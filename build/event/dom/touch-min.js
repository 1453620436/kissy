/*
Copyright 2013, KISSY v1.50
MIT Licensed
build time: Dec 23 12:49
*/
KISSY.add("event/dom/touch/handle-map",[],function(){return{}});KISSY.add("event/dom/touch/single-touch",[],function(b){function a(){}a.prototype={constructor:a,requiredTouchCount:1,onTouchStart:function(b){if(b.touches.length!==this.requiredTouchCount)return!1;b=this.lastTouches=b.touches;this.lastXY={pageX:b[0].pageX,pageY:b[0].pageY}},onTouchMove:b.noop,onTouchEnd:b.noop};return a});
KISSY.add("event/dom/touch/tap",["./handle-map","event/dom/base","./single-touch"],function(b,a){function j(e){e.preventDefault()}function i(){i.superclass.constructor.apply(this,arguments)}var g=a("./handle-map"),k=a("event/dom/base"),h=a("./single-touch"),l=k.Object;b.extend(i,h,{onTouchStart:function(e){var d=this;if(!1===i.superclass.onTouchStart.call(d,e))return!1;d.tapHoldTimer&&clearTimeout(d.tapHoldTimer);d.tapHoldTimer=setTimeout(function(){var f=b.mix({touch:e.touches[0],which:1,TAP_HOLD_DELAY:(b.now()-
e.timeStamp)/1E3},d.lastXY);d.tapHoldTimer=0;d.lastXY=0;k.fire(e.target,"tapHold",f)},1E3);d.startTime=e.timeStamp;d.singleTapTimer&&(clearTimeout(d.singleTapTimer),d.singleTapTimer=0)},onTouchMove:function(e){var d;if(!(d=this.lastXY))return!1;e=e.changedTouches[0];if(!e||5<Math.abs(e.pageX-d.pageX)||5<Math.abs(e.pageY-d.pageY))return!1},onTouchEnd:function(e){var d;if(d=this.lastXY){var f=e.target,g=e.changedTouches[0];this.tapHoldTimer&&(clearTimeout(this.tapHoldTimer),this.tapHoldTimer=0);var b=
new l({type:"tap",which:1,pageX:d.pageX,pageY:d.pageY,target:f,currentTarget:f});b.touch=g;b.originalEvent=e.originalEvent;k.fire(f,"tap",b);if(b.isDefaultPrevented())k.on(f,"click",{fn:j,once:1});var b=this.lastEndTime,e=e.timeStamp,a;this.lastEndTime=e;if(b&&(a=e-b,300>a)){this.lastEndTime=0;k.fire(f,"doubleTap",{touch:g,pageX:d.pageX,pageY:d.pageY,which:1,duration:a/1E3});return}a=e-this.startTime;300<a?k.fire(f,"singleTap",{touch:g,pageX:d.pageX,pageY:d.pageY,which:1,duration:a/1E3}):this.singleTapTimer=
setTimeout(function(){k.fire(f,"singleTap",{touch:g,pageX:d.pageX,pageY:d.pageY,which:1,duration:a/1E3})},300)}}});g.tap=g.doubleTap=g.singleTap=g.tapHold={handle:new i};return i});
KISSY.add("event/dom/touch/swipe",["./handle-map","event/dom/base","./single-touch"],function(b,a){function j(f,b,g){var a=b.changedTouches[0],c=a.pageX-f.startX,p=a.pageY-f.startY,q=Math.abs(c),r=Math.abs(p);if(g){if(f.isVertical&&f.isHorizontal){if(5>Math.max(q,r))return;r>q?f.isHorizontal=0:f.isVertical=0}}else if(f.isVertical&&r<d&&(f.isVertical=0),f.isHorizontal&&q<d)f.isHorizontal=0;if(f.isHorizontal)c=0>c?"left":"right";else if(f.isVertical)c=0>p?"up":"down",q=r;else return!1;k.fire(b.target,
g?e:l,{originalEvent:b.originalEvent,pageX:a.pageX,pageY:a.pageY,which:1,touch:a,direction:c,distance:q,duration:(b.timeStamp-f.startTime)/1E3})}function i(){}var g=a("./handle-map"),k=a("event/dom/base"),h=a("./single-touch"),l="swipe",e="swiping",d=50;b.extend(i,h,{onTouchStart:function(f){if(!1===i.superclass.onTouchStart.apply(this,arguments))return!1;var e=f.touches[0];this.startTime=f.timeStamp;this.isVertical=this.isHorizontal=1;this.startX=e.pageX;this.startY=e.pageY;-1!==f.type.indexOf("mouse")&&
f.preventDefault()},onTouchMove:function(e){var d=e.changedTouches[0],b=d.pageY-this.startY,d=Math.abs(d.pageX-this.startX),b=Math.abs(b);if(1E3<e.timeStamp-this.startTime)return!1;this.isVertical&&35<d&&(this.isVertical=0);this.isHorizontal&&35<b&&(this.isHorizontal=0);return j(this,e,1)},onTouchEnd:function(e){return!1===this.onTouchMove(e)?!1:j(this,e,0)}});g[l]=g[e]={handle:new i};return i});
KISSY.add("event/dom/touch/multi-touch",["dom"],function(b,a){function j(){}var i=a("dom");j.prototype={constructor:j,requiredTouchCount:2,onTouchStart:function(b){var a=this.requiredTouchCount,h=b.touches.length;h===a?this.start():h>a&&this.end(b)},onTouchEnd:function(b){this.end(b)},start:function(){this.isTracking||(this.isTracking=!0,this.isStarted=!1)},fireEnd:b.noop,getCommonTarget:function(b){var a=b.touches,b=a[0].target,a=a[1].target;if(b===a||i.contains(b,a))return b;for(;;){if(i.contains(a,
b))return a;a=a.parentNode}"getCommonTarget error!"},end:function(b){this.isTracking&&(this.isTracking=!1,this.isStarted&&(this.isStarted=!1,this.fireEnd(b)))}};return j});
KISSY.add("event/dom/touch/pinch",["./handle-map","event/dom/base","./multi-touch"],function(b,a){function j(){}function i(b){2===b.targetTouches.length&&b.preventDefault()}var g=a("./handle-map"),k=a("event/dom/base"),h=a("./multi-touch");b.extend(j,h,{onTouchMove:function(a){if(this.isTracking){var e=a.touches;if(0<e[0].pageX&&0<e[0].pageY&&0<e[1].pageX&&0<e[1].pageY){var d,f=e[0],g=e[1];d=f.pageX-g.pageX;f=f.pageY-g.pageY;d=Math.sqrt(d*d+f*f);this.lastTouches=e;this.isStarted?k.fire(this.target,
"pinch",b.mix(a,{distance:d,scale:d/this.startDistance})):(this.isStarted=!0,this.startDistance=d,e=this.target=this.getCommonTarget(a),k.fire(e,"pinchStart",b.mix(a,{distance:d,scale:1})))}}},fireEnd:function(a){k.fire(this.target,"pinchEnd",b.mix(a,{touches:this.lastTouches}))}});h=new j;g.pinchStart=g.pinchEnd={handle:h};g=g.pinch={handle:h};b.Features.isTouchEventSupported()&&(g.setup=function(){this.addEventListener("touchmove",i,!1)},g.tearDown=function(){this.removeEventListener("touchmove",
i,!1)});return j});
KISSY.add("event/dom/touch/rotate",["./handle-map","event/dom/base","./multi-touch"],function(b,a){function j(){}function i(b){2===b.targetTouches.length&&b.preventDefault()}var g=a("./handle-map"),k=a("event/dom/base"),h=a("./multi-touch"),l=180/Math.PI;b.extend(j,h,{onTouchMove:function(a){if(this.isTracking){var d=a.touches,f=d[0],g=d[1],h=this.lastAngle,f=Math.atan2(g.pageY-f.pageY,g.pageX-f.pageX)*l;if(void 0!==h){var g=Math.abs(f-h),i=(f+360)%360,c=(f-360)%360;Math.abs(i-h)<g?f=i:Math.abs(c-
h)<g&&(f=c)}this.lastTouches=d;this.lastAngle=f;this.isStarted?k.fire(this.target,"rotate",b.mix(a,{angle:f,rotation:f-this.startAngle})):(this.isStarted=!0,this.startAngle=f,this.target=this.getCommonTarget(a),k.fire(this.target,"rotateStart",b.mix(a,{angle:f,rotation:0})))}},end:function(){this.lastAngle=void 0;j.superclass.end.apply(this,arguments)},fireEnd:function(a){k.fire(this.target,"rotateEnd",b.mix(a,{touches:this.lastTouches}))}});h=new j;g.rotateEnd=g.rotateStart={handle:h};g=g.rotate=
{handle:h};b.Features.isTouchEventSupported()&&(g.setup=function(){this.addEventListener("touchmove",i,!1)},g.tearDown=function(){this.removeEventListener("touchmove",i,!1)});return j});
KISSY.add("event/dom/touch/handle","dom,./handle-map,event/dom/base,./tap,./swipe,./pinch,./rotate".split(","),function(b,a){function j(c){return b.startsWith(c,"touch")}function i(c){return b.startsWith(c,"mouse")}function g(c){return b.startsWith(c,"MSPointer")||b.startsWith(c,"pointer")}function k(c){this.doc=c;this.eventHandle={};this.init();this.touches=[];this.inTouch=0}var h=a("dom"),l=a("./handle-map"),e=a("event/dom/base");a("./tap");a("./swipe");a("./pinch");a("./rotate");var d=b.guid("touch-handle"),
f=b.Features,o,n,m;if(f.isTouchEventSupported())if(b.UA.ios){m="touchend touchcancel";o="touchstart";n="touchmove"}else{m="touchend touchcancel mouseup";o="touchstart mousedown";n="touchmove mousemove"}else if(f.isPointerSupported()){o="pointerdown";n="pointermove";m="pointerup pointercancel"}else if(f.isMsPointerSupported()){o="MSPointerDown";n="MSPointerMove";m="MSPointerUp MSPointerCancel"}else{o="mousedown";n="mousemove";m="mouseup"}k.prototype={constructor:k,lastTouches:[],firstTouch:null,init:function(){var c=
this.doc;e.on(c,o,this.onTouchStart,this);if(!g(n))e.on(c,n,this.onTouchMove,this);e.on(c,m,this.onTouchEnd,this)},addTouch:function(c){c.identifier=c.pointerId;this.touches.push(c)},removeTouch:function(c){for(var b=0,a=c.pointerId,d=this.touches,e=d.length;b<e;b++){c=d[b];if(c.pointerId===a){d.splice(b,1);break}}},updateTouch:function(c){for(var b=0,a,d=c.pointerId,e=this.touches,f=e.length;b<f;b++){a=e[b];a.pointerId===d&&(e[b]=c)}},isPrimaryTouch:function(c){return this.firstTouch===c.identifier},
setPrimaryTouch:function(c){if(this.firstTouch===null)this.firstTouch=c.identifier},removePrimaryTouch:function(c){if(this.isPrimaryTouch(c))this.firstTouch=null},dupMouse:function(c){var b=this.lastTouches,c=c.changedTouches[0];if(this.isPrimaryTouch(c)){var a={x:c.clientX,y:c.clientY};b.push(a);setTimeout(function(){var c=b.indexOf(a);c>-1&&b.splice(c,1)},2500)}},isEventSimulatedFromTouch:function(c){for(var b=this.lastTouches,a=c.clientX,c=c.clientY,d=0,e=b.length,f;d<e&&(f=b[d]);d++){var g=Math.abs(a-
f.x),h=Math.abs(c-f.y);if(g<=25&&h<=25)return true}return 0},normalize:function(c){var b=c.type,a;if(j(b)){a=b==="touchend"||b==="touchcancel"?c.changedTouches:c.touches;if(a.length===1){c.which=1;c.pageX=a[0].pageX;c.pageY=a[0].pageY}return c}a=this.touches;b=!b.match(/(up|cancel)$/i);c.touches=b?a:[];c.targetTouches=b?a:[];c.changedTouches=a;return c},onTouchStart:function(c){var b,a;a=c.type;var d=this.eventHandle;if(j(a)){this.setPrimaryTouch(c.changedTouches[0]);this.dupMouse(c)}else if(i(a)){if(this.isEventSimulatedFromTouch(c))return;
this.touches=[c.originalEvent]}else if(g(a)){this.addTouch(c.originalEvent);if(this.touches.length===1)e.on(this.doc,n,this.onTouchMove,this)}else throw Error("unrecognized touch event: "+c.type);for(b in d){a=d[b].handle;a.isActive=1}this.callEventHandle("onTouchStart",c)},onTouchMove:function(c){var b=c.type;if(i(b)){if(this.isEventSimulatedFromTouch(b))return;this.touches=[c.originalEvent]}else if(g(b))this.updateTouch(c.originalEvent);else if(!j(b))throw Error("unrecognized touch event: "+c.type);
this.callEventHandle("onTouchMove",c)},onTouchEnd:function(c){var a=this,d=c.type;if(!i(d)||!a.isEventSimulatedFromTouch(c)){a.callEventHandle("onTouchEnd",c);if(j(d)){a.dupMouse(c);b.makeArray(c.changedTouches).forEach(function(c){a.removePrimaryTouch(c)})}else if(i(d))a.touches=[];else if(g(d)){a.removeTouch(c.originalEvent);a.touches.length||e.detach(a.doc,n,a.onTouchMove,a)}}},callEventHandle:function(c,a){var b=this.eventHandle,d,e,a=this.normalize(a);if(a.changedTouches.length){for(d in b){e=
b[d].handle;if(!e.processed){e.processed=1;if(e.isActive&&e[c]&&e[c](a)===false)e.isActive=0}}for(d in b){e=b[d].handle;e.processed=0}}},addEventHandle:function(a){var b=this.eventHandle,d=l[a].handle;b[a]?b[a].count++:b[a]={count:1,handle:d}},removeEventHandle:function(a){var b=this.eventHandle;if(b[a]){b[a].count--;b[a].count||delete b[a]}},destroy:function(){var a=this.doc;e.detach(a,o,this.onTouchStart,this);e.detach(a,n,this.onTouchMove,this);e.detach(a,m,this.onTouchEnd,this)}};return{addDocumentHandle:function(a,
b){var e=h.getDocument(a),f=h.data(e,d);f||h.data(e,d,f=new k(e));b&&f.addEventHandle(b)},removeDocumentHandle:function(a,e){var f=h.getDocument(a),g=h.data(f,d);if(g){e&&g.removeEventHandle(e);if(b.isEmptyObject(g.eventHandle)){g.destroy();h.removeData(f,d)}}}}});
KISSY.add("event/dom/touch",["event/dom/base","./touch/handle-map","./touch/handle"],function(b,a){function j(a){e.addDocumentHandle(this,a);l[a].setup.apply(this,arguments)}function i(a){e.removeDocumentHandle(this,a);l[a].tearDown.apply(this,arguments)}function g(a){e.addDocumentHandle(this,a)}function k(a){e.removeDocumentHandle(this,a)}var h=a("event/dom/base"),l=a("./touch/handle-map"),e=a("./touch/handle"),d=h.Gesture,f=d.start="KSPointerDown",o=d.move="KSPointerMove",n=d.end="KSPointerUp";
d.tap="tap";d.singleTap="singleTap";d.doubleTap="doubleTap";l[f]={handle:{isActive:1,onTouchStart:function(a){h.fire(a.target,f,a)}}};l[o]={handle:{isActive:1,onTouchMove:function(a){h.fire(a.target,o,a)}}};l[n]={handle:{isActive:1,onTouchEnd:function(a){h.fire(a.target,n,a)}}};var d=h.Special,m,c,p;for(c in l)m={},p=l[c],m.setup=p.setup?j:g,m.tearDown=p.tearDown?i:k,p.add&&(m.add=p.add),p.remove&&(m.remove=p.remove),d[c]=m});
