/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 27 00:40
*/
KISSY.add("editor/plugin/bubble",["overlay","editor"],function(g,f){function s(k){var i=null,a=k.get("editor").getControls();g.each(a,function(a){var c;if(c=a.isKeBubble)if(c=a!==k)if(c=a.get("visible")){c=k.get("y");var g=c+k.get("el").outerHeight(),j=a.get("y"),d=j+a.get("el").outerHeight();c=c<=d&&g>=d||c<=j&&g>=j}c&&(i?i.get("y")<a.get("y")&&(i=a):i=a)});return i}var u=f("overlay"),n=f("editor"),j={}.a,v={zIndex:n.baseZIndex(n.ZIndexManager.BUBBLE_VIEW),elCls:"{prefixCls}editor-bubble",prefixCls:"{prefixCls}editor-",
effect:{effect:"fade",duration:0.3}};n.prototype.addBubble=function(k,i,a){function f(){e.hide();var b=d.get("window");b&&(b.detach("scroll",p),q.stop())}function c(){var b;var a=e;if(b=a.get("editorSelectedEl")){var c=a.get("editor"),d=c.get("window"),l=c.get("iframe").offset(),a=l.top,l=l.left,i=l+d.width(),d=a+d.height(),h=b.offset(),h=n.Utils.getXY(h,c),c=h.top,h=h.left,k=h+b.width(),f=c+b.height(),m,o;g.UA.ie&&"img"==b[0].nodeName.toLowerCase()&&f>d?b=j:(f>d&&c<d?o=d-30:f>a&&f<d&&(o=f),k>l&&
h<l?m=l:h>l&&h<i&&(m=h),b=m!==j&&o!==j?[m,o]:j)}else b=j;if(b){e.move(b[0],b[1]);if(m=s(e))b[1]=m.get("y")+m.get("el").outerHeight(),e.move(b[0],b[1]);e.get("visible")?"already show by selectionChange":e.show()}}function p(){e.get("editorSelectedEl")&&(e.get("el"),e.hide(),q())}function t(){d.get("window").on("scroll",p);c()}var d=this,r=d.get("prefixCls"),e,a=a||{};a.editor=d;g.mix(a,v);a.elCls=g.substitute(a.elCls,{prefixCls:r});a.prefixCls=g.substitute(a.prefixCls,{prefixCls:r});e=new u(a);e.isKeBubble=
1;d.addControl(k+"/bubble",e);d.on("selectionChange",function(b){var b=b.path,a=b.elements;if(b&&a&&(b=b.lastElement))(b=i(b))?(e.set("editorSelectedEl",b),e.hide(),g.later(t,10)):f()});d.on("sourceMode",f);var q=g.buffer(c,350)}});
