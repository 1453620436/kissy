/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 27 00:00
*/
KISSY.add("editor/plugin/list-utils/cmd",["editor","../list-utils"],function(r,v){function u(g){this.type=g}function w(g,d){var e,h,b,i=d.blockLimit,a=d.elements;if(!i)return!1;if(a)for(b=0;b<a.length&&(e=a[b])&&e[0]!==i[0];b++)if(t[h=e.nodeName()]&&h==g)return e.css("list-style-type");return!1}var q=v("editor"),o=v("../list-utils"),t={ol:"insertOrderedList",ul:"insertUnorderedList"},x=q.RangeType,z=q.ElementPath,y=q.Walker,A=r.UA,m=r.Node,s=r.DOM,B=/^h[1-6]$/;u.prototype={constructor:u,changeListType:function(g,
d,e,h,b){for(var i=o.listToArray(d.root,e,void 0,void 0,void 0),a=[],g=0;g<d.contents.length;g++){var c=d.contents[g];if((c=c.closest("li",void 0))&&c[0]&&!c.data("list_item_processed"))a.push(c),c._4e_setMarker(e,"list_item_processed",!0,void 0)}c=new m(d.root[0].ownerDocument.createElement(this.type));c.css("list-style-type",b);for(g=0;g<a.length;g++)b=a[g].data("listarray_index"),i[b].parent=c;for(var e=o.arrayToList(i,e,null,"p"),j,b=e.listNode.childNodes.length,g=0;g<b&&(j=new m(e.listNode.childNodes[g]));g++)j.nodeName()==
this.type&&h.push(j);d.root.before(e.listNode);d.root.remove()},createList:function(g,d,e,h){var b=d.contents,g=d.root[0].ownerDocument,i=[];if(1==b.length&&b[0][0]===d.root[0]){var a=new m(g.createElement("div"));b[0][0].nodeType!=s.NodeType.TEXT_NODE&&b[0]._4e_moveChildren(a,void 0,void 0);b[0][0].appendChild(a[0]);b[0]=a}d=d.contents[0].parent();for(a=0;a<b.length;a++)d=d._4e_commonAncestor(b[a].parent(),void 0);for(a=0;a<b.length;a++)for(var c=b[a],j;j=c.parent();){if(j[0]===d[0]){i.push(c);break}c=
j}if(!(1>i.length)){b=new m(i[i.length-1][0].nextSibling);a=new m(g.createElement(this.type));a.css("list-style-type",h);for(e.push(a);i.length;)e=i.shift(),h=new m(g.createElement("li")),B.test(e.nodeName())?h[0].appendChild(e[0]):(e._4e_copyAttributes(h,void 0,void 0),e._4e_moveChildren(h,void 0,void 0),e.remove()),a[0].appendChild(h[0]),A.ie||h._4e_appendBogus(void 0);b[0]?a.insertBefore(b,void 0):d.append(a)}},removeList:function(g,d,e){function h(a){if((k=new m(j[a?"firstChild":"lastChild"]))&&
!(k[0].nodeType==s.NodeType.ELEMENT_NODE&&k._4e_isBlockBoundary(void 0,void 0))&&(f=d.root[a?"prev":"next"](y.whitespaces(!0),1))&&!(k[0].nodeType==s.NodeType.ELEMENT_NODE&&f._4e_isBlockBoundary({br:1},void 0)))k[a?"before":"after"](g.get("document")[0].createElement("br"))}for(var b=o.listToArray(d.root,e,void 0,void 0,void 0),i=[],a=0;a<d.contents.length;a++){var c=d.contents[a];if((c=c.closest("li",void 0))&&!c.data("list_item_processed"))i.push(c),c._4e_setMarker(e,"list_item_processed",!0,void 0)}c=
null;for(a=0;a<i.length;a++)c=i[a].data("listarray_index"),b[c].indent=-1;for(a=c+1;a<b.length;a++)if(b[a].indent>Math.max(b[a-1].indent,0)){i=b[a-1].indent+1-b[a].indent;for(c=b[a].indent;b[a]&&b[a].indent>=c;)b[a].indent+=i,a++;a--}var j=o.arrayToList(b,e,null,"p").listNode,k,f;h(!0);h(void 0);d.root.before(j);d.root.remove()},exec:function(g,d){var e=g.getSelection(),h=e&&e.getRanges();if(h&&!(1>h.length)){for(var b=e.getStartElement(),b=new q.ElementPath(b),i=w(this.type,b),b=e.createBookmarks(!0),
a=[],c={};0<h.length;){var j=h.shift(),k=j.getBoundaryNodes(),f=k.startNode,l=k.endNode;f[0].nodeType==s.NodeType.ELEMENT_NODE&&"td"==f.nodeName()&&j.setStartAt(k.startNode,x.POSITION_AFTER_START);l[0].nodeType==s.NodeType.ELEMENT_NODE&&"td"==l.nodeName()&&j.setEndAt(k.endNode,x.POSITION_BEFORE_END);j=j.createIterator();for(j.forceBrBreak=!1;k=j.getNextParagraph();)if(!k.data("list_block")){k._4e_setMarker(c,"list_block",1,void 0);for(var l=new z(k),m=l.elements,p=null,o=!1,p=l.blockLimit,n,f=m.length-
1;0<=f&&(n=m[f]);f--)if(t[n.nodeName()]&&p.contains(n)){p.removeData("list_group_object");(f=n.data("list_group_object"))?f.contents.push(k):(f={root:n,contents:[k]},a.push(f),n._4e_setMarker(c,"list_group_object",f,void 0));o=!0;break}o||(l=p||l.block,l.data("list_group_object")?l.data("list_group_object").contents.push(k):(f={root:l,contents:[k]},l._4e_setMarker(c,"list_group_object",f,void 0),a.push(f)))}}for(h=[];0<a.length;)f=a.shift(),i?t[f.root.nodeName()]&&(f.root.css("list-style-type")==
d?this.removeList(g,f,c):f.root.css("list-style-type",d)):t[f.root.nodeName()]?this.changeListType(g,f,c,h,d):(q.Utils.clearAllMarkers(c),this.createList(g,f,h,d));for(var r=this,f=0;f<h.length;f++)p=h[f],n=function(a,b){var c=b[a?"prev":"next"](y.whitespaces(!0),1);c&&c[0]&&c.nodeName()==r.type&&c.css("list-style-type")==d&&(c.remove(),c._4e_moveChildren(b,a?!0:!1,void 0))},n(void 0,p),n(!0,p);q.Utils.clearAllMarkers(c);e.selectBookmarks(b)}}};return{ListCommand:u,queryActive:w}});
