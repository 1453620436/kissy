/*
Copyright 2013, KISSY v1.50
MIT Licensed
build time: Dec 11 23:40
*/
KISSY.add("router/utils",[],function(c){return{endWithSlash:function(a){return c.endsWith(a,"/")},startWithSlash:function(a){return c.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+
"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return a.getFragment().replace(/^!/,"")}}});
KISSY.add("router/route",[],function(c){function a(a){var b=[],a=c.escapeRegExp(a),a=a.replace(h,function(a,p,e,d,j){a={};c.endsWith(e,"?")&&(a.optional=!0,e=e.slice(0,-1));a.name=e||j;b.push(a);if(e)return"([^/]+)";if(j)return"(.*)"});return{keys:b,regexp:RegExp("^"+a+"$")}}function b(b,h){this.path=b;this.callbacks=h;"string"===typeof b?c.mix(this,a(b)):this.regexp=b}var h=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;b.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var b=this.keys,
f=[],g=1,e=a.length;g<e;++g){var d=b[g-1],h="string"===typeof a[g]?c.urlDecode(a[g]):a[g];d?f[d.name]=h:f.push(h)}return f}};return b});KISSY.add("router/request",[],function(c){function a(a){c.mix(this,a)}a.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return a});
KISSY.add("router",["./router/utils","./router/route","uri","./router/request","event/dom"],function(c,a,b){function h(a){a=a||location.href;a=new t(a);if(k&&l){var b=a.query;return a.getPath().substr(i.length)+(b.has()?"?"+b.toString():"")}return d.getHash(a)}function p(a,b,u){function n(){e++;if(e===h)u(a,b);else{var d=g[e];if(c.startsWith(a.path+"/",d[0]+"/")){var f=d[0].length;a.url=a.url.slice(f);var i=a.path;a.path=a.path.slice(f);d[1](a,n);a.url=a.originalUrl;a.path=i}else n()}}var e=-1,h=
g.length;n()}function s(a,b){function c(){d++;if(d!==h){var f=e[d];if(a.params=f.match(a.path)){var g=-1,i=f.callbacks,k=i.length,j=function(d){if("route"===d)j=null,c();else if(g++,g!==k)i[g](a,b,j)};j("")}else c()}}var d=-1,h=e.length;c()}function f(){var a=h(),d=new c.Uri(a),f=d.query.get();d.query.reset();a=new v({query:f,path:d.toString()||"/",url:a,originalUrl:a});p(a,{redirect:b.navigate},s)}var g=[],e=[],d=a("./router/utils"),j=a("./router/route"),t=a("uri"),v=a("./router/request"),q=a("event/dom"),
r=!1,k,i,o=c.Env.host,m=o.history,w=c.Features.isHashChangeSupported(),l=!(!m||!m.pushState);b.use=function(a,b){"string"!==typeof a&&(b=a,a="");g.push([a,b])};b.navigate=function(a,b){var b=b||{},c=b.replaceHistory,e;h()!==a?k&&l?(m[c?"replaceState":"pushState"]({},"",d.getFullPath(a,i)),f()):(e="#!"+a,c?location.replace(e+(w?Node.REPLACE_HISTORY:"")):location.hash=e):b&&b.triggerRoute&&f()};b.get=function(a){var b=c.makeArray(arguments).slice(1);e.push(new j(a,b))};b.start=function(a){a=a||{};if(r)return a.success&&
a.success.call(b);a.urlRoot=(a.urlRoot||"").replace(/\/$/,"");k=a.useNativeHistory;i=a.urlRoot;var c=location.pathname,e=h(),g=location.hash.match(/#!.+/);if(k)if(l)g&&(d.equalsIgnoreSlash(c,i)?(m.replaceState({},"",d.getFullPath(e,i)),a.triggerRoute=1):"router: location path must be same with urlRoot!");else if(!d.equalsIgnoreSlash(c,i)){location.replace(d.addEndSlash(i)+"#!"+e);return}setTimeout(function(){if(k&&l)q.on(o,"popstate",f);else q.on(o,"hashchange",f),a.triggerRoute=1;a.triggerRoute&&
f();a.success&&a.success()},100);r=!0;return b}});
