/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Jan 8 16:54
*/
KISSY.add("router/utils",[],function(e){return{endWithSlash:function(a){return e.endsWith(a,"/")},startWithSlash:function(a){return e.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+
"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return a.getFragment().replace(/^!/,"")}}});
KISSY.add("router/route",[],function(e){function a(a){var b=[],a=e.escapeRegExp(a),a=a.replace(p,function(a,v,h,c,g){a={};h&&e.endsWith(h,"?")&&(a.optional=!0,h=h.slice(0,-1));a.name=h||g;b.push(a);if(h)return"([^/]+)";if(g)return"(.*)"});return{keys:b,regexp:RegExp("^"+a+"$")}}function b(b,t){this.path=b;this.callbacks=t;"string"===typeof b?e.mix(this,a(b)):this.regexp=b}var p=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;b.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var b=this.keys||
[],d=[],i=1,h=a.length;i<h;++i){var c=b[i-1],g="string"===typeof a[i]?e.urlDecode(a[i]):a[i];c?d[c.name]=g:d.push(g)}return d},removeCallback:function(a){for(var b=this.callbacks||[],d=b.length-1;0<=d;d++)b===a&&b.splice(d,1)}};return b});KISSY.add("router/request",[],function(e){function a(a){e.mix(this,a)}a.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return a});
KISSY.add("router",["./router/utils","./router/route","uri","./router/request","event/dom"],function(e,a,b){function p(a){a=a||location.href;a=new w(a);if(!j&&l){var k=a.query;return a.getPath().substr(m.length)+(k.has()?"?"+k.toString():"")}return g.getHash(a)}function v(a,k,b){function f(){c++;if(c===d)b(a,k);else{var g=h[c];if(e.startsWith(a.path+"/",g[0]+"/")){var i=g[0].length;a.url=a.url.slice(i);var j=a.path;a.path=a.path.slice(i);g[1](a,f);a.url=a.originalUrl;a.path=j}else f()}}var c=-1,d=
h.length;f()}function t(a,k){function b(){f++;if(f!==d){var g=c[f];if(a.params=g.match(a.path)){var e=-1,h=g.callbacks,i=h.length,j=function(c){"route"===c?(j=null,b()):(e++,e!==i&&(a.route=g,h[e](a,k,j)))};j("")}else b()}}var f=-1,d=c.length;b()}function d(a){var k=p(),c=new e.Uri(k),f=c.query.get();c.query.reset();a=new x({query:f,backward:a,path:c.toString()||"/",url:k,originalUrl:k});v(a,{redirect:b.navigate},t)}function i(a){var a=a.originalEvent.state,b=!1;a.pageDepth===q[q.length-2]?(b=!0,
q.pop()):q.push(a.pageDepth);d(b)}var h=[],c=[],g=a("./router/utils"),y=a("./router/route"),w=a("uri"),x=a("./router/request"),r=a("event/dom"),u=!1,j,m,s=e.Env.host,n=s.history,z=e.Features.isHashChangeSupported(),l=!(!n||!n.pushState),o=10,q=[o];b.use=function(a,b){"string"!==typeof a&&(b=a,a="");h.push([a,b])};b.navigate=function(a,b){var b=b||{},c=b.replaceHistory,f;p()!==a?(c||(o++,q.push(o)),!j&&l)?(n[c?"replaceState":"pushState"]({pageDepth:o},"",g.getFullPath(a,m)),d()):(f="#!"+a,c?l?(n.replaceState({pageDepth:o},
"",f),d()):location.replace(f+(z?"":r.REPLACE_HISTORY)):l?(n.pushState({pageDepth:o},"",f),d()):location.hash=f):b&&b.triggerRoute&&d()};b.get=function(a){var b=e.makeArray(arguments).slice(1);c.push(new y(a,b))};b.matchRoute=function(a){for(var b=0,d=c.length;b<d;b++)if(c[b].match(a))return c[b];return!1};b.removeRoute=function(a,b){for(var d=c.length-1;0<=d;d--){var f=c[d];f.path===a&&(b?(f.removeCallback(b),f.callbacks.length||c.splice(d,1)):c.splice(d,1))}};b.clearRoutes=function(){h=[];c=[]};
b.hasRoute=function(a){for(var b=0,d=c.length;b<d;b++)if(c[b].path===a)return c[b];return!1};b.start=function(a){a=a||{};if(u)return a.success&&a.success.call(b);a.urlRoot=(a.urlRoot||"").replace(/\/$/,"");j=a.useHash;m=a.urlRoot;void 0===j&&(j=!0);var c=location.pathname,e=p(),f=location.hash.match(/#!.+/);if(!j)if(l)f&&(g.equalsIgnoreSlash(c,m)?(n.replaceState({},"",g.getFullPath(e,m)),a.triggerRoute=1):"router: location path must be same with urlRoot!");else if(!g.equalsIgnoreSlash(c,m)){location.replace(g.addEndSlash(m)+
"#!"+e);return}setTimeout(function(){var c=l;if(l)r.on(s,"popstate",i);else r.on(s,"hashchange",d),a.triggerRoute=1;j&&!p()&&(b.navigate("/",{replaceHistory:1}),a.triggerRoute=0,c=!1);c&&n.replaceState({pageDepth:o},"",location.href);a.triggerRoute&&d();a.success&&a.success()},100);u=!0;return b};b.stop=function(){u=!1;r.detach(s,"hashchange",d);r.detach(s,"popstate",i)}});
