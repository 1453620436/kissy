/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Jan 9 00:15
*/
KISSY.add("router/utils",[],function(c){return{endWithSlash:function(a){return c.endsWith(a,"/")},startWithSlash:function(a){return c.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+
"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return a.getFragment().replace(/^!/,"").replace(/__ks-vid=.+$/,"")}}});
KISSY.add("router/route",[],function(c){function a(a){var b=[],a=c.escapeRegExp(a),a=a.replace(g,function(a,y,i,g,j){a={};i&&c.endsWith(i,"?")&&(a.optional=!0,i=i.slice(0,-1));a.name=i||j;b.push(a);if(i)return"([^/]+)";if(j)return"(.*)"});return{keys:b,regexp:RegExp("^"+a+"$")}}function b(b,u){this.path=b;this.callbacks=u;"string"===typeof b?c.mix(this,a(b)):this.regexp=b}var g=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;b.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var b=this.keys||
[],h=[],k=1,i=a.length;k<i;++k){var g=b[k-1],j="string"===typeof a[k]?c.urlDecode(a[k]):a[k];g?h[g.name]=j:h.push(j)}return h},removeCallback:function(a){for(var b=this.callbacks||[],c=b.length-1;0<=c;c++)b===a&&b.splice(c,1)}};return b});KISSY.add("router/request",[],function(c){function a(a){c.mix(this,a)}a.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return a});
KISSY.add("router",["./router/utils","./router/route","uri","./router/request","event/dom"],function(c,a,b){function g(d){d=d||location.href;d=new A(d);if(!m&&n){var a=d.query;return d.getPath().substr(o.length)+(a.has()?"?"+a.toString():"")}return r.getHash(d)}function y(d,a,b){function e(){f++;if(f===i)b(d,a);else{var g=j[f];if(c.startsWith(d.path+"/",g[0]+"/")){var h=g[0].length;d.url=d.url.slice(h);var k=d.path;d.path=d.path.slice(h);g[1](d,e);d.url=d.originalUrl;d.path=k}else e()}}var f=-1,i=
j.length;e()}function u(d,a){function b(){e++;if(e!==c){var g=f[e];if(d.params=g.match(d.path)){var h=-1,i=g.callbacks,k=i.length,j=function(c){"route"===c?(j=null,b()):(h++,h!==k&&(d.route=g,i[h](d,a,j)))};j("")}else b()}}var e=-1,c=f.length;b()}function h(a){var v=g(),w=new c.Uri(v),e=w.query.get();w.query.reset();a=new B({query:e,backward:a,path:w.toString()||"/",url:v,originalUrl:v});y(a,{redirect:b.navigate},u)}function k(a){var b=!1;a===p[p.length-2]?(b=!0,p.pop()):a!==p[p.length-1]&&p.push(a);
h(b)}function i(a){(a=a.originalEvent.state)&&k(a.vid)}function z(a){var b;(a=(b=(new c.Uri(a.newURL||location.href)).getFragment().match(/__ks-vid=(.+)$/))?parseInt(b[1],10):0)&&k(a)}var j=[],f=[],r=a("./router/utils"),C=a("./router/route"),A=a("uri"),B=a("./router/request"),s=a("event/dom"),x=!1,m,o,t=c.Env.host,q=t.history,D=c.Features.isHashChangeSupported(),n=!(!q||!q.pushState),l=10,p=[l];b.use=function(a,b){"string"!==typeof a&&(b=a,a="");j.push([a,b])};b.navigate=function(a,b){var b=b||{},
c=b.replace,e;g()!==a?(c||(l++,p.push(l)),!m&&n)?(q[c?"replaceState":"pushState"]({vid:l},"",r.getFullPath(a,o)),h()):(e="#!"+a,c?n?(q.replaceState({vid:l},"",e),h()):location.replace(e+(D?"":s.REPLACE_HISTORY)+"__ks-vid="+l):n?(q.pushState({vid:l},"",e),h()):location.hash=e+"__ks-vid="+l):b&&b.triggerRoute&&h()};b.get=function(a){var b=c.makeArray(arguments).slice(1);f.push(new C(a,b))};b.matchRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].match(a))return f[b];return!1};b.removeRoute=function(a,
b){for(var c=f.length-1;0<=c;c--){var e=f[c];e.path===a&&(b?(e.removeCallback(b),e.callbacks.length||f.splice(c,1)):f.splice(c,1))}};b.clearRoutes=function(){j=[];f=[]};b.hasRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].path===a)return f[b];return!1};b.start=function(a){a=a||{};if(x)return a.success&&a.success.call(b);a.urlRoot=(a.urlRoot||"").replace(/\/$/,"");m=a.useHash;o=a.urlRoot;void 0===m&&(m=!0);a.useHashChange&&(n=!1);var c=location.pathname,f=g(),e=location.hash.match(/#!.+/);
if(!m)if(n)e&&(r.equalsIgnoreSlash(c,o)?(q.replaceState({},"",r.getFullPath(f,o)),a.triggerRoute=1):"router: location path must be same with urlRoot!");else if(r.equalsIgnoreSlash(c,o))m=!0;else{location.replace(r.addEndSlash(o)+"#!"+f);return}setTimeout(function(){var c=n;if(n)s.on(t,"popstate",i);else s.on(t,"hashchange",z),a.triggerRoute=1;m&&!g()&&(b.navigate("/",{replace:1}),a.triggerRoute=0,c=!1);c&&q.replaceState({vid:l},"",location.href);a.triggerRoute&&h();a.success&&a.success()},100);x=
!0;return b};b.stop=function(){x=!1;s.detach(t,"hashchange",z);s.detach(t,"popstate",i)}});
