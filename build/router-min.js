/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Mar 27 22:00
*/
KISSY.add("router/utils",["event/dom","uri"],function(e,c){function a(b){return b.replace(/__ks-vid=.+$/,"")}function m(b){var a;return(a=b.match(/__ks-vid=(.+)$/))?parseInt(a[1],10):0}var i=c("event/dom"),g=c("uri");return{endWithSlash:function(b){return e.endsWith(b,"/")},startWithSlash:function(b){return e.startsWith(b,"/")},removeEndSlash:function(b){this.endWithSlash(b)&&(b=b.substring(0,b.length-1));return b},removeStartSlash:function(b){this.startWithSlash(b)&&(b=b.substring(1));return b},
addEndSlash:function(b){return this.removeEndSlash(b)+"/"},addStartSlash:function(b){return b?"/"+this.removeStartSlash(b):b},getFullPath:function(b,a){return location.protocol+"//"+location.host+this.removeEndSlash(a)+this.addStartSlash(b)},equalsIgnoreSlash:function(b,a){b=this.removeEndSlash(b);a=this.removeEndSlash(a);return b===a},getHash:function(b){return a(b.getFragment().replace(/^!/,"")).replace(i.REPLACE_HISTORY,"")},removeVid:a,hasVid:function(b){return-1!==b.indexOf("__ks-vid=")},addVid:function(b,
a){return b+"__ks-vid="+a},getVidFromUrlWithHash:function(b){return m((new g(b)).getFragment())},getVidFromHash:m}});
KISSY.add("router/route",[],function(e){function c(a,i,c,b){e.isArray(a)&&(a="("+a.join("|")+")");a=a.concat(c?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,a,m,c,e,f,g){i.push(c);a=a||"";return""+(f?"":a)+"(?:"+(f?a:"")+(m||"")+(e||m&&"([^/.]+?)"||"([^/]+?)")+")"+(f||"")+(g?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:i,regexp:RegExp("^"+a+"$",b?"":"i")}}function a(a,i,g){this.path=a;this.callbacks=i;this.keys=[];"string"===
typeof a||e.isArray(a)?e.mix(this,c(a,this.keys,g.strict,g.caseSensitive)):this.regexp=a}a.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var c=this.keys,g=[],b=1,o=a.length;b<o;++b){var p=c[b-1],r="string"===typeof a[b]?e.urlDecode(a[b]):a[b];p?g[p]=r:g.push(r)}return g},removeCallback:function(a){for(var c=this.callbacks||[],e=c.length-1;0<=e;e++)c===a&&c.splice(e,1)}};return a});
KISSY.add("router/request",[],function(e){function c(a){e.mix(this,a)}c.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return c});
KISSY.add("router","./router/utils,./router/route,uri,./router/request,event/dom,event/custom".split(","),function(e,c,a){function m(a,b){var d=h.addVid("#!"+a+(A?"":b?s.REPLACE_HISTORY:""),n);b?location.replace(d):location.hash=d}function i(a){a=a||location.href;a=new v(a);if(!j.useHash&&k){var b=a.query;return a.getPath().substr(j.urlRoot.length)+(b.has()?"?"+b.toString():"")}return h.getHash(a)}function g(a,b,d){function c(){f++;if(f===g)d(a,b);else{var h=u[f];if(e.startsWith(a.path+"/",h[0]+"/")){var i=
h[0].length;a.url=a.url.slice(i);var j=a.path;a.path=a.path.slice(i);h[1](a,c);a.url=a.originalUrl;a.path=j}else c()}}var f=-1,g=u.length;c()}function b(a,b){function d(){c++;if(c!==e){var h=f[c];if(a.params=h.match(a.path)){var i=-1,g=h.callbacks,j=g.length,k=function(c){if(c==="route"){k=null;d()}else{i++;if(i!==j){a.route=h;g[i](a,b,k)}}};k("")}else d()}}var c=-1,e=f.length;d()}function o(y,c){var d=i(),e=new v(d),f=e.query.get();e.query.reset();d=new B({query:f,backward:y===true,replace:c===true,
forward:y===false&&c===false,path:e.toString()||"/",url:d,originalUrl:d});e={redirect:a.navigate};a.fire("dispatch",{request:d,response:e});g(d,e,b)}function p(a){var b=false,d=false;if(a===l[l.length-2]){b=true;l.pop()}else a!==l[l.length-1]?l.push(a):d=true;o(b,d)}function r(a){(a=a.originalEvent.state)&&p(a.vid)}function x(a){(a=z(a.newURL||location.href))&&p(a)}var u=[],f=[],h=c("./router/utils"),C=c("./router/route"),v=c("uri"),B=c("./router/request"),s=c("event/dom"),c=c("event/custom"),z=h.getVidFromUrlWithHash,
t=e.Env.host,q=t.history,A=e.Feature.isHashChangeSupported(),k=!(!q||!q.pushState),n=10,l=[n],j={urlRoot:"",useHash:!k};e.mix(a,c.Target);a.use=function(a,b){if(typeof a!=="string"){b=a;a=""}u.push([a,b])};a.navigate=function(a,b){var b=b||{},d=b.replace||false;if(i()!==a){if(!d){n++;l.push(n)}if(!j.useHash&&k){q[d?"replaceState":"pushState"]({vid:n},"",h.getFullPath(a,j.urlRoot));o(false,d)}else if(k){q[d?"replaceState":"pushState"]({vid:n},"","#!"+a);o(false,d)}else m(a,d)}else b&&b.triggerRoute&&
o(false,true)};a.get=function(a){var b=e.makeArray(arguments).slice(1);f.push(new C(a,b,j))};a.matchRoute=function(a){for(var b=0,d=f.length;b<d;b++)if(f[b].match(a))return f[b];return false};a.removeRoute=function(a,b){for(var d=f.length-1;d>=0;d--){var c=f[d];if(c.path===a)if(b){c.removeCallback(b);c.callbacks.length||f.splice(d,1)}else f.splice(d,1)}};a.clearRoutes=function(){u=[];f=[]};a.hasRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].path===a)return f[b];return false};a.config=function(a){if(a.urlRoot)a.urlRoot=
a.urlRoot.replace(/\/$/,"");e.mix(j,a)};var w;a.start=function(b){if(w)return b&&b.call(a);var c=j.useHash,d=j.urlRoot,e=j.triggerRoute,f=location.pathname,g=location.href,l=i(),p=location.hash.match(/#!.+/);if(!c)if(k){if(p&&h.equalsIgnoreSlash(f,d)){q.replaceState({},"",h.getFullPath(l,d));e=1}}else if(h.equalsIgnoreSlash(f,d))c=true;else{location.replace(h.addEndSlash(d)+"#!"+l);return}setTimeout(function(){var d=k;if(k)s.on(t,"popstate",r);else{s.on(t,"hashchange",x);e=1}if(c)if(i())if(!k&&z(g)!==
n){m(h.getHash(new v(g)),true);e=0}else k&&h.hasVid(g)&&location.replace(g=h.removeVid(g));else{a.navigate("/",{replace:1});e=0;d=false}d&&q.replaceState({vid:n},"",g);e&&o(false,true);b&&b(a)},100);w=true;return a};a.Utils=h;a.stop=function(){w=false;s.detach(t,"hashchange",x);s.detach(t,"popstate",r)}});
