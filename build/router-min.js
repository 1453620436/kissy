/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Mar 11 23:36
*/
KISSY.add("router/utils",["event/dom"],function(e,d){function a(b){return b.replace(/__ks-vid=.+$/,"")}function l(b){var a;return(a=b.match(/__ks-vid=(.+)$/))?parseInt(a[1],10):0}var h=d("event/dom");return{endWithSlash:function(b){return e.endsWith(b,"/")},startWithSlash:function(b){return e.startsWith(b,"/")},removeEndSlash:function(b){this.endWithSlash(b)&&(b=b.substring(0,b.length-1));return b},removeStartSlash:function(b){this.startWithSlash(b)&&(b=b.substring(1));return b},addEndSlash:function(b){return this.removeEndSlash(b)+
"/"},addStartSlash:function(b){return b?"/"+this.removeStartSlash(b):b},getFullPath:function(b,a){return location.protocol+"//"+location.host+this.removeEndSlash(a)+this.addStartSlash(b)},equalsIgnoreSlash:function(b,a){b=this.removeEndSlash(b);a=this.removeEndSlash(a);return b===a},getHash:function(b){return a(b.getFragment().replace(/^!/,"")).replace(h.REPLACE_HISTORY,"")},removeVid:a,hasVid:function(b){return-1!==b.indexOf("__ks-vid=")},addVid:function(b,a){return b+"__ks-vid="+a},getVidFromUrlWithHash:function(b){return l((new e.Uri(b)).getFragment())},
getVidFromHash:l}});
KISSY.add("router/route",[],function(e){function d(a,h,b,d){e.isArray(a)&&(a="("+a.join("|")+")");a=a.concat(b?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,a,l,e,d,f,g){h.push(e);a=a||"";return""+(f?"":a)+"(?:"+(f?a:"")+(l||"")+(d||l&&"([^/.]+?)"||"([^/]+?)")+")"+(f||"")+(g?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:h,regexp:RegExp("^"+a+"$",d?"":"i")}}function a(a,h,b){this.path=a;this.callbacks=h;this.keys=[];"string"===
typeof a||e.isArray(a)?e.mix(this,d(a,this.keys,b.strict,b.caseSensitive)):this.regexp=a}a.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var d=this.keys,b=[],i=1,q=a.length;i<q;++i){var m=d[i-1],s="string"===typeof a[i]?e.urlDecode(a[i]):a[i];m?b[m]=s:b.push(s)}return b},removeCallback:function(a){for(var e=this.callbacks||[],b=e.length-1;0<=b;b++)e===a&&e.splice(b,1)}};return a});
KISSY.add("router/request",[],function(e){function d(a){e.mix(this,a)}d.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return d});
KISSY.add("router","./router/utils,./router/route,uri,./router/request,event/dom,event/custom".split(","),function(e,d,a){function l(a,b){var c=g.addVid("#!"+a+(B?"":b?t.REPLACE_HISTORY:""),n);b?location.replace(c):location.hash=c}function h(a){a=a||location.href;a=new C(a);if(!j.useHash&&o){var b=a.query;return a.getPath().substr(j.urlRoot.length)+(b.has()?"?"+b.toString():"")}return g.getHash(a)}function b(a,b,c){function v(){d++;if(d===f)c(a,b);else{var g=r[d];if(e.startsWith(a.path+"/",g[0]+"/")){var h=
g[0].length;a.url=a.url.slice(h);var j=a.path;a.path=a.path.slice(h);g[1](a,v);a.url=a.originalUrl;a.path=j}else v()}}var d=-1,f=r.length;v()}function i(a,b){function c(){e++;if(e!==d){var g=f[e];if(a.params=g.match(a.path)){var h=-1,j=g.callbacks,l=j.length,i=function(e){if(e==="route"){i=null;c()}else{h++;if(h!==l){a.route=g;j[h](a,b,i)}}};i("")}else c()}}var e=-1,d=f.length;c()}function q(y,z){var c=h(),d=new e.Uri(c),g=d.query.get();d.query.reset();c=new D({query:g,backward:y===true,replace:z===
true,forward:y===false&&z===false,path:d.toString()||"/",url:c,originalUrl:c});d={redirect:a.navigate};a.fire("dispatch",{request:c,response:d});b(c,d,i)}function m(a){var b=false,c=false;if(a===k[k.length-2]){b=true;k.pop()}else a!==k[k.length-1]?k.push(a):c=true;q(b,c)}function s(a){(a=a.originalEvent.state)&&m(a.vid)}function x(a){(a=A(a.newURL||location.href))&&m(a)}var r=[],f=[],g=d("./router/utils"),E=d("./router/route"),C=d("uri"),D=d("./router/request"),t=d("event/dom"),d=d("event/custom"),
A=g.getVidFromUrlWithHash,u=e.Env.host,p=u.history,B=e.Feature.isHashChangeSupported(),o=!(!p||!p.pushState),n=10,k=[n],j={urlRoot:"",useHash:!(p&&p.pushState)};e.mix(a,d.Target);a.use=function(a,b){if(typeof a!=="string"){b=a;a=""}r.push([a,b])};a.navigate=function(a,b){var b=b||{},c=b.replace||false;if(h()!==a){if(!c){n++;k.push(n)}if(!j.useHash&&o){p[c?"replaceState":"pushState"]({vid:n},"",g.getFullPath(a,j.urlRoot));q(false,c)}else if(o){p[c?"replaceState":"pushState"]({vid:n},"","#!"+a);q(false,
c)}else l(a,c)}else b&&b.triggerRoute&&q(false,true)};a.get=function(a){var b=e.makeArray(arguments).slice(1);f.push(new E(a,b,j))};a.matchRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].match(a))return f[b];return false};a.removeRoute=function(a,b){for(var c=f.length-1;c>=0;c--){var d=f[c];if(d.path===a)if(b){d.removeCallback(b);d.callbacks.length||f.splice(c,1)}else f.splice(c,1)}};a.clearRoutes=function(){r=[];f=[]};a.hasRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].path===
a)return f[b];return false};a.config=function(a){if(a.urlRoot)a.urlRoot=a.urlRoot.replace(/\/$/,"");e.mix(j,a)};var w;a.start=function(b){if(w)return b&&b.call(a);var d=j.useHash,c=j.urlRoot,f=j.triggerRoute,i=location.pathname,k=location.href,m=h(),r=location.hash.match(/#!.+/);if(!d)if(o){if(r&&g.equalsIgnoreSlash(i,c)){p.replaceState({},"",g.getFullPath(m,c));f=1}}else if(g.equalsIgnoreSlash(i,c))d=true;else{location.replace(g.addEndSlash(c)+"#!"+m);return}setTimeout(function(){var c=o;if(o)t.on(u,
"popstate",s);else{t.on(u,"hashchange",x);f=1}if(d)if(h())if(!o&&A(k)!==n){l(g.getHash(new e.Uri(k)),true);f=0}else o&&g.hasVid(k)&&location.replace(k=g.removeVid(k));else{a.navigate("/",{replace:1});f=0;c=false}c&&p.replaceState({vid:n},"",k);f&&q(false,true);b&&b(a)},100);w=true;return a};a.Utils=g;a.stop=function(){w=false;t.detach(u,"hashchange",x);t.detach(u,"popstate",s)}});
