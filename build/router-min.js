/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Jan 17 13:06
*/
KISSY.add("router/utils",[],function(h){function b(a){return a.replace(/__ks-vid=.+$/,"")}function c(a){var e;return(e=a.match(/__ks-vid=(.+)$/))?parseInt(e[1],10):0}return{endWithSlash:function(a){return h.endsWith(a,"/")},startWithSlash:function(a){return h.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+
"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,e){return location.protocol+"//"+location.host+this.removeEndSlash(e)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,e){a=this.removeEndSlash(a);e=this.removeEndSlash(e);return a===e},getHash:function(a){return b(a.getFragment().replace(/^!/,""))},removeVid:b,hasVid:function(a){return-1!==a.indexOf("__ks-vid=")},addVid:function(a,e){return a+"__ks-vid="+e},getVidFromUrlWithHash:function(a){return c((new h.Uri(a)).getFragment())},
getVidFromHash:c}});
KISSY.add("router/route",[],function(h){function b(e){var c=[],e=h.escapeRegExp(e),e=e.replace(a,function(a,e,b,r,j){a={};b&&h.endsWith(b,"?")&&(a.optional=!0,b=b.slice(0,-1));a.name=b||j;c.push(a);if(b)return"([^/]+)";if(j)return"(.*)"});return{keys:c,regexp:RegExp("^"+e+"$")}}function c(a,c){this.path=a;this.callbacks=c;"string"===typeof a?h.mix(this,b(a)):this.regexp=a}var a=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;c.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var c=this.keys||
[],b=[],f=1,q=a.length;f<q;++f){var r=c[f-1],j="string"===typeof a[f]?h.urlDecode(a[f]):a[f];r?b[r.name]=j:b.push(j)}return b},removeCallback:function(a){for(var c=this.callbacks||[],b=c.length-1;0<=b;b++)c===a&&c.splice(b,1)}};return c});KISSY.add("router/request",[],function(h){function b(c){h.mix(this,c)}b.prototype={param:function(c){return c in this.params?this.params[c]:this.query[c]}};return b});
KISSY.add("router","./router/utils,./router/route,uri,./router/request,event/dom,event/custom".split(","),function(h,b,c){function a(d,a){var k=i.addVid("#!"+d+(A?"":t.REPLACE_HISTORY),n);a?location.replace(k):location.hash=k}function e(d){d=d||location.href;d=new B(d);if(!o&&l){var a=d.query;return d.getPath().substr(p.length)+(a.has()?"?"+a.toString():"")}return i.getHash(d)}function y(d,a,k){function c(){b++;if(b===e)k(d,a);else{var g=v[b];if(h.startsWith(d.path+"/",g[0]+"/")){var f=g[0].length;
d.url=d.url.slice(f);var i=d.path;d.path=d.path.slice(f);g[1](d,c);d.url=d.originalUrl;d.path=i}else c()}}var b=-1,e=v.length;c()}function z(d,a){function c(){b++;if(b!==e){var h=g[b];if(d.params=h.match(d.path)){var f=-1,i=h.callbacks,l=i.length,j=function(b){if(b==="route"){j=null;c()}else{f++;if(f!==l){d.route=h;i[f](d,a,j)}}};j("")}else c()}}var b=-1,e=g.length;c()}function f(d,a){var b=e(),f=new h.Uri(b),g=f.query.get();f.query.reset();b=new C({query:g,backward:d===true,replace:a===true,forward:d===
false&&a===false,path:f.toString()||"/",url:b,originalUrl:b});f={redirect:c.navigate};c.fire("dispatch",{request:b,response:f});y(b,f,z)}function q(d){var a=false,b=false;if(d===m[m.length-2]){a=true;m.pop()}else d!==m[m.length-1]?m.push(d):b=true;f(a,b)}function r(a){(a=a.originalEvent.state)&&q(a.vid)}function j(a){(a=x(a.newURL||location.href))&&q(a)}var v=[],g=[],i=b("./router/utils"),D=b("./router/route"),B=b("uri"),C=b("./router/request"),t=b("event/dom"),b=b("event/custom"),w=false,o,p,x=i.getVidFromUrlWithHash,
u=h.Env.host,s=u.history,A=h.Feature.isHashChangeSupported(),l=!(!s||!s.pushState),n=10,m=[n];h.mix(c,b.Target);c.use=function(a,b){if(typeof a!=="string"){b=a;a=""}v.push([a,b])};c.navigate=function(d,b){var b=b||{},c=b.replace||false;if(e()!==d){if(!c){n++;m.push(n)}if(!o&&l){s[c?"replaceState":"pushState"]({vid:n},"",i.getFullPath(d,p));f(false,c)}else if(l){s[c?"replaceState":"pushState"]({vid:n},"","#!"+d);f(false,c)}else a(d,c)}else b&&b.triggerRoute&&f(false,true)};c.get=function(a){var b=
h.makeArray(arguments).slice(1);g.push(new D(a,b))};c.matchRoute=function(a){for(var b=0,c=g.length;b<c;b++)if(g[b].match(a))return g[b];return false};c.removeRoute=function(a,b){for(var c=g.length-1;c>=0;c--){var e=g[c];if(e.path===a)if(b){e.removeCallback(b);e.callbacks.length||g.splice(c,1)}else g.splice(c,1)}};c.clearRoutes=function(){v=[];g=[]};c.hasRoute=function(a){for(var b=0,c=g.length;b<c;b++)if(g[b].path===a)return g[b];return false};c.start=function(b){b=b||{};if(w)return b.success&&b.success.call(c);
b.urlRoot=(b.urlRoot||"").replace(/\/$/,"");o=b.useHash;p=b.urlRoot;o===void 0&&(o=true);b.useHashChange&&(l=false);var g=location.pathname,k=location.href,m=e(),q=location.hash.match(/#!.+/);if(!o)if(l){if(q)if(i.equalsIgnoreSlash(g,p)){s.replaceState({},"",i.getFullPath(m,p));b.triggerRoute=1}else"router: location path must be same with urlRoot!"}else if(i.equalsIgnoreSlash(g,p))o=true;else{location.replace(i.addEndSlash(p)+"#!"+m);return}setTimeout(function(){var g=l;if(l)t.on(u,"popstate",r);
else{t.on(u,"hashchange",j);b.triggerRoute=1}if(o)if(e())if(!l&&x(k)!==n){a(i.getHash(new h.Uri(k)),true);b.triggerRoute=0}else l&&i.hasVid(k)&&location.replace(k=i.removeVid(k));else{c.navigate("/",{replace:1});b.triggerRoute=0;g=false}g&&s.replaceState({vid:n},"",k);b.triggerRoute&&f(false,true);b.success&&b.success()},100);w=true;return c};c.stop=function(){w=false;t.detach(u,"hashchange",j);t.detach(u,"popstate",r)}});
