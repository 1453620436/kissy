/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Jan 14 17:33
*/
KISSY.add("router/utils",[],function(g){function c(a){return a.replace(/__ks-vid=.+$/,"")}function b(a){var e;return(e=a.match(/__ks-vid=(.+)$/))?parseInt(e[1],10):0}return{endWithSlash:function(a){return g.endsWith(a,"/")},startWithSlash:function(a){return g.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+
"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,e){return location.protocol+"//"+location.host+this.removeEndSlash(e)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,e){a=this.removeEndSlash(a);e=this.removeEndSlash(e);return a===e},getHash:function(a){return c(a.getFragment().replace(/^!/,""))},removeVid:c,hasVid:function(a){return-1!==a.indexOf("__ks-vid=")},addVid:function(a,e){return a+"__ks-vid="+e},getVidFromUrlWithHash:function(a){return b((new g.Uri(a)).getFragment())},
getVidFromHash:b}});
KISSY.add("router/route",[],function(g){function c(e){var b=[],e=g.escapeRegExp(e),e=e.replace(a,function(a,e,c,r,m){a={};c&&g.endsWith(c,"?")&&(a.optional=!0,c=c.slice(0,-1));a.name=c||m;b.push(a);if(c)return"([^/]+)";if(m)return"(.*)"});return{keys:b,regexp:RegExp("^"+e+"$")}}function b(a,b){this.path=a;this.callbacks=b;"string"===typeof a?g.mix(this,c(a)):this.regexp=a}var a=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;b.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var b=this.keys||
[],c=[],i=1,q=a.length;i<q;++i){var r=b[i-1],m="string"===typeof a[i]?g.urlDecode(a[i]):a[i];r?c[r.name]=m:c.push(m)}return c},removeCallback:function(a){for(var b=this.callbacks||[],c=b.length-1;0<=c;c++)b===a&&b.splice(c,1)}};return b});KISSY.add("router/request",[],function(g){function c(b){g.mix(this,b)}c.prototype={param:function(b){return b in this.params?this.params[b]:this.query[b]}};return c});
KISSY.add("router",["./router/utils","./router/route","uri","./router/request","event/dom"],function(g,c,b){function a(d,a){var h=j.addVid("#!"+d+(A?"":t.REPLACE_HISTORY),n);a?location.replace(h):location.hash=h}function e(d){d=d||location.href;d=new B(d);if(!o&&k){var a=d.query;return d.getPath().substr(p.length)+(a.has()?"?"+a.toString():"")}return j.getHash(d)}function y(d,a,h){function b(){c++;if(c===e)h(d,a);else{var f=v[c];if(g.startsWith(d.path+"/",f[0]+"/")){var i=f[0].length;d.url=d.url.slice(i);
var j=d.path;d.path=d.path.slice(i);f[1](d,b);d.url=d.originalUrl;d.path=j}else b()}}var c=-1,e=v.length;b()}function z(d,a){function h(){b++;if(b!==c){var e=f[b];if(d.params=e.match(d.path)){var g=-1,i=e.callbacks,j=i.length,k=function(b){"route"===b?(k=null,h()):(g++,g!==j&&(d.route=e,i[g](d,a,k)))};k("")}else h()}}var b=-1,c=f.length;h()}function i(d,a){var h=e(),c=new g.Uri(h),i=c.query.get();c.query.reset();h=new C({query:i,backward:d,replace:a,path:c.toString()||"/",url:h,originalUrl:h});y(h,
{redirect:b.navigate},z)}function q(d){var a=!1,b=!1;d===l[l.length-2]?(a=!0,l.pop()):d!==l[l.length-1]?l.push(d):b=!0;i(a,b)}function r(a){(a=a.originalEvent.state)&&q(a.vid)}function m(a){(a=x(a.newURL||location.href))&&q(a)}var v=[],f=[],j=c("./router/utils"),D=c("./router/route"),B=c("uri"),C=c("./router/request"),t=c("event/dom"),w=!1,o,p,x=j.getVidFromUrlWithHash,u=g.Env.host,s=u.history,A=g.Features.isHashChangeSupported(),k=!(!s||!s.pushState),n=10,l=[n];b.use=function(a,b){"string"!==typeof a&&
(b=a,a="");v.push([a,b])};b.navigate=function(d,b){var b=b||{},c=b.replace;e()!==d?(c||(n++,l.push(n)),!o&&k)?(s[c?"replaceState":"pushState"]({vid:n},"",j.getFullPath(d,p)),i(!1,c)):k?(s[c?"replaceState":"pushState"]({vid:n},"","#!"+d),i(!1,c)):a(d,c):b&&b.triggerRoute&&i(!1,!0)};b.get=function(a){var b=g.makeArray(arguments).slice(1);f.push(new D(a,b))};b.matchRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].match(a))return f[b];return!1};b.removeRoute=function(a,b){for(var c=f.length-1;0<=
c;c--){var e=f[c];e.path===a&&(b?(e.removeCallback(b),e.callbacks.length||f.splice(c,1)):f.splice(c,1))}};b.clearRoutes=function(){v=[];f=[]};b.hasRoute=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b].path===a)return f[b];return!1};b.start=function(c){c=c||{};if(w)return c.success&&c.success.call(b);c.urlRoot=(c.urlRoot||"").replace(/\/$/,"");o=c.useHash;p=c.urlRoot;void 0===o&&(o=!0);c.useHashChange&&(k=!1);var f=location.pathname,h=location.href,l=e(),q=location.hash.match(/#!.+/);if(!o)if(k)q&&
(j.equalsIgnoreSlash(f,p)?(s.replaceState({},"",j.getFullPath(l,p)),c.triggerRoute=1):"router: location path must be same with urlRoot!");else if(j.equalsIgnoreSlash(f,p))o=!0;else{location.replace(j.addEndSlash(p)+"#!"+l);return}setTimeout(function(){var f=k;if(k)t.on(u,"popstate",r);else t.on(u,"hashchange",m),c.triggerRoute=1;o&&(e()?!k&&x(h)!==n?(a(j.getHash(new g.Uri(h)),!0),c.triggerRoute=0):k&&j.hasVid(h)&&location.replace(h=j.removeVid(h)):(b.navigate("/",{replace:1}),c.triggerRoute=0,f=!1));
f&&s.replaceState({vid:n},"",h);c.triggerRoute&&i();c.success&&c.success()},100);w=!0;return b};b.stop=function(){w=!1;t.detach(u,"hashchange",m);t.detach(u,"popstate",r)}});
