/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Apr 4 12:24
*/
KISSY.add("router/utils",["event/dom"],function(e,c){function a(b){return b.replace(/__ks-vid=.+$/,"")}function m(b){var a;return(a=b.match(/__ks-vid=(.+)$/))?parseInt(a[1],10):0}function h(b){return(b=b.match(/#(.+)$/))&&b[1]||""}var f=c("event/dom");return{endWithSlash:function(b){return e.endsWith(b,"/")},startWithSlash:function(b){return e.startsWith(b,"/")},removeEndSlash:function(b){this.endWithSlash(b)&&(b=b.substring(0,b.length-1));return b},removeStartSlash:function(b){this.startWithSlash(b)&&
(b=b.substring(1));return b},addEndSlash:function(b){return this.removeEndSlash(b)+"/"},addStartSlash:function(b){return b?"/"+this.removeStartSlash(b):b},getFullPath:function(b,a){return location.protocol+"//"+location.host+this.removeEndSlash(a)+this.addStartSlash(b)},equalsIgnoreSlash:function(b,a){b=this.removeEndSlash(b);a=this.removeEndSlash(a);return b===a},getHash:function(b){return a(h(b).replace(/^!/,"")).replace(f.REPLACE_HISTORY,"")},removeVid:a,hasVid:function(b){return-1!==b.indexOf("__ks-vid=")},
addVid:function(b,a){return b+"__ks-vid="+a},getVidFromUrlWithHash:function(b){return m(h(b))},getVidFromHash:m}});
KISSY.add("router/route",[],function(e){function c(a,h,f,b){e.isArray(a)&&(a="("+a.join("|")+")");a=a.concat(f?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,a,m,e,f,g,c){h.push(e);a=a||"";return""+(g?"":a)+"(?:"+(g?a:"")+(m||"")+(f||m&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")+(c?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:h,regexp:RegExp("^"+a+"$",b?"":"i")}}function a(a,h,f){this.path=a;this.callbacks=h;this.keys=[];"string"===
typeof a||e.isArray(a)?e.mix(this,c(a,this.keys,f.strict,f.caseSensitive)):this.regexp=a}a.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var h=this.keys,f=[],b=1,c=a.length;b<c;++b){var o=h[b-1],r="string"===typeof a[b]?e.urlDecode(a[b]):a[b];o?f[o]=r:f.push(r)}return f},removeCallback:function(a){for(var c=this.callbacks||[],e=c.length-1;0<=e;e++)c===a&&c.splice(e,1)}};return a});
KISSY.add("router/request",[],function(e){function c(a){e.mix(this,a)}c.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return c});
KISSY.add("router","./router/utils,./router/route,uri,./router/request,event/dom,event/custom".split(","),function(e,c,a){function m(a,b){var d=i.addVid("#!"+a+(B?"":b?s.REPLACE_HISTORY:""),n);b?location.replace(d):location.hash=d}function h(a){var a=a||location.href,b=new z(a);if(!k.useHash&&j){a=b.query;return b.getPath().substr(k.urlRoot.length)+(a.has()?"?"+a.toString():"")}return i.getHash(a)}function f(a,b,d){function v(){c++;if(c===g)d(a,b);else{var h=u[c];if(e.startsWith(a.path+"/",h[0]+"/")){var f=
h[0].length;a.url=a.url.slice(f);var i=a.path;a.path=a.path.slice(f);h[1](a,v);a.url=a.originalUrl;a.path=i}else v()}}var c=-1,g=u.length;v()}function b(a,b){function d(){c++;if(c!==e){var h=g[c];if(a.params=h.match(a.path)){var f=-1,i=h.callbacks,k=i.length,j=function(c){if(c==="route"){j=null;d()}else{f++;if(f!==k){a.route=h;i[f](a,b,j)}}};j("")}else d()}}var c=-1,e=g.length;d()}function q(y,c){var d=h(),e=new z(d),g=e.query.get();e.query.reset();d=new C({query:g,backward:y===true,replace:c===true,
forward:y===false&&c===false,path:e.toString()||"/",url:d,originalUrl:d});e={redirect:a.navigate};a.fire("dispatch",{request:d,response:e});f(d,e,b)}function o(a){var b=false,d=false;if(a===l[l.length-2]){b=true;l.pop()}else a!==l[l.length-1]?l.push(a):d=true;q(b,d)}function r(a){(a=a.originalEvent.state)&&o(a.vid)}function x(a){(a=A(a.newURL||location.href))&&o(a)}var u=[],g=[],i=c("./router/utils"),D=c("./router/route"),z=c("uri"),C=c("./router/request"),s=c("event/dom"),c=c("event/custom"),A=i.getVidFromUrlWithHash,
t=e.Env.host,p=t.history,B=e.Feature.isHashChangeSupported(),j=!(!p||!p.pushState),n=10,l=[n],k={urlRoot:"",useHash:!j};e.mix(a,c.Target);a.use=function(a,b){if(typeof a!=="string"){b=a;a=""}u.push([a,b])};a.navigate=function(a,b){var b=b||{},d=b.replace||false;if(h()!==a){if(!d){n++;l.push(n)}if(!k.useHash&&j){p[d?"replaceState":"pushState"]({vid:n},"",i.getFullPath(a,k.urlRoot));q(false,d)}else if(j){p[d?"replaceState":"pushState"]({vid:n},"","#!"+a);q(false,d)}else m(a,d)}else b&&b.triggerRoute&&
q(false,true)};a.get=function(a){var b=e.makeArray(arguments).slice(1);g.push(new D(a,b,k))};a.matchRoute=function(a){for(var b=0,d=g.length;b<d;b++)if(g[b].match(a))return g[b];return false};a.removeRoute=function(a,b){for(var d=g.length-1;d>=0;d--){var c=g[d];if(c.path===a)if(b){c.removeCallback(b);c.callbacks.length||g.splice(d,1)}else g.splice(d,1)}};a.clearRoutes=function(){u=[];g=[]};a.hasRoute=function(a){for(var b=0,c=g.length;b<c;b++)if(g[b].path===a)return g[b];return false};a.config=function(a){if(a.urlRoot)a.urlRoot=
a.urlRoot.replace(/\/$/,"");e.mix(k,a)};var w;a.start=function(b){if(w)return b&&b.call(a);var c=k.useHash,d=k.urlRoot,e=k.triggerRoute,g=location.pathname,f=location.href,l=h(),o=location.hash.match(/#!.+/);if(!c)if(j){if(o&&i.equalsIgnoreSlash(g,d)){p.replaceState({},"",i.getFullPath(l,d));e=1}}else if(i.equalsIgnoreSlash(g,d))c=true;else{location.replace(i.addEndSlash(d)+"#!"+l);return}setTimeout(function(){var d=j;if(j)s.on(t,"popstate",r);else{s.on(t,"hashchange",x);e=1}if(c)if(h())if(!j&&A(f)!==
n){m(i.getHash(f),true);e=0}else j&&i.hasVid(f)&&location.replace(f=i.removeVid(f));else{a.navigate("/",{replace:1});e=0;d=false}d&&p.replaceState({vid:n},"",f);e&&q(false,true);b&&b(a)},100);w=true;return a};a.Utils=i;a.stop=function(){w=false;s.detach(t,"hashchange",x);s.detach(t,"popstate",r)}});
