/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Jan 8 13:16
*/
KISSY.add("router/utils",[],function(e){return{endWithSlash:function(a){return e.endsWith(a,"/")},startWithSlash:function(a){return e.startsWith(a,"/")},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,b){return location.protocol+
"//"+location.host+this.removeEndSlash(b)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,b){a=this.removeEndSlash(a);b=this.removeEndSlash(b);return a===b},getHash:function(a){return a.getFragment().replace(/^!/,"")}}});
KISSY.add("router/route",[],function(e){function a(a){var b=[],a=e.escapeRegExp(a),a=a.replace(n,function(a,w,c,g,h){a={};c&&e.endsWith(c,"?")&&(a.optional=!0,c=c.slice(0,-1));a.name=c||h;b.push(a);if(c)return"([^/]+)";if(h)return"(.*)"});return{keys:b,regexp:RegExp("^"+a+"$")}}function b(b,s){this.path=b;this.callbacks=s;"string"===typeof b?e.mix(this,a(b)):this.regexp=b}var n=/(:([\w\d]+\??))|(\\\*([\w\d]+))/g;b.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var b=this.keys||
[],d=[],f=1,c=a.length;f<c;++f){var g=b[f-1],h="string"===typeof a[f]?e.urlDecode(a[f]):a[f];g?d[g.name]=h:d.push(h)}return d},removeCallback:function(a){for(var b=this.callbacks||[],d=b.length-1;0<=d;d++)b===a&&b.splice(d,1)}};return b});KISSY.add("router/request",[],function(e){function a(a){e.mix(this,a)}a.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return a});
KISSY.add("router",["./router/utils","./router/route","uri","./router/request","event/dom"],function(e,a,b){function n(a){a=a||location.href;a=new x(a);if(!o&&i){var k=a.query;return a.getPath().substr(j.length)+(k.has()?"?"+k.toString():"")}return g.getHash(a)}function w(a,k,b){function c(){d++;if(d===g)b(a,k);else{var u=f[d];if(e.startsWith(a.path+"/",u[0]+"/")){var h=u[0].length;a.url=a.url.slice(h);var i=a.path;a.path=a.path.slice(h);u[1](a,c);a.url=a.originalUrl;a.path=i}else c()}}var d=-1,g=
f.length;c()}function s(a,b){function t(){d++;if(d!==e){var g=c[d];if(a.params=g.match(a.path)){var f=-1,h=g.callbacks,i=h.length,j=function(c){"route"===c?(j=null,t()):(f++,f!==i&&(a.route=g,h[f](a,b,j)))};j("")}else t()}}var d=-1,e=c.length;t()}function d(a){var k=n(),c=new e.Uri(k),d=c.query.get();c.query.reset();a=new y({query:d,backward:a,path:c.toString()||"/",url:k,originalUrl:k});w(a,{redirect:b.navigate},s)}var f=[],c=[],g=a("./router/utils"),h=a("./router/route"),x=a("uri"),y=a("./router/request"),
q=a("event/dom"),v=!1,o,j,r=e.Env.host,l=r.history,z=e.Features.isHashChangeSupported(),i=!(!l||!l.pushState),m=10,p=[m];b.use=function(a,b){"string"!==typeof a&&(b=a,a="");f.push([a,b])};b.navigate=function(a,b){var b=b||{},c=b.replaceHistory,e;n()!==a?(c||(m++,p.push(m)),!o&&i)?(l[c?"replaceState":"pushState"]({pageDepth:m},"",g.getFullPath(a,j)),d()):(e="#!"+a,c?i?(l.replaceState({pageDepth:m},"",e),d()):location.replace(e+(z?"":q.REPLACE_HISTORY)):i?(l.pushState({pageDepth:m},"",e),d()):location.hash=
e):b&&b.triggerRoute&&d()};b.get=function(a){var b=e.makeArray(arguments).slice(1);c.push(new h(a,b))};b.matchRoute=function(a){for(var b=0,d=c.length;b<d;b++)if(c[b].match(a))return c[b];return!1};b.removeRoute=function(a,b){for(var d=c.length-1;0<=d;d--){var e=c[d];e.path===a&&(b?(e.removeCallback(b),e.callbacks.length||c.splice(d,1)):c.splice(d,1))}};b.clearRoutes=function(){f=[];c=[]};b.hasRoute=function(a){for(var b=0,d=c.length;b<d;b++)if(c[b].path===a)return c[b];return!1};b.start=function(a){a=
a||{};if(v)return a.success&&a.success.call(b);a.urlRoot=(a.urlRoot||"").replace(/\/$/,"");o=a.useHash;j=a.urlRoot;var c=location.pathname,e=n(),f=location.hash.match(/#!.+/);if(!o)if(i)f&&(g.equalsIgnoreSlash(c,j)?(l.replaceState({},"",g.getFullPath(e,j)),a.triggerRoute=1):"router: location path must be same with urlRoot!");else if(!g.equalsIgnoreSlash(c,j)){location.replace(g.addEndSlash(j)+"#!"+e);return}setTimeout(function(){var c=i;if(i)q.on(r,"popstate",function(a){var a=a.originalEvent.state,
b=!1;a.pageDepth===p[p.length-2]?(b=!0,p.pop()):p.push(a.pageDepth);d(b)});else q.on(r,"hashchange",d),a.triggerRoute=1;o&&!n()&&(b.navigate("/",{replaceHistory:1}),a.triggerRoute=0,c=!1);c&&l.replaceState({pageDepth:m},"",location.href);a.triggerRoute&&d();a.success&&a.success()},100);v=!0;return b};b.stop=function(){v=!1;q.detach(r,"popstate hashchange",d)}});
