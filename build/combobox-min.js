/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 10 18:35
*/
KISSY.add("combobox/combobox-xtpl",[],function(l,f,k,i){f=function(g,a,d,h){var j=this,f=j.nativeCommands,b=j.utils;if("5.0.0"!==l.version)throw Error("current xtemplate file("+j.name+")(v5.0.0) need to be recompiled using current kissy(v"+l.version+")!");var i=b.callCommand,f=f["if"];a.write('<div class="');var b={escape:1},c=[];c.push("invalid-el");b.params=c;if((b=i(j,g,b,a,"getBaseCssClasses",1))&&b.isBuffer)a=b,b=h;a.write(b,!0);a.write('">\n    <div class="');b={escape:1};c=[];c.push("invalid-inner");
b.params=c;if((b=i(j,g,b,a,"getBaseCssClasses",2))&&b.isBuffer)a=b,b=h;a.write(b,!0);a.write('"></div>\n</div>\n\n');var b={escape:1},c=[],k=g.resolve(["hasTrigger"]);c.push(k);b.params=c;b.fn=function(b,a){a.write('\n<div class="');var d={escape:1},c=[];c.push("trigger");d.params=c;if((d=i(j,b,d,a,"getBaseCssClasses",6))&&d.isBuffer)a=d,d=h;a.write(d,!0);a.write('">\n    <div class="');d={escape:1};c=[];c.push("trigger-inner");d.params=c;if((d=i(j,b,d,a,"getBaseCssClasses",7))&&d.isBuffer)a=d,d=
h;a.write(d,!0);a.write('">&#x25BC;</div>\n</div>\n');return a};a=f.call(j,g,b,a,5,d);a.write('\n\n<div class="');b={escape:1};c=[];c.push("input-wrap");b.params=c;if((b=i(j,g,b,a,"getBaseCssClasses",11))&&b.isBuffer)a=b,b=h;a.write(b,!0);a.write('">\n\n    <input id="ks-combobox-input-');b=g.resolve(["id"]);a.write(b,!0);a.write('"\n           aria-haspopup="true"\n           aria-autocomplete="list"\n           aria-haspopup="true"\n           role="autocomplete"\n           aria-expanded="false"\n\n    ');
b={escape:1};c=[];k=g.resolve(["disabled"]);c.push(k);b.params=c;b.fn=function(b,a){a.write("\n    disabled\n    ");return a};a=f.call(j,g,b,a,20,d);a.write('\n\n    autocomplete="off"\n    class="');b={escape:1};c=[];c.push("input");b.params=c;if((b=i(j,g,b,a,"getBaseCssClasses",25))&&b.isBuffer)a=b,b=h;a.write(b,!0);a.write('"\n\n    value="');b=g.resolve(["value"]);a.write(b,!0);a.write('"\n    />\n\n\n    <label for="ks-combobox-input-');b=g.resolve(["id"]);a.write(b,!0);a.write("\"\n            style='display:");
b={escape:1};c=[];k=g.resolve(["value"]);c.push(k);b.params=c;b.fn=function(a,b){b.write("none");return b};b.inverse=function(b,a){a.write("block");return a};a=f.call(j,g,b,a,32,d);a.write(";'\n    class=\"");d={escape:1};f=[];f.push("placeholder");d.params=f;if((d=i(j,g,d,a,"getBaseCssClasses",33))&&d.isBuffer)a=d,d=h;a.write(d,!0);a.write('">\n    ');g=g.resolve(["placeholder"]);a.write(g,!0);a.write("\n    </label>\n</div>\n");return a};f.TPL_NAME=i.name;return f});
KISSY.add("combobox/control",["node","component/control","./combobox-xtpl","menu"],function(l,f){function k(e){for(var a=0;a<e.length;a++)if(!e[a].get("disabled"))return e[a];return null}function i(){n(this)}function g(){var e=this;setTimeout(function(){c(e)},0)}function a(){this.focus();c(this)}function d(){this.setCurrentValue(this.getCurrentValue(),{force:1})}function h(e){var b;b=this.get("menu");if(!e||b===e.target){var e=this.get("input"),o=b.get("el");b=b.get("contentEl");e.attr("aria-owns",
o.attr("id"));o.on("focusout",i,this);o.on("focusin",g,this);b.on("mouseover",a,this);b.on("mousedown",d,this);if(this.get("matchElWidth"))o.getWindow().on("resize",j,this)}}function j(){var e=this.get("menu");if(e.get("visible")){var b=this.get("el"),a=e.get("el"),a=(parseInt(a.css("borderLeftWidth"),10)||0)+(parseInt(a.css("borderRightWidth"),10)||0);e.set("width",b[0].offsetWidth-a)}}function p(e){e=e.target;e.isMenuItem&&(e=e.get("textContent"),this.setCurrentValue(e),this._savedValue=e,this.set("collapsed",
!0))}function b(e,a){var b=e.$el,d=e.getBaseCssClasses("invalid"),c=e.get("invalidEl");a?(b.addClass(d),c.attr("title",a),c.show()):(b.removeClass(d),c.hide())}function n(e){e._focusoutDismissTimer||(e._focusoutDismissTimer=setTimeout(function(){e._focusoutDismissTimer&&e.set("collapsed",!0)},50))}function c(e){var a=e._focusoutDismissTimer;a&&(clearTimeout(a),e._focusoutDismissTimer=null)}function q(e){this.set("value",e.target.value,{data:{causedByInputEvent:1}})}function r(e){var a,b=[],d,c,b=
this.get("menu"),e=this.normalizeData(e);b.removeChildren(!0);(c=b.get("highlightedItem"))&&c.set("highlighted",!1);if(e&&e.length){for(c=0;c<e.length;c++)a=e[c],b.addChild(a);b=b.get("children");e=this.getCurrentValue();if(this.get("highlightMatchItem"))for(c=0;c<b.length;c++)if(b[c].get("textContent")===e){b[c].set("highlighted",!0);d=!0;break}if(!d&&this.get("autoHighlightFirst"))for(c=0;c<b.length;c++)if(!b[c].get("disabled")){b[c].set("highlighted",!0);break}this.set("collapsed",!1);this.fire("afterRenderData")}else this.set("collapsed",
!0)}var s=f("node"),t=f("component/control"),u=f("./combobox-xtpl");f("menu");var m=s.KeyCode;return t.extend({initializer:function(){this.publish("afterRenderData",{bubbles:!1})},_savedValue:null,bindUI:function(){this.get("input").on("input",q,this);this.on("click",p,this);var e=this.get("menu");if(e.get("rendered"))h.call(this);else e.on("afterRenderUI",h,this)},destructor:function(){this.get("menu").destroy();this.$el.getWindow().detach("resize",j,this)},normalizeData:function(e){var b,a,c;if(e&&
e.length){e=e.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,this.getCurrentValue(),e):[];for(c=0;c<e.length;c++)a=e[c],b[c]=l.mix({content:a,textContent:a,value:a},b[c])}return b},getCurrentValue:function(){return this.get("value")},setCurrentValue:function(e,b){this.set("value",e,b)},_onSetValue:function(e,b){var a;b.causedByInputEvent?(a=this.getCurrentValue(),void 0===a?this.set("collapsed",!0):(this._savedValue=a,this.sendRequest(a))):this.get("input").val(e)},
handleFocusInternal:function(){var e;c(this);this.get("invalidEl")&&b(this,!1);(e=this.get("placeholderEl"))&&e.hide()},handleBlurInternal:function(e){var a=this,c=a.get("placeholderEl");a.callSuper(e);n(a);a.get("invalidEl")&&a.validate(function(e,c){e?!a.get("focused")&&c===a.get("value")&&b(a,e):b(a,!1)});c&&!a.get("value")&&c.show()},handleMouseDownInternal:function(a){var b,c;this.callSuper(a);b=a.target;if((c=this.get("trigger"))&&(c[0]===b||c.contains(b)))this.get("collapsed")?(this.focus(),
this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyDownInternal:function(a){var b,c=a.keyCode,d,g,f=this.get("menu");this.get("input");b=this.get("updateInputOnDownUp");if(f.get("visible")){d=f.get("highlightedItem");if(b&&d&&(g=f.get("children"),c===m.DOWN&&d===k(g.concat().reverse())||c===m.UP&&d===k(g)))return this.setCurrentValue(this._savedValue),d.set("highlighted",!1),!0;g=f.handleKeyDownInternal(a);d=f.get("highlightedItem");if(c===m.ESC)return this.set("collapsed",
!0),b&&this.setCurrentValue(this._savedValue),!0;b&&l.inArray(c,[m.DOWN,m.UP])&&this.setCurrentValue(d.get("textContent"));return c===m.TAB&&d&&(d.handleClickInternal(a),this.get("multiple"))?!0:g}if(c===m.DOWN||c===m.UP)if(a=this.getCurrentValue(),void 0!==a)return this.sendRequest(a),!0},validate:function(a){var b=this.get("validator"),c=this.getCurrentValue();b?b(c,function(b){a(b,c)}):a(!1,c)},sendRequest:function(a){this.get("dataSource").fetchData(a,r,this)},getKeyEventTarget:function(){return this.get("input")},
_onSetCollapsed:function(a){var b=this.$el,d=this.get("menu");if(a)d.hide();else if(c(this),!d.get("visible")){if(this.get("matchElWidth")){d.render();var g=d.get("el"),g=(parseInt(g.css("borderLeftWidth"),10)||0)+(parseInt(g.css("borderRightWidth"),10)||0);d.set("width",b[0].offsetWidth-g)}d.show()}this.get("input").attr("aria-expanded",!a)},_onSetDisabled:function(a,b){this.callSuper(a,b);this.get("input").attr("disabled",a)}},{ATTRS:{contentTpl:{value:u},input:{selector:function(){return"."+this.getBaseCssClass("input")}},
value:{value:"",sync:0,render:1,parse:function(){return this.get("input").val()}},trigger:{selector:function(){return"."+this.getBaseCssClass("trigger")}},placeholder:{render:1,sync:0,parse:function(){var a=this.get("placeholderEl");return a&&a.html()}},placeholderEl:{selector:function(){return"."+this.getBaseCssClass("placeholder")}},validator:{},invalidEl:{selector:function(){return"."+this.getBaseCssClass("invalid-el")}},allowTextSelection:{value:!0},hasTrigger:{value:!0,sync:0,render:1},menu:{value:{},
getter:function(a){a.isControl||(a.xclass=a.xclass||"popupmenu",a=this.createComponent(a),this.setInternal("menu",a));return a},setter:function(a){if(a.isControl){a.setInternal("parent",this);var b={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};l.mix(a.get("align"),b,!1)}}},collapsed:{render:1,sync:0,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0}},xclass:"combobox"})});
KISSY.add("combobox/local-data-source",["attribute"],function(l,f){return f("attribute").extend({fetchData:function(f,i,g){var a=this.get("parse"),d=this.get("data"),d=a(f,d);i.call(g,d)}},{ATTRS:{data:{value:[]},parse:{value:function(f,i){var g=[],a=0;if(!f)return i;l.each(i,function(d){-1!==d.indexOf(f)&&g.push(d);a++});return g}}}})});
KISSY.add("combobox/remote-data-source",["io","attribute"],function(l,f){var k=f("io");return f("attribute").extend({fetchData:function(f,g,a){var d=this,h,j=d.get("paramName"),l=d.get("parse"),b=d.get("cache"),n=d.get("allowEmpty");d.caches=d.caches||{};d.io&&(d.io.abort(),d.io=null);if(!f&&!0!==n)return g.call(a,[]);if(b&&(h=d.caches[f]))return g.call(a,h);h=d.get("xhrCfg");h.data=h.data||{};h.data[j]=f;h.success=function(c){l&&(c=l(f,c));d.setInternal("data",c);b&&(d.caches[f]=c);g.call(a,c)};
d.io=k(h)}},{ATTRS:{paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}}})});KISSY.add("combobox",["combobox/control","combobox/local-data-source","combobox/remote-data-source"],function(l,f){var k=f("combobox/control"),i=f("combobox/local-data-source"),g=f("combobox/remote-data-source");k.LocalDataSource=i;k.RemoteDataSource=g;return k});
