/*
Copyright 2013, KISSY v1.41
MIT Licensed
build time: Dec 2 15:11
*/
KISSY.add("combobox/combobox-xtpl",[],function(){return function(e,a,h){var f=this,a=this.config.utils,k=a.runBlockCommand,g=a.getExpression,c=a.getPropertyOrRunCommand,a='<div id="ks-combobox-invalid-el-',b=c(f,e,{},"id",0,1,h,!1),a=a+g(b,!0),a=a+'"\n     class="',b={},d=[];d.push("invalid-el");b.params=d;b=c(f,e,b,"getBaseCssClasses",0,2,!0,h);a=a+b+'">\n    <div class="';b={};d=[];d.push("invalid-inner");b.params=d;var b=c(f,e,b,"getBaseCssClasses",0,3,!0,h),a=a+b+'"></div>\n</div>\n\n',b={},d=
[],j=c(f,e,{},"hasTrigger",0,6,h,!0);d.push(j);b.params=d;b.fn=function(b){var d;d='\n<div id="ks-combobox-trigger-';var a=c(f,b,{},"id",0,7,h,!1);d+=g(a,!0);d+='"\n     class="';var a={},j=[];j.push("trigger");a.params=j;a=c(f,b,a,"getBaseCssClasses",0,8,!0,h);d=d+a+'">\n    <div class="';a={};j=[];j.push("trigger-inner");a.params=j;b=c(f,b,a,"getBaseCssClasses",0,9,!0,h);return d+b+'">&#x25BC;</div>\n</div>\n'};a+=k(f,e,b,"if",6);a+='\n\n<div class="';b={};d=[];d.push("input-wrap");b.params=d;b=
c(f,e,b,"getBaseCssClasses",0,13,!0,h);a=a+b+'">\n\n    <input id="ks-combobox-input-';b=c(f,e,{},"id",0,15,h,!1);a+=g(b,!0);a+='"\n           aria-haspopup="true"\n           aria-autocomplete="list"\n           aria-haspopup="true"\n           role="autocomplete"\n           aria-expanded="false"\n\n    ';b={};d=[];j=c(f,e,{},"disabled",0,22,h,!0);d.push(j);b.params=d;b.fn=function(){return"\n    disabled\n    "};a+=k(f,e,b,"if",22);a+='\n\n    autocomplete="off"\n    class="';b={};d=[];d.push("input");
b.params=d;b=c(f,e,b,"getBaseCssClasses",0,27,!0,h);a=a+b+'"\n\n    value="';b=c(f,e,{},"value",0,29,h,!1);a+=g(b,!0);a+='"\n    />\n\n\n    <label id="ks-combobox-placeholder-';b=c(f,e,{},"id",0,33,h,!1);a+=g(b,!0);a+='"\n           for="ks-combobox-input-';b=c(f,e,{},"id",0,34,h,!1);a+=g(b,!0);a+="\"\n            style='display:";b={};d=[];j=c(f,e,{},"value",0,35,h,!0);d.push(j);b.params=d;b.fn=function(){return"none"};b.inverse=function(){return"block"};a+=k(f,e,b,"if",35);a+=";'\n    class=\"";
k={};b=[];b.push("placeholder");k.params=b;k=c(f,e,k,"getBaseCssClasses",0,36,!0,h);a=a+k+'">\n    ';e=c(f,e,{},"placeholder",0,37,h,!1);a+=g(e,!0);return a+"\n    </label>\n</div>\n"}});
KISSY.add("combobox/render",["component/control","./combobox-xtpl"],function(e,a){var h=a("component/control"),f=a("./combobox-xtpl");return h.getDefaultRender().extend({beforeCreateDom:function(a,f){e.mix(f,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.control.get("input")},_onSetCollapsed:function(a){this.control.get("input").attr("aria-expanded",
!a)},_onSetDisabled:function(a,f){this.callSuper(a,f);this.control.get("input").attr("disabled",a)}},{ATTRS:{contentTpl:{value:f}},HTML_PARSER:{value:function(a){return a.one("."+this.getBaseCssClass("input")).val()},input:function(a){return a.one("."+this.getBaseCssClass("input"))},trigger:function(a){return a.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(a){return a.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(a){return a.one("."+this.getBaseCssClass("placeholder"))}}})});
KISSY.add("combobox/control",["node","component/control","./render","menu"],function(e,a){function h(o){for(var a=0;a<o.length;a++)if(!o[a].get("disabled"))return o[a];return null}function f(){j(this)}function k(){var a=this;setTimeout(function(){r(a)},0)}function g(){this.focus();r(this)}function c(){this.setValueFromAutocomplete(this.getValueForAutocomplete(),{force:1})}function b(a){a=a.target;a.isMenuItem&&(a=a.get("textContent"),this.setValueFromAutocomplete(a),this._savedValue=a,this.set("collapsed",
!0))}function d(a,b){var d=a.$el,j=a.view.getBaseCssClasses("invalid"),c=a.get("invalidEl");b?(d.addClass(j),c.attr("title",b),c.show()):(d.removeClass(j),c.hide())}function j(a){a._focusoutDismissTimer||(a._focusoutDismissTimer=setTimeout(function(){a._focusoutDismissTimer&&a.set("collapsed",!0)},50))}function r(a){var b=a._focusoutDismissTimer;b&&(clearTimeout(b),a._focusoutDismissTimer=null)}function l(a){this.set("value",a.newVal,{data:{causedByTimer:1}})}function i(a){var b,d=[],j,c,d=this.get("menu"),
a=this.normalizeData(a);d.removeChildren(!0);(c=d.get("highlightedItem"))&&c.set("highlighted",!1);if(a&&a.length){for(c=0;c<a.length;c++)b=a[c],d.addChild(b);d=d.get("children");a=this.getValueForAutocomplete();if(this.get("highlightMatchItem"))for(c=0;c<d.length;c++)if(d[c].get("textContent")===a){d[c].set("highlighted",!0);j=!0;break}if(!j&&this.get("autoHighlightFirst"))for(c=0;c<d.length;c++)if(!d[c].get("disabled")){d[c].set("highlighted",!0);break}this.set("collapsed",!1);this.fire("afterRenderData")}else this.set("collapsed",
!0)}var s=a("node"),q=a("component/control"),p=a("./render");a("menu");var m=s.KeyCode;return q.extend([],{initializer:function(){this.publish("afterRenderData",{bubbles:!1})},_savedValue:null,normalizeData:function(a){var b,d,c;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),a):[];for(c=0;c<a.length;c++)d=a[c],b[c]=e.mix({content:d,textContent:d,value:d},b[c])}return b},bindUI:function(){var a=this;a.get("input").on("valuechange",
l,a);a.on("click",b,a);a.get("menu").onRendered(function(b){var d=a.get("input"),j=b.get("el"),b=b.get("contentEl");d.attr("aria-owns",j.attr("id"));j.on("focusout",f,a);j.on("focusin",k,a);b.on("mouseover",g,a);b.on("mousedown",c,a)})},destructor:function(){this.get("menu").destroy()},getValueForAutocomplete:function(){return this.get("value")},setValueFromAutocomplete:function(a,b){this.set("value",a,b)},_onSetValue:function(a,b){var d;b.causedByTimer?(d=this.getValueForAutocomplete(),void 0===
d?this.set("collapsed",!0):(this._savedValue=d,this.sendRequest(d))):this.get("input").val(a)},handleFocusInternal:function(){var a;this.get("invalidEl")&&d(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlurInternal:function(a){var b=this,c=b.get("placeholderEl");b.callSuper(a);j(b);b.get("invalidEl")&&b.validate(function(a,c){a?!b.get("focused")&&c===b.get("value")&&d(b,a):d(b,!1)});c&&!b.get("value")&&c.show()},handleMouseDownInternal:function(a){var b,d;this.callSuper(a);b=a.target;if((d=
this.get("trigger"))&&(d[0]===b||d.contains(b)))this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyDownInternal:function(a){var b,d=a.keyCode,c,j,f=this.get("menu");this.get("input");b=this.get("updateInputOnDownUp");if(f.get("visible")){c=f.get("highlightedItem");if(b&&c&&(j=f.get("children"),d===m.DOWN&&c===h(j.concat().reverse())||d===m.UP&&c===h(j)))return this.setValueFromAutocomplete(this._savedValue),c.set("highlighted",!1),!0;j=
f.handleKeyDownInternal(a);c=f.get("highlightedItem");if(d===m.ESC)return this.set("collapsed",!0),b&&this.setValueFromAutocomplete(this._savedValue),!0;b&&e.inArray(d,[m.DOWN,m.UP])&&this.setValueFromAutocomplete(c.get("textContent"));return d===m.TAB&&c&&(c.handleClickInternal(a),this.get("multiple"))?!0:j}if(d===m.DOWN||d===m.UP)if(a=this.getValueForAutocomplete(),void 0!==a)return this.sendRequest(a),!0},validate:function(a){var b=this.get("validator"),d=this.getValueForAutocomplete();b?b(d,function(b){a(b,
d)}):a(!1,d)},sendRequest:function(a){this.get("dataSource").fetchData(a,i,this)},_onSetCollapsed:function(a){var b=this.$el,d=this.get("menu");a?d.hide():(r(this),d.get("visible")||(this.get("matchElWidth")&&(d.render(),a=d.get("el"),a=(parseInt(a.css("borderLeftWidth"))||0)+(parseInt(a.css("borderRightWidth"))||0),d.set("width",b[0].offsetWidth-a)),d.show()))}},{ATTRS:{input:{},value:{value:"",sync:0,view:1},trigger:{},placeholder:{view:1},placeholderEl:{},validator:{},invalidEl:{},allowTextSelection:{value:!0},
hasTrigger:{value:!0,view:1},menu:{value:{},getter:function(a){a.isControl||(a.xclass=a.xclass||"popupmenu",a=this.createComponent(a),this.setInternal("menu",a));return a},setter:function(a){if(a.isControl){a.setInternal("parent",this);var b={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};e.mix(a.get("align"),b,!1)}}},collapsed:{view:1,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},
xrender:{value:p}},xclass:"combobox"})});
KISSY.add("combobox/cursor",["node"],function(e,a){function h(a){var d=g;d||(d=f(k));"textarea"===""+a[0].type.toLowerCase()?d.css("width",a.css("width")):d.css("width",9999);e.each(c,function(c){d.css(c,a.css(c))});g||d.insertBefore(a[0].ownerDocument.body.firstChild);return g=d}var f=a("node").all,k='<div style="z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;"></div>',g,c="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");return function(a){var d=
f(a),a=d[0],c=a.ownerDocument,g=f(c),l=a.scrollTop,i=a.scrollLeft;if(c.selection)return a=c.selection.createRange(),{left:a.boundingLeft+i+g.scrollLeft(),top:a.boundingTop+l+a.boundingHeight+g.scrollTop()};g=d.offset();if("textarea"!==a.type)return g.top+=a.offsetHeight,g;c=h(d);d=a.selectionStart;c.html(e.escapeHtml(a.value.substring(0,d-1))+"<span>x</span>");c.offset(g);g=c.last();a=g.offset();a.top+=g.height();0<d&&(a.left+=g.width());a.top-=l;a.left-=i;return a}});
KISSY.add("combobox/multi-value-combobox",["./cursor","./control"],function(e,a){function h(a,b){return b&&-1!==a.indexOf(b)}function f(a){a.newVal&&a.target===this.get("menu")&&this.alignWithCursor()}function k(a){var b=a.get("input"),f=a.get("value"),l=[],i=[],e=a.get("literal"),k=a.get("separator"),a=a.get("separatorType"),p=!1,m=a!==g,b=b.prop("selectionStart"),o,n,t=-1;for(o=0;o<f.length;o++)(n=f.charAt(o),e&&n===e&&(p=!p),p)?i.push(n):(o===b&&(t=l.length),m&&c.test(n))?(i.length&&l.push(i.join("")),
i=[],i.push(n)):h(k,n)?a===g?(i.push(n),i.length&&l.push(i.join("")),i=[]):(i.length&&l.push(i.join("")),i=[],i.push(n)):i.push(n);i.length&&l.push(i.join(""));l.length||l.push("");-1===t&&(a===g&&h(k,n)&&l.push(""),t=l.length-1);return{tokens:l,cursorPosition:b,tokenIndex:t}}var g="suffix",c=/\s|\xa0/,b=a("./cursor");return a("./control").extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",f,this))},getValueForAutocomplete:function(){var a=
k(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),f=this.get("separatorType"),b=b[c],c=b.length-1;if(f!==g)if(h(a,b.charAt(0)))b=b.slice(1);else return;else f===g&&h(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueFromAutocomplete:function(a,b){var f=this.get("input"),e=k(this),i=e.tokens,e=Math.max(0,e.tokenIndex),s=this.get("separator"),q;q=this.get("separatorType");var p=i[e+1]||"",m=i[e];if(q!==g){if(i[e]=m.charAt(0)+a,a&&(!p||!c.test(p.charAt(0))))i[e]+=" "}else i[e]=a,q=m.length-
1,h(s,m.charAt(q))?i[e]+=m.charAt(q):1===s.length&&(i[e]+=s);e=i.slice(0,e+1).join("").length;this.set("value",i.join(""),b);f.prop("selectionStart",e);f.prop("selectionEnd",e)},alignWithCursor:function(){var a=this.get("menu"),c;c=this.get("input");c=b(c);a.move(c.left,c.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:g},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
KISSY.add("combobox/filter-select",["./control"],function(e,a,h,f){e=a("./control");f.exports=e.extend({validate:function(a){var f=this;f.callSuper(function(c,b){c?a(c,b):f.get("dataSource").fetchData(b,function(c){a:{if(c=f.normalizeData(c))for(var e=0;e<c.length;e++)if(c[e].textContent===b){c=c[e];break a}c=!1}a(c?"":f.get("invalidMessage"),b,c)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}})});
KISSY.add("combobox/local-data-source",["attribute"],function(e,a){return a("attribute").extend({fetchData:function(a,f,e){var g=this.get("parse"),c=this.get("data"),c=g(a,c);f.call(e,c)}},{ATTRS:{data:{value:[]},parse:{value:function(a,f){var k=[],g=0;if(!a)return f;e.each(f,function(c){-1!==c.indexOf(a)&&k.push(c);g++});return k}}}})});
KISSY.add("combobox/remote-data-source",["io","attribute"],function(e,a){var h=a("io");return a("attribute").extend({fetchData:function(a,e,g){var c=this,b,d=c.get("paramName"),j=c.get("parse"),r=c.get("cache"),l=c.get("allowEmpty");c.caches=c.caches||{};c.io&&(c.io.abort(),c.io=null);if(!a&&!0!==l)return e.call(g,[]);if(r&&(b=c.caches[a]))return e.call(g,b);b=c.get("xhrCfg");b.data=b.data||{};b.data[d]=a;b.success=function(b){j&&(b=j(a,b));c.setInternal("data",b);r&&(c.caches[a]=b);e.call(g,b)};
c.io=h(b)}},{ATTRS:{paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}}})});
KISSY.add("combobox",["combobox/control","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"],function(e,a){var h=a("combobox/control"),f=a("combobox/multi-value-combobox"),k=a("combobox/filter-select"),g=a("combobox/local-data-source"),c=a("combobox/remote-data-source");h.LocalDataSource=g;h.RemoteDataSource=c;h.FilterSelect=k;h.MultiValueComboBox=f;return h});
