/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 27 00:37
*/
KISSY.add("combobox/combobox-xtpl",[],function(){return function(f,b,d){var e=this,b=this.config.utils,k=b.runBlockCommand,i=b.getExpression,g=b.getPropertyOrRunCommand,b='<div id="ks-combobox-invalid-el-',a=g(e,f,{},"id",0,1,d,!1),b=b+i(a,!0),b=b+'"\n     class="',a={},c=[];c.push("invalid-el");a.params=c;a=g(e,f,a,"getBaseCssClasses",0,2,!0,d);b=b+a+'">\n    <div class="';a={};c=[];c.push("invalid-inner");a.params=c;var a=g(e,f,a,"getBaseCssClasses",0,3,!0,d),b=b+a+'"></div>\n</div>\n\n',a={},c=
[],h=g(e,f,{},"hasTrigger",0,6,d,!0);c.push(h);a.params=c;a.fn=function(a){var c;c='\n<div id="ks-combobox-trigger-';var b=g(e,a,{},"id",0,7,d,!1);c+=i(b,!0);c+='"\n     class="';var b={},h=[];h.push("trigger");b.params=h;b=g(e,a,b,"getBaseCssClasses",0,8,!0,d);c=c+b+'">\n    <div class="';b={};h=[];h.push("trigger-inner");b.params=h;a=g(e,a,b,"getBaseCssClasses",0,9,!0,d);return c+a+'">&#x25BC;</div>\n</div>\n'};b+=k(e,f,a,"if",6);b+='\n\n<div class="';a={};c=[];c.push("input-wrap");a.params=c;a=
g(e,f,a,"getBaseCssClasses",0,13,!0,d);b=b+a+'">\n\n    <input id="ks-combobox-input-';a=g(e,f,{},"id",0,15,d,!1);b+=i(a,!0);b+='"\n           aria-haspopup="true"\n           aria-autocomplete="list"\n           aria-haspopup="true"\n           role="autocomplete"\n           aria-expanded="false"\n\n    ';a={};c=[];h=g(e,f,{},"disabled",0,22,d,!0);c.push(h);a.params=c;a.fn=function(){return"\n    disabled\n    "};b+=k(e,f,a,"if",22);b+='\n\n    autocomplete="off"\n    class="';a={};c=[];c.push("input");
a.params=c;a=g(e,f,a,"getBaseCssClasses",0,27,!0,d);b=b+a+'"\n\n    value="';a=g(e,f,{},"value",0,29,d,!1);b+=i(a,!0);b+='"\n    />\n\n\n    <label id="ks-combobox-placeholder-';a=g(e,f,{},"id",0,33,d,!1);b+=i(a,!0);b+='"\n           for="ks-combobox-input-';a=g(e,f,{},"id",0,34,d,!1);b+=i(a,!0);b+="\"\n            style='display:";a={};c=[];h=g(e,f,{},"value",0,35,d,!0);c.push(h);a.params=c;a.fn=function(){return"none"};a.inverse=function(){return"block"};b+=k(e,f,a,"if",35);b+=";'\n    class=\"";
k={};a=[];a.push("placeholder");k.params=a;k=g(e,f,k,"getBaseCssClasses",0,36,!0,d);b=b+k+'">\n    ';f=g(e,f,{},"placeholder",0,37,d,!1);b+=i(f,!0);return b+"\n    </label>\n</div>\n"}});
KISSY.add("combobox/render",["component/control","./combobox-xtpl"],function(f,b){var d=b("component/control"),e=b("./combobox-xtpl");return d.getDefaultRender().extend({beforeCreateDom:function(b,d){f.mix(d,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.control.get("input")},_onSetCollapsed:function(b){this.control.get("input").attr("aria-expanded",
!b)},_onSetDisabled:function(b,d){this.callSuper(b,d);this.control.get("input").attr("disabled",b)}},{ATTRS:{contentTpl:{value:e}},HTML_PARSER:{value:function(b){return b.one("."+this.getBaseCssClass("input")).val()},input:function(b){return b.one("."+this.getBaseCssClass("input"))},trigger:function(b){return b.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(b){return b.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(b){return b.one("."+this.getBaseCssClass("placeholder"))}}})});
KISSY.add("combobox/control",["node","component/control","./render","menu"],function(f,b){function d(j){for(var a=0;a<j.length;a++)if(!j[a].get("disabled"))return j[a];return null}function e(){h(this)}function k(){var j=this;setTimeout(function(){r(j)},0)}function i(){this.focus();r(this)}function g(){this.setValueFromAutocomplete(this.getValueForAutocomplete(),{force:1})}function a(j){j=j.target;j.isMenuItem&&(j=j.get("textContent"),this.setValueFromAutocomplete(j),this._savedValue=j,this.set("collapsed",
!0))}function c(j,a){var b=j.$el,c=j.view.getBaseCssClasses("invalid"),h=j.get("invalidEl");a?(b.addClass(c),h.attr("title",a),h.show()):(b.removeClass(c),h.hide())}function h(a){a._focusoutDismissTimer||(a._focusoutDismissTimer=setTimeout(function(){a._focusoutDismissTimer&&a.set("collapsed",!0)},50))}function r(a){var b;if(b=a._focusoutDismissTimer)clearTimeout(b),a._focusoutDismissTimer=null}function l(a){this.set("value",a.newVal,{data:{causedByTimer:1}})}function m(a){var b,c=[],h,d,c=this.get("menu"),
a=this.normalizeData(a);c.removeChildren(!0);(d=c.get("highlightedItem"))&&d.set("highlighted",!1);if(a&&a.length){for(d=0;d<a.length;d++)b=a[d],c.addChild(b);c=c.get("children");a=this.getValueForAutocomplete();if(this.get("highlightMatchItem"))for(d=0;d<c.length;d++)if(c[d].get("textContent")==a){c[d].set("highlighted",!0);h=!0;break}if(!h&&this.get("autoHighlightFirst"))for(d=0;d<c.length;d++)if(!c[d].get("disabled")){c[d].set("highlighted",!0);break}this.set("collapsed",!1);this.fire("afterRenderData")}else this.set("collapsed",
!0)}var s=b("node"),p=b("component/control"),q=b("./render");b("menu");var o=o,n=s.KeyCode;return p.extend([],{initializer:function(){this.publish("afterRenderData",{bubbles:!1})},_savedValue:null,normalizeData:function(a){var c,b,d;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));c=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),a):[];for(d=0;d<a.length;d++)b=a[d],c[d]=f.mix({content:b,textContent:b,value:b},c[d])}return c},bindUI:function(){var c=this;c.get("input").on("valuechange",
l,c);c.on("click",a,c);c.get("menu").onRendered(function(a){var b=c.get("input"),d=a.get("el"),a=a.get("contentEl");b.attr("aria-owns",d.attr("id"));d.on("focusout",e,c);d.on("focusin",k,c);a.on("mouseover",i,c);a.on("mousedown",g,c)})},destructor:function(){this.get("menu").destroy()},getValueForAutocomplete:function(){return this.get("value")},setValueFromAutocomplete:function(a,c){this.set("value",a,c)},_onSetValue:function(a,c){var b;c.causedByTimer?(b=this.getValueForAutocomplete(),b===o?this.set("collapsed",
!0):(this._savedValue=b,this.sendRequest(b))):this.get("input").val(a)},handleFocusInternal:function(){var a;this.get("invalidEl")&&c(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlurInternal:function(a){var b=this,d=b.get("placeholderEl");b.callSuper(a);h(b);b.get("invalidEl")&&b.validate(function(a,d){a?!b.get("focused")&&d==b.get("value")&&c(b,a):c(b,!1)});d&&!b.get("value")&&d.show()},handleMouseDownInternal:function(a){var b,c;this.callSuper(a);b=a.target;if((c=this.get("trigger"))&&
(c[0]==b||c.contains(b)))this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyDownInternal:function(a){var b,c=a.keyCode,h,e,g=this.get("menu");this.get("input");b=this.get("updateInputOnDownUp");if(g.get("visible")){h=g.get("highlightedItem");if(b&&h&&(e=g.get("children"),c==n.DOWN&&h==d(e.concat().reverse())||c==n.UP&&h==d(e)))return this.setValueFromAutocomplete(this._savedValue),h.set("highlighted",!1),!0;e=g.handleKeyDownInternal(a);
h=g.get("highlightedItem");if(c==n.ESC)return this.set("collapsed",!0),b&&this.setValueFromAutocomplete(this._savedValue),!0;b&&f.inArray(c,[n.DOWN,n.UP])&&this.setValueFromAutocomplete(h.get("textContent"));return c==n.TAB&&h&&(h.handleClickInternal(a),this.get("multiple"))?!0:e}if(c==n.DOWN||c==n.UP)if(a=this.getValueForAutocomplete(),a!==o)return this.sendRequest(a),!0;return o},validate:function(a){var c=this.get("validator"),b=this.getValueForAutocomplete();c?c(b,function(c){a(c,b)}):a(!1,b)},
sendRequest:function(a){this.get("dataSource").fetchData(a,m,this)},_onSetCollapsed:function(a){var c=this.$el,b=this.get("menu");a?b.hide():(r(this),b.get("visible")||(this.get("matchElWidth")&&(b.render(),a=b.get("el"),a=(parseInt(a.css("borderLeftWidth"))||0)+(parseInt(a.css("borderRightWidth"))||0),b.set("width",c[0].offsetWidth-a)),b.show()))}},{ATTRS:{input:{},value:{value:"",sync:0,view:1},trigger:{},placeholder:{view:1},placeholderEl:{},validator:{},invalidEl:{},allowTextSelection:{value:!0},
hasTrigger:{value:!0,view:1},menu:{value:{},getter:function(a){a.isControl||(a.xclass=a.xclass||"popupmenu",a=this.createComponent(a),this.setInternal("menu",a));return a},setter:function(a){if(a.isControl){a.setInternal("parent",this);var b={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};f.mix(a.get("align"),b,!1)}}},collapsed:{view:1,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},
xrender:{value:q}},xclass:"combobox"})});
KISSY.add("combobox/cursor",["node"],function(f,b){function d(a){var b=i;b||(b=e(k));"textarea"==""+a[0].type.toLowerCase()?b.css("width",a.css("width")):b.css("width",9999);f.each(g,function(d){b.css(d,a.css(d))});i||b.insertBefore(a[0].ownerDocument.body.firstChild);return i=b}var e=b("node").all,k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",i,g="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");return function(a){var b=
e(a),a=b[0],h=a.ownerDocument,g=e(h),l=a.scrollTop,i=a.scrollLeft;if(h.selection)return a=h.selection.createRange(),{left:a.boundingLeft+i+g.scrollLeft(),top:a.boundingTop+l+a.boundingHeight+g.scrollTop()};g=b.offset();if("textarea"!=a.type)return g.top+=a.offsetHeight,g;h=d(b);b=a.selectionStart;h.html(f.escapeHtml(a.value.substring(0,b-1))+"<span>x</span>");h.offset(g);g=h.last();a=g.offset();a.top+=g.height();0<b&&(a.left+=g.width());a.top-=l;a.left-=i;return a}});
KISSY.add("combobox/multi-value-combobox",["./cursor","./control"],function(f,b){function d(a,b){return b&&-1!=a.indexOf(b)}function e(a){a.newVal&&a.target==this.get("menu")&&this.alignWithCursor()}function k(a){var b=a.get("input"),e=a.get("value"),l=[],f=[],k=a.get("literal"),p=a.get("separator"),a=a.get("separatorType"),q=!1,o=a!=i,b=b.prop("selectionStart"),n,j,t=-1;for(n=0;n<e.length;n++)(j=e.charAt(n),k&&j==k&&(q=!q),q)?f.push(j):(n==b&&(t=l.length),o&&g.test(j))?(f.length&&l.push(f.join("")),
f=[],f.push(j)):d(p,j)?a==i?(f.push(j),f.length&&l.push(f.join("")),f=[]):(f.length&&l.push(f.join("")),f=[],f.push(j)):f.push(j);f.length&&l.push(f.join(""));l.length||l.push("");-1==t&&(a==i&&d(p,j)&&l.push(""),t=l.length-1);return{tokens:l,cursorPosition:b,tokenIndex:t}}var i="suffix",g=/\s|\xa0/,a=b("./cursor");return b("./control").extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",e,this))},getValueForAutocomplete:function(){var a=
k(this),b=a.tokens,g=a.tokenIndex,a=this.get("separator"),f=this.get("separatorType"),b=b[g],g=b.length-1;if(f!=i)if(d(a,b.charAt(0)))b=b.slice(1);else return;else f==i&&d(a,b.charAt(g))&&(b=b.slice(0,g));return b},setValueFromAutocomplete:function(a,b){var f=this.get("input"),e=k(this),m=e.tokens,e=Math.max(0,e.tokenIndex),s=this.get("separator"),p;p=this.get("separatorType");var q=m[e+1]||"",o=m[e];if(p!=i){if(m[e]=o.charAt(0)+a,!q||!g.test(q.charAt(0)))a&&(m[e]+=" ")}else m[e]=a,p=o.length-1,d(s,
o.charAt(p))?m[e]+=o.charAt(p):1==s.length&&(m[e]+=s);e=m.slice(0,e+1).join("").length;this.set("value",m.join(""),b);f.prop("selectionStart",e);f.prop("selectionEnd",e)},alignWithCursor:function(){var b=this.get("menu"),d;d=this.get("input");d=a(d);b.move(d.left,d.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:i},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
KISSY.add("combobox/filter-select",["./control"],function(f,b,d,e){f=b("./control");e.exports=f.extend({validate:function(b){var d=this;d.callSuper(function(e,a){e?b(e,a):d.get("dataSource").fetchData(a,function(c){a:{if(c=d.normalizeData(c))for(var e=0;e<c.length;e++)if(c[e].textContent==a){c=c[e];break a}c=!1}b(c?"":d.get("invalidMessage"),a,c)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}})});
KISSY.add("combobox/local-data-source",["attribute"],function(f,b){return b("attribute").extend({fetchData:function(b,e,f){var i=this.get("parse"),g=this.get("data"),g=i(b,g);e.call(f,g)}},{ATTRS:{data:{value:[]},parse:{value:function(b,e){var k=[],i=0;if(!b)return e;f.each(e,function(e){-1!=e.indexOf(b)&&k.push(e);i++});return k}}}})});
KISSY.add("combobox/remote-data-source",["io","attribute"],function(f,b){var d=d,e=b("io");return b("attribute").extend({fetchData:function(b,f,g){var a=this,c,h=a.get("paramName"),r=a.get("parse"),l=a.get("cache"),m=a.get("allowEmpty");a.caches=a.caches||{};a.io&&(a.io.abort(),a.io=null);if(!b&&!0!==m)return f.call(g,[]);if(l&&(c=a.caches[b]))return f.call(g,c);c=a.get("xhrCfg");c.data=c.data||{};c.data[h]=b;c.success=function(c){r&&(c=r(b,c));a.setInternal("data",c);l&&(a.caches[b]=c);f.call(g,
c)};a.io=e(c);return d}},{ATTRS:{paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}}})});
KISSY.add("combobox",["combobox/control","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"],function(f,b){var d=b("combobox/control"),e=b("combobox/multi-value-combobox"),k=b("combobox/filter-select"),i=b("combobox/local-data-source"),g=b("combobox/remote-data-source");d.LocalDataSource=i;d.RemoteDataSource=g;d.FilterSelect=k;d.MultiValueComboBox=e;return d});
