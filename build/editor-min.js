/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Sep 11 14:23
*/
KISSY.add("editor/iframe-content-tpl",'<!doctype html>\n<html>\n<head>{doctype} \n    <title>{title}</title> \n    <style> \n    {style}\n    </style> \n    {links} \n    </head> \n<body class="ks-editor">\n{data} \n{script} \n</body> \n</html>');KISSY.add("editor/render-tpl",'<div class="{{prefixCls}}editor-tools"\n     id="ks-editor-tools-{{id}}">\n\n</div>\n\n<\!--\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\n--\>\n\n<div class="{{prefixCls}}editor-textarea-wrap"\n\n{{#if mobile}}\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\n{{/if}}\n\nid="ks-editor-textarea-wrap-{{id}}"\n>\n\n<textarea\n        id="ks-editor-textarea-{{id}}"\n        class="{{prefixCls}}editor-textarea"\n\n{{#each textareaAttrs}}\n{{xindex}}="{{.}}"\n{{/each}}\n\n{{#if mode}}\nstyle="display:none"\n{{/if}}\n\n>{{data}}</textarea>\n\n</div>\n\n<div class="{{prefixCls}}editor-status"\n     id="ks-editor-status-{{id}}">\n\n</div>');
KISSY.add("editor/render",function(a,n,r){return n.getDefaultRender().extend({beforeCreateDom:function(q,o){a.mix(q,{mobile:a.UA.mobile});a.mix(o,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:r}}})},{requires:["component/control","./render-tpl"]});
KISSY.add("editor/base",function(a,n,r,q){return r.extend({},{Config:{},XHTML_DTD:n.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{view:1,value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:q}},xclass:"editor"})},{requires:["html-parser","component/control","./render"]});
KISSY.add("editor/utils",function(a,n){var r=a.Node,q=a.DOM,o=a.UA,w={debugUrl:function(f){var j=a.Config;j.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));-1==f.indexOf("?t")&&(f=-1!=f.indexOf("?")?f+"&":f+"?",f+="t="+encodeURIComponent(j.tag));return j.base+"editor/"+f},lazyRun:function(a,j,m){var u=a[j],s=a[m];a[j]=function(){u.apply(this,arguments);a[j]=a[m];return s.apply(this,arguments)}},getXY:function(a,j){var m=a.left,u=a.top,s=j.get("window")[0],m=m-q.scrollLeft(s),u=u-q.scrollTop(s),s=j.get("iframe").offset(),
m=m+s.left,u=u+s.top;return{left:m,top:u}},tryThese:function(a){for(var j,m=0,u=arguments.length;m<u;m++){var s=arguments[m];try{j=s();break}catch(l){}}return j},arrayCompare:function(a,j){if(!a&&!j)return!0;if(!a||!j||a.length!=j.length)return!1;for(var m=0;m<a.length;m++)if(a[m]!==j[m])return!1;return!0},clearAllMarkers:function(a){for(var j in a)a[j]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(a.trim(f))},
verifyInputs:function(f){for(var j=0;j<f.length;j++){var m=new r(f[j]),u=a.trim(w.valInput(m)),s=m.attr("data-verify"),m=m.attr("data-warning");if(s&&!RegExp(s).test(u))return alert(m),!1}return!0},sourceDisable:function(a,j){a.on("sourceMode",j.disable,j);a.on("wysiwygMode",j.enable,j)},resetInput:function(a){var j=a.attr("placeholder");j&&o.ie?(a.addClass("ks-editor-input-tip"),a.val(j)):o.ie||a.val("")},valInput:function(a,j){if(void 0===j)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");
a.val(j)},placeholder:function(f,j){f.attr("placeholder",j);o.ie&&(f.on("blur",function(){a.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(j))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");a.trim(f.val())==j&&f.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(f){var f=a.clone(f),j;for(j in f){var m=f[j];"function"===typeof m&&(f[j]=m())}return f},map:function(a,
j){for(var m=0;m<a.length;m++)a[m]=j(a[m]);return a},ieEngine:document.documentMode||o.ie,preventFocus:function(a){o.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(f){a.mix(q,f);for(var j in f)(function(m){r.prototype[m]=function(){var j=[].slice.call(arguments,0);j.unshift(this[0]);return(j=f[m].apply(null,j))&&(j.nodeType||a.isWindow(j))?new r(j):a.isArray(j)&&(j.__IS_NODELIST||j[0]&&j[0].nodeType)?new r(j):j}})(j)},addRes:function(){var f=this.__res=this.__res||[];
f.push.apply(f,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],j=0;j<a.length;j++){var m=a[j];"function"===typeof m?m():m.destroy?m.destroy():m.remove&&m.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,f){return f.toUpperCase()})+"Value"}};return n.Utils=w},{requires:["./base","node"]});
KISSY.add("editor/dom",function(a,n,r){function q(a,e){var c=a[e?"next":"prev"](o,1);if(c&&c[0].nodeType==j.ELEMENT_NODE){for(var b=[];c.attr("_ke_bookmark")||c._4e_isEmptyInlineRemovable(o);)if(b.push(c),c=e?c.next(o,1):c.prev(o,1),!c)return;if(a._4e_isIdentical(c,o)){for(var i=new u(e?a[0].lastChild:a[0].firstChild);b.length;)b.shift()._4e_move(a,!e,o);c._4e_moveChildren(a,!e,o);c.remove();i[0]&&i[0].nodeType==j.ELEMENT_NODE&&i._4e_mergeSiblings()}}}var o=o,w=n.XHTML_DTD,f=a.DOM,j=f.NodeType,m=
a.UA,u=a.Node,s={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var l=n.PositionType,x={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},y={hr:1},h=function(a){return a&&(a[0]||a)};r.injectDom({_4e_sameLevel:function(a,e){var e=h(e),c=a.parentNode;return c&&c==e.parentNode},_4e_isBlockBoundary:function(p,e){var c=a.merge(y,e);return!(!x[f.css(p,"display")]&&!c[f.nodeName(p)])},_4e_index:function(a,e){for(var c=a.parentNode.childNodes,b,i=-1,d=0;d<c.length;d++)if(b=c[d],!e||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(i++,b===a)return i;return-1},_4e_move:function(a,
e,c){e=h(e);c?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_isIdentical:function(a,e){if(!e)return!1;e=h(e);if(f.nodeName(a)!=f.nodeName(e))return!1;var c=a.attributes,b=e.attributes,i=c.length,d=b.length;if(i!=d)return!1;for(var g=0;g<i;g++){var k=c[g],v=k.name;if(k.specified&&f.attr(a,v)!=f.attr(e,v))return!1}if(8>r.ieEngine)for(g=0;g<d;g++)if(k=b[g],v=k.name,k.specified&&f.attr(a,v)!=f.attr(e,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(p){if(!w.$removeEmpty[f.nodeName(p)])return!1;
for(var p=p.childNodes,e=0,c=p.length;e<c;e++){var b=p[e],i=b.nodeType;if(!(i==j.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(i==j.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(b)||i==f.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,e,c){e=h(e);if(a!=e)if(c)for(;c=a.lastChild;)e.insertBefore(a.removeChild(c),e.firstChild);else for(;c=a.firstChild;)e.appendChild(a.removeChild(c))},_4e_mergeSiblings:function(a){a=new u(a);s[a.nodeName()]&&(q(a,!0),q(a))},_4e_splitText:function(a,
e){var c=a.ownerDocument;if(a.nodeType==f.NodeType.TEXT_NODE){if(m.ie&&e==a.nodeValue.length){var b=c.createTextNode("");f.insertAfter(b,a);return b}b=a.splitText(e);c.documentMode&&(c=c.createTextNode(""),f.insertAfter(c,b),f.remove(c));return b}},_4e_parents:function(a,e){var c=[];c.__IS_NODELIST=1;do c[e?"push":"unshift"](a);while(a=a.parentNode);return c},_4e_nextSourceNode:function(a,e,c,b){if(b&&!b.call)var i=h(b),b=function(a){return a!==i};var e=!e&&a.firstChild,d=a;if(!e){if(a.nodeType==
j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.nextSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.nextSibling}return!e||b&&!1===b(e)?null:c&&c!=e.nodeType?f._4e_nextSourceNode(e,!1,c,b):e},_4e_previousSourceNode:function(a,e,c,b){if(b&&!b.call)var i=h(b),b=function(a){return a!==i};var e=!e&&a.lastChild,d=a;if(!e){if(a.nodeType==j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.previousSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.previousSibling}return!e||
b&&!1===b(e)?null:c&&e.nodeType!=c?f._4e_previousSourceNode(e,!1,c,b):e},_4e_commonAncestor:function(a,e){e=h(e);if(a===e)return a;if(f.contains(e,a))return e;var c=a;do if(f.contains(c,e))return c;while(c=c.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(a){for(var e=a.attributes,c=0;c<e.length;c++){var b=e[c];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){m.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,e){var c=h(e);if(a.compareDocumentPosition)return a.compareDocumentPosition(c);if(a==c)return l.POSITION_IDENTICAL;if(a.nodeType==j.ELEMENT_NODE&&c.nodeType==j.ELEMENT_NODE){if(f.contains(a,c))return l.POSITION_CONTAINS+l.POSITION_PRECEDING;if(f.contains(c,a))return l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>c.sourceIndex?l.POSITION_DISCONNECTED:a.sourceIndex<c.sourceIndex?l.POSITION_PRECEDING:l.POSITION_FOLLOWING}for(var b=
f._4e_address(a),c=f._4e_address(c),i=Math.min(b.length,c.length),d=0;d<=i-1;d++)if(b[d]!=c[d])return b[d]<c[d]?l.POSITION_PRECEDING:l.POSITION_FOLLOWING;return b.length<c.length?l.POSITION_CONTAINS+l.POSITION_PRECEDING:l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING},_4e_address:function(a,e){for(var c=[],b=a.ownerDocument.documentElement,i=a;i&&i!=b;)c.unshift(f._4e_index(i,e)),i=i.parentNode;return c},_4e_remove:function(a,e){var c=a.parentNode;if(c){if(e)for(var b;b=a.firstChild;)c.insertBefore(a.removeChild(b),
a);c.removeChild(a)}return a},_4e_trim:function(a){f._4e_ltrim(a);f._4e_rtrim(a)},_4e_ltrim:function(a){for(var e;e=a.firstChild;){if(e.nodeType==f.NodeType.TEXT_NODE){var c=r.ltrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,b-c.length),a.removeChild(a.firstChild));else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){for(var e;e=a.lastChild;){if(e.type==f.NodeType.TEXT_NODE){var c=r.rtrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,c.length),
a.removeChild(a.lastChild));else{a.removeChild(e);continue}}break}!m.ie&&!m.opera&&(e=a.lastChild)&&1==e.nodeType&&"br"==f.nodeName(e)&&a.removeChild(e)},_4e_appendBogus:function(h){for(var e=h.lastChild;e&&e.nodeType==f.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(e))e=m.opera?h.ownerDocument.createTextNode(""):h.ownerDocument.createElement("br"),h.appendChild(e)},_4e_setMarker:function(h,e,c,b){var h=new u(h),i=h.data("list_marker_id")||
h.data("list_marker_id",a.guid()).data("list_marker_id"),d=h.data("list_marker_names")||h.data("list_marker_names",{}).data("list_marker_names");e[i]=h;d[c]=1;return h.data(c,b)},_4e_clearMarkers:function(a,e,c){var a=new u(a),b=a.data("list_marker_names"),i=a.data("list_marker_id"),d;for(d in b)a.removeData(d);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete e[i])},_4e_copyAttributes:function(a,e,c){for(var e=new u(e),b=a.attributes,c=c||{},i=0;i<b.length;i++){var d=b[i],
g=d.name.toLowerCase(),k;if(!(g in c))if("checked"==g&&(k=f.attr(a,g)))e.attr(g,k);else if(d.specified||m.ie&&d.value&&"value"==g)k=f.attr(a,g),null===k&&(k=d.nodeValue),e.attr(g,k)}""!==a.style.cssText&&(e[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=f.nodeName(a);return(a=!w.$nonEditable[a]&&(w[a]||w.span))&&a["#text"]},_4e_getByAddress:function(a,e,c){for(var a=a.documentElement,b=0;a&&b<e.length;b++){var i=e[b];if(c)for(var d=-1,g=0;g<a.childNodes.length;g++){var k=a.childNodes[g];
if(!(!0===c&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(d++,d==i)){a=k;break}}else a=a.childNodes[i]}return a}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/focusManager",function(a,n){function r(){var a=this;a.__iframeFocus=m;f=a;w&&clearTimeout(w);w=setTimeout(function(){a.fire("focus")},30)}function q(){var a=this;a.__iframeFocus=u;f=s;w&&clearTimeout(w);w=setTimeout(function(){a.fire("blur")},30)}var o={},w,f,j={refreshAll:function(){for(var a in o){var f=o[a].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return f},getInstance:function(a){return o[a]},register:function(a){o[a.get("id")]=a},
add:function(a){this.register(a);a.get("window").on("focus",r,a).on("blur",q,a)},remove:function(a){delete o[a.get("id")];a.get("window").detach("focus",r,a).detach("blur",q,a)}},m=!0,u=!1,s=null;j.refreshAll=j.refreshAll;n.focusManager=j;n.getInstances=function(){return o};return j},{requires:["./base","./dom"]});
KISSY.add("editor/walker",function(a,n){function r(a,c){if(this._.end)return j;var b,i=this.range,d,g=this.guard,k=this.type,v=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,i.trim(),i.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var h=i.endContainer[0],m=h.childNodes[i.endOffset];this._.guardLTR=function(a,b){return b&&(h==a||"body"==u.nodeName(a))?!1:a!=m}}if(a&&!this._.guardRTL){var p=i.startContainer[0],s=0<i.startOffset&&p.childNodes[i.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(p==a||"body"==u.nodeName(a))?!1:a!=s}}var z=a?this._.guardRTL:this._.guardLTR;d=g?function(a,b){return z(a,b)===f?f:g(a,b)}:z;this.current?b=this.current[v](f,k,d):a?(b=i.endContainer,0<i.endOffset?(b=new l(b[0].childNodes[i.endOffset-1]),d(b[0])===f&&(b=j)):b=d(b,w)===f?j:b._4e_previousSourceNode(w,k,d,void 0)):(b=i.startContainer,b=new l(b[0].childNodes[i.startOffset]),b.length?d(b[0])===f&&(b=j):b=d(i.startContainer,w)===f?j:i.startContainer._4e_nextSourceNode(w,
k,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==f){if(!c)return b}else if(c&&this.evaluator)return f;b=b[v](f,k,d)}this.end();return this.current=j}function q(a){for(var c,b=j;c=r.call(this,a);)b=c;return b}function o(a){this.range=a;this.guard=this.evaluator=j;this._={}}var w=!0,f=!1,j=null,m=a.UA,u=a.DOM,s=n.XHTML_DTD,l=a.Node;a.augment(o,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,w)},checkForward:function(){return r.call(this,
f,w)!==f},checkBackward:function(){return r.call(this,w,w)!==f},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,w)},reset:function(){delete this.current;this._={}},_iterator:r});a.mix(o,{blockBoundary:function(a){return function(c){return!(c.nodeType==u.NodeType.ELEMENT_NODE&&u._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function b(a){return"span"==u.nodeName(a)&&u.attr(a,"_ke_bookmark")}return function(i){var d,g;d=i.nodeType==u.NodeType.TEXT_NODE&&(g=
i.parentNode)&&b(g);d=a?d:d||b(i);return!!(c^d)}},whitespaces:function(e){return function(c){c=c.nodeType==u.NodeType.TEXT_NODE&&!a.trim(c.nodeValue);return!!(e^c)}},invisible:function(a){var c=o.whitespaces();return function(b){b=c(b)||b.nodeType==u.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,y=o.whitespaces(),h=o.bookmark(),p=function(a){var c=u.nodeName(a);return h(a)||y(a)||1==a.nodeType&&c in s.$inline&&!(c in s.$empty)};n.Utils.injectDom({_4e_getBogus:function(a){a=
new l(a);do a=a._4e_previousSourceNode();while(a&&p(a[0]));return a&&(!m.ie?"br"==a.nodeName():3==a[0].nodeType&&x.test(a.text()))?a[0]:!1}});return n.Walker=o},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/elementPath",function(a,n){function r(a){for(var u=w,s=w,l=[];a;){if(a[0].nodeType==q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var n=a.nodeName();if(!s&&(!u&&f[n]&&(u=a),j[n])){var r;if(r=!u)if(r="div"==n){a:{r=a[0].childNodes;for(var h=0,p=r.length;h<p;h++){var e=r[h];if(e.nodeType==q.NodeType.ELEMENT_NODE&&o.$block[e.nodeName.toLowerCase()]){r=!0;break a}}r=!1}r=!r}r?u=a:s=a}l.push(a);if("body"==n)break}a=a.parent()}this.block=u;this.blockLimit=s;this.elements=
l}var q=a.DOM,o=n.XHTML_DTD,w=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};r.prototype={constructor:r,compare:function(a){var f=this.elements,a=a&&a.elements;if(!a||f.length!=a.length)return!1;for(var j=0;j<f.length;j++)if(!q.equals(f[j],a[j]))return!1;return!0},contains:function(a){for(var f=this.elements,j=0;j<f.length;j++)if(f[j].nodeName()in a)return f[j];return w},toString:function(){var a=
this.elements,f,j=[];for(f=0;f<a.length;f++)j.push(a[f].nodeName());return j.toString()}};return n.ElementPath=r},{requires:["./base","./dom","node"]});
KISSY.add("editor/range",function(a,n,r,q,o){function w(z){var d=z.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(z)in b.$removeEmpty,c=z.nodeType==e.NodeType.TEXT_NODE&&!a.trim(z.nodeValue),z=!!z.parentNode.getAttribute("_ke_bookmark");return d||c||z}function f(a){return!v(a)&&!C(a)}function j(b){var d=x;return function(i){if(C(i))return l;if(i.nodeType==e.NodeType.TEXT_NODE){if(a.trim(i.nodeValue).length)return x}else if(i.nodeType==e.NodeType.ELEMENT_NODE&&(i=e.nodeName(i),!L[i]))if(!b&&!c.ie&&"br"==
i&&!d)d=l;else return x;return l}}function m(a,b){var d=a.startContainer,t=a.endContainer,c=a.startOffset,k=a.endOffset,h,v=x,f=x,j=void 0,E=a.document,Q;0<b&&(j=E.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();t[0].nodeType==e.NodeType.TEXT_NODE?(f=l,t=t._4e_splitText(k)):0<t[0].childNodes.length&&(k>=t[0].childNodes.length?(t=new i(t[0].appendChild(E.createTextNode(""))),Q=l):t=new i(t[0].childNodes[k]));d[0].nodeType==e.NodeType.TEXT_NODE?(v=l,d._4e_splitText(c)):c?c>=d[0].childNodes.length?
(d=new i(d[0].appendChild(E.createTextNode(""))),h=l):d=new i(d[0].childNodes[c].previousSibling):(h=new i(E.createTextNode("")),d.prepend(h),d=h,h=l);var I=d._4e_parents(),K=t._4e_parents();I.each(function(a,b){I[b]=a});K.each(function(a,b){K[b]=a});for(var G,p,E=0;E<I.length&&!(G=I[E],p=K[E],!G.equals(p));E++);for(var c=j,A,m,C=E;C<I.length;C++){A=I[C];k=0<b&&!A.equals(d)?c.appendChild(A.clone()[0]):null;A=A[0].nextSibling;m=K[C];for(var n=t[0],o=m&&m[0];A&&!(o==A||n==A);){m=A.nextSibling;if(2==
b)c.appendChild(A.cloneNode(l));else{if(g[A.nodeName.toLowerCase()]){var q=A.cloneNode(l);A.innerHTML="";A=q}else e._4e_remove(A);1==b&&c.appendChild(A)}A=m}k&&(c=k)}for(c=j;E<K.length;E++){A=K[E];k=0<b&&!A.equals(t)?c.appendChild(A.clone()[0]):null;if(!I[E]||!A._4e_sameLevel(I[E]))for(A=A[0].previousSibling;A;)m=A.previousSibling,2==b?c.insertBefore(A.cloneNode(l),c.firstChild):(e._4e_remove(A),1==b&&c.insertBefore(A,c.firstChild)),A=m;k&&(c=k)}if(2==b){if(v&&(G=d[0],G.nodeType==e.NodeType.TEXT_NODE&&
G.nextSibling&&G.nextSibling.nodeType==e.NodeType.TEXT_NODE&&(G.data+=G.nextSibling.data,G.parentNode.removeChild(G.nextSibling))),f)f=t[0],f.nodeType==e.NodeType.TEXT_NODE&&f.previousSibling&&f.previousSibling.nodeType==e.NodeType.TEXT_NODE&&(f.previousSibling.data+=f.data,f.parentNode.removeChild(f))}else{if(G&&p&&(!d._4e_sameLevel(G)||!t._4e_sameLevel(p)))f=G._4e_index(),h&&G._4e_sameLevel(d)&&f--,a.setStart(G.parent(),f+1);a.collapse(l)}h&&d.remove();Q&&t.remove();return j}function u(a){a.collapsed=
a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=y;this.collapsed=l;this.document=a}n.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var l=!0,x=!1,y=null,h=n.RangeType,p=n.PositionType,e=a.DOM,
c=a.UA,b=n.XHTML_DTD,i=a.Node,d=i.all,g={td:1},k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new q.whitespaces,C=new q.bookmark,F=q.whitespaces(l),D=q.bookmark(!1,!0),L={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(s,{toString:function(){var a=[],b=this.startContainer[0],d=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);
a.push((d.id||d.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),
a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=
b;this.endContainer||(this.endContainer=a,this.endOffset=b);u(this)},setEnd:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);u(this)},setStartAt:function(a,b){switch(b){case h.POSITION_AFTER_START:this.setStart(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);
break;case h.POSITION_BEFORE_START:this.setStartBefore(a);break;case h.POSITION_AFTER_END:this.setStartAfter(a)}u(this)},setEndAt:function(a,b){switch(b){case h.POSITION_AFTER_START:this.setEnd(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(a);break;case h.POSITION_AFTER_END:this.setEndAfter(a)}u(this)},cloneContents:function(){return m(this,2)},
deleteContents:function(){return m(this,0)},extractContents:function(){return m(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=l},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=
this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return y;var b=new q(a);b.evaluator=function(a){return F(a)&&D(a)};a=b.next();b.reset();b=b.previous();return a&&a.equals(b)?a:y},shrink:function(a,b){if(!this.collapsed){var a=a||h.SHRINK_TEXT,d=this.clone(),t=this.startContainer,c=this.endContainer,i=this.startOffset,g=this.endOffset,k=l,f,v,E=l;t&&t[0].nodeType==e.NodeType.TEXT_NODE&&(i?i>=t[0].nodeValue.length?
d.setStartAfter(t):(d.setStartBefore(t),k=x):d.setStartBefore(t));c&&c[0].nodeType==e.NodeType.TEXT_NODE&&(g?g>=c[0].nodeValue.length?d.setEndAfter(c):(d.setEndAfter(c),E=x):d.setEndBefore(c));if(k||E)v=new q(d),v.evaluator=function(b){return b.nodeType==(a==h.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)},v.guard=function(b,d){if(a==h.SHRINK_ELEMENT&&b.nodeType==e.NodeType.TEXT_NODE||d&&b==f)return x;!d&&b.nodeType==e.NodeType.ELEMENT_NODE&&(f=b);return l};k&&(d=v[a==h.SHRINK_ELEMENT?
"lastForward":"next"]())&&this.setStartAt(d,b?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);E&&(v.reset(),(v=v[a==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,b?h.POSITION_BEFORE_END:h.POSITION_AFTER_END));return k||E}},createBookmark2:function(a){var b=this.startContainer,d=this.endContainer,c=this.startOffset,g=this.endOffset,k,f;if(!b||!d)return{start:0,end:0};if(a){if(b[0].nodeType==e.NodeType.ELEMENT_NODE&&(k=new i(b[0].childNodes[c]))&&k[0]&&k[0].nodeType==e.NodeType.TEXT_NODE&&
0<c&&k[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)b=k,c=0;for(;b[0].nodeType==e.NodeType.TEXT_NODE&&(f=b.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)b=f,c+=f[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==e.NodeType.ELEMENT_NODE&&(k=new i(d[0].childNodes[g]))&&k[0]&&k[0].nodeType==e.NodeType.TEXT_NODE&&0<g&&k[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)d=k,g=0;for(;d[0].nodeType==e.NodeType.TEXT_NODE&&(f=d.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)d=f,
g+=f[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?y:d._4e_address(a),startOffset:c,endOffset:g,normalized:a,is2:l}},createBookmark:function(b){var d,c,t,g,e=this.collapsed;d=new i("<span>",y,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");b&&(t=a.guid("ke_bm_"),d.attr("id",t+"S"));e||(c=d.clone(),c.html("&nbsp;"),b&&c.attr("id",t+"E"),g=this.clone(),g.collapse(),g.insertNode(c));g=this.clone();g.collapse(l);g.insertNode(d);c?(this.setStartAfter(d),
this.setEndBefore(c)):this.moveToPosition(d,h.POSITION_AFTER_END);return{startNode:b?t+"S":d,endNode:b?t+"E":c,serializable:b,collapsed:e}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(l)},trim:function(a,b){var d=this.startContainer,c=this.startOffset,i=this.collapsed;if((!a||i)&&d[0]&&d[0].nodeType==e.NodeType.TEXT_NODE){if(c)if(c>=d[0].nodeValue.length)c=d._4e_index()+1,d=d.parent();else{var g=d._4e_splitText(c),c=d._4e_index()+1,d=d.parent();e.equals(this.startContainer,this.endContainer)?
this.setEnd(g,this.endOffset-this.startOffset):e.equals(d,this.endContainer)&&(this.endOffset+=1)}else c=d._4e_index(),d=d.parent();this.setStart(d,c);if(i){this.collapse(l);return}}d=this.endContainer;c=this.endOffset;!b&&!i&&d[0]&&d[0].nodeType==e.NodeType.TEXT_NODE&&(c?(c>=d[0].nodeValue.length||d._4e_splitText(c),c=d._4e_index()+1):c=d._4e_index(),d=d.parent(),this.setEnd(d,c))},insertNode:function(a){this.optimizeBookmark();this.trim(x,l);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||
null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(b){var c=d(this.document);if(b.is2){var i=c._4e_getByAddress(b.start,b.normalized),t=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(i,t);c?this.setEnd(c,b):this.collapse(l)}else i=(t=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=t?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(i),i._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(l)},
getCommonAncestor:function(a,b){var d=this.startContainer,c=this.endContainer,d=d[0]==c[0]?a&&d[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new i(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(c);return b&&d[0].nodeType==e.NodeType.TEXT_NODE?d.parent():d},enlarge:function(){function a(b,c,i,g){var k=b[c?"startContainer":"endContainer"],f,h=c?0:1,j=0,l=c?"previousSibling":"nextSibling";f=b[c?"startOffset":"endOffset"];if(k[0].nodeType==e.NodeType.TEXT_NODE){if(c){if(f)return}else if(f<
k[0].nodeValue.length)return;f=k[0][l];k=k[0].parentNode}else f=k[0].childNodes[f+(c?-1:1)]||null,k=k[0];for(;k;){for(;f;)if(v(f)||C(f))f=f[l];else break;if(f){if(!j)b[c?"setStartAfter":"setEndBefore"](d(f));break}k=d(k);if("body"==k.nodeName())break;if(j||k.equals(g))i[h]=k,j=1;else b[c?"setStartBefore":"setEndAfter"](k);f=k[0][l];k=k[0].parentNode}}return function(b){switch(b){case h.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),c=[];a(this,1,c,b);a(this,0,c,b);c[0]&&c[1]&&
(b=c[0].contains(c[1])?c[1]:c[0],this.setStartBefore(b),this.setEndAfter(b));break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:var t=new s(this.document),c=new i(this.document.body);t.setStartAt(c,h.POSITION_AFTER_START);t.setEnd(this.startContainer,this.startOffset);var t=new q(t),g,k,f=q.blockBoundary(b==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:y),v=function(a){var b=f(a);b||(g=d(a));return b},j=function(a){var b=v(a);!b&&"br"==e.nodeName(a)&&(k=d(a));return b};t.guard=v;t=t.lastBackward();
g=g||c;this.setStartAt(g,"br"!=g.nodeName()&&(!t&&this.checkStartOfBlock()||t&&g.contains(t))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);t=this.clone();t.collapse();t.setEndAt(c,h.POSITION_BEFORE_END);t=new q(t);t.guard=b==h.ENLARGE_LIST_ITEM_CONTENTS?j:v;g=y;t=t.lastForward();g=g||c;this.setEndAt(g,!t&&this.checkEndOfBlock()||t&&g.contains(t)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);k&&this.setEndAfter(k)}}}(),checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&
b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(0,d)).length)return x;this.trim();b=new o(this.startContainer);d=this.clone();d.collapse(l);d.setStartAt(b.block||b.blockLimit,h.POSITION_AFTER_START);b=new q(d);b.evaluator=j(l);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(d)).length)return x;this.trim();b=new o(this.endContainer);d=this.clone();d.collapse(x);
d.setEndAt(b.block||b.blockLimit,h.POSITION_BEFORE_END);b=new q(d);b.evaluator=j(x);return b.checkForward()},checkBoundaryOfElement:function(a,b){var d=this.clone();d[b==h.START?"setStartAt":"setEndAt"](a,b==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);d=new q(d);d.evaluator=w;return d[b==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,i;if(a[0].nodeType==e.NodeType.ELEMENT_NODE)if(i=
a[0].childNodes.length,i>c)a=d(a[0].childNodes[c]);else if(0==i)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==e.NodeType.ELEMENT_NODE)if(i=b[0].childNodes.length,i>g)b=d(b[0].childNodes[g])._4e_previousSourceNode(l);else if(0==i)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}a._4e_position(b)&p.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var i=this.createBookmark(),
g=d(this.document.createElement(b));this.collapse(a);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();c.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(i);return g},splitBlock:function(b){var d=new o(this.startContainer),g=new o(this.endContainer),i=d.block,k=g.block,e=y;if(!d.blockLimit.equals(g.blockLimit))return y;"br"!=b&&(i||(i=this.fixBlock(l,b),k=(new o(this.endContainer)).block),k||(k=this.fixBlock(x,b)));b=i&&this.checkStartOfBlock();
d=k&&this.checkEndOfBlock();this.deleteContents();i&&i[0]==k[0]&&(d?(e=new o(this.startContainer),this.moveToPosition(k,h.POSITION_AFTER_END),k=y):b?(e=new o(this.startContainer),this.moveToPosition(i,h.POSITION_BEFORE_START),i=y):(k=this.splitElement(i),!c.ie&&!a.inArray(i.nodeName(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:k,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:e}},splitElement:function(a){if(!this.collapsed)return y;this.setEndAt(a,h.POSITION_BEFORE_END);var b=
this.extractContents(),d=a.clone(x);d[0].appendChild(b);d.insertAfter(a);this.moveToPosition(a,h.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,b){for(var d=0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,b?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);d=1;break}a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?h.POSITION_BEFORE_END:h.POSITION_AFTER_START),d=1);var c=a,i=d,g=void 0;c[0].nodeType==e.NodeType.ELEMENT_NODE&&
c._4e_isEditable()&&(g=c[b?"last":"first"](f,1));!i&&!g&&(g=c[b?"prev":"next"](f,1));a=g}return!!d},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var d,c,i,g=a.nodeName();d=b.$block[g];this.deleteContents();if(d){for(d=this.getCommonAncestor(x,l);(c=b[d.nodeName()])&&(!c||!c[g]);){var k=d.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(d),
this.collapse(l),d.remove()):i=d;d=k}i&&this.splitElement(i)}this.insertNode(a)}});r.injectDom({_4e_breakParent:function(a,b){var b=d(b),a=d(a),c,i=new n.Range(a[0].ownerDocument);i.setStartAfter(a);i.setEndAfter(b);c=i.extractContents();i.insertNode(a.remove());a.after(c)}});return n.Range=s},{requires:"./base,./utils,./walker,./elementPath,./dom,node".split(",")});
KISSY.add("editor/selection",function(a,n){function r(a){this.document=a;this._={cache:{}};if(l)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=o}catch(d){this.isInvalid=o}}function q(a){a=new r(a);return!a||a.isInvalid?w:a}n.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var o=!0,w=null,f=a.UA,j=a.DOM,m=a.Node,u=n.SelectionType,s=n.RangeType,l=f.ie,x=n.Walker,y=n.Range,h=
{img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(r,{getNative:!l?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!l?function(){var a=this._.cache;if(a.type)return a.type;var c=u.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=
d.getRangeAt(0),g=d.startContainer;g==d.endContainer&&g.nodeType==j.NodeType.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&h[g.childNodes[d.startOffset].nodeName.toLowerCase()]&&(c=u.SELECTION_ELEMENT)}}else c=u.SELECTION_NONE;return a.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var c=u.SELECTION_NONE;try{var d=this.getNative(),g=d.type;"Text"==g&&(c=u.SELECTION_TEXT);"Control"==g&&(c=u.SELECTION_ELEMENT);d.createRange().parentElement&&(c=u.SELECTION_TEXT)}catch(k){}return a.type=
c},getRanges:l?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),k=c.childNodes,e,f=0;f<k.length;f++){var h=k[f];if(h.nodeType==j.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(h);var h=e.compareEndPoints("StartToStart",a),l=e.compareEndPoints("EndToStart",a);e.collapse();if(0<h)break;else{if(!h||1==l&&-1==h)return{container:c,offset:f};if(!l)return{container:c,offset:f+1}}e=w}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",
a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=k[--f].nodeValue.length}catch(m){e=0}return 0===e?{container:c,offset:f}:{container:k[f],offset:-e}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var g=this.getNative(),c=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==u.SELECTION_TEXT)return g=new y(this.document),e=a(c,o),g.setStart(new m(e.container),e.offset),e=a(c),g.setEnd(new m(e.container),e.offset),d.ranges=[g];if(e==u.SELECTION_ELEMENT){d=
d.ranges=[];for(e=0;e<c.length;e++){for(var f=c.item(e),h=f.parentNode,j=0,g=new y(this.document);j<h.childNodes.length&&h.childNodes[j]!=f;j++);g.setStart(new m(h),j);g.setEnd(new m(h),j+1);d.push(g)}return d}return d.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],d=this.getNative();if(!d)return[];for(var g=0;g<d.rangeCount;g++){var e=d.getRangeAt(g),f=new y(this.document);f.setStart(new m(e.startContainer),e.startOffset);f.setEnd(new m(e.endContainer),e.endOffset);
a.push(f)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,d=this.getNative();switch(this.getType()){case u.SELECTION_ELEMENT:return this.getSelectedElement();case u.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();o;)if(c=g.startContainer,g.startOffset==(c[0].nodeType===j.NodeType.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())g.setStartAfter(c);else break;c=g.startContainer;
if(c[0].nodeType!=j.NodeType.ELEMENT_NODE)return c.parent();c=new m(c[0].childNodes[g.startOffset]);if(!c[0]||c[0].nodeType!=j.NodeType.ELEMENT_NODE)return g.startContainer;for(g=c[0].firstChild;g&&g.nodeType==j.NodeType.ELEMENT_NODE;)c=new m(g),g=g.firstChild;return c}if(l)g=d.createRange(),g.collapse(o),c=new m(g.parentElement());else{if((c=d.anchorNode)&&c.nodeType!=j.NodeType.ELEMENT_NODE)c=c.parentNode;c&&(c=new m(c))}}return a.startElement=c},getSelectedElement:function(){var a,c=this._.cache;
if(void 0!==c.selectedElement)return c.selectedElement;l&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var d;if(a)d=new m(a);else{a=this.getRanges()[0];for(var g,e=2;e&&(!(d=a.getEnclosedNode())||!(d[0].nodeType==j.NodeType.ELEMENT_NODE&&h[d.nodeName()]&&(g=d)));e--)a.shrink(s.SHRINK_ELEMENT);d=g}return c.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var c,d=this.document;if(l)try{c=d.body.createControlRange(),c.addElement(a[0]),c.select()}catch(g){c=d.body.createTextRange(),
c.moveToElementText(a[0]),c.select()}finally{}else c=d.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(l){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var d=0;d<a.length;d++){var g=a[d],e=this.document.createRange(),h=g.startContainer;if(g.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&h[0].nodeType==
j.NodeType.ELEMENT_NODE&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;e.setStart(h[0],g.startOffset);e.setEnd(g.endContainer[0],g.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var c=[],d=this.getRanges(),g=0;g<d.length;g++)c.push(d[g].createBookmark2(a));return c},createBookmarks:function(c,e){for(var d=[],g=this.document,f,e=e||this.getRanges(),h=e.length,l=0;l<h;l++){d.push(f=e[l].createBookmark(c,
o));var m=(c=f.serializable)?a.one("#"+f.startNode,g):f.startNode;f=c?a.one("#"+f.endNode,g):f.endNode;for(var p=l+1;p<h;p++){var n=e[p],q=n.startContainer,r=n.endContainer;j.equals(q,m.parent())&&n.startOffset++;j.equals(q,f.parent())&&n.startOffset++;j.equals(r,m.parent())&&n.endOffset++;j.equals(r,f.parent())&&n.endOffset++}}return d},selectBookmarks:function(a){for(var c=[],d=0;d<a.length;d++){var g=new y(this.document);g.moveToBookmark(a[d]);c.push(g)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();l?a&&a.clear():a&&a.removeAllRanges()}});var p={table:1,tbody:1,tr:1},e=x.whitespaces(o),c=/\ufeff|\u00a0/;y.prototype.select=y.prototype.select=!l?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
j.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(o),c.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=q(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var f=this.collapsed,
d,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==j.NodeType.ELEMENT_NODE){(new r(this.document)).selectElement(new m(k));return}}(this.startContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in p||this.endContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in p)&&this.shrink(s.SHRINK_ELEMENT,o);var h=this.createBookmark(),k=h.startNode,
l;f||(l=h.endNode);h=this.document.body.createTextRange();h.moveToElementText(k[0]);h.moveStart("character",1);if(l)a=this.document.body.createTextRange(),a.moveToElementText(l[0]),h.setEndPoint("EndToEnd",a),h.moveEnd("character",-1);else{for(d=k[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(c))&&(a||!k[0].previousSibling||k[0].previousSibling&&"br"==j.nodeName(k[0].previousSibling));g=new m(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(k);
d&&j.insertBefore(this.document.createTextNode("\ufeff"),k[0]||k)}this.setStartBefore(k);k._4e_remove();if(f){if(d?(h.moveStart("character",-1),h.select(),this.document.selection.clear()):h.select(),g)this.moveToPosition(g,s.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(l),l._4e_remove(),h.select()};r.getSelection=q;return n.Selection=r},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/domIterator",function(a,n){function r(a){1>arguments.length||(this.range=a,this.forceBrBreak=o,this.enlargeBr=q,this.enforceRealBlocks=o,this._||(this._={}))}var q=!0,o=!1,w=a.UA,f=n.Walker,j=n.Range,m=n.RangeType,u=n.ElementPath,s=a.Node,l=a.DOM,x=/^[\r\n\t ]*$/;a.augment(r,{getNextParagraph:function(n){var h,p,e,c,b;if(!this._.lastNode){p=this.range.clone();p.shrink(m.SHRINK_ELEMENT,q);p.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var i=new f(p),d=f.bookmark(q,q);i.evaluator=d;this._.nextNode=i.next();i=new f(p);i.evaluator=d;i=i.previous();this._.lastNode=i._4e_nextSourceNode(q);this._.lastNode&&this._.lastNode[0].nodeType==l.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(d=new j(p.document),d.moveToPosition(this._.lastNode,m.POSITION_AFTER_END),d.checkEndOfBlock()&&(d=new u(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(q)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new s(p.document.createTextNode("")),l.insertAfter(this._.lastNode[0],i[0]));p=null}d=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;d;){var g=o,k=d[0].nodeType!=l.NodeType.ELEMENT_NODE,v=o;if(k)d[0].nodeType==l.NodeType.TEXT_NODE&&x.test(d[0].nodeValue)&&(k=o);else{var r=d.nodeName();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==r)k=q;else if(!p&&!d[0].childNodes.length&&"hr"!=r){h=d;e=d.equals(i);break}p&&(p.setEndAt(d,m.POSITION_BEFORE_START),
"br"!=r&&(this._.nextNode=d));g=q}else{if(d[0].firstChild){p||(p=new j(this.range.document),p.setStartAt(d,m.POSITION_BEFORE_START));d=new s(d[0].firstChild);continue}k=q}}k&&!p&&(p=new j(this.range.document),p.setStartAt(d,m.POSITION_BEFORE_START));e=(!g||k)&&d.equals(i);if(p&&!g)for(;!d[0].nextSibling&&!e;){r=d.parent();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){g=q;e||r.equals(i);break}d=r;k=q;e=d.equals(i);v=q}k&&p.setEndAt(d,m.POSITION_AFTER_END);d=d._4e_nextSourceNode(v,null,i);if((e=
!d)||g&&p)break}if(!h){if(!p)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;h=new u(p.startContainer);d=h.blockLimit;g={div:1,th:1,td:1};h=h.block;if((!h||!h[0])&&!this.enforceRealBlocks&&g[d.nodeName()]&&p.checkStartOfBlock()&&p.checkEndOfBlock())h=d;else if(!h||this.enforceRealBlocks&&"li"==h.nodeName())h=new s(this.range.document.createElement(n||"p")),h[0].appendChild(p.extractContents()),h._4e_trim(),p.insertNode(h),c=b=q;else if("li"!=h.nodeName()){if(!p.checkStartOfBlock()||
!p.checkEndOfBlock())h=h.clone(o),h[0].appendChild(p.extractContents()),h._4e_trim(),b=p.splitBlock(),c=!b.wasStartOfBlock,b=!b.wasEndOfBlock,p.insertNode(h)}else e||(this._.nextNode=h.equals(i)?null:p.getBoundaryNodes().endNode._4e_nextSourceNode(q,null,i))}c&&(p=new s(h[0].previousSibling),p[0]&&p[0].nodeType==l.NodeType.ELEMENT_NODE&&("br"==p.nodeName()?p._4e_remove():p[0].lastChild&&"br"==l.nodeName(p[0].lastChild)&&l._4e_remove(p[0].lastChild)));b&&(p=f.bookmark(o,q),c=new s(h[0].lastChild),
c[0]&&c[0].nodeType==l.NodeType.ELEMENT_NODE&&"br"==c.nodeName()&&(w.ie||c.prev(p,1)||c.next(p,1))&&c.remove());this._.nextNode||(this._.nextNode=e||h.equals(i)?null:h._4e_nextSourceNode(q,null,i));return h}});j.prototype.createIterator=function(){return new r(this)};return r},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor/styles",function(a,n){function r(a){return!F.attr(a,"_ke_bookmark")}function q(a,c){for(var d in a)"string"==typeof a[d]?a[d]=a[d].replace(R,function(a,d){return c[d]}):q(a[d],c)}function o(c,d){d&&(c=a.clone(c),q(c,d));var b=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==b||B[b]?KEST.STYLE_BLOCK:O[b]?KEST.STYLE_OBJECT:KEST.STYLE_INLINE;this._={definition:c}}function w(a,c){var d=c?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=
new L(a),g=b.getRanges(),e=0;e<g.length;e++)d.call(this,g[e]);b.selectRanges(g)}function f(a,c,d){var b=a.element;"*"==b&&(b="span");c=new H(c.createElement(b));d&&d._4e_copyAttributes(c);d=a._.definition;a=d.attributes;d=o.getStyleText(d);if(a)for(var g in a)c.attr(g,a[g]);d&&(c[0].style.cssText=d);return c}function j(a){var c=a.createBookmark(g),d=a.createIterator();d.enforceRealBlocks=g;d.enlargeBr=g;for(var b,e=a.document;b=d.getNextParagraph();){var k=f(this,e,b),i=k,k="pre"==i.nodeName,h="pre"==
b.nodeName,j=!k&&h;k&&!h?(h=b,j=h.html(),j=m(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),t.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(i[0]),i.outerHtml("<pre>"+j+"</pre>"),i=new H(h.firstChild),i._4e_remove()):i.html(j)):j?i=s(u(b),i):b._4e_moveChildren(i);b[0].parentNode.replaceChild(i[0],b[0]);if(k&&(b=i,k=void 0,(k=b._4e_previousSourceNode(g,F.NodeType.ELEMENT_NODE))&&
"pre"==k.nodeName()))i=m(k.html(),/\n$/,"")+"\n\n"+m(b.html(),/^\n/,""),t.ie?b.outerHtml("<pre>"+i+"</pre>"):b.html(i),k._4e_remove()}a.moveToBookmark(c)}function m(a,c,d){var b="",g="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,d){c&&(b=c);d&&(g=d);return""});return b+a.replace(c,d)+g}function u(a){var c=[];m(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,d){c.push(d)});return c}function s(a,c){for(var d=c[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var g=a[b],g=g.replace(/(\r\n|\r)/g,"\n"),g=m(g,/^[ \t]*\n/,""),g=m(g,/\n$/,""),g=m(g,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),g=g.replace(/\n/g,"<br>"),g=g.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),e=c.clone();e.html(g);d.appendChild(e[0])}return d}
function l(a){var c=a.document;if(a.collapsed)c=f(this,c,void 0),a.insertNode(c),a.moveToPosition(c,D.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,i,h=M[d];h||(i=g,h=M.span);var j=a.createBookmark();a.enlarge(D.ENLARGE_ELEMENT);a.trim();for(var l=a.createBookmark(),J=l.startNode,l=l.endNode,m=J,p;m&&m[0];){var B=k;if(F.equals(m,l))m=v,B=g;else{var n=m[0].nodeType,q=n==F.NodeType.ELEMENT_NODE?m.nodeName():v;if(q&&m.attr("_ke_bookmark")){m=m._4e_nextSourceNode(g);continue}if(!q||
h[q]&&(m._4e_position(l)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m))){var o=m.parent();if(o&&"a"==d&&o.nodeName()==d)n=f(this,c,void 0),o._4e_moveChildren(n),o[0].parentNode.replaceChild(n[0],o[0]),n._4e_mergeSiblings();else if(o&&o[0]&&((M[o.nodeName()]||M.span)[d]||i)&&(!e.parentRule||e.parentRule(o))){if(!p&&(!q||!M.$removeEmpty[q]||(m._4e_position(l)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|
z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))p=new N(c),p.setStartBefore(m);if(n==F.NodeType.TEXT_NODE||n==F.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){o=m;for(n=null;(B=!o.next(r,1))&&(n=o.parent())&&h[n.nodeName()]&&(n._4e_position(J)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(n));)o=n;p.setEndAfter(o)}}else B=g}else B=g;m=m._4e_nextSourceNode()}if(B&&
p&&!p.collapsed){for(var B=f(this,c,void 0),o=p.getCommonAncestor(),n={},q={},u,s=null,C;B&&o&&B[0]&&o[0];){if(o.nodeName()==d){for(u in e.attributes)if(!q[u]&&(C=o.attr(s)))B.attr(u)==C?B.removeAttr(u):q[u]=1;for(s in e.styles)if(!n[s]&&(C=o.style(s)))B.style(s)==C?B.style(s,""):n[s]=1;if(!B._4e_hasAttributes()){B=v;break}}o=o.parent()}B?(B[0].appendChild(p.extractContents()),b(this,B),p.insertNode(B),B._4e_mergeSiblings(),t.ie||B[0].normalize()):(B=new H(c.createElement("span")),B[0].appendChild(p.extractContents()),
p.insertNode(B),b(this,B),B._4e_remove(!0));p=v}}J._4e_remove();l._4e_remove();a.moveToBookmark(j);a.shrink(D.SHRINK_TEXT)}}function x(a){a.enlarge(D.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var b=new J(d.parent()),g,f=0,k;f<b.elements.length&&(k=b.elements[f])&&!(k==b.block||k==b.blockLimit);f++)if(this.checkElementRemovable(k)){var h=a.checkBoundaryOfElement(k,D.END),j=!h&&a.checkBoundaryOfElement(k,D.START);j||h?(g=k,g.match=j?"start":"end"):(k._4e_mergeSiblings(),
k.nodeName()!=this.element?(h=p(this),i(k,h[k.nodeName()]||h["*"])):e(this,k))}if(g){k=d;for(f=0;;f++){h=b.elements[f];if(h.equals(g))break;else if(h.match)continue;else h=h.clone();h[0].appendChild(k[0]);k=h}k["start"==g.match?"insertBefore":"insertAfter"](g);b=g.html();!b||"\u200b"==b?g.remove():t.webkit&&C(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var l=c.endNode,m=this;g=function(){for(var a=new J(d.parent()),c=new J(l.parent()),b=v,g=v,e=0;e<a.elements.length;e++){var f=a.elements[e];
if(f==a.block||f==a.blockLimit)break;m.checkElementRemovable(f)&&(b=f)}for(e=0;e<c.elements.length;e++){f=c.elements[e];if(f==c.block||f==c.blockLimit)break;m.checkElementRemovable(f)&&(g=f)}g&&l._4e_breakParent(g);b&&d._4e_breakParent(b)};g();for(b=new H(d[0].nextSibling);b[0]!==l[0];){f=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==F.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?e(this,b):(k=p(this),i(b,k[b.nodeName()]||k["*"])),f[0].nodeType==F.NodeType.ELEMENT_NODE&&
f.contains(d)))g(),f=new H(d[0].nextSibling);b=f}}a.moveToBookmark(c)}function y(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,b){c[d]=b});return c}function h(a,c){var d="";c!==k?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function p(c){if(c._.overrides)return c._.overrides;var d=c._.overrides={},b=c._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var g=0;g<b.length;g++){var e=b[g],f,k,t;"string"==typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():c.element,k=e.attributes,t=e.styles);e=d[f]||(d[f]={});if(k){f=e.attributes=e.attributes||[];for(var h in k)f.push([h.toLowerCase(),k[h]])}if(t){var e=e.styles=e.styles||[],i;for(i in t)e.push([i.toLowerCase(),t[i]])}}}return d}function e(b,e){var f=b._.definition,k=p(b),t=a.merge(f.attributes,(k[e.nodeName()]||k["*"]||{}).attributes),f=a.merge(f.styles,
(k[e.nodeName()]||k["*"]||{}).styles),k=a.isEmptyObject(t)&&a.isEmptyObject(f),h;for(h in t)("class"==h||b._.definition.fullMatch)&&e.attr(h)!=c(h,t[h])||(k=k||!!e.hasAttr(h),e.removeAttr(h));for(var i in f)b._.definition.fullMatch&&e.style(i)!=c(i,f[i],g)||(k=k||!!e.style(i),e.style(i,""));d(e)}function c(a,c,d){var b=new H("<span>");b[d?"style":"attr"](a,c);return b[d?"style":"attr"](a)}function b(a,c){for(var d=p(a),b=c.all(a.element),g=b.length;0<=--g;)e(a,new H(b[g]));for(var f in d)if(f!=a.element){b=
c.all(f);for(g=b.length-1;0<=g;g--){var k=new H(b[g]);i(k,d[f])}}}function i(a,c){var b,g=c&&c.attributes;if(g)for(b=0;b<g.length;b++){var e=g[b][0],f;if(f=a.attr(e)){var k=g[b][1];(k===v||k.test&&k.test(f)||"string"==typeof k&&f==k)&&a[0].removeAttribute(e)}}if(g=c&&c.styles)for(b=0;b<g.length;b++)if(e=g[b][0],k=a.css(e)){var t=g[b][1];(t===v||t.test&&t.test(f)||"string"==typeof t&&k==t)&&a.css(e,"")}d(a)}function d(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(g);
c&&(c.nodeType==F.NodeType.ELEMENT_NODE&&F._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==F.NodeType.ELEMENT_NODE&&F._4e_mergeSiblings(b))}}var g=!0,k=!1,v=null,C=a.all,F=a.DOM,D=n.RangeType,L=n.Selection,z=n.PositionType,N=n.Range,H=a.Node,t=a.UA,J=n.ElementPath,B={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},M=n.XHTML_DTD,O={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;n.StyleType=KEST={STYLE_BLOCK:1,STYLE_INLINE:2,
STYLE_OBJECT:3};o.prototype={constructor:o,apply:function(a){w.call(this,a,k)},remove:function(a){w.call(this,a,g)},applyToRange:function(a){return(this.applyToRange=this.type==KEST.STYLE_INLINE?l:this.type==KEST.STYLE_BLOCK?j:v).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==KEST.STYLE_INLINE?x:v).call(this,a)},checkElementRemovable:function(a,c){if(!a)return k;var b=this._.definition,d;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return g;var e=
b._AC;if(e)b=e;else{var e={},f=0,t=b.attributes;if(t)for(var i in t)f++,e[i]=t[i];if(t=o.getStyleText(b))e.style||f++,e.style=t;e._length=f;b=b._AC=e}if(b._length){for(var j in b)if("_length"!=j){f=a.attr(j)||"";if("style"==j)a:{e=b[j];f=h(f,k);"string"==typeof e&&(e=y(e));"string"==typeof f&&(f=y(f));t=void 0;for(t in e)if(!(t in f&&(f[t]==e[t]||"inherit"==e[t]||"inherit"==f[t]))){e=k;break a}e=g}else e=b[j]==f;if(e){if(!c)return g}else if(c)return k}if(c)return g}else return g}j=p(this);if(j=j[a.nodeName()]||
j["*"]){if(!(b=j.attributes)&&!(d=j.styles))return g;if(b)for(e=0;e<b.length;e++)if(j=b[e][0],j=a.attr(j))if(f=b[e][1],f===v||"string"==typeof f&&j==f||f.test&&f.test(j))return g;if(d)for(e=0;e<d.length;e++)if(j=a.css(d[e][0]))if(b=d[e][1],b===v||"string"==typeof b&&j==b||b.test&&b.test(j))return g}return k},checkActive:function(a){switch(this.type){case KEST.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,g);case KEST.STYLE_OBJECT:case KEST.STYLE_INLINE:for(var c=a.elements,b=
0,d;b<c.length;b++)if(d=c[b],!(this.type==KEST.STYLE_INLINE&&(F.equals(d,a.block)||F.equals(d,a.blockLimit))))if((this.type!=KEST.STYLE_OBJECT||d.nodeName()in O)&&this.checkElementRemovable(d,g))return g}return k}};o.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(P,";"));for(var e in c){var g=c[e],f=(e+":"+g).replace(P,";");"inherit"==g?d+=f:b+=f}b.length&&(b=h(b));return a._ST=b+d};return n.Style=o},{requires:"./base,./range,./selection,./domIterator,./elementPath,node".split(",")});
KISSY.add("editor/zIndexManager",function(a,n){var r=n.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};n.baseZIndex=function(a){return(n.Config.baseZIndex||1E4)+a};return r},{requires:["./base"]});
KISSY.add("editor/clipboard",function(a,n,r,q){function o(a){this.editor=a;this._init()}function w(a){var b=a.get("document")[0],e=a.getSelection(),d;if(e.getType()==q.SELECTION_ELEMENT&&(d=e.getSelectedElement())){var a=e.getRanges()[0],g=u(b.createTextNode(""));g.insertBefore(d);a.setStartBefore(g);a.setEndAfter(d);e.selectRanges([a]);setTimeout(function(){d.parent()&&(g.remove(),e.selectElement(d))},0)}}function f(a){if(s.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(s.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&
!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(s.gecko||s.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function j(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(s.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,
"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(s.gecko||s.opera)s.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function m(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"");-1!=a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi,
" "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,b){return b.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(b=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!b&&f(a)&&(a=j(a));return a}var u=a.all,s=a.UA,l=s.ie?"beforepaste":"paste",x=n.RangeType;a.augment(o,{_init:function(){var a=this,b=a.editor,e=b.get("document"),d=e.one("body"),g=function(a){this.type=
a};g.prototype={exec:function(b){var d=this.type;b.focus();setTimeout(function(){s.ie&&("cut"==d?w(b):"paste"==d&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));h(b,d)||alert(p[d])},0)}};d.on(l,a._getClipboardDataFromPasteBin,a);s.ie&&(d.on("paste",a._iePaste,a),e.on("keydown",a._onKeyDown,a),e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));b.addCommand("copy",new g("copy"));b.addCommand("cut",new g("cut"));b.addCommand("paste",
new g("paste"))},_onKeyDown:function(a){this.editor.get("mode")==n.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,e=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{b=e.get("document")[0].queryCommandEnabled(a)}catch(d){}this._isPreventBeforePaste=0}else b=(a=(a=e.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&
clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;this._isPreventPaste||(a.preventDefault(),b.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){logger.debug(l+":  paste event happen");var c=this.editor,b=c.get("document")[0];if(b.getElementById("ke-paste-bin"))logger.debug(l+": trigger more than once ...");else{var e=c.getSelection(),d=new r(b),
g=u(s.webkit?"<body></body>":"<div></div>",b);g.attr("id","ke-paste-bin");s.webkit&&g[0].appendChild(b.createTextNode("\u200b"));b.body.appendChild(g[0]);g.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var f=e.createBookmarks();d.setStartAt(g,x.POSITION_AFTER_START);d.setEndAt(g,x.POSITION_BEFORE_END);d.select(!0);setTimeout(function(){var b,d=g;g=s.webkit&&(b=g.first())&&b.hasClass("Apple-style-span")?b:g;e.selectBookmarks(f);
var h=g.html();d.remove();if(h=m(h))logger.debug("paste "+h),b=c.fire("paste",{html:h}),!1!==b&&(void 0!==b&&(h=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(h)?a.use("editor/plugin/word-filter",function(a,b){c.insertHtml(b.toDataFormat(h,c))}):c.insertHtml(h))},0)}}}});var y=function(a,b){var e=a.get("document")[0],d=u(e.body),g=!1,f=function(){g=!0};d.on(b,f);(7<s.ie?e:e.selection.createRange()).execCommand(b);d.detach(b,f);return g},h=s.ie?function(a,b){return y(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(e){return!1}},
p={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},e={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var b;a.docReady(function(){b=new o(a)});var f={copy:1,cut:1,paste:1},d=["copy","cut","paste"];a.on("contextmenu",function(g){var k=g.contextmenu;if(!k.__copy_fix){k.__copy_fix=1;for(g=0;g<d.length;g++)k.addChild({content:e[d[g]],value:d[g]});k.on("click",function(b){var d=
b.target.get("value");f[d]&&(k.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var h=k.get("children"),g=h.length-1;g--;0<=g){var j=h[g],l;l=j.get?j.get("value"):j.value;f[l]&&(l=!b._stateFromNamedCommand(l),j.set?j.set("disabled",l):j.disabled=l)}})}}},{requires:["./base","./range","./selection","node"]});
KISSY.add("editor/enterKey",function(a,n,r,q){function o(l){var n;n=l.getSelection().getRanges();for(var o=n.length-1;0<o;o--)n[o].deleteContents();n=n[0];o=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var h=(new q(n.startContainer)).block;if(h&&("li"==h.nodeName()||"li"==h.parent().nodeName()))return l.hasCommand("outdent")?(l.execCommand("save"),l.execCommand("outdent"),l.execCommand("save"),!0):!1}var p=n.splitBlock("p");if(!p)return!0;var l=p.previousBlock,h=p.nextBlock,e=p.wasStartOfBlock,
c=p.wasEndOfBlock,b;if(h)b=h.parent(),"li"==b.nodeName()&&(h._4e_breakParent(b),h._4e_move(h.next(),!0));else if(l&&(b=l.parent())&&"li"==b.nodeName())l._4e_breakParent(b),n.moveToElementEditablePosition(l.next()),l._4e_move(l.prev());if(!e&&!c){if("li"==h.nodeName()&&(b=h.first(r.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(f.ie?new u(o.createTextNode("\u00a0")):new u(o.createElement("br"))).insertBefore(b);h&&n.moveToElementEditablePosition(h)}else{var i;if(l){if("li"==l.nodeName()||!j.test(l.nodeName()))i=
l.clone()}else h&&(i=h.clone());i||(i=new u("<p>",null,o));if(b=p.elementPath)for(var p=0,d=b.elements.length;p<d;p++){var g=b.elements[p];if(g.equals(b.block)||g.equals(b.blockLimit))break;m.$removeEmpty[g.nodeName()]&&(g=g.clone(),i._4e_moveChildren(g),i.append(g))}f.ie||i._4e_appendBogus();n.insertNode(i);if(f.ie&&e&&(!c||!l[0].childNodes.length))n.moveToElementEditablePosition(c?l:i),n.select();n.moveToElementEditablePosition(e&&!c?h:i)}f.ie||(h?(i=new u(o.createElement("span")),i.html("&nbsp;"),
n.insertNode(i),i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),n.deleteContents()):i.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));n.select();return!0}function w(a){var f=a.get("document")[0];s.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var h=a.execCommand("enterBlock");a.execCommand("save");!1!==h&&f.preventDefault()}})}var f=a.UA,j=/^h[1-6]$/,m=n.XHTML_DTD,
u=a.Node,s=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:o});a.docReady(function(){w(a)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/htmlDataProcessor",function(a,n,r){return{init:function(q){function o(b){var b=b.childNodes,c,e,f,h=b.length;if(h){f=1;for(c=0;c<h;c++)if(e=b[c],e.nodeType!=a.DOM.NodeType.TEXT_NODE||e.nodeValue){f=0;break}return f?!1:void 0}return!1}function w(a){return a.replace(x,function(a,b,d){return"<"+b+d.replace(y,function(a,b){return-1==d.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function f(a){return a.replace(p,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function j(b){return b.replace(e,function(b,d){return a.urlDecode(d)})}var m=a.Node,u=a.UA,s=new r.Filter,l=new r.Filter;(function(){function b(a){a=r.serialize(a);return new r.Comment(h+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:o}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],
d,c=0;c<b.length;c++)d="_ke_saved_"+b[c],a.getAttribute(d)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var d=b.getAttribute("width"),b=b.getAttribute("height");d&&a.setAttribute("width",d);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:o,strong:o,em:o,del:o,u:o},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,h.length)==h)return b=a.trim(a.urlDecode(b.substr(h.length))),r.parse(b).childNodes[0]}};u.ie&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});s.addRules(e);l.addRules(c)})();(function(){function b(d){for(var d=d.childNodes,c=d.length,e=d[c-1];e&&3==e.nodeType&&!a.trim(e.nodeValue);)e=d[--c];return e}function c(a){var e=b(a);e&&(1==e.nodeType&&"br"==e.nodeName?a.removeChild(e):3==e.nodeType&&
j.test(e.nodeValue)&&a.removeChild(e))}function e(a){var c=b(a);return!c||"form"==a.nodeName&&"input"==c.nodeName}function f(a){c(a);e(a)&&(u.ie||a.appendChild(new r.Tag("br")))}function h(a){c(a);e(a)&&a.appendChild(new r.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,i=n.XHTML_DTD,m=a.merge(i.$block,i.$listItem,i.$tableContent),p;for(p in m)"br"in i[p]||delete m[p];delete m.pre;var i={tags:{}},o={tags:{}};for(p in m)i.tags[p]=f,o.tags[p]=h;l.addRules(i);s.addRules(o)})();s.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var x=/<(a|area|img|input)\b([^>]*)>/gi,y=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,h="{ke_protected}",p=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,c=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,i=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
q.htmlDataProcessor={dataFilter:l,htmlFilter:s,toHtml:function(a){u.webkit&&(a=a.replace(/\u200b/g,""));var b=new r.BeautifyWriter;(new r.Parser(a)).parse().writeHtml(b,s);return a=b.getHtml()},toDataFormat:function(a,e){var e=e||l,a=f(a),a=w(a),a=a.replace(c,"$1ke:$2"),a=a.replace(i,"<ke:$1$2></ke:$1>"),h=new m("<div>");h.html("a"+a);a=h.html().substr(1);a=a.replace(b,"$1$2");a=j(a);h=new r.BasicWriter;(new r.Parser(a)).parse().writeHtml(h,e);return a=h.getHtml()},toServer:function(a){var b=new r.MinifyWriter;
(new r.Parser(a)).parse().writeHtml(b,s);return b.getHtml()}}}}},{requires:["./base","html-parser"]});
KISSY.add("editor/selectionFix",function(a,n){function r(a){function f(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=m}return c}function e(){var a=d.selection.createRange();g&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&g.select();s.remove(d,"mouseup",e);s.remove(d,"mousemove",c);g=b=0}function c(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",g)?a.setEndPoint("StartToStart",g):a.setEndPoint("EndToEnd",g),a.select()}else e()}var b,i=a.get("window")[0],
d=a.get("document")[0],g;s.on(d,"mousedown contextmenu",function(a){var h=d.documentElement;if(a.target===h&&(b&&e(),!(h.scrollHeight>h.clientHeight)&&(b=1,g=f(a.pageX,a.pageY))))s.on(d,"mouseup",e),s.on(d,"mousemove",c),i.focus(),g.select()})}function q(a){function l(b){if(d){var c=a.getSelection(),g=c&&c.getType(),j=c&&e.selection;if(b&&j&&g==y.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){l(f)},50);else{var m;if(!j||!j.type||!("Control"!=j.type&&(m=j.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))i=j&&c.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],c=new x(e.body),b=new x(e.documentElement);if(8>n.Utils.ieEngine)b.on("click",function(b){"html"===(new x(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var i,d,g=f;b.on("mousedown",function(){g=j});b.on("mouseup",function(){g=f});c.on("focusin",function(a){if("body"==(new x(a.target)).nodeName()&&i){try{g&&i.select()}catch(b){}i=
m}});c.on("focus",function(){d=f;l()});c.on("beforedeactivate",function(a){a.relatedTarget||(d=j,g=f)});c.on("mousedown",function(){d=j});c.on("mouseup",function(){d=f;setTimeout(function(){l(f)},0)});c.on("keydown",function(){d=j});c.on("keyup",function(){d=f;setTimeout(function(){l()},0)})}function o(a){var f=a.get("document")[0];s.on(f,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function w(a){function m(a){var b=n.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function e(a){return b(a)&&i(a)}var c=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=n.Walker.whitespaces(f),i=n.Walker.bookmark(j,f),d=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var i=b.path,o=new x(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],q=i.blockLimit;if(u.gecko){var r=i.block||i.blockLimit,s=r&&r.last(e);r&&r._4e_isBlockBoundary()&&(!s||!(1==s[0].nodeType&&
s._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!i.block){if("body"==q.nodeName()){if((i=b.fixBlock(f,"p"))&&i[0]!=o[0].lastChild&&i.outerHtml().match(c))if((q=i.next(d,1))&&q[0].nodeType==l.NodeType.ELEMENT_NODE&&!m[q])b.moveToElementEditablePosition(q),i._4e_remove();else if((q=i.prev(d,1))&&q[0].nodeType==l.NodeType.ELEMENT_NODE&&!m[q])b.moveToElementEditablePosition(q,q.outerHtml().match(c)?j:f),i._4e_remove();b.select();a.notifySelectionChange()}i=
a.get("document")[0];b=new n.Range(i);b.moveToElementEditablePosition(o,f);"body"!==(new n.ElementPath(b.startContainer)).blockLimit.nodeName()&&(o=(new x(i.createElement("p"))).appendTo(o),u.ie||o._4e_appendBogus())}})}var f=!0,j=!1,m=null,u=a.UA,s=a.Event,l=a.DOM,x=a.Node,y=n.SelectionType;return{init:function(a){a.docReady(function(){u.ie?(r(a),q(a)):o(a)});w(a)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["json","editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:"editor,base,editor/plugin/contextmenu,editor/plugin/bubble,editor/plugin/dialog-loader,editor/plugin/flash-common/utils".split(",")}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,overlay,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/progressbar":{requires:["base"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});
a({"editor/plugin/resize":{requires:["editor","dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor",
"editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor",
"editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor",
"editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor",function(a,n,r,q,o,w,f,j,m,u,s,l){function x(a,c){var d=a.body;L(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";d.setAttribute("contentEditable",!1);d.setAttribute("contentEditable",!0);!c&&x(a,1)})}function y(b){b.get("iframe");var c=b.get("textarea")[0],e=b.get("window"),f=b.get("document"),g=f[0];v.webkit&&(f.on("click",function(b){var c=new n(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),f.on("mouseup",function(b){var c=new n(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(v.gecko||C||v.opera){var h;h=(new n('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);h.on("focus",function(){b.focus()});b.activateGecko=function(){v.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}e.on("focus",function(){v.gecko?x(g,d):v.opera&&
g.body.focus();b.notifySelectionChange()});if(v.gecko)f.on("mousedown",function(){b.__iframeFocus||x(g,d)});if(C&&(f.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var i={33:1,34:1};f.on("keydown",function(a){a.keyCode in i&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(v.webkit)f.on("mousedown",function(c){c=new n(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(v.gecko)f.on("dragstart",function(a){var b=new n(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});w.add(b)}function h(b,c,d,e){var f="",h;h=o.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});
return a.substitute(r,{doctype:8===k.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(D(g).isCustomDomain()?'document.domain="'+k.domain+'";':"")+'parent.KISSY.require("editor")._initIframe("'+b+'");<\/script>':""})}function p(a,b){function c(){i=g.document;a.setInternal("document",new n(i));a.setInternal("window",new n(g));d.detach();i.open("text/html","replace");i.write(e);i.close()}var d=
a.get("iframe"),e=h(a.get("id"),a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,i;d.__loaded=1;try{i=g.document}catch(j){if(f.src=f.src,7>C){setTimeout(c,10);return}}c()}function e(b,c){var d=D(g).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new n(a.substitute(z,{iframeSrc:d,prefixCls:b.get("prefixCls")})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",v.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(v.gecko&&!d.__loaded)d.on("load",
function(){p(b,c)},b);else p(b,c)}function c(b){if(b.get("iframe")){var c=b.get("iframe"),d=b.get("window"),b=b.get("document"),e=b[0],f=D(e.documentElement),e=D(e.body);a.each([b,f,e,d],function(a){a.detach()});c.remove()}}var b=!0,i=i,d=!1,g=a.Env.host,k=g.document,v=a.UA,C=v.ie,F=n.NodeType,D=n.all,L=o.tryThese,z='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',N=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;
q.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};q.addMembers({initializer:function(){this.__commands={};this.__controls={};w.register(this)},renderUI:function(){m.init(this);u.init(this);s.init(this);l.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=D(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+
"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");1==a?(this.setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this.getFormatData(1)),b.hide()),c.show(),this.fire("sourceMode"))},
_onSetFocused:function(a){a&&this.__docReady&&this.focus()},setData:function(a){var b,d=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);c(this);e(this,d)}},destructor:function(){var b,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(b=c[0].form)&&(b=D(b))&&b.detach("submit",this.sync,this);if(d){b=D(d[0].body);var c=D(d[0].documentElement),e=this.get("window");w.remove(this);d.detach();c.detach();b.detach();e.detach()}a.each(this.__controls,
function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],
d=a.makeArray(arguments);d.shift();d.unshift(this);if(c)return c.exec.apply(c,d);b+": command not found";return i},queryCommandValue:function(a){return this.execCommand(o.getQueryCmd(a))},getData:function(b,c){var d=this.htmlDataProcessor,e;c==i&&(c=this.get("mode"));e=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=b?d.toHtml(e):d.toServer(e);e=a.trim(e);N.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return h(0,
this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return q.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b="";a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];v.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},
blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(c,a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);
b.href=a},removeCustomLink:function(b){this.get("document").all("link").each(function(a){a.attr("href")==b&&a.remove()});var c=this.get("customLink"),d=a.indexOf(b,c);-1!=d&&c.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=
b.getStartElement(),d=new q.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return i;this.focus();var c,d=a.nodeName(),e=q.XHTML_DTD,f=e.$block[d],g=q.RangeType,h=(d=this.getSelection())&&d.getRanges(),j,k,l;if(!h||0==h.length)return i;this.execCommand("save");for(k=
h.length-1;0<=k;k--)j=h[k],c=!k&&a||a.clone(b),j.insertNodeByDtd(c),l||(l=c);if(!l)return i;j.moveToPosition(l,g.POSITION_AFTER_END);f&&(a=q.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==F.ELEMENT_NODE&&l.nodeName())&&e.$block[a]&&e[a]["#text"]&&j.moveToElementEditablePosition(l));d.selectRanges([j]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(i,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});H.call(this);return c},insertHtml:function(a,b){var c=this,e,f=c.get("document")[0];
if(1===c.get("mode")){if(e=c.htmlDataProcessor)a=e.toDataFormat(a,b);c.focus();c.execCommand("save");if(C){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){"insertHtml error in ie"}}else try{f.execCommand("inserthtml",d,a)}catch(h){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new q.Range(f),e=D(f.body).first(function(a){return 1==a.nodeType&&"br"!=a.nodeName.toLowerCase()});e||(e=D(f.createElement("p")),e._4e_appendBogus().appendTo(f.body));
b.setStartAt(e,q.RangeType.POSITION_AFTER_START);b.select()}f.execCommand("inserthtml",d,a)},50)}setTimeout(function(){c.getSelection().scrollIntoView()},50);H.call(c)}}});q.decorate=function(a,b){var b=b||{},a=D(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");d&&(b.width=b.width||d);e&&(b.height=b.height||e);f&&(c.name=f);b.data=b.data||a.val();b.elBefore=a;c=(new q(b)).render();a.remove();return c};q._initIframe=function(a){var c=w.getInstance(a),
a=c.get("document"),e=a[0];a.one("#ke_active_script").remove();y(c);var f=e.body,g=D(f);C?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){v.gecko||v.opera?f.contentEditable=b:v.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(v.gecko||v.opera){var h=e.documentElement;D(h).on("mousedown",function(a){if(a.target==h){v.gecko&&x(e,d);c.activateGecko()}})}setTimeout(function(){C&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom=
"0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),b=c.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",d,!a);e.execCommand("enableInlineTableEditing",d,!b)}catch(f){g.on(C?"resizestart":"resize",function(c){var d=new n(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var H=a.buffer(function(){this.execCommand("save")},50);return q},{requires:"node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/styles,editor/zIndexManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta".split(",")});
