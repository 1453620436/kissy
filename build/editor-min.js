/*
Copyright 2013, KISSY v1.41
MIT Licensed
build time: Dec 2 15:22
*/
KISSY.add("editor/iframe-content-tpl",[],'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>');
KISSY.add("editor/render-xtpl",[],function(){return function(a,b,v){var o=this,b=this.config.utils,t=b.runBlockCommand,x=b.getExpression,s=b.getPropertyOrRunCommand,b='<div class="',f=s(o,a,{},"prefixCls",0,1,v,!1),b=b+x(f,!0),b=b+'editor-tools"\n     id="ks-editor-tools-',f=s(o,a,{},"id",0,2,v,!1),b=b+x(f,!0),b=b+'">\n\n</div>\n\n<\!--\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\n--\>\n\n<div class="',f=s(o,a,{},"prefixCls",0,11,v,!1),b=b+x(f,!0),b=b+'editor-textarea-wrap"\n\n',
f={},j=[],u=s(o,a,{},"mobile",0,13,v,!0);j.push(u);f.params=j;f.fn=function(){return'\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\n'};b+=t(o,a,f,"if",13);b+='\n\nid="ks-editor-textarea-wrap-';f=s(o,a,{},"id",0,17,v,!1);b+=x(f,!0);b+='"\n>\n\n<textarea\n        id="ks-editor-textarea-';f=s(o,a,{},"id",0,21,v,!1);b+=x(f,!0);b+='"\n        class="';f=s(o,a,{},"prefixCls",0,22,v,!1);b+=x(f,!0);b+='editor-textarea"\n\n';f={};j=[];u=s(o,a,{},"textareaAttrs",0,24,v,!0);j.push(u);f.params=
j;f.fn=function(a){var f;f="\n";var j=s(o,a,{},"xindex",0,25,v,!1);f+=x(j,!0);f+='="';a=s(o,a,{},".",0,25,v,!1);f+=x(a,!0);return f+'"\n'};b+=t(o,a,f,"each",24);b+="\n\n";f={};j=[];u=s(o,a,{},"mode",0,28,v,!0);j.push(u);f.params=j;f.fn=function(){return'\nstyle="display:none"\n'};b+=t(o,a,f,"if",28);b+="\n\n>";t=s(o,a,{},"data",0,32,v,!1);b+=x(t,!0);b+='</textarea>\n\n</div>\n\n<div class="';t=s(o,a,{},"prefixCls",0,36,v,!1);b+=x(t,!0);b+='editor-status"\n     id="ks-editor-status-';a=s(o,a,{},"id",
0,37,v,!1);b+=x(a,!0);return b+'">\n\n</div>'}});KISSY.add("editor/render",["component/control","./render-xtpl"],function(a,b){var v=b("component/control"),o=b("./render-xtpl");return v.getDefaultRender().extend({beforeCreateDom:function(b,o){a.mix(b,{mobile:a.UA.mobile});a.mix(o,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:o}}})});
KISSY.add("editor/base",["html-parser","component/control","./render"],function(a,b){var v=b("html-parser"),o=b("component/control"),t=b("./render");return o.extend({},{Config:{},XHTML_DTD:v.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{view:1,value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:t}},xclass:"editor"})});
KISSY.add("editor/utils",["node","./base"],function(a,b){var v=b("node"),o=b("./base"),t=a.DOM,x=a.UA,s={debugUrl:function(f){var j=a.Config;j.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));-1===f.indexOf("?t")&&(f=-1!==f.indexOf("?")?f+"&":f+"?",f+="t="+encodeURIComponent(j.tag));return j.base+"editor/"+f},lazyRun:function(a,j,b){var p=a[j],n=a[b];a[j]=function(){p.apply(this,arguments);a[j]=a[b];return n.apply(this,arguments)}},getXY:function(a,j){var b=a.left,p=a.top,n=j.get("window")[0],b=b-t.scrollLeft(n),
p=p-t.scrollTop(n),n=j.get("iframe").offset(),b=b+n.left,p=p+n.top;return{left:b,top:p}},tryThese:function(){for(var a,j=0,b=arguments.length;j<b;j++){var p=arguments[j];try{a=p();break}catch(n){}}return a},clearAllMarkers:function(a){for(var j in a)a[j]._4eClearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(a.trim(f))},verifyInputs:function(f){for(var j=0;j<f.length;j++){var b=new v(f[j]),
p=a.trim(s.valInput(b)),n=b.attr("data-verify"),b=b.attr("data-warning");if(n&&!RegExp(n).test(p))return alert(b),!1}return!0},sourceDisable:function(a,b){a.on("sourceMode",b.disable,b);a.on("wysiwygMode",b.enable,b)},resetInput:function(a){var b=a.attr("placeholder");b&&x.ie?(a.addClass("ks-editor-input-tip"),a.val(b)):x.ie||a.val("")},valInput:function(a,b){if(void 0===b)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(b)},placeholder:function(f,b){f.attr("placeholder",
b);x.ie&&(f.on("blur",function(){a.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(b))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");a.trim(f.val())===b&&f.val("")}))},normParams:function(b){var b=a.clone(b),j;for(j in b){var u=b[j];"function"===typeof u&&(b[j]=u())}return b},preventFocus:function(a){x.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(b){a.mix(t,b);for(var j in b)(function(j){v.prototype[j]=function(){var p=[].slice.call(arguments,
0);p.unshift(this[0]);return(p=b[j].apply(null,p))&&(p.nodeType||a.isWindow(p))?new v(p):a.isArray(p)&&(p.__IS_NODELIST||p[0]&&p[0].nodeType)?new v(p):p}})(j)},addRes:function(){var b=this.__res=this.__res||[];b.push.apply(b,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],b=0;b<a.length;b++){var u=a[b];"function"===typeof u?u():u.destroy?u.destroy():u.remove&&u.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,b){return b.toUpperCase()})+
"Value"}};return o.Utils=s});
KISSY.add("editor/focusManager",["./base"],function(a,b){function v(){var a=this;a.__iframeFocus=u;f=a;s&&clearTimeout(s);s=setTimeout(function(){a.fire("focus")},30)}function o(){var a=this;a.__iframeFocus=p;f=n;s&&clearTimeout(s);s=setTimeout(function(){a.fire("blur")},30)}var t=b("./base"),x={},s,f,j={currentInstance:function(){return f},getInstance:function(a){return x[a]},register:function(a){x[a.get("id")]=a},add:function(a){this.register(a);a.get("window").on("focus",v,a).on("blur",o,a)},remove:function(a){delete x[a.get("id")];
a.get("window").detach("focus",v,a).detach("blur",o,a)}},u=!0,p=!1,n=null;t.focusManager=j;t.getInstances=function(){return x};return j});
KISSY.add("editor/dom",["node","./base","./utils"],function(a,b){function v(a,c){var e=a[c?"next":"prev"](void 0,1);if(e&&e[0].nodeType===j.ELEMENT_NODE){for(var g=[];e.attr("_ke_bookmark")||e._4eIsEmptyInlineRemovable(void 0);)if(g.push(e),e=c?e.next(void 0,1):e.prev(void 0,1),!e)return;if(a._4eIsIdentical(e,void 0)){for(var h=new o(c?a[0].lastChild:a[0].firstChild);g.length;)g.shift()._4eMove(a,!c,void 0);e._4eMoveChildren(a,!c,void 0);e.remove();h[0]&&h[0].nodeType===j.ELEMENT_NODE&&h._4eMergeSiblings()}}}
var o=b("node"),t=b("./base"),x=b("./utils"),s=t.XHTML_DTD,f=a.DOM,j=f.NodeType,u=a.UA,p={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};t.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var n=t.PositionType,m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},w={hr:1},q=function(a){return a&&(a[0]||a)};x.injectDom({_4eSameLevel:function(a,c){var c=q(c),e=a.parentNode;return e&&e===c.parentNode},_4eIsBlockBoundary:function(l,c){var e=a.merge(w,c);return!(!m[f.css(l,"display")]&&!e[f.nodeName(l)])},_4eIndex:function(a,c){for(var e=a.parentNode.childNodes,g,h=-1,d=0;d<e.length;d++)if(g=e[d],!c||!(3===g.nodeType&&g.previousSibling&&3===g.previousSibling.nodeType))if(h++,
g===a)return h;return-1},_4eMove:function(a,c,e){c=q(c);e?c.insertBefore(a,c.firstChild):c.appendChild(a)},_4eIsIdentical:function(a,c){if(!c)return!1;c=q(c);if(f.nodeName(a)!==f.nodeName(c))return!1;var e=a.attributes,g,h,d=c.attributes,k=e.length,r=d.length;if(k!==r)return!1;for(var b=0;b<k;b++)if(g=e[b],h=g.name,g.specified&&f.attr(a,h)!==f.attr(c,h))return!1;if(8>u.ieMode)for(b=0;b<r;b++)if(g=d[b],h=g.name,g.specified&&f.attr(a,h)!==f.attr(c,h))return!1;return!0},_4eIsEmptyInlineRemovable:function(l){if(!s.$removeEmpty[f.nodeName(l)])return!1;
for(var l=l.childNodes,c=0,e=l.length;c<e;c++){var g=l[c],h=g.nodeType;if(!(h===j.ELEMENT_NODE&&g.getAttribute("_ke_bookmark"))&&(h===j.ELEMENT_NODE&&!f._4eIsEmptyInlineRemovable(g)||h===f.NodeType.TEXT_NODE&&a.trim(g.nodeValue)))return!1}return!0},_4eMoveChildren:function(a,c,e){c=q(c);if(a!==c)if(e)for(;e=a.lastChild;)c.insertBefore(a.removeChild(e),c.firstChild);else for(;e=a.firstChild;)c.appendChild(a.removeChild(e))},_4eMergeSiblings:function(a){a=new o(a);p[a.nodeName()]&&(v(a,!0),v(a))},_4eSplitText:function(a,
c){var e=a.ownerDocument;if(a.nodeType===f.NodeType.TEXT_NODE){if(u.ie&&c===a.nodeValue.length){var g=e.createTextNode("");f.insertAfter(g,a);return g}g=a.splitText(c);e.documentMode&&(e=e.createTextNode(""),f.insertAfter(e,g),f.remove(e));return g}},_4eParents:function(a,c){var e=[];e.__IS_NODELIST=1;do e[c?"push":"unshift"](a);while(a=a.parentNode);return e},_4eNextSourceNode:function(a,c,e,g){if(g&&!g.call)var h=q(g),g=function(a){return a!==h};var c=!c&&a.firstChild,d=a;if(!c){if(a.nodeType===
j.ELEMENT_NODE&&g&&!1===g(a,!0))return null;c=a.nextSibling}for(;!c&&(d=d.parentNode);){if(g&&!1===g(d,!0))return null;c=d.nextSibling}return!c||g&&!1===g(c)?null:e&&e!==c.nodeType?f._4eNextSourceNode(c,!1,e,g):c},_4ePreviousSourceNode:function(a,c,e,g){if(g&&!g.call)var h=q(g),g=function(a){return a!==h};var c=!c&&a.lastChild,d=a;if(!c){if(a.nodeType===j.ELEMENT_NODE&&g&&!1===g(a,!0))return null;c=a.previousSibling}for(;!c&&(d=d.parentNode);){if(g&&!1===g(d,!0))return null;c=d.previousSibling}return!c||
g&&!1===g(c)?null:e&&c.nodeType!==e?f._4ePreviousSourceNode(c,!1,e,g):c},_4eCommonAncestor:function(a,c){c=q(c);if(a===c)return a;if(f.contains(c,a))return c;var e=a;do if(f.contains(e,c))return e;while(e=e.parentNode);return null},_4eHasAttributes:9>u.ieMode?function(a){for(var c=a.attributes,e=0;e<c.length;e++){var g=c[e];switch(g.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(g.specified)return!0}}return!1}:function(a){u.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4ePosition:function(a,c){var e=q(c);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a===e)return n.POSITION_IDENTICAL;if(a.nodeType===j.ELEMENT_NODE&&e.nodeType===j.ELEMENT_NODE){if(f.contains(a,e))return n.POSITION_CONTAINS+n.POSITION_PRECEDING;if(f.contains(e,a))return n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?n.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?n.POSITION_PRECEDING:n.POSITION_FOLLOWING}for(var g=
f._4eAddress(a),e=f._4eAddress(e),h=Math.min(g.length,e.length),d=0;d<=h-1;d++)if(g[d]!==e[d])return g[d]<e[d]?n.POSITION_PRECEDING:n.POSITION_FOLLOWING;return g.length<e.length?n.POSITION_CONTAINS+n.POSITION_PRECEDING:n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING},_4eAddress:function(a,c){for(var e=[],g=a.ownerDocument.documentElement,h=a;h&&h!==g;)e.unshift(f._4eIndex(h,c)),h=h.parentNode;return e},_4eRemove:function(a,c){var e=a.parentNode;if(e){if(c)for(var g;g=a.firstChild;)e.insertBefore(a.removeChild(g),
a);e.removeChild(a)}return a},_4eTrim:function(a){f._4eLtrim(a);f._4eRtrim(a)},_4eLtrim:function(a){for(var c;c=a.firstChild;){if(c.nodeType===f.NodeType.TEXT_NODE){var e=x.ltrim(c.nodeValue),g=c.nodeValue.length;if(e)e.length<g&&(f._4eSplitText(c,g-e.length),a.removeChild(a.firstChild));else{a.removeChild(c);continue}}break}},_4eRtrim:function(a){for(var c;c=a.lastChild;){if(c.type===f.NodeType.TEXT_NODE){var e=x.rtrim(c.nodeValue),g=c.nodeValue.length;if(e)e.length<g&&(f._4eSplitText(c,e.length),
a.removeChild(a.lastChild));else{a.removeChild(c);continue}}break}!u.ie&&!u.opera&&(c=a.lastChild)&&1===c.nodeType&&"br"===f.nodeName(c)&&a.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===f.NodeType.TEXT_NODE&&!a.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===f.NodeType.TEXT_NODE||"br"!==f.nodeName(c))c=u.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),b.appendChild(c)},_4eSetMarker:function(b,c,e,g){var b=new o(b),h=b.data("list_marker_id")||
b.data("list_marker_id",a.guid()).data("list_marker_id"),d=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[h]=b;d[e]=1;return b.data(e,g)},_4eClearMarkers:function(a,c,e){var a=new o(a),b=a.data("list_marker_names"),h=a.data("list_marker_id"),d;for(d in b)a.removeData(d);a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete c[h])},_4eCopyAttributes:function(a,c,e){for(var c=new o(c),b=a.attributes,e=e||{},h=0;h<b.length;h++){var d=b[h],
k=d.name.toLowerCase(),r;if(!(k in e))if("checked"===k&&(r=f.attr(a,k)))c.attr(k,r);else if(d.specified||u.ie&&d.value&&"value"===k)r=f.attr(a,k),null===r&&(r=d.nodeValue),c.attr(k,r)}""!==a.style.cssText&&(c[0].style.cssText=a.style.cssText)},_4eIsEditable:function(a){a=f.nodeName(a);return(a=!s.$nonEditable[a]&&(s[a]||s.span))&&a["#text"]},_4eGetByAddress:function(a,c,e){for(var a=a.documentElement,b=0;a&&b<c.length;b++){var h=c[b];if(e)for(var d=-1,k=0;k<a.childNodes.length;k++){var r=a.childNodes[k];
if(!(!0===e&&3===r.nodeType&&r.previousSibling&&3===r.previousSibling.nodeType)&&(d++,d===h)){a=r;break}}else a=a.childNodes[h]}return a}})});
KISSY.add("editor/walker",["./base","node"],function(a,b){function v(a,c){if(this._.end)return j;var h,d=this.range,k,r=this.guard,b=this.type,y=a?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,d.trim(),d.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var n=d.endContainer[0],B=n.childNodes[d.endOffset];this._.guardLTR=function(a,i){return i&&(n===a||"body"===p.nodeName(a))?!1:a!==B}}if(a&&!this._.guardRTL){var l=d.startContainer[0],u=0<d.startOffset&&l.childNodes[d.startOffset-
1]||null;this._.guardRTL=function(a,i){return i&&(l===a||"body"===p.nodeName(a))?!1:a!==u}}var I=a?this._.guardRTL:this._.guardLTR;k=r?function(a,i){return I(a,i)===f?f:r(a,i)}:I;this.current?h=this.current[y](f,b,k):a?(h=d.endContainer,0<d.endOffset?(h=new m(h[0].childNodes[d.endOffset-1]),k(h[0])===f&&(h=j)):h=k(h,s)===f?j:h._4ePreviousSourceNode(s,b,k,void 0)):(h=d.startContainer,h=new m(h[0].childNodes[d.startOffset]),h.length?k(h[0])===f&&(h=j):h=k(d.startContainer,s)===f?j:d.startContainer._4eNextSourceNode(s,
b,k,void 0));for(;h&&!this._.end;){this.current=h;if(!this.evaluator||this.evaluator(h[0])!==f){if(!c)return h}else if(c&&this.evaluator)return f;h=h[y](f,b,k)}this.end();return this.current=j}function o(a){for(var c,h=j;c=v.call(this,a);)h=c;return h}function t(a){this.range=a;this.guard=this.evaluator=j;this._={}}var x=b("./base"),s=!0,f=!1,j=null,u=a.UA,p=a.DOM,n=x.XHTML_DTD,m=b("node");a.augment(t,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,
s)},checkForward:function(){return v.call(this,f,s)!==f},checkBackward:function(){return v.call(this,s,s)!==f},lastForward:function(){return o.call(this)},lastBackward:function(){return o.call(this,s)},reset:function(){delete this.current;this._={}},_iterator:v});a.mix(t,{blockBoundary:function(a){return function(c){return!(c.nodeType===p.NodeType.ELEMENT_NODE&&p._4eIsBlockBoundary(c,a))}},bookmark:function(a,c){function h(a){return"span"===p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(d){var k,
b;k=d.nodeType===p.NodeType.TEXT_NODE&&(b=d.parentNode)&&h(b);k=a?k:k||h(d);return!!(c^k)}},whitespaces:function(c){return function(b){b=b.nodeType===p.NodeType.TEXT_NODE&&!a.trim(b.nodeValue);return!!(c^b)}},invisible:function(a){var c=t.whitespaces();return function(h){h=c(h)||h.nodeType===p.NodeType.ELEMENT_NODE&&!h.offsetHeight;return!!(a^h)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=t.whitespaces(),l=t.bookmark(),c=function(a){var c=p.nodeName(a);return l(a)||q(a)||1===a.nodeType&&c in n.$inline&&
!(c in n.$empty)};x.Utils.injectDom({_4eGetBogus:function(a){a=new m(a);do a=a._4ePreviousSourceNode();while(a&&c(a[0]));return a&&(!u.ie?"br"===a.nodeName():3===a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return x.Walker=t});
KISSY.add("editor/elementPath",["node","./base","./dom"],function(a,b){function v(a){for(var b=s,n=s,m=[];a;){if(a[0].nodeType===t.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var o=a.nodeName();if(!n&&(!b&&f[o]&&(b=a),j[o])){var q;if(q=!b)if(q="div"===o){a:{q=a[0].childNodes;for(var l=0,c=q.length;l<c;l++){var e=q[l];if(e.nodeType===t.NodeType.ELEMENT_NODE&&x.$block[e.nodeName.toLowerCase()]){q=!0;break a}}q=!1}q=!q}q?b=a:n=a}m.push(a);if("body"===o)break}a=a.parent()}this.block=
b;this.blockLimit=n;this.elements=m}b("node");var o=b("./base");b("./dom");var t=a.DOM,x=o.XHTML_DTD,s=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={constructor:v,compare:function(a){var b=this.elements,a=a&&a.elements;if(!a||b.length!==a.length)return!1;for(var f=0;f<b.length;f++)if(!t.equals(b[f],a[f]))return!1;return!0},contains:function(a){for(var b=this.elements,f=0;f<b.length;f++)if(b[f].nodeName()in
a)return b[f];return s},toString:function(){var a=this.elements,b,f=[];for(b=0;b<a.length;b++)f.push(a[b].nodeName());return f.toString()}};return o.ElementPath=v});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./elementPath".split(","),function(a,b){function v(I){var b=I.nodeType!==g.NodeType.TEXT_NODE&&g.nodeName(I)in d.$removeEmpty,i=I.nodeType===g.NodeType.TEXT_NODE&&!a.trim(I.nodeValue),I=!!I.parentNode.getAttribute("_ke_bookmark");return b||i||I}function o(a){return!y(a)&&!E(a)}function t(d){var b=q;return function(i){if(E(i))return w;if(i.nodeType===g.NodeType.TEXT_NODE){if(a.trim(i.nodeValue).length)return q}else if(i.nodeType===g.NodeType.ELEMENT_NODE){i=
g.nodeName(i);if(!G[i])if(!d&&!h.ie&&i==="br"&&!b)b=w;else return q}return w}}function x(a,d){var i=a.startContainer,A=a.endContainer,b=a.startOffset,c=a.endOffset,h,k=q,e=q,z,y=a.document,f;d>0&&(z=y.createDocumentFragment());if(a.collapsed)return z;a.optimizeBookmark();if(A[0].nodeType===g.NodeType.TEXT_NODE){e=w;A=A._4eSplitText(c)}else if(A[0].childNodes.length>0)if(c>=A[0].childNodes.length){A=new j(A[0].appendChild(y.createTextNode("")));f=w}else A=new j(A[0].childNodes[c]);if(i[0].nodeType===
g.NodeType.TEXT_NODE){k=w;i._4eSplitText(b)}else if(b)if(b>=i[0].childNodes.length){i=new j(i[0].appendChild(y.createTextNode("")));h=w}else i=new j(i[0].childNodes[b].previousSibling);else{h=new j(y.createTextNode(""));i.prepend(h);i=h;h=w}var n=i._4eParents(),K=A._4eParents();n.each(function(a,i){n[i]=a});K.each(function(a,i){K[i]=a});for(var H,E,y=0;y<n.length;y++){H=n[y];E=K[y];if(!H.equals(E))break}for(var b=z,C,l,B=y;B<n.length;B++){C=n[B];c=d>0&&!C.equals(i)?b.appendChild(C.clone()[0]):null;
C=C[0].nextSibling;l=K[B];for(var m=A[0],p=l&&l[0];C;){if(p===C||m===C)break;l=C.nextSibling;if(d===2)b.appendChild(C.cloneNode(w));else{if(r[C.nodeName.toLowerCase()]){var o=C.cloneNode(w);C.innerHTML="";C=o}else g._4eRemove(C);d===1&&b.appendChild(C)}C=l}c&&(b=c)}for(b=z;y<K.length;y++){C=K[y];c=d>0&&!C.equals(A)?b.appendChild(C.clone()[0]):null;if(!n[y]||!C._4eSameLevel(n[y]))for(C=C[0].previousSibling;C;){l=C.previousSibling;if(d===2)b.insertBefore(C.cloneNode(w),b.firstChild);else{g._4eRemove(C);
d===1&&b.insertBefore(C,b.firstChild)}C=l}c&&(b=c)}if(d===2){if(k){H=i[0];if(H.nodeType===g.NodeType.TEXT_NODE&&H.nextSibling&&H.nextSibling.nodeType===g.NodeType.TEXT_NODE){H.data=H.data+H.nextSibling.data;H.parentNode.removeChild(H.nextSibling)}}if(e){e=A[0];if(e.nodeType===g.NodeType.TEXT_NODE&&e.previousSibling&&e.previousSibling.nodeType===g.NodeType.TEXT_NODE){e.previousSibling.data=e.previousSibling.data+e.data;e.parentNode.removeChild(e)}}}else{if(H&&E&&(!i._4eSameLevel(H)||!A._4eSameLevel(E))){e=
H._4eIndex();h&&H._4eSameLevel(i)&&e--;a.setStart(H.parent(),e+1)}a.collapse(w)}h&&i.remove();f&&A.remove();return z}function s(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function f(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=l;this.collapsed=w;this.document=a}b("./dom");var j=b("node"),u=b("./utils"),p=b("./walker"),n=b("./base"),m=b("./elementPath");n.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var w=true,q=false,l=null,c=n.RangeType,e=n.PositionType,g=a.DOM,h=a.UA,d=n.XHTML_DTD,k=j.all,r={td:1},z={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new p.whitespaces,E=new p.bookmark,B=p.whitespaces(w),J=p.bookmark(false,true),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,
label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(f,{toString:function(){var a=[],d=this.startContainer[0],i=this.endContainer[0];a.push((d.id||d.nodeName)+":"+this.startOffset);a.push((i.id||i.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,d=this.startOffset;a[0].nodeType!==g.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;d=this.endOffset;
a[0].nodeType!==g.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&this.setStartBefore(a);
d&&d.nodeName()==="span"&&d.attr("_ke_bookmark")&&this.setEndAfter(d)},setStart:function(a,d){if(a[0].nodeType===g.NodeType.ELEMENT_NODE&&z[a.nodeName()]){a=a.parent();d=a._4eIndex()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}s(this)},setEnd:function(a,d){if(a[0].nodeType===g.NodeType.ELEMENT_NODE&&z[a.nodeName()]){a=a.parent();d=a._4eIndex()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=a;this.startOffset=
d}s(this)},setStartAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===g.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}s(this)},setEndAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===g.NodeType.TEXT_NODE?
this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}s(this)},cloneContents:function(){return x(this,2)},deleteContents:function(){return x(this,0)},extractContents:function(){return x(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=
w},clone:function(){var a=new f(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==g.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==g.NodeType.ELEMENT_NODE)return l;var d=new p(a);d.evaluator=function(a){return B(a)&&J(a)};a=d.next();d.reset();d=d.previous();return a&&a.equals(d)?
a:l},shrink:function(a,d){if(!this.collapsed){var a=a||c.SHRINK_TEXT,i=this.clone(),b=this.startContainer,h=this.endContainer,k=this.startOffset,r=this.endOffset,e=w,y,z,f=w;if(b&&b[0].nodeType===g.NodeType.TEXT_NODE)if(k)if(k>=b[0].nodeValue.length)i.setStartAfter(b);else{i.setStartBefore(b);e=q}else i.setStartBefore(b);if(h&&h[0].nodeType===g.NodeType.TEXT_NODE)if(r)if(r>=h[0].nodeValue.length)i.setEndAfter(h);else{i.setEndAfter(h);f=q}else i.setEndBefore(h);if(e||f){z=new p(i);z.evaluator=function(d){return d.nodeType===
(a===c.SHRINK_ELEMENT?g.NodeType.ELEMENT_NODE:g.NodeType.TEXT_NODE)};z.guard=function(d,i){if(a===c.SHRINK_ELEMENT&&d.nodeType===g.NodeType.TEXT_NODE||i&&d===y)return q;!i&&d.nodeType===g.NodeType.ELEMENT_NODE&&(y=d);return w}}if(e)(i=z[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(i,d?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(f){z.reset();(z=z[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(z,d?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return e||f}},
createBookmark2:function(a){var d=this.startContainer,i=this.endContainer,b=this.startOffset,c=this.endOffset,h,k;if(!d||!i)return{start:0,end:0};if(a){if(d[0].nodeType===g.NodeType.ELEMENT_NODE)if((h=new j(d[0].childNodes[b]))&&h[0]&&h[0].nodeType===g.NodeType.TEXT_NODE&&b>0&&h[0].previousSibling.nodeType===g.NodeType.TEXT_NODE){d=h;b=0}for(;d[0].nodeType===g.NodeType.TEXT_NODE&&(k=d.prev(void 0,1))&&k[0].nodeType===g.NodeType.TEXT_NODE;){d=k;b=b+k[0].nodeValue.length}if(!this.collapsed){if(i[0].nodeType===
g.NodeType.ELEMENT_NODE)if((h=new j(i[0].childNodes[c]))&&h[0]&&h[0].nodeType===g.NodeType.TEXT_NODE&&c>0&&h[0].previousSibling.nodeType===g.NodeType.TEXT_NODE){i=h;c=0}for(;i[0].nodeType===g.NodeType.TEXT_NODE&&(k=i.prev(void 0,1))&&k[0].nodeType===g.NodeType.TEXT_NODE;){i=k;c=c+k[0].nodeValue.length}}}return{start:d._4eAddress(a),end:this.collapsed?l:i._4eAddress(a),startOffset:b,endOffset:c,normalized:a,is2:w}},createBookmark:function(d){var b,i,h,k,r=this.collapsed;b=new j("<span>",l,this.document);
b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");if(d){h=a.guid("ke_bm_");b.attr("id",h+"S")}if(!r){i=b.clone();i.html("&nbsp;");d&&i.attr("id",h+"E");k=this.clone();k.collapse();k.insertNode(i)}k=this.clone();k.collapse(w);k.insertNode(b);if(i){this.setStartAfter(b);this.setEndBefore(i)}else this.moveToPosition(b,c.POSITION_AFTER_END);return{startNode:d?h+"S":b,endNode:d?h+"E":i,serializable:d,collapsed:r}},moveToPosition:function(a,d){this.setStartAt(a,d);this.collapse(w)},trim:function(a,
d){var i=this.startContainer,b=this.startOffset,h=this.collapsed;if((!a||h)&&i[0]&&i[0].nodeType===g.NodeType.TEXT_NODE){if(b)if(b>=i[0].nodeValue.length){b=i._4eIndex()+1;i=i.parent()}else{var c=i._4eSplitText(b),b=i._4eIndex()+1,i=i.parent();if(g.equals(this.startContainer,this.endContainer))this.setEnd(c,this.endOffset-this.startOffset);else if(g.equals(i,this.endContainer))this.endOffset=this.endOffset+1}else{b=i._4eIndex();i=i.parent()}this.setStart(i,b);if(h){this.collapse(w);return}}i=this.endContainer;
b=this.endOffset;if(!d&&!h&&i[0]&&i[0].nodeType===g.NodeType.TEXT_NODE){if(b){b>=i[0].nodeValue.length||i._4eSplitText(b);b=i._4eIndex()+1}else b=i._4eIndex();i=i.parent();this.setEnd(i,b)}},insertNode:function(a){this.optimizeBookmark();this.trim(q,w);var d=this.startContainer;d[0].insertBefore(a[0],d[0].childNodes[this.startOffset]||null);d[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(d){var b=k(this.document);if(d.is2){var i=b._4eGetByAddress(d.start,
d.normalized),h=d.startOffset,b=d.end&&b._4eGetByAddress(d.end,d.normalized),d=d.endOffset;this.setStart(i,h);b?this.setEnd(b,d):this.collapse(w)}else{i=(h=d.serializable)?a.one("#"+d.startNode,b):d.startNode;d=h?a.one("#"+d.endNode,b):d.endNode;this.setStartBefore(i);i._4eRemove();if(d&&d[0]){this.setEndBefore(d);d._4eRemove()}else this.collapse(w)}},getCommonAncestor:function(a,d){var i=this.startContainer,b=this.endContainer,i=i[0]===b[0]?a&&i[0].nodeType===g.NodeType.ELEMENT_NODE&&this.startOffset===
this.endOffset-1?new j(i[0].childNodes[this.startOffset]):i:i._4eCommonAncestor(b);return d&&i[0].nodeType===g.NodeType.TEXT_NODE?i.parent():i},enlarge:function(){function a(d,i,b,h){var c=d[i?"startContainer":"endContainer"],r,e=i?0:1,z=0,f=i?"previousSibling":"nextSibling";r=d[i?"startOffset":"endOffset"];if(c[0].nodeType===g.NodeType.TEXT_NODE){if(i){if(r)return}else if(r<c[0].nodeValue.length)return;r=c[0][f];c=c[0].parentNode}else{r=c[0].childNodes[r+(i?-1:1)]||null;c=c[0]}for(;c;){for(;r;)if(y(r)||
E(r))r=r[f];else break;if(r){if(!z)d[i?"setStartAfter":"setEndBefore"](k(r));break}c=k(c);if(c.nodeName()==="body")break;if(z||c.equals(h)){b[e]=c;z=1}else d[i?"setStartBefore":"setEndAfter"](c);r=c[0][f];c=c[0].parentNode}}return function(d){switch(d){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var d=this.getCommonAncestor(),i=[];a(this,1,i,d);a(this,0,i,d);if(i[0]&&i[1]){d=i[0].contains(i[1])?i[1]:i[0];this.setStartBefore(d);this.setEndAfter(d)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var b=
new f(this.document),i=new j(this.document.body);b.setStartAt(i,c.POSITION_AFTER_START);b.setEnd(this.startContainer,this.startOffset);var b=new p(b),h,r,e=p.blockBoundary(d===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:l),z=function(a){var d=e(a);d||(h=k(a));return d},y=function(a){var d=z(a);!d&&g.nodeName(a)==="br"&&(r=k(a));return d};b.guard=z;b=b.lastBackward();h=h||i;this.setStartAt(h,h.nodeName()!=="br"&&(!b&&this.checkStartOfBlock()||b&&h.contains(b))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);
b=this.clone();b.collapse();b.setEndAt(i,c.POSITION_BEFORE_END);b=new p(b);b.guard=d===c.ENLARGE_LIST_ITEM_CONTENTS?y:z;h=l;b=b.lastForward();h=h||i;this.setEndAt(h,!b&&this.checkEndOfBlock()||b&&h.contains(b)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);r&&this.setEndAfter(r)}}}(),checkStartOfBlock:function(){var d=this.startContainer,b=this.startOffset;if(b&&d[0].nodeType===g.NodeType.TEXT_NODE&&a.trim(d[0].nodeValue.substring(0,b)).length)return q;this.trim();d=new m(this.startContainer);b=this.clone();
b.collapse(w);b.setStartAt(d.block||d.blockLimit,c.POSITION_AFTER_START);d=new p(b);d.evaluator=t(w);return d.checkBackward()},checkEndOfBlock:function(){var d=this.endContainer,b=this.endOffset;if(d[0].nodeType===g.NodeType.TEXT_NODE&&a.trim(d[0].nodeValue.substring(b)).length)return q;this.trim();d=new m(this.endContainer);b=this.clone();b.collapse(q);b.setEndAt(d.block||d.blockLimit,c.POSITION_BEFORE_END);d=new p(b);d.evaluator=t(q);return d.checkForward()},checkBoundaryOfElement:function(a,d){var b=
this.clone();b[d===c.START?"setStartAt":"setEndAt"](a,d===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new p(b);b.evaluator=v;return b[d===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,b=this.startOffset,h=this.endOffset,c;if(a[0].nodeType===g.NodeType.ELEMENT_NODE){c=a[0].childNodes.length;if(c>b)a=k(a[0].childNodes[b]);else if(c===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=k(a);a=a._4eNextSourceNode()||
a}}if(d[0].nodeType===g.NodeType.ELEMENT_NODE){c=d[0].childNodes.length;if(c>h)d=k(d[0].childNodes[h])._4ePreviousSourceNode(w);else if(c===0)d=d._4ePreviousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=k(d)}}a._4ePosition(d)&e.POSITION_FOLLOWING&&(a=d);return{startNode:a,endNode:d}},fixBlock:function(a,d){var b=this.createBookmark(),r=k(this.document.createElement(d));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);r[0].appendChild(this.extractContents());r._4eTrim();h.ie||r._4eAppendBogus();
this.insertNode(r);this.moveToBookmark(b);return r},splitBlock:function(d){var b=new m(this.startContainer),i=new m(this.endContainer),k=b.block,r=i.block,e=l;if(!b.blockLimit.equals(i.blockLimit))return l;if(d!=="br"){if(!k){k=this.fixBlock(w,d);r=(new m(this.endContainer)).block}r||(r=this.fixBlock(q,d))}d=k&&this.checkStartOfBlock();b=r&&this.checkEndOfBlock();this.deleteContents();if(k&&k[0]===r[0])if(b){e=new m(this.startContainer);this.moveToPosition(r,c.POSITION_AFTER_END);r=l}else if(d){e=
new m(this.startContainer);this.moveToPosition(k,c.POSITION_BEFORE_START);k=l}else{r=this.splitElement(k);!h.ie&&!a.inArray(k.nodeName(),["ul","ol"])&&k._4eAppendBogus()}return{previousBlock:k,nextBlock:r,wasStartOfBlock:d,wasEndOfBlock:b,elementPath:e}},splitElement:function(a){if(!this.collapsed)return l;this.setEndAt(a,c.POSITION_BEFORE_END);var d=this.extractContents(),b=a.clone(q);b[0].appendChild(d);b.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(a,
d){for(var b=0;a;){if(a[0].nodeType===g.NodeType.TEXT_NODE){this.moveToPosition(a,d?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);b=1;break}if(a[0].nodeType===g.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,d?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);b=1}var h=a,k=b,r=void 0;h[0].nodeType===g.NodeType.ELEMENT_NODE&&h._4eIsEditable()&&(r=h[d?"last":"first"](o,1));!k&&!r&&(r=h[d?"prev":"next"](o,1));a=r}return!!b},selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,
d.nodeType===g.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(a){var b,i,h,c=a.nodeName();b=d.$block[c];this.deleteContents();if(b){for(b=this.getCommonAncestor(q,w);(i=d[b.nodeName()])&&(!i||!i[c]);){var k=b.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(b);this.collapse(w);b.remove()}else h=b;b=k}h&&this.splitElement(h)}this.insertNode(a)}});u.injectDom({_4eBreakParent:function(a,d){var d=k(d),a=k(a),b,h=new n.Range(a[0].ownerDocument);
h.setStartAfter(a);h.setEndAfter(d);b=h.extractContents();h.insertNode(a.remove());a.after(b)}});return n.Range=f});
KISSY.add("editor/selection",["node","./walker","./range","./base"],function(a,b){function v(a){this.document=a;this._={cache:{}};if(q)try{var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!==a||d.parentElement&&d.parentElement().ownerDocument!==a)this.isInvalid=j}catch(b){this.isInvalid=j}}function o(a){a=new v(a);return!a||a.isInvalid?u:a}var t=b("node"),x=b("./walker"),s=b("./range"),f=b("./base");f.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};
var j=!0,u=null,p=a.UA,n=a.DOM,m=f.SelectionType,w=f.RangeType,q=document.selection,l={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(v,{getNative:!q?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=n.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!q?function(){var a=this._.cache;if(a.type)return a.type;
var d=m.SELECTION_TEXT,b=this.getNative();if(b){if(1===b.rangeCount){var b=b.getRangeAt(0),c=b.startContainer;c===b.endContainer&&c.nodeType===n.NodeType.ELEMENT_NODE&&1===Number(b.endOffset-b.startOffset)&&l[c.childNodes[b.startOffset].nodeName.toLowerCase()]&&(d=m.SELECTION_ELEMENT)}}else d=m.SELECTION_NONE;return a.type=d}:function(){var a=this._.cache;if(a.type)return a.type;var d=m.SELECTION_NONE;try{var b=this.getNative(),c=b.type;"Text"===c&&(d=m.SELECTION_TEXT);"Control"===c&&(d=m.SELECTION_ELEMENT);
b.createRange().parentElement&&(d=m.SELECTION_TEXT)}catch(e){}return a.type=d},getRanges:q?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),h=c.childNodes,e,g=0;g<h.length;g++){var f=h[g];if(f.nodeType===n.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(f);var f=e.compareEndPoints("StartToStart",a),j=e.compareEndPoints("EndToStart",a);e.collapse();if(0<f)break;else{if(!f||1===j&&-1===f)return{container:c,offset:g};if(!j)return{container:c,offset:g+
1}}e=u}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=h[--g].nodeValue.length}catch(l){e=0}return 0===e?{container:c,offset:g}:{container:h[g],offset:-e}};return function(d){var b=this._.cache;if(b.ranges&&!d)return b.ranges;var c=this.getNative(),d=c&&c.createRange(),e=this.getType();if(!c)return[];if(e===m.SELECTION_TEXT)return c=new s(this.document),e=a(d,j),c.setStart(new t(e.container),
e.offset),e=a(d),c.setEnd(new t(e.container),e.offset),b.ranges=[c],[c];if(e===m.SELECTION_ELEMENT){b=b.ranges=[];for(e=0;e<d.length;e++){for(var g=d.item(e),f=g.parentNode,n=0,c=new s(this.document);n<f.childNodes.length&&f.childNodes[n]!==g;n++);c.setStart(new t(f),n);c.setEnd(new t(f),n+1);b.push(c)}return b}b.ranges=[];return[]}}():function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var a=[],b=this.getNative();if(!b)return[];for(var c=0;c<b.rangeCount;c++){var e=b.getRangeAt(c),g=new s(this.document);
g.setStart(new t(e.startContainer),e.startOffset);g.setEnd(new t(e.endContainer),e.endOffset);a.push(g)}return d.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var d,b=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();j;)if(d=c.startContainer,c.startOffset===(d[0].nodeType===n.NodeType.ELEMENT_NODE?d[0].childNodes.length:
d[0].nodeValue.length)&&!d._4eIsBlockBoundary())c.setStartAfter(d);else break;d=c.startContainer;if(d[0].nodeType!==n.NodeType.ELEMENT_NODE)return d.parent();d=new t(d[0].childNodes[c.startOffset]);if(!d[0]||d[0].nodeType!==n.NodeType.ELEMENT_NODE)return c.startContainer;for(c=d[0].firstChild;c&&c.nodeType===n.NodeType.ELEMENT_NODE;)d=new t(c),c=c.firstChild;return d}if(q)c=b.createRange(),c.collapse(j),d=new t(c.parentElement());else{if((d=b.anchorNode)&&d.nodeType!==n.NodeType.ELEMENT_NODE)d=d.parentNode;
d&&(d=new t(d))}}return a.startElement=d},getSelectedElement:function(){var a,d=this._.cache;if(void 0!==d.selectedElement)return d.selectedElement;q&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var b;if(a)b=new t(a);else{a=this.getRanges()[0];for(var c,e=2;e&&(!(b=a.getEnclosedNode())||!(b[0].nodeType===n.NodeType.ELEMENT_NODE&&l[b.nodeName()]&&(c=b)));e--)a.shrink(w.SHRINK_ELEMENT);b=c}a=b;return d.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var d,b=
this.document;if(q)try{d=b.body.createControlRange(),d.addElement(a[0]),d.select()}catch(c){d=b.body.createTextRange(),d.moveToElementText(a[0]),d.select()}finally{}else d=b.createRange(),d.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(d);this.reset()},selectRanges:function(a){if(q){if(1<a.length){var d=a[a.length-1];a[0].setEnd(d.endContainer,d.endOffset);a.length=1}a[0]&&a[0].select()}else{d=this.getNative();if(!d)return;d.removeAllRanges();for(var b=0;b<a.length;b++){var c=
a[b],e=this.document.createRange(),g=c.startContainer;if(c.collapsed&&(p.gecko&&1.09>p.gecko||p.opera||p.webkit)&&g[0].nodeType===n.NodeType.ELEMENT_NODE&&!g[0].childNodes.length)g[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),c.startOffset++,c.endOffset++;e.setStart(g[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);d.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var d=[],b=this.getRanges(),c=0;c<b.length;c++)d.push(b[c].createBookmark2(a));return d},createBookmarks:function(b,
d){for(var c=[],e=this.document,g,d=d||this.getRanges(),f=d.length,l=0;l<f;l++){c.push(g=d[l].createBookmark(b,j));var m=(b=g.serializable)?a.one("#"+g.startNode,e):g.startNode;g=b?a.one("#"+g.endNode,e):g.endNode;for(var p=l+1;p<f;p++){var q=d[p],o=q.startContainer,s=q.endContainer;n.equals(o,m.parent())&&q.startOffset++;n.equals(o,g.parent())&&q.startOffset++;n.equals(s,m.parent())&&q.endOffset++;n.equals(s,g.parent())&&q.endOffset++}}return c},selectBookmarks:function(a){for(var d=[],b=0;b<a.length;b++){var c=
new s(this.document);c.moveToBookmark(a[b]);d.push(c)}this.selectRanges(d);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();q?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},e=x.whitespaces(j),
g=/\ufeff|\u00a0/;s.prototype.select=!q?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType===n.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var d=this.document.createRange();d.setStart(a[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(0<=b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(j),d.setEnd(this.endContainer[0],this.endOffset);
else throw b;}a=o(this.document).getNative();a.removeAllRanges();a.addRange(d)}:function(a){var d=this.collapsed,b,r;if(this.startContainer[0]===this.endContainer[0]&&1===this.endOffset-this.startOffset){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType===n.NodeType.ELEMENT_NODE){(new v(this.document)).selectElement(new t(f));return}}(this.startContainer[0].nodeType===n.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===n.NodeType.ELEMENT_NODE&&
this.endContainer.nodeName()in c)&&this.shrink(w.SHRINK_ELEMENT,j);var y=this.createBookmark(),f=y.startNode,l;d||(l=y.endNode);y=this.document.body.createTextRange();y.moveToElementText(f[0]);y.moveStart("character",1);if(l)a=this.document.body.createTextRange(),a.moveToElementText(l[0]),y.setEndPoint("EndToEnd",a),y.moveEnd("character",-1);else{for(b=f[0].nextSibling;b&&!e(b);)b=b.nextSibling;b=!(b&&b.nodeValue&&b.nodeValue.match(g))&&(a||!f[0].previousSibling||f[0].previousSibling&&"br"===n.nodeName(f[0].previousSibling));
r=new t(this.document.createElement("span"));r.html("&#65279;");r.insertBefore(f);b&&n.insertBefore(this.document.createTextNode("\ufeff"),f[0]||f)}this.setStartBefore(f);f._4eRemove();if(d){if(b?(y.moveStart("character",-1),y.select(),this.document.selection.clear()):y.select(),r)this.moveToPosition(r,w.POSITION_BEFORE_START),r._4eRemove()}else this.setEndBefore(l),l._4eRemove(),y.select()};v.getSelection=o;return f.Selection=v});
KISSY.add("editor/clipboard",["node","./base","./range","./selection"],function(a,b){function v(a){this.editor=a;this._init()}function o(a){var b=a.get("document")[0],c=a.getSelection(),e;if(c.getType()===p.SELECTION_ELEMENT&&(e=c.getSelectedElement())){var a=c.getRanges()[0],h=n(b.createTextNode(""));h.insertBefore(e);a.setStartBefore(h);a.setEndAfter(e);c.selectRanges([a]);setTimeout(function(){e.parent()&&(h.remove(),c.selectElement(e))},0)}}function t(a){if(m.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(m.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(m.gecko||m.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function x(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(m.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(m.gecko||m.opera)m.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function s(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"");-1!==a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,b){return b.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(b=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!b&&t(a)&&(a=x(a));return a}var f=b("node"),j=b("./base"),u=b("./range"),p=b("./selection"),n=f.all,
m=a.UA,w=11>m.ieMode,q=w?"beforepaste":"paste",l=j.RangeType;a.augment(v,{_init:function(){var a=this,b=a.editor,c=b.get("document"),h=c.one("body"),f=function(a){this.type=a};f.prototype={exec:function(b){var c=this.type;b.focus();setTimeout(function(){w&&("cut"===c?o(b):"paste"===c&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));e(b,c)||alert(g[c])},0)}};h.on(q,a._getClipboardDataFromPasteBin,a);w&&(h.on("paste",a._iePaste,a),c.on("keydown",a._onKeyDown,a),c.on("contextmenu",function(){a._isPreventBeforePaste=
1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));b.addCommand("copy",new f("copy"));b.addCommand("cut",new f("cut"));b.addCommand("paste",new f("paste"))},_onKeyDown:function(a){this.editor.get("mode")===j.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86===a.keyCode||a.shiftKey&&45===a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,c=this.editor;if("paste"===a){this._isPreventBeforePaste=1;try{b=c.get("document")[0].queryCommandEnabled(a)}catch(e){}this._isPreventBeforePaste=
0}else b=(a=(a=c.getSelection())&&a.getRanges())&&!(1===a.length&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;this._isPreventPaste||(a.preventDefault(),b.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){q+":  paste event happen";var b=this.editor,
c=b.get("document")[0];if(c.getElementById("ke-paste-bin"))q+": trigger more than once ...";else{var e=b.getSelection(),h=new u(c),g=n(m.webkit?"<body></body>":"<div></div>",c);g.attr("id","ke-paste-bin");m.webkit&&g[0].appendChild(c.createTextNode("\u200b"));c.body.appendChild(g[0]);g.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var f=e.createBookmarks();h.setStartAt(g,l.POSITION_AFTER_START);h.setEndAt(g,l.POSITION_BEFORE_END);
h.select(!0);setTimeout(function(){var c,h=g;g=m.webkit&&(c=g.first())&&c.hasClass("Apple-style-span")?c:g;e.selectBookmarks(f);var k=g.html();h.remove();if(k=s(k))"paste "+k,c=b.fire("paste",{html:k}),!1!==c&&(void 0!==c&&(k=c),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(k)?a.use("editor/plugin/word-filter",function(a,c){b.insertHtml(c.toDataFormat(k,b))}):b.insertHtml(k))},0)}}}});var c=function(a,b){var c=a.get("document")[0],e=n(c.body),h=!1,g=function(){h=!0};e.on(b,g);(7<m.ieMode?
c:c.selection.createRange()).execCommand(b);e.detach(b,g);return h},e=w?function(a,b){return c(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(c){return!1}},g={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},h={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var b;a.docReady(function(){b=new v(a)});var c={copy:1,cut:1,paste:1},e=["copy","cut","paste"];
a.on("contextmenu",function(g){var f=g.contextmenu;if(!f.__copyFix){f.__copyFix=1;for(g=0;g<e.length;g++)f.addChild({content:h[e[g]],value:e[g]});f.on("click",function(b){var e=b.target.get("value");c[e]&&(f.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(e);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var j=f.get("children"),g=j.length-1;g--;0<=g){var n=j[g],l;l=n.get?n.get("value"):n.value;c[l]&&(l=!b._stateFromNamedCommand(l),n.set?n.set("disabled",l):n.disabled=
l)}})}}});
KISSY.add("editor/enterKey",["node","./walker","./base","./elementPath"],function(a,b){function v(b){var m;m=b.getSelection().getRanges();for(var o=m.length-1;0<o;o--)m[o].deleteContents();m=m[0];o=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var q=(new f(m.startContainer)).block;if(q&&("li"===q.nodeName()||"li"===q.parent().nodeName()))return b.hasCommand("outdent")?(b.execCommand("save"),b.execCommand("outdent"),b.execCommand("save"),!0):!1}var l=m.splitBlock("p");if(!l)return!0;var b=
l.previousBlock,q=l.nextBlock,c=l.wasStartOfBlock,e=l.wasEndOfBlock,g;if(q)g=q.parent(),"li"===g.nodeName()&&(q._4eBreakParent(g),q._4eMove(q.next(),!0));else if(b&&(g=b.parent())&&"li"===g.nodeName())b._4eBreakParent(g),m.moveToElementEditablePosition(b.next()),b._4eMove(b.prev());var h;if(!c&&!e){if("li"===q.nodeName()&&(g=q.first(x.invisible(!0)))&&a.inArray(g.nodeName(),["ul","ol"]))(j?new t(o.createTextNode("\u00a0")):new t(o.createElement("br"))).insertBefore(g);q&&m.moveToElementEditablePosition(q)}else{if(b){if("li"===
b.nodeName()||!u.test(b.nodeName()))h=b.clone()}else q&&(h=q.clone());h||(h=new t("<p>",null,o));if(g=l.elementPath)for(var l=0,d=g.elements.length;l<d;l++){var k=g.elements[l];if(k.equals(g.block)||k.equals(g.blockLimit))break;p.$removeEmpty[k.nodeName()]&&(k=k.clone(),h._4eMoveChildren(k),h.append(k))}j||h._4eAppendBogus();m.insertNode(h);if(j&&c&&(!e||!b[0].childNodes.length))m.moveToElementEditablePosition(e?b:h),m.select();m.moveToElementEditablePosition(c&&!e?q:h)}j||(q?(h=new t(o.createElement("span")),
h.html("&nbsp;"),m.insertNode(h),h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),m.deleteContents()):h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));m.select();return!0}function o(a){a.get("document").on("keydown",function(b){if(13===b.keyCode&&!b.shiftKey&&!b.ctrlKey&&!b.metaKey){a.execCommand("save");var f=a.execCommand("enterBlock");a.execCommand("save");!1!==f&&b.preventDefault()}})}var t=b("node"),x=b("./walker"),
s=b("./base"),f=b("./elementPath"),j=11>a.UA.ieMode,u=/^h[1-6]$/,p=s.XHTML_DTD;return{init:function(a){a.addCommand("enterBlock",{exec:v});a.docReady(function(){o(a)})}}});
KISSY.add("editor/htmlDataProcessor",["./base","html-parser"],function(a,b){var v=b("./base"),o=b("html-parser"),t=11>a.UA.ieMode;return{init:function(b){function s(b){var b=b.childNodes,c,d,e,g=b.length;if(g){e=1;for(c=0;c<g;c++)if(d=b[c],d.nodeType!==a.DOM.NodeType.TEXT_NODE||d.nodeValue){e=0;break}return e?!1:void 0}return!1}function f(a){return a.replace(q,function(a,b,c){return"<"+b+c.replace(l,function(a,b){return-1===c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function j(a){return a.replace(e,
function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function u(b){return b.replace(g,function(b,c){return a.urlDecode(c)})}var p=a.Node,n=a.UA,m=new o.Filter,w=new o.Filter;(function(){function b(a){a=o.serialize(a);return new o.Comment(c+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:s}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:s,strong:s,em:s,del:s,u:s},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,c.length)===c)return b=a.trim(a.urlDecode(b.substr(c.length))),o.parse(b).childNodes[0]}};t&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});m.addRules(e);w.addRules(d)})();(function(){function b(c){for(var c=c.childNodes,d=c.length,i=c[d-1];i&&3===i.nodeType&&!a.trim(i.nodeValue);)i=c[--d];return i}function c(a){var d=b(a);d&&(1===d.nodeType&&"br"===d.nodeName?a.removeChild(d):
3===d.nodeType&&h.test(d.nodeValue)&&a.removeChild(d))}function d(a){var c=b(a);return!c||"form"===a.nodeName&&"input"===c.nodeName}function e(a){c(a);d(a)&&(t||a.appendChild(new o.Tag("br")))}function g(a){c(a);d(a)&&a.appendChild(new o.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,f=v.XHTML_DTD,k=a.merge(f.$block,f.$listItem,f.$tableContent),j;for(j in k)"br"in f[j]||delete k[j];delete k.pre;var f={tags:{}},i={tags:{}};for(j in k)f.tags[j]=e,i.tags[j]=g;w.addRules(f);m.addRules(i)})();
m.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var q=/<(a|area|img|input)\b([^>]*)>/gi,l=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",e=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,g=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,h=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,d=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,
k=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;b.htmlDataProcessor={dataFilter:w,htmlFilter:m,toHtml:function(a){n.webkit&&(a=a.replace(/\u200b/g,""));var b=new o.BeautifyWriter;(new o.Parser(a)).parse().writeHtml(b,m);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||w,a=j(a),a=f(a),a=a.replace(h,"$1ke:$2"),a=a.replace(k,"<ke:$1$2></ke:$1>"),c=new p("<div>");c.html("a"+a);a=c.html().substr(1);a=a.replace(d,"$1$2");a=u(a);c=new o.BasicWriter;(new o.Parser(a)).parse().writeHtml(c,b);return a=
c.getHtml()},toServer:function(a){var b=new o.MinifyWriter;(new o.Parser(a)).parse().writeHtml(b,m);return b.getHtml()}}}}});
KISSY.add("editor/selectionFix",["./base","./selection","./range","node"],function(a,b){function v(a){function b(a,c){var d=j.body.createTextRange();try{d.moveToPoint(a,c)}catch(e){d=n}return d}function e(){var a=j.selection.createRange();m&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&m.select();f.detach("mouseup",e);f.detach("mousemove",g);m=h=0}function g(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",m)?a.setEndPoint("StartToStart",m):a.setEndPoint("EndToEnd",
m),a.select()}else e()}var h,d=a.get("window")[0],f=a.get("document"),j=f[0],m;f.on("mousedown contextmenu",function(a){var l=j.documentElement;if(a.target===l&&(h&&e(),!(l.scrollHeight>l.clientHeight)&&(h=1,m=b(a.pageX,a.pageY))))f.on("mouseup",e),f.on("mousemove",g),d.focus(),m.select()})}function o(b){function c(a){if(k){var g=b.getSelection(),f=g&&g.getType(),h=g&&e.selection;if(a&&h&&f===q.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){c(u)},50);else{var j;if(!h||
!h.type||!("Control"!==h.type&&(j=h.createRange())&&(j=j.parentElement())&&(j=j.nodeName)&&j.toLowerCase()in{input:1,textarea:1}))d=h&&g.getRanges()[0],b.checkSelectionChange()}}}var e=b.get("document")[0],g=new j(e.body),f=new j(e.documentElement);if(8>a.UA.ieMode)f.on("click",function(a){"html"===(new j(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var d,k,r=u;f.on("mousedown",function(){r=p});f.on("mouseup",function(){r=u});g.on("focusin",function(a){if("body"===
(new j(a.target)).nodeName()&&d){try{r&&d.select()}catch(b){}d=n}});g.on("focus",function(){k=u;c()});g.on("beforedeactivate",function(a){a.relatedTarget||(k=p,r=u)});g.on("mousedown",function(){k=p});g.on("mouseup",function(){k=u;setTimeout(function(){c(u)},0)});g.on("keydown",function(){k=p});g.on("keyup",function(){k=u;setTimeout(function(){c()},0)})}function t(a){a.get("document").on("mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function x(a){function b(a){var c=s.XHTML_DTD;
return a._4eIsBlockBoundary()&&c.$empty[a.nodeName()]}function e(a){return f(a)&&d(a)}var g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,f=s.Walker.whitespaces(u),d=s.Walker.bookmark(p,u),k=function(a){return f(a)&&8!==a.nodeType};a.on("selectionChange",function(d){var f=d.path,h=a.get("document")[0],n=new j(h.body),d=(d=d.selection)&&d.getRanges()[0],o=f.blockLimit;n[0]||(h.documentElement.appendChild(h.createElement("body")),
n=new j(h.body),d&&(d.setStart(n,0),d.collapse(1)));o=o||n;if(m.gecko){var q=(h=f.block||f.blockLimit)&&h.last(e);h&&h._4eIsBlockBoundary()&&(!q||!(1===q[0].nodeType&&q._4eIsBlockBoundary()))&&"pre"!==h.nodeName()&&!h._4eGetBogus()&&h._4eAppendBogus()}if(d&&d.collapsed&&!f.block){if("body"===o.nodeName()){"html"===d.startContainer.nodeName()&&d.setStart(n,0);if((f=d.fixBlock(u,"p"))&&f[0]!==n[0].lastChild&&f.outerHtml().match(g))if((h=f.next(k,1))&&h[0].nodeType===w.NodeType.ELEMENT_NODE&&!b[h])d.moveToElementEditablePosition(h),
f._4eRemove();else if((h=f.prev(k,1))&&h[0].nodeType===w.NodeType.ELEMENT_NODE&&!b[h])d.moveToElementEditablePosition(h,h.outerHtml().match(g)?p:u),f._4eRemove();d.select();a.notifySelectionChange()}f=a.get("document")[0];d=new s.Range(f);d.moveToElementEditablePosition(n,u);"body"!==(new s.ElementPath(d.startContainer)).blockLimit.nodeName()&&(n=(new j(f.createElement("p"))).appendTo(n),m.ie||n._4eAppendBogus())}})}var s=b("./base");b("./selection");var f=b("./range"),j=b("node"),u=!0,p=!1,n=null,
m=a.UA,w=a.DOM,q=s.SelectionType;return{init:function(a){a.docReady(function(){if(document.selection)v(a),o(a);else if(t(a),11===m.ieMode)a.get("document").on("focusin",function(b){var e=a.getSelection(),e=e&&e.getRanges()[0];e||(e=new f(this),e.setStart(j.all(b.target),0),e.collapse(1),e.select())})});x(a)}}});
KISSY.add("editor/plugin-meta",[],function(){(function(a){a({"editor/plugin/back-color":{requires:["editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor/plugin/font/ui","editor/plugin/bold/cmd","editor/plugin/button"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/button","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","menubutton","editor/plugin/dialog"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor",
"editor/plugin/dialog"]}});a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix","event"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["editor","overlay"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:"editor,json,event,editor/plugin/local-storage,overlay,editor/plugin/menubutton".split(",")}});
a({"editor/plugin/drag-upload":{requires:["editor","event"]}});a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["editor","swf","event"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor/plugin/flash-common/utils","base","editor","editor/plugin/dialog-loader","editor/plugin/bubble"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd","editor/plugin/menubutton"]}});a({"editor/plugin/font-family/cmd":{requires:["editor/plugin/font/cmd"]}});
a({"editor/plugin/font-size":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd","editor/plugin/menubutton"]}});a({"editor/plugin/font-size/cmd":{requires:["editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});
a({"editor/plugin/heading":{requires:["editor/plugin/menubutton","editor","editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor/plugin/button","editor","editor/plugin/bubble","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["editor","io","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd","editor/plugin/button"]}});
a({"editor/plugin/indent/cmd":{requires:["editor/plugin/dent-cmd"]}});a({"editor/plugin/italic":{requires:["editor/plugin/font/ui","editor/plugin/italic/cmd","editor/plugin/button"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});
a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor/plugin/button","editor/plugin/bubble","editor","editor/plugin/link/utils",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay",
"editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor/plugin/maximize/cmd","editor/plugin/button"]}});a({"editor/plugin/maximize/cmd":{requires:["editor","event"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/ordered-list":{requires:["editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/button","editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/preview":{requires:["editor/plugin/button"]}});a({"editor/plugin/progressbar":{requires:["base"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/button",
"editor/plugin/remove-format/cmd"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay","editor/plugin/button"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor/plugin/font/ui","editor/plugin/strike-through/cmd","editor/plugin/button"]}});
a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu","editor/plugin/button"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor/plugin/font/ui","editor/plugin/underline/cmd","editor/plugin/button"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});
a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd","editor/plugin/button"]}});a({"editor/plugin/undo/btn":{requires:["editor/plugin/button","editor"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor",
"editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor/styles",["node","./selection","./range","./base","./elementPath"],function(a,b){function v(a){return!F.attr(a,"_ke_bookmark")}function o(a,b){for(var c in a)"string"===typeof a[c]?a[c]=a[c].replace(Q,function(a,c){return b[c]}):o(a[c],b)}function t(b,c){c&&(b=a.clone(b),o(b,c));var d=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#text"===d||N[d]?D.STYLE_BLOCK:O[d]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:b}}function x(a,b){var c=b?this.removeFromRange:
this.applyToRange;a.body.focus();for(var d=new r(a),i=d.getRanges(),e=0;e<i.length;e++)c.call(this,i[e]);d.selectRanges(i)}function s(a,b,c){var d=a.element;"*"===d&&(d="span");b=new k(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=t.getStyleText(c);if(a)for(var i in a)b.attr(i,a[i]);c&&(b[0].style.cssText=c);return b}function f(a){var b=a.createBookmark(B),c=a.createIterator();c.enforceRealBlocks=B;c.enlargeBr=B;for(var d,i=a.document;d=c.getNextParagraph();){var e=
s(this,i,d),f=e,e="pre"===f.nodeName,h="pre"===d.nodeName,g=!e&&h;e&&!h?(h=d,g=h.html(),g=j(g,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),g=g.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),g=g.replace(/([ \t\n\r]+|&nbsp;)/g," "),g=g.replace(/<br\b[^>]*>/gi,"\n"),M.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(f[0]),f.outerHtml("<pre>"+g+"</pre>"),f=new k(h.firstChild),f._4eRemove()):f.html(g)):g?f=p(u(d),f):d._4eMoveChildren(f);d[0].parentNode.replaceChild(f[0],d[0]);if(e&&(d=f,e=void 0,
(e=d._4ePreviousSourceNode(B,F.NodeType.ELEMENT_NODE))&&"pre"===e.nodeName()))f=j(e.html(),/\n$/,"")+"\n\n"+j(d.html(),/^\n/,""),M.ie?d.outerHtml("<pre>"+f+"</pre>"):d.html(f),e._4eRemove()}a.moveToBookmark(b)}function j(a,b,c){var d="",i="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(i=c);return""});return d+a.replace(b,c)+i}function u(a){var b=[];j(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function p(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var i=a[d],i=i.replace(/(\r\n|\r)/g,"\n"),i=j(i,/^[ \t]*\n/,""),i=j(i,/\n$/,""),i=j(i,/^[ \t]+|[ \t]+$/g,function(a,b){return 1===a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),i=i.replace(/\n/g,"<br>"),i=i.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),e=b.clone();e.html(i);c.appendChild(e[0])}return c}function n(a){var b=a.document;if(a.collapsed)b=s(this,b,void 0),a.insertNode(b),a.moveToPosition(b,i.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,e,f=L[c];f||(e=B,f=L.span);var h=a.createBookmark();a.enlarge(i.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),n=j.startNode,j=j.endNode,l=n,D;l&&l[0];){var m=J;if(F.equals(l,j))l=G,m=B;else{var o=l[0].nodeType,q=o===F.NodeType.ELEMENT_NODE?l.nodeName():G;if(q&&l.attr("_ke_bookmark")){l=
l._4eNextSourceNode(B);continue}if(!q||f[q]&&(l._4ePosition(j)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)===A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(l))){var p=l.parent();if(p&&"a"===c&&p.nodeName()===c)o=s(this,b,void 0),p._4eMoveChildren(o),p[0].parentNode.replaceChild(o[0],p[0]),o._4eMergeSiblings();else if(p&&p[0]&&((L[p.nodeName()]||L.span)[c]||e)&&(!d.parentRule||d.parentRule(p))){if(!D&&(!q||!L.$removeEmpty[q]||(l._4ePosition(j)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)===A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))D=new z(b),D.setStartBefore(l);if(o===F.NodeType.TEXT_NODE||o===F.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){p=l;for(o=null;(m=!p.next(v,1))&&(o=p.parent())&&f[o.nodeName()]&&(o._4ePosition(n)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)===A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(o));)p=
o;D.setEndAfter(p)}}else m=B}else m=B;l=l._4eNextSourceNode()}if(m&&D&&!D.collapsed){for(var m=s(this,b,void 0),p=D.getCommonAncestor(),o={},q={},r,t=null,u;m&&p&&m[0]&&p[0];){if(p.nodeName()===c){for(r in d.attributes)if(!q[r]&&(u=p.attr(t)))m.attr(r)===u?m.removeAttr(r):q[r]=1;for(t in d.styles)if(!o[t]&&(u=p.style(t)))m.style(t)===u?m.style(t,""):o[t]=1;if(!m._4eHasAttributes()){m=G;break}}p=p.parent()}m?(m[0].appendChild(D.extractContents()),g(this,m),D.insertNode(m),m._4eMergeSiblings(),M.ie||
m[0].normalize()):(m=new k(b.createElement("span")),m[0].appendChild(D.extractContents()),D.insertNode(m),g(this,m),m._4eRemove(!0));D=G}}n._4eRemove();j._4eRemove();a.moveToBookmark(h);a.shrink(i.SHRINK_TEXT)}}function m(a){a.enlarge(i.ENLARGE_ELEMENT);var b=a.createBookmark(),d=b.startNode;if(a.collapsed){for(var e=new E(d.parent()),f,g=0,j;g<e.elements.length&&(j=e.elements[g])&&!(j===e.block||j===e.blockLimit);g++)if(this.checkElementRemovable(j)){var A=a.checkBoundaryOfElement(j,i.END),m=!A&&
a.checkBoundaryOfElement(j,i.START);m||A?(f=j,f.match=m?"start":"end"):(j._4eMergeSiblings(),j.nodeName()!==this.element?(A=l(this),h(j,A[j.nodeName()]||A["*"])):c(this,j))}if(f){j=d;for(g=0;;g++){A=e.elements[g];if(A.equals(f))break;else if(A.match)continue;else A=A.clone();A[0].appendChild(j[0]);j=A}j["start"===f.match?"insertBefore":"insertAfter"](f);e=f.html();!e||"\u200b"===e?f.remove():M.webkit&&I(a.document.createTextNode("\u200b")).insertBefore(j)}}else{var n=b.endNode,D=this;f=function(){for(var a=
new E(d.parent()),b=new E(n.parent()),c=G,i,e=G,f=0;f<a.elements.length;f++){i=a.elements[f];if(i===a.block||i===a.blockLimit)break;D.checkElementRemovable(i)&&(c=i)}for(f=0;f<b.elements.length;f++){i=b.elements[f];if(i===b.block||i===b.blockLimit)break;D.checkElementRemovable(i)&&(e=i)}e&&n._4eBreakParent(e);c&&d._4eBreakParent(c)};f();for(e=new k(d[0].nextSibling);e[0]!==n[0];){g=e._4eNextSourceNode();if(e[0]&&e[0].nodeType===F.NodeType.ELEMENT_NODE&&this.checkElementRemovable(e)&&(e.nodeName()===
this.element?c(this,e):(j=l(this),h(e,j[e.nodeName()]||j["*"])),g[0].nodeType===F.NodeType.ELEMENT_NODE&&g.contains(d)))f(),g=new k(d[0].nextSibling);e=g}}a.moveToBookmark(b)}function w(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function q(a,b){var c="";b!==J?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function l(b){if(b._.overrides)return b._.overrides;var c=b._.overrides={},d=b._.definition.overrides;if(d){a.isArray(d)||(d=[d]);for(var i=0;i<d.length;i++){var e=d[i],f,g,h;"string"===typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():b.element,g=e.attributes,h=e.styles);e=c[f]||(c[f]={});if(g){f=e.attributes=e.attributes||[];for(var j in g)f.push([j.toLowerCase(),g[j]])}if(h){var e=e.styles=e.styles||[],k;for(k in h)e.push([k.toLowerCase(),h[k]])}}}return c}function c(b,
c){var i=b._.definition,f=l(b),g=a.merge(i.attributes,(f[c.nodeName()]||f["*"]||{}).attributes),i=a.merge(i.styles,(f[c.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(g)&&a.isEmptyObject(i),h;for(h in g)("class"===h||b._.definition.fullMatch)&&c.attr(h)!==e(h,g[h])||(f=f||!!c.hasAttr(h),c.removeAttr(h));for(var j in i)b._.definition.fullMatch&&c.style(j)!==e(j,i[j],B)||(f=f||!!c.style(j),c.style(j,""));d(c)}function e(a,b,c){var d=new k("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}
function g(a,b){for(var d=l(a),i=b.all(a.element),e=i.length;0<=--e;)c(a,new k(i[e]));for(var f in d)if(f!==a.element){i=b.all(f);for(e=i.length-1;0<=e;e--){var g=new k(i[e]);h(g,d[f])}}}function h(a,b){var c,i,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0];if(i=a.attr(f)){var g=e[c][1];(g===G||g.test&&g.test(i)||"string"===typeof g&&i===g)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++)if(f=e[c][0],g=a.css(f)){var h=e[c][1];(h===G||h.test&&h.test(i)||"string"===typeof h&&
g===h)&&a.css(f,"")}d(a)}function d(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(B);b&&(b.nodeType===F.NodeType.ELEMENT_NODE&&F._4eMergeSiblings(b),c&&b!==c&&c.nodeType===F.NodeType.ELEMENT_NODE&&F._4eMergeSiblings(c))}}var k=b("node"),r=b("./selection"),z=b("./range"),y=b("./base"),E=b("./elementPath"),B=!0,J=!1,G=null,I=a.all,F=a.DOM,i=y.RangeType,A=y.PositionType,D,M=a.UA,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=y.XHTML_DTD,O={embed:1,hr:1,
img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;y.StyleType=D={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};t.prototype={constructor:t,apply:function(a){x.call(this,a,J)},remove:function(a){x.call(this,a,B)},applyToRange:function(a){return(this.applyToRange=this.type===D.STYLE_INLINE?n:this.type===D.STYLE_BLOCK?f:G).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===D.STYLE_INLINE?m:G).call(this,a)},checkElementRemovable:function(a,
b){if(!a)return J;var c,d=this._.definition,i;if(a.nodeName()===this.element){if(!b&&!a._4eHasAttributes())return B;var e=d._AC;if(!e){var e={},f=0,g=d.attributes;if(g)for(var h in g)f++,e[h]=g[h];if(g=t.getStyleText(d))e.style||f++,e.style=g;e._length=f;d._AC=e}d=e;if(d._length){for(c in d)if("_length"!==c){f=a.attr(c)||"";if("style"===c)a:{e=d[c];f=q(f,J);"string"===typeof e&&(e=w(e));"string"===f&&(f=w(f));g=void 0;for(g in e)if(!(g in f&&(f[g]===e[g]||"inherit"===e[g]||"inherit"===f[g]))){e=J;
break a}e=B}else e=d[c]===f;if(e){if(!b)return B}else if(b)return J}if(b)return B}else return B}c=l(this);if(c=c[a.nodeName()]||c["*"]){if(!(d=c.attributes)&&!(i=c.styles))return B;if(d)for(e=0;e<d.length;e++)if(c=d[e][0],c=a.attr(c))if(f=d[e][1],f===G||"string"===typeof f&&c===f||f.test&&f.test(c))return B;if(i)for(e=0;e<i.length;e++)if(c=a.css(i[e][0]))if(d=i[e][1],d===G||"string"===typeof d&&c===d||d.test&&d.test(c))return B}return J},checkActive:function(a){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,B);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type===D.STYLE_INLINE&&(F.equals(d,a.block)||F.equals(d,a.blockLimit))))if((this.type!==D.STYLE_OBJECT||d.nodeName()in O)&&this.checkElementRemovable(d,B))return B}return J}};t.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(P,";"));for(var e in b){var i=b[e],f=(e+":"+i).replace(P,";");"inherit"===i?
d+=f:c+=f}c.length&&(c=q(c));c+=d;return a._ST=c};return y.Style=t});
KISSY.add("editor/domIterator",["node","./walker","./range","./base","./elementPath"],function(a,b){function v(a){1>arguments.length||(this.range=a,this.forceBrBreak=u,this.enlargeBr=j,this.enforceRealBlocks=u,this._=this._||{})}var o=b("node"),t=b("./walker"),x=b("./range"),s=b("./base"),f=b("./elementPath"),j=!0,u=!1,p=a.UA,n=s.RangeType,m=a.DOM,w=/^[\r\n\t ]*$/;a.augment(v,{getNextParagraph:function(b){var l,c,e,g,h,d;if(!this._.lastNode){e=this.range.clone();e.shrink(n.SHRINK_ELEMENT,j);e.enlarge(this.forceBrBreak||
!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);c=new t(e);var k=t.bookmark(j,j);c.evaluator=k;this._.nextNode=c.next();c=new t(e);c.evaluator=k;c=c.previous();this._.lastNode=c._4eNextSourceNode(j);this._.lastNode&&this._.lastNode[0].nodeType===m.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()&&(k=new x(e.document),k.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),k.checkEndOfBlock()&&(k=new f(k.endContainer),this._.lastNode=
(k.block||k.blockLimit)._4eNextSourceNode(j)));this._.lastNode||(this._.lastNode=this._.docEndMarker=new o(e.document.createTextNode("")),m.insertAfter(this._.lastNode[0],c[0]));e=null}k=this._.nextNode;c=this._.lastNode;for(this._.nextNode=null;k;){var r=u,s=k[0].nodeType!==m.NodeType.ELEMENT_NODE,v=u;if(s)k[0].nodeType===m.NodeType.TEXT_NODE&&w.test(k[0].nodeValue)&&(s=u);else{var E=k.nodeName();if(k._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){if("br"===E)s=j;else if(!e&&!k[0].childNodes.length&&
"hr"!==E){l=k;g=k.equals(c);break}e&&(e.setEndAt(k,n.POSITION_BEFORE_START),"br"!==E&&(this._.nextNode=k));r=j}else{if(k[0].firstChild){e||(e=new x(this.range.document),e.setStartAt(k,n.POSITION_BEFORE_START));k=new o(k[0].firstChild);continue}s=j}}s&&!e&&(e=new x(this.range.document),e.setStartAt(k,n.POSITION_BEFORE_START));g=(!r||s)&&k.equals(c);if(e&&!r)for(;!k[0].nextSibling&&!g;){E=k.parent();if(E._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){r=j;g||E.equals(c);break}k=E;s=j;g=k.equals(c);v=
j}s&&e.setEndAt(k,n.POSITION_AFTER_END);k=k._4eNextSourceNode(v,null,c);if((g=!k)||r&&e)break}if(!l){if(!e)return this._.docEndMarker&&this._.docEndMarker._4eRemove(),this._.nextNode=null;l=new f(e.startContainer);k=l.blockLimit;r={div:1,th:1,td:1};l=l.block;if((!l||!l[0])&&!this.enforceRealBlocks&&r[k.nodeName()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())l=k;else if(!l||this.enforceRealBlocks&&"li"===l.nodeName())l=new o(this.range.document.createElement(b||"p")),l[0].appendChild(e.extractContents()),
l._4eTrim(),e.insertNode(l),h=d=j;else if("li"!==l.nodeName()){if(!e.checkStartOfBlock()||!e.checkEndOfBlock())l=l.clone(u),l[0].appendChild(e.extractContents()),l._4eTrim(),d=e.splitBlock(),h=!d.wasStartOfBlock,d=!d.wasEndOfBlock,e.insertNode(l)}else g||(this._.nextNode=l.equals(c)?null:e.getBoundaryNodes().endNode._4eNextSourceNode(j,null,c))}h&&(e=new o(l[0].previousSibling),e[0]&&e[0].nodeType===m.NodeType.ELEMENT_NODE&&("br"===e.nodeName()?e._4eRemove():e[0].lastChild&&"br"===m.nodeName(e[0].lastChild)&&
m._4eRemove(e[0].lastChild)));d&&(e=t.bookmark(u,j),h=new o(l[0].lastChild),h[0]&&h[0].nodeType===m.NodeType.ELEMENT_NODE&&"br"===h.nodeName()&&(p.ie||h.prev(e,1)||h.next(e,1))&&h.remove());this._.nextNode||(this._.nextNode=g||l.equals(c)?null:l._4eNextSourceNode(j,null,c));return l}});x.prototype.createIterator=function(){return new v(this)};return v});
KISSY.add("editor/z-index-manager",["./base"],function(a,b){var v=b("./base"),o=v.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(a){return(v.Config.baseZIndex||1E4)+a};return o});
KISSY.add("editor","node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta,editor/styles,editor/domIterator,editor/z-index-manager".split(","),function(a,b,v,o){function t(a,b){var c=a.body;J(function(){a.designMode="on";setTimeout(function N(){a.designMode="off";c.focus();if(!N.retry)N.retry=h},50)},function(){a.designMode="off";c.setAttribute("contentEditable",false);c.setAttribute("contentEditable",
true);b||t(a,1)})}function x(b){var c=b.get("textarea")[0],e=b.get("window"),f=b.get("document"),g=f[0];if(z.webkit){f.on("click",function(b){var c=new p(b.target);a.inArray(c.nodeName(),["input","select"])&&b.preventDefault()});f.on("mouseup",function(b){var c=new p(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()})}if(z.gecko||z.ie||z.opera){var h;h=(new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);h.on("focus",
function(){b.focus()});b.activateGecko=function(){z.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}e.on("focus",function(){z.gecko?t(g,d):z.opera&&g.body.focus();b.notifySelectionChange()});if(z.gecko)f.on("mousedown",function(){b.__iframeFocus||t(g,d)});if(y){f.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);
b.execCommand("save");a.preventDefault()}}});if(g.compatMode==="CSS1Compat"){var j={33:1,34:1};f.on("keydown",function(a){a.keyCode in j&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}if(z.webkit)f.on("mousedown",function(c){c=new p(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(z.gecko)f.on("dragstart",function(a){var b=new p(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});q.add(b)}
function s(b,c,d,e){var f="",g;g=w.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(g);for(g=0;g<d.length;g++)f=f+a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[g]});return a.substitute(n,{doctype:a.UA.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:f,style:"<style>"+c+"</style>",data:e||"",script:b?'<script id="ke_active_script">'+(B(k).isCustomDomain()?'document.domain="'+r.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+
b+'");<\/script>':""})}function f(a,b){function c(){h=g.document;a.setInternal("document",new p(h));a.setInternal("window",new p(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=s(a.get("id"),a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(j){f.src=f.src;if(y<7){setTimeout(c,10);return}}c()}function j(b,c){var d=B(k).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new p(a.substitute(G,{iframeSrc:d,
prefixCls:b.get("prefixCls")})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",z.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(z.gecko&&!d.__loaded)d.on("load",function(){f(b,c)},b);else f(b,c)}function u(b){if(b.get("iframe")){var c=b.get("iframe"),d=b.get("window"),b=b.get("document"),e=b[0],f=B(e.documentElement),e=B(e.body);a.each([b,f,e,d],function(a){a.detach()});c.remove()}}var p=b("node"),n=b("editor/iframe-content-tpl"),m=b("editor/base"),
w=b("editor/utils"),q=b("editor/focusManager"),l=b("editor/clipboard"),c=b("editor/enterKey"),e=b("editor/htmlDataProcessor"),g=b("editor/selectionFix");b("editor/plugin-meta");b("editor/styles");b("editor/domIterator");b("editor/z-index-manager");o.exports=m;var h=true,d=false,k=a.Env.host,r=k.document,z=a.UA,y=z.ieMode<11,E=p.NodeType,B=p.all,J=w.tryThese,G='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',I=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;
m.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};m.addMembers({initializer:function(){this.__commands={};this.__controls={};q.register(this)},renderUI:function(){l.init(this);c.init(this);e.init(this);g.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=B(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+
"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");if(a===1){this.setData(c.val());c.hide();this.fire("wysiwygMode")}else{if(b){c.val(this.getFormatData(1));b.hide()}c.show();this.fire("sourceMode")}},
_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var b,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(b=c[0].form)&&(b=B(b))&&b.detach("submit",this.sync,this);if(d){b=B(d[0].body);var c=B(d[0].documentElement),e=this.get("window");q.remove(this);d.detach();c.detach();b.detach();e.detach()}a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},sync:function(){this.get("textarea").val(this.getData())},
getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],d=a.makeArray(arguments);d.shift();d.unshift(this);if(c)return c.exec.apply(c,
d);b+": command not found"},queryCommandValue:function(a){return this.execCommand(w.getQueryCmd(a))},setData:function(a){var b,c=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);u(this);j(this,c)}},getData:function(b,c){var d=this.htmlDataProcessor,e;c===void 0&&(c=this.get("mode"));e=c===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=b?d.toHtml(e):d.toServer(e);e=a.trim(e);I.test(e)&&
(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return s(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return m.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b="";if(a){a=a.cloneContents();b=this.get("document")[0].createElement("div");b.appendChild(a);b=b.innerHTML}return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],
a=a[0];z.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);
this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(b){this.get("document").all("link").each(function(a){a.attr("href")===b&&a.remove()});var c=this.get("customLink"),d=a.indexOf(b,c);d!==-1&&c.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&
clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new m.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d)){a.__previousPath=d;a.fire("selectionChange",{selection:b,path:d,element:c})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var b,c=a.nodeName(),d=m.XHTML_DTD,
e=d.$block[c],f=m.RangeType,g=(c=this.getSelection())&&c.getRanges(),j,k,l;if(g&&g.length!==0){this.execCommand("save");for(k=g.length-1;k>=0;k--){j=g[k];b=!k&&a||a.clone(h);j.insertNodeByDtd(b);l||(l=b)}if(l){j.moveToPosition(l,f.POSITION_AFTER_END);if(e){a=m.Walker.whitespaces(true);(a=(l=l.next(a,1))&&l[0].nodeType===E.ELEMENT_NODE&&l.nodeName())&&d.$block[a]&&d[a]["#text"]&&j.moveToElementEditablePosition(l)}c.selectRanges([j]);this.focus();b&&b[0].nodeType===1&&b.scrollIntoView(void 0,{alignWithTop:false,
allowHorizontalScroll:true,onlyScrollIfNeeded:true});F.call(this);return b}}}},insertHtml:function(a,b){var c=this,d,e=c.get("document")[0];if(c.get("mode")===1){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,b);c.focus();c.execCommand("save");if(d=e.selection){d.type==="Control"&&d.clear();try{d.createRange().pasteHTML(a)}catch(f){"insertHtml error in ie"}}else{d=c.get("iframe")[0].contentWindow.getSelection();var g=d.getRangeAt(0);g.deleteContents();var h=e.createElement("div");h.innerHTML=a;for(var e=
e.createDocumentFragment(),j,k;j=h.firstChild;)k=e.appendChild(j);g.insertNode(e);if(k){g=g.cloneRange();g.setStartAfter(k);g.collapse(true);d.removeAllRanges();d.addRange(g)}}setTimeout(function(){c.getSelection().scrollIntoView()},50);F.call(c)}}});m.decorate=function(a,b){var b=b||{},a=B(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");if(d)b.width=b.width||d;if(e)b.height=b.height||e;if(f)c.name=f;b.data=b.data||a.val();b.elBefore=a;c=(new m(b)).render();
a.remove();return c};m._initIframe=function(a){var b=q.getInstance(a),a=b.get("document"),c=a[0];a.one("#ke_active_script").remove();x(b);var e=c.body,f=B(e);if(y){e.hideFocus=h;e.disabled=h;e.contentEditable=h;e.removeAttribute("disabled")}else setTimeout(function(){z.gecko||z.opera?e.contentEditable=h:z.webkit?e.parentNode.contentEditable=h:c.designMode="on"},0);if(z.gecko||z.opera){var g=c.documentElement;B(g).on("mousedown",function(a){if(a.target===g){z.gecko&&t(c,d);b.activateGecko()}})}setTimeout(function(){y&&
setTimeout(function(){if(c){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",d,!a);c.execCommand("enableInlineTableEditing",d,!e)}catch(g){f.on(y?"resizestart":"resize",function(b){var c=new p(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};var F=a.buffer(function(){this.execCommand("save")},
50)});
