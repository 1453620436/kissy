/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 27 00:07
*/
KISSY.add("editor/iframe-content-tpl",[],'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>');
KISSY.add("editor/render-xtpl",[],function(){return function(a,d,u){var s=this,d=this.config.utils,t=d.runBlockCommand,x=d.getExpression,r=d.getPropertyOrRunCommand,d='<div class="',n=r(s,a,{},"prefixCls",0,1,u,!1),d=d+x(n,!0),d=d+'editor-tools"\n     id="ks-editor-tools-',n=r(s,a,{},"id",0,2,u,!1),d=d+x(n,!0),d=d+'">\n\n</div>\n\n<\!--\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\n--\>\n\n<div class="',n=r(s,a,{},"prefixCls",0,11,u,!1),d=d+x(n,!0),d=d+'editor-textarea-wrap"\n\n',
n={},i=[],v=r(s,a,{},"mobile",0,13,u,!0);i.push(v);n.params=i;n.fn=function(){return'\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\n'};d+=t(s,a,n,"if",13);d+='\n\nid="ks-editor-textarea-wrap-';n=r(s,a,{},"id",0,17,u,!1);d+=x(n,!0);d+='"\n>\n\n<textarea\n        id="ks-editor-textarea-';n=r(s,a,{},"id",0,21,u,!1);d+=x(n,!0);d+='"\n        class="';n=r(s,a,{},"prefixCls",0,22,u,!1);d+=x(n,!0);d+='editor-textarea"\n\n';n={};i=[];v=r(s,a,{},"textareaAttrs",0,24,u,!0);i.push(v);n.params=
i;n.fn=function(a){var i;i="\n";var n=r(s,a,{},"xindex",0,25,u,!1);i+=x(n,!0);i+='="';a=r(s,a,{},".",0,25,u,!1);i+=x(a,!0);return i+'"\n'};d+=t(s,a,n,"each",24);d+="\n\n";n={};i=[];v=r(s,a,{},"mode",0,28,u,!0);i.push(v);n.params=i;n.fn=function(){return'\nstyle="display:none"\n'};d+=t(s,a,n,"if",28);d+="\n\n>";t=r(s,a,{},"data",0,32,u,!1);d+=x(t,!0);d+='</textarea>\n\n</div>\n\n<div class="';t=r(s,a,{},"prefixCls",0,36,u,!1);d+=x(t,!0);d+='editor-status"\n     id="ks-editor-status-';a=r(s,a,{},"id",
0,37,u,!1);d+=x(a,!0);return d+'">\n\n</div>'}});KISSY.add("editor/render",["component/control","./render-xtpl"],function(a,d){var u=d("component/control"),s=d("./render-xtpl");return u.getDefaultRender().extend({beforeCreateDom:function(d,s){a.mix(d,{mobile:a.UA.mobile});a.mix(s,{textarea:"#ks-editor-textarea-{id}",toolBarEl:"#ks-editor-tools-{id}",statusBarEl:"#ks-editor-status-{id}"})}},{ATTRS:{contentTpl:{value:s}}})});
KISSY.add("editor/base",["html-parser","component/control","./render"],function(a,d){var u=d("html-parser"),s=d("component/control"),t=d("./render");return s.extend({},{Config:{},XHTML_DTD:u.DTD,ATTRS:{textarea:{},textareaAttrs:{view:1},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{view:1,value:1},data:{view:1},customStyle:{value:""},customLink:{value:[]},xrender:{value:t}},xclass:"editor"})});
KISSY.add("editor/utils",["node","./base"],function(a,d){var u=d("node"),s=d("./base"),t=a.DOM,x=a.UA,r={debugUrl:function(n){var i=a.Config;i.debug||(n=n.replace(/\.(js|css)/i,"-min.$1"));-1==n.indexOf("?t")&&(n=-1!=n.indexOf("?")?n+"&":n+"?",n+="t="+encodeURIComponent(i.tag));return i.base+"editor/"+n},lazyRun:function(a,i,d){var p=a[i],q=a[d];a[i]=function(){p.apply(this,arguments);a[i]=a[d];return q.apply(this,arguments)}},getXY:function(a,i){var d=a.left,p=a.top,q=i.get("window")[0],d=d-t.scrollLeft(q),
p=p-t.scrollTop(q),q=i.get("iframe").offset(),d=d+q.left,p=p+q.top;return{left:d,top:p}},tryThese:function(a){for(var i,d=0,p=arguments.length;d<p;d++){var q=arguments[d];try{i=q();break}catch(o){}}return i},clearAllMarkers:function(a){for(var i in a)a[i]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(d){return/^\d+(.\d+)?$/.test(a.trim(d))},verifyInputs:function(d){for(var i=0;i<d.length;i++){var v=new u(d[i]),
p=a.trim(r.valInput(v)),q=v.attr("data-verify"),v=v.attr("data-warning");if(q&&!RegExp(q).test(p))return alert(v),!1}return!0},sourceDisable:function(a,i){a.on("sourceMode",i.disable,i);a.on("wysiwygMode",i.enable,i)},resetInput:function(a){var i=a.attr("placeholder");i&&x.ie?(a.addClass("ks-editor-input-tip"),a.val(i)):x.ie||a.val("")},valInput:function(a,i){if(void 0===i)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(i)},placeholder:function(d,i){d.attr("placeholder",
i);x.ie&&(d.on("blur",function(){a.trim(d.val())||(d.addClass("ks-editor-input-tip"),d.val(i))}),d.on("focus",function(){d.removeClass("ks-editor-input-tip");a.trim(d.val())==i&&d.val("")}))},normParams:function(d){var d=a.clone(d),i;for(i in d){var v=d[i];"function"===typeof v&&(d[i]=v())}return d},preventFocus:function(a){x.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(d){a.mix(t,d);for(var i in d)(function(i){u.prototype[i]=function(){var p=[].slice.call(arguments,
0);p.unshift(this[0]);return(p=d[i].apply(null,p))&&(p.nodeType||a.isWindow(p))?new u(p):a.isArray(p)&&(p.__IS_NODELIST||p[0]&&p[0].nodeType)?new u(p):p}})(i)},addRes:function(){var d=this.__res=this.__res||[];d.push.apply(d,a.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],i=0;i<a.length;i++){var d=a[i];"function"===typeof d?d():d.destroy?d.destroy():d.remove&&d.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,d){return d.toUpperCase()})+
"Value"}};return s.Utils=r});
KISSY.add("editor/focusManager",["./base"],function(a,d){function u(){var a=this;a.__iframeFocus=v;n=a;r&&clearTimeout(r);r=setTimeout(function(){a.fire("focus")},30)}function s(){var a=this;a.__iframeFocus=p;n=q;r&&clearTimeout(r);r=setTimeout(function(){a.fire("blur")},30)}var t=d("./base"),x={},r,n,i={currentInstance:function(){return n},getInstance:function(a){return x[a]},register:function(a){x[a.get("id")]=a},add:function(a){this.register(a);a.get("window").on("focus",u,a).on("blur",s,a)},remove:function(a){delete x[a.get("id")];
a.get("window").detach("focus",u,a).detach("blur",s,a)}},v=!0,p=!1,q=null;t.focusManager=i;t.getInstances=function(){return x};return i});
KISSY.add("editor/dom",["node","./base","./utils"],function(a,d){function u(h,a){var e=h[a?"next":"prev"](r,1);if(e&&e[0].nodeType==v.ELEMENT_NODE){for(var f=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemovable(r);)if(f.push(e),e=a?e.next(r,1):e.prev(r,1),!e)return;if(h._4e_isIdentical(e,r)){for(var c=new s(a?h[0].lastChild:h[0].firstChild);f.length;)f.shift()._4e_move(h,!a,r);e._4e_moveChildren(h,!a,r);e.remove();c[0]&&c[0].nodeType==v.ELEMENT_NODE&&c._4e_mergeSiblings()}}}var s=d("node"),t=d("./base"),
x=d("./utils"),r=r,n=t.XHTML_DTD,i=a.DOM,v=i.NodeType,p=a.UA,q={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};t.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var o=t.PositionType,w={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,
"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},m={hr:1},l=function(h){return h&&(h[0]||h)};x.injectDom({_4e_sameLevel:function(h,a){var a=l(a),e=h.parentNode;return e&&e==a.parentNode},_4e_isBlockBoundary:function(h,j){var e=a.merge(m,j);return!(!w[i.css(h,"display")]&&!e[i.nodeName(h)])},_4e_index:function(h,a){for(var e=h.parentNode.childNodes,f,c=-1,b=0;b<e.length;b++)if(f=e[b],!a||!(3==f.nodeType&&f.previousSibling&&3==f.previousSibling.nodeType))if(c++,
f===h)return c;return-1},_4e_move:function(h,a,e){a=l(a);e?a.insertBefore(h,a.firstChild):a.appendChild(h)},_4e_isIdentical:function(h,a){if(!a)return!1;a=l(a);if(i.nodeName(h)!=i.nodeName(a))return!1;var e=h.attributes,f=a.attributes,c=e.length,b=f.length;if(c!=b)return!1;for(var g=0;g<c;g++){var k=e[g],d=k.name;if(k.specified&&i.attr(h,d)!=i.attr(a,d))return!1}if(8>p.ieMode)for(g=0;g<b;g++)if(k=f[g],d=k.name,k.specified&&i.attr(h,d)!=i.attr(a,d))return!1;return!0},_4e_isEmptyInlineRemovable:function(h){if(!n.$removeEmpty[i.nodeName(h)])return!1;
for(var h=h.childNodes,j=0,e=h.length;j<e;j++){var f=h[j],c=f.nodeType;if(!(c==v.ELEMENT_NODE&&f.getAttribute("_ke_bookmark"))&&(c==v.ELEMENT_NODE&&!i._4e_isEmptyInlineRemovable(f)||c==i.NodeType.TEXT_NODE&&a.trim(f.nodeValue)))return!1}return!0},_4e_moveChildren:function(h,a,e){a=l(a);if(h!=a)if(e)for(;e=h.lastChild;)a.insertBefore(h.removeChild(e),a.firstChild);else for(;e=h.firstChild;)a.appendChild(h.removeChild(e))},_4e_mergeSiblings:function(a){a=new s(a);q[a.nodeName()]&&(u(a,!0),u(a))},_4e_splitText:function(a,
j){var e=a.ownerDocument;if(a.nodeType==i.NodeType.TEXT_NODE){if(p.ie&&j==a.nodeValue.length){var f=e.createTextNode("");i.insertAfter(f,a);return f}f=a.splitText(j);e.documentMode&&(e=e.createTextNode(""),i.insertAfter(e,f),i.remove(e));return f}},_4e_parents:function(a,j){var e=[];e.__IS_NODELIST=1;do e[j?"push":"unshift"](a);while(a=a.parentNode);return e},_4e_nextSourceNode:function(a,j,e,f){if(f&&!f.call)var c=l(f),f=function(a){return a!==c};var j=!j&&a.firstChild,b=a;if(!j){if(a.nodeType==
v.ELEMENT_NODE&&f&&!1===f(a,!0))return null;j=a.nextSibling}for(;!j&&(b=b.parentNode);){if(f&&!1===f(b,!0))return null;j=b.nextSibling}return!j||f&&!1===f(j)?null:e&&e!=j.nodeType?i._4e_nextSourceNode(j,!1,e,f):j},_4e_previousSourceNode:function(a,j,e,f){if(f&&!f.call)var c=l(f),f=function(a){return a!==c};var j=!j&&a.lastChild,b=a;if(!j){if(a.nodeType==v.ELEMENT_NODE&&f&&!1===f(a,!0))return null;j=a.previousSibling}for(;!j&&(b=b.parentNode);){if(f&&!1===f(b,!0))return null;j=b.previousSibling}return!j||
f&&!1===f(j)?null:e&&j.nodeType!=e?i._4e_previousSourceNode(j,!1,e,f):j},_4e_commonAncestor:function(a,j){j=l(j);if(a===j)return a;if(i.contains(j,a))return j;var e=a;do if(i.contains(e,j))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>p.ieMode?function(a){for(var j=a.attributes,e=0;e<j.length;e++){var f=j[e];switch(f.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(f.specified)return!0}}return!1}:function(a){p.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,j){var e=l(j);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return o.POSITION_IDENTICAL;if(a.nodeType==v.ELEMENT_NODE&&e.nodeType==v.ELEMENT_NODE){if(i.contains(a,e))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(i.contains(e,a))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?o.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var f=
i._4e_address(a),e=i._4e_address(e),c=Math.min(f.length,e.length),b=0;b<=c-1;b++)if(f[b]!=e[b])return f[b]<e[b]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return f.length<e.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(a,j){for(var e=[],f=a.ownerDocument.documentElement,c=a;c&&c!=f;)e.unshift(i._4e_index(c,j)),c=c.parentNode;return e},_4e_remove:function(a,j){var e=a.parentNode;if(e){if(j)for(var f;f=a.firstChild;)e.insertBefore(a.removeChild(f),
a);e.removeChild(a)}return a},_4e_trim:function(a){i._4e_ltrim(a);i._4e_rtrim(a)},_4e_ltrim:function(a){for(var j;j=a.firstChild;){if(j.nodeType==i.NodeType.TEXT_NODE){var e=x.ltrim(j.nodeValue),f=j.nodeValue.length;if(e)e.length<f&&(i._4e_splitText(j,f-e.length),a.removeChild(a.firstChild));else{a.removeChild(j);continue}}break}},_4e_rtrim:function(a){for(var j;j=a.lastChild;){if(j.type==i.NodeType.TEXT_NODE){var e=x.rtrim(j.nodeValue),f=j.nodeValue.length;if(e)e.length<f&&(i._4e_splitText(j,e.length),
a.removeChild(a.lastChild));else{a.removeChild(j);continue}}break}!p.ie&&!p.opera&&(j=a.lastChild)&&1==j.nodeType&&"br"==i.nodeName(j)&&a.removeChild(j)},_4e_appendBogus:function(h){for(var j=h.lastChild;j&&j.nodeType==i.NodeType.TEXT_NODE&&!a.trim(j.nodeValue);)j=j.previousSibling;if(!j||j.nodeType==i.NodeType.TEXT_NODE||"br"!==i.nodeName(j))j=p.opera?h.ownerDocument.createTextNode(""):h.ownerDocument.createElement("br"),h.appendChild(j)},_4e_setMarker:function(h,j,e,f){var h=new s(h),c=h.data("list_marker_id")||
h.data("list_marker_id",a.guid()).data("list_marker_id"),b=h.data("list_marker_names")||h.data("list_marker_names",{}).data("list_marker_names");j[c]=h;b[e]=1;return h.data(e,f)},_4e_clearMarkers:function(a,j,e){var a=new s(a),f=a.data("list_marker_names"),c=a.data("list_marker_id"),b;for(b in f)a.removeData(b);a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete j[c])},_4e_copyAttributes:function(a,j,e){for(var j=new s(j),f=a.attributes,e=e||{},c=0;c<f.length;c++){var b=f[c],
g=b.name.toLowerCase(),k;if(!(g in e))if("checked"==g&&(k=i.attr(a,g)))j.attr(g,k);else if(b.specified||p.ie&&b.value&&"value"==g)k=i.attr(a,g),null===k&&(k=b.nodeValue),j.attr(g,k)}""!==a.style.cssText&&(j[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=i.nodeName(a);return(a=!n.$nonEditable[a]&&(n[a]||n.span))&&a["#text"]},_4e_getByAddress:function(a,j,e){for(var a=a.documentElement,f=0;a&&f<j.length;f++){var c=j[f];if(e)for(var b=-1,g=0;g<a.childNodes.length;g++){var k=a.childNodes[g];
if(!(!0===e&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(b++,b==c)){a=k;break}}else a=a.childNodes[c]}return a}})});
KISSY.add("editor/walker",["./base","node"],function(a,d){function u(a,e){if(this._.end)return i;var f,c=this.range,b,g=this.guard,k=this.type,h=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,c.trim(),c.collapsed))return this.end(),i;if(!a&&!this._.guardLTR){var d=c.endContainer[0],m=d.childNodes[c.endOffset];this._.guardLTR=function(a,c){return c&&(d==a||"body"==p.nodeName(a))?!1:a!=m}}if(a&&!this._.guardRTL){var l=c.startContainer[0],q=0<c.startOffset&&l.childNodes[c.startOffset-
1]||null;this._.guardRTL=function(a,c){return c&&(l==a||"body"==p.nodeName(a))?!1:a!=q}}var L=a?this._.guardRTL:this._.guardLTR;b=g?function(a,c){return L(a,c)===n?n:g(a,c)}:L;this.current?f=this.current[h](n,k,b):a?(f=c.endContainer,0<c.endOffset?(f=new o(f[0].childNodes[c.endOffset-1]),b(f[0])===n&&(f=i)):f=b(f,r)===n?i:f._4e_previousSourceNode(r,k,b,void 0)):(f=c.startContainer,f=new o(f[0].childNodes[c.startOffset]),f.length?b(f[0])===n&&(f=i):f=b(c.startContainer,r)===n?i:c.startContainer._4e_nextSourceNode(r,
k,b,void 0));for(;f&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f[0])!==n){if(!e)return f}else if(e&&this.evaluator)return n;f=f[h](n,k,b)}this.end();return this.current=i}function s(a){for(var e,f=i;e=u.call(this,a);)f=e;return f}function t(a){this.range=a;this.guard=this.evaluator=i;this._={}}var x=d("./base"),r=!0,n=!1,i=null,v=a.UA,p=a.DOM,q=x.XHTML_DTD,o=d("node");a.augment(t,{end:function(){this._.end=1},next:function(){return u.call(this)},previous:function(){return u.call(this,
r)},checkForward:function(){return u.call(this,n,r)!==n},checkBackward:function(){return u.call(this,r,r)!==n},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,r)},reset:function(){delete this.current;this._={}},_iterator:u});a.mix(t,{blockBoundary:function(a){return function(e){return!(e.nodeType==p.NodeType.ELEMENT_NODE&&p._4e_isBlockBoundary(e,a))}},bookmark:function(a,e){function f(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(c){var b,
g;b=c.nodeType==p.NodeType.TEXT_NODE&&(g=c.parentNode)&&f(g);b=a?b:b||f(c);return!!(e^b)}},whitespaces:function(h){return function(e){e=e.nodeType==p.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);return!!(h^e)}},invisible:function(a){var e=t.whitespaces();return function(f){f=e(f)||f.nodeType==p.NodeType.ELEMENT_NODE&&!f.offsetHeight;return!!(a^f)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,m=t.whitespaces(),l=t.bookmark(),h=function(a){var e=p.nodeName(a);return l(a)||m(a)||1==a.nodeType&&e in q.$inline&&
!(e in q.$empty)};x.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=a._4e_previousSourceNode();while(a&&h(a[0]));return a&&(!v.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return x.Walker=t});
KISSY.add("editor/elementPath",["node","./base","./dom"],function(a,d){function u(a){for(var d=r,q=r,o=[];a;){if(a[0].nodeType==t.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var s=a.nodeName();if(!q&&(!d&&n[s]&&(d=a),i[s])){var m;if(m=!d)if(m="div"==s){a:{m=a[0].childNodes;for(var l=0,h=m.length;l<h;l++){var j=m[l];if(j.nodeType==t.NodeType.ELEMENT_NODE&&x.$block[j.nodeName.toLowerCase()]){m=!0;break a}}m=!1}m=!m}m?d=a:q=a}o.push(a);if("body"==s)break}a=a.parent()}this.block=d;this.blockLimit=
q;this.elements=o}d("node");var s=d("./base");d("./dom");var t=a.DOM,x=s.XHTML_DTD,r=null,n={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};u.prototype={constructor:u,compare:function(a){var d=this.elements,a=a&&a.elements;if(!a||d.length!=a.length)return!1;for(var i=0;i<d.length;i++)if(!t.equals(d[i],a[i]))return!1;return!0},contains:function(a){for(var d=this.elements,i=0;i<d.length;i++)if(d[i].nodeName()in
a)return d[i];return r},toString:function(){var a=this.elements,d,i=[];for(d=0;d<a.length;d++)i.push(a[d].nodeName());return i.toString()}};return s.ElementPath=u});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./elementPath".split(","),function(a,d){function u(b){var g=b.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(b)in c.$removeEmpty,f=b.nodeType==e.NodeType.TEXT_NODE&&!a.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return g||f||b}function s(a){return!y(a)&&!B(a)}function t(c){var b=m;return function(g){if(B(g))return w;if(g.nodeType==e.NodeType.TEXT_NODE){if(a.trim(g.nodeValue).length)return m}else if(g.nodeType==e.NodeType.ELEMENT_NODE){g=
e.nodeName(g);if(!F[g])if(!c&&!f.ie&&g=="br"&&!b)b=w;else return m}return w}}function x(a,c){var b=a.startContainer,f=a.endContainer,k=a.startOffset,d=a.endOffset,h,j=m,y=m,l=void 0,B=a.document,Q;c>0&&(l=B.createDocumentFragment());if(a.collapsed)return l;a.optimizeBookmark();if(f[0].nodeType==e.NodeType.TEXT_NODE){y=w;f=f._4e_splitText(d)}else if(f[0].childNodes.length>0)if(d>=f[0].childNodes.length){f=new i(f[0].appendChild(B.createTextNode("")));Q=w}else f=new i(f[0].childNodes[d]);if(b[0].nodeType==
e.NodeType.TEXT_NODE){j=w;b._4e_splitText(k)}else if(k)if(k>=b[0].childNodes.length){b=new i(b[0].appendChild(B.createTextNode("")));h=w}else b=new i(b[0].childNodes[k].previousSibling);else{h=new i(B.createTextNode(""));b.prepend(h);b=h;h=w}var o=b._4e_parents(),J=f._4e_parents();o.each(function(a,c){o[c]=a});J.each(function(a,c){J[c]=a});for(var D,N,B=0;B<o.length;B++){D=o[B];N=J[B];if(!D.equals(N))break}for(var k=l,A,q,z=B;z<o.length;z++){A=o[z];d=c>0&&!A.equals(b)?k.appendChild(A.clone()[0]):
null;A=A[0].nextSibling;q=J[z];for(var p=f[0],r=q&&q[0];A;){if(r==A||p==A)break;q=A.nextSibling;if(c==2)k.appendChild(A.cloneNode(w));else{if(g[A.nodeName.toLowerCase()]){var n=A.cloneNode(w);A.innerHTML="";A=n}else e._4e_remove(A);c==1&&k.appendChild(A)}A=q}d&&(k=d)}for(k=l;B<J.length;B++){A=J[B];d=c>0&&!A.equals(f)?k.appendChild(A.clone()[0]):null;if(!o[B]||!A._4e_sameLevel(o[B]))for(A=A[0].previousSibling;A;){q=A.previousSibling;if(c==2)k.insertBefore(A.cloneNode(w),k.firstChild);else{e._4e_remove(A);
c==1&&k.insertBefore(A,k.firstChild)}A=q}d&&(k=d)}if(c==2){if(j){D=b[0];if(D.nodeType==e.NodeType.TEXT_NODE&&D.nextSibling&&D.nextSibling.nodeType==e.NodeType.TEXT_NODE){D.data=D.data+D.nextSibling.data;D.parentNode.removeChild(D.nextSibling)}}if(y){y=f[0];if(y.nodeType==e.NodeType.TEXT_NODE&&y.previousSibling&&y.previousSibling.nodeType==e.NodeType.TEXT_NODE){y.previousSibling.data=y.previousSibling.data+y.data;y.parentNode.removeChild(y)}}}else{if(D&&N&&(!b._4e_sameLevel(D)||!f._4e_sameLevel(N))){y=
D._4e_index();h&&D._4e_sameLevel(b)&&y--;a.setStart(D.parent(),y+1)}a.collapse(w)}h&&b.remove();Q&&f.remove();return l}function r(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function n(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=l;this.collapsed=w;this.document=a}d("./dom");var i=d("node"),v=d("./utils"),p=d("./walker"),q=d("./base"),o=d("./elementPath");q.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var w=true,m=false,l=null,h=q.RangeType,j=q.PositionType,e=a.DOM,f=a.UA,c=q.XHTML_DTD,b=i.all,g={td:1},k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new p.whitespaces,B=new p.bookmark,z=p.whitespaces(w),H=p.bookmark(false,true),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,
label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(n,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,c=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;
a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&a.nodeName()=="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);c&&c.nodeName()=="span"&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(a,c){if(a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]){a=a.parent();c=a._4e_index()}this.startContainer=a;this.startOffset=c;if(!this.endContainer){this.endContainer=a;this.endOffset=c}r(this)},setEnd:function(a,c){if(a[0].nodeType==e.NodeType.ELEMENT_NODE&&k[a.nodeName()]){a=a.parent();c=a._4e_index()+1}this.endContainer=a;this.endOffset=c;if(!this.startContainer){this.startContainer=
a;this.startOffset=c}r(this)},setStartAt:function(a,c){switch(c){case h.POSITION_AFTER_START:this.setStart(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setStartBefore(a);break;case h.POSITION_AFTER_END:this.setStartAfter(a)}r(this)},setEndAt:function(a,c){switch(c){case h.POSITION_AFTER_START:this.setEnd(a,0);break;case h.POSITION_BEFORE_END:a[0].nodeType==
e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(a);break;case h.POSITION_AFTER_END:this.setEndAfter(a)}r(this)},cloneContents:function(){return x(this,2)},deleteContents:function(){return x(this,0)},extractContents:function(){return x(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=w},clone:function(){var a=new n(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return l;var c=new p(a);c.evaluator=function(a){return z(a)&&H(a)};a=c.next();c.reset();c=
c.previous();return a&&a.equals(c)?a:l},shrink:function(a,c){if(!this.collapsed){var a=a||h.SHRINK_TEXT,b=this.clone(),g=this.startContainer,f=this.endContainer,k=this.startOffset,d=this.endOffset,i=w,y,j,l=w;if(g&&g[0].nodeType==e.NodeType.TEXT_NODE)if(k)if(k>=g[0].nodeValue.length)b.setStartAfter(g);else{b.setStartBefore(g);i=m}else b.setStartBefore(g);if(f&&f[0].nodeType==e.NodeType.TEXT_NODE)if(d)if(d>=f[0].nodeValue.length)b.setEndAfter(f);else{b.setEndAfter(f);l=m}else b.setEndBefore(f);if(i||
l){j=new p(b);j.evaluator=function(c){return c.nodeType==(a==h.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)};j.guard=function(c,b){if(a==h.SHRINK_ELEMENT&&c.nodeType==e.NodeType.TEXT_NODE||b&&c==y)return m;!b&&c.nodeType==e.NodeType.ELEMENT_NODE&&(y=c);return w}}if(i)(b=j[a==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(b,c?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);if(l){j.reset();(j=j[a==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,c?h.POSITION_BEFORE_END:
h.POSITION_AFTER_END)}return i||l}},createBookmark2:function(a){var c=this.startContainer,b=this.endContainer,g=this.startOffset,f=this.endOffset,k,d;if(!c||!b)return{start:0,end:0};if(a){if(c[0].nodeType==e.NodeType.ELEMENT_NODE)if((k=new i(c[0].childNodes[g]))&&k[0]&&k[0].nodeType==e.NodeType.TEXT_NODE&&g>0&&k[0].previousSibling.nodeType==e.NodeType.TEXT_NODE){c=k;g=0}for(;c[0].nodeType==e.NodeType.TEXT_NODE&&(d=c.prev(void 0,1))&&d[0].nodeType==e.NodeType.TEXT_NODE;){c=d;g=g+d[0].nodeValue.length}if(!this.collapsed){if(b[0].nodeType==
e.NodeType.ELEMENT_NODE)if((k=new i(b[0].childNodes[f]))&&k[0]&&k[0].nodeType==e.NodeType.TEXT_NODE&&f>0&&k[0].previousSibling.nodeType==e.NodeType.TEXT_NODE){b=k;f=0}for(;b[0].nodeType==e.NodeType.TEXT_NODE&&(d=b.prev(void 0,1))&&d[0].nodeType==e.NodeType.TEXT_NODE;){b=d;f=f+d[0].nodeValue.length}}}return{start:c._4e_address(a),end:this.collapsed?l:b._4e_address(a),startOffset:g,endOffset:f,normalized:a,is2:w}},createBookmark:function(c){var b,g,f,e,k=this.collapsed;b=new i("<span>",l,this.document);
b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");if(c){f=a.guid("ke_bm_");b.attr("id",f+"S")}if(!k){g=b.clone();g.html("&nbsp;");c&&g.attr("id",f+"E");e=this.clone();e.collapse();e.insertNode(g)}e=this.clone();e.collapse(w);e.insertNode(b);if(g){this.setStartAfter(b);this.setEndBefore(g)}else this.moveToPosition(b,h.POSITION_AFTER_END);return{startNode:c?f+"S":b,endNode:c?f+"E":g,serializable:c,collapsed:k}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(w)},trim:function(a,
c){var b=this.startContainer,g=this.startOffset,f=this.collapsed;if((!a||f)&&b[0]&&b[0].nodeType==e.NodeType.TEXT_NODE){if(g)if(g>=b[0].nodeValue.length){g=b._4e_index()+1;b=b.parent()}else{var k=b._4e_splitText(g),g=b._4e_index()+1,b=b.parent();if(e.equals(this.startContainer,this.endContainer))this.setEnd(k,this.endOffset-this.startOffset);else if(e.equals(b,this.endContainer))this.endOffset=this.endOffset+1}else{g=b._4e_index();b=b.parent()}this.setStart(b,g);if(f){this.collapse(w);return}}b=this.endContainer;
g=this.endOffset;if(!c&&!f&&b[0]&&b[0].nodeType==e.NodeType.TEXT_NODE){if(g){g>=b[0].nodeValue.length||b._4e_splitText(g);g=b._4e_index()+1}else g=b._4e_index();b=b.parent();this.setEnd(b,g)}},insertNode:function(a){this.optimizeBookmark();this.trim(m,w);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(c){var g=b(this.document);if(c.is2){var f=g._4e_getByAddress(c.start,
c.normalized),e=c.startOffset,g=c.end&&g._4e_getByAddress(c.end,c.normalized),c=c.endOffset;this.setStart(f,e);g?this.setEnd(g,c):this.collapse(w)}else{f=(e=c.serializable)?a.one("#"+c.startNode,g):c.startNode;c=e?a.one("#"+c.endNode,g):c.endNode;this.setStartBefore(f);f._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(w)}},getCommonAncestor:function(a,c){var b=this.startContainer,g=this.endContainer,b=b[0]==g[0]?a&&b[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==
this.endOffset-1?new i(b[0].childNodes[this.startOffset]):b:b._4e_commonAncestor(g);return c&&b[0].nodeType==e.NodeType.TEXT_NODE?b.parent():b},enlarge:function(){function a(c,g,f,k){var d=c[g?"startContainer":"endContainer"],h,i=g?0:1,m=0,j=g?"previousSibling":"nextSibling";h=c[g?"startOffset":"endOffset"];if(d[0].nodeType==e.NodeType.TEXT_NODE){if(g){if(h)return}else if(h<d[0].nodeValue.length)return;h=d[0][j];d=d[0].parentNode}else{h=d[0].childNodes[h+(g?-1:1)]||null;d=d[0]}for(;d;){for(;h;)if(y(h)||
B(h))h=h[j];else break;if(h){if(!m)c[g?"setStartAfter":"setEndBefore"](b(h));break}d=b(d);if(d.nodeName()=="body")break;if(m||d.equals(k)){f[i]=d;m=1}else c[g?"setStartBefore":"setEndAfter"](d);h=d[0][j];d=d[0].parentNode}}return function(c){switch(c){case h.ENLARGE_ELEMENT:if(this.collapsed)break;var c=this.getCommonAncestor(),g=[];a(this,1,g,c);a(this,0,g,c);if(g[0]&&g[1]){c=g[0].contains(g[1])?g[1]:g[0];this.setStartBefore(c);this.setEndAfter(c)}break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:var f=
new n(this.document),g=new i(this.document.body);f.setStartAt(g,h.POSITION_AFTER_START);f.setEnd(this.startContainer,this.startOffset);var f=new p(f),k,d,m=p.blockBoundary(c==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:l),j=function(a){var c=m(a);c||(k=b(a));return c},y=function(a){var c=j(a);!c&&e.nodeName(a)=="br"&&(d=b(a));return c};f.guard=j;f=f.lastBackward();k=k||g;this.setStartAt(k,k.nodeName()!="br"&&(!f&&this.checkStartOfBlock()||f&&k.contains(f))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);f=this.clone();
f.collapse();f.setEndAt(g,h.POSITION_BEFORE_END);f=new p(f);f.guard=c==h.ENLARGE_LIST_ITEM_CONTENTS?y:j;k=l;f=f.lastForward();k=k||g;this.setEndAt(k,!f&&this.checkEndOfBlock()||f&&k.contains(f)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);d&&this.setEndAfter(d)}}}(),checkStartOfBlock:function(){var c=this.startContainer,b=this.startOffset;if(b&&c[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(c[0].nodeValue.substring(0,b)).length)return m;this.trim();c=new o(this.startContainer);b=this.clone();b.collapse(w);
b.setStartAt(c.block||c.blockLimit,h.POSITION_AFTER_START);c=new p(b);c.evaluator=t(w);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,b=this.endOffset;if(c[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(c[0].nodeValue.substring(b)).length)return m;this.trim();c=new o(this.endContainer);b=this.clone();b.collapse(m);b.setEndAt(c.block||c.blockLimit,h.POSITION_BEFORE_END);c=new p(b);c.evaluator=t(m);return c.checkForward()},checkBoundaryOfElement:function(a,c){var b=this.clone();
b[c==h.START?"setStartAt":"setEndAt"](a,c==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);b=new p(b);b.evaluator=u;return b[c==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,c=this.endContainer,g=this.startOffset,f=this.endOffset,k;if(a[0].nodeType==e.NodeType.ELEMENT_NODE){k=a[0].childNodes.length;if(k>g)a=b(a[0].childNodes[g]);else if(k==0)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=b(a);a=a._4e_nextSourceNode()||
a}}if(c[0].nodeType==e.NodeType.ELEMENT_NODE){k=c[0].childNodes.length;if(k>f)c=b(c[0].childNodes[f])._4e_previousSourceNode(w);else if(k==0)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=b(c)}}a._4e_position(c)&j.POSITION_FOLLOWING&&(a=c);return{startNode:a,endNode:c}},fixBlock:function(a,c){var g=this.createBookmark(),k=b(this.document.createElement(c));this.collapse(a);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);k[0].appendChild(this.extractContents());k._4e_trim();f.ie||
k._4e_appendBogus();this.insertNode(k);this.moveToBookmark(g);return k},splitBlock:function(c){var b=new o(this.startContainer),g=new o(this.endContainer),k=b.block,e=g.block,d=l;if(!b.blockLimit.equals(g.blockLimit))return l;if(c!="br"){if(!k){k=this.fixBlock(w,c);e=(new o(this.endContainer)).block}e||(e=this.fixBlock(m,c))}c=k&&this.checkStartOfBlock();b=e&&this.checkEndOfBlock();this.deleteContents();if(k&&k[0]==e[0])if(b){d=new o(this.startContainer);this.moveToPosition(e,h.POSITION_AFTER_END);
e=l}else if(c){d=new o(this.startContainer);this.moveToPosition(k,h.POSITION_BEFORE_START);k=l}else{e=this.splitElement(k);!f.ie&&!a.inArray(k.nodeName(),["ul","ol"])&&k._4e_appendBogus()}return{previousBlock:k,nextBlock:e,wasStartOfBlock:c,wasEndOfBlock:b,elementPath:d}},splitElement:function(a){if(!this.collapsed)return l;this.setEndAt(a,h.POSITION_BEFORE_END);var c=this.extractContents(),b=a.clone(m);b[0].appendChild(c);b.insertAfter(a);this.moveToPosition(a,h.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(a,
c){for(var b=0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,c?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);b=1;break}if(a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()){this.moveToPosition(a,c?h.POSITION_BEFORE_END:h.POSITION_AFTER_START);b=1}var g=a,f=b,k=void 0;g[0].nodeType==e.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(k=g[c?"last":"first"](s,1));!f&&!k&&(k=g[c?"prev":"next"](s,1));a=k}return!!b},selectNodeContents:function(a){var c=a[0];this.setStart(a,0);this.setEnd(a,
c.nodeType==e.NodeType.TEXT_NODE?c.nodeValue.length:c.childNodes.length)},insertNodeByDtd:function(a){var b,g,f,k=a.nodeName();b=c.$block[k];this.deleteContents();if(b){for(b=this.getCommonAncestor(m,w);(g=c[b.nodeName()])&&(!g||!g[k]);){var e=b.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(b);this.collapse(w);b.remove()}else f=b;b=e}f&&this.splitElement(f)}this.insertNode(a)}});v.injectDom({_4e_breakParent:function(a,c){var c=b(c),a=b(a),g,f=new q.Range(a[0].ownerDocument);
f.setStartAfter(a);f.setEndAfter(c);g=f.extractContents();f.insertNode(a.remove());a.after(g)}});return q.Range=n});
KISSY.add("editor/selection",["node","./walker","./range","./base"],function(a,d){function u(a){this.document=a;this._={cache:{}};if(m)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=i}catch(b){this.isInvalid=i}}function s(a){a=new u(a);return!a||a.isInvalid?v:a}var t=d("node"),x=d("./walker"),r=d("./range"),n=d("./base");n.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var i=
!0,v=null,p=a.UA,q=a.DOM,o=n.SelectionType,w=n.RangeType,m=11>p.ieMode,l={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(u,{getNative:!m?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=q.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!m?function(){var a=this._.cache;if(a.type)return a.type;
var c=o.SELECTION_TEXT,b=this.getNative();if(b){if(1==b.rangeCount){var b=b.getRangeAt(0),g=b.startContainer;g==b.endContainer&&g.nodeType==q.NodeType.ELEMENT_NODE&&1==Number(b.endOffset-b.startOffset)&&l[g.childNodes[b.startOffset].nodeName.toLowerCase()]&&(c=o.SELECTION_ELEMENT)}}else c=o.SELECTION_NONE;return a.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var c=o.SELECTION_NONE;try{var b=this.getNative(),g=b.type;"Text"==g&&(c=o.SELECTION_TEXT);"Control"==g&&(c=o.SELECTION_ELEMENT);
b.createRange().parentElement&&(c=o.SELECTION_TEXT)}catch(k){}return a.type=c},getRanges:m?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var g=a.parentElement(),f=g.childNodes,e,d=0;d<f.length;d++){var h=f[d];if(h.nodeType==q.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(h);var h=e.compareEndPoints("StartToStart",a),i=e.compareEndPoints("EndToStart",a);e.collapse();if(0<h)break;else{if(!h||1==i&&-1==h)return{container:g,offset:d};if(!i)return{container:g,offset:d+1}}e=
v}}e||(e=a.duplicate(),e.moveToElementText(g),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=f[--d].nodeValue.length}catch(m){e=0}return 0===e?{container:g,offset:d}:{container:f[d],offset:-e}};return function(c){var b=this._.cache;if(b.ranges&&!c)return b.ranges;var g=this.getNative(),c=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==o.SELECTION_TEXT)return g=new r(this.document),e=a(c,i),g.setStart(new t(e.container),e.offset),
e=a(c),g.setEnd(new t(e.container),e.offset),b.ranges=[g];if(e==o.SELECTION_ELEMENT){b=b.ranges=[];for(e=0;e<c.length;e++){for(var d=c.item(e),h=d.parentNode,m=0,g=new r(this.document);m<h.childNodes.length&&h.childNodes[m]!=d;m++);g.setStart(new t(h),m);g.setEnd(new t(h),m+1);b.push(g)}return b}return b.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],b=this.getNative();if(!b)return[];for(var g=0;g<b.rangeCount;g++){var e=b.getRangeAt(g),d=new r(this.document);
d.setStart(new t(e.startContainer),e.startOffset);d.setEnd(new t(e.endContainer),e.endOffset);a.push(d)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,b=this.getNative();switch(this.getType()){case o.SELECTION_ELEMENT:return this.getSelectedElement();case o.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();i;)if(c=g.startContainer,g.startOffset==(c[0].nodeType===q.NodeType.ELEMENT_NODE?c[0].childNodes.length:
c[0].nodeValue.length)&&!c._4e_isBlockBoundary())g.setStartAfter(c);else break;c=g.startContainer;if(c[0].nodeType!=q.NodeType.ELEMENT_NODE)return c.parent();c=new t(c[0].childNodes[g.startOffset]);if(!c[0]||c[0].nodeType!=q.NodeType.ELEMENT_NODE)return g.startContainer;for(g=c[0].firstChild;g&&g.nodeType==q.NodeType.ELEMENT_NODE;)c=new t(g),g=g.firstChild;return c}if(m)g=b.createRange(),g.collapse(i),c=new t(g.parentElement());else{if((c=b.anchorNode)&&c.nodeType!=q.NodeType.ELEMENT_NODE)c=c.parentNode;
c&&(c=new t(c))}}return a.startElement=c},getSelectedElement:function(){var a,c=this._.cache;if(void 0!==c.selectedElement)return c.selectedElement;m&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var b;if(a)b=new t(a);else{a=this.getRanges()[0];for(var g,e=2;e&&(!(b=a.getEnclosedNode())||!(b[0].nodeType==q.NodeType.ELEMENT_NODE&&l[b.nodeName()]&&(g=b)));e--)a.shrink(w.SHRINK_ELEMENT);b=g}return c.selectedElement=b},reset:function(){this._.cache={}},selectElement:function(a){var c,b=this.document;
if(m)try{c=b.body.createControlRange(),c.addElement(a[0]),c.select()}catch(g){c=b.body.createTextRange(),c.moveToElementText(a[0]),c.select()}finally{}else c=b.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(m){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var b=0;b<a.length;b++){var g=a[b],e=this.document.createRange(),
d=g.startContainer;if(g.collapsed&&(p.gecko&&1.09>p.gecko||p.opera||p.webkit)&&d[0].nodeType==q.NodeType.ELEMENT_NODE&&!d[0].childNodes.length)d[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;e.setStart(d[0],g.startOffset);e.setEnd(g.endContainer[0],g.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var c=[],b=this.getRanges(),g=0;g<b.length;g++)c.push(b[g].createBookmark2(a));return c},createBookmarks:function(e,c){for(var b=[],
g=this.document,d,c=c||this.getRanges(),h=c.length,m=0;m<h;m++){b.push(d=c[m].createBookmark(e,i));var j=(e=d.serializable)?a.one("#"+d.startNode,g):d.startNode;d=e?a.one("#"+d.endNode,g):d.endNode;for(var l=m+1;l<h;l++){var o=c[l],p=o.startContainer,r=o.endContainer;q.equals(p,j.parent())&&o.startOffset++;q.equals(p,d.parent())&&o.startOffset++;q.equals(r,j.parent())&&o.endOffset++;q.equals(r,d.parent())&&o.endOffset++}}return b},selectBookmarks:function(a){for(var c=[],b=0;b<a.length;b++){var g=
new r(this.document);g.moveToBookmark(a[b]);c.push(g)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();m?a&&a.clear():a&&a.removeAllRanges()}});var h={table:1,tbody:1,tr:1},j=x.whitespaces(i),
e=/\ufeff|\u00a0/;r.prototype.select=r.prototype.select=!m?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==q.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(0<=b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(i),c.setEnd(this.endContainer[0],
this.endOffset);else throw b;}a=s(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var c=this.collapsed,b,g;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var d=this.startContainer[0].childNodes[this.startOffset];if(d.nodeType==q.NodeType.ELEMENT_NODE){(new u(this.document)).selectElement(new t(d));return}}(this.startContainer[0].nodeType==q.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in h||this.endContainer[0].nodeType==q.NodeType.ELEMENT_NODE&&
this.endContainer.nodeName()in h)&&this.shrink(w.SHRINK_ELEMENT,i);var m=this.createBookmark(),d=m.startNode,l;c||(l=m.endNode);m=this.document.body.createTextRange();m.moveToElementText(d[0]);m.moveStart("character",1);if(l)a=this.document.body.createTextRange(),a.moveToElementText(l[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(b=d[0].nextSibling;b&&!j(b);)b=b.nextSibling;b=!(b&&b.nodeValue&&b.nodeValue.match(e))&&(a||!d[0].previousSibling||d[0].previousSibling&&"br"==q.nodeName(d[0].previousSibling));
g=new t(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(d);b&&q.insertBefore(this.document.createTextNode("\ufeff"),d[0]||d)}this.setStartBefore(d);d._4e_remove();if(c){if(b?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),g)this.moveToPosition(g,w.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(l),l._4e_remove(),m.select()};u.getSelection=s;return n.Selection=u});
KISSY.add("editor/clipboard",["node","./base","./range","./selection"],function(a,d){function u(a){this.editor=a;this._init()}function s(a){var d=a.get("document")[0],h=a.getSelection(),i;if(h.getType()==v.SELECTION_ELEMENT&&(i=h.getSelectedElement())){var a=h.getRanges()[0],e=$(d.createTextNode(""));e.insertBefore(i);a.setStartBefore(e);a.setEndAfter(i);h.selectRanges([a]);setTimeout(function(){i.parent()&&(e.remove(),h.selectElement(i))},0)}}function t(a){if(UA.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(UA.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(UA.gecko||UA.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function x(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(UA.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(UA.gecko||UA.opera)UA.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function r(a){var d=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"");-1!=a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,d){return d.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(d=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!d&&t(a)&&(a=x(a));return a}d("node");var n=d("./base"),i=d("./range"),v=d("./selection");a.augment(u,
{_init:function(){var a=this,d=a.editor,h=d.get("document"),i=h.one("body"),e=function(a){this.type=a};e.prototype={exec:function(e){var c=this.type;e.focus();setTimeout(function(){UA.ie&&("cut"==c?s(e):"paste"==c&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));q(e,c)||alert(o[c])},0)}};i.on(pasteEvent,a._getClipboardDataFromPasteBin,a);UA.ie&&(i.on("paste",a._iePaste,a),h.on("keydown",a._onKeyDown,a),h.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=
0},0)}));d.addCommand("copy",new e("copy"));d.addCommand("cut",new e("cut"));d.addCommand("paste",new e("paste"))},_onKeyDown:function(a){this.editor.get("mode")==n.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,h=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{d=h.get("document")[0].queryCommandEnabled(a)}catch(i){}this._isPreventBeforePaste=0}else d=(a=(a=h.getSelection())&&a.getRanges())&&
!(1==a.length&&a[0].collapsed);return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;this._isPreventPaste||(a.preventDefault(),d.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){pasteEvent+":  paste event happen";var d=this.editor,l=d.get("document")[0];if(l.getElementById("ke-paste-bin"))pasteEvent+
": trigger more than once ...";else{var h=d.getSelection(),j=new i(l),e=$(UA.webkit?"<body></body>":"<div></div>",l);e.attr("id","ke-paste-bin");UA.webkit&&e[0].appendChild(l.createTextNode("\u200b"));l.body.appendChild(e[0]);e.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var f=h.createBookmarks();j.setStartAt(e,KER.POSITION_AFTER_START);j.setEndAt(e,KER.POSITION_BEFORE_END);j.select(!0);setTimeout(function(){var c,
b=e;e=UA.webkit&&(c=e.first())&&c.hasClass("Apple-style-span")?c:e;h.selectBookmarks(f);var g=e.html();b.remove();if(g=r(g))"paste "+g,c=d.fire("paste",{html:g}),!1!==c&&(void 0!==c&&(g=c),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?a.use("editor/plugin/word-filter",function(a,c){d.insertHtml(c.toDataFormat(g,d))}):d.insertHtml(g))},0)}}}});var p=function(a,d){var h=a.get("document")[0],i=$(h.body),e=!1,f=function(){e=!0};i.on(d,f);(7<UA.ie?h:h.selection.createRange()).execCommand(d);
i.detach(d,f);return e},q=UA.ie?function(a,d){return p(a,d)}:function(a,d){try{return a.get("document")[0].execCommand(d)}catch(h){return!1}},o={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},w={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var d;a.docReady(function(){d=new u(a)});var h={copy:1,cut:1,paste:1},i=["copy","cut","paste"];a.on("contextmenu",function(e){var f=
e.contextmenu;if(!f.__copy_fix){f.__copy_fix=1;for(e=0;e<i.length;e++)f.addChild({content:w[i[e]],value:i[e]});f.on("click",function(c){var b=c.target.get("value");h[b]&&(f.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(b);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var c=f.get("children"),e=c.length-1;e--;0<=e){var b=c[e],g;g=b.get?b.get("value"):b.value;h[g]&&(g=!d._stateFromNamedCommand(g),b.set?b.set("disabled",g):b.disabled=g)}})}}});
KISSY.add("editor/enterKey",["node","./walker","./base","./elementPath"],function(a,d){function u(d){var o;o=d.getSelection().getRanges();for(var r=o.length-1;0<r;r--)o[r].deleteContents();o=o[0];r=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var m=(new n(o.startContainer)).block;if(m&&("li"==m.nodeName()||"li"==m.parent().nodeName()))return d.hasCommand("outdent")?(d.execCommand("save"),d.execCommand("outdent"),d.execCommand("save"),!0):!1}var l=o.splitBlock("p");if(!l)return!0;var d=
l.previousBlock,m=l.nextBlock,h=l.wasStartOfBlock,j=l.wasEndOfBlock,e;if(m)e=m.parent(),"li"==e.nodeName()&&(m._4e_breakParent(e),m._4e_move(m.next(),!0));else if(d&&(e=d.parent())&&"li"==e.nodeName())d._4e_breakParent(e),o.moveToElementEditablePosition(d.next()),d._4e_move(d.prev());if(!h&&!j){if("li"==m.nodeName()&&(e=m.first(x.invisible(!0)))&&a.inArray(e.nodeName(),["ul","ol"]))(i?new t(r.createTextNode("\u00a0")):new t(r.createElement("br"))).insertBefore(e);m&&o.moveToElementEditablePosition(m)}else{var f;
if(d){if("li"==d.nodeName()||!v.test(d.nodeName()))f=d.clone()}else m&&(f=m.clone());f||(f=new t("<p>",null,r));if(e=l.elementPath)for(var l=0,c=e.elements.length;l<c;l++){var b=e.elements[l];if(b.equals(e.block)||b.equals(e.blockLimit))break;p.$removeEmpty[b.nodeName()]&&(b=b.clone(),f._4e_moveChildren(b),f.append(b))}i||f._4e_appendBogus();o.insertNode(f);if(i&&h&&(!j||!d[0].childNodes.length))o.moveToElementEditablePosition(j?d:f),o.select();o.moveToElementEditablePosition(h&&!j?m:f)}i||(m?(f=
new t(r.createElement("span")),f.html("&nbsp;"),o.insertNode(f),f.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),o.deleteContents()):f.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));o.select();return!0}function s(a){a.get("document").on("keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){a.execCommand("save");var i=a.execCommand("enterBlock");a.execCommand("save");!1!==i&&d.preventDefault()}})}
var t=d("node"),x=d("./walker"),r=d("./base"),n=d("./elementPath"),i=11>a.UA.ieMode,v=/^h[1-6]$/,p=r.XHTML_DTD;return{init:function(a){a.addCommand("enterBlock",{exec:u});a.docReady(function(){s(a)})}}});
KISSY.add("editor/htmlDataProcessor",["./base","html-parser"],function(a,d){var u=d("./base"),s=d("html-parser"),t=11>a.UA.ieMode;return{init:function(d){function r(c){var c=c.childNodes,b,d,e,f=c.length;if(f){e=1;for(b=0;b<f;b++)if(d=c[b],d.nodeType!=a.DOM.NodeType.TEXT_NODE||d.nodeValue){e=0;break}return e?!1:void 0}return!1}function n(a){return a.replace(m,function(a,c,b){return"<"+c+b.replace(l,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function i(a){return a.replace(j,
function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function v(c){return c.replace(e,function(c,b){return a.urlDecode(b)})}var p=a.Node,q=a.UA,o=new s.Filter,w=new s.Filter;(function(){function c(a){a=s.serialize(a);return new s.Comment(h+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:c,noscript:c,span:r}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=
["name","href","src"],b,g=0;g<c.length;g++)b="_ke_saved_"+c[g],a.getAttribute(b)&&a.removeAttribute(c[g]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:r,strong:r,em:r,del:r,u:r},attributes:{style:function(c){if(!a.trim(c))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(c){if(c.substr(0,h.length)==h)return c=a.trim(a.urlDecode(c.substr(h.length))),s.parse(c).childNodes[0]}};t&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});o.addRules(d);w.addRules(b)})();(function(){function c(b){for(var b=b.childNodes,g=b.length,d=b[g-1];d&&3==d.nodeType&&!a.trim(d.nodeValue);)d=b[--g];return d}function b(a){var d=c(a);d&&(1==d.nodeType&&"br"==d.nodeName?a.removeChild(d):
3==d.nodeType&&h.test(d.nodeValue)&&a.removeChild(d))}function d(a){var b=c(a);return!b||"form"==a.nodeName&&"input"==b.nodeName}function e(a){b(a);d(a)&&(t||a.appendChild(new s.Tag("br")))}function f(a){b(a);d(a)&&a.appendChild(new s.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,i=u.XHTML_DTD,j=a.merge(i.$block,i.$listItem,i.$tableContent),l;for(l in j)"br"in i[l]||delete j[l];delete j.pre;var i={tags:{}},m={tags:{}};for(l in j)i.tags[l]=e,m.tags[l]=f;w.addRules(i);o.addRules(m)})();o.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var m=/<(a|area|img|input)\b([^>]*)>/gi,l=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,h="{ke_protected}",j=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,f=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,c=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,b=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
d.htmlDataProcessor={dataFilter:w,htmlFilter:o,toHtml:function(a){q.webkit&&(a=a.replace(/\u200b/g,""));var c=new s.BeautifyWriter;(new s.Parser(a)).parse().writeHtml(c,o);return a=c.getHtml()},toDataFormat:function(a,d){var d=d||w,a=i(a),a=n(a),a=a.replace(f,"$1ke:$2"),a=a.replace(b,"<ke:$1$2></ke:$1>"),e=new p("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(c,"$1$2");a=v(a);e=new s.BasicWriter;(new s.Parser(a)).parse().writeHtml(e,d);return a=e.getHtml()},toServer:function(a){var c=new s.MinifyWriter;
(new s.Parser(a)).parse().writeHtml(c,o);return c.getHtml()}}}}});
KISSY.add("editor/selectionFix",["./base","./selection","./range","node"],function(a,d){function u(a){function d(a,c){var b=g.body.createTextRange();try{b.moveToPoint(a,c)}catch(e){b=q}return b}function i(){var a=g.selection.createRange();k&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&k.select();b.detach("mouseup",i);b.detach("mousemove",e);k=f=0}function e(a){if(a.button){if(a=d(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",k)?a.setEndPoint("StartToStart",k):a.setEndPoint("EndToEnd",
k),a.select()}else i()}var f,c=a.get("window")[0],b=a.get("document"),g=b[0],k;b.on("mousedown contextmenu",function(a){var l=g.documentElement;if(a.target===l&&(f&&i(),!(l.scrollHeight>l.clientHeight)&&(f=1,k=d(a.pageX,a.pageY))))b.on("mouseup",i),b.on("mousemove",e),c.focus(),k.select()})}function s(d){function h(a){if(b){var g=d.getSelection(),e=g&&g.getType(),f=g&&j.selection;if(a&&f&&e==m.SELECTION_NONE&&!j.queryCommandEnabled("InsertImage"))setTimeout(function(){h(v)},50);else{var i;if(!f||
!f.type||!("Control"!=f.type&&(i=f.createRange())&&(i=i.parentElement())&&(i=i.nodeName)&&i.toLowerCase()in{input:1,textarea:1}))c=f&&g.getRanges()[0],d.checkSelectionChange()}}}var j=d.get("document")[0],e=new i(j.body),f=new i(j.documentElement);if(8>a.UA.ieMode)f.on("click",function(a){"html"===(new i(a.target)).nodeName()&&d.getSelection().getNative().createRange().select()});var c,b,g=v;f.on("mousedown",function(){g=p});f.on("mouseup",function(){g=v});e.on("focusin",function(a){if("body"==(new i(a.target)).nodeName()&&
c){try{g&&c.select()}catch(b){}c=q}});e.on("focus",function(){b=v;h()});e.on("beforedeactivate",function(a){a.relatedTarget||(b=p,g=v)});e.on("mousedown",function(){b=p});e.on("mouseup",function(){b=v;setTimeout(function(){h(v)},0)});e.on("keydown",function(){b=p});e.on("keyup",function(){b=v;setTimeout(function(){h()},0)})}function t(a){a.get("document").on("mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function x(a){function d(a){var c=r.XHTML_DTD;return a._4e_isBlockBoundary()&&
c.$empty[a.nodeName()]}function j(a){return f(a)&&c(a)}var e=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,f=r.Walker.whitespaces(v),c=r.Walker.bookmark(p,v),b=function(a){return f(a)&&8!=a.nodeType};a.on("selectionChange",function(c){var f=c.path,m=a.get("document")[0],n=new i(m.body),c=(c=c.selection)&&c.getRanges()[0],s=f.blockLimit;n[0]||(m.documentElement.appendChild(m.createElement("body")),n=new i(m.body),c&&
(c.setStart(n,0),c.collapse(1)));s=s||n;if(o.gecko){var q=(m=f.block||f.blockLimit)&&m.last(j);m&&m._4e_isBlockBoundary()&&(!q||!(1==q[0].nodeType&&q._4e_isBlockBoundary()))&&"pre"!=m.nodeName()&&!m._4e_getBogus()&&m._4e_appendBogus()}if(c&&c.collapsed&&!f.block){if("body"==s.nodeName()){"html"==c.startContainer.nodeName()&&c.setStart(n,0);if((f=c.fixBlock(v,"p"))&&f[0]!=n[0].lastChild&&f.outerHtml().match(e))if((m=f.next(b,1))&&m[0].nodeType==w.NodeType.ELEMENT_NODE&&!d[m])c.moveToElementEditablePosition(m),
f._4e_remove();else if((m=f.prev(b,1))&&m[0].nodeType==w.NodeType.ELEMENT_NODE&&!d[m])c.moveToElementEditablePosition(m,m.outerHtml().match(e)?p:v),f._4e_remove();c.select();a.notifySelectionChange()}f=a.get("document")[0];c=new r.Range(f);c.moveToElementEditablePosition(n,v);"body"!==(new r.ElementPath(c.startContainer)).blockLimit.nodeName()&&(n=(new i(f.createElement("p"))).appendTo(n),o.ie||n._4e_appendBogus())}})}var r=d("./base");d("./selection");var n=d("./range"),i=d("node"),v=!0,p=!1,q=null,
o=a.UA,w=a.DOM,m=r.SelectionType;return{init:function(a){a.docReady(function(){if(11>o.ieMode)u(a),s(a);else if(t(a),11==o.ieMode)a.get("document").on("focusin",function(d){var j=a.getSelection(),j=j&&j.getRanges()[0];j||(j=new n(this),j.setStart(i.all(d.target),0),j.collapse(1),j.select())})});x(a)}}});
KISSY.add("editor/plugin-meta",[],function(){(function(a){a({"editor/plugin/back-color":{requires:["editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor/plugin/font/ui","editor/plugin/bold/cmd","editor/plugin/button"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/button","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","menubutton","editor/plugin/dialog"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor",
"editor/plugin/dialog"]}});a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix","event"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["editor","overlay"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:"editor,json,event,editor/plugin/local-storage,overlay,editor/plugin/menubutton".split(",")}});
a({"editor/plugin/drag-upload":{requires:["editor","event"]}});a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","html-parser"]}});a({"editor/plugin/flash-bridge":{requires:["editor","swf","event"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor/plugin/flash-common/utils","base","editor","editor/plugin/dialog-loader","editor/plugin/bubble"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd","editor/plugin/menubutton"]}});a({"editor/plugin/font-family/cmd":{requires:["editor/plugin/font/cmd"]}});
a({"editor/plugin/font-size":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd","editor/plugin/menubutton"]}});a({"editor/plugin/font-size/cmd":{requires:["editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});
a({"editor/plugin/heading":{requires:["editor/plugin/menubutton","editor","editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor/plugin/button","editor","editor/plugin/bubble","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["editor","io","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd","editor/plugin/button"]}});
a({"editor/plugin/indent/cmd":{requires:["editor/plugin/dent-cmd"]}});a({"editor/plugin/italic":{requires:["editor/plugin/font/ui","editor/plugin/italic/cmd","editor/plugin/button"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});
a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd","editor/plugin/button"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor/plugin/button","editor/plugin/bubble","editor","editor/plugin/link/utils",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay",
"editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor/plugin/maximize/cmd","editor/plugin/button"]}});a({"editor/plugin/maximize/cmd":{requires:["editor","event"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/ordered-list":{requires:["editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/button","editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/preview":{requires:["editor/plugin/button"]}});a({"editor/plugin/progressbar":{requires:["base"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/button",
"editor/plugin/remove-format/cmd"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay","editor/plugin/button"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor/plugin/font/ui","editor/plugin/strike-through/cmd","editor/plugin/button"]}});
a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu","editor/plugin/button"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor/plugin/font/ui","editor/plugin/underline/cmd","editor/plugin/button"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});
a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd","editor/plugin/button"]}});a({"editor/plugin/undo/btn":{requires:["editor/plugin/button","editor"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["html-parser"]}});a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects","editor/plugin/button"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor",
"editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor/styles",["node","./selection","./range","./base","./elementPath"],function(a,d){function u(a){return!E.attr(a,"_ke_bookmark")}function s(a,c){for(var b in a)"string"==typeof a[b]?a[b]=a[b].replace(S,function(a,b){return c[b]}):s(a[b],c)}function t(c,b){b&&(c=a.clone(c),s(c,b));var d=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==d||R[d]?G.STYLE_BLOCK:O[d]?G.STYLE_OBJECT:G.STYLE_INLINE;this._={definition:c}}function x(a,c){var b=c?this.removeFromRange:
this.applyToRange;a.body.focus();for(var d=new g(a),e=d.getRanges(),f=0;f<e.length;f++)b.call(this,e[f]);d.selectRanges(e)}function r(a,c,d){var e=a.element;"*"==e&&(e="span");c=new b(c.createElement(e));d&&d._4e_copyAttributes(c);d=a._.definition;a=d.attributes;d=t.getStyleText(d);if(a)for(var g in a)c.attr(g,a[g]);d&&(c[0].style.cssText=d);return c}function n(a){var c=a.createBookmark(z),d=a.createIterator();d.enforceRealBlocks=z;d.enlargeBr=z;for(var e,g=a.document;e=d.getNextParagraph();){var f=
r(this,g,e),h=f,f="pre"==h.nodeName,k="pre"==e.nodeName,j=!f&&k;f&&!k?(k=e,j=k.html(),j=i(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),M.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(h[0]),h.outerHtml("<pre>"+j+"</pre>"),h=new b(k.firstChild),h._4e_remove()):h.html(j)):j?h=p(v(e),h):e._4e_moveChildren(h);e[0].parentNode.replaceChild(h[0],e[0]);if(f&&(e=h,f=void 0,
(f=e._4e_previousSourceNode(z,E.NodeType.ELEMENT_NODE))&&"pre"==f.nodeName()))h=i(f.html(),/\n$/,"")+"\n\n"+i(e.html(),/^\n/,""),M.ie?e.outerHtml("<pre>"+h+"</pre>"):e.html(h),f._4e_remove()}a.moveToBookmark(c)}function i(a,c,b){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,b){c&&(d=c);b&&(e=b);return""});return d+a.replace(c,b)+e}function v(a){var c=[];i(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,c,b){return c+"</pre>"+b+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,b){c.push(b)});return c}function p(a,c){for(var b=c[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=i(e,/^[ \t]*\n/,""),e=i(e,/\n$/,""),e=i(e,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),g=c.clone();g.html(e);b.appendChild(g[0])}return b}function q(a){var c=a.document;if(a.collapsed)c=r(this,c,void 0),a.insertNode(c),a.moveToPosition(c,I.POSITION_BEFORE_END);else{var d=this.element,g=this._.definition,f,h=K[d];h||(f=z,h=K.span);var i=a.createBookmark();a.enlarge(I.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),m=j.startNode,j=j.endNode,l=m,o;l&&l[0];){var n=H;if(E.equals(l,j))l=F,n=z;else{var p=l[0].nodeType,s=p==E.NodeType.ELEMENT_NODE?l.nodeName():F;if(s&&l.attr("_ke_bookmark")){l=
l._4e_nextSourceNode(z);continue}if(!s||h[s]&&(l._4e_position(j)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(l))){var q=l.parent();if(q&&"a"==d&&q.nodeName()==d)p=r(this,c,void 0),q._4e_moveChildren(p),q[0].parentNode.replaceChild(p[0],q[0]),p._4e_mergeSiblings();else if(q&&q[0]&&((K[q.nodeName()]||K.span)[d]||f)&&(!g.parentRule||g.parentRule(q))){if(!o&&(!s||!K.$removeEmpty[s]||(l._4e_position(j)|
C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))o=new k(c),o.setStartBefore(l);if(p==E.NodeType.TEXT_NODE||p==E.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){q=l;for(p=null;(n=!q.next(u,1))&&(p=q.parent())&&h[p.nodeName()]&&(p._4e_position(m)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(p));)q=
p;o.setEndAfter(q)}}else n=z}else n=z;l=l._4e_nextSourceNode()}if(n&&o&&!o.collapsed){for(var n=r(this,c,void 0),q=o.getCommonAncestor(),p={},s={},t,v=null,y;n&&q&&n[0]&&q[0];){if(q.nodeName()==d){for(t in g.attributes)if(!s[t]&&(y=q.attr(v)))n.attr(t)==y?n.removeAttr(t):s[t]=1;for(v in g.styles)if(!p[v]&&(y=q.style(v)))n.style(v)==y?n.style(v,""):p[v]=1;if(!n._4e_hasAttributes()){n=F;break}}q=q.parent()}n?(n[0].appendChild(o.extractContents()),e(this,n),o.insertNode(n),n._4e_mergeSiblings(),M.ie||
n[0].normalize()):(n=new b(c.createElement("span")),n[0].appendChild(o.extractContents()),o.insertNode(n),e(this,n),n._4e_remove(!0));o=F}}m._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(I.SHRINK_TEXT)}}function o(a){a.enlarge(I.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var e=new B(d.parent()),g,i=0,k;i<e.elements.length&&(k=e.elements[i])&&!(k==e.block||k==e.blockLimit);i++)if(this.checkElementRemovable(k)){var j=a.checkBoundaryOfElement(k,I.END),m=!j&&
a.checkBoundaryOfElement(k,I.START);m||j?(g=k,g.match=m?"start":"end"):(k._4e_mergeSiblings(),k.nodeName()!=this.element?(j=l(this),f(k,j[k.nodeName()]||j["*"])):h(this,k))}if(g){k=d;for(i=0;;i++){j=e.elements[i];if(j.equals(g))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(k[0]);k=j}k["start"==g.match?"insertBefore":"insertAfter"](g);e=g.html();!e||"\u200b"==e?g.remove():M.webkit&&L(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var o=c.endNode,n=this;g=function(){for(var a=new B(d.parent()),
c=new B(o.parent()),b=F,e=F,g=0;g<a.elements.length;g++){var f=a.elements[g];if(f==a.block||f==a.blockLimit)break;n.checkElementRemovable(f)&&(b=f)}for(g=0;g<c.elements.length;g++){f=c.elements[g];if(f==c.block||f==c.blockLimit)break;n.checkElementRemovable(f)&&(e=f)}e&&o._4e_breakParent(e);b&&d._4e_breakParent(b)};g();for(e=new b(d[0].nextSibling);e[0]!==o[0];){i=e._4e_nextSourceNode();if(e[0]&&e[0].nodeType==E.NodeType.ELEMENT_NODE&&this.checkElementRemovable(e)&&(e.nodeName()==this.element?h(this,
e):(k=l(this),f(e,k[e.nodeName()]||k["*"])),i[0].nodeType==E.NodeType.ELEMENT_NODE&&i.contains(d)))g(),i=new b(d[0].nextSibling);e=i}}a.moveToBookmark(c)}function w(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,b,d){c[b]=d});return c}function m(a,c){var b="";c!==H?(b=document.createElement("span"),b.style.cssText=a,b=b.style.cssText||""):b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function l(c){if(c._.overrides)return c._.overrides;
var b=c._.overrides={},d=c._.definition.overrides;if(d){a.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++){var g=d[e],f,i,h;"string"==typeof g?f=g.toLowerCase():(f=g.element?g.element.toLowerCase():c.element,i=g.attributes,h=g.styles);g=b[f]||(b[f]={});if(i){f=g.attributes=g.attributes||[];for(var k in i)f.push([k.toLowerCase(),i[k]])}if(h){var g=g.styles=g.styles||[],j;for(j in h)g.push([j.toLowerCase(),h[j]])}}}return b}function h(b,d){var e=b._.definition,g=l(b),f=a.merge(e.attributes,(g[d.nodeName()]||
g["*"]||{}).attributes),e=a.merge(e.styles,(g[d.nodeName()]||g["*"]||{}).styles),g=a.isEmptyObject(f)&&a.isEmptyObject(e),i;for(i in f)("class"==i||b._.definition.fullMatch)&&d.attr(i)!=j(i,f[i])||(g=g||!!d.hasAttr(i),d.removeAttr(i));for(var h in e)b._.definition.fullMatch&&d.style(h)!=j(h,e[h],z)||(g=g||!!d.style(h),d.style(h,""));c(d)}function j(a,c,d){var e=new b("<span>");e[d?"style":"attr"](a,c);return e[d?"style":"attr"](a)}function e(a,c){for(var d=l(a),e=c.all(a.element),g=e.length;0<=--g;)h(a,
new b(e[g]));for(var i in d)if(i!=a.element){e=c.all(i);for(g=e.length-1;0<=g;g--){var k=new b(e[g]);f(k,d[i])}}}function f(a,b){var d,e=b&&b.attributes;if(e)for(d=0;d<e.length;d++){var g=e[d][0],f;if(f=a.attr(g)){var i=e[d][1];(i===F||i.test&&i.test(f)||"string"==typeof i&&f==i)&&a[0].removeAttribute(g)}}if(e=b&&b.styles)for(d=0;d<e.length;d++)if(g=e[d][0],i=a.css(g)){var h=e[d][1];(h===F||h.test&&h.test(f)||"string"==typeof h&&i==h)&&a.css(g,"")}c(a)}function c(a){if(!a._4e_hasAttributes()){var c=
a[0].firstChild,b=a[0].lastChild;a._4e_remove(z);c&&(c.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==E.NodeType.ELEMENT_NODE&&E._4e_mergeSiblings(b))}}var b=d("node"),g=d("./selection"),k=d("./range"),y=d("./base"),B=d("./elementPath"),z=!0,H=!1,F=null,L=a.all,E=a.DOM,I=y.RangeType,C=y.PositionType,G,M=a.UA,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},K=y.XHTML_DTD,O={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},
P=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;y.StyleType=G={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};t.prototype={constructor:t,apply:function(a){x.call(this,a,H)},remove:function(a){x.call(this,a,z)},applyToRange:function(a){return(this.applyToRange=this.type==G.STYLE_INLINE?q:this.type==G.STYLE_BLOCK?n:F).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==G.STYLE_INLINE?o:F).call(this,a)},checkElementRemovable:function(a,c){if(!a)return H;var b=this._.definition,d;if(a.nodeName()==
this.element){if(!c&&!a._4e_hasAttributes())return z;var e=b._AC;if(e)b=e;else{var e={},g=0,f=b.attributes;if(f)for(var i in f)g++,e[i]=f[i];if(f=t.getStyleText(b))e.style||g++,e.style=f;e._length=g;b=b._AC=e}if(b._length){for(var h in b)if("_length"!=h){g=a.attr(h)||"";if("style"==h)a:{e=b[h];g=m(g,H);"string"==typeof e&&(e=w(e));"string"==typeof g&&(g=w(g));f=void 0;for(f in e)if(!(f in g&&(g[f]==e[f]||"inherit"==e[f]||"inherit"==g[f]))){e=H;break a}e=z}else e=b[h]==g;if(e){if(!c)return z}else if(c)return H}if(c)return z}else return z}h=
l(this);if(h=h[a.nodeName()]||h["*"]){if(!(b=h.attributes)&&!(d=h.styles))return z;if(b)for(e=0;e<b.length;e++)if(h=b[e][0],h=a.attr(h))if(g=b[e][1],g===F||"string"==typeof g&&h==g||g.test&&g.test(h))return z;if(d)for(e=0;e<d.length;e++)if(h=a.css(d[e][0]))if(b=d[e][1],b===F||"string"==typeof b&&h==b||b.test&&b.test(h))return z}return H},checkActive:function(a){switch(this.type){case G.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,z);case G.STYLE_OBJECT:case G.STYLE_INLINE:for(var c=
a.elements,b=0,d;b<c.length;b++)if(d=c[b],!(this.type==G.STYLE_INLINE&&(E.equals(d,a.block)||E.equals(d,a.blockLimit))))if((this.type!=G.STYLE_OBJECT||d.nodeName()in O)&&this.checkElementRemovable(d,z))return z}return H}};t.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(P,";"));for(var e in c){var g=c[e],f=(e+":"+g).replace(P,";");"inherit"==g?d+=f:b+=f}b.length&&(b=m(b));return a._ST=b+d};return y.Style=t});
KISSY.add("editor/domIterator",["node","./walker","./range","./base","./elementPath"],function(a,d){function u(a){1>arguments.length||(this.range=a,this.forceBrBreak=v,this.enlargeBr=i,this.enforceRealBlocks=v,this._||(this._={}))}var s=d("node"),t=d("./walker"),x=d("./range"),r=d("./base"),n=d("./elementPath"),i=!0,v=!1,p=a.UA,q=r.RangeType,o=a.DOM,w=/^[\r\n\t ]*$/;a.augment(u,{getNextParagraph:function(d){var l,h,j,e,f;if(!this._.lastNode){h=this.range.clone();h.shrink(q.SHRINK_ELEMENT,i);h.enlarge(this.forceBrBreak||
!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);var c=new t(h),b=t.bookmark(i,i);c.evaluator=b;this._.nextNode=c.next();c=new t(h);c.evaluator=b;c=c.previous();this._.lastNode=c._4e_nextSourceNode(i);this._.lastNode&&this._.lastNode[0].nodeType==o.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(b=new x(h.document),b.moveToPosition(this._.lastNode,q.POSITION_AFTER_END),b.checkEndOfBlock()&&(b=new n(b.endContainer),this._.lastNode=
(b.block||b.blockLimit)._4e_nextSourceNode(i)));this._.lastNode||(this._.lastNode=this._.docEndMarker=new s(h.document.createTextNode("")),o.insertAfter(this._.lastNode[0],c[0]));h=null}b=this._.nextNode;c=this._.lastNode;for(this._.nextNode=null;b;){var g=v,k=b[0].nodeType!=o.NodeType.ELEMENT_NODE,r=v;if(k)b[0].nodeType==o.NodeType.TEXT_NODE&&w.test(b[0].nodeValue)&&(k=v);else{var u=b.nodeName();if(b._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==u)k=i;else if(!h&&!b[0].childNodes.length&&
"hr"!=u){l=b;j=b.equals(c);break}h&&(h.setEndAt(b,q.POSITION_BEFORE_START),"br"!=u&&(this._.nextNode=b));g=i}else{if(b[0].firstChild){h||(h=new x(this.range.document),h.setStartAt(b,q.POSITION_BEFORE_START));b=new s(b[0].firstChild);continue}k=i}}k&&!h&&(h=new x(this.range.document),h.setStartAt(b,q.POSITION_BEFORE_START));j=(!g||k)&&b.equals(c);if(h&&!g)for(;!b[0].nextSibling&&!j;){u=b.parent();if(u._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){g=i;j||u.equals(c);break}b=u;k=i;j=b.equals(c);r=
i}k&&h.setEndAt(b,q.POSITION_AFTER_END);b=b._4e_nextSourceNode(r,null,c);if((j=!b)||g&&h)break}if(!l){if(!h)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;l=new n(h.startContainer);b=l.blockLimit;g={div:1,th:1,td:1};l=l.block;if((!l||!l[0])&&!this.enforceRealBlocks&&g[b.nodeName()]&&h.checkStartOfBlock()&&h.checkEndOfBlock())l=b;else if(!l||this.enforceRealBlocks&&"li"==l.nodeName())l=new s(this.range.document.createElement(d||"p")),l[0].appendChild(h.extractContents()),
l._4e_trim(),h.insertNode(l),e=f=i;else if("li"!=l.nodeName()){if(!h.checkStartOfBlock()||!h.checkEndOfBlock())l=l.clone(v),l[0].appendChild(h.extractContents()),l._4e_trim(),f=h.splitBlock(),e=!f.wasStartOfBlock,f=!f.wasEndOfBlock,h.insertNode(l)}else j||(this._.nextNode=l.equals(c)?null:h.getBoundaryNodes().endNode._4e_nextSourceNode(i,null,c))}e&&(h=new s(l[0].previousSibling),h[0]&&h[0].nodeType==o.NodeType.ELEMENT_NODE&&("br"==h.nodeName()?h._4e_remove():h[0].lastChild&&"br"==o.nodeName(h[0].lastChild)&&
o._4e_remove(h[0].lastChild)));f&&(h=t.bookmark(v,i),e=new s(l[0].lastChild),e[0]&&e[0].nodeType==o.NodeType.ELEMENT_NODE&&"br"==e.nodeName()&&(p.ie||e.prev(h,1)||e.next(h,1))&&e.remove());this._.nextNode||(this._.nextNode=j||l.equals(c)?null:l._4e_nextSourceNode(i,null,c));return l}});x.prototype.createIterator=function(){return new u(this)};return u});
KISSY.add("editor/z-index-manager",["./base"],function(a,d){var u=d("./base"),s=u.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};u.baseZIndex=function(a){return(u.Config.baseZIndex||1E4)+a};return s});
KISSY.add("editor","node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta,editor/styles,editor/domIterator,editor/z-index-manager".split(","),function(a,d,u,s){function t(a,b){var d=a.body;tryThese(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();if(!arguments.callee.retry)arguments.callee.retry=TRUE},50)},function(){a.designMode="off";d.setAttribute("contentEditable",
false);d.setAttribute("contentEditable",true);!b&&t(a,1)})}function x(c){c.get("iframe");var b=c.get("textarea")[0],d=c.get("window"),e=c.get("document"),f=e[0];if(UA.webkit){e.on("click",function(c){var b=new p(c.target);a.inArray(b.nodeName(),["input","select"])&&c.preventDefault()});e.on("mouseup",function(c){var b=new p(c.target);a.inArray(b.nodeName(),["input","textarea"])&&c.preventDefault()})}if(UA.gecko||UA.ie||UA.opera){var h;h=(new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);
h.on("focus",function(){c.focus()});c.activateGecko=function(){UA.gecko&&c.__iframeFocus&&h[0].focus()};c.on("destroy",function(){h.detach();h.remove()})}d.on("focus",function(){UA.gecko?t(f,FALSE):UA.opera&&f.body.focus();c.notifySelectionChange()});if(UA.gecko)e.on("mousedown",function(){c.__iframeFocus||t(f,FALSE)});if(IS_IE){e.on("keydown",function(a){if(a.keyCode in{8:1,46:1}){var b=c.getSelection(),d=b.getSelectedElement();if(d){c.execCommand("save");var e=b.getRanges()[0].createBookmark();
d.remove();b.selectBookmarks([e]);c.execCommand("save");a.preventDefault()}}});if(f.compatMode=="CSS1Compat"){var i={33:1,34:1};e.on("keydown",function(a){a.keyCode in i&&setTimeout(function(){c.getSelection().scrollIntoView()},0)})}}if(UA.webkit)e.on("mousedown",function(b){b=new p(b.target);a.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(b)});if(UA.gecko)e.on("dragstart",function(a){var c=new p(a.target);c.nodeName()==="img"&&/ke_/.test(c[0].className)&&
a.preventDefault()});m.add(c)}function r(c,b,d,e){var f="",h;h=w.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(h);for(h=0;h<d.length;h++)f=f+a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[h]});return a.substitute(q,{doctype:a.UA.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:f,style:"<style>"+b+"</style>",data:e||"",script:c?'<script id="ke_active_script">'+($(window).isCustomDomain()?'document.domain="'+document.domain+'";':
"")+'parent.KISSY.require("editor")._initIframe("'+c+'");<\/script>':""})}function n(a,b){function d(){j=i.document;a.setInternal("document",new p(j));a.setInternal("window",new p(i));e.detach();j.open("text/html","replace");j.write(f);j.close()}var e=a.get("iframe"),f=r(a.get("id"),a.get("customStyle"),a.get("customLink"),b),h=e[0],i=h.contentWindow,j;e.__loaded=1;try{j=i.document}catch(l){h.src=h.src;if(IS_IE<7){setTimeout(d,10);return}}d()}function i(c,b){var d=$(window).getEmptyIframeSrc()||"";
d&&(d=' src="'+d+'" ');var d=new p(a.substitute(IFRAME_TPL,{iframeSrc:d,prefixCls:c.get("prefixCls")})),e=c.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",UA.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);c.set("iframe",d);c.__docReady=0;if(UA.gecko&&!d.__loaded)d.on("load",function(){n(c,b)},c);else n(c,b)}function v(c){if(c.get("iframe")){var b=c.get("iframe"),d=c.get("window"),c=c.get("document"),e=c[0],f=$(e.documentElement),e=$(e.body);a.each([c,f,e,d],function(a){a.detach()});
b.remove()}}var p=d("node"),q=d("editor/iframe-content-tpl"),o=d("editor/base"),w=d("editor/utils"),m=d("editor/focusManager"),l=d("editor/clipboard"),h=d("editor/enterKey"),j=d("editor/htmlDataProcessor"),e=d("editor/selectionFix");d("editor/plugin-meta");d("editor/styles");d("editor/domIterator");d("editor/z-index-manager");s.exports=o;o.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};o.addMembers({initializer:function(){this.__commands={};this.__controls={};m.register(this)},renderUI:function(){l.init(this);
h.init(this);j.init(this);e.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var d=b.getSelection();d&&d.removeAllRanges()}}var b=this,d,e=b.get("prefixCls"),f=b.get("textarea");if(b.get("attachForm")&&(d=f[0].form)&&(d=$(d)))d.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(e+"editor-focused")});b.on("focus",function(){b.$el.addClass(e+"editor-focused")})},_onSetHeight:function(a){var b=this.get("textarea"),d=this.get("toolBarEl"),
e=this.get("statusBarEl"),a=parseInt(a,10),a=a-((d&&d.outerHeight()||0)+(e&&e.outerHeight()||0));b.parent().css(HEIGHT,a);b.css(HEIGHT,a)},_onSetMode:function(a){var b=this.get("iframe"),d=this.get("textarea");if(a==1){this.setData(d.val());d.hide();this.fire("wysiwygMode")}else{if(b){d.val(this.getFormatData(1));b.hide()}d.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var c,b=this.get("textarea"),d=this.get("document");this.get("attachForm")&&
(c=b[0].form)&&(c=$(c))&&c.detach("submit",this.sync,this);if(d){c=$(d[0].body);var b=$(d[0].documentElement),e=this.get("window");m.remove(this);d.detach();b.detach();c.detach();e.detach()}a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},sync:function(){this.get("textarea").val(this.getData())},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,
b){var a=a+"/dialog",d=this.__controls[a];d.show(b);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(c){var b=this.__commands[c],d=a.makeArray(arguments);d.shift();d.unshift(this);if(b)return b.exec.apply(b,d);c+": command not found"},queryCommandValue:function(a){return this.execCommand(w.getQueryCmd(a))},setData:function(a){var b,d=a;if(this.get("mode")!=1)this.get("textarea").val(a);
else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);v(this);i(this,d)}},getData:function(c,b){var d=this.htmlDataProcessor,e;b==void 0&&(b=this.get("mode"));e=b==1&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());e=c?d.toHtml(e):d.toServer(e);e=a.trim(e);EMPTY_CONTENT_REG.test(e)&&(e="");return e},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return r(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},
getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b="";if(a){a=a.cloneContents();b=this.get("document")[0].createElement("div");b.appendChild(a);b=b.innerHTML}return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];UA.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var d=this.get("window"),e=this.get("customStyle")||"";this.set("customStyle",e+("\n"+a));d&&d.addStyleSheet(a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),d=this.get("document")[0];b.push(a);this.set("customLink",b);b=d.createElement("link");b.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(c){this.get("document").all("link").each(function(a){a.attr("href")==
c&&a.remove()});var b=this.get("customLink"),d=a.indexOf(c,b);d!=-1&&b.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),e=new o.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(e)){a.__previousPath=
e;a.fire("selectionChange",{selection:b,path:e,element:d})}}},100)},notifySelectionChange:function(){this.__previousPath=NULL;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var b,d=a.nodeName(),e=o.XHTML_DTD,h=e.$block[d],i=o.RangeType,j=(d=this.getSelection())&&d.getRanges(),l,m,n;if(j&&j.length!=0){this.execCommand("save");for(m=j.length-1;m>=0;m--){l=j[m];b=!m&&a||a.clone(TRUE);l.insertNodeByDtd(b);n||(n=b)}if(n){l.moveToPosition(n,i.POSITION_AFTER_END);
if(h){a=o.Walker.whitespaces(true);(a=(n=n.next(a,1))&&n[0].nodeType==NodeType.ELEMENT_NODE&&n.nodeName())&&e.$block[a]&&e[a]["#text"]&&l.moveToElementEditablePosition(n)}d.selectRanges([l]);this.focus();b&&b[0].nodeType==1&&b.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});f.call(this);return b}}}},insertHtml:function(a,b){var d=this,e,h=d.get("document")[0];if(d.get("mode")===1){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,b);d.focus();d.execCommand("save");
if(IS_IE){e=h.selection;e.type=="Control"&&e.clear();try{e.createRange().pasteHTML(a)}catch(i){"insertHtml error in ie"}}else try{h.execCommand("inserthtml",FALSE,a)}catch(j){setTimeout(function(){if(d.getSelection().getRanges().length==0){var b=new o.Range(h),e=$(h.body).first(function(a){return a.nodeType==1&&a.nodeName.toLowerCase()!="br"});if(!e){e=$(h.createElement("p"));e._4e_appendBogus().appendTo(h.body)}b.setStartAt(e,o.RangeType.POSITION_AFTER_START);b.select()}h.execCommand("inserthtml",
FALSE,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);f.call(d)}}});o.decorate=function(a,b){var b=b||{},a=$(a),d=b.textareaAttrs=b.textareaAttrs||{},e=a.style("width"),f=a.style("height"),h=a.attr("name");if(e)b.width=b.width||e;if(f)b.height=b.height||f;if(h)d.name=h;b.data=b.data||a.val();b.elBefore=a;d=(new o(b)).render();a.remove();return d};o._initIframe=function(a){var b=m.getInstance(a),a=b.get("document"),d=a[0];a.one("#ke_active_script").remove();x(b);var e=d.body,f=
$(e);if(IS_IE){e.hideFocus=TRUE;e.disabled=TRUE;e.contentEditable=TRUE;e.removeAttribute("disabled")}else setTimeout(function(){UA.gecko||UA.opera?e.contentEditable=TRUE:UA.webkit?e.parentNode.contentEditable=TRUE:d.designMode="on"},0);if(UA.gecko||UA.opera){var h=d.documentElement;$(h).on("mousedown",function(a){if(a.target==h){UA.gecko&&t(d,FALSE);b.activateGecko()}})}setTimeout(function(){IS_IE&&setTimeout(function(){if(d){e.runtimeStyle.marginBottom="0px";e.runtimeStyle.marginBottom=""}},1E3)},
0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),c=b.get("disableInlineTableEditing");if(a||c)try{d.execCommand("enableObjectResizing",FALSE,!a);d.execCommand("enableInlineTableEditing",FALSE,!c)}catch(e){f.on(IS_IE?"resizestart":"resize",function(b){var d=new p(b.target);(a||d.nodeName()==="table"&&c)&&b.preventDefault()})}},10)};var f=a.buffer(function(){this.execCommand("save")},50)});
