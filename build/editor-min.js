/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 10 18:46
*/
KISSY.add("editor/iframe-content-tpl",[],'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>');
KISSY.add("editor/render-xtpl",[],function(l,h,v,w){h=function(p,h,u){var d=this.nativeCommands;if("5.0.0"!==l.version)throw Error("current xtemplate file("+this.name+")(v5.0.0) need to be recompiled using current kissy(v"+l.version+")!");var g=d.each,d=d["if"];h.write('<div class="');var q=p.resolve(["prefixCls"]);h.write(q,!0);h.write('editor-tools">\n\n</div>\n\n<\!--\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\n--\>\n\n<div class="');q=p.resolve(["prefixCls"]);
h.write(q,!0);h.write('editor-textarea-wrap"\n\n');var q={escape:1},x=[],k=p.resolve(["mobile"]);x.push(k);q.params=x;q.fn=function(d,g){g.write('\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\n');return g};h=d.call(this,p,q,h,12,u);h.write('\n>\n\n<textarea class="');q=p.resolve(["prefixCls"]);h.write(q,!0);h.write('editor-textarea"\n\n');q={escape:1};x=[];k=p.resolve(["textareaAttrs"]);x.push(k);q.params=x;q.fn=function(d,g){g.write("\n");var k=d.resolve(["xindex"]);g.write(k,!0);g.write('="');
k=d.resolve(["this"]);g.write(k,!0);g.write('"\n');return g};h=g.call(this,p,q,h,19,u);h.write("\n\n");g={escape:1};q=[];x=p.resolve(["mode"]);q.push(x);g.params=q;g.fn=function(d,g){g.write('\nstyle="display:none"\n');return g};h=d.call(this,p,g,h,23,u);h.write("\n\n>");u=p.resolve(["data"]);h.write(u,!0);h.write('</textarea>\n\n</div>\n\n<div class="');p=p.resolve(["prefixCls"]);h.write(p,!0);h.write('editor-status">\n\n</div>');return h};h.TPL_NAME=w.name;return h});
KISSY.add("editor/base",["html-parser","component/control","./render-xtpl"],function(l,h){var v=h("html-parser"),w=h("component/control"),p=h("./render-xtpl");return w.extend({beforeCreateDom:function(h){l.mix(h,{mobile:l.UA.mobile})}},{Config:{},XHTML_DTD:v.DTD,ATTRS:{contentTpl:{value:p},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},
statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},handleGestureEvents:{value:!1},focusable:{value:!1},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/utils",["node","./base"],function(l,h){var v=h("node"),w=h("./base"),p=l.require("dom"),y=l.UA,u={debugUrl:function(d){var g=l.Config;g.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));-1===d.indexOf("?t")&&(d=-1!==d.indexOf("?")?d+"&":d+"?",d+="t="+encodeURIComponent(g.tag));return l.config("base")+"editor/"+d},lazyRun:function(d,g,q){var l=d[g],k=d[q];d[g]=function(){l.apply(this,arguments);d[g]=d[q];return k.apply(this,arguments)}},getXY:function(d,g){var q=d.left,l=d.top,k=g.get("window")[0],
q=q-p.scrollLeft(k),l=l-p.scrollTop(k),k=g.get("iframe").offset(),q=q+k.left,l=l+k.top;return{left:q,top:l}},tryThese:function(){for(var d,g=0,l=arguments.length;g<l;g++){var h=arguments[g];try{d=h();break}catch(k){}}return d},clearAllMarkers:function(d){for(var g in d)d[g]._4eClearMarkers(d,!0,void 0)},ltrim:function(d){return d.replace(/^\s+/,"")},rtrim:function(d){return d.replace(/\s+$/,"")},isNumber:function(d){return/^\d+(.\d+)?$/.test(l.trim(d))},verifyInputs:function(d){for(var g=0;g<d.length;g++){var q=
new v(d[g]),h=l.trim(u.valInput(q)),k=q.attr("data-verify"),q=q.attr("data-warning");if(k&&!RegExp(k).test(h))return alert(q),!1}return!0},sourceDisable:function(d,g){d.on("sourceMode",g.disable,g);d.on("wysiwygMode",g.enable,g)},resetInput:function(d){var g=d.attr("placeholder");g&&y.ie?(d.addClass("ks-editor-input-tip"),d.val(g)):y.ie||d.val("")},valInput:function(d,g){if(void 0===g)return d.hasClass("ks-editor-input-tip")?"":d.val();d.removeClass("ks-editor-input-tip");d.val(g)},placeholder:function(d,
g){d.attr("placeholder",g);y.ie&&(d.on("blur",function(){l.trim(d.val())||(d.addClass("ks-editor-input-tip"),d.val(g))}),d.on("focus",function(){d.removeClass("ks-editor-input-tip");l.trim(d.val())===g&&d.val("")}))},normParams:function(d){var d=l.clone(d),g;for(g in d){var q=d[g];"function"===typeof q&&(d[g]=q())}return d},preventFocus:function(d){y.ie?d.unselectable():d.attr("onmousedown","return false;")},injectDom:function(d){l.mix(p,d);for(var g in d)(function(g){v.prototype[g]=function(){var h=
[].slice.call(arguments,0);h.unshift(this[0]);return(h=d[g].apply(null,h))&&(h.nodeType||l.isWindow(h))?new v(h):l.isArray(h)&&(h.__IS_NODELIST||h[0]&&h[0].nodeType)?new v(h):h}})(g)},addRes:function(){var d=this.__res=this.__res||[];d.push.apply(d,l.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],g=0;g<d.length;g++){var h=d[g];"function"===typeof h?h():h.destroy?h.destroy():h.remove&&h.remove()}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(d,
h){return h.toUpperCase()})+"Value"}};return w.Utils=u});
KISSY.add("editor/focusManager",["./base"],function(l,h){function v(){var g=this;g.__iframeFocus=q;d=g;u&&clearTimeout(u);u=setTimeout(function(){g.fire("focus")},30)}function w(){var g=this;g.__iframeFocus=x;d=k;u&&clearTimeout(u);u=setTimeout(function(){g.fire("blur")},30)}var p=h("./base"),y={},u,d,g={currentInstance:function(){return d},getInstance:function(d){return y[d]},register:function(d){y[d.get("id")]=d},add:function(d){this.register(d);d.get("window").on("focus",v,d).on("blur",w,d)},remove:function(d){delete y[d.get("id")];
d.get("window").detach("focus",v,d).detach("blur",w,d)}},q=!0,x=!1,k=null;p.focusManager=g;p.getInstances=function(){return y};return g});
KISSY.add("editor/dom",["node","./base","./utils"],function(l,h){function v(b,c){var f=b[c?"next":"prev"](void 0,1);if(f&&f[0].nodeType===g.ELEMENT_NODE){for(var i=[];f.attr("_ke_bookmark")||f._4eIsEmptyInlineRemovable(void 0);)if(i.push(f),f=c?f.next(void 0,1):f.prev(void 0,1),!f)return;if(b._4eIsIdentical(f,void 0)){for(var j=new w(c?b[0].lastChild:b[0].firstChild);i.length;)i.shift()._4eMove(b,!c,void 0);f._4eMoveChildren(b,!c,void 0);f.remove();j[0]&&j[0].nodeType===g.ELEMENT_NODE&&j._4eMergeSiblings()}}}
var w=h("node"),p=h("./base"),y=h("./utils"),u=p.XHTML_DTD,d=l.require("dom"),g=d.NodeType,q=l.UA,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};p.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var k=p.PositionType,t={block:1,"list-item":1,table:1,"table-row-group":1,
"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},o={hr:1},r=function(b){return b&&(b[0]||b)};y.injectDom({_4eSameLevel:function(b,c){var c=r(c),f=b.parentNode;return f&&f===c.parentNode},_4eIsBlockBoundary:function(b,c){var f=l.merge(o,c);return!(!t[d.css(b,"display")]&&!f[d.nodeName(b)])},_4eIndex:function(b,c){for(var f=b.parentNode.childNodes,i,j=-1,a=0;a<f.length;a++)if(i=f[a],!c||!(3===i.nodeType&&i.previousSibling&&
3===i.previousSibling.nodeType))if(j++,i===b)return j;return-1},_4eMove:function(b,c,f){c=r(c);f?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4eIsIdentical:function(b,c){if(!c)return!1;c=r(c);if(d.nodeName(b)!==d.nodeName(c))return!1;var f=b.attributes,i,j,a=c.attributes,e=f.length,m=a.length;if(e!==m)return!1;for(var s=0;s<e;s++)if(i=f[s],j=i.name,i.specified&&d.attr(b,j)!==d.attr(c,j))return!1;if(8>q.ieMode)for(s=0;s<m;s++)if(i=a[s],j=i.name,i.specified&&d.attr(b,j)!==d.attr(c,j))return!1;
return!0},_4eIsEmptyInlineRemovable:function(b){if(!u.$removeEmpty[d.nodeName(b)])return!1;for(var b=b.childNodes,c=0,f=b.length;c<f;c++){var i=b[c],j=i.nodeType;if(!(j===g.ELEMENT_NODE&&i.getAttribute("_ke_bookmark"))&&(j===g.ELEMENT_NODE&&!d._4eIsEmptyInlineRemovable(i)||j===d.NodeType.TEXT_NODE&&l.trim(i.nodeValue)))return!1}return!0},_4eMoveChildren:function(b,c,f){c=r(c);if(b!==c)if(f)for(;f=b.lastChild;)c.insertBefore(b.removeChild(f),c.firstChild);else for(;f=b.firstChild;)c.appendChild(b.removeChild(f))},
_4eMergeSiblings:function(b){b=new w(b);x[b.nodeName()]&&(v(b,!0),v(b))},_4eSplitText:function(b,c){var f=b.ownerDocument;if(b.nodeType===d.NodeType.TEXT_NODE){if(q.ie&&c===b.nodeValue.length){var i=f.createTextNode("");d.insertAfter(i,b);return i}i=b.splitText(c);f.documentMode&&(f=f.createTextNode(""),d.insertAfter(f,i),d.remove(f));return i}},_4eParents:function(b,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](b);while(b=b.parentNode);return f},_4eNextSourceNode:function(b,c,f,i){if(i&&
!i.call)var j=r(i),i=function(a){return a!==j};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType===g.ELEMENT_NODE&&i&&!1===i(b,!0))return null;c=b.nextSibling}for(;!c&&(a=a.parentNode);){if(i&&!1===i(a,!0))return null;c=a.nextSibling}return!c||i&&!1===i(c)?null:f&&f!==c.nodeType?d._4eNextSourceNode(c,!1,f,i):c},_4ePreviousSourceNode:function(b,c,f,i){if(i&&!i.call)var j=r(i),i=function(a){return a!==j};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType===g.ELEMENT_NODE&&i&&!1===i(b,!0))return null;c=b.previousSibling}for(;!c&&
(a=a.parentNode);){if(i&&!1===i(a,!0))return null;c=a.previousSibling}return!c||i&&!1===i(c)?null:f&&c.nodeType!==f?d._4ePreviousSourceNode(c,!1,f,i):c},_4eCommonAncestor:function(b,c){c=r(c);if(b===c)return b;if(d.contains(c,b))return c;var f=b;do if(d.contains(f,c))return f;while(f=f.parentNode);return null},_4eHasAttributes:9>q.ieMode?function(b){for(var c=b.attributes,f=0;f<c.length;f++){var i=c[f];switch(i.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(i.specified)return!0}}return!1}:
function(b){q.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4ePosition:function(b,c){var f=r(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(f);if(b===f)return k.POSITION_IDENTICAL;if(b.nodeType===g.ELEMENT_NODE&&f.nodeType===g.ELEMENT_NODE){if(d.contains(b,f))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(d.contains(f,b))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>f.sourceIndex?k.POSITION_DISCONNECTED:
b.sourceIndex<f.sourceIndex?k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var i=d._4eAddress(b),f=d._4eAddress(f),j=Math.min(i.length,f.length),a=0;a<=j-1;a++)if(i[a]!==f[a])return i[a]<f[a]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return i.length<f.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4eAddress:function(b,c){for(var f=[],i=b.ownerDocument.documentElement,j=b;j&&j!==i;)f.unshift(d._4eIndex(j,c)),j=j.parentNode;return f},_4eRemove:function(b,
c){var f=b.parentNode;if(f){if(c)for(var i;i=b.firstChild;)f.insertBefore(b.removeChild(i),b);f.removeChild(b)}return b},_4eTrim:function(b){d._4eLtrim(b);d._4eRtrim(b)},_4eLtrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType===d.NodeType.TEXT_NODE){var f=y.ltrim(c.nodeValue),i=c.nodeValue.length;if(f)f.length<i&&(d._4eSplitText(c,i-f.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4eRtrim:function(b){for(var c;c=b.lastChild;){if(c.type===d.NodeType.TEXT_NODE){var f=
y.rtrim(c.nodeValue),i=c.nodeValue.length;if(f)f.length<i&&(d._4eSplitText(c,f.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!q.ie&&!q.opera&&(c=b.lastChild)&&1===c.nodeType&&"br"===d.nodeName(c)&&b.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===d.NodeType.TEXT_NODE&&!l.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===d.NodeType.TEXT_NODE||"br"!==d.nodeName(c))c=q.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),
b.appendChild(c)},_4eSetMarker:function(b,c,f,i){var b=new w(b),j=b.data("list_marker_id")||b.data("list_marker_id",l.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[j]=b;a[f]=1;return b.data(f,i)},_4eClearMarkers:function(b,c,f){var b=new w(b),i=b.data("list_marker_names"),j=b.data("list_marker_id"),a;for(a in i)b.removeData(a);b.removeData("list_marker_names");f&&(b.removeData("list_marker_id"),delete c[j])},_4eCopyAttributes:function(b,
c,f){for(var c=new w(c),i=b.attributes,f=f||{},j=0;j<i.length;j++){var a=i[j],e=a.name.toLowerCase(),m;if(!(e in f))if("checked"===e&&(m=d.attr(b,e)))c.attr(e,m);else if(a.specified||q.ie&&a.value&&"value"===e)m=d.attr(b,e),null===m&&(m=a.nodeValue),c.attr(e,m)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},_4eIsEditable:function(b){b=d.nodeName(b);return(b=!u.$nonEditable[b]&&(u[b]||u.span))&&b["#text"]},_4eGetByAddress:function(b,c,f){for(var b=b.documentElement,i=0;b&&i<c.length;i++){var j=
c[i];if(f)for(var a=-1,e=0;e<b.childNodes.length;e++){var m=b.childNodes[e];if(!(!0===f&&3===m.nodeType&&m.previousSibling&&3===m.previousSibling.nodeType)&&(a++,a===j)){b=m;break}}else b=b.childNodes[j]}return b}})});
KISSY.add("editor/walker",["./base","node"],function(l,h){function v(b,c){if(this._.end)return g;var j,a=this.range,e,m=this.guard,s=this.type,z=b?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),g;if(!b&&!this._.guardLTR){var k=a.endContainer[0],h=k.childNodes[a.endOffset];this._.guardLTR=function(a,J){return J&&(k===a||"body"===x.nodeName(a))?!1:a!==h}}if(b&&!this._.guardRTL){var l=a.startContainer[0],r=0<a.startOffset&&l.childNodes[a.startOffset-
1]||null;this._.guardRTL=function(a,J){return J&&(l===a||"body"===x.nodeName(a))?!1:a!==r}}var J=b?this._.guardRTL:this._.guardLTR;e=m?function(a,b){return J(a,b)===d?d:m(a,b)}:J;this.current?j=this.current[z](d,s,e):b?(j=a.endContainer,0<a.endOffset?(j=new t(j[0].childNodes[a.endOffset-1]),e(j[0])===d&&(j=g)):j=e(j,u)===d?g:j._4ePreviousSourceNode(u,s,e,void 0)):(j=a.startContainer,j=new t(j[0].childNodes[a.startOffset]),j.length?e(j[0])===d&&(j=g):j=e(a.startContainer,u)===d?g:a.startContainer._4eNextSourceNode(u,
s,e,void 0));for(;j&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j[0])!==d){if(!c)return j}else if(c&&this.evaluator)return d;j=j[z](d,s,e)}this.end();return this.current=g}function w(b){for(var c,j=g;c=v.call(this,b);)j=c;return j}function p(b){this.range=b;this.guard=this.evaluator=g;this._={}}var y=h("./base"),u=!0,d=!1,g=null,q=l.UA,x=l.require("dom"),k=y.XHTML_DTD,t=h("node");l.augment(p,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,
u)},checkForward:function(){return v.call(this,d,u)!==d},checkBackward:function(){return v.call(this,u,u)!==d},lastForward:function(){return w.call(this)},lastBackward:function(){return w.call(this,u)},reset:function(){delete this.current;this._={}},_iterator:v});l.mix(p,{blockBoundary:function(b){return function(c){return!(c.nodeType===x.NodeType.ELEMENT_NODE&&x._4eIsBlockBoundary(c,b))}},bookmark:function(b,c){function j(a){return"span"===x.nodeName(a)&&x.attr(a,"_ke_bookmark")}return function(a){var e,
m;e=a.nodeType===x.NodeType.TEXT_NODE&&(m=a.parentNode)&&j(m);e=b?e:e||j(a);return!!(c^e)}},whitespaces:function(b){return function(c){c=c.nodeType===x.NodeType.TEXT_NODE&&!l.trim(c.nodeValue);return!!(b^c)}},invisible:function(b){var c=p.whitespaces();return function(j){j=c(j)||j.nodeType===x.NodeType.ELEMENT_NODE&&!j.offsetHeight;return!!(b^j)}}});var o=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,r=p.whitespaces(),b=p.bookmark(),c=function(c){var d=x.nodeName(c);return b(c)||r(c)||1===c.nodeType&&d in k.$inline&&
!(d in k.$empty)};y.Utils.injectDom({_4eGetBogus:function(b){b=new t(b);do b=b._4ePreviousSourceNode();while(b&&c(b[0]));return b&&(!q.ie?"br"===b.nodeName():3===b[0].nodeType&&o.test(b.text()))?b[0]:!1}});return y.Walker=p});
KISSY.add("editor/elementPath",["node","./base","./dom"],function(l,h){function v(h){for(var l=u,k=u,t=[];h;){if(h[0].nodeType===p.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=h);var o=h.nodeName();if(!k&&(!l&&d[o]&&(l=h),g[o])){var r;if(r=!l)if(r="div"===o){a:{r=h[0].childNodes;for(var b=0,c=r.length;b<c;b++){var f=r[b];if(f.nodeType===p.NodeType.ELEMENT_NODE&&y.$block[f.nodeName.toLowerCase()]){r=!0;break a}}r=!1}r=!r}r?l=h:k=h}t.push(h);if("body"===o)break}h=h.parent()}this.block=
l;this.blockLimit=k;this.elements=t}h("node");var w=h("./base");h("./dom");var p=l.require("dom"),y=w.XHTML_DTD,u=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},g={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={constructor:v,compare:function(d){var g=this.elements,d=d&&d.elements;if(!d||g.length!==d.length)return!1;for(var k=0;k<g.length;k++)if(!p.equals(g[k],d[k]))return!1;return!0},contains:function(d){for(var g=this.elements,
k=0;k<g.length;k++)if(g[k].nodeName()in d)return g[k];return u},toString:function(){var d=this.elements,g,k=[];for(g=0;g<d.length;g++)k.push(d[g].nodeName());return k.toString()}};return w.ElementPath=v});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./elementPath".split(","),function(l,h){function v(b){var c=b.nodeType!==i.NodeType.TEXT_NODE&&i.nodeName(b)in a.$removeEmpty,e=b.nodeType===i.NodeType.TEXT_NODE&&!l.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return c||e||b}function w(a){return!z(a)&&!D(a)}function p(a){var b=r;return function(c){if(D(c))return o;if(c.nodeType===i.NodeType.TEXT_NODE){if(l.trim(c.nodeValue).length)return r}else if(c.nodeType===i.NodeType.ELEMENT_NODE){c=
i.nodeName(c);if(!G[c])if(!a&&!j.ie&&c==="br"&&!b)b=o;else return r}return o}}function y(a,b){var c=a.startContainer,e=a.endContainer,n=a.startOffset,j=a.endOffset,d,f=r,s=r,z,k=a.document,Q;b>0&&(z=k.createDocumentFragment());if(a.collapsed)return z;a.optimizeBookmark();if(e[0].nodeType===i.NodeType.TEXT_NODE){s=o;e=e._4eSplitText(j)}else if(e[0].childNodes.length>0)if(j>=e[0].childNodes.length){e=new g(e[0].appendChild(k.createTextNode("")));Q=o}else e=new g(e[0].childNodes[j]);if(c[0].nodeType===
i.NodeType.TEXT_NODE){f=o;c._4eSplitText(n)}else if(n)if(n>=c[0].childNodes.length){c=new g(c[0].appendChild(k.createTextNode("")));d=o}else c=new g(c[0].childNodes[n].previousSibling);else{d=new g(k.createTextNode(""));c.prepend(d);c=d;d=o}var h=c._4eParents(),L=e._4eParents();h.each(function(a,b){h[b]=a});L.each(function(a,b){L[b]=a});for(var I,l,k=0;k<h.length;k++){I=h[k];l=L[k];if(!I.equals(l))break}for(var n=z,B,D,A=k;A<h.length;A++){B=h[A];j=b>0&&!B.equals(c)?n.appendChild(B.clone()[0]):null;
B=B[0].nextSibling;D=L[A];for(var t=e[0],p=D&&D[0];B;){if(p===B||t===B)break;D=B.nextSibling;if(b===2)n.appendChild(B.cloneNode(o));else{if(m[B.nodeName.toLowerCase()]){var q=B.cloneNode(o);B.innerHTML="";B=q}else i._4eRemove(B);b===1&&n.appendChild(B)}B=D}j&&(n=j)}for(n=z;k<L.length;k++){B=L[k];j=b>0&&!B.equals(e)?n.appendChild(B.clone()[0]):null;if(!h[k]||!B._4eSameLevel(h[k]))for(B=B[0].previousSibling;B;){D=B.previousSibling;if(b===2)n.insertBefore(B.cloneNode(o),n.firstChild);else{i._4eRemove(B);
b===1&&n.insertBefore(B,n.firstChild)}B=D}j&&(n=j)}if(b===2){if(f){I=c[0];if(I.nodeType===i.NodeType.TEXT_NODE&&I.nextSibling&&I.nextSibling.nodeType===i.NodeType.TEXT_NODE){I.data=I.data+I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}if(s){s=e[0];if(s.nodeType===i.NodeType.TEXT_NODE&&s.previousSibling&&s.previousSibling.nodeType===i.NodeType.TEXT_NODE){s.previousSibling.data=s.previousSibling.data+s.data;s.parentNode.removeChild(s)}}}else{if(I&&l&&(!c._4eSameLevel(I)||!e._4eSameLevel(l))){s=
I._4eIndex();d&&I._4eSameLevel(c)&&s--;a.setStart(I.parent(),s+1)}a.collapse(o)}d&&c.remove();Q&&e.remove();return z}function u(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function d(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=b;this.collapsed=o;this.document=a}h("./dom");var g=h("node"),q=h("./utils"),x=h("./walker"),k=h("./base"),t=h("./elementPath");k.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=true,r=false,b=null,c=k.RangeType,f=k.PositionType,i=l.require("dom"),j=l.UA,a=k.XHTML_DTD,e=g.all,m={td:1},s={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},z=new x.whitespaces,D=new x.bookmark,A=x.whitespaces(o),C=x.bookmark(false,true),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};l.augment(d,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!==i.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
b=this.endOffset;a[0].nodeType!==i.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);b&&b.nodeName()==="span"&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&s[a.nodeName()]){a=a.parent();b=a._4eIndex()}this.startContainer=a;this.startOffset=b;if(!this.endContainer){this.endContainer=a;this.endOffset=b}u(this)},setEnd:function(a,b){if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&s[a.nodeName()]){a=a.parent();b=a._4eIndex()+1}this.endContainer=a;this.endOffset=b;if(!this.startContainer){this.startContainer=
a;this.startOffset=b}u(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===i.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}u(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
i.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}u(this)},cloneContents:function(){return y(this,2)},deleteContents:function(){return y(this,0)},extractContents:function(){return y(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=o},clone:function(){var a=new d(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==i.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==i.NodeType.ELEMENT_NODE)return b;var c=new x(a);c.evaluator=function(a){return A(a)&&C(a)};a=c.next();c.reset();
c=c.previous();return a&&a.equals(c)?a:b},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,e=this.clone(),j=this.startContainer,n=this.endContainer,d=this.startOffset,m=this.endOffset,s=o,g,f,k=o;if(j&&j[0].nodeType===i.NodeType.TEXT_NODE)if(d)if(d>=j[0].nodeValue.length)e.setStartAfter(j);else{e.setStartBefore(j);s=r}else e.setStartBefore(j);if(n&&n[0].nodeType===i.NodeType.TEXT_NODE)if(m)if(m>=n[0].nodeValue.length)e.setEndAfter(n);else{e.setEndAfter(n);k=r}else e.setEndBefore(n);
if(s||k){f=new x(e);f.evaluator=function(b){return b.nodeType===(a===c.SHRINK_ELEMENT?i.NodeType.ELEMENT_NODE:i.NodeType.TEXT_NODE)};f.guard=function(b,e){if(a===c.SHRINK_ELEMENT&&b.nodeType===i.NodeType.TEXT_NODE||e&&b===g)return r;!e&&b.nodeType===i.NodeType.ELEMENT_NODE&&(g=b);return o}}if(s)(e=f[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(k){f.reset();(f=f[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(f,
b?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return s||k}},createBookmark2:function(a){var c=this.startContainer,e=this.endContainer,j=this.startOffset,n=this.endOffset,d,m;if(!c||!e)return{start:0,end:0};if(a){if(c[0].nodeType===i.NodeType.ELEMENT_NODE)if((d=new g(c[0].childNodes[j]))&&d[0]&&d[0].nodeType===i.NodeType.TEXT_NODE&&j>0&&d[0].previousSibling.nodeType===i.NodeType.TEXT_NODE){c=d;j=0}for(;c[0].nodeType===i.NodeType.TEXT_NODE&&(m=c.prev(void 0,1))&&m[0].nodeType===i.NodeType.TEXT_NODE;){c=
m;j=j+m[0].nodeValue.length}if(!this.collapsed){if(e[0].nodeType===i.NodeType.ELEMENT_NODE)if((d=new g(e[0].childNodes[n]))&&d[0]&&d[0].nodeType===i.NodeType.TEXT_NODE&&n>0&&d[0].previousSibling.nodeType===i.NodeType.TEXT_NODE){e=d;n=0}for(;e[0].nodeType===i.NodeType.TEXT_NODE&&(m=e.prev(void 0,1))&&m[0].nodeType===i.NodeType.TEXT_NODE;){e=m;n=n+m[0].nodeValue.length}}}return{start:c._4eAddress(a),end:this.collapsed?b:e._4eAddress(a),startOffset:j,endOffset:n,normalized:a,is2:o}},createBookmark:function(a){var e,
j,d,n,m=this.collapsed;e=new g("<span>",b,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");if(a){d=l.guid("ke_bm_");e.attr("id",d+"S")}if(!m){j=e.clone();j.html("&nbsp;");a&&j.attr("id",d+"E");n=this.clone();n.collapse();n.insertNode(j)}n=this.clone();n.collapse(o);n.insertNode(e);if(j){this.setStartAfter(e);this.setEndBefore(j)}else this.moveToPosition(e,c.POSITION_AFTER_END);return{startNode:a?d+"S":e,endNode:a?d+"E":j,serializable:a,collapsed:m}},moveToPosition:function(a,
b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var e=this.startContainer,c=this.startOffset,n=this.collapsed;if((!a||n)&&e[0]&&e[0].nodeType===i.NodeType.TEXT_NODE){if(c)if(c>=e[0].nodeValue.length){c=e._4eIndex()+1;e=e.parent()}else{var j=e._4eSplitText(c),c=e._4eIndex()+1,e=e.parent();if(i.equals(this.startContainer,this.endContainer))this.setEnd(j,this.endOffset-this.startOffset);else if(i.equals(e,this.endContainer))this.endOffset=this.endOffset+1}else{c=e._4eIndex();e=e.parent()}this.setStart(e,
c);if(n){this.collapse(o);return}}e=this.endContainer;c=this.endOffset;if(!b&&!n&&e[0]&&e[0].nodeType===i.NodeType.TEXT_NODE){if(c){c>=e[0].nodeValue.length||e._4eSplitText(c);c=e._4eIndex()+1}else c=e._4eIndex();e=e.parent();this.setEnd(e,c)}},insertNode:function(a){this.optimizeBookmark();this.trim(r,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=e(this.document);
if(a.is2){var c=b._4eGetByAddress(a.start,a.normalized),j=a.startOffset,b=a.end&&b._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,j);b?this.setEnd(b,a):this.collapse(o)}else{c=(j=a.serializable)?l.one("#"+a.startNode,b):a.startNode;a=j?l.one("#"+a.endNode,b):a.endNode;this.setStartBefore(c);c._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(o)}},getCommonAncestor:function(a,b){var e=this.startContainer,c=this.endContainer,e=e[0]===c[0]?a&&e[0].nodeType===
i.NodeType.ELEMENT_NODE&&this.startOffset===this.endOffset-1?new g(e[0].childNodes[this.startOffset]):e:e._4eCommonAncestor(c);return b&&e[0].nodeType===i.NodeType.TEXT_NODE?e.parent():e},enlarge:function(){function a(b,c,j,n){var d=b[c?"startContainer":"endContainer"],m,s=c?0:1,f=0,g=c?"previousSibling":"nextSibling";m=b[c?"startOffset":"endOffset"];if(d[0].nodeType===i.NodeType.TEXT_NODE){if(c){if(m)return}else if(m<d[0].nodeValue.length)return;m=d[0][g];d=d[0].parentNode}else{m=d[0].childNodes[m+
(c?-1:1)]||null;d=d[0]}for(;d;){for(;m;)if(z(m)||D(m))m=m[g];else break;if(m){if(!f)b[c?"setStartAfter":"setEndBefore"](e(m));break}d=e(d);if(d.nodeName()==="body")break;if(f||d.equals(n)){j[s]=d;f=1}else b[c?"setStartBefore":"setEndAfter"](d);m=d[0][g];d=d[0].parentNode}}return function(j){var m;switch(j){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var j=this.getCommonAncestor(),s=[];a(this,1,s,j);a(this,0,s,j);if(s[0]&&s[1]){j=s[0].contains(s[1])?s[1]:s[0];this.setStartBefore(j);this.setEndAfter(j)}break;
case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:m=new d(this.document);s=new g(this.document.body);m.setStartAt(s,c.POSITION_AFTER_START);m.setEnd(this.startContainer,this.startOffset);m=new x(m);var n,f,k=x.blockBoundary(j===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:b),z=function(a){var b=k(a);b||(n=e(a));return b},h=function(a){var b=z(a);!b&&i.nodeName(a)==="br"&&(f=e(a));return b};m.guard=z;m=m.lastBackward();n=n||s;this.setStartAt(n,n.nodeName()!=="br"&&(!m&&this.checkStartOfBlock()||
m&&n.contains(m))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);m=this.clone();m.collapse();m.setEndAt(s,c.POSITION_BEFORE_END);m=new x(m);m.guard=j===c.ENLARGE_LIST_ITEM_CONTENTS?h:z;n=b;m=m.lastForward();n=n||s;this.setEndAt(n,!m&&this.checkEndOfBlock()||m&&n.contains(m)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),checkStartOfBlock:function(){var a=this.startContainer,b=this.startOffset;if(b&&a[0].nodeType===i.NodeType.TEXT_NODE&&l.trim(a[0].nodeValue.substring(0,b)).length)return r;
this.trim();a=new t(this.startContainer);b=this.clone();b.collapse(o);b.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new x(b);a.evaluator=p(o);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,b=this.endOffset;if(a[0].nodeType===i.NodeType.TEXT_NODE&&l.trim(a[0].nodeValue.substring(b)).length)return r;this.trim();a=new t(this.endContainer);b=this.clone();b.collapse(r);b.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new x(b);a.evaluator=p(r);return a.checkForward()},
checkBoundaryOfElement:function(a,b){var e=this.clone();e[b===c.START?"setStartAt":"setEndAt"](a,b===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);e=new x(e);e.evaluator=v;return e[b===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,j=this.endOffset,m;if(a[0].nodeType===i.NodeType.ELEMENT_NODE){m=a[0].childNodes.length;if(m>c)a=e(a[0].childNodes[c]);else if(m===0)a=a._4ePreviousSourceNode();else{for(a=
a[0];a.lastChild;)a=a.lastChild;a=e(a);a=a._4eNextSourceNode()||a}}if(b[0].nodeType===i.NodeType.ELEMENT_NODE){m=b[0].childNodes.length;if(m>j)b=e(b[0].childNodes[j])._4ePreviousSourceNode(o);else if(m===0)b=b._4ePreviousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=e(b)}}a._4ePosition(b)&f.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var m=this.createBookmark(),d=e(this.document.createElement(b));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);
d[0].appendChild(this.extractContents());d._4eTrim();j.ie||d._4eAppendBogus();this.insertNode(d);this.moveToBookmark(m);return d},splitBlock:function(a){var e=new t(this.startContainer),m=new t(this.endContainer),d=e.block,n=m.block,s=b;if(!e.blockLimit.equals(m.blockLimit))return b;if(a!=="br"){if(!d){d=this.fixBlock(o,a);n=(new t(this.endContainer)).block}n||(n=this.fixBlock(r,a))}a=d&&this.checkStartOfBlock();e=n&&this.checkEndOfBlock();this.deleteContents();if(d&&d[0]===n[0])if(e){s=new t(this.startContainer);
this.moveToPosition(n,c.POSITION_AFTER_END);n=b}else if(a){s=new t(this.startContainer);this.moveToPosition(d,c.POSITION_BEFORE_START);d=b}else{n=this.splitElement(d);!j.ie&&!l.inArray(d.nodeName(),["ul","ol"])&&d._4eAppendBogus()}return{previousBlock:d,nextBlock:n,wasStartOfBlock:a,wasEndOfBlock:e,elementPath:s}},splitElement:function(a){if(!this.collapsed)return b;this.setEndAt(a,c.POSITION_BEFORE_END);var e=this.extractContents(),m=a.clone(r);m[0].appendChild(e);m.insertAfter(a);this.moveToPosition(a,
c.POSITION_AFTER_END);return m},moveToElementEditablePosition:function(a,b){for(var e=0;a;){if(a[0].nodeType===i.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);e=1;break}if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);e=1}var m=a,d=e,j=void 0;m[0].nodeType===i.NodeType.ELEMENT_NODE&&m._4eIsEditable()&&(j=m[b?"last":"first"](w,1));!d&&!j&&(j=m[b?"prev":"next"](w,1));a=j}return!!e},
selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType===i.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(b){var e,c,m,j=b.nodeName();e=a.$block[j];this.deleteContents();if(e){for(e=this.getCommonAncestor(r,o);(c=a[e.nodeName()])&&(!c||!c[j]);){var d=e.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(e);this.collapse(o);e.remove()}else m=e;e=d}m&&this.splitElement(m)}this.insertNode(b)}});q.injectDom({_4eBreakParent:function(a,
b){var b=e(b),a=e(a),c,m=new k.Range(a[0].ownerDocument);m.setStartAfter(a);m.setEndAfter(b);c=m.extractContents();m.insertNode(a.remove());a.after(c)}});return k.Range=d});
KISSY.add("editor/selection",["node","./walker","./range","./base"],function(l,h){function v(b){this.document=b;this._={cache:{}};if(r)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!==b||a.parentElement&&a.parentElement().ownerDocument!==b)this.isInvalid=g}catch(e){this.isInvalid=g}}function w(b){b=new v(b);return!b||b.isInvalid?q:b}var p=h("node"),y=h("./walker"),u=h("./range"),d=h("./base");d.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};
var g=!0,q=null,x=l.UA,k=l.require("dom"),t=d.SelectionType,o=d.RangeType,r=document.selection,b={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};l.augment(v,{getNative:!r?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=k.getWindow(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!r?function(){var c=this._.cache;
if(c.type)return c.type;var a=t.SELECTION_TEXT,e=this.getNative();if(e){if(1===e.rangeCount){var e=e.getRangeAt(0),m=e.startContainer;m===e.endContainer&&m.nodeType===k.NodeType.ELEMENT_NODE&&1===Number(e.endOffset-e.startOffset)&&b[m.childNodes[e.startOffset].nodeName.toLowerCase()]&&(a=t.SELECTION_ELEMENT)}}else a=t.SELECTION_NONE;return c.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=t.SELECTION_NONE;try{var e=this.getNative(),c=e.type;"Text"===c&&(a=t.SELECTION_TEXT);"Control"===
c&&(a=t.SELECTION_ELEMENT);e.createRange().parentElement&&(a=t.SELECTION_TEXT)}catch(d){}return b.type=a},getRanges:r?function(){var b=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),d=c.childNodes,j,f=0;f<d.length;f++){var g=d[f];if(g.nodeType===k.NodeType.ELEMENT_NODE){j=a.duplicate();j.moveToElementText(g);var g=j.compareEndPoints("StartToStart",a),i=j.compareEndPoints("EndToStart",a);j.collapse();if(0<g)break;else{if(!g||1===i&&-1===g)return{container:c,offset:f};if(!i)return{container:c,
offset:f+1}}j=q}}j||(j=a.duplicate(),j.moveToElementText(c),j.collapse(!1));j.setEndPoint("StartToStart",a);j=(""+j.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<j;)j-=d[--f].nodeValue.length}catch(h){j=0}return 0===j?{container:c,offset:f}:{container:d[f],offset:-j}};return function(a){var e=this._.cache;if(e.ranges&&!a)return e.ranges;var c=this.getNative(),a=c&&c.createRange(),d=this.getType();if(!c)return[];if(d===t.SELECTION_TEXT)return c=new u(this.document),d=b(a,g),c.setStart(new p(d.container),
d.offset),d=b(a),c.setEnd(new p(d.container),d.offset),e.ranges=[c],[c];if(d===t.SELECTION_ELEMENT){e=e.ranges=[];for(d=0;d<a.length;d++){for(var f=a.item(d),i=f.parentNode,k=0,c=new u(this.document);k<i.childNodes.length&&i.childNodes[k]!==f;k++);c.setStart(new p(i),k);c.setEnd(new p(i),k+1);e.push(c)}return e}e.ranges=[];return[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var f=c.getRangeAt(d),g=new u(this.document);
g.setStart(new p(f.startContainer),f.startOffset);g.setEnd(new p(f.endContainer),f.endOffset);b.push(g)}return a.ranges=b},getStartElement:function(){var b=this._.cache;if(void 0!==b.startElement)return b.startElement;var a,c=this.getNative();switch(this.getType()){case t.SELECTION_ELEMENT:return this.getSelectedElement();case t.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();g;)if(a=d.startContainer,d.startOffset===(a[0].nodeType===k.NodeType.ELEMENT_NODE?a[0].childNodes.length:
a[0].nodeValue.length)&&!a._4eIsBlockBoundary())d.setStartAfter(a);else break;a=d.startContainer;if(a[0].nodeType!==k.NodeType.ELEMENT_NODE)return a.parent();a=new p(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!==k.NodeType.ELEMENT_NODE)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType===k.NodeType.ELEMENT_NODE;)a=new p(d),d=d.firstChild;return a}if(r)d=c.createRange(),d.collapse(g),a=new p(d.parentElement());else{if((a=c.anchorNode)&&a.nodeType!==k.NodeType.ELEMENT_NODE)a=a.parentNode;
a&&(a=new p(a))}}return b.startElement=a},getSelectedElement:function(){var c,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;r&&(c=this.getNative().createRange(),c=c.item&&c.item(0));var e;if(c)e=new p(c);else{c=this.getRanges()[0];for(var d,f=2;f&&(!(e=c.getEnclosedNode())||!(e[0].nodeType===k.NodeType.ELEMENT_NODE&&b[e.nodeName()]&&(d=e)));f--)c.shrink(o.SHRINK_ELEMENT);e=d}c=e;return a.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(b){var a,c=
this.document;if(r)try{a=c.body.createControlRange(),a.addElement(b[0]),a.select()}catch(d){a=c.body.createTextRange(),a.moveToElementText(b[0]),a.select()}finally{}else a=c.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);this.reset()},selectRanges:function(b){if(r){if(1<b.length){var a=b[b.length-1];b[0].setEnd(a.endContainer,a.endOffset);b.length=1}b[0]&&b[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var d=
b[c],f=this.document.createRange(),g=d.startContainer;if(d.collapsed&&(x.gecko&&1.09>x.gecko||x.opera||x.webkit)&&g[0].nodeType===k.NodeType.ELEMENT_NODE&&!g[0].childNodes.length)g[0].appendChild(this.document.createTextNode(x.webkit?"\u200b":"")),d.startOffset++,d.endOffset++;f.setStart(g[0],d.startOffset);f.setEnd(d.endContainer[0],d.endOffset);a.addRange(f)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));return a},createBookmarks:function(b,
a){for(var c=[],d=this.document,f,a=a||this.getRanges(),i=a.length,h=0;h<i;h++){c.push(f=a[h].createBookmark(b,g));var r=(b=f.serializable)?l.one("#"+f.startNode,d):f.startNode;f=b?l.one("#"+f.endNode,d):f.endNode;for(var t=h+1;t<i;t++){var p=a[t],o=p.startContainer,q=p.endContainer;k.equals(o,r.parent())&&p.startOffset++;k.equals(o,f.parent())&&p.startOffset++;k.equals(q,r.parent())&&p.endOffset++;k.equals(q,f.parent())&&p.endOffset++}}return c},selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var d=
new u(this.document);d.moveToBookmark(b[c]);a.push(d)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4eCommonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var b=this.getNative();r?b&&b.clear():b&&b.removeAllRanges()}});var c={table:1,tbody:1,tr:1},f=y.whitespaces(g),
i=/\ufeff|\u00a0/;u.prototype.select=!r?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType===k.NodeType.ELEMENT_NODE&&!b[0].childNodes.length&&(b[0].appendChild(this.document.createTextNode(x.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(g),a.setEnd(this.endContainer[0],this.endOffset);
else throw c;}b=w(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,d,m;if(this.startContainer[0]===this.endContainer[0]&&1===this.endOffset-this.startOffset){var s=this.startContainer[0].childNodes[this.startOffset];if(s.nodeType===k.NodeType.ELEMENT_NODE){(new v(this.document)).selectElement(new p(s));return}}(this.startContainer[0].nodeType===k.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===k.NodeType.ELEMENT_NODE&&
this.endContainer.nodeName()in c)&&this.shrink(o.SHRINK_ELEMENT,g);var h=this.createBookmark(),s=h.startNode,l;a||(l=h.endNode);h=this.document.body.createTextRange();h.moveToElementText(s[0]);h.moveStart("character",1);if(l)b=this.document.body.createTextRange(),b.moveToElementText(l[0]),h.setEndPoint("EndToEnd",b),h.moveEnd("character",-1);else{for(d=s[0].nextSibling;d&&!f(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(i))&&(b||!s[0].previousSibling||s[0].previousSibling&&"br"===k.nodeName(s[0].previousSibling));
m=new p(this.document.createElement("span"));m.html("&#65279;");m.insertBefore(s);d&&k.insertBefore(this.document.createTextNode("\ufeff"),s[0]||s)}this.setStartBefore(s);s._4eRemove();if(a){if(d?(h.moveStart("character",-1),h.select(),this.document.selection.clear()):h.select(),m)this.moveToPosition(m,o.POSITION_BEFORE_START),m._4eRemove()}else this.setEndBefore(l),l._4eRemove(),h.select()};v.getSelection=w;return d.Selection=v});
KISSY.add("editor/clipboard",["node","./base","./range","./selection"],function(l,h){function v(a){this.editor=a;this._init()}function w(a){var b=a.get("document")[0],c=a.getSelection(),d;if(c.getType()===x.SELECTION_ELEMENT&&(d=c.getSelectedElement())){var a=c.getRanges()[0],f=k(b.createTextNode(""));f.insertBefore(d);a.setStartBefore(f);a.setEndAfter(d);c.selectRanges([a]);setTimeout(function(){d.parent()&&(f.remove(),c.selectElement(d))},0)}}function p(a){if(t.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(t.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(t.gecko||t.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function y(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(t.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(t.gecko||t.opera)t.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function u(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"");-1!==a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,b){return b.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(b=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!b&&p(a)&&(a=y(a));return a}var d=h("node"),g=h("./base"),q=h("./range"),x=h("./selection"),k=d.all,
t=l.UA,o=11>t.ieMode,r=o?"beforepaste":"paste",b=g.RangeType;l.augment(v,{_init:function(){var a=this,b=a.editor,c=b.get("document"),d=c.one("body"),g=function(a){this.type=a};g.prototype={exec:function(b){var c=this.type;b.focus();setTimeout(function(){o&&("cut"===c?w(b):"paste"===c&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));f(b,c)||alert(i[c])},0)}};d.on(r,a._getClipboardDataFromPasteBin,a);o&&(d.on("paste",a._iePaste,a),c.on("keydown",a._onKeyDown,a),c.on("contextmenu",function(){a._isPreventBeforePaste=
1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));b.addCommand("copy",new g("copy"));b.addCommand("cut",new g("cut"));b.addCommand("paste",new g("paste"))},_onKeyDown:function(a){this.editor.get("mode")===g.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86===a.keyCode||a.shiftKey&&45===a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,c=this.editor;if("paste"===a){this._isPreventBeforePaste=1;try{b=c.get("document")[0].queryCommandEnabled(a)}catch(d){}this._isPreventBeforePaste=
0}else b=(a=(a=c.getSelection())&&a.getRanges())&&!(1===a.length&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;this._isPreventPaste||(a.preventDefault(),b.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,c=a.get("document")[0];if(!c.getElementById("ke-paste-bin")){var d=
a.getSelection(),f=new q(c),g=k(t.webkit?"<body></body>":"<div></div>",c);g.attr("id","ke-paste-bin");t.webkit&&g[0].appendChild(c.createTextNode("\u200b"));c.body.appendChild(g[0]);g.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var j=d.createBookmarks();f.setStartAt(g,b.POSITION_AFTER_START);f.setEndAt(g,b.POSITION_BEFORE_END);f.select(!0);setTimeout(function(){var b,c=g;g=t.webkit&&(b=g.first())&&b.hasClass("Apple-style-span")?
b:g;d.selectBookmarks(j);var e=g.html();c.remove();if(e=u(e))b=a.fire("paste",{html:e}),!1!==b&&(void 0!==b&&(e=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(e)?l.use("editor/plugin/word-filter",function(b,c){a.insertHtml(c.toDataFormat(e,a))}):a.insertHtml(e))},0)}}}});var c=function(a,b){var c=a.get("document")[0],d=k(c.body),f=!1,g=function(){f=!0};d.on(b,g);(7<t.ieMode?c:c.selection.createRange()).execCommand(b);d.detach(b,g);return f},f=o?function(a,b){return c(a,b)}:function(a,
b){try{return a.get("document")[0].execCommand(b)}catch(c){return!1}},i={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},j={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var b;a.docReady(function(){b=new v(a)});var c={copy:1,cut:1,paste:1},d=["copy","cut","paste"];a.on("contextmenu",function(f){var g=f.contextmenu;if(!g.__copyFix){g.__copyFix=1;for(f=0;f<d.length;f++)g.addChild({content:j[d[f]],
value:d[f]});g.on("click",function(b){var d=b.target.get("value");c[d]&&(g.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var i=g.get("children"),f=i.length-1;f--;0<=f){var k=i[f],h;h=k.get?k.get("value"):k.value;c[h]&&(h=!b._stateFromNamedCommand(h),k.set?k.set("disabled",h):k.disabled=h)}})}}});
KISSY.add("editor/enterKey",["node","./walker","./base","./elementPath"],function(l,h){function v(k){var h;h=k.getSelection().getRanges();for(var o=h.length-1;0<o;o--)h[o].deleteContents();h=h[0];o=h.document;if(h.checkStartOfBlock()&&h.checkEndOfBlock()){var r=(new d(h.startContainer)).block;if(r&&("li"===r.nodeName()||"li"===r.parent().nodeName()))return k.hasCommand("outdent")?(k.execCommand("save"),k.execCommand("outdent"),k.execCommand("save"),!0):!1}var b=h.splitBlock("p");if(!b)return!0;var k=
b.previousBlock,r=b.nextBlock,c=b.wasStartOfBlock,f=b.wasEndOfBlock,i;if(r)i=r.parent(),"li"===i.nodeName()&&(r._4eBreakParent(i),r._4eMove(r.next(),!0));else if(k&&(i=k.parent())&&"li"===i.nodeName())k._4eBreakParent(i),h.moveToElementEditablePosition(k.next()),k._4eMove(k.prev());var j;if(!c&&!f){if("li"===r.nodeName()&&(i=r.first(y.invisible(!0)))&&l.inArray(i.nodeName(),["ul","ol"]))(g?new p(o.createTextNode("\u00a0")):new p(o.createElement("br"))).insertBefore(i);r&&h.moveToElementEditablePosition(r)}else{if(k){if("li"===
k.nodeName()||!q.test(k.nodeName()))j=k.clone()}else r&&(j=r.clone());j||(j=new p("<p>",null,o));if(i=b.elementPath)for(var b=0,a=i.elements.length;b<a;b++){var e=i.elements[b];if(e.equals(i.block)||e.equals(i.blockLimit))break;x.$removeEmpty[e.nodeName()]&&(e=e.clone(),j._4eMoveChildren(e),j.append(e))}g||j._4eAppendBogus();h.insertNode(j);if(g&&c&&(!f||!k[0].childNodes.length))h.moveToElementEditablePosition(f?k:j),h.select();h.moveToElementEditablePosition(c&&!f?r:j)}g||(r?(j=new p(o.createElement("span")),
j.html("&nbsp;"),h.insertNode(j),j.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),h.deleteContents()):j.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));h.select();return!0}function w(d){d.get("document").on("keydown",function(g){if(13===g.keyCode&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey){d.execCommand("save");var h=d.execCommand("enterBlock");d.execCommand("save");!1!==h&&g.preventDefault()}})}var p=h("node"),y=h("./walker"),
u=h("./base"),d=h("./elementPath"),g=11>l.UA.ieMode,q=/^h[1-6]$/,x=u.XHTML_DTD;return{init:function(d){d.addCommand("enterBlock",{exec:v});d.docReady(function(){w(d)})}}});
KISSY.add("editor/htmlDataProcessor",["./base","html-parser"],function(l,h){var v=h("./base"),w=h("html-parser"),p=11>l.UA.ieMode;return{init:function(h){function u(a){var a=a.childNodes,b,c,d,e=a.length;if(e){d=1;for(b=0;b<e;b++)if(c=a[b],c.nodeType!==l.require("dom").NodeType.TEXT_NODE||c.nodeValue){d=0;break}return d?!1:void 0}return!1}function d(a){return a.replace(r,function(a,c,d){return"<"+c+d.replace(b,function(a,b){return-1===d.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function g(a){return a.replace(f,
function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function q(a){return a.replace(i,function(a,b){return l.urlDecode(b)})}var x=l.Node,k=l.UA,t=new w.Filter,o=new w.Filter;(function(){function a(b){b=w.serialize(b);return new w.Comment(c+encodeURIComponent(b).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:u}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:u,strong:u,em:u,del:u,u:u},attributes:{style:function(a){if(!l.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,c.length)===c)return a=l.trim(l.urlDecode(a.substr(c.length))),w.parse(a).childNodes[0]}};p&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});t.addRules(d);o.addRules(b)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,d=b[c-1];d&&3===d.nodeType&&!l.trim(d.nodeValue);)d=b[--c];return d}function b(c){var d=a(c);d&&(1===d.nodeType&&"br"===d.nodeName?c.removeChild(d):
3===d.nodeType&&f.test(d.nodeValue)&&c.removeChild(d))}function c(b){var d=a(b);return!d||"form"===b.nodeName&&"input"===d.nodeName}function d(a){b(a);c(a)&&(p||a.appendChild(new w.Tag("br")))}function e(a){b(a);c(a)&&a.appendChild(new w.Text("\u00a0"))}var f=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,g=v.XHTML_DTD,j=l.merge(g.$block,g.$listItem,g.$tableContent),h;for(h in j)"br"in g[h]||delete j[h];delete j.pre;var g={tags:{}},i={tags:{}};for(h in j)g.tags[h]=d,i.tags[h]=e;o.addRules(g);t.addRules(i)})();
t.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var r=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",f=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,i=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,j=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,a=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,
e=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;h.htmlDataProcessor={dataFilter:o,htmlFilter:t,toHtml:function(a){k.webkit&&(a=a.replace(/\u200b/g,""));var b=new w.BeautifyWriter;(new w.Parser(a)).parse().writeHtml(b,t);return a=b.getHtml()},toDataFormat:function(b,c){var c=c||o,b=g(b),b=d(b),b=b.replace(j,"$1ke:$2"),b=b.replace(e,"<ke:$1$2></ke:$1>"),f=new x("<div>");f.html("a"+b);b=f.html().substr(1);b=b.replace(a,"$1$2");b=q(b);f=new w.BasicWriter;(new w.Parser(b)).parse().writeHtml(f,c);return b=
f.getHtml()},toServer:function(a){var b=new w.MinifyWriter;(new w.Parser(a)).parse().writeHtml(b,t);return b.getHtml()}}}}});
KISSY.add("editor/selectionFix",["./base","./selection","node"],function(l,h){function v(d){function b(a,b){var c=e.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=x}return c}function c(){var b=e.selection.createRange();h&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&h.select();a.detach("mouseup",c);a.detach("mousemove",f);h=g=0}function f(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else c()}
var g,j=d.get("window")[0],a=d.get("document"),e=a[0],h;a.on("mousedown contextmenu",function(d){var k=e.documentElement;if(d.target===k&&(g&&c(),!(k.scrollHeight>k.clientHeight)&&(g=1,h=b(d.pageX,d.pageY))))a.on("mouseup",c),a.on("mousemove",f),j.focus(),h.select()})}function w(h){function b(d){if(a){var e=h.getSelection(),f=e&&e.getType(),i=e&&c.selection;if(d&&i&&f===o.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(g)},50);else{var k;if(!i||!i.type||!("Control"!==
i.type&&(k=i.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))j=i&&e.getRanges()[0],h.checkSelectionChange()}}}var c=h.get("document")[0],f=new d(c.body),i=new d(c.documentElement);if(8>l.UA.ieMode)i.on("click",function(a){"html"===(new d(a.target)).nodeName()&&h.getSelection().getNative().createRange().select()});var j,a,e=g;i.on("mousedown",function(){e=q});i.on("mouseup",function(){e=g});f.on("focusin",function(a){if("body"===(new d(a.target)).nodeName()&&
j){try{e&&j.select()}catch(b){}j=x}});f.on("focus",function(){a=g;b()});f.on("beforedeactivate",function(b){b.relatedTarget||(a=q,e=g)});f.on("mousedown",function(){a=q});f.on("mouseup",function(){a=g;setTimeout(function(){b(g)},0)});f.on("keydown",function(){a=q});f.on("keyup",function(){a=g;setTimeout(function(){b()},0)})}function p(d){d.get("document").on("mouseup keyup selectionchange",function(){d.checkSelectionChange()})}function y(h){function b(a){var b=u.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(a){return i(a)&&j(a)}var f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,i=u.Walker.whitespaces(g),j=u.Walker.bookmark(q,g),a=function(a){return i(a)&&8!==a.nodeType};h.on("selectionChange",function(e){var j=e.path,i=h.get("document")[0],l=new d(i.body),e=(e=e.selection)&&e.getRanges()[0],p=j.blockLimit;l[0]||(i.documentElement.appendChild(i.createElement("body")),l=new d(i.body),
e&&(e.setStart(l,0),e.collapse(1)));p=p||l;if(k.gecko){var o=(i=j.block||j.blockLimit)&&i.last(c);i&&i._4eIsBlockBoundary()&&(!o||!(1===o[0].nodeType&&o._4eIsBlockBoundary()))&&"pre"!==i.nodeName()&&!i._4eGetBogus()&&i._4eAppendBogus()}if(e&&e.collapsed&&!j.block){if("body"===p.nodeName()){"html"===e.startContainer.nodeName()&&e.setStart(l,0);if((j=e.fixBlock(g,"p"))&&j[0]!==l[0].lastChild&&j.outerHtml().match(f))if((i=j.next(a,1))&&i[0].nodeType===t.NodeType.ELEMENT_NODE&&!b[i])e.moveToElementEditablePosition(i),
j._4eRemove();else if((i=j.prev(a,1))&&i[0].nodeType===t.NodeType.ELEMENT_NODE&&!b[i])e.moveToElementEditablePosition(i,i.outerHtml().match(f)?q:g),j._4eRemove();e.select();h.notifySelectionChange()}j=h.get("document")[0];e=new u.Range(j);e.moveToElementEditablePosition(l,g);"body"!==(new u.ElementPath(e.startContainer)).blockLimit.nodeName()&&(l=(new d(j.createElement("p"))).appendTo(l),k.ie||l._4eAppendBogus())}})}var u=h("./base");h("./selection");var d=h("node"),g=!0,q=!1,x=null,k=l.UA,t=l.require("dom"),
o=u.SelectionType;return{init:function(d){d.docReady(function(){if(document.selection)v(d),w(d);else if(p(d),k.ie){var b,c=d.get("document");c.on("focusout",function(){b=d.getSelection().getRanges()});c.on("focusin",function(){b&&(d.getSelection().selectRanges(b),b=null)})}});y(d)}}});
KISSY.add("editor/modules",[],function(l){l.config("requires",{"editor/plugin/back-color":["editor/plugin/color/btn","editor/plugin/back-color/cmd"],"editor/plugin/back-color/cmd":["editor/plugin/color/cmd"],"editor/plugin/bold":["editor/plugin/font/ui","editor/plugin/bold/cmd"],"editor/plugin/bold/cmd":["editor/plugin/font/cmd"],"editor/plugin/bubble":["overlay","editor"],"editor/plugin/button":["editor","button"],"editor/plugin/checkbox-source-area":["editor"],"editor/plugin/code":["editor/plugin/button",
"editor/plugin/dialog-loader"],"editor/plugin/code/dialog":["menubutton","editor/plugin/dialog"],"editor/plugin/color/btn":["editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"],"editor/plugin/color/cmd":["editor"],"editor/plugin/color/dialog":["editor/plugin/dialog"],"editor/plugin/contextmenu":["menu","editor/plugin/focus-fix","event/dom"],"editor/plugin/dent-cmd":["editor","editor/plugin/list-utils"],"editor/plugin/dialog":["overlay","editor/plugin/focus-fix","dd/plugin/constrain",
"component/plugin/drag"],"editor/plugin/dialog-loader":["editor","overlay"],"editor/plugin/draft":["json","event/dom","editor/plugin/local-storage","editor/plugin/menubutton"],"editor/plugin/drag-upload":["editor","event/dom"],"editor/plugin/element-path":["editor"],"editor/plugin/fake-objects":["editor","html-parser"],"editor/plugin/flash":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/flash/dialog":["editor/plugin/flash-common/utils",
"editor/plugin/dialog","editor/plugin/menubutton"],"editor/plugin/flash-bridge":["editor","swf","event/custom"],"editor/plugin/flash-common/base-class":["editor/plugin/flash-common/utils","base","editor/plugin/dialog-loader","editor/plugin/bubble","editor/plugin/contextmenu"],"editor/plugin/flash-common/utils":["swf"],"editor/plugin/focus-fix":["editor"],"editor/plugin/font/cmd":["editor"],"editor/plugin/font/ui":["editor/plugin/button","editor/plugin/menubutton"],"editor/plugin/font-family":["editor/plugin/font/ui",
"editor/plugin/font-family/cmd"],"editor/plugin/font-family/cmd":["editor/plugin/font/cmd"],"editor/plugin/font-size":["editor/plugin/font/ui","editor/plugin/font-size/cmd"],"editor/plugin/font-size/cmd":["editor/plugin/font/cmd"],"editor/plugin/fore-color":["editor/plugin/color/btn","editor/plugin/fore-color/cmd"],"editor/plugin/fore-color/cmd":["editor/plugin/color/cmd"],"editor/plugin/heading":["editor/plugin/menubutton","editor/plugin/heading/cmd"],"editor/plugin/heading/cmd":["editor"],"editor/plugin/image":["editor/plugin/button",
"editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader","node"],"editor/plugin/image/dialog":["io","editor/plugin/dialog","tabs","editor/plugin/menubutton","node"],"editor/plugin/indent":["editor/plugin/indent/cmd","editor/plugin/button"],"editor/plugin/indent/cmd":["editor/plugin/dent-cmd"],"editor/plugin/italic":["editor/plugin/font/ui","editor/plugin/italic/cmd"],"editor/plugin/italic/cmd":["editor/plugin/font/cmd"],"editor/plugin/justify-center":["editor/plugin/justify-center/cmd",
"editor/plugin/button"],"editor/plugin/justify-center/cmd":["editor/plugin/justify-cmd"],"editor/plugin/justify-cmd":["editor"],"editor/plugin/justify-left":["editor/plugin/justify-left/cmd","editor/plugin/button"],"editor/plugin/justify-left/cmd":["editor/plugin/justify-cmd"],"editor/plugin/justify-right":["editor/plugin/justify-right/cmd","editor/plugin/button"],"editor/plugin/justify-right/cmd":["editor/plugin/justify-cmd"],"editor/plugin/link":["editor/plugin/button","editor/plugin/bubble","editor/plugin/link/utils",
"editor/plugin/dialog-loader"],"editor/plugin/link/dialog":["editor/plugin/dialog","editor/plugin/link/utils"],"editor/plugin/link/utils":["editor"],"editor/plugin/list-utils/btn":["editor/plugin/button","editor/plugin/menubutton"],"editor/plugin/list-utils/cmd":["editor","editor/plugin/list-utils"],"editor/plugin/local-storage":["overlay","editor/plugin/flash-bridge"],"editor/plugin/maximize":["editor/plugin/maximize/cmd","editor/plugin/button"],"editor/plugin/maximize/cmd":["editor","event/dom"],
"editor/plugin/menubutton":["editor","menubutton"],"editor/plugin/ordered-list":["editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"],"editor/plugin/ordered-list/cmd":["editor/plugin/list-utils/cmd"],"editor/plugin/outdent":["editor/plugin/button","editor/plugin/outdent/cmd"],"editor/plugin/outdent/cmd":["editor/plugin/dent-cmd"],"editor/plugin/overlay":["overlay","editor/plugin/focus-fix"],"editor/plugin/page-break":["editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/preview":["editor/plugin/button"],
"editor/plugin/progressbar":["base"],"editor/plugin/remove-format":["editor/plugin/button","editor/plugin/remove-format/cmd"],"editor/plugin/remove-format/cmd":["editor"],"editor/plugin/resize":["dd"],"editor/plugin/smiley":["editor/plugin/overlay","editor/plugin/button"],"editor/plugin/source-area":["editor/plugin/button"],"editor/plugin/strike-through":["editor/plugin/font/ui","editor/plugin/strike-through/cmd"],"editor/plugin/strike-through/cmd":["editor/plugin/font/cmd"],"editor/plugin/table":["editor/plugin/dialog-loader",
"editor/plugin/contextmenu","editor/plugin/button"],"editor/plugin/table/dialog":["editor/plugin/dialog","editor/plugin/menubutton"],"editor/plugin/underline":["editor/plugin/font/ui","editor/plugin/underline/cmd"],"editor/plugin/underline/cmd":["editor/plugin/font/cmd"],"editor/plugin/undo":["editor/plugin/undo/btn","editor/plugin/undo/cmd"],"editor/plugin/undo/btn":["editor/plugin/button"],"editor/plugin/undo/cmd":["editor"],"editor/plugin/unordered-list":["editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"],
"editor/plugin/unordered-list/cmd":["editor/plugin/list-utils/cmd"],"editor/plugin/video":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/video/dialog":["io","editor/plugin/flash/dialog"],"editor/plugin/word-filter":["html-parser"],"editor/plugin/xiami-music":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/xiami-music/dialog":["editor/plugin/flash/dialog"]})});
KISSY.add("editor/styles",["node","./selection","./range","./base","./elementPath"],function(l,h){function v(a){return!H.attr(a,"_ke_bookmark")}function w(a,b){for(var c in a)"string"===typeof a[c]?a[c]=a[c].replace(R,function(a,c){return b[c]}):w(a[c],b)}function p(a,b){b&&(a=l.clone(a),w(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"===c||F[c]?n.STYLE_BLOCK:N[c]?n.STYLE_OBJECT:n.STYLE_INLINE;this._={definition:a}}function y(a,b){var c=b?this.removeFromRange:
this.applyToRange;a.body.focus();for(var d=new m(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function u(a,b,c){var d=a.element;"*"===d&&(d="span");b=new e(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=p.getStyleText(c);if(a)for(var f in a)b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function d(a){var b=a.createBookmark(A),c=a.createIterator();c.enforceRealBlocks=A;c.enlargeBr=A;for(var d,f=a.document;d=c.getNextParagraph();){var n=
u(this,f,d),h=n,n="pre"===h.nodeName,j="pre"===d.nodeName,i=!n&&j;n&&!j?(j=d,i=j.html(),i=g(i,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,""),i=i.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1"),i=i.replace(/([\t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),O.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(h[0]),h.outerHtml("<pre>"+i+"</pre>"),h=new e(j.firstChild),h._4eRemove()):h.html(i)):i?h=x(q(d),h):d._4eMoveChildren(h);d[0].parentNode.replaceChild(h[0],d[0]);if(n&&(d=h,n=void 0,(n=
d._4ePreviousSourceNode(A,H.NodeType.ELEMENT_NODE))&&"pre"===n.nodeName()))h=g(n.html(),/\n$/,"")+"\n\n"+g(d.html(),/^\n/,""),O.ie?d.outerHtml("<pre>"+h+"</pre>"):d.html(h),n._4eRemove()}a.moveToBookmark(b)}function g(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function q(a){var b=[];g(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,
b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function x(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=g(e,/^[\t]*\n/,""),e=g(e,/\n$/,""),e=g(e,/^[\t]+|[\t]+$/g,function(a,b){return 1===a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}function k(a){var b=a.document;if(a.collapsed)b=u(this,b,void 0),a.insertNode(b),a.moveToPosition(b,K.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,f,g=M[c];g||(f=A,g=M.span);var n=a.createBookmark();a.enlarge(K.ENLARGE_ELEMENT);a.trim();for(var h=a.createBookmark(),j=h.startNode,h=h.endNode,k=j,l;k&&k[0];){var m=C;if(H.equals(k,h))k=G,m=A;else{var F=k[0].nodeType,p=F===H.NodeType.ELEMENT_NODE?k.nodeName():G;if(p&&k.attr("_ke_bookmark")){k=
k._4eNextSourceNode(A);continue}if(!p||g[p]&&(k._4ePosition(h)|E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(k))){var o=k.parent();if(o&&"a"===c&&o.nodeName()===c)F=u(this,b,void 0),o._4eMoveChildren(F),o[0].parentNode.replaceChild(F[0],o[0]),F._4eMergeSiblings();else if(o&&o[0]&&((M[o.nodeName()]||M.span)[c]||f)&&(!d.parentRule||d.parentRule(o))){if(!l&&(!p||!M.$removeEmpty[p]||(k._4ePosition(h)|
E.POSITION_PRECEDING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_PRECEDING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED))l=new s(b),l.setStartBefore(k);if(F===H.NodeType.TEXT_NODE||F===H.NodeType.ELEMENT_NODE&&!k[0].childNodes.length){o=k;for(F=null;(m=!o.next(v,1))&&(F=o.parent())&&g[F.nodeName()]&&(F._4ePosition(j)|E.POSITION_FOLLOWING|E.POSITION_IDENTICAL|E.POSITION_IS_CONTAINED)===E.POSITION_FOLLOWING+E.POSITION_IDENTICAL+E.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(F));)o=
F;l.setEndAfter(o)}}else m=A}else m=A;k=k._4eNextSourceNode()}if(m&&l&&!l.collapsed){for(var m=u(this,b,void 0),o=l.getCommonAncestor(),F={},p={},r,q=null,t;m&&o&&m[0]&&o[0];){if(o.nodeName()===c){for(r in d.attributes)if(!p[r]&&(t=o.attr(q)))m.attr(r)===t?m.removeAttr(r):p[r]=1;for(q in d.styles)if(!F[q]&&(t=o.style(q)))m.style(q)===t?m.style(q,""):F[q]=1;if(!m._4eHasAttributes()){m=G;break}}o=o.parent()}m?(m[0].appendChild(l.extractContents()),i(this,m),l.insertNode(m),m._4eMergeSiblings(),O.ie||
m[0].normalize()):(m=new e(b.createElement("span")),m[0].appendChild(l.extractContents()),l.insertNode(m),i(this,m),m._4eRemove(!0));l=G}}j._4eRemove();h._4eRemove();a.moveToBookmark(n);a.shrink(K.SHRINK_TEXT)}}function t(a){a.enlarge(K.ENLARGE_ELEMENT);var d=a.createBookmark(),f=d.startNode;if(a.collapsed){for(var g=new D(f.parent()),h,n=0,i;n<g.elements.length&&(i=g.elements[n])&&!(i===g.block||i===g.blockLimit);n++)if(this.checkElementRemovable(i)){var k=a.checkBoundaryOfElement(i,K.END),l=!k&&
a.checkBoundaryOfElement(i,K.START);l||k?(h=i,h.match=l?"start":"end"):(i._4eMergeSiblings(),i.nodeName()!==this.element?(k=b(this),j(i,k[i.nodeName()]||k["*"])):c(this,i))}if(h){i=f;for(n=0;;n++){k=g.elements[n];if(k.equals(h))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(i[0]);i=k}i["start"===h.match?"insertBefore":"insertAfter"](h);g=h.html();!g||"\u200b"===g?h.remove():O.webkit&&J(a.document.createTextNode("\u200b")).insertBefore(i)}}else{var m=d.endNode,F=this;h=function(){for(var a=
new D(f.parent()),b=new D(m.parent()),c=G,d,e=G,g=0;g<a.elements.length;g++){d=a.elements[g];if(d===a.block||d===a.blockLimit)break;F.checkElementRemovable(d)&&(c=d)}for(g=0;g<b.elements.length;g++){d=b.elements[g];if(d===b.block||d===b.blockLimit)break;F.checkElementRemovable(d)&&(e=d)}e&&m._4eBreakParent(e);c&&f._4eBreakParent(c)};h();for(g=new e(f[0].nextSibling);g[0]!==m[0];){n=g._4eNextSourceNode();if(g[0]&&g[0].nodeType===H.NodeType.ELEMENT_NODE&&this.checkElementRemovable(g)&&(g.nodeName()===
this.element?c(this,g):(i=b(this),j(g,i[g.nodeName()]||i["*"])),n[0].nodeType===H.NodeType.ELEMENT_NODE&&n.contains(f)))h(),n=new e(f[0].nextSibling);g=n}}a.moveToBookmark(d)}function o(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function r(a,b){var c="";b!==C?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){l.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g,h;"string"===typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():a.element,g=e.attributes,h=e.styles);e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var n in g)f.push([n.toLowerCase(),g[n]])}if(h){var e=e.styles=e.styles||[],i;for(i in h)e.push([i.toLowerCase(),h[i]])}}}return b}function c(c,
d){var e=c._.definition,g=b(c),h=l.merge(e.attributes,(g[d.nodeName()]||g["*"]||{}).attributes),e=l.merge(e.styles,(g[d.nodeName()]||g["*"]||{}).styles),g=l.isEmptyObject(h)&&l.isEmptyObject(e),n;for(n in h)("class"===n||c._.definition.fullMatch)&&d.attr(n)!==f(n,h[n])||(g=g||!!d.hasAttr(n),d.removeAttr(n));for(var i in e)c._.definition.fullMatch&&d.style(i)!==f(i,e[i],A)||(g=g||!!d.style(i),d.style(i,""));a(d)}function f(a,b,c){var d=new e("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}
function i(a,d){for(var g=b(a),f=d.all(a.element),h=f.length;0<=--h;)c(a,new e(f[h]));for(var n in g)if(n!==a.element){f=d.all(n);for(h=f.length-1;0<=h;h--){var i=new e(f[h]);j(i,g[n])}}}function j(b,c){var d,e,g=c&&c.attributes;if(g)for(d=0;d<g.length;d++){var f=g[d][0];if(e=b.attr(f)){var h=g[d][1];(h===G||h.test&&h.test(e)||"string"===typeof h&&e===h)&&b[0].removeAttribute(f)}}if(g=c&&c.styles)for(d=0;d<g.length;d++)if(f=g[d][0],h=b.css(f)){var n=g[d][1];(n===G||n.test&&n.test(e)||"string"===typeof n&&
h===n)&&b.css(f,"")}a(b)}function a(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(A);b&&(b.nodeType===H.NodeType.ELEMENT_NODE&&H._4eMergeSiblings(b),c&&b!==c&&c.nodeType===H.NodeType.ELEMENT_NODE&&H._4eMergeSiblings(c))}}var e=h("node"),m=h("./selection"),s=h("./range"),z=h("./base"),D=h("./elementPath"),A=!0,C=!1,G=null,J=l.all,H=l.require("dom"),K=z.RangeType,E=z.PositionType,n,O=l.UA,F={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},M=z.XHTML_DTD,N={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;z.StyleType=n={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};p.prototype={constructor:p,apply:function(a){y.call(this,a,C)},remove:function(a){y.call(this,a,A)},applyToRange:function(a){return(this.applyToRange=this.type===n.STYLE_INLINE?k:this.type===n.STYLE_BLOCK?d:G).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===n.STYLE_INLINE?t:G).call(this,a)},
checkElementRemovable:function(a,c){if(!a)return C;var d,e=this._.definition,g;if(a.nodeName()===this.element){if(!c&&!a._4eHasAttributes())return A;var f=e._AC;if(!f){var f={},h=0,n=e.attributes;if(n)for(var i in n)h++,f[i]=n[i];if(n=p.getStyleText(e))f.style||h++,f.style=n;f._length=h;e._AC=f}e=f;if(e._length){for(d in e)if("_length"!==d){h=a.attr(d)||"";if("style"===d)a:{f=e[d];h=r(h,C);"string"===typeof f&&(f=o(f));"string"===h&&(h=o(h));n=void 0;for(n in f)if(!(n in h&&(h[n]===f[n]||"inherit"===
f[n]||"inherit"===h[n]))){f=C;break a}f=A}else f=e[d]===h;if(f){if(!c)return A}else if(c)return C}if(c)return A}else return A}d=b(this);if(d=d[a.nodeName()]||d["*"]){if(!(e=d.attributes)&&!(g=d.styles))return A;if(e)for(f=0;f<e.length;f++)if(d=e[f][0],d=a.attr(d))if(h=e[f][1],h===G||"string"===typeof h&&d===h||h.test&&h.test(d))return A;if(g)for(f=0;f<g.length;f++)if(d=a.css(g[f][0]))if(e=g[f][1],e===G||"string"===typeof e&&d===e||e.test&&e.test(d))return A}return C},checkActive:function(a){switch(this.type){case n.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,A);case n.STYLE_OBJECT:case n.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type===n.STYLE_INLINE&&(H.equals(d,a.block)||H.equals(d,a.blockLimit))))if((this.type!==n.STYLE_OBJECT||d.nodeName()in N)&&this.checkElementRemovable(d,A))return A}return C}};p.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(P,";"));for(var e in b){var f=b[e],g=(e+":"+f).replace(P,";");"inherit"===f?
d+=g:c+=g}c.length&&(c=r(c));c+=d;return a._ST=c};return z.Style=p});
KISSY.add("editor/domIterator",["node","./walker","./range","./base","./elementPath"],function(l,h){function v(d){1>arguments.length||(this.range=d,this.forceBrBreak=q,this.enlargeBr=g,this.enforceRealBlocks=q,this._=this._||{})}var w=h("node"),p=h("./walker"),y=h("./range"),u=h("./base"),d=h("./elementPath"),g=!0,q=!1,x=l.UA,k=u.RangeType,t=l.require("dom"),o=/^[\r\n\t ]*$/;l.augment(v,{getNextParagraph:function(h){var b,c,f,i,j,a;if(!this._.lastNode){f=this.range.clone();f.shrink(k.SHRINK_ELEMENT,
g);f.enlarge(this.forceBrBreak||!this.enlargeBr?k.ENLARGE_LIST_ITEM_CONTENTS:k.ENLARGE_BLOCK_CONTENTS);c=new p(f);var e=p.bookmark(g,g);c.evaluator=e;this._.nextNode=c.next();c=new p(f);c.evaluator=e;c=c.previous();this._.lastNode=c._4eNextSourceNode(g);this._.lastNode&&this._.lastNode[0].nodeType===t.NodeType.TEXT_NODE&&!l.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()&&(e=new y(f.document),e.moveToPosition(this._.lastNode,k.POSITION_AFTER_END),e.checkEndOfBlock()&&
(e=new d(e.endContainer),this._.lastNode=(e.block||e.blockLimit)._4eNextSourceNode(g)));this._.lastNode||(this._.lastNode=this._.docEndMarker=new w(f.document.createTextNode("")),t.insertAfter(this._.lastNode[0],c[0]));f=null}e=this._.nextNode;c=this._.lastNode;for(this._.nextNode=null;e;){var m=q,s=e[0].nodeType!==t.NodeType.ELEMENT_NODE,u=q;if(s)e[0].nodeType===t.NodeType.TEXT_NODE&&o.test(e[0].nodeValue)&&(s=q);else{var v=e.nodeName();if(e._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){if("br"===
v)s=g;else if(!f&&!e[0].childNodes.length&&"hr"!==v){b=e;i=e.equals(c);break}f&&(f.setEndAt(e,k.POSITION_BEFORE_START),"br"!==v&&(this._.nextNode=e));m=g}else{if(e[0].firstChild){f||(f=new y(this.range.document),f.setStartAt(e,k.POSITION_BEFORE_START));e=new w(e[0].firstChild);continue}s=g}}s&&!f&&(f=new y(this.range.document),f.setStartAt(e,k.POSITION_BEFORE_START));i=(!m||s)&&e.equals(c);if(f&&!m)for(;!e[0].nextSibling&&!i;){v=e.parent();if(v._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){m=g;i||
v.equals(c);break}e=v;s=g;i=e.equals(c);u=g}s&&f.setEndAt(e,k.POSITION_AFTER_END);e=e._4eNextSourceNode(u,null,c);if((i=!e)||m&&f)break}if(!b){if(!f)return this._.docEndMarker&&this._.docEndMarker._4eRemove(),this._.nextNode=null;b=new d(f.startContainer);e=b.blockLimit;m={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&m[e.nodeName()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())b=e;else if(!b||this.enforceRealBlocks&&"li"===b.nodeName())b=new w(this.range.document.createElement(h||
"p")),b[0].appendChild(f.extractContents()),b._4eTrim(),f.insertNode(b),j=a=g;else if("li"!==b.nodeName()){if(!f.checkStartOfBlock()||!f.checkEndOfBlock())b=b.clone(q),b[0].appendChild(f.extractContents()),b._4eTrim(),a=f.splitBlock(),j=!a.wasStartOfBlock,a=!a.wasEndOfBlock,f.insertNode(b)}else i||(this._.nextNode=b.equals(c)?null:f.getBoundaryNodes().endNode._4eNextSourceNode(g,null,c))}j&&(f=new w(b[0].previousSibling),f[0]&&f[0].nodeType===t.NodeType.ELEMENT_NODE&&("br"===f.nodeName()?f._4eRemove():
f[0].lastChild&&"br"===t.nodeName(f[0].lastChild)&&t._4eRemove(f[0].lastChild)));a&&(f=p.bookmark(q,g),j=new w(b[0].lastChild),j[0]&&j[0].nodeType===t.NodeType.ELEMENT_NODE&&"br"===j.nodeName()&&(x.ie||j.prev(f,1)||j.next(f,1))&&j.remove());this._.nextNode||(this._.nextNode=i||b.equals(c)?null:b._4eNextSourceNode(g,null,c));return b}});y.prototype.createIterator=function(){return new v(this)};return v});
KISSY.add("editor/z-index-manager",["./base"],function(l,h){var v=h("./base"),w=v.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(h){return(v.Config.baseZIndex||1E4)+h};return w});
KISSY.add("editor","node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focusManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/modules,editor/styles,editor/domIterator,editor/z-index-manager".split(","),function(l,h,v,w){function p(a,b){var c=a.get("textarea"),d=a.get("toolBarEl"),e=a.get("statusBarEl"),b=parseInt(b,10),b=b-((d&&d.outerHeight()||0)+(e&&e.outerHeight()||0));c.parent().css(G,b);c.css(G,b)}function y(b,c){var d=b.body;J(function(){b.designMode=
"on";setTimeout(function N(){b.designMode="off";d.focus();if(!N.retry)N.retry=a},50)},function(){b.designMode="off";d.setAttribute("contentEditable",false);d.setAttribute("contentEditable",true);c||y(b,1)})}function u(a){var c=a.get("textarea")[0],d=a.get("window"),f=a.get("document"),g=f[0];if(z.webkit){f.on("click",function(a){var b=new k(a.target);l.inArray(b.nodeName(),["input","select"])&&a.preventDefault()});f.on("mouseup",function(a){var b=new k(a.target);l.inArray(b.nodeName(),["input","textarea"])&&
a.preventDefault()})}if(z.gecko||z.ie||z.opera){var h;h=(new k('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);h.on("focus",function(){a.focus()});a.activateGecko=function(){z.gecko&&a.__iframeFocus&&h[0].focus()};a.on("destroy",function(){h.detach();h.remove()})}d.on("focus",function(){z.gecko?y(g,e):z.opera&&g.body.focus();a.notifySelectionChange()});if(z.gecko)f.on("mousedown",function(){a.__iframeFocus||y(g,e)});if(D){f.on("keydown",function(b){if(b.keyCode in
{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}});if(g.compatMode==="CSS1Compat"){var i={33:1,34:1};f.on("keydown",function(b){b.keyCode in i&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(z.webkit)f.on("mousedown",function(b){b=new k(b.target);l.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});
if(z.gecko)f.on("dragstart",function(a){var b=new k(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});b.add(a)}function d(a,b,c,d){var e="",f;f=r.debugUrl("theme/editor-iframe.css");c=c.concat([]);c.unshift(f);for(f=0;f<c.length;f++)e=e+l.substitute('<link href="{href}" rel="stylesheet" />',{href:c[f]});return l.substitute(t,{doctype:l.UA.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:e,style:"<style>"+b+"</style>",data:d||
"",script:a?'<script id="ke_active_script">'+(C(m).isCustomDomain()?'document.domain="'+s.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+a+'");<\/script>':""})}function g(a,b){function c(){i=h.document;a.setInternal("document",new k(i));a.setInternal("window",new k(h));e.detach();i.open("text/html","replace");i.write(f);i.close()}var e=a.get("iframe"),f=d(a.get("id"),a.get("customStyle"),a.get("customLink"),b),g=e[0],h=g.contentWindow,i;e.__loaded=1;try{i=h.document}catch(j){g.src=
g.src;if(D<7){setTimeout(c,10);return}}c()}function q(a,b){var c=C(m).getEmptyIframeSrc()||"";c&&(c=' src="'+c+'" ');var c=new k(l.substitute(H,{iframeSrc:c,prefixCls:a.get("prefixCls")})),d=a.get("textarea");d.hasAttr("tabindex")&&c.attr("tabindex",z.webkit?-1:d.attr("tabindex"));d.parent().prepend(c);a.set("iframe",c);a.__docReady=0;if(z.gecko&&!c.__loaded)c.on("load",function(){g(a,b)},a);else g(a,b)}function x(a){if(a.get("iframe")){var b=a.get("iframe"),c=a.get("window"),a=a.get("document"),
d=a[0],e=C(d.documentElement),d=C(d.body);l.each([a,e,d,c],function(a){a.detach()});b.remove()}}var k=h("node"),t=h("editor/iframe-content-tpl"),o=h("editor/base"),r=h("editor/utils"),b=h("editor/focusManager"),c=h("editor/clipboard"),f=h("editor/enterKey"),i=h("editor/htmlDataProcessor"),j=h("editor/selectionFix");h("editor/modules");h("editor/styles");h("editor/domIterator");h("editor/z-index-manager");w.exports=o;var a=true,e=false,m=l.Env.host,s=m.document,z=l.UA,D=z.ieMode<11,A=k.NodeType,C=
k.all,G="height",J=r.tryThese,H='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',K=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;o.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};o.addMembers({initializer:function(){this.__commands={};this.__controls={};b.register(this)},renderUI:function(){c.init(this);f.init(this);i.init(this);j.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();
else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form)&&(c=C(c)))c.on("submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.$el.removeClass(d+"editor-focused")});b.on("focus",function(){b.$el.addClass(d+"editor-focused")})},syncUI:function(){p(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},
addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=l.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},queryCommandValue:function(a){return this.execCommand(r.getQueryCmd(a))},setData:function(a){var b,
c=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);x(this);q(this,c)}},getData:function(a,b){var c=this.htmlDataProcessor,d;b===void 0&&(b=this.get("mode"));d=b===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=l.trim(d);K.test(d)&&(d="");return d},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return d(0,this.get("customStyle"),
this.get("customLink"),this.getFormatData())},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],b="";if(a){a=a.cloneContents();b=this.get("document")[0].createElement("div");b.appendChild(a);b=b.innerHTML}return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];z.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},
blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&c.addStyleSheet(a,b)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);
b.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(b){b.attr("href")===a&&b.remove()});var b=this.get("customLink"),c=l.indexOf(a,b);c!==-1&&b.splice(c,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&
!b.isInvalid){var c=b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d)){a.__previousPath=d;a.fire("selectionChange",{selection:b,path:d,element:c})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(b){if(this.get("mode")===1){this.focus();var c,d=b.nodeName(),e=o.XHTML_DTD,f=e.$block[d],g=o.RangeType,h=(d=this.getSelection())&&d.getRanges(),i,j,k;if(h&&h.length!==0){this.execCommand("save");
for(j=h.length-1;j>=0;j--){i=h[j];c=!j&&b||b.clone(a);i.insertNodeByDtd(c);k||(k=c)}if(k){i.moveToPosition(k,g.POSITION_AFTER_END);if(f){b=o.Walker.whitespaces(true);(b=(k=k.next(b,1))&&k[0].nodeType===A.ELEMENT_NODE&&k.nodeName())&&e.$block[b]&&e[b]["#text"]&&i.moveToElementEditablePosition(k)}d.selectRanges([i]);this.focus();c&&c[0].nodeType===1&&c.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});E.call(this);return c}}}},insertHtml:function(a,b){var c=
this,d,e=c.get("document")[0];if(c.get("mode")===1){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,b);c.focus();c.execCommand("save");if(d=e.selection){d.type==="Control"&&d.clear();try{d.createRange().pasteHTML(a)}catch(f){}}else{d=c.get("iframe")[0].contentWindow.getSelection();var g=d.getRangeAt(0);g.deleteContents();var h=e.createElement("div");h.innerHTML=a;for(var e=e.createDocumentFragment(),i,j;i=h.firstChild;)j=e.appendChild(i);g.insertNode(e);if(j){g=g.cloneRange();g.setStartAfter(j);g.collapse(true);
d.removeAllRanges();d.addRange(g)}}setTimeout(function(){c.getSelection().scrollIntoView()},50);E.call(c)}},_onSetHeight:function(a){p(this,a)},_onSetMode:function(a){var b=this.get("iframe"),c=this.get("textarea");if(a===1){this.setData(c.val());c.hide();this.fire("wysiwygMode")}else{if(b){c.val(this.getFormatData(1));b.hide()}c.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,c=this.get("textarea"),d=this.get("document");this.get("attachForm")&&
(a=c[0].form)&&(a=C(a))&&a.detach("submit",this.sync,this);if(d){a=C(d[0].body);var c=C(d[0].documentElement),e=this.get("window");b.remove(this);d.detach();c.detach();a.detach();e.detach()}l.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});o.decorate=function(a,b){var b=b||{},a=C(a),c=b.textareaAttrs=b.textareaAttrs||{},d=a.style("width"),e=a.style("height"),f=a.attr("name");if(d)b.width=b.width||d;if(e)b.height=b.height||e;if(f)c.name=f;b.data=b.data||
a.val();b.elBefore=a;c=(new o(b)).render();a.remove();return c};o._initIframe=function(c){var d=b.getInstance(c),c=d.get("document"),f=c[0];c.one("#ke_active_script").remove();u(d);var g=f.body,h=C(g);if(D){g.hideFocus=a;g.disabled=a;g.contentEditable=a;g.removeAttribute("disabled")}else setTimeout(function(){z.gecko||z.opera?g.contentEditable=a:z.webkit?g.parentNode.contentEditable=a:f.designMode="on"},0);if(z.gecko||z.opera){var i=f.documentElement;C(i).on("mousedown",function(a){if(a.target===
i){z.gecko&&y(f,e);d.activateGecko()}})}setTimeout(function(){D&&setTimeout(function(){if(f){g.runtimeStyle.marginBottom="0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{f.execCommand("enableObjectResizing",e,!a);f.execCommand("enableInlineTableEditing",e,!b)}catch(c){h.on(D?"resizestart":"resize",function(c){var d=new k(c.target);(a||d.nodeName()==="table"&&
b)&&c.preventDefault()})}},10)};var E=l.buffer(function(){this.execCommand("save")},50)});
