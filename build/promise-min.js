/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 26 20:54
*/
KISSY.add("promise",[],function(j){function q(a){"undefined"!==typeof console&&console.error&&console.error(a)}function m(a,b,d){if(a instanceof f)processImmediate(function(){d.call(a,a[PROMISE_VALUE])});else{var k=a[PROMISE_VALUE],c=a[PROMISE_PENDINGS];c?c.push([b,d]):i(k)?m(k,b,d):b&&processImmediate(function(){b.call(a,k)})}}function e(a){if(!(this instanceof e))return new e(a);this.promise=a||new c;this.promise.defer=this}function i(a){return a&&a instanceof c}function c(a){this[PROMISE_VALUE]=
a;void 0===a&&(this[PROMISE_PENDINGS]=[],this[PROMISE_PROGRESS_LISTENERS]=[])}function f(a){if(a instanceof f)return a;c.apply(this,arguments);this[PROMISE_VALUE]instanceof c&&"assert.not(this.__promise_value instanceof promise) in Reject constructor";return this}function h(a,b,d){function k(a){try{return b?b.call(this,a):a}catch(d){return q(d.stack||d),new f(d)}}function h(a){try{return d?d.call(this,a):new f(a)}catch(b){return q(b.stack||b),new f(b)}}function l(a){g?"already done at fulfilled":
a instanceof c?"assert.not(value instanceof Promise) in when":(g=1,n.resolve(k.call(this,a)))}var n=new e,g=0;a instanceof c?m(a,l,function(a){g?"already done at rejected":(g=1,n.resolve(h.call(this,a)))}):l(a);return n.promise}function o(a){return!p(a)&&i(a)&&void 0===a[PROMISE_PENDINGS]&&(!i(a[PROMISE_VALUE])||o(a[PROMISE_VALUE]))}function p(a){return i(a)&&void 0===a[PROMISE_PENDINGS]&&a[PROMISE_VALUE]instanceof f}e.prototype={constructor:e,resolve:function(a){var b=this.promise,d;if(!(d=b[PROMISE_PENDINGS]))return null;
b[PROMISE_VALUE]=a;d=[].concat(d);b[PROMISE_PENDINGS]=void 0;b[PROMISE_PROGRESS_LISTENERS]=void 0;j.each(d,function(a){m(b,a[0],a[1])});return a},reject:function(a){return this.resolve(new f(a))},notify:function(a){j.each(this.promise[PROMISE_PROGRESS_LISTENERS],function(b){processImmediate(function(){b(a)})})}};c.prototype={constructor:c,then:function(a,b,d){d&&this.progress(d);return h(this,a,b)},progress:function(a){this[PROMISE_PROGRESS_LISTENERS]&&this[PROMISE_PROGRESS_LISTENERS].push(a);return this},
fail:function(a){return h(this,0,a)},fin:function(a){return h(this,function(b){return a(b,!0)},function(b){return a(b,!1)})},done:function(a,b){(a||b?this.then(a,b):this).fail(function(a){a.stack||a;"error";setTimeout(function(){throw a;},0)})},isResolved:function(){return o(this)},isRejected:function(){return p(this)}};j.extend(f,c);KISSY.Defer=e;KISSY.Promise=c;c.Defer=e;j.mix(c,{when:h,isPromise:i,isResolved:o,isRejected:p,all:function(a){var b=a.length;if(!b)return null;for(var d=e(),c=0;c<a.length;c++)(function(c,
l){h(c,function(c){a[l]=c;0===--b&&d.resolve(a)},function(a){d.reject(a)})})(a[c],c);return d.promise},async:function(a){return function(){function b(a,b){var g;try{g=i[a](b)}catch(j){return new f(j)}return g.done?g.value:h(g.value,c,e)}function c(a){return b("next",a)}function e(a){return b("throw",a)}var i=a.apply(this,arguments);return c()}}});return c});
