/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 10 18:35
*/
KISSY.add("combobox/multi-word/cursor",["node"],function(p,f){function k(b){var a=i;a||(a=g(n));"textarea"===""+b[0].type.toLowerCase()?a.css("width",b.css("width")):a.css("width",9999);p.each(o,function(c){a.css(c,b.css(c))});i||a.insertBefore(b[0].ownerDocument.body.firstChild);return i=a}var g=f("node").all,n='<div style="z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;"></div>',i,o="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var a=g(b),b=a[0],c=b.ownerDocument,h=g(c),d=b.scrollTop,e=b.scrollLeft;if(c.selection)return b=c.selection.createRange(),{left:b.boundingLeft+e+h.scrollLeft(),top:b.boundingTop+d+b.boundingHeight+h.scrollTop()};h=a.offset();if("textarea"!==b.type)return h.top+=b.offsetHeight,h;c=k(a);a=b.selectionStart;c.html(p.escapeHtml(b.value.substring(0,a-1))+"<span>x</span>");c.offset(h);h=c.last();b=h.offset();b.top+=h.height();0<a&&(b.left+=h.width());b.top-=d;b.left-=e;return b}});
KISSY.add("combobox/multi-word",["./multi-word/cursor","combobox"],function(p,f){function k(a,c){return c&&-1!==a.indexOf(c)}function g(a){a.newVal&&a.target===this.get("menu")&&this.alignWithCursor()}function n(a){var c=a.get("input"),b=a.get("value"),d=[],e=[],q=a.get("literal"),r=a.get("separator"),a=a.get("separatorType"),l=!1,m=a!==i,c=c.prop("selectionStart"),g,j,f=-1;for(g=0;g<b.length;g++)(j=b.charAt(g),q&&j===q&&(l=!l),l)?e.push(j):(g===c&&(f=d.length),m&&o.test(j))?(e.length&&d.push(e.join("")),
e=[],e.push(j)):k(r,j)?a===i?(e.push(j),e.length&&d.push(e.join("")),e=[]):(e.length&&d.push(e.join("")),e=[],e.push(j)):e.push(j);e.length&&d.push(e.join(""));d.length||d.push("");-1===f&&(a===i&&k(r,j)&&d.push(""),f=d.length-1);return{tokens:d,cursorPosition:c,tokenIndex:f}}var i="suffix",o=/\s|\xa0/,b=f("./multi-word/cursor");return f("combobox").extend({syncUI:function(){var a;this.get("alignWithCursor")&&(a=this.get("menu"),a.setInternal("align",null),a.on("beforeVisibleChange",g,this))},getCurrentValue:function(){var a=
n(this),c=a.tokens,b=a.tokenIndex,a=this.get("separator"),d=this.get("separatorType"),c=c[b],b=c.length-1;if(d!==i)if(k(a,c.charAt(0)))c=c.slice(1);else return;else d===i&&k(a,c.charAt(b))&&(c=c.slice(0,b));return c},setCurrentValue:function(a,b){var h=this.get("input"),d=n(this),e=d.tokens,d=Math.max(0,d.tokenIndex),g=this.get("separator"),f;f=this.get("separatorType");var l=e[d+1]||"",m=e[d];if(f!==i){if(e[d]=m.charAt(0)+a,a&&(!l||!o.test(l.charAt(0))))e[d]+=" "}else e[d]=a,f=m.length-1,k(g,m.charAt(f))?
e[d]+=m.charAt(f):1===g.length&&(e[d]+=g);d=e.slice(0,d+1).join("").length;this.set("value",e.join(""),b);h.prop("selectionStart",d);h.prop("selectionEnd",d)},alignWithCursor:function(){var a=this.get("menu"),c;c=this.get("input");c=b(c);a.move(c.left,c.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:i},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
