/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 14 22:14
*/
KISSY.add("combobox/multi-word",["./multi-word/cursor","combobox"],function(q,e){function k(d,a){return a&&-1!==d.indexOf(a)}function o(d){d.newVal&&d.target===this.get("menu")&&this.alignWithCursor()}function m(d){var a=d.get("input"),f=d.get("value"),b=[],c=[],r=d.get("literal"),j=d.get("separator"),d=d.get("separatorType"),p=!1,l=d!==h,a=a.prop("selectionStart"),e,i,g=-1;for(e=0;e<f.length;e++)(i=f.charAt(e),r&&i===r&&(p=!p),p)?c.push(i):(e===a&&(g=b.length),l&&n.test(i))?(c.length&&b.push(c.join("")),
c=[],c.push(i)):k(j,i)?d===h?(c.push(i),c.length&&b.push(c.join("")),c=[]):(c.length&&b.push(c.join("")),c=[],c.push(i)):c.push(i);c.length&&b.push(c.join(""));b.length||b.push("");-1===g&&(d===h&&k(j,i)&&b.push(""),g=b.length-1);return{tokens:b,cursorPosition:a,tokenIndex:g}}var h="suffix",n=/\s|\xa0/,g=e("./multi-word/cursor");return e("combobox").extend({syncUI:function(){var d;this.get("alignWithCursor")&&(d=this.get("menu"),d.setInternal("align",null),d.on("beforeVisibleChange",o,this))},getCurrentValue:function(){var d=
m(this),a=d.tokens,f=d.tokenIndex,d=this.get("separator"),b=this.get("separatorType"),a=a[f],f=a.length-1;if(b!==h)if(k(d,a.charAt(0)))a=a.slice(1);else return;else b===h&&k(d,a.charAt(f))&&(a=a.slice(0,f));return a},setCurrentValue:function(d,a){var f=this.get("input"),b=m(this),c=b.tokens,b=Math.max(0,b.tokenIndex),e=this.get("separator"),j;j=this.get("separatorType");var g=c[b+1]||"",l=c[b];if(j!==h){if(c[b]=l.charAt(0)+d,d&&(!g||!n.test(g.charAt(0))))c[b]+=" "}else c[b]=d,j=l.length-1,k(e,l.charAt(j))?
c[b]+=l.charAt(j):1===e.length&&(c[b]+=e);b=c.slice(0,b+1).join("").length;this.set("value",c.join(""),a);f.prop("selectionStart",b);f.prop("selectionEnd",b)},alignWithCursor:function(){var d=this.get("menu"),a;a=this.get("input");a=g(a);d.move(a.left,a.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:h},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})});
KISSY.add("combobox/multi-word/cursor",["node","util"],function(q,e){function k(a){var f=g;f||(f=h(n));"textarea"===""+a[0].type.toLowerCase()?f.css("width",a.css("width")):f.css("width",9999);m.each(d,function(b){f.css(b,a.css(b))});g||f.insertBefore(a[0].ownerDocument.body.firstChild);return g=f}var o=e("node"),m=e("util"),h=o.all,n='<div style="z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;"></div>',g,d="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(a){var d=h(a),a=d[0],b=a.ownerDocument,c=h(b),e=a.scrollTop,g=a.scrollLeft;if(b.selection)return a=b.selection.createRange(),{left:a.boundingLeft+g+c.scrollLeft(),top:a.boundingTop+e+a.boundingHeight+c.scrollTop()};c=d.offset();if("textarea"!==a.type)return c.top+=a.offsetHeight,c;b=k(d);d=a.selectionStart;b.html(q.escapeHtml(a.value.substring(0,d-1))+"<span>x</span>");b.offset(c);c=b.last();a=c.offset();a.top+=c.height();0<d&&(a.left+=c.width());a.top-=e;a.left-=g;return a}});
