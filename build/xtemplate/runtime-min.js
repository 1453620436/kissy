/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 28 19:32
*/
KISSY.add("xtemplate/runtime/scope",[],function(k){function i(a,h){this.data=a||{};this.affix=h;this.root=this}i.prototype={isScope:1,setParent:function(a){this.parent=a;this.root=a.root},getParent:function(){return this.parent},getRoot:function(){return this.root},set:function(a,h){this.affix||(this.affix={});this.affix[a]=h},setData:function(a){this.data=a},getData:function(){return this.data},mix:function(a){this.affix||(this.affix={});k.mix(this.affix,a)},has:function(a){var h=this.data,f=this.affix;
return f&&a in f?!0:"object"===typeof h&&a in h},get:function(a){var h=this.data,f=this.affix;if(f&&a in f)return f[a];if("object"===typeof h&&a in h)return h[a]},resolve:function(a,h){"."===a&&(a="this");var f=a.split("."),e=this,d,c,b,j,g;if("root"===f[0])f.shift(),e=e.root;else if(h)for(;e&&h--;)e=e.parent;var m=0;for(d=f.length;e;){g=1;b=e;for(c=0;c<d;c++)if(j=f[c],"this"===j)m=1;else if(b===e){if(!e.has(j)){g=0;break}b=e.get(j)}else{if("object"!==typeof b||!(j in b)){g=0;break}b=b[j]}if(g)return b&&
b.isScope&&(b=b.data),"function"===typeof b&&(b=b.call(this.data)),[b];if(m)break;e=e.parent}return!1}};return i});
KISSY.add("xtemplate/runtime/commands",["path","./scope"],function(k,i){var a,h=i("path"),f=i("./scope");return a={each:function(e,d){var c=d.params[0],b="",a,g;if(c)if(g=new f,k.isArray(c)){a=c.length;for(var m=0;m<a;m++)g.data=c[m],g.affix={xcount:a,xindex:m},g.setParent(e),b+=d.fn(g)}else for(a in c)g.data=c[a],g.affix={xindex:a},g.setParent(e),b+=d.fn(g);else d.inverse&&(b=d.inverse(e));return b},"with":function(a,d){var c=d.params[0],b="";c?(c=new f(c),c.setParent(a),b=d.fn(c)):d.inverse&&(b=
d.inverse(a));return b},"if":function(a,d){var c="";d.params[0]?d.fn&&(c=d.fn(a)):d.inverse&&(c=d.inverse(a));return c},set:function(a,d){a.mix(d.hash);return""},include:function(a,d){var c=d.params;if(!c||1!==c.length)return"include must has one param","";if(d.hash){var b=new f(d.hash);b.setParent(a);a=b}b=this.config.name;c=c[0];if("."===c.charAt(0)){if("unspecified"===b)return"parent template does not have name for relative sub tpl name: "+c,"";c=h.resolve(b,"../",c)}b=this.config.loader.call(this,
c);d=k.merge(this.config);d.name=c;d.commands=this.config.commands;d.macros=this.config.macros;return this.invokeEngine(b,a,d)},macro:function(a,d){var c=d.params,b=c[0],h=c.slice(1),c=this.config.macros;if(d.fn)c[b]||(c[b]={paramNames:h,fn:d.fn});else{var g={};(b=c[b])||"can not find macro:"+name;k.each(b.paramNames,function(a,c){g[a]=h[c]});c=new f(g);return b.fn.call(this,c)}return""},parse:function(e,d){return a.include.call(this,new f,d)}}});
KISSY.add("xtemplate/runtime",["./runtime/commands","./runtime/scope"],function(k,i){function a(g){g}function h(g,a){for(var c=a.split("."),b=g,d=c.length,f=0;f<d&&!(b=b[c[f]],!b);f++);return b}function f(g,a){this.tpl=g;a=k.merge(j,a);a.commands=k.merge(a.commands,e);a.utils=b;a.macros=a.macros||{};this.config=a}var e=i("./runtime/commands"),d=i("./runtime/scope"),c=k.escapeHtml,b={runBlockCommand:function(g,c,b,d,f){var e=g.config,i=e.silent?a:k.error,j=e.commands,e=h(j,d);if(!e)if(!b.params&&!b.hash){var l=
c.resolve(d,void 0);!1===l?(i('can not find property: "'+d+'" at line '+f),l=""):l=l[0];e=j["if"];k.isArray(l)?e=j.each:"object"===typeof l&&(e=j["with"]);b.params=[l]}else return"can not find command module: "+d+'" at line '+f,"";i="";try{i=e.call(g,c,b)}catch(n){n.message+': "'+d+'" at line '+f}void 0===i&&(i="");return i},getExpression:function(a,b){void 0===a&&(a="");return b&&a?c(a):a},getPropertyOrRunCommand:function(b,d,f,e,i,j,q,o){var l,n=b.config,p=h(n.commands,e),n=n.silent?a:k.error;if(p)try{l=
p.call(b,d,f)}catch(r){return r.message+': "'+e+'" at line '+j,""}else{b=d.resolve(e,i);if(!1===b)return n('can not find property: "'+e+'" at line '+j,"warn"),o?void 0:"";l=b[0]}!o&&void 0===l&&(l="");return q&&l?c(l):l}},j={silent:!0,name:"unspecified",loader:function(a){var b=k.require(a);b||'template "'+a+'" does not exist, need to be required or used first!';return b}};k.mix(f,{commands:e,utils:b,addCommand:function(a,b){e[a]=b},removeCommand:function(a){delete e[a]}});f.prototype={constructor:f,
invokeEngine:function(a,b,c){return(new this.constructor(a,c)).render(b,!0)},removeCommand:function(a){delete this.config.commands[a]},addCommand:function(a,b){this.config.commands[a]=b},render:function(a){var b=a;if(!b||!b.isScope)b=new d(a);return this.tpl(b,k)}};f.Scope=d;return f});
