/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 28 20:17
*/
KISSY.add("xtemplate/runtime/scope",[],function(h){function i(e,g){this.data=e||{};this.affix=g;this.root=this}i.prototype={isScope:1,setParent:function(e){this.parent=e;this.root=e.root},getParent:function(){return this.parent},getRoot:function(){return this.root},set:function(e,g){this.affix||(this.affix={});this.affix[e]=g},setData:function(e){this.data=e},getData:function(){return this.data},mix:function(e){this.affix||(this.affix={});h.mix(this.affix,e)},has:function(e){var g=this.data,f=this.affix;
return f&&e in f?!0:"object"===typeof g&&e in g},get:function(e){var g=this.data,f=this.affix;if(f&&e in f)return f[e];if("object"===typeof g&&e in g)return g[e]},resolve:function(e,g){"."===e&&(e="this");var f=e.split("."),d=this,c,b,a,h,k;if("root"===f[0])f.shift(),d=d.root;else if(g)for(;d&&g--;)d=d.parent;var m=0;for(c=f.length;d;){k=1;a=d;for(b=0;b<c;b++)if(h=f[b],"this"===h)m=1;else if(a===d){if(!d.has(h)){k=0;break}a=d.get(h)}else{if("object"!==typeof a||!(h in a)){k=0;break}a=a[h]}if(k)return a&&
a.isScope&&(a=a.data),"function"===typeof a&&(a=a.call(this.data)),[a];if(m)break;d=d.parent}return!1}};return i});
KISSY.add("xtemplate/runtime/commands",["path","./scope"],function(h,i){var e,g=i("path"),f=i("./scope");return e={each:function(d,c){var b=c.params,a=b[0],e="xindex",k;3===b.length?(e=b[1],k=b[2]):2===b.length&&(k=b[1]);var b="",m,n,p;if(a)if(n=new f,h.isArray(a)){m=a.length;for(var g=0;g<m;g++)n.data=a[g],p=n.affix={xcount:m},p[e]=g,k&&(p[k]=a[g]),n.setParent(d),b+=c.fn(n)}else for(m in a)n.data=a[m],p=n.affix={},p[e]=m,k&&(p[k]=a[m]),n.setParent(d),b+=c.fn(n);else c.inverse&&(b=c.inverse(d));return b},
"with":function(d,c){var b=c.params[0],a="";b?(b=new f(b),b.setParent(d),a=c.fn(b)):c.inverse&&(a=c.inverse(d));return a},"if":function(d,c){var b="";c.params[0]?c.fn&&(b=c.fn(d)):c.inverse&&(b=c.inverse(d));return b},set:function(d,c){d.mix(c.hash);return""},include:function(d,c){var b=c.params;if(!b||1!==b.length)return"include must has one param","";if(c.hash){var a=new f(c.hash);a.setParent(d);d=a}a=this.config.name;b=b[0];if("."===b.charAt(0)){if("unspecified"===a)return"parent template does not have name for relative sub tpl name: "+
b,"";b=g.resolve(a,"../",b)}a=this.config.loader.call(this,b);c=h.merge(this.config);c.name=b;c.commands=this.config.commands;c.macros=this.config.macros;return this.invokeEngine(a,d,c)},macro:function(d,c){var b=c.params,a=b[0],e=b.slice(1),b=this.config.macros;if(c.fn)b[a]||(b[a]={paramNames:e,fn:c.fn});else{var k={};(a=b[a])||"can not find macro:"+name;h.each(a.paramNames,function(b,a){k[b]=e[a]});b=new f(k);return a.fn.call(this,b)}return""},parse:function(d,c){return e.include.call(this,new f,
c)}}});
KISSY.add("xtemplate/runtime",["./runtime/commands","./runtime/scope"],function(h,i){function e(b){b}function g(b,a){for(var c=a.split("."),e=b,d=c.length,g=0;g<d&&!(e=e[c[g]],!e);g++);return e}function f(b,c){this.tpl=b;c=h.merge(r,c);c.commands=h.merge(c.commands,d);c.utils=a;c.macros=c.macros||{};this.config=c}var d=i("./runtime/commands"),c=i("./runtime/scope"),b=h.escapeHtml,a={runBlockCommand:function(b,c,a,d,f){var l=b.config,i=l.silent?e:h.error,o=l.commands,l=g(o,d);if(!l)if(!a.params&&!a.hash){var j=
c.resolve(d,void 0);!1===j?(i('can not find property: "'+d+'" at line '+f),j=""):j=j[0];l=o["if"];h.isArray(j)?l=o.each:"object"===typeof j&&(l=o["with"]);a.params=[j]}else return"can not find command module: "+d+'" at line '+f,"";i="";try{i=l.call(b,c,a)}catch(q){q.message+': "'+d+'" at line '+f}void 0===i&&(i="");return i},getExpression:function(a,c){void 0===a&&(a="");return c&&a?b(a):a},getPropertyOrRunCommand:function(a,c,d,f,i,l,r,o){var j,q=a.config,s=g(q.commands,f),q=q.silent?e:h.error;if(s)try{j=
s.call(a,c,d)}catch(t){return t.message+': "'+f+'" at line '+l,""}else{a=c.resolve(f,i);if(!1===a)return q('can not find property: "'+f+'" at line '+l,"warn"),o?void 0:"";j=a[0]}!o&&void 0===j&&(j="");return r&&j?b(j):j}},r={silent:!0,name:"unspecified",loader:function(a){var b=h.require(a);b||'template "'+a+'" does not exist, need to be required or used first!';return b}};h.mix(f,{commands:d,utils:a,addCommand:function(a,b){d[a]=b},removeCommand:function(a){delete d[a]}});f.prototype={constructor:f,
invokeEngine:function(a,b,c){return(new this.constructor(a,c)).render(b,!0)},removeCommand:function(a){delete this.config.commands[a]},addCommand:function(a,b){this.config.commands[a]=b},render:function(a){var b=a;if(!b||!b.isScope)b=new c(a);return this.tpl(b,h)}};f.Scope=c;return f});
