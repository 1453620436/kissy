/*
Copyright 2013, KISSY v1.50dev
MIT Licensed
build time: Nov 29 12:48
*/
KISSY.add("xtemplate/runtime/scope",[],function(h){function j(e,g){this.data=e||{};this.affix=g;this.root=this}j.prototype={isScope:1,setParent:function(e){this.parent=e;this.root=e.root},getParent:function(){return this.parent},getRoot:function(){return this.root},set:function(e,g){this.affix||(this.affix={});this.affix[e]=g},setData:function(e){this.data=e},getData:function(){return this.data},mix:function(e){this.affix||(this.affix={});h.mix(this.affix,e)},has:function(e){var g=this.data,f=this.affix;
return f&&e in f?!0:"object"===typeof g&&e in g},get:function(e){var g=this.data,f=this.affix;if(f&&e in f)return f[e];if("object"===typeof g&&e in g)return g[e]},resolve:function(e,g){"."===e&&(e="this");var f=e.split("."),d=this,c,b,a,h,i;if("root"===f[0])f.shift(),d=d.root;else if(g)for(;d&&g--;)d=d.parent;var m=0;for(c=f.length;d;){i=1;a=d;for(b=0;b<c;b++)if(h=f[b],"this"===h)m=1;else if(a===d){if(!d.has(h)){i=0;break}a=d.get(h)}else{if("object"!==typeof a||!(h in a)){i=0;break}a=a[h]}if(i)return a&&
a.isScope&&(a=a.data),"function"===typeof a&&(a=a.call(this.data)),[a];if(m)break;d=d.parent}return!1}};return j});
KISSY.add("xtemplate/runtime/commands",["path","./scope"],function(h,j){var e,g=j("path"),f=j("./scope");return e={each:function(d,c){var b=c.params,a=b[0],e=b[2]||"xindex",b=b[1],i="",m,n,p;if(a)if(n=new f,h.isArray(a)){m=a.length;for(var g=0;g<m;g++)n.data=a[g],p=n.affix={xcount:m},p[e]=g,b&&(p[b]=a[g]),n.setParent(d),i+=c.fn(n)}else for(m in a)n.data=a[m],p=n.affix={},p[e]=m,b&&(p[b]=a[m]),n.setParent(d),i+=c.fn(n);else c.inverse&&(i=c.inverse(d));return i},"with":function(d,c){var b=c.params[0],
a="";b?(b=new f(b),b.setParent(d),a=c.fn(b)):c.inverse&&(a=c.inverse(d));return a},"if":function(d,c){var b="";c.params[0]?c.fn&&(b=c.fn(d)):c.inverse&&(b=c.inverse(d));return b},set:function(d,c){d.mix(c.hash);return""},include:function(d,c){var b=c.params;if(!b||1!==b.length)return"include must has one param","";if(c.hash){var a=new f(c.hash);a.setParent(d);d=a}a=this.config.name;b=b[0];if("."===b.charAt(0)){if("unspecified"===a)return"parent template does not have name for relative sub tpl name: "+
b,"";b=g.resolve(a,"../",b)}a=this.config.loader.call(this,b);c=h.merge(this.config);c.name=b;c.commands=this.config.commands;c.macros=this.config.macros;return this.invokeEngine(a,d,c)},macro:function(d,c){var b=c.params,a=b[0],e=b.slice(1),b=this.config.macros;if(c.fn)b[a]||(b[a]={paramNames:e,fn:c.fn});else{var i={};(a=b[a])||"can not find macro:"+name;h.each(a.paramNames,function(b,a){i[b]=e[a]});b=new f(i);return a.fn.call(this,b)}return""},parse:function(d,c){return e.include.call(this,new f,
c)}}});
KISSY.add("xtemplate/runtime",["./runtime/commands","./runtime/scope"],function(h,j){function e(i){i}function g(i,b){for(var a=b.split("."),c=i,d=a.length,e=0;e<d&&!(c=c[a[e]],!c);e++);return c}function f(i,b){this.tpl=i;b=h.merge(r,b);b.commands=h.merge(b.commands,d);b.utils=a;b.macros=b.macros||{};this.config=b}var d=j("./runtime/commands"),c=j("./runtime/scope"),b=h.escapeHtml,a={runBlockCommand:function(b,a,c,d,f){var l=b.config,j=l.silent?e:h.error,o=l.commands,l=g(o,d);if(!l)if(!c.params&&!c.hash){var k=
a.resolve(d,void 0);!1===k?(j('can not find property: "'+d+'" at line '+f),k=""):k=k[0];l=o["if"];h.isArray(k)?l=o.each:"object"===typeof k&&(l=o["with"]);c.params=[k]}else return"can not find command module: "+d+'" at line '+f,"";j="";try{j=l.call(b,a,c)}catch(q){q.message+': "'+d+'" at line '+f}void 0===j&&(j="");return j},getExpression:function(a,c){void 0===a&&(a="");return c&&a?b(a):a},getPropertyOrRunCommand:function(a,c,d,f,j,l,r,o){var k,q=a.config,s=g(q.commands,f),q=q.silent?e:h.error;if(s)try{k=
s.call(a,c,d)}catch(t){return t.message+': "'+f+'" at line '+l,""}else{a=c.resolve(f,j);if(!1===a)return q('can not find property: "'+f+'" at line '+l,"warn"),o?void 0:"";k=a[0]}!o&&void 0===k&&(k="");return r&&k?b(k):k}},r={silent:!0,name:"unspecified",loader:function(a){var b=h.require(a);b||'template "'+a+'" does not exist, need to be required or used first!';return b}};h.mix(f,{commands:d,utils:a,addCommand:function(a,b){d[a]=b},removeCommand:function(a){delete d[a]}});f.prototype={constructor:f,
invokeEngine:function(a,b,c){return(new this.constructor(a,c)).render(b,!0)},removeCommand:function(a){delete this.config.commands[a]},addCommand:function(a,b){this.config.commands[a]=b},render:function(a){var b=a;if(!b||!b.isScope)b=new c(a);return this.tpl(b,h)}};f.Scope=c;return f});
