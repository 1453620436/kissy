/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 14 22:30
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(k,a){function f(b,c,j){var e=b.fn;if(e.version&&k.version!==e.version)throw Error("current xtemplate file("+b.name+")(v"+e.version+")need to be recompiled using current kissy(v"+k.version+")!");j=b.fn.call(b,c,j);if(e=b.session.extendTplName)delete b.session.extendTplName,j=b.root.include(e,b,c,j);return j.end()}function g(b,c,j,e,a,f,h,g){var d=b.root.config.commands,i;if(!f){i=a[0];d=
d&&d[i]||m[i];if(1!==a.length&&d){i=a.length;for(var l=1;l<i&&!(d=d[a[l]],!d);l++);}i=d}if(i)return i.call(b,c,j,e,h);a.join(".");return g&&(b=c.resolve(a.slice(0,-1),f),a=b[a[a.length-1]])?a.apply(b,j.params):e}function d(b,c){this.fn=b;this.config=c=c||{}}function b(b,c){if("."!==b.charAt(0))return b;var j=i[c]=i[c]||{};if(j[b])return j[b];var e=b,a,f=b;a=c.split("/");f=f.split("/");a.pop();for(var d=0,m=f.length;d<m;d++){var h=f[d];"."!==h&&(".."===h?a.pop():a.push(h))}a=a.join("/");return b=j[e]=
a}var c=a("util"),j=a("./runtime/commands"),m={},e=a("./runtime/scope"),l=a("./runtime/linked-buffer"),h={callFn:function(b,c,a,j,e,f,d){return g(b,c,a,j,e,f,d,!0)},callCommand:function(b,c,a,j,e,f){return g(b,c,a,j,e,0,f,!0)}};c.mix(d,{nativeCommands:j,utils:h,addCommand:function(b,c){m[b]=c},removeCommand:function(b){delete m[b]}});var i={};d.prototype={constructor:d,Scope:e,nativeCommands:j,utils:h,getTplContent:function(b,c){k.use(b,{success:function(b,a){c(void 0,a)},error:function(){c('template "'+
b+'" does not exist')}})},load:function(b,c){this.getTplContent(b,c)},removeCommand:function(b){var c=this.config;c.commands&&delete c.commands[b]},addCommand:function(b,c){var a=this.config;a.commands=a.commands||{};a.commands[b]=c},include:function(c,a,j,e){var d=this,c=b(c,a.name);return e.async(function(b){d.load(c,function(e,d){e?b.error(e):f({root:a.root,fn:d,name:c,session:a.session},j,b)})})},render:function(b,c){var a="",j=this.fn,c=c||function(b,c){a=c},d=this.config.name;!d&&j.TPL_NAME&&
(d=j.TPL_NAME);var m=new e(b),h=(new l(c)).head;f({name:d,fn:j,session:{},root:this},m,h);return a}};d.Scope=e;return d});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(k,a){var f=a("./scope"),g=a("util"),d={each:function(b,c,a){var d=c.params,e=d[0],l=d[2]||"xindex",d=d[1],h,i,n;if(e)if(g.isArray(e)){h=e.length;for(var k=0;k<h;k++)i=new f(e[k]),n=i.affix={xcount:h},n[l]=k,d&&(n[d]=e[k]),i.setParent(b),a=c.fn(i,a)}else for(h in e)i=new f(e[h]),n=i.affix={},n[l]=h,d&&(n[d]=e[h]),i.setParent(b),a=c.fn(i,a);return a},"with":function(b,c,a){var d=c.params[0];d&&(d=new f(d),d.setParent(b),a=c.fn(d,a));
return a},"if":function(b,c,a){c.params[0]?c.fn&&(a=c.fn(b,a)):c.inverse&&(a=c.inverse(b,a));return a},set:function(b,c,a){b.mix(c.hash);return a},include:function(b,c,a){var d=c.params,e,g=d.length;e=b;c.hash&&(e=new f(c.hash),e.setParent(b));for(b=0;b<g;b++)a=this.root.include(d[b],this,e,a);return a},parse:function(b,c,a){return d.include.call(this,new f,c,a)},extend:function(b,c,a){this.session.extendTplName=c.params[0];return a},block:function(b,a,d){var f=this.session,e=a.params,g=e[0],h;2===
e.length&&(h=e[0],g=e[1]);var e=f.blocks=f.blocks||{},i=e[g],a={fn:a.fn,type:h};if(i){if(i.type)if("append"===i.type)a.next=i,e[g]=a;else if("prepend"===i.type){var k;for(h=i;h&&"prepend"===h.type;)k=h,h=h.next;a.next=h;k.next=a}}else e[g]=a;if(!f.extendTplName)for(h=e[g];h;)h.fn&&(d=h.fn.call(this,b,d)),h=h.next;return d},macro:function(b,a,d){var b=a.params,g=b[0],b=b.slice(1),e=this.session,e=e.macros=e.macros||{};if(a.fn)e[g]={paramNames:b,fn:a.fn};else{var a={},g=e[g],k;if(g&&(k=g.paramNames)){for(var e=
0,h=k.length;e<h;e++)a[k[e]]=b[e];k=new f(a);d=g.fn.call(this,k,d)}}return d}};return d});
KISSY.add("xtemplate/runtime/scope",[],function(){function k(a,f){this.data=a||{};this.affix=f;this.root=this}k.prototype={isScope:1,setParent:function(a){this.parent=a;this.root=a.root},set:function(a,f){this.affix||(this.affix={});this.affix[a]=f},setData:function(a){this.data=a},getData:function(){return this.data},mix:function(a){var f=this.affix;f||(f=this.affix={});for(var g in a)f[g]=a[g]},get:function(a){var f=this.data,g=f&&f[a];if(void 0!==g)return g;g=(g=this.affix)&&g[a];return void 0!==
g?g:"this"===a?f:"root"===a?this.root.data:g},resolve:function(a,f){if(!f&&1===a.length)return this.get(a[0]);var g=a.length,d=this,b;if(g&&"root"===a[0])a.shift(),d=d.root,g--;else if(f)for(;d&&f--;)d=d.parent;if(!g)return d.data;var c=a[0];do b=d.get(c);while(void 0===b&&(d=d.parent));if(b&&d){for(d=1;b&&d<g;d++)b=b[a[d]];return b}}};return k});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(k,a){function f(a){this.list=a;this.data=""}function g(a){this.head=new f(this);this.callback=a;this.data=""}var d=a("util");f.prototype={constructor:f,isBuffer:1,write:function(a,c){if(a||0===a)this.data+=c?d.escapeHtml(a):a;return this},async:function(a){var c=this.list,d=new f(c),c=new f(c);c.next=this.next;d.next=c;this.next=d;this.ready=!0;a(d);return c},error:function(a){var c=this.list.callback;c&&(c(a,void 0),this.list.callback=
null)},end:function(a,c){this.list.callback&&(this.write(a,c),this.ready=!0,this.list.flush());return this}};g.prototype={constructor:g,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};g.Buffer=f;return g});
