/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 4 12:51
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(l,g){function f(a,b,d){var f=a.fn;if(f.version&&l.version!==f.version)throw Error("current xtemplate file("+a.name+")(v"+f.version+")need to be recompiled using current kissy(v"+l.version+")!");d=a.fn(b,d);if(f=a.runtime.extendTplName)delete a.runtime.extendTplName,d=a.root.include(f,a,b,d);return d.end()}function j(a,b,d,f,c,e,i,j){var k;if(!e){k=a.runtime.commands;var m=a.root.config.commands,
g=c[0];k=k&&k[g]||m&&m[g]||h[g];if(1!==c.length&&k){m=c.length;for(g=1;g<m&&!(k=k[c[g]],!k);g++);}}if(k)return k.call(a,b,d,f,i);c.join(".");return j&&(a=b.resolve(c.slice(0,-1),e),c=a[c[c.length-1]])?c.apply(a,d.params):f}function e(a,b){this.fn=a;this.config=b=b||{}}function a(a,b){if("."!==a.charAt(0))return a;var d=k[b]=k[b]||{};if(d[a])return d[a];var f=a,c,h=a;c=b.split("/");h=h.split("/");c.pop();for(var e=0,i=h.length;e<i;e++){var j=h[e];"."!==j&&(".."===j?c.pop():c.push(j))}c=c.join("/");
return a=d[f]=c}var b=g("util"),d=g("./runtime/commands"),h={},c=g("./runtime/scope"),m=g("./runtime/linked-buffer"),i={callFn:function(a,b,c,d,f,h,e){return j(a,b,c,d,f,h,e,!0)},callCommand:function(a,b,c,d,f,h){return j(a,b,c,d,f,0,h,!0)}};b.mix(e,{nativeCommands:d,utils:i,addCommand:function(a,b){h[a]=b},removeCommand:function(a){delete h[a]}});var k={};e.prototype={constructor:e,Scope:c,nativeCommands:d,utils:i,getTplContent:function(a,b){l.use(a,{success:function(a,c){b(void 0,c)},error:function(){b('template "'+
a+'" does not exist')}})},load:function(a,b){this.getTplContent(a,b)},removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var c=this.config;c.commands=c.commands||{};c.commands[a]=b},include:function(b,c,d,h){var e=this,b=a(b,c.name);return h.async(function(a){e.load(b,function(h,e){h?a.error(h):f({root:c.root,fn:e,name:b,runtime:c.runtime},d,a)})})},render:function(a,b,d){var h="",e=this.fn;"function"===typeof b&&(d=b,b=null);var b=b||{},d=d||function(a,
b){h=b},i=this.config.name;!i&&e.TPL_NAME&&(i=e.TPL_NAME);a=new c(a);d=(new m(d)).head;f({name:i,fn:e,runtime:{commands:b.commands},root:this},a,d);return h}};e.Scope=c;return e});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(l,g){var f=g("./scope"),j=g("util"),e={each:function(a,b,d){var h=b.params,c=h[0],e=h[2]||"xindex",h=h[1],i,k,g;if(c)if(j.isArray(c)){i=c.length;for(var l=0;l<i;l++)k=new f(c[l]),g=k.affix={xcount:i},g[e]=l,h&&(g[h]=c[l]),k.setParent(a),d=b.fn(k,d)}else for(i in c)k=new f(c[i]),g=k.affix={},g[e]=i,h&&(g[h]=c[i]),k.setParent(a),d=b.fn(k,d);return d},"with":function(a,b,d){var h=b.params[0];h&&(h=new f(h),h.setParent(a),d=b.fn(h,d));
return d},"if":function(a,b,d){b.params[0]?b.fn&&(d=b.fn(a,d)):b.inverse&&(d=b.inverse(a,d));return d},set:function(a,b,d){a.mix(b.hash);return d},include:function(a,b,d){var h=b.params,c,e=h.length;c=a;b.hash&&(c=new f(b.hash),c.setParent(a));for(a=0;a<e;a++)d=this.root.include(h[a],this,c,d);return d},parse:function(a,b,d){return e.include.call(this,new f,b,d)},extend:function(a,b,d){this.runtime.extendTplName=b.params[0];return d},block:function(a,b,d){var f=this.runtime,c=b.params,e=c[0],i;2===
c.length&&(i=c[0],e=c[1]);var c=f.blocks=f.blocks||{},g=c[e],b={fn:b.fn,type:i};if(g){if(g.type)if("append"===g.type)b.next=g,c[e]=b;else if("prepend"===g.type){var j;for(i=g;i&&"prepend"===i.type;)j=i,i=i.next;b.next=i;j.next=b}}else c[e]=b;if(!f.extendTplName)for(i=c[e];i;)i.fn&&(d=i.fn.call(this,a,d)),i=i.next;return d},macro:function(a,b,d){var a=b.params,e=a[0],a=a.slice(1),c=this.runtime,c=c.macros=c.macros||{};if(b.fn)c[e]={paramNames:a,fn:b.fn};else{var b={},e=c[e],g;if(e&&(g=e.paramNames)){for(var c=
0,i=g.length;c<i;c++)b[g[c]]=a[c];g=new f(b);d=e.fn.call(this,g,d)}}return d}};return e});
KISSY.add("xtemplate/runtime/scope",[],function(){function l(f){this.data=arguments.length?f:{};this.affix=g;this.root=this}var g;l.prototype={isScope:1,setParent:function(f){this.parent=f;this.root=f.root},set:function(f,g){this.affix||(this.affix={});this.affix[f]=g},setData:function(f){this.data=f},getData:function(){return this.data},mix:function(f){var g=this.affix;g||(g=this.affix={});for(var e in f)g[e]=f[e]},get:function(f){var j=this.data,e;e=(e=this.affix)&&e[f];if(e!==g)return e;j!==g&&
(e=j[f]);return e!==g?e:"this"===f?j:"root"===f?this.root.data:e},resolve:function(f,j){if(!j&&1===f.length)return this.get(f[0]);var e=f.length,a=this,b;if(e&&"root"===f[0])f.shift(),a=a.root,e--;else if(j)for(;a&&j--;)a=a.parent;if(!e)return a.data;var d=f[0];do b=a.get(d);while(b===g&&(a=a.parent));if(b&&a){for(a=1;b&&a<e;a++)b=b[f[a]];return b}return g}};return l});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(l,g){function f(a){this.list=a;this.data=""}function j(a){this.head=new f(this);this.callback=a;this.data=""}var e=g("util");f.prototype={constructor:f,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?e.escapeHtml(a):a;return this},async:function(a){var b=this.list,d=new f(b),b=new f(b);b.next=this.next;d.next=b;this.next=d;this.ready=!0;a(d);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=
null)},end:function(a,b){this.list.callback&&(this.write(a,b),this.ready=!0,this.list.flush());return this}};j.prototype={constructor:j,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};j.Buffer=f;return j});
