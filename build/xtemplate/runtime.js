/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 29 15:34
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(l,g){function f(a,b,d){var f=a.fn;if(f.version&&l.version!==f.version)throw Error("current xtemplate file("+a.name+")(v"+f.version+")need to be recompiled using current kissy(v"+l.version+")!");d=a.fn.call(a,b,d);if(f=a.session.extendTplName)delete a.session.extendTplName,d=a.root.include(f,a,b,d);return d.end()}function k(a,b,d,f,c,e,i,k){var j=a.root.config.commands,m;if(!e){m=c[0];j=
j&&j[m]||h[m];if(1!==c.length&&j){m=c.length;for(var g=1;g<m&&!(j=j[c[g]],!j);g++);}m=j}if(m)return m.call(a,b,d,f,i);c.join(".");return k&&(a=b.resolve(c.slice(0,-1),e),c=a[c[c.length-1]])?c.apply(a,d.params):f}function e(a,b){this.fn=a;this.config=b=b||{}}function a(a,b){if("."!==a.charAt(0))return a;var d=j[b]=j[b]||{};if(d[a])return d[a];var f=a,c,h=a;c=b.split("/");h=h.split("/");c.pop();for(var e=0,i=h.length;e<i;e++){var m=h[e];"."!==m&&(".."===m?c.pop():c.push(m))}c=c.join("/");return a=d[f]=
c}var b=g("util"),d=g("./runtime/commands"),h={},c=g("./runtime/scope"),m=g("./runtime/linked-buffer"),i={callFn:function(a,b,c,d,f,h,e){return k(a,b,c,d,f,h,e,!0)},callCommand:function(a,b,c,d,f,h){return k(a,b,c,d,f,0,h,!0)}};b.mix(e,{nativeCommands:d,utils:i,addCommand:function(a,b){h[a]=b},removeCommand:function(a){delete h[a]}});var j={};e.prototype={constructor:e,Scope:c,nativeCommands:d,utils:i,getTplContent:function(a,b){l.use(a,{success:function(a,c){b(void 0,c)},error:function(){b('template "'+
a+'" does not exist')}})},load:function(a,b){this.getTplContent(a,b)},removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var c=this.config;c.commands=c.commands||{};c.commands[a]=b},include:function(b,c,d,h){var e=this,b=a(b,c.name);return h.async(function(a){e.load(b,function(h,e){h?a.error(h):f({root:c.root,fn:e,name:b,session:c.session},d,a)})})},render:function(a,b){var d="",h=this.fn,b=b||function(a,b){d=b},e=this.config.name;!e&&h.TPL_NAME&&
(e=h.TPL_NAME);var i=new c(a),j=(new m(b)).head;f({name:e,fn:h,session:{},root:this},i,j);return d}};e.Scope=c;return e});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(l,g){var f=g("./scope"),k=g("util"),e={each:function(a,b,d){var h=b.params,c=h[0],e=h[2]||"xindex",h=h[1],i,j,g;if(c)if(k.isArray(c)){i=c.length;for(var l=0;l<i;l++)j=new f(c[l]),g=j.affix={xcount:i},g[e]=l,h&&(g[h]=c[l]),j.setParent(a),d=b.fn(j,d)}else for(i in c)j=new f(c[i]),g=j.affix={},g[e]=i,h&&(g[h]=c[i]),j.setParent(a),d=b.fn(j,d);return d},"with":function(a,b,d){var h=b.params[0];h&&(h=new f(h),h.setParent(a),d=b.fn(h,d));
return d},"if":function(a,b,d){b.params[0]?b.fn&&(d=b.fn(a,d)):b.inverse&&(d=b.inverse(a,d));return d},set:function(a,b,d){a.mix(b.hash);return d},include:function(a,b,d){var h=b.params,c,e=h.length;c=a;b.hash&&(c=new f(b.hash),c.setParent(a));for(a=0;a<e;a++)d=this.root.include(h[a],this,c,d);return d},parse:function(a,b,d){return e.include.call(this,new f,b,d)},extend:function(a,b,d){this.session.extendTplName=b.params[0];return d},block:function(a,b,d){var f=this.session,c=b.params,e=c[0],i;2===
c.length&&(i=c[0],e=c[1]);var c=f.blocks=f.blocks||{},j=c[e],b={fn:b.fn,type:i};if(j){if(j.type)if("append"===j.type)b.next=j,c[e]=b;else if("prepend"===j.type){var g;for(i=j;i&&"prepend"===i.type;)g=i,i=i.next;b.next=i;g.next=b}}else c[e]=b;if(!f.extendTplName)for(i=c[e];i;)i.fn&&(d=i.fn.call(this,a,d)),i=i.next;return d},macro:function(a,b,d){var a=b.params,e=a[0],a=a.slice(1),c=this.session,c=c.macros=c.macros||{};if(b.fn)c[e]={paramNames:a,fn:b.fn};else{var b={},e=c[e],g;if(e&&(g=e.paramNames)){for(var c=
0,i=g.length;c<i;c++)b[g[c]]=a[c];g=new f(b);d=e.fn.call(this,g,d)}}return d}};return e});
KISSY.add("xtemplate/runtime/scope",[],function(){function l(f){this.data=arguments.length?f:{};this.affix=g;this.root=this}var g;l.prototype={isScope:1,setParent:function(f){this.parent=f;this.root=f.root},set:function(f,g){this.affix||(this.affix={});this.affix[f]=g},setData:function(f){this.data=f},getData:function(){return this.data},mix:function(f){var g=this.affix;g||(g=this.affix={});for(var e in f)g[e]=f[e]},get:function(f){var k=this.data,e;e=(e=this.affix)&&e[f];if(e!==g)return e;k!==g&&
(e=k[f]);return e!==g?e:"this"===f?k:"root"===f?this.root.data:e},resolve:function(f,k){if(!k&&1===f.length)return this.get(f[0]);var e=f.length,a=this,b;if(e&&"root"===f[0])f.shift(),a=a.root,e--;else if(k)for(;a&&k--;)a=a.parent;if(!e)return a.data;var d=f[0];do b=a.get(d);while(b===g&&(a=a.parent));if(b&&a){for(a=1;b&&a<e;a++)b=b[f[a]];return b}return g}};return l});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(l,g){function f(a){this.list=a;this.data=""}function k(a){this.head=new f(this);this.callback=a;this.data=""}var e=g("util");f.prototype={constructor:f,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?e.escapeHtml(a):a;return this},async:function(a){var b=this.list,d=new f(b),b=new f(b);b.next=this.next;d.next=b;this.next=d;this.ready=!0;a(d);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=
null)},end:function(a,b){this.list.callback&&(this.write(a,b),this.ready=!0,this.list.flush());return this}};k.prototype={constructor:k,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};k.Buffer=f;return k});
