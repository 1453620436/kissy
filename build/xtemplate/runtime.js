/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Jun 11 20:12
*/
KISSY.add("xtemplate/runtime",["util","logger","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(p,e,o,l){function i(b,a,c){var h=b.fn;if(h.version&&KISSY.version!==h.version)throw Error("current xtemplate file("+b.name+")(v"+h.version+")need to be recompiled using current kissy(v"+KISSY.version+")!");c=b.fn(a,c);if(h=b.runtime.extendTplName)delete b.runtime.extendTplName,c=b.root.include(h,b,a,null,c);return c.end()}function j(a,m,h,d,g,f,k,i){var n;if(!f){n=a.runtime.commands;
var j=a.root.config.commands,e=g[0];n=n&&n[e]||j&&j[e]||c[e];if(1!==g.length&&n){j=g.length;for(e=1;e<j&&!(n=n[g[e]],!n);e++);}}if(n)return n.call(a,m,h,d,k);a="in file: "+a.name+" can not call: "+g.join(".")+'" at line '+k;if(i&&(m=m.resolve(g.slice(0,-1),f),g=m[g[g.length-1]]))return g.apply(m,h.params);a&&b.error(a);return d}function d(b,a){this.fn=b;this.config=a=a||{}}function a(a,c){if("."!==a.charAt(0))return a;c||b.error("parent template does not have name for relative sub tpl name: "+a);
var h=f[c]=f[c]||{};if(h[a])return h[a];var g=a,d,k=a;d=c.split("/");k=k.split("/");d.pop();for(var i=0,j=k.length;i<j;i++){var e=k[i];"."!==e&&(".."===e?d.pop():d.push(e))}d=d.join("/");return a=h[g]=d}var p=e("util"),b=e("logger"),o=e("./runtime/commands"),c={},h=e("./runtime/scope"),g=e("./runtime/linked-buffer"),k={callFn:function(a,b,c,h,g,d,f){return j(a,b,c,h,g,d,f,!0)},callCommand:function(a,b,c,h,g,d){return j(a,b,c,h,g,0,d,!0)}};p.mix(d,{nativeCommands:o,utils:k,addCommand:function(a,b){c[a]=
b},removeCommand:function(a){delete c[a]}});var f={};d.prototype={constructor:d,Scope:h,nativeCommands:o,utils:k,getTplContent:function(a,c){e([a],{success:function(a){c(void 0,a)},error:function(){var h='template "'+a+'" does not exist';b.log(h,"error");c(h)}})},load:function(a,b){this.getTplContent(a,b)},removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var c=this.config;c.commands=c.commands||{};c.commands[a]=b},include:function(b,c,h,g,d){var f=
this,b=a(b,c.name);return d.async(function(a){f.load(b,function(d,f){d?a.error(d):"string"===typeof f?a.write(f,g&&g.escape).end():i({root:c.root,fn:f,name:b,runtime:c.runtime},h,a)})})},render:function(a,b,c){var d="",f=this.fn;"function"===typeof b&&(c=b,b=null);var b=b||{},c=c||function(a,b){d=b},k=this.config.name;!k&&f.TPL_NAME&&(k=f.TPL_NAME);a=new h(a);c=(new g(c)).head;i({name:k,fn:f,runtime:{commands:b.commands},root:this},a,c);return d}};d.Scope=h;l.exports=d});
KISSY.add("xtemplate/runtime/commands",["./scope","util"],function(p,e,o,l){var i=e("./scope"),j=e("util"),d={each:function(a,b,c){var h=b.params,d=h[0],k=h[2]||"xindex",h=h[1],f,e,m;if(d)if(j.isArray(d)){f=d.length;for(var l=0;l<f;l++)e=new i(d[l]),m=e.affix={xcount:f},m[k]=l,h&&(m[h]=d[l]),e.setParent(a),c=b.fn(e,c)}else for(f in d)e=new i(d[f]),m=e.affix={},m[k]=f,h&&(m[h]=d[f]),e.setParent(a),c=b.fn(e,c);return c},"with":function(a,b,c){var d=b.params[0];d&&(d=new i(d),d.setParent(a),c=b.fn(d,
c));return c},"if":function(a,b,c){b.params[0]?b.fn&&(c=b.fn(a,c)):b.inverse&&(c=b.inverse(a,c));return c},set:function(a,b,c){a.mix(b.hash);return c},include:function(a,b,c){var d=b.params,g,e=d.length;g=a;b.hash&&(g=new i(b.hash),g.setParent(a));for(a=0;a<e;a++)c=this.root.include(d[a],this,g,b,c);return c},parse:function(a,b,c){return d.include.call(this,new i,b,c)},extend:function(a,b,c){this.runtime.extendTplName=b.params[0];return c},block:function(a,b,c){var d=this.runtime,g=b.params,e=g[0],
f;2===g.length&&(f=g[0],e=g[1]);var g=d.blocks=d.blocks||{},i=g[e],b={fn:b.fn,type:f};if(i){if(i.type)if("append"===i.type)b.next=i,g[e]=b;else if("prepend"===i.type){var j;for(f=i;f&&"prepend"===f.type;)j=f,f=f.next;b.next=f;j.next=b}}else g[e]=b;if(!d.extendTplName)for(f=g[e];f;)f.fn&&(c=f.fn.call(this,a,c)),f=f.next;return c},macro:function(a,b,c,d){var a=b.params,g=a[0],a=a.slice(1),e=this.runtime,e=e.macros=e.macros||{};if(b.fn)e[g]={paramNames:a,fn:b.fn};else{var b={},g=e[g],f;if(g&&(f=g.paramNames)){d=
0;for(e=f.length;d<e;d++)b[f[d]]=a[d];f=new i(b);c=g.fn.call(this,f,c)}else throw Error("in file: "+this.name+" can not find macro: "+name+'" at line '+d);}return c}};l.exports=d});
KISSY.add("xtemplate/runtime/scope",[],function(p,e,o,l){function i(d){this.data=arguments.length?d:{};this.affix=j;this.root=this}var j;i.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,a){this.affix||(this.affix={});this.affix[d]=a},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){var a=this.affix;a||(a=this.affix={});for(var b in d)a[b]=d[b]},get:function(d){var a=this.data,b;b=(b=this.affix)&&b[d];if(b!==j)return b;
a!==j&&(b=a[d]);return b!==j?b:"this"===d?a:"root"===d?this.root.data:b},resolve:function(d,a){if(!a&&1===d.length)return this.get(d[0]);var b=d.length,c=this,e;if(b&&"root"===d[0])d.shift(),c=c.root,b--;else if(a)for(;c&&a--;)c=c.parent;if(!b)return c.data;var g=d[0];do e=c.get(g);while(e===j&&(c=c.parent));if(e&&c){for(c=1;e&&c<b;c++)e=e[d[c]];return e}return j}};l.exports=i});
KISSY.add("xtemplate/runtime/linked-buffer",["util"],function(p,e,o,l){function i(a){this.list=a;this.data=""}function j(a){this.head=new i(this);this.callback=a;this.data=""}var d=e("util");i.prototype={constructor:i,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?d.escapeHtml(a):a;return this},async:function(a){var b=this.list,c=new i(b),b=new i(b);b.next=this.next;c.next=b;this.next=c;this.ready=!0;a(c);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=
null)},end:function(a,b){this.list.callback&&(this.write(a,b),this.ready=!0,this.list.flush());return this}};j.prototype={constructor:j,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};j.Buffer=i;l.exports=j});
