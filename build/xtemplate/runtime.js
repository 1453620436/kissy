/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 29 15:13
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(k,f){function d(a,b){var e=a.split("/"),i=b.split("/");e.pop();for(var d=0,c=i.length;d<c;d++){var j=i[d];"."!==j&&(".."===j?e.pop():e.push(j))}return e.join("/")}function c(a,b,e,i){var d=a.tpl,i=i||{};i.extendTplName=null;d.TPL_NAME&&!a.name&&(a.name=d.TPL_NAME);e=d.call(a,b,e,i);(d=i.extendTplName)&&(e=a.include(d,b,e,i));return e.end()}function b(a,b,e,d,c,j,g,h){var f=a.config.commands,
k;if(!j){k=c[0];f=f&&f[k]||i[k];if(1!==c.length&&f){k=c.length;for(var n=1;n<k&&!(f=f[c[n]],!f);n++);}k=f}if(k)return k.call(a,b,e,d,g);c.join(".");return h&&(a=b.resolve(c.slice(0,-1),j),c=a[c[c.length-1]])?c.apply(a,e.params):d}function a(a,b){this.tpl=a;b=b||{};b.name&&(this.name=b.name);this.config=b}f("util");var e=f("./runtime/commands"),i={},j=f("./runtime/scope"),h=f("./runtime/linked-buffer"),g={callFn:function(a,e,i,d,c,j,g){return b(a,e,i,d,c,j,g,!0)},callCommand:function(a,e,i,d,c,j){return b(a,
e,i,d,c,0,j,!0)}};k.mix(a,{nativeCommands:e,utils:g,addCommand:function(a,b){i[a]=b},removeCommand:function(a){delete i[a]}});a.prototype={constructor:a,Scope:j,nativeCommands:e,utils:g,load:function(a,b){var e=k.require(a);e?b(void 0,e):b('template "'+a+'" does not exist, better required or used first for performance!',void 0)},removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var e=this.config;e.commands=e.commands||{};e.commands[a]=b},include:function(b,
e,i,j){var g=this,h=g.name;if("."===b.charAt(0)){if(!h)throw Error("parent template does not have name for relative sub tpl name: "+b);b=d(h,b)}return i.async(function(i){g.load(b,function(d,h){d?i.error(d):(h instanceof a||(h=new g.constructor(h,g.config),h.name=b),c(h,e,i,j))})})},render:function(a,b){var e="",b=b||function(a,b){e=b};!this.name&&this.tpl.TPL_NAME&&(this.name=this.tpl.TPL_NAME);var i=new j(a),d=(new h(b)).head;c(this,i,d);return e}};a.Scope=j;return a});
KISSY.add("xtemplate/runtime/commands",["./scope"],function(k,f){var d=f("./scope"),c={each:function(b,a,e){var i=a.params,c=i[0],h=i[2]||"xindex",i=i[1],g,f,l;if(c)if(k.isArray(c)){g=c.length;for(var m=0;m<g;m++)f=new d,l=f.affix={xcount:g},f.data=c[m],l[h]=m,i&&(l[i]=c[m]),f.setParent(b),e=a.fn(f,e)}else for(g in c)f=new d,l=f.affix={},f.data=c[g],l[h]=g,i&&(l[i]=c[g]),f.setParent(b),e=a.fn(f,e);return e},"with":function(b,a,e){var c=a.params[0];c&&(c=new d(c),c.setParent(b),e=a.fn(c,e));return e},
"if":function(b,a,e){a.params[0]?a.fn&&(e=a.fn(b,e)):a.inverse&&(e=a.inverse(b,e));return e},set:function(b,a,e){b.mix(a.hash);return e},include:function(b,a,e,c,f){var c=a.params,h,g=c.length;h=b;a.hash&&(h=new d(a.hash),h.setParent(b));for(b=0;b<g;b++)e=this.include(c[b],h,e,f);return e},parse:function(b,a,e,i,f){return c.include.call(this,new d,a,e,f)},extend:function(b,a,c,d,f){f.extendTplName=a.params[0];return c},block:function(b,a,c,d,f){var h=a.params,d=h[0],g;2===h.length&&(g=h[0],d=h[1]);
var h=f.blocks=f.blocks||{},k=h[d],a={fn:a.fn,type:g};if(k){if(k.type)if("append"===k.type)a.next=k,h[d]=a;else if("prepend"===k.type){var l;for(g=k;g&&"prepend"===g.type;)l=g,g=g.next;a.next=g;l.next=a}}else h[d]=a;if(!f.extendTplName)for(g=h[d];g;)g.fn&&(c=g.fn.call(this,b,c)),g=g.next;return c},macro:function(b,a,c,f,j){b=a.params;f=b[0];b=b.slice(1);j=j.macros=j.macros||{};if(a.fn)j[f]={paramNames:b,fn:a.fn};else{var a={},j=j[f],h;if(j&&(h=j.paramNames)){for(var f=0,g=h.length;f<g;f++)a[h[f]]=
b[f];h=new d(a);c=j.fn.call(this,h,c)}}return c}};return c});
KISSY.add("xtemplate/runtime/scope",[],function(k){function f(d,c){this.data=d||{};this.affix=c;this.root=this}f.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,c){this.affix||(this.affix={});this.affix[d]=c},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){this.affix||(this.affix={});k.mix(this.affix,d)},get:function(d){var c=this.data,b=c&&c[d];if(void 0!==b)return b;var a=this.affix;return a&&d in a?a[d]:"this"===d?
c:"root"===d?this.root.data:b},resolve:function(d,c){if(!c&&1===d.length)return this.get(d[0]);var b=d.length,a,e;a=this;if(b&&"root"===d[0])d.shift(),a=a.root,b--;else if(c)for(;a&&c--;)a=a.parent;if(!b)return a.data;var f=d[0];do e=a.get(f);while(void 0===e&&(a=a.parent));if(e&&a){for(a=1;e&&a<b;a++)e=e[d[a]];return e}}};return f});
KISSY.add("xtemplate/runtime/linked-buffer",[],function(k){function f(c){this.list=c;this.data=""}function d(c){this.head=new f(this);this.callback=c;this.data=""}f.prototype={constructor:f,isBuffer:1,write:function(c,b){if(c||0===c)this.data+=b?k.escapeHtml(c):c;return this},async:function(c){var b=this.list,a=new f(b),b=new f(b);b.next=this.next;a.next=b;this.next=a;this.ready=!0;c(a);return b},error:function(c){var b=this.list.callback;b&&(b(c,void 0),this.list.callback=null)},end:function(c,b){this.list.callback&&
(this.write(c,b),this.ready=!0,this.list.flush());return this}};d.prototype={constructor:d,flush:function(){for(var c=this.head;c;){if(c.ready)this.data+=c.data;else return;this.head=c=c.next}this.callback(null,this.data)}};d.Buffer=f;return d});
