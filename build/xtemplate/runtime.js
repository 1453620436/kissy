/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 24 17:47
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(m,e){function d(a,f){var c=a.split("/"),h=f.split("/");c.pop();for(var d=0,b=h.length;d<b;d++){var i=h[d];"."!==i&&(".."===i?c.pop():c.push(i))}return c.join("/")}function b(a,f,c,h){var d=a.tpl,h=h||{};h.extendTplName=null;d.TPL_NAME&&!a.name&&(a.name=d.TPL_NAME);c=d.call(a,f,c,h);(d=h.extendTplName)&&(c=a.include(d,f,c,h));return c.end()}function f(a,c){this.tpl=a;c=c||{};c.name&&(this.name=
c.name);this.config=c}e("util");var a=e("./runtime/commands"),c={},h=e("./runtime/scope"),i=e("./runtime/linked-buffer"),g={callCommand:function(a,f,h,d,b,i){var g=a.config.commands;if(-1===b.indexOf("."))b=g&&g[b]||c[b];else{b=b.split(".");if(g=g&&g[b[0]]||c[b[0]])for(var e=b.length,o=1;o<e&&!(g=g[b[o]],!g);o++);b=g}return b?b.call(a,f,h,d,i):d}};m.mix(f,{nativeCommands:a,utils:g,addCommand:function(a,f){c[a]=f},removeCommand:function(a){delete c[a]}});f.prototype={constructor:f,Scope:h,nativeCommands:a,
utils:g,load:function(a,c){var f=m.require(a);f?c(void 0,f):c('template "'+a+'" does not exist, better required or used first for performance!',void 0)},removeCommand:function(a){var c=this.config;c.commands&&delete c.commands[a]},addCommand:function(a,c){var f=this.config;f.commands=f.commands||{};f.commands[a]=c},include:function(a,c,h,i){var g=this,e=g.name;if("."===a.charAt(0)){if(!e)throw Error("parent template does not have name for relative sub tpl name: "+a);a=d(e,a)}return h.async(function(h){g.load(a,
function(d,e){d?h.error(d):(e instanceof f||(e=new g.constructor(e,g.config),e.name=a),b(e,c,h,i))})})},render:function(a,c){var f="",c=c||function(a,c){f=c};!this.name&&this.tpl.TPL_NAME&&(this.name=this.tpl.TPL_NAME);b(this,new h(a),(new i(c)).head);return f}};f.Scope=h;return f});
KISSY.add("xtemplate/runtime/commands",["./scope"],function(m,e){var d=e("./scope"),b={each:function(f,a,c){var h=a.params,b=h[0],g=h[2]||"xindex",h=h[1],e,k,l;if(b)if(m.isArray(b)){e=b.length;for(var n=0;n<e;n++)k=new d,l=k.affix={xcount:e},k.data=b[n],l[g]=n,h&&(l[h]=b[n]),k.setParent(f),c=a.fn(k,c)}else for(e in b)k=new d,l=k.affix={},k.data=b[e],l[g]=e,h&&(l[h]=b[e]),k.setParent(f),c=a.fn(k,c);return c},"with":function(f,a,c){var b=a.params[0];b&&(b=new d(b),b.setParent(f),c=a.fn(b,c));return c},
"if":function(f,a,c){a.params[0]?a.fn&&(c=a.fn(f,c)):a.inverse&&(c=a.inverse(f,c));return c},set:function(f,a,c){f.mix(a.hash);return c},include:function(f,a,c,b,e){b=a.params;a.hash&&(a=new d(a.hash),a.setParent(f),f=a);return this.include(b[0],f,c,e)},parse:function(f,a,c,h,e){return b.include.call(this,new d,a,c,e)},extend:function(b,a,c,d,e){e.extendTplName=a.params[0];return c},block:function(b,a,c,d,e){var g=a.params,d=g[0],j;2===g.length&&(j=g[0],d=g[1]);var g=e.blocks=e.blocks||{},k=g[d],
a={fn:a.fn,type:j};if(k){if(k.type)if("append"===k.type)a.next=k,g[d]=a;else if("prepend"===k.type){var l;for(j=k;j&&"prepend"===j.type;)l=j,j=j.next;a.next=j;l.next=a}}else g[d]=a;if(!e.extendTplName)for(j=g[d];j;)j.fn&&(c=j.fn.call(this,b,c)),j=j.next;return c},macro:function(b,a,c,e,i){b=a.params;e=b[0];b=b.slice(1);i=i.macros=i.macros||{};if(a.fn)i[e]={paramNames:b,fn:a.fn};else{var a={},i=i[e],g;if(i&&(g=i.paramNames)){for(var e=0,j=g.length;e<j;e++)a[g[e]]=b[e];g=new d(a);c=i.fn.call(this,g,
c)}}return c}};return b});
KISSY.add("xtemplate/runtime/scope",[],function(m){function e(d,b){this.data=d||{};this.affix=b;this.root=this}e.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,b){this.affix||(this.affix={});this.affix[d]=b},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){this.affix||(this.affix={});m.mix(this.affix,d)},get:function(d){var b=this.data,f=b&&b[d];if(void 0!==f)return f;var a=this.affix;return a&&d in a?a[d]:"this"===d?
b:"root"===d?this.root.data:f},resolve:function(d,b){if(!b&&1===d.length)return this.get(d[0]);var f,a,c;a=this;if("root"===d[0])d.shift(),a=a.root;else if(b)for(;a&&b--;)a=a.parent;f=d.length;var e=d[0];do c=a.get(e);while(void 0===c&&(a=a.parent));if(c&&a){for(a=1;c&&a<f;a++)c=c[d[a]];"function"===typeof c&&(c=c.call(this.data));return c}}};return e});
KISSY.add("xtemplate/runtime/linked-buffer",[],function(m){function e(b){this.list=b;this.data=""}function d(b){this.head=new e(this);this.callback=b;this.data=""}e.prototype={constructor:e,isBuffer:1,write:function(b,d){if(b||0===b)this.data+=d?m.escapeHtml(b):b;return this},async:function(b){var d=this.list,a=new e(d),d=new e(d);d.next=this.next;a.next=d;this.next=a;this.ready=!0;b(a);return d},error:function(b){var d=this.list.callback;d&&(d(b,void 0),this.list.callback=null)},end:function(b,d){this.list.callback&&
(this.write(b,d),this.ready=!0,this.list.flush());return this}};d.prototype={constructor:d,flush:function(){for(var b=this.head;b;){if(b.ready)this.data+=b.data;else return;this.head=b=b.next}this.callback(null,this.data)}};d.Buffer=e;return d});
