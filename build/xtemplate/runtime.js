/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 9 18:20
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(l,a){function f(b,d,c){var a=b.fn;if(a.version&&l.version!==a.version)throw Error("current xtemplate file("+b.name+")(v"+a.version+")need to be recompiled using current kissy(v"+l.version+")!");c=b.fn.call(b,d,c);if(a=b.session.extendTplName)delete b.session.extendTplName,c=b.root.include(a,b,d,c);return c.end()}function c(b,d,c,a,h,e,f,g){var i=b.root.config.commands,j;if(!e){j=h[0];i=
i&&i[j]||k[j];if(1!==h.length&&i){j=h.length;for(var l=1;l<j&&!(i=i[h[l]],!i);l++);}j=i}if(j)return j.call(b,d,c,a,f);h.join(".");return g&&(b=d.resolve(h.slice(0,-1),e),h=b[h[h.length-1]])?h.apply(b,c.params):a}function b(b,d){this.fn=b;this.config=d=d||{}}function d(b,d){if("."!==b.charAt(0))return b;if(!d)throw Error("parent template does not have name for relative sub tpl name: "+b);var c=i[d]=i[d]||{};if(c[b])return c[b];var h=b,a,e=b;a=d.split("/");e=e.split("/");a.pop();for(var f=0,k=e.length;f<
k;f++){var g=e[f];"."!==g&&(".."===g?a.pop():a.push(g))}a=a.join("/");return b=c[h]=a}a("util");var h=a("./runtime/commands"),k={},e=a("./runtime/scope"),j=a("./runtime/linked-buffer"),g={callFn:function(b,d,a,h,e,f,k){return c(b,d,a,h,e,f,k,!0)},callCommand:function(b,d,a,h,e,f){return c(b,d,a,h,e,0,f,!0)}};l.mix(b,{nativeCommands:h,utils:g,addCommand:function(b,d){k[b]=d},removeCommand:function(b){delete k[b]}});var i={};b.prototype={constructor:b,Scope:e,nativeCommands:h,utils:g,getTplContent:function(b,
d){var a=l.require(b,!0);if(a)return d(void 0,a);d('template "'+b+'" does not exist, better required or used first for performance!')},load:function(b,d){this.getTplContent(b,d)},removeCommand:function(b){var d=this.config;d.commands&&delete d.commands[b]},addCommand:function(b,d){var a=this.config;a.commands=a.commands||{};a.commands[b]=d},include:function(b,a,c,h){var e=this,b=d(b,a.name);return h.async(function(d){e.load(b,function(h,e){h?d.error(h):f({root:a.root,fn:e,name:b,session:a.session},
c,d)})})},render:function(b,d){var a="",h=this.fn,d=d||function(b,d){a=d},c=this.config.name;!c&&h.TPL_NAME&&(c=h.TPL_NAME);var k=new e(b),g=(new j(d)).head;f({name:c,fn:h,session:{},root:this},k,g);return a}};b.Scope=e;return b});
KISSY.add("xtemplate/runtime/commands",["./scope"],function(l,a){var f=a("./scope"),c={each:function(b,d,a){var c=d.params,e=c[0],j=c[2]||"xindex",c=c[1],g,i,m;if(e)if(l.isArray(e)){g=e.length;for(var n=0;n<g;n++)i=new f(e[n]),m=i.affix={xcount:g},m[j]=n,c&&(m[c]=e[n]),i.setParent(b),a=d.fn(i,a)}else for(g in e)i=new f(e[g]),m=i.affix={},m[j]=g,c&&(m[c]=e[g]),i.setParent(b),a=d.fn(i,a);return a},"with":function(b,d,a){var c=d.params[0];c&&(c=new f(c),c.setParent(b),a=d.fn(c,a));return a},"if":function(b,
d,a){d.params[0]?d.fn&&(a=d.fn(b,a)):d.inverse&&(a=d.inverse(b,a));return a},set:function(b,d,a){b.mix(d.hash);return a},include:function(b,a,c){var k=a.params,e,j=k.length;e=b;a.hash&&(e=new f(a.hash),e.setParent(b));for(b=0;b<j;b++)c=this.root.include(k[b],this,e,c);return c},parse:function(b,a,h){return c.include.call(this,new f,a,h)},extend:function(b,a,c){this.session.extendTplName=a.params[0];return c},block:function(b,a,c){var f=this.session,e=a.params,j=e[0],g;2===e.length&&(g=e[0],j=e[1]);
var e=f.blocks=f.blocks||{},i=e[j],a={fn:a.fn,type:g};if(i){if(i.type)if("append"===i.type)a.next=i,e[j]=a;else if("prepend"===i.type){var l;for(g=i;g&&"prepend"===g.type;)l=g,g=g.next;a.next=g;l.next=a}}else e[j]=a;if(!f.extendTplName)for(g=e[j];g;)g.fn&&(c=g.fn.call(this,b,c)),g=g.next;return c},macro:function(b,a,c){var b=a.params,k=b[0],b=b.slice(1),e=this.session,e=e.macros=e.macros||{};if(a.fn)e[k]={paramNames:b,fn:a.fn};else{var a={},k=e[k],j;if(k&&(j=k.paramNames)){for(var e=0,g=j.length;e<
g;e++)a[j[e]]=b[e];j=new f(a);c=k.fn.call(this,j,c)}}return c}};return c});
KISSY.add("xtemplate/runtime/scope",[],function(){function l(a,f){this.data=a||{};this.affix=f;this.root=this}l.prototype={isScope:1,setParent:function(a){this.parent=a;this.root=a.root},set:function(a,f){this.affix||(this.affix={});this.affix[a]=f},setData:function(a){this.data=a},getData:function(){return this.data},mix:function(a){var f=this.affix;f||(f=this.affix={});for(var c in a)f[c]=a[c]},get:function(a){var f=this.data,c=f&&f[a];if(void 0!==c)return c;c=(c=this.affix)&&c[a];return void 0!==
c?c:"this"===a?f:"root"===a?this.root.data:c},resolve:function(a,f){if(!f&&1===a.length)return this.get(a[0]);var c=a.length,b=this,d;if(c&&"root"===a[0])a.shift(),b=b.root,c--;else if(f)for(;b&&f--;)b=b.parent;if(!c)return b.data;var h=a[0];do d=b.get(h);while(void 0===d&&(b=b.parent));if(d&&b){for(b=1;d&&b<c;b++)d=d[a[b]];return d}}};return l});
KISSY.add("xtemplate/runtime/linked-buffer",[],function(l){function a(a){this.list=a;this.data=""}function f(c){this.head=new a(this);this.callback=c;this.data=""}a.prototype={constructor:a,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?l.escapeHtml(a):a;return this},async:function(c){var b=this.list,d=new a(b),b=new a(b);b.next=this.next;d.next=b;this.next=d;this.ready=!0;c(d);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=null)},end:function(a,b){this.list.callback&&
(this.write(a,b),this.ready=!0,this.list.flush());return this}};f.prototype={constructor:f,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};f.Buffer=a;return f});
