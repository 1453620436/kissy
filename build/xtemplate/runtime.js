/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 28 22:37
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer"],function(i,f){function d(a,b){var e=a.split("/"),h=b.split("/");e.pop();for(var d=0,c=h.length;d<c;d++){var j=h[d];"."!==j&&(".."===j?e.pop():e.push(j))}return e.join("/")}function c(a,b,e,h){var d=a.tpl,h=h||{};h.extendTplName=null;d.TPL_NAME&&!a.name&&(a.name=d.TPL_NAME);e=d.call(a,b,e,h);(d=h.extendTplName)&&(e=a.include(d,b,e,h));return e.end()}function b(a,b,e,d,c,j,g,k){var f=a.config.commands,
i;if(!j){i=c[0];f=f&&f[i]||h[i];if(1!==c.length&&f){i=c.length;for(var o=1;o<i&&!(f=f[c[o]],!f);o++);}i=f}if(i)return i.call(a,b,e,d,g);c.join(".");return k&&(a=b.resolve(c.slice(0,-1),j),c=a[c[c.length-1]])?c.apply(a,e.params):d}function a(a,b){this.tpl=a;b=b||{};b.name&&(this.name=b.name);this.config=b}f("util");var e=f("./runtime/commands"),h={},j=f("./runtime/scope"),k=f("./runtime/linked-buffer"),g={callFn:function(a,e,d,c,h,j,g){return b(a,e,d,c,h,j,g,!0)},callCommand:function(a,e,d,c,h,j){return b(a,
e,d,c,h,0,j,!0)}};i.mix(a,{nativeCommands:e,utils:g,addCommand:function(a,b){h[a]=b},removeCommand:function(a){delete h[a]}});a.prototype={constructor:a,Scope:j,nativeCommands:e,utils:g,load:function(a,b){var e=i.require(a);e?b(void 0,e):b('template "'+a+'" does not exist, better required or used first for performance!',void 0)},removeCommand:function(a){var b=this.config;b.commands&&delete b.commands[a]},addCommand:function(a,b){var e=this.config;e.commands=e.commands||{};e.commands[a]=b},include:function(b,
e,h,j){var g=this,f=g.name;if("."===b.charAt(0)){if(!f)throw Error("parent template does not have name for relative sub tpl name: "+b);b=d(f,b)}return h.async(function(h){g.load(b,function(d,f){d?h.error(d):(f instanceof a||(f=new g.constructor(f,g.config),f.name=b),c(f,e,h,j))})})},render:function(a,b){var e="",b=b||function(a,b){e=b};!this.name&&this.tpl.TPL_NAME&&(this.name=this.tpl.TPL_NAME);var h=new j(a),d=(new k(b)).head;c(this,h,d);return e}};a.Scope=j;return a});
KISSY.add("xtemplate/runtime/commands",["./scope"],function(i,f){var d=f("./scope"),c={each:function(b,a,e){var h=a.params,c=h[0],f=h[2]||"xindex",h=h[1],g,l,m;if(c)if(i.isArray(c)){g=c.length;for(var n=0;n<g;n++)l=new d,m=l.affix={xcount:g},l.data=c[n],m[f]=n,h&&(m[h]=c[n]),l.setParent(b),e=a.fn(l,e)}else for(g in c)l=new d,m=l.affix={},l.data=c[g],m[f]=g,h&&(m[h]=c[g]),l.setParent(b),e=a.fn(l,e);return e},"with":function(b,a,e){var c=a.params[0];c&&(c=new d(c),c.setParent(b),e=a.fn(c,e));return e},
"if":function(b,a,e){a.params[0]?a.fn&&(e=a.fn(b,e)):a.inverse&&(e=a.inverse(b,e));return e},set:function(b,a,e){b.mix(a.hash);return e},include:function(b,a,e,c,f){c=a.params;a.hash&&(a=new d(a.hash),a.setParent(b),b=a);return this.include(c[0],b,e,f)},parse:function(b,a,e,h,f){return c.include.call(this,new d,a,e,f)},extend:function(b,a,c,d,f){f.extendTplName=a.params[0];return c},block:function(b,a,c,d,f){var k=a.params,d=k[0],g;2===k.length&&(g=k[0],d=k[1]);var k=f.blocks=f.blocks||{},i=k[d],
a={fn:a.fn,type:g};if(i){if(i.type)if("append"===i.type)a.next=i,k[d]=a;else if("prepend"===i.type){var m;for(g=i;g&&"prepend"===g.type;)m=g,g=g.next;a.next=g;m.next=a}}else k[d]=a;if(!f.extendTplName)for(g=k[d];g;)g.fn&&(c=g.fn.call(this,b,c)),g=g.next;return c},macro:function(b,a,c,f,j){b=a.params;f=b[0];b=b.slice(1);j=j.macros=j.macros||{};if(a.fn)j[f]={paramNames:b,fn:a.fn};else{var a={},j=j[f],i;if(j&&(i=j.paramNames)){for(var f=0,g=i.length;f<g;f++)a[i[f]]=b[f];i=new d(a);c=j.fn.call(this,i,
c)}}return c}};return c});
KISSY.add("xtemplate/runtime/scope",[],function(i){function f(d,c){this.data=d||{};this.affix=c;this.root=this}f.prototype={isScope:1,setParent:function(d){this.parent=d;this.root=d.root},set:function(d,c){this.affix||(this.affix={});this.affix[d]=c},setData:function(d){this.data=d},getData:function(){return this.data},mix:function(d){this.affix||(this.affix={});i.mix(this.affix,d)},get:function(d){var c=this.data,b=c&&c[d];if(void 0!==b)return b;var a=this.affix;return a&&d in a?a[d]:"this"===d?
c:"root"===d?this.root.data:b},resolve:function(d,c){if(!c&&1===d.length)return this.get(d[0]);var b=d.length,a,e;a=this;if(b&&"root"===d[0])d.shift(),a=a.root,b--;else if(c)for(;a&&c--;)a=a.parent;if(!b)return a.data;var f=d[0];do e=a.get(f);while(void 0===e&&(a=a.parent));if(e&&a){for(a=1;e&&a<b;a++)e=e[d[a]];return e}}};return f});
KISSY.add("xtemplate/runtime/linked-buffer",[],function(i){function f(c){this.list=c;this.data=""}function d(c){this.head=new f(this);this.callback=c;this.data=""}f.prototype={constructor:f,isBuffer:1,write:function(c,b){if(c||0===c)this.data+=b?i.escapeHtml(c):c;return this},async:function(c){var b=this.list,a=new f(b),b=new f(b);b.next=this.next;a.next=b;this.next=a;this.ready=!0;c(a);return b},error:function(c){var b=this.list.callback;b&&(b(c,void 0),this.list.callback=null)},end:function(c,b){this.list.callback&&
(this.write(c,b),this.ready=!0,this.list.flush());return this}};d.prototype={constructor:d,flush:function(){for(var c=this.head;c;){if(c.ready)this.data+=c.data;else return;this.head=c=c.next}this.callback(null,this.data)}};d.Buffer=f;return d});
