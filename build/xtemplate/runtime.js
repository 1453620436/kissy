/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 9 00:58
*/
KISSY.add("xtemplate/runtime",["util","./runtime/commands","./runtime/scope","./runtime/linked-buffer","./runtime/pool"],function(h,a){function e(l,b,a,f){var c=l.tpl;f.extendTplName=null;c.TPL_NAME&&!l.name&&(l.name=c.TPL_NAME);a=c.call(l,b,a,f);(c=f.extendTplName)&&(a=l.include(c,b,a,f));return a.end()}function c(b,a,f,c,d,e,i,j){var g=b.getRoot().config.commands,h;if(!e){h=d[0];g=g&&g[h]||k[h];if(1!==d.length&&g){h=d.length;for(var o=1;o<h&&!(g=g[d[o]],!g);o++);}h=g}if(h)return h.call(b,a,f,c,
i);d.join(".");return j&&(b=a.resolve(d.slice(0,-1),e),d=b[d[d.length-1]])?d.apply(b,f.params):c}function b(b,a){this.tpl=b;a=a||{};this.name=a.name;this.config=a;this.subNameResolveCache={};a.root=a.root||this}a("util");var f=a("./runtime/commands"),k={},d=a("./runtime/scope"),i=a("./runtime/linked-buffer"),g=a("./runtime/pool"),j={callFn:function(b,a,f,d,e,k,g){return c(b,a,f,d,e,k,g,!0)},callCommand:function(b,a,f,d,e,k){return c(b,a,f,d,e,0,k,!0)}};h.mix(b,{nativeCommands:f,pool:g,utils:j,addCommand:function(b,
a){k[b]=a},removeCommand:function(b){delete k[b]}});b.prototype={constructor:b,Scope:d,nativeCommands:f,utils:j,getRoot:function(){return this.config.root},resolve:function(b){if("."!==b.charAt(0))return b;var a=this.subNameResolveCache;if(a[b])return a[b];var f=this.name;if(!f)throw Error("parent template does not have name for relative sub tpl name: "+b);var d=b,f=f.split("/"),b=b.split("/");f.pop();for(var c=0,e=b.length;c<e;c++){var k=b[c];"."!==k&&(".."===k?f.pop():f.push(k))}f=f.join("/");return b=
a[d]=f},loadContent:function(b,a){var f=h.require(b);f?a(void 0,f):a('template "'+b+'" does not exist, better required or used first for performance!',void 0)},load:function(b,a,f){var c=this,d,e=c.getRoot().config.cache;if(!1!==e&&g.hasInstance(b))return d=g.getInstance(void 0,{name:b,root:c.getRoot()},c.constructor),a.descendants.push(d),f(void 0,d);c.loadContent(b,function(d,k){if(d)f(d);else{var i;!1!==e?(i=g.getInstance(k,{name:b,root:c.getRoot()},c.constructor),a.descendants.push(i)):i=new c.constructor(k,
{name:b,root:c.getRoot()});f(void 0,i)}})},removeCommand:function(b){var a=this.config;a.commands&&delete a.commands[b]},addCommand:function(b,a){var f=this.config;f.commands=f.commands||{};f.commands[b]=a},include:function(b,a,f,c){var d=this,b=d.resolve(b);return f.async(function(f){d.load(b,c,function(b,d){b?f.error(b):e(d,a,f,c)})})},render:function(b,a){var f="",a=a||function(b,a){f=a},c={descendants:[]},k=a;!1!==this.config.cache&&(k=function(b,f){for(var d=c.descendants.length,k=0;k<d;k++)g.recycle(c.descendants[k]);
a(b,f)});!this.name&&this.tpl.TPL_NAME&&(this.name=this.tpl.TPL_NAME);var j=new d(b),k=(new i(k)).head;e(this,j,k,c);return f}};b.Scope=d;return b});
KISSY.add("xtemplate/runtime/commands",["./scope"],function(h,a){var e=a("./scope"),c={each:function(b,a,c){var d=a.params,i=d[0],g=d[2]||"xindex",d=d[1],j,l,m;if(i)if(h.isArray(i)){j=i.length;for(var n=0;n<j;n++)l=new e(i[n]),m=l.affix={xcount:j},m[g]=n,d&&(m[d]=i[n]),l.setParent(b),c=a.fn(l,c)}else for(j in i)l=new e(i[j]),m=l.affix={},m[g]=j,d&&(m[d]=i[j]),l.setParent(b),c=a.fn(l,c);return c},"with":function(b,a,c){var d=a.params[0];d&&(d=new e(d),d.setParent(b),c=a.fn(d,c));return c},"if":function(b,
a,c){a.params[0]?a.fn&&(c=a.fn(b,c)):a.inverse&&(c=a.inverse(b,c));return c},set:function(b,a,c){b.mix(a.hash);return c},include:function(b,a,c,d,i){var d=a.params,g,j=d.length;g=b;a.hash&&(g=new e(a.hash),g.setParent(b));for(b=0;b<j;b++)c=this.include(d[b],g,c,i);return c},parse:function(b,a,k,d,i){return c.include.call(this,new e,a,k,d,i)},extend:function(a,c,e,d,i){i.extendTplName=c.params[0];return e},block:function(a,c,e,d,i){var g=c.params,d=g[0],j;2===g.length&&(j=g[0],d=g[1]);var g=i.blocks=
i.blocks||{},h=g[d],c={fn:c.fn,type:j};if(h){if(h.type)if("append"===h.type)c.next=h,g[d]=c;else if("prepend"===h.type){var m;for(j=h;j&&"prepend"===j.type;)m=j,j=j.next;c.next=j;m.next=c}}else g[d]=c;if(!i.extendTplName)for(j=g[d];j;)j.fn&&(e=j.fn.call(this,a,e)),j=j.next;return e},macro:function(a,c,h,d,i){a=c.params;d=a[0];a=a.slice(1);i=i.macros=i.macros||{};if(c.fn)i[d]={paramNames:a,fn:c.fn};else{var c={},i=i[d],g;if(i&&(g=i.paramNames)){for(var d=0,j=g.length;d<j;d++)c[g[d]]=a[d];g=new e(c);
h=i.fn.call(this,g,h)}}return h}};return c});
KISSY.add("xtemplate/runtime/scope",[],function(){function h(a,e){this.data=a||{};this.affix=e;this.root=this}h.prototype={isScope:1,setParent:function(a){this.parent=a;this.root=a.root},set:function(a,e){this.affix||(this.affix={});this.affix[a]=e},setData:function(a){this.data=a},getData:function(){return this.data},mix:function(a){var e=this.affix;e||(e=this.affix={});for(var c in a)e[c]=a[c]},get:function(a){var e=this.data,c=e&&e[a];if(void 0!==c)return c;c=(c=this.affix)&&c[a];return void 0!==
c?c:"this"===a?e:"root"===a?this.root.data:c},resolve:function(a,e){if(!e&&1===a.length)return this.get(a[0]);var c=a.length,b=this,f;if(c&&"root"===a[0])a.shift(),b=b.root,c--;else if(e)for(;b&&e--;)b=b.parent;if(!c)return b.data;var h=a[0];do f=b.get(h);while(void 0===f&&(b=b.parent));if(f&&b){for(b=1;f&&b<c;b++)f=f[a[b]];return f}}};return h});
KISSY.add("xtemplate/runtime/linked-buffer",[],function(h){function a(a){this.list=a;this.data=""}function e(c){this.head=new a(this);this.callback=c;this.data=""}a.prototype={constructor:a,isBuffer:1,write:function(a,b){if(a||0===a)this.data+=b?h.escapeHtml(a):a;return this},async:function(c){var b=this.list,e=new a(b),b=new a(b);b.next=this.next;e.next=b;this.next=e;this.ready=!0;c(e);return b},error:function(a){var b=this.list.callback;b&&(b(a,void 0),this.list.callback=null)},end:function(a,b){this.list.callback&&
(this.write(a,b),this.ready=!0,this.list.flush());return this}};e.prototype={constructor:e,flush:function(){for(var a=this.head;a;){if(a.ready)this.data+=a.data;else return;this.head=a=a.next}this.callback(null,this.data)}};e.Buffer=a;return e});
KISSY.add("xtemplate/runtime/pool",[],function(){var h={};return{getInstance:function(a,e,c){var b=h[e.name];if(b&&b.length)return a=b.pop(),a.config=e,a;a=new c(a,e);a.fromPool=1;return a},hasInstance:function(a){return(a=h[a])&&a.length},getCache:function(){return h},recycle:function(a){if(a.fromPool){var e=a.name,e=h[e]=h[e]||[];e[e.length]=a}}}});
