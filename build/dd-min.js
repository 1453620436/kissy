/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Mar 13 17:50
*/
KISSY.add("dd/ddm",["node","base"],function(b,d){function l(h){var a=h.get("activeDrag").get("activeHandler"),i="auto";a&&(i=a.css("cursor"));"auto"===i&&(i=h.get("dragCursor"));h._shim.css({cursor:i,display:"block"});p&&s.call(h)}function f(h){var a=h.get("drops");h.setInternal("validDrops",[]);a.length&&b.each(a,function(i){i._active()})}function n(h){var a=h.get("drops");h.setInternal("validDrops",[]);a.length&&b.each(a,function(i){i._deActive()})}function g(h){var a=h.offset();return{left:a.left,
right:a.left+(h.__ddCachedWidth||h.outerWidth()),top:a.top,bottom:a.top+(h.__ddCachedHeight||h.outerHeight())}}function a(a,c){return a.left<=c.left&&a.right>=c.left&&a.top<=c.top&&a.bottom>=c.top}function c(a){return a.top>=a.bottom||a.left>=a.right?0:(a.right-a.left)*(a.bottom-a.top)}function j(a,c){var i=Math.max(a.top,c.top),j=Math.min(a.right,c.right),o=Math.min(a.bottom,c.bottom);return{left:Math.max(a.left,c.left),right:j,top:i,bottom:o}}function m(a){a&&(a.__ddCachedWidth=a.outerWidth(),a.__ddCachedHeight=
a.outerHeight())}var e=d("node"),k=d("base"),t=b.UA,u=e.all,e=b.Env.host,r=e.document,w=u(r),q=u(e),p=6===t.ie,k=k.extend({addDrop:function(a){this.get("drops").push(a)},removeDrop:function(a){var c=this.get("drops"),a=b.indexOf(a,c);-1!==a&&c.splice(a,1)},start:function(a,c){this.setInternal("activeDrag",c);c.get("shim")&&v(this);this.__needDropCheck=0;c.get("groups")&&(f(this),this.get("validDrops").length&&(m(c.get("node")),this.__needDropCheck=1))},addValidDrop:function(a){this.get("validDrops").push(a)},
_notifyDropsMove:function(h,d){var i=this.get("validDrops"),e=d.get("mode"),o=0,m=0,f=g(d.get("node")),k=c(f);b.each(i,function(i){if(!i.get("disabled")){var b;if(b=i.getNodeFromTarget(h,d.get("dragNode")[0],d.get("node")[0]))if("point"===e)a(g(b),d.mousePos)&&(b=c(g(b)),o?b<m&&(o=i,m=b):(o=i,m=b));else if("intersect"===e)b=c(j(f,g(b))),b>m&&(m=b,o=i);else if("strict"===e&&(b=c(j(f,g(b))),b===k))return o=i,!1}});if((i=this.get("activeDrop"))&&i!==o)i._handleOut(h),d._handleOut(h);this.setInternal("activeDrop",
o);o&&(i!==o?o._handleEnter(h):o._handleOver(h))},move:function(a,c){this.__needDropCheck&&this._notifyDropsMove(a,c)},end:function(a){var c=this.get("activeDrop");this._shim&&this._shim.hide();n(this);c&&c._end(a);this.setInternal("activeDrop",null);this.setInternal("activeDrag",null)}},{ATTRS:{dragCursor:{value:"move"},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}}}),v=function(a){a._shim=u('<div style="background-color:red;position:'+(p?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+
a.get("dragCursor")+';z-index:999999;"></div>').prependTo(r.body||r.documentElement).css("opacity",0);v=l;if(p)q.on("resize scroll",s,a);l(a)},s=b.throttle(function(){var a;(a=this.get("activeDrag"))&&a.get("shim")&&this._shim.css({width:w.width(),height:w.height()})},30),k=new k;k.inRegion=a;k.region=g;k.area=c;k.cacheWH=m;k.PREFIX_CLS="ks-dd-";return k});
KISSY.add("dd/draggable",["node","./ddm","base","event/gesture/drag"],function(b,d){function l(a){return function(){this._isValidDrag&&a.apply(this,arguments)}}function f(){p.body.onselectstart=x;p.body.releaseCapture&&p.body.releaseCapture()}function n(){return!1}function g(a){this._isValidDrag=0;this.onGestureStart(a)}var a=d("node"),c=a.Gesture,j=d("./ddm"),m=d("base"),e=d("event/gesture/drag"),k=b.UA,t=a.all,u=t(document),r=b.each,w=k.ie,q=j.PREFIX_CLS,p=b.Env.host.document,v=l(function(a){this._start(a)}),
s=l(function(a){this._move(a)}),h=l(function(a){this._end(a)}),x;return m.extend({initializer:function(){this.addTarget(j);this._allowMove=this.get("move")},_onSetNode:function(a){this.setInternal("dragNode",a)},onGestureStart:function(a){var c=a.target;this._checkDragStartValid(a)&&this._checkHandler(c)&&this._prepare(a)},getEventTargetEl:function(){return this.get("node")},bindDragEvent:function(){this.getEventTargetEl().on(e.DRAG_START,v,this).on(e.DRAG,s,this).on(e.DRAG_END,h,this).on(c.start,
g,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.getEventTargetEl().detach(e.DRAG_START,v,this).detach(e.DRAG,s,this).detach(e.DRAG_END,h,this).detach(c.start,g,this).detach("dragstart",this._fixDragStart)},_onSetDisabled:function(a){this.get("dragNode")[a?"addClass":"removeClass"](q+"-disabled");this[a?"detachDragEvent":"bindDragEvent"]()},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var c=this,j=c.get("handlers"),b=0;r(j,function(j){if(j[0]===
a||j.contains(a))return b=1,c.setInternal("activeHandler",j),!1});return b},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!==a.which?0:1},_prepare:function(a){this._isValidDrag=1;w&&(x=p.body.onselectstart,p.body.onselectstart=n,p.body.setCapture&&p.body.setCapture(),u.on(c.end,{fn:f,once:!0}));this.get("halt")&&a.stopPropagation();"mouse"===a.gestureType&&a.preventDefault();this._allowMove&&this.setInternal("startNodePos",this.get("node").offset())},_start:function(a){this.mousePos=
{left:a.pageX,top:a.pageY};j.start(a,this);this.fire("dragstart",{drag:this,gestureType:a.gestureType,startPos:a.startPos,deltaX:a.deltaX,deltaY:a.deltaY,pageX:a.pageX,pageY:a.pageY});this.get("dragNode").addClass(q+"dragging")},_move:function(a){var c=a.pageX,b=a.pageY;"touch"===a.gestureType&&a.preventDefault();this.mousePos={left:c,top:b};c={drag:this,gestureType:a.gestureType,startPos:a.startPos,deltaX:a.deltaX,deltaY:a.deltaY,pageX:a.pageX,pageY:a.pageY};if(b=this._allowMove){var d=this.get("startNodePos"),
m=d.left+a.deltaX,d=d.top+a.deltaY;c.left=m;c.top=d;this.setInternal("actualPos",{left:m,top:d});this.fire("dragalign",c)}m=1;!1===this.fire("drag",c)&&(m=0);j.move(a,this);this.get("preventDefaultOnMove")&&a.preventDefault();m&&b&&this.get("node").offset(this.get("actualPos"))},stopDrag:function(){this._isValidDrag&&this._end()},_end:function(a){var a=a||{},c;this._isValidDrag=0;this.get("node").removeClass(q+"drag-over");this.get("dragNode").removeClass(q+"dragging");(c=j.get("activeDrop"))?this.fire("dragdrophit",
{drag:this,drop:c}):this.fire("dragdropmiss",{drag:this});j.end(a,this);this.fire("dragend",{drag:this,gestureType:a.gestureType,startPos:a.startPos,deltaX:a.deltaX,deltaY:a.deltaY,pageX:a.pageX,pageY:a.pageY})},_handleOut:function(){this.get("node").removeClass(q+"drag-over");this.fire("dragexit",{drag:this,drop:j.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(q+"drag-over");this.fire("dragenter",a)},_handleOver:function(a){this.fire("dragover",a)},destructor:function(){this.detachDragEvent()}},
{name:"Draggable",ATTRS:{node:{setter:function(c){if(!(c instanceof a))return t(c)}},dragNode:{},shim:{value:!1},handlers:{value:[],getter:function(a){var c=this;a.length||(a[0]=c.get("node"));r(a,function(b,j){"function"===typeof b&&(b=b.call(c));"string"===typeof b&&(b=c.get("node").one(b));b.nodeType&&(b=t(b));a[j]=b});c.setInternal("handlers",a);return a}},activeHandler:{},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:!0},startNodePos:{},
actualPos:{},preventDefaultOnMove:{value:!0}},inheritedStatics:{DropMode:{POINT:"point",INTERSECT:"intersect",STRICT:"strict"}}})});
KISSY.add("dd/draggable-delegate",["node","./ddm","./draggable"],function(b,d){var l=d("node"),f=d("./ddm"),n=d("./draggable"),g=f.PREFIX_CLS,a=l.all;return n.extend({_onSetNode:b.noop,_onSetDisabled:function(a){this.get("container")[a?"addClass":"removeClass"](g+"-disabled");this[a?"detachDragEvent":"bindDragEvent"]()},getEventTargetEl:function(){return this.get("container")},onGestureStart:function(c){var b,d;if(this._checkDragStartValid(c)){b=this.get("handlers");var e=a(c.target);(b=b.length?
this._getHandler(e):e)&&(d=this._getNode(b));d&&(this.setInternal("activeHandler",b),this.setInternal("node",d),this.setInternal("dragNode",d),this._prepare(c))}},_getHandler:function(a){for(var b=this.get("container"),d=this.get("handlers");a&&a[0]!==b[0];){for(var e=0;e<d.length;e++)if(a.test(d[e]))return a;a=a.parent()}return null},_getNode:function(a){return a.closest(this.get("selector"),this.get("container"))}},{ATTRS:{container:{setter:function(c){return a(c)}},selector:{},handlers:{value:[],
getter:0}}})});
KISSY.add("dd/droppable",["node","./ddm","base"],function(b,d){var l=d("node"),f=d("./ddm"),n=d("base"),g=f.PREFIX_CLS;return n.extend({initializer:function(){this.addTarget(f);f.addDrop(this)},getNodeFromTarget:function(a,c,b){var a=this.get("node"),d=a[0];return d===c||d===b?null:a},_active:function(){var a=f.get("activeDrag"),c=this.get("node"),b=this.get("groups"),a=a.get("groups");a:if(!0===a)b=1;else{for(var d in b)if(a[d]){b=1;break a}b=0}b?(f.addValidDrop(this),c&&(c.addClass(g+"drop-active-valid"),
f.cacheWH(c))):c&&c.addClass(g+"drop-active-invalid")},_deActive:function(){var a=this.get("node");a&&a.removeClass(g+"drop-active-valid").removeClass(g+"drop-active-invalid")},__getCustomEvt:function(a){return b.mix({drag:f.get("activeDrag"),drop:this},a)},_handleOut:function(){var a=this.__getCustomEvt();this.get("node").removeClass(g+"drop-over");this.fire("dropexit",a)},_handleEnter:function(a){a=this.__getCustomEvt(a);a.drag._handleEnter(a);this.get("node").addClass(g+"drop-over");this.fire("dropenter",
a)},_handleOver:function(a){a=this.__getCustomEvt(a);a.drag._handleOver(a);this.fire("dropover",a)},_end:function(){var a=this.__getCustomEvt();this.get("node").removeClass(g+"drop-over");this.fire("drophit",a)},destructor:function(){f.removeDrop(this)}},{name:"Droppable",ATTRS:{node:{setter:function(a){if(a)return l.one(a)}},groups:{value:{}},disabled:{}}})});
KISSY.add("dd/droppable-delegate",["node","./ddm","./droppable"],function(b,d){function l(){var a=this.get("container"),c=[],b=this.get("selector");a.all(b).each(function(a){n.cacheWH(a);c.push(a)});this.__allNodes=c}var f=d("node"),n=d("./ddm"),g=d("./droppable").extend({initializer:function(){n.on("dragstart",l,this)},getNodeFromTarget:function(a,c,d){var g={left:a.pageX,top:a.pageY},a=this.__allNodes,e=0,f=Number.MAX_VALUE;a&&b.each(a,function(a){var b=a[0];b===d||b===c||(b=n.region(a),n.inRegion(b,
g)&&(b=n.area(b),b<f&&(f=b,e=a)))});e&&(this.setInternal("lastNode",this.get("node")),this.setInternal("node",e));return e},_handleOut:function(){this.callSuper();this.setInternal("node",0);this.setInternal("lastNode",0)},_handleOver:function(a){var b=this.get("node"),d=g.superclass._handleOut,f=this.callSuper,e=g.superclass._handleEnter,k=this.get("lastNode");k[0]!==b[0]?(this.setInternal("node",k),d.apply(this,arguments),this.setInternal("node",b),e.call(this,a)):f.call(this,a)},_end:function(a){this.callSuper(a);
this.setInternal("node",0)}},{ATTRS:{lastNode:{},selector:{},container:{setter:function(a){return f.one(a)}}}});return g});KISSY.add("dd",["dd/ddm","dd/draggable","dd/draggable-delegate","dd/droppable-delegate","dd/droppable"],function(b,d){var l=d("dd/ddm"),f=d("dd/draggable"),n=d("dd/draggable-delegate"),g=d("dd/droppable-delegate"),a=d("dd/droppable"),l={Draggable:f,DDM:l,Droppable:a,DroppableDelegate:g,DraggableDelegate:n};return KISSY.DD=l});
