/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 29 15:11
*/
KISSY.add("router","./router/utils,./router/route,uri,./router/request,event/dom,event/custom".split(","),function(d,i,a){function g(c,b){var e=l.addVid("#!"+c+(A?"":b?s.REPLACE_HISTORY:""),p);b?location.replace(e):location.hash=e}function j(c){var c=c||location.href,b=new x(c);if(!m.useHash&&n){c=b.query;return b.getPath().substr(m.urlRoot.length)+(c.has()?"?"+c.toString():"")}return l.getHash(c)}function f(c,b,e){function a(){g++;if(g===k)e(c,b);else{var j=v[g];if(d.startsWith(c.path+"/",j[0]+"/")){var h=
j[0].length;c.url=c.url.slice(h);var f=c.path;c.path=c.path.slice(h);j[1](c,a);c.url=c.originalUrl;c.path=f}else a()}}var g=-1,k=v.length;a()}function b(c,b){function e(){a++;if(a!==g){var j=h[a];if(c.params=j.match(c.path)){var k=-1,f=j.callbacks,d=f.length,i=function(a){if(a==="route"){i=null;e()}else{k++;if(k!==d){c.route=j;f[k](c,b,i)}}};i("")}else e()}}var a=-1,g=h.length;e()}function k(c,g){var e=j(),k=new x(e),h=k.query.get();k.query.reset();e=new B({query:h,backward:c===true,replace:g===true,
forward:c===false&&g===false,path:k.toString()||"/",url:e,originalUrl:e});k={redirect:a.navigate};a.fire("dispatch",{request:e,response:k});f(e,k,b)}function q(c){var b=false,a=false;if(c===o[o.length-2]){b=true;o.pop()}else c!==o[o.length-1]?o.push(c):a=true;k(b,a)}function t(c){(c=c.originalEvent.state)&&q(c.vid)}function y(c){(c=z(c.newURL||location.href))&&q(c)}var v=[],h=[],l=i("./router/utils"),C=i("./router/route"),x=i("uri"),B=i("./router/request"),s=i("event/dom"),i=i("event/custom"),z=l.getVidFromUrlWithHash,
u=d.Env.host,r=u.history,A=d.Feature.isHashChangeSupported(),n=!(!r||!r.pushState),p=10,o=[p],m={urlRoot:"",useHash:!n};d.mix(a,i.Target);a.use=function(c,b){if(typeof c!=="string"){b=c;c=""}v.push([c,b])};a.navigate=function(b,a){var a=a||{},e=a.replace||false;if(j()!==b){if(!e){p++;o.push(p)}if(!m.useHash&&n){r[e?"replaceState":"pushState"]({vid:p},"",l.getFullPath(b,m.urlRoot));k(false,e)}else if(n){r[e?"replaceState":"pushState"]({vid:p},"","#!"+b);k(false,e)}else g(b,e)}else a&&a.triggerRoute&&
k(false,true)};a.get=function(b){var a=d.makeArray(arguments).slice(1);h.push(new C(b,a,m))};a.matchRoute=function(b){for(var a=0,g=h.length;a<g;a++)if(h[a].match(b))return h[a];return false};a.removeRoute=function(b,a){for(var g=h.length-1;g>=0;g--){var k=h[g];if(k.path===b)if(a){k.removeCallback(a);k.callbacks.length||h.splice(g,1)}else h.splice(g,1)}};a.clearRoutes=function(){v=[];h=[]};a.hasRoute=function(b){for(var a=0,g=h.length;a<g;a++)if(h[a].path===b)return h[a];return false};a.config=function(b){if(b.urlRoot)b.urlRoot=
b.urlRoot.replace(/\/$/,"");d.mix(m,b)};var w;a.start=function(b){if(w)return b&&b.call(a);var h=m.useHash,e=m.urlRoot,f=m.triggerRoute,i=location.pathname,d=location.href,q=j(),o=location.hash.match(/#!.+/);if(!h)if(n){if(o&&l.equalsIgnoreSlash(i,e)){r.replaceState({},"",l.getFullPath(q,e));f=1}}else if(l.equalsIgnoreSlash(i,e))h=true;else{location.replace(l.addEndSlash(e)+"#!"+q);return}setTimeout(function(){var e=n;if(n)s.on(u,"popstate",t);else{s.on(u,"hashchange",y);f=1}if(h)if(j())if(!n&&z(d)!==
p){g(l.getHash(d),true);f=0}else n&&l.hasVid(d)&&location.replace(d=l.removeVid(d));else{a.navigate("/",{replace:1});f=0;e=false}e&&r.replaceState({vid:p},"",d);f&&k(false,true);b&&b(a)},100);w=true;return a};a.Utils=l;a.stop=function(){w=false;s.detach(u,"hashchange",y);s.detach(u,"popstate",t)}});
KISSY.add("router/utils",["event/dom"],function(d,i){function a(b){return b.replace(/__ks-vid=.+$/,"")}function g(b){var a;return(a=b.match(/__ks-vid=(.+)$/))?parseInt(a[1],10):0}function j(b){return(b=b.match(/#(.+)$/))&&b[1]||""}var f=i("event/dom");return{endWithSlash:function(b){return d.endsWith(b,"/")},startWithSlash:function(b){return d.startsWith(b,"/")},removeEndSlash:function(b){this.endWithSlash(b)&&(b=b.substring(0,b.length-1));return b},removeStartSlash:function(b){this.startWithSlash(b)&&
(b=b.substring(1));return b},addEndSlash:function(b){return this.removeEndSlash(b)+"/"},addStartSlash:function(b){return b?"/"+this.removeStartSlash(b):b},getFullPath:function(b,a){return location.protocol+"//"+location.host+this.removeEndSlash(a)+this.addStartSlash(b)},equalsIgnoreSlash:function(b,a){b=this.removeEndSlash(b);a=this.removeEndSlash(a);return b===a},getHash:function(b){return a(j(b).replace(/^!/,"")).replace(f.REPLACE_HISTORY,"")},removeVid:a,hasVid:function(b){return-1!==b.indexOf("__ks-vid=")},
addVid:function(b,a){return b+"__ks-vid="+a},getVidFromUrlWithHash:function(b){return g(j(b))},getVidFromHash:g}});
KISSY.add("router/route",[],function(d){function i(a,j,f,b){d.isArray(a)&&(a="("+a.join("|")+")");a=a.concat(f?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,a,g,f,d,h,i){j.push(f);a=a||"";return""+(h?"":a)+"(?:"+(h?a:"")+(g||"")+(d||g&&"([^/.]+?)"||"([^/]+?)")+")"+(h||"")+(i?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:j,regexp:RegExp("^"+a+"$",b?"":"i")}}function a(a,j,f){this.path=a;this.callbacks=j;this.keys=[];"string"===
typeof a||d.isArray(a)?d.mix(this,i(a,this.keys,f.strict,f.caseSensitive)):this.regexp=a}a.prototype={match:function(a){a=a.match(this.regexp);if(!a)return!1;for(var j=this.keys,f=[],b=1,i=a.length;b<i;++b){var q=j[b-1],t="string"===typeof a[b]?d.urlDecode(a[b]):a[b];q?f[q]=t:f.push(t)}return f},removeCallback:function(a){for(var d=this.callbacks||[],f=d.length-1;0<=f;f++)d===a&&d.splice(f,1)}};return a});
KISSY.add("router/request",[],function(d){function i(a){d.mix(this,a)}i.prototype={param:function(a){return a in this.params?this.params[a]:this.query[a]}};return i});
