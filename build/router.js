/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 14 22:28
*/
KISSY.add("router","util,./router/utils,./router/route,uri,./router/request,event/dom,event/custom,feature".split(","),function(n,b,d){function l(e,a){var f=g.addVid("#!"+e+(B?"":a?t.REPLACE_HISTORY:""),r);a?location.replace(f):location.hash=f}function j(e){var e=e||location.href,a=new x(e);if(!p.useHash&&q){e=a.query;return a.getPath().substr(p.urlRoot.length)+(e.has()?"?"+e.toString():"")}return g.getHash(e)}function i(e,a,f){function c(){d++;if(d===i)f(e,a);else{var b=v[d];if(k.startsWith(e.path+
"/",b[0]+"/")){var g=b[0].length;e.url=e.url.slice(g);var h=e.path;e.path=e.path.slice(g);b[1](e,c);e.url=e.originalUrl;e.path=h}else c()}}var d=-1,i=v.length;c()}function a(e,a){function f(){c++;if(c!==d){var i=h[c];if(e.params=i.match(e.path)){var b=-1,g=i.callbacks,j=g.length,m=function(c){if(c==="route"){m=null;f()}else{b++;if(b!==j){e.route=i;g[b](e,a,m)}}};m("")}else f()}}var c=-1,d=h.length;f()}function c(e,c){var f=j(),b=new x(f),g=b.query.get();b.query.reset();f=new C({query:g,backward:e===
true,replace:c===true,forward:e===false&&c===false,path:b.toString()||"/",url:f,originalUrl:f});b={redirect:d.navigate};d.fire("dispatch",{request:f,response:b});i(f,b,a)}function m(e){var a=false,f=false;if(e===o[o.length-2]){a=true;o.pop()}else e!==o[o.length-1]?o.push(e):f=true;c(a,f)}function y(a){(a=a.originalEvent.state)&&m(a.vid)}function z(a){(a=A(a.newURL||location.href))&&m(a)}var k=b("util"),v=[],h=[],g=b("./router/utils"),D=b("./router/route"),x=b("uri"),C=b("./router/request"),t=b("event/dom"),
E=b("event/custom"),A=g.getVidFromUrlWithHash,u=n.Env.host,s=u.history,B=b("feature").isHashChangeSupported(),q=!(!s||!s.pushState),r=10,o=[r],p={urlRoot:"",useHash:!q};k.mix(d,E.Target);d.use=function(a,c){if(typeof a!=="string"){c=a;a=""}v.push([a,c])};d.navigate=function(a,b){var b=b||{},f=b.replace||false;if(j()!==a){if(!f){r++;o.push(r)}if(!p.useHash&&q){s[f?"replaceState":"pushState"]({vid:r},"",g.getFullPath(a,p.urlRoot));c(false,f)}else if(q){s[f?"replaceState":"pushState"]({vid:r},"","#!"+
a);c(false,f)}else l(a,f)}else b&&b.triggerRoute&&c(false,true)};d.get=function(a){var c=k.makeArray(arguments).slice(1);h.push(new D(a,c,p))};d.matchRoute=function(a){for(var c=0,b=h.length;c<b;c++)if(h[c].match(a))return h[c];return false};d.removeRoute=function(a,c){for(var b=h.length-1;b>=0;b--){var d=h[b];if(d.path===a)if(c){d.removeCallback(c);d.callbacks.length||h.splice(b,1)}else h.splice(b,1)}};d.clearRoutes=function(){v=[];h=[]};d.hasRoute=function(a){for(var c=0,b=h.length;c<b;c++)if(h[c].path===
a)return h[c];return false};d.config=function(a){if(a.urlRoot)a.urlRoot=a.urlRoot.replace(/\/$/,"");k.mix(p,a)};var w;d.start=function(a){if(w)return a&&a.call(d);var b=p.useHash,i=p.urlRoot,h=p.triggerRoute,m=location.pathname,k=location.href,o=j(),n=location.hash.match(/#!.+/);if(!b)if(q){if(n&&g.equalsIgnoreSlash(m,i)){s.replaceState({},"",g.getFullPath(o,i));h=1}}else if(g.equalsIgnoreSlash(m,i))b=true;else{location.replace(g.addEndSlash(i)+"#!"+o);return}setTimeout(function(){var i=q;if(q)t.on(u,
"popstate",y);else{t.on(u,"hashchange",z);h=1}if(b)if(j())if(!q&&A(k)!==r){l(g.getHash(k),true);h=0}else q&&g.hasVid(k)&&location.replace(k=g.removeVid(k));else{d.navigate("/",{replace:1});h=0;i=false}i&&s.replaceState({vid:r},"",k);h&&c(false,true);a&&a(d)},100);w=true;return d};d.Utils=g;d.stop=function(){w=false;t.detach(u,"hashchange",z);t.detach(u,"popstate",y)}});
KISSY.add("router/utils",["event/dom"],function(n,b){function d(a){return a.replace(/__ks-vid=.+$/,"")}function l(a){var c;return(c=a.match(/__ks-vid=(.+)$/))?parseInt(c[1],10):0}function j(a){return(a=a.match(/#(.+)$/))&&a[1]||""}var i=b("event/dom");return{endWithSlash:function(a){return"/"===a.charAt(a.length-1)},startWithSlash:function(a){return"/"===a.charAt(0)},removeEndSlash:function(a){this.endWithSlash(a)&&(a=a.substring(0,a.length-1));return a},removeStartSlash:function(a){this.startWithSlash(a)&&
(a=a.substring(1));return a},addEndSlash:function(a){return this.removeEndSlash(a)+"/"},addStartSlash:function(a){return a?"/"+this.removeStartSlash(a):a},getFullPath:function(a,c){return location.protocol+"//"+location.host+this.removeEndSlash(c)+this.addStartSlash(a)},equalsIgnoreSlash:function(a,c){a=this.removeEndSlash(a);c=this.removeEndSlash(c);return a===c},getHash:function(a){return d(j(a).replace(/^!/,"")).replace(i.REPLACE_HISTORY,"")},removeVid:d,hasVid:function(a){return-1!==a.indexOf("__ks-vid=")},
addVid:function(a,c){return a+"__ks-vid="+c},getVidFromUrlWithHash:function(a){return l(j(a))},getVidFromHash:l}});
KISSY.add("router/route",["util"],function(n,b){function d(b,a,c,d){j.isArray(b)&&(b="("+b.join("|")+")");b=b.concat(c?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(b,c,d,i,h,g,m){a.push(i);c=c||"";return""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(h||d&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")+(m?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return{keys:a,regexp:RegExp("^"+b+"$",d?"":"i")}}function l(b,a,c){this.path=b;this.callbacks=a;this.keys=
[];"string"===typeof b||j.isArray(b)?j.mix(this,d(b,this.keys,c.strict,c.caseSensitive)):this.regexp=b}var j=b("util");l.prototype={match:function(b){b=b.match(this.regexp);if(!b)return!1;for(var a=this.keys,c=[],d=1,n=b.length;d<n;++d){var l=a[d-1],k="string"===typeof b[d]?j.urlDecode(b[d]):b[d];l?c[l]=k:c.push(k)}return c},removeCallback:function(b){for(var a=this.callbacks||[],c=a.length-1;0<=c;c++)a===b&&a.splice(c,1)}};return l});
KISSY.add("router/request",[],function(){function n(b){for(var d in b)this[d]=b[d]}n.prototype={param:function(b){return b in this.params?this.params[b]:this.query[b]}};return n});
