/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 23 18:21
*/
KISSY.add("editor","node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager".split(","),function(n,h,v,u){function q(a,m){var d=a.get("textarea"),b=a.get("toolBarEl"),c=a.get("statusBarEl"),m=parseInt(m,10),m=m-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));d.parent().css(H,m);d.css(H,m)}function y(d,b){var c=d.body;m(function(){d.designMode=
"on";setTimeout(function M(){d.designMode="off";c.focus();if(!M.retry)M.retry=a},50)},function(){d.designMode="off";c.setAttribute("contentEditable",false);c.setAttribute("contentEditable",true);b||y(d,1)})}function t(a){var m=a.get("textarea")[0],c=a.get("window"),g=a.get("document"),l=g[0];if(x.webkit){g.on("click",function(a){var m=new k(a.target);n.inArray(m.nodeName(),["input","select"])&&a.preventDefault()});g.on("mouseup",function(a){var m=new k(a.target);n.inArray(m.nodeName(),["input","textarea"])&&
a.preventDefault()})}if(x.gecko||x.ie||x.opera){var e;e=(new k('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(m);e.on("focus",function(){a.focus()});a.activateGecko=function(){x.gecko&&a.__iframeFocus&&e[0].focus()};a.on("destroy",function(){e.detach();e.remove()})}c.on("focus",function(){x.gecko?y(l,d):x.opera&&l.body.focus();a.notifySelectionChange()});if(x.gecko)g.on("mousedown",function(){a.__iframeFocus||y(l,d)});if(E){g.on("keydown",function(m){if(m.keyCode in
{8:1,46:1}){var d=a.getSelection(),b=d.getSelectedElement();if(b){a.execCommand("save");var c=d.getRanges()[0].createBookmark();b.remove();d.selectBookmarks([c]);a.execCommand("save");m.preventDefault()}}});if(l.compatMode==="CSS1Compat"){var z={33:1,34:1};g.on("keydown",function(m){m.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(x.webkit)g.on("mousedown",function(m){m=new k(m.target);n.inArray(m.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(m)});
if(x.gecko)g.on("dragstart",function(a){var m=new k(a.target);m.nodeName()==="img"&&/ke_/.test(m[0].className)&&a.preventDefault()});b.add(a)}function f(a,m,d,b){var c="",g;g=o.debugUrl("theme/iframe.css");d=d.concat([]);d.unshift(g);for(g=0;g<d.length;g++)c=c+n.substitute('<link href="{href}" rel="stylesheet" />',{href:d[g]});return n.substitute(s,{doctype:n.UA.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:c,style:"<style>"+m+"</style>",data:b||"",script:a?
'<script id="ke_active_script">'+(C(l).isCustomDomain()?'document.domain="'+D.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+a+'");<\/script>':""})}function j(a,m){function d(){e=l.document;a.setInternal("document",new k(e));a.setInternal("window",new k(l));b.detach();e.open("text/html","replace");e.write(c);e.close()}var b=a.get("iframe"),c=f(a.get("id"),a.get("customStyle"),a.get("customLink"),m),g=b[0],l=g.contentWindow,e;b.__loaded=1;try{e=l.document}catch(z){g.src=g.src;if(E<
7){setTimeout(d,10);return}}d()}function r(a,m){var d=C(l).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new k(n.substitute(z,{iframeSrc:d,prefixCls:a.get("prefixCls")})),b=a.get("textarea");b.hasAttr("tabindex")&&d.attr("tabindex",x.webkit?-1:b.attr("tabindex"));b.parent().prepend(d);a.set("iframe",d);a.__docReady=0;if(x.gecko&&!d.__loaded)d.on("load",function(){j(a,m)},a);else j(a,m)}function w(a){if(a.get("iframe")){var m=a.get("iframe"),d=a.get("window"),a=a.get("document"),b=a[0],c=C(b.documentElement),
b=C(b.body);n.each([a,c,b,d],function(a){a.detach()});m.remove()}}var k=h("node"),s=h("editor/iframe-content-tpl"),p=h("editor/base"),o=h("editor/utils"),b=h("editor/focus-manager"),c=h("editor/clipboard"),e=h("editor/enter-key"),i=h("editor/html-data-processor"),g=h("editor/selection-fix");h("editor/styles");h("editor/dom-iterator");h("editor/z-index-manager");u.exports=p;var a=true,d=false,l=n.Env.host,D=l.document,x=n.UA,E=x.ieMode<11,A=k.NodeType,C=k.all,H="height",m=o.tryThese,z='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',
G=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;p.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};p.addMembers({initializer:function(){this.__commands={};this.__controls={};b.register(this)},renderUI:function(){c.init(this);e.init(this);i.init(this);g.init(this)},bindUI:function(){function a(){m.detach("docReady",a);if(m.get("focused"))m.focus();else{var d=m.getSelection();d&&d.removeAllRanges()}}var m=this,d,b=m.get("prefixCls"),c=m.get("textarea");if(m.get("attachForm")&&(d=c[0].form)&&(d=C(d)))d.on("submit",
m.sync,m);m.on("docReady",a);m.on("blur",function(){m.$el.removeClass(b+"editor-focused")});m.on("focus",function(){m.$el.addClass(b+"editor-focused")})},syncUI:function(){q(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,m){this.__controls[a]=m},showDialog:function(a,m){var a=a+"/dialog",d=this.__controls[a];d.show(m);this.fire("dialogShow",{dialog:d.dialog,
pluginDialog:d,dialogName:a})},addCommand:function(a,m){this.__commands[a]=m},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var m=this.__commands[a],d=n.makeArray(arguments);d.shift();d.unshift(this);if(m)return m.exec.apply(m,d)},queryCommandValue:function(a){return this.execCommand(o.getQueryCmd(a))},setData:function(a){var m,d=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(m=this.htmlDataProcessor)d=m.toDataFormat(a);w(this);r(this,d)}},getData:function(a,
m){var d=this.htmlDataProcessor,b;m===void 0&&(m=this.get("mode"));b=m===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());b=a?d.toHtml(b):d.toServer(b);b=n.trim(b);G.test(b)&&(b="");return b},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return f(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=
this.getSelection().getRanges()[0],m="";if(a){a=a.cloneContents();m=this.get("document")[0].createElement("div");m.appendChild(a);m=m.innerHTML}return m},focus:function(){var a=this.get("window");if(a){var m=this.get("document")[0],a=a[0];x.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{m.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,m){var d=this.get("window"),b=this.get("customStyle")||
"";this.set("customStyle",b+("\n"+a));d&&d.addStyleSheet(a,m)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var m=this.get("customLink"),d=this.get("document")[0];m.push(a);this.set("customLink",m);m=d.createElement("link");m.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(m);m.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(m){m.attr("href")===a&&m.remove()});var m=this.get("customLink"),d=n.indexOf(a,
m);d!==-1&&m.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var m=a.getSelection();if(m&&!m.isInvalid){var d=m.getStartElement(),b=new p.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(b)){a.__previousPath=b;a.fire("selectionChange",{selection:m,
path:b,element:d})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(m){if(this.get("mode")===1){this.focus();var d,b=m.nodeName(),c=p.XHTML_DTD,g=c.$block[b],e=p.RangeType,l=(b=this.getSelection())&&b.getRanges(),z,i,G;if(l&&l.length!==0){this.execCommand("save");for(i=l.length-1;i>=0;i--){z=l[i];d=!i&&m||m.clone(a);z.insertNodeByDtd(d);G||(G=d)}if(G){z.moveToPosition(G,e.POSITION_AFTER_END);if(g){m=p.Walker.whitespaces(true);(m=
(G=G.next(m,1))&&G[0].nodeType===A.ELEMENT_NODE&&G.nodeName())&&c.$block[m]&&c[m]["#text"]&&z.moveToElementEditablePosition(G)}b.selectRanges([z]);this.focus();d&&d[0].nodeType===1&&d.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});F.call(this);return d}}}},insertHtml:function(a,m){var d=this,b,c=d.get("document")[0];if(d.get("mode")===1){if(b=d.htmlDataProcessor)a=b.toDataFormat(a,m);d.focus();d.execCommand("save");if(b=c.selection){b.type==="Control"&&
b.clear();try{b.createRange().pasteHTML(a)}catch(g){}}else{b=d.get("iframe")[0].contentWindow.getSelection();var l=b.getRangeAt(0);l.deleteContents();var e=c.createElement("div");e.innerHTML=a;for(var c=c.createDocumentFragment(),z,i;z=e.firstChild;)i=c.appendChild(z);l.insertNode(c);if(i){l=l.cloneRange();l.setStartAfter(i);l.collapse(true);b.removeAllRanges();b.addRange(l)}}setTimeout(function(){d.getSelection().scrollIntoView()},50);F.call(d)}},_onSetHeight:function(a){q(this,a)},_onSetMode:function(a){var m=
this.get("iframe"),d=this.get("textarea");if(a===1){this.setData(d.val());d.hide();this.fire("wysiwygMode")}else{if(m){d.val(this.getFormatData(1));m.hide()}d.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,m=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(a=m[0].form)&&(a=C(a))&&a.detach("submit",this.sync,this);if(d){a=C(d[0].body);var m=C(d[0].documentElement),c=this.get("window");b.remove(this);d.detach();
m.detach();a.detach();c.detach()}n.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});p.decorate=function(a,m){var m=m||{},a=C(a),d=m.textareaAttrs=m.textareaAttrs||{},b=a.style("width"),c=a.style("height"),g=a.attr("name");if(b)m.width=m.width||b;if(c)m.height=m.height||c;if(g)d.name=g;m.data=m.data||a.val();m.elBefore=a;d=(new p(m)).render();a.remove();return d};p._initIframe=function(m){var c=b.getInstance(m),m=c.get("document"),g=m[0];m.one("#ke_active_script").remove();
t(c);var l=g.body,e=C(l);if(E){l.hideFocus=a;l.disabled=a;l.contentEditable=a;l.removeAttribute("disabled")}else setTimeout(function(){x.gecko||x.opera?l.contentEditable=a:x.webkit?l.parentNode.contentEditable=a:g.designMode="on"},0);if(x.gecko||x.opera){var z=g.documentElement;C(z).on("mousedown",function(a){if(a.target===z){x.gecko&&y(g,d);c.activateGecko()}})}setTimeout(function(){E&&setTimeout(function(){if(g){l.runtimeStyle.marginBottom="0px";l.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=
1;c.fire("docReady");var a=c.get("disableObjectResizing"),m=c.get("disableInlineTableEditing");if(a||m)try{g.execCommand("enableObjectResizing",d,!a);g.execCommand("enableInlineTableEditing",d,!m)}catch(b){e.on(E?"resizestart":"resize",function(d){var b=new k(d.target);(a||b.nodeName()==="table"&&m)&&d.preventDefault()})}},10)};var F=n.buffer(function(){this.execCommand("save")},50)});KISSY.add("editor/iframe-content-tpl",[],function(){return'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>'});
KISSY.add("editor/base",["html-parser","component/control","./render-xtpl"],function(n,h){var v=h("html-parser"),u=h("component/control"),q=h("./render-xtpl");return u.extend({beforeCreateDom:function(q){n.mix(q,{mobile:n.UA.mobile})}},{Config:{},XHTML_DTD:v.DTD,ATTRS:{contentTpl:{value:q},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},
statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},handleGestureEvents:{value:!1},focusable:{value:!1},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(n,h,v,u){h=function(q,h,t){var f=this.nativeCommands;if("5.0.0"!==n.version)throw Error("current xtemplate file("+this.name+")(v5.0.0) need to be recompiled using current kissy(v"+n.version+")!");var j=f.each,f=f["if"];h.write('<div class="');var r=q.resolve(["prefixCls"]);h.write(r,!0);h.write('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="');
r=q.resolve(["prefixCls"]);h.write(r,!0);h.write('editor-textarea-wrap"\r\n\r\n');var r={escape:1},w=[],k=q.resolve(["mobile"]);w.push(k);r.params=w;r.fn=function(f,j){j.write('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n');return j};h=f.call(this,q,r,h,12,t);h.write('\r\n>\r\n\r\n<textarea class="');r=q.resolve(["prefixCls"]);h.write(r,!0);h.write('editor-textarea"\r\n\r\n');r={escape:1};w=[];k=q.resolve(["textareaAttrs"]);w.push(k);r.params=w;r.fn=function(f,j){j.write("\r\n");
var k=f.resolve(["xindex"]);j.write(k,!0);j.write('="');k=f.resolve(["this"]);j.write(k,!0);j.write('"\r\n');return j};h=j.call(this,q,r,h,19,t);h.write("\r\n\r\n");j={escape:1};r=[];w=q.resolve(["mode"]);r.push(w);j.params=r;j.fn=function(f,j){j.write('\r\nstyle="display:none"\r\n');return j};h=f.call(this,q,j,h,23,t);h.write("\r\n\r\n>");t=q.resolve(["data"]);h.write(t,!0);h.write('</textarea>\r\n\r\n</div>\r\n\r\n<div class="');q=q.resolve(["prefixCls"]);h.write(q,!0);h.write('editor-status">\r\n\r\n</div>');
return h};h.TPL_NAME=u.name;return h});
KISSY.add("editor/utils",["node","./base"],function(n,h){var v=h("node"),u=h("./base"),q=n.require("dom"),y=n.UA,t={debugUrl:function(f){var j=n.Config;j.debug&&(f=f.replace(/\.(js|css)/i,"-debug.$1"));-1===f.indexOf("?t")&&(f=-1!==f.indexOf("?")?f+"&":f+"?",j.tag&&(f+="t="+encodeURIComponent(j.tag)));return n.config("base")+"editor/"+f},lazyRun:function(f,j,r){var n=f[j],k=f[r];f[j]=function(){n.apply(this,arguments);f[j]=f[r];return k.apply(this,arguments)}},getXY:function(f,j){var r=f.left,n=f.top,
k=j.get("window")[0],r=r-q.scrollLeft(k),n=n-q.scrollTop(k),k=j.get("iframe").offset(),r=r+k.left,n=n+k.top;return{left:r,top:n}},tryThese:function(){for(var f,j=0,n=arguments.length;j<n;j++){var h=arguments[j];try{f=h();break}catch(k){}}return f},clearAllMarkers:function(f){for(var j in f)f[j]._4eClearMarkers(f,!0,void 0)},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(n.trim(f))},verifyInputs:function(f){for(var j=
0;j<f.length;j++){var r=new v(f[j]),h=n.trim(t.valInput(r)),k=r.attr("data-verify"),r=r.attr("data-warning");if(k&&!RegExp(k).test(h))return alert(r),!1}return!0},sourceDisable:function(f,j){f.on("sourceMode",j.disable,j);f.on("wysiwygMode",j.enable,j)},resetInput:function(f){var j=f.attr("placeholder");j&&y.ie?(f.addClass("ks-editor-input-tip"),f.val(j)):y.ie||f.val("")},valInput:function(f,j){if(void 0===j)return f.hasClass("ks-editor-input-tip")?"":f.val();f.removeClass("ks-editor-input-tip");
f.val(j)},placeholder:function(f,j){f.attr("placeholder",j);y.ie&&(f.on("blur",function(){n.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(j))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");n.trim(f.val())===j&&f.val("")}))},normParams:function(f){var f=n.clone(f),j;for(j in f){var r=f[j];"function"===typeof r&&(f[j]=r())}return f},preventFocus:function(f){y.ie?f.unselectable():f.attr("onmousedown","return false;")},injectDom:function(f){n.mix(q,f);for(var j in f)(function(j){v.prototype[j]=
function(){var h=[].slice.call(arguments,0);h.unshift(this[0]);return(h=f[j].apply(null,h))&&(h.nodeType||n.isWindow(h))?new v(h):n.isArray(h)&&(h.__IS_NODELIST||h[0]&&h[0].nodeType)?new v(h):h}})(j)},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,n.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],j=0;j<f.length;j++){var h=f[j];"function"===typeof h?h():h.destroy?h.destroy():h.remove&&h.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,
function(f,h){return h.toUpperCase()})+"Value"}};return u.Utils=t});
KISSY.add("editor/focus-manager",["./base"],function(n,h){function v(){var j=this;j.__iframeFocus=r;f=j;t&&clearTimeout(t);t=setTimeout(function(){j.fire("focus")},30)}function u(){var j=this;j.__iframeFocus=w;f=k;t&&clearTimeout(t);t=setTimeout(function(){j.fire("blur")},30)}var q=h("./base"),y={},t,f,j={currentInstance:function(){return f},getInstance:function(f){return y[f]},register:function(f){y[f.get("id")]=f},add:function(f){this.register(f);f.get("window").on("focus",v,f).on("blur",u,f)},
remove:function(f){delete y[f.get("id")];f.get("window").detach("focus",v,f).detach("blur",u,f)}},r=!0,w=!1,k=null;q.focusManager=j;q.getInstances=function(){return y};return j});
KISSY.add("editor/clipboard",["node","./base","./range","./selection"],function(n,h){function v(a){this.editor=a;this._init()}function u(a){var d=a.get("document")[0],b=a.getSelection(),c;if(b.getType()===w.SELECTION_ELEMENT&&(c=b.getSelectedElement())){var a=b.getRanges()[0],g=k(d.createTextNode(""));g.insertBefore(c);a.setStartBefore(g);a.setEndAfter(c);b.selectRanges([a]);setTimeout(function(){c.parent()&&(g.remove(),b.selectElement(c))},0)}}function q(a){if(s.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(s.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(s.gecko||s.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function y(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(s.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(s.gecko||s.opera)s.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function t(a){var d=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,
"");-1!==a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,d){return d.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(d=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!d&&q(a)&&(a=y(a));return a}var f=h("node"),j=h("./base"),r=h("./range"),w=h("./selection"),k=f.all,
s=n.UA,p=11>s.ieMode,o=p?"beforepaste":"paste",b=j.RangeType;n.augment(v,{_init:function(){var a=this,d=a.editor,b=d.get("document"),c=b.one("body"),g=function(a){this.type=a};g.prototype={exec:function(d){var b=this.type;d.focus();setTimeout(function(){p&&("cut"===b?u(d):"paste"===b&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));e(d,b)||alert(i[b])},0)}};c.on(o,a._getClipboardDataFromPasteBin,a);p&&(c.on("paste",a._iePaste,a),b.on("keydown",a._onKeyDown,a),b.on("contextmenu",function(){a._isPreventBeforePaste=
1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));d.addCommand("copy",new g("copy"));d.addCommand("cut",new g("cut"));d.addCommand("paste",new g("paste"))},_onKeyDown:function(a){this.editor.get("mode")===j.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86===a.keyCode||a.shiftKey&&45===a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,b=this.editor;if("paste"===a){this._isPreventBeforePaste=1;try{d=b.get("document")[0].queryCommandEnabled(a)}catch(c){}this._isPreventBeforePaste=
0}else d=(a=(a=b.getSelection())&&a.getRanges())&&!(1===a.length&&a[0].collapsed);return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;this._isPreventPaste||(a.preventDefault(),d.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,d=a.get("document")[0];if(!d.getElementById("ke-paste-bin")){var c=
a.getSelection(),g=new r(d),e=k(s.webkit?"<body></body>":"<div></div>",d);e.attr("id","ke-paste-bin");s.webkit&&e[0].appendChild(d.createTextNode("\u200b"));d.body.appendChild(e[0]);e.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var i=c.createBookmarks();g.setStartAt(e,b.POSITION_AFTER_START);g.setEndAt(e,b.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var d,b=e;e=s.webkit&&(d=e.first())&&d.hasClass("Apple-style-span")?
d:e;c.selectBookmarks(i);var g=e.html();b.remove();if(g=t(g))d=a.fire("paste",{html:g}),!1!==d&&(void 0!==d&&(g=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?n.use("editor/plugin/word-filter",function(m,d){a.insertHtml(d.toDataFormat(g,a))}):a.insertHtml(g))},0)}}}});var c=function(a,d){var b=a.get("document")[0],c=k(b.body),g=!1,e=function(){g=!0};c.on(d,e);(7<s.ieMode?b:b.selection.createRange()).execCommand(d);c.detach(d,e);return g},e=p?function(a,d){return c(a,d)}:function(a,
d){try{return a.get("document")[0].execCommand(d)}catch(b){return!1}},i={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},g={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var d;a.docReady(function(){d=new v(a)});var b={copy:1,cut:1,paste:1},c=["copy","cut","paste"];a.on("contextmenu",function(e){var i=e.contextmenu;if(!i.__copyFix){i.__copyFix=1;for(e=0;e<c.length;e++)i.addChild({content:g[c[e]],
value:c[e]});i.on("click",function(m){var d=m.target.get("value");b[d]&&(i.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var f=i.get("children"),e=f.length-1;e--;0<=e){var j=f[e],k;k=j.get?j.get("value"):j.value;b[k]&&(k=!d._stateFromNamedCommand(k),j.set?j.set("disabled",k):j.disabled=k)}})}}});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./element-path".split(","),function(n,h){function v(m){var d=m.nodeType!==i.NodeType.TEXT_NODE&&i.nodeName(m)in a.$removeEmpty,b=m.nodeType===i.NodeType.TEXT_NODE&&!n.trim(m.nodeValue),m=!!m.parentNode.getAttribute("_ke_bookmark");return d||b||m}function u(a){return!x(a)&&!E(a)}function q(a){var d=o;return function(b){if(E(b))return p;if(b.nodeType===i.NodeType.TEXT_NODE){if(n.trim(b.nodeValue).length)return o}else if(b.nodeType===i.NodeType.ELEMENT_NODE){b=
i.nodeName(b);if(!H[b])if(!a&&!g.ie&&b==="br"&&!d)d=p;else return o}return p}}function y(a,d){var b=a.startContainer,c=a.endContainer,g=a.startOffset,e=a.endOffset,f,D=o,k=o,h,x=a.document,O;d>0&&(h=x.createDocumentFragment());if(a.collapsed)return h;a.optimizeBookmark();if(c[0].nodeType===i.NodeType.TEXT_NODE){k=p;c=c._4eSplitText(e)}else if(c[0].childNodes.length>0)if(e>=c[0].childNodes.length){c=new j(c[0].appendChild(x.createTextNode("")));O=p}else c=new j(c[0].childNodes[e]);if(b[0].nodeType===
i.NodeType.TEXT_NODE){D=p;b._4eSplitText(g)}else if(g)if(g>=b[0].childNodes.length){b=new j(b[0].appendChild(x.createTextNode("")));f=p}else b=new j(b[0].childNodes[g].previousSibling);else{f=new j(x.createTextNode(""));b.prepend(f);b=f;f=p}var n=b._4eParents(),K=c._4eParents();n.each(function(a,d){n[d]=a});K.each(function(a,d){K[d]=a});for(var I,r,x=0;x<n.length;x++){I=n[x];r=K[x];if(!I.equals(r))break}for(var g=h,B,E,s=x;s<n.length;s++){B=n[s];e=d>0&&!B.equals(b)?g.appendChild(B.clone()[0]):null;
B=B[0].nextSibling;E=K[s];for(var q=c[0],A=E&&E[0];B;){if(A===B||q===B)break;E=B.nextSibling;if(d===2)g.appendChild(B.cloneNode(p));else{if(l[B.nodeName.toLowerCase()]){var w=B.cloneNode(p);B.innerHTML="";B=w}else i._4eRemove(B);d===1&&g.appendChild(B)}B=E}e&&(g=e)}for(g=h;x<K.length;x++){B=K[x];e=d>0&&!B.equals(c)?g.appendChild(B.clone()[0]):null;if(!n[x]||!B._4eSameLevel(n[x]))for(B=B[0].previousSibling;B;){E=B.previousSibling;if(d===2)g.insertBefore(B.cloneNode(p),g.firstChild);else{i._4eRemove(B);
d===1&&g.insertBefore(B,g.firstChild)}B=E}e&&(g=e)}if(d===2){if(D){I=b[0];if(I.nodeType===i.NodeType.TEXT_NODE&&I.nextSibling&&I.nextSibling.nodeType===i.NodeType.TEXT_NODE){I.data=I.data+I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}if(k){k=c[0];if(k.nodeType===i.NodeType.TEXT_NODE&&k.previousSibling&&k.previousSibling.nodeType===i.NodeType.TEXT_NODE){k.previousSibling.data=k.previousSibling.data+k.data;k.parentNode.removeChild(k)}}}else{if(I&&r&&(!b._4eSameLevel(I)||!c._4eSameLevel(r))){k=
I._4eIndex();f&&I._4eSameLevel(b)&&k--;a.setStart(I.parent(),k+1)}a.collapse(p)}f&&b.remove();O&&c.remove();return h}function t(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function f(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=b;this.collapsed=p;this.document=a}h("./dom");var j=h("node"),r=h("./utils"),w=h("./walker"),k=h("./base"),s=h("./element-path");k.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=true,o=false,b=null,c=k.RangeType,e=k.PositionType,i=n.require("dom"),g=n.UA,a=k.XHTML_DTD,d=j.all,l={td:1},D={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},x=new w.whitespaces,E=new w.bookmark,A=w.whitespaces(p),C=w.bookmark(false,true),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.augment(f,{toString:function(){var a=[],d=this.startContainer[0],b=this.endContainer[0];a.push((d.id||d.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,d=this.startOffset;a[0].nodeType!==i.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
d=this.endOffset;a[0].nodeType!==i.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);d&&d.nodeName()==="span"&&d.attr("_ke_bookmark")&&this.setEndAfter(d)},setStart:function(a,d){if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&D[a.nodeName()]){a=a.parent();d=a._4eIndex()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}t(this)},setEnd:function(a,d){if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&D[a.nodeName()]){a=a.parent();d=a._4eIndex()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=
a;this.startOffset=d}t(this)},setStartAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===i.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}t(this)},setEndAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
i.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}t(this)},cloneContents:function(){return y(this,2)},deleteContents:function(){return y(this,0)},extractContents:function(){return y(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=p},clone:function(){var a=new f(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==i.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==i.NodeType.ELEMENT_NODE)return b;var d=new w(a);d.evaluator=function(a){return A(a)&&C(a)};a=d.next();d.reset();
d=d.previous();return a&&a.equals(d)?a:b},shrink:function(a,d){if(!this.collapsed){var a=a||c.SHRINK_TEXT,b=this.clone(),g=this.startContainer,e=this.endContainer,l=this.startOffset,f=this.endOffset,j=p,k,D,x=p;if(g&&g[0].nodeType===i.NodeType.TEXT_NODE)if(l)if(l>=g[0].nodeValue.length)b.setStartAfter(g);else{b.setStartBefore(g);j=o}else b.setStartBefore(g);if(e&&e[0].nodeType===i.NodeType.TEXT_NODE)if(f)if(f>=e[0].nodeValue.length)b.setEndAfter(e);else{b.setEndAfter(e);x=o}else b.setEndBefore(e);
if(j||x){D=new w(b);D.evaluator=function(d){return d.nodeType===(a===c.SHRINK_ELEMENT?i.NodeType.ELEMENT_NODE:i.NodeType.TEXT_NODE)};D.guard=function(d,b){if(a===c.SHRINK_ELEMENT&&d.nodeType===i.NodeType.TEXT_NODE||b&&d===k)return o;!b&&d.nodeType===i.NodeType.ELEMENT_NODE&&(k=d);return p}}if(j)(b=D[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(b,d?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(x){D.reset();(D=D[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(D,
d?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return j||x}},createBookmark2:function(a){var d=this.startContainer,c=this.endContainer,g=this.startOffset,e=this.endOffset,l,f;if(!d||!c)return{start:0,end:0};if(a){if(d[0].nodeType===i.NodeType.ELEMENT_NODE)if((l=new j(d[0].childNodes[g]))&&l[0]&&l[0].nodeType===i.NodeType.TEXT_NODE&&g>0&&l[0].previousSibling.nodeType===i.NodeType.TEXT_NODE){d=l;g=0}for(;d[0].nodeType===i.NodeType.TEXT_NODE&&(f=d.prev(void 0,1))&&f[0].nodeType===i.NodeType.TEXT_NODE;){d=
f;g=g+f[0].nodeValue.length}if(!this.collapsed){if(c[0].nodeType===i.NodeType.ELEMENT_NODE)if((l=new j(c[0].childNodes[e]))&&l[0]&&l[0].nodeType===i.NodeType.TEXT_NODE&&e>0&&l[0].previousSibling.nodeType===i.NodeType.TEXT_NODE){c=l;e=0}for(;c[0].nodeType===i.NodeType.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType===i.NodeType.TEXT_NODE;){c=f;e=e+f[0].nodeValue.length}}}return{start:d._4eAddress(a),end:this.collapsed?b:c._4eAddress(a),startOffset:g,endOffset:e,normalized:a,is2:p}},createBookmark:function(a){var d,
g,e,l,f=this.collapsed;d=new j("<span>",b,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");if(a){e=n.guid("ke_bm_");d.attr("id",e+"S")}if(!f){g=d.clone();g.html("&nbsp;");a&&g.attr("id",e+"E");l=this.clone();l.collapse();l.insertNode(g)}l=this.clone();l.collapse(p);l.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,c.POSITION_AFTER_END);return{startNode:a?e+"S":d,endNode:a?e+"E":g,serializable:a,collapsed:f}},moveToPosition:function(a,
d){this.setStartAt(a,d);this.collapse(p)},trim:function(a,d){var b=this.startContainer,c=this.startOffset,g=this.collapsed;if((!a||g)&&b[0]&&b[0].nodeType===i.NodeType.TEXT_NODE){if(c)if(c>=b[0].nodeValue.length){c=b._4eIndex()+1;b=b.parent()}else{var e=b._4eSplitText(c),c=b._4eIndex()+1,b=b.parent();if(i.equals(this.startContainer,this.endContainer))this.setEnd(e,this.endOffset-this.startOffset);else if(i.equals(b,this.endContainer))this.endOffset=this.endOffset+1}else{c=b._4eIndex();b=b.parent()}this.setStart(b,
c);if(g){this.collapse(p);return}}b=this.endContainer;c=this.endOffset;if(!d&&!g&&b[0]&&b[0].nodeType===i.NodeType.TEXT_NODE){if(c){c>=b[0].nodeValue.length||b._4eSplitText(c);c=b._4eIndex()+1}else c=b._4eIndex();b=b.parent();this.setEnd(b,c)}},insertNode:function(a){this.optimizeBookmark();this.trim(o,p);var d=this.startContainer;d[0].insertBefore(a[0],d[0].childNodes[this.startOffset]||null);d[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=d(this.document);
if(a.is2){var c=b._4eGetByAddress(a.start,a.normalized),g=a.startOffset,b=a.end&&b._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,g);b?this.setEnd(b,a):this.collapse(p)}else{c=(g=a.serializable)?n.one("#"+a.startNode,b):a.startNode;a=g?n.one("#"+a.endNode,b):a.endNode;this.setStartBefore(c);c._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(p)}},getCommonAncestor:function(a,d){var b=this.startContainer,c=this.endContainer,b=b[0]===c[0]?a&&b[0].nodeType===
i.NodeType.ELEMENT_NODE&&this.startOffset===this.endOffset-1?new j(b[0].childNodes[this.startOffset]):b:b._4eCommonAncestor(c);return d&&b[0].nodeType===i.NodeType.TEXT_NODE?b.parent():b},enlarge:function(){function a(b,c,g,e){var l=b[c?"startContainer":"endContainer"],m,f=c?0:1,j=0,k=c?"previousSibling":"nextSibling";m=b[c?"startOffset":"endOffset"];if(l[0].nodeType===i.NodeType.TEXT_NODE){if(c){if(m)return}else if(m<l[0].nodeValue.length)return;m=l[0][k];l=l[0].parentNode}else{m=l[0].childNodes[m+
(c?-1:1)]||null;l=l[0]}for(;l;){for(;m;)if(x(m)||E(m))m=m[k];else break;if(m){if(!j)b[c?"setStartAfter":"setEndBefore"](d(m));break}l=d(l);if(l.nodeName()==="body")break;if(j||l.equals(e)){g[f]=l;j=1}else b[c?"setStartBefore":"setEndAfter"](l);m=l[0][k];l=l[0].parentNode}}return function(g){var e;switch(g){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var g=this.getCommonAncestor(),l=[];a(this,1,l,g);a(this,0,l,g);if(l[0]&&l[1]){g=l[0].contains(l[1])?l[1]:l[0];this.setStartBefore(g);this.setEndAfter(g)}break;
case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:e=new f(this.document);l=new j(this.document.body);e.setStartAt(l,c.POSITION_AFTER_START);e.setEnd(this.startContainer,this.startOffset);e=new w(e);var k,D,x=w.blockBoundary(g===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:b),h=function(a){var b=x(a);b||(k=d(a));return b},n=function(a){var b=h(a);!b&&i.nodeName(a)==="br"&&(D=d(a));return b};e.guard=h;e=e.lastBackward();k=k||l;this.setStartAt(k,k.nodeName()!=="br"&&(!e&&this.checkStartOfBlock()||
e&&k.contains(e))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);e=this.clone();e.collapse();e.setEndAt(l,c.POSITION_BEFORE_END);e=new w(e);e.guard=g===c.ENLARGE_LIST_ITEM_CONTENTS?n:h;k=b;e=e.lastForward();k=k||l;this.setEndAt(k,!e&&this.checkEndOfBlock()||e&&k.contains(e)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);D&&this.setEndAfter(D)}}}(),checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType===i.NodeType.TEXT_NODE&&n.trim(a[0].nodeValue.substring(0,d)).length)return o;
this.trim();a=new s(this.startContainer);d=this.clone();d.collapse(p);d.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new w(d);a.evaluator=q(p);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType===i.NodeType.TEXT_NODE&&n.trim(a[0].nodeValue.substring(d)).length)return o;this.trim();a=new s(this.endContainer);d=this.clone();d.collapse(o);d.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new w(d);a.evaluator=q(o);return a.checkForward()},
checkBoundaryOfElement:function(a,d){var b=this.clone();b[d===c.START?"setStartAt":"setEndAt"](a,d===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new w(b);b.evaluator=v;return b[d===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,l;if(a[0].nodeType===i.NodeType.ELEMENT_NODE){l=a[0].childNodes.length;if(l>c)a=d(a[0].childNodes[c]);else if(l===0)a=a._4ePreviousSourceNode();else{for(a=
a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4eNextSourceNode()||a}}if(b[0].nodeType===i.NodeType.ELEMENT_NODE){l=b[0].childNodes.length;if(l>g)b=d(b[0].childNodes[g])._4ePreviousSourceNode(p);else if(l===0)b=b._4ePreviousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}}a._4ePosition(b)&e.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var e=this.createBookmark(),l=d(this.document.createElement(b));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);
l[0].appendChild(this.extractContents());l._4eTrim();g.ie||l._4eAppendBogus();this.insertNode(l);this.moveToBookmark(e);return l},splitBlock:function(a){var d=new s(this.startContainer),e=new s(this.endContainer),l=d.block,f=e.block,i=b;if(!d.blockLimit.equals(e.blockLimit))return b;if(a!=="br"){if(!l){l=this.fixBlock(p,a);f=(new s(this.endContainer)).block}f||(f=this.fixBlock(o,a))}a=l&&this.checkStartOfBlock();d=f&&this.checkEndOfBlock();this.deleteContents();if(l&&l[0]===f[0])if(d){i=new s(this.startContainer);
this.moveToPosition(f,c.POSITION_AFTER_END);f=b}else if(a){i=new s(this.startContainer);this.moveToPosition(l,c.POSITION_BEFORE_START);l=b}else{f=this.splitElement(l);!g.ie&&!n.inArray(l.nodeName(),["ul","ol"])&&l._4eAppendBogus()}return{previousBlock:l,nextBlock:f,wasStartOfBlock:a,wasEndOfBlock:d,elementPath:i}},splitElement:function(a){if(!this.collapsed)return b;this.setEndAt(a,c.POSITION_BEFORE_END);var d=this.extractContents(),g=a.clone(o);g[0].appendChild(d);g.insertAfter(a);this.moveToPosition(a,
c.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(a,d){for(var b=0;a;){if(a[0].nodeType===i.NodeType.TEXT_NODE){this.moveToPosition(a,d?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);b=1;break}if(a[0].nodeType===i.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,d?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);b=1}var g=a,e=b,l=void 0;g[0].nodeType===i.NodeType.ELEMENT_NODE&&g._4eIsEditable()&&(l=g[d?"last":"first"](u,1));!e&&!l&&(l=g[d?"prev":"next"](u,1));a=l}return!!b},
selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,d.nodeType===i.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(d){var b,c,g,e=d.nodeName();b=a.$block[e];this.deleteContents();if(b){for(b=this.getCommonAncestor(o,p);(c=a[b.nodeName()])&&(!c||!c[e]);){var l=b.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(b);this.collapse(p);b.remove()}else g=b;b=l}g&&this.splitElement(g)}this.insertNode(d)}});r.injectDom({_4eBreakParent:function(a,
b){var b=d(b),a=d(a),c,g=new k.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);c=g.extractContents();g.insertNode(a.remove());a.after(c)}});return k.Range=f});
KISSY.add("editor/dom",["node","./base","./utils"],function(n,h){function v(b,c){var e=b[c?"next":"prev"](void 0,1);if(e&&e[0].nodeType===j.ELEMENT_NODE){for(var f=[];e.attr("_ke_bookmark")||e._4eIsEmptyInlineRemovable(void 0);)if(f.push(e),e=c?e.next(void 0,1):e.prev(void 0,1),!e)return;if(b._4eIsIdentical(e,void 0)){for(var g=new u(c?b[0].lastChild:b[0].firstChild);f.length;)f.shift()._4eMove(b,!c,void 0);e._4eMoveChildren(b,!c,void 0);e.remove();g[0]&&g[0].nodeType===j.ELEMENT_NODE&&g._4eMergeSiblings()}}}
var u=h("node"),q=h("./base"),y=h("./utils"),t=q.XHTML_DTD,f=n.require("dom"),j=f.NodeType,r=n.UA,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var k=q.PositionType,s={block:1,"list-item":1,table:1,"table-row-group":1,
"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},p={hr:1},o=function(b){return b&&(b[0]||b)};y.injectDom({_4eSameLevel:function(b,c){var c=o(c),e=b.parentNode;return e&&e===c.parentNode},_4eIsBlockBoundary:function(b,c){var e=n.merge(p,c);return!(!s[f.css(b,"display")]&&!e[f.nodeName(b)])},_4eIndex:function(b,c){for(var e=b.parentNode.childNodes,f,g=-1,a=0;a<e.length;a++)if(f=e[a],!c||!(3===f.nodeType&&f.previousSibling&&
3===f.previousSibling.nodeType))if(g++,f===b)return g;return-1},_4eMove:function(b,c,e){c=o(c);e?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4eIsIdentical:function(b,c){if(!c)return!1;c=o(c);if(f.nodeName(b)!==f.nodeName(c))return!1;var e=b.attributes,i,g,a=c.attributes,d=e.length,l=a.length;if(d!==l)return!1;for(var j=0;j<d;j++)if(i=e[j],g=i.name,i.specified&&f.attr(b,g)!==f.attr(c,g))return!1;if(8>r.ieMode)for(j=0;j<l;j++)if(i=a[j],g=i.name,i.specified&&f.attr(b,g)!==f.attr(c,g))return!1;
return!0},_4eIsEmptyInlineRemovable:function(b){if(!t.$removeEmpty[f.nodeName(b)])return!1;for(var b=b.childNodes,c=0,e=b.length;c<e;c++){var i=b[c],g=i.nodeType;if(!(g===j.ELEMENT_NODE&&i.getAttribute("_ke_bookmark"))&&(g===j.ELEMENT_NODE&&!f._4eIsEmptyInlineRemovable(i)||g===f.NodeType.TEXT_NODE&&n.trim(i.nodeValue)))return!1}return!0},_4eMoveChildren:function(b,c,e){c=o(c);if(b!==c)if(e)for(;e=b.lastChild;)c.insertBefore(b.removeChild(e),c.firstChild);else for(;e=b.firstChild;)c.appendChild(b.removeChild(e))},
_4eMergeSiblings:function(b){b=new u(b);w[b.nodeName()]&&(v(b,!0),v(b))},_4eSplitText:function(b,c){var e=b.ownerDocument;if(b.nodeType===f.NodeType.TEXT_NODE){if(r.ie&&c===b.nodeValue.length){var i=e.createTextNode("");f.insertAfter(i,b);return i}i=b.splitText(c);e.documentMode&&(e=e.createTextNode(""),f.insertAfter(e,i),f.remove(e));return i}},_4eParents:function(b,c){var e=[];e.__IS_NODELIST=1;do e[c?"push":"unshift"](b);while(b=b.parentNode);return e},_4eNextSourceNode:function(b,c,e,i){if(i&&
!i.call)var g=o(i),i=function(a){return a!==g};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType===j.ELEMENT_NODE&&i&&!1===i(b,!0))return null;c=b.nextSibling}for(;!c&&(a=a.parentNode);){if(i&&!1===i(a,!0))return null;c=a.nextSibling}return!c||i&&!1===i(c)?null:e&&e!==c.nodeType?f._4eNextSourceNode(c,!1,e,i):c},_4ePreviousSourceNode:function(b,c,e,i){if(i&&!i.call)var g=o(i),i=function(a){return a!==g};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType===j.ELEMENT_NODE&&i&&!1===i(b,!0))return null;c=b.previousSibling}for(;!c&&
(a=a.parentNode);){if(i&&!1===i(a,!0))return null;c=a.previousSibling}return!c||i&&!1===i(c)?null:e&&c.nodeType!==e?f._4ePreviousSourceNode(c,!1,e,i):c},_4eCommonAncestor:function(b,c){c=o(c);if(b===c)return b;if(f.contains(c,b))return c;var e=b;do if(f.contains(e,c))return e;while(e=e.parentNode);return null},_4eHasAttributes:9>r.ieMode?function(b){for(var c=b.attributes,e=0;e<c.length;e++){var f=c[e];switch(f.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(f.specified)return!0}}return!1}:
function(b){r.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4ePosition:function(b,c){var e=o(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(e);if(b===e)return k.POSITION_IDENTICAL;if(b.nodeType===j.ELEMENT_NODE&&e.nodeType===j.ELEMENT_NODE){if(f.contains(b,e))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(f.contains(e,b))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>e.sourceIndex?k.POSITION_DISCONNECTED:
b.sourceIndex<e.sourceIndex?k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var i=f._4eAddress(b),e=f._4eAddress(e),g=Math.min(i.length,e.length),a=0;a<=g-1;a++)if(i[a]!==e[a])return i[a]<e[a]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return i.length<e.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4eAddress:function(b,c){for(var e=[],i=b.ownerDocument.documentElement,g=b;g&&g!==i;)e.unshift(f._4eIndex(g,c)),g=g.parentNode;return e},_4eRemove:function(b,
c){var e=b.parentNode;if(e){if(c)for(var f;f=b.firstChild;)e.insertBefore(b.removeChild(f),b);e.removeChild(b)}return b},_4eTrim:function(b){f._4eLtrim(b);f._4eRtrim(b)},_4eLtrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType===f.NodeType.TEXT_NODE){var e=y.ltrim(c.nodeValue),i=c.nodeValue.length;if(e)e.length<i&&(f._4eSplitText(c,i-e.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4eRtrim:function(b){for(var c;c=b.lastChild;){if(c.type===f.NodeType.TEXT_NODE){var e=
y.rtrim(c.nodeValue),i=c.nodeValue.length;if(e)e.length<i&&(f._4eSplitText(c,e.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!r.ie&&!r.opera&&(c=b.lastChild)&&1===c.nodeType&&"br"===f.nodeName(c)&&b.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===f.NodeType.TEXT_NODE&&!n.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===f.NodeType.TEXT_NODE||"br"!==f.nodeName(c))c=r.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),
b.appendChild(c)},_4eSetMarker:function(b,c,e,f){var b=new u(b),g=b.data("list_marker_id")||b.data("list_marker_id",n.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[g]=b;a[e]=1;return b.data(e,f)},_4eClearMarkers:function(b,c,e){var b=new u(b),f=b.data("list_marker_names"),g=b.data("list_marker_id"),a;for(a in f)b.removeData(a);b.removeData("list_marker_names");e&&(b.removeData("list_marker_id"),delete c[g])},_4eCopyAttributes:function(b,
c,e){for(var c=new u(c),i=b.attributes,e=e||{},g=0;g<i.length;g++){var a=i[g],d=a.name.toLowerCase(),l;if(!(d in e))if("checked"===d&&(l=f.attr(b,d)))c.attr(d,l);else if(a.specified||r.ie&&a.value&&"value"===d)l=f.attr(b,d),null===l&&(l=a.nodeValue),c.attr(d,l)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},_4eIsEditable:function(b){b=f.nodeName(b);return(b=!t.$nonEditable[b]&&(t[b]||t.span))&&b["#text"]},_4eGetByAddress:function(b,c,e){for(var b=b.documentElement,f=0;b&&f<c.length;f++){var g=
c[f];if(e)for(var a=-1,d=0;d<b.childNodes.length;d++){var l=b.childNodes[d];if(!(!0===e&&3===l.nodeType&&l.previousSibling&&3===l.previousSibling.nodeType)&&(a++,a===g)){b=l;break}}else b=b.childNodes[g]}return b}})});
KISSY.add("editor/walker",["./base","node"],function(n,h){function v(b,c){if(this._.end)return j;var g,a=this.range,d,l=this.guard,k=this.type,x=b?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),j;if(!b&&!this._.guardLTR){var h=a.endContainer[0],n=h.childNodes[a.endOffset];this._.guardLTR=function(a,d){return d&&(h===a||"body"===w.nodeName(a))?!1:a!==n}}if(b&&!this._.guardRTL){var o=a.startContainer[0],r=0<a.startOffset&&o.childNodes[a.startOffset-
1]||null;this._.guardRTL=function(a,d){return d&&(o===a||"body"===w.nodeName(a))?!1:a!==r}}var m=b?this._.guardRTL:this._.guardLTR;d=l?function(a,d){return m(a,d)===f?f:l(a,d)}:m;this.current?g=this.current[x](f,k,d):b?(g=a.endContainer,0<a.endOffset?(g=new s(g[0].childNodes[a.endOffset-1]),d(g[0])===f&&(g=j)):g=d(g,t)===f?j:g._4ePreviousSourceNode(t,k,d,void 0)):(g=a.startContainer,g=new s(g[0].childNodes[a.startOffset]),g.length?d(g[0])===f&&(g=j):g=d(a.startContainer,t)===f?j:a.startContainer._4eNextSourceNode(t,
k,d,void 0));for(;g&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g[0])!==f){if(!c)return g}else if(c&&this.evaluator)return f;g=g[x](f,k,d)}this.end();return this.current=j}function u(b){for(var c,g=j;c=v.call(this,b);)g=c;return g}function q(b){this.range=b;this.guard=this.evaluator=j;this._={}}var y=h("./base"),t=!0,f=!1,j=null,r=n.UA,w=n.require("dom"),k=y.XHTML_DTD,s=h("node");n.augment(q,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,
t)},checkForward:function(){return v.call(this,f,t)!==f},checkBackward:function(){return v.call(this,t,t)!==f},lastForward:function(){return u.call(this)},lastBackward:function(){return u.call(this,t)},reset:function(){delete this.current;this._={}},_iterator:v});n.mix(q,{blockBoundary:function(b){return function(c){return!(c.nodeType===w.NodeType.ELEMENT_NODE&&w._4eIsBlockBoundary(c,b))}},bookmark:function(b,c){function g(a){return"span"===w.nodeName(a)&&w.attr(a,"_ke_bookmark")}return function(a){var d,
l;d=a.nodeType===w.NodeType.TEXT_NODE&&(l=a.parentNode)&&g(l);d=b?d:d||g(a);return!!(c^d)}},whitespaces:function(b){return function(c){c=c.nodeType===w.NodeType.TEXT_NODE&&!n.trim(c.nodeValue);return!!(b^c)}},invisible:function(b){var c=q.whitespaces();return function(g){g=c(g)||g.nodeType===w.NodeType.ELEMENT_NODE&&!g.offsetHeight;return!!(b^g)}}});var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,o=q.whitespaces(),b=q.bookmark(),c=function(c){var f=w.nodeName(c);return b(c)||o(c)||1===c.nodeType&&f in k.$inline&&
!(f in k.$empty)};y.Utils.injectDom({_4eGetBogus:function(b){b=new s(b);do b=b._4ePreviousSourceNode();while(b&&c(b[0]));return b&&(!r.ie?"br"===b.nodeName():3===b[0].nodeType&&p.test(b.text()))?b[0]:!1}});return y.Walker=q});
KISSY.add("editor/element-path",["node","./base","./dom"],function(n,h){function v(h){for(var n=t,k=t,s=[];h;){if(h[0].nodeType===q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=h);var p=h.nodeName();if(!k&&(!n&&f[p]&&(n=h),j[p])){var o;if(o=!n)if(o="div"===p){a:{o=h[0].childNodes;for(var b=0,c=o.length;b<c;b++){var e=o[b];if(e.nodeType===q.NodeType.ELEMENT_NODE&&y.$block[e.nodeName.toLowerCase()]){o=!0;break a}}o=!1}o=!o}o?n=h:k=h}s.push(h);if("body"===p)break}h=h.parent()}this.block=
n;this.blockLimit=k;this.elements=s}h("node");var u=h("./base");h("./dom");var q=n.require("dom"),y=u.XHTML_DTD,t=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={constructor:v,compare:function(f){var j=this.elements,f=f&&f.elements;if(!f||j.length!==f.length)return!1;for(var k=0;k<j.length;k++)if(!q.equals(j[k],f[k]))return!1;return!0},contains:function(f){for(var j=this.elements,
k=0;k<j.length;k++)if(j[k].nodeName()in f)return j[k];return t},toString:function(){var f=this.elements,j,k=[];for(j=0;j<f.length;j++)k.push(f[j].nodeName());return k.toString()}};return u.ElementPath=v});
KISSY.add("editor/selection",["node","./walker","./range","./base"],function(n,h){function v(b){this.document=b;this._={cache:{}};if(o)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!==b||a.parentElement&&a.parentElement().ownerDocument!==b)this.isInvalid=j}catch(d){this.isInvalid=j}}function u(b){b=new v(b);return!b||b.isInvalid?r:b}var q=h("node"),y=h("./walker"),t=h("./range"),f=h("./base");f.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};
var j=!0,r=null,w=n.UA,k=n.require("dom"),s=f.SelectionType,p=f.RangeType,o=document.selection,b={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};n.augment(v,{getNative:!o?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=k.getWindow(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!o?function(){var c=this._.cache;
if(c.type)return c.type;var a=s.SELECTION_TEXT,d=this.getNative();if(d){if(1===d.rangeCount){var d=d.getRangeAt(0),l=d.startContainer;l===d.endContainer&&l.nodeType===k.NodeType.ELEMENT_NODE&&1===Number(d.endOffset-d.startOffset)&&b[l.childNodes[d.startOffset].nodeName.toLowerCase()]&&(a=s.SELECTION_ELEMENT)}}else a=s.SELECTION_NONE;return c.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=s.SELECTION_NONE;try{var d=this.getNative(),c=d.type;"Text"===c&&(a=s.SELECTION_TEXT);"Control"===
c&&(a=s.SELECTION_ELEMENT);d.createRange().parentElement&&(a=s.SELECTION_TEXT)}catch(e){}return b.type=a},getRanges:o?function(){var b=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),g=c.childNodes,e,f=0;f<g.length;f++){var j=g[f];if(j.nodeType===k.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(j);var j=e.compareEndPoints("StartToStart",a),i=e.compareEndPoints("EndToStart",a);e.collapse();if(0<j)break;else{if(!j||1===i&&-1===j)return{container:c,offset:f};if(!i)return{container:c,
offset:f+1}}e=r}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=g[--f].nodeValue.length}catch(h){e=0}return 0===e?{container:c,offset:f}:{container:g[f],offset:-e}};return function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var c=this.getNative(),a=c&&c.createRange(),e=this.getType();if(!c)return[];if(e===s.SELECTION_TEXT)return c=new t(this.document),e=b(a,j),c.setStart(new q(e.container),
e.offset),e=b(a),c.setEnd(new q(e.container),e.offset),d.ranges=[c],[c];if(e===s.SELECTION_ELEMENT){d=d.ranges=[];for(e=0;e<a.length;e++){for(var f=a.item(e),k=f.parentNode,i=0,c=new t(this.document);i<k.childNodes.length&&k.childNodes[i]!==f;i++);c.setStart(new q(k),i);c.setEnd(new q(k),i+1);d.push(c)}return d}d.ranges=[];return[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],d=this.getNative();if(!d)return[];for(var c=0;c<d.rangeCount;c++){var e=d.getRangeAt(c),f=new t(this.document);
f.setStart(new q(e.startContainer),e.startOffset);f.setEnd(new q(e.endContainer),e.endOffset);b.push(f)}return a.ranges=b},getStartElement:function(){var b=this._.cache;if(void 0!==b.startElement)return b.startElement;var a,d=this.getNative();switch(this.getType()){case s.SELECTION_ELEMENT:return this.getSelectedElement();case s.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();j;)if(a=c.startContainer,c.startOffset===(a[0].nodeType===k.NodeType.ELEMENT_NODE?a[0].childNodes.length:
a[0].nodeValue.length)&&!a._4eIsBlockBoundary())c.setStartAfter(a);else break;a=c.startContainer;if(a[0].nodeType!==k.NodeType.ELEMENT_NODE)return a.parent();a=new q(a[0].childNodes[c.startOffset]);if(!a[0]||a[0].nodeType!==k.NodeType.ELEMENT_NODE)return c.startContainer;for(c=a[0].firstChild;c&&c.nodeType===k.NodeType.ELEMENT_NODE;)a=new q(c),c=c.firstChild;return a}if(o)c=d.createRange(),c.collapse(j),a=new q(c.parentElement());else{if((a=d.anchorNode)&&a.nodeType!==k.NodeType.ELEMENT_NODE)a=a.parentNode;
a&&(a=new q(a))}}return b.startElement=a},getSelectedElement:function(){var c,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;o&&(c=this.getNative().createRange(),c=c.item&&c.item(0));var d;if(c)d=new q(c);else{c=this.getRanges()[0];for(var e,f=2;f&&(!(d=c.getEnclosedNode())||!(d[0].nodeType===k.NodeType.ELEMENT_NODE&&b[d.nodeName()]&&(e=d)));f--)c.shrink(p.SHRINK_ELEMENT);d=e}c=d;return a.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(b){var a,d=
this.document;if(o)try{a=d.body.createControlRange(),a.addElement(b[0]),a.select()}catch(c){a=d.body.createTextRange(),a.moveToElementText(b[0]),a.select()}finally{}else a=d.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);this.reset()},selectRanges:function(b){if(o){if(1<b.length){var a=b[b.length-1];b[0].setEnd(a.endContainer,a.endOffset);b.length=1}b[0]&&b[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var d=0;d<b.length;d++){var c=
b[d],e=this.document.createRange(),f=c.startContainer;if(c.collapsed&&(w.gecko&&1.09>w.gecko||w.opera||w.webkit)&&f[0].nodeType===k.NodeType.ELEMENT_NODE&&!f[0].childNodes.length)f[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":"")),c.startOffset++,c.endOffset++;e.setStart(f[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);a.addRange(e)}}this.reset()},createBookmarks2:function(b){for(var a=[],d=this.getRanges(),c=0;c<d.length;c++)a.push(d[c].createBookmark2(b));return a},createBookmarks:function(b,
a){for(var d=[],c=this.document,e,a=a||this.getRanges(),f=a.length,i=0;i<f;i++){d.push(e=a[i].createBookmark(b,j));var h=(b=e.serializable)?n.one("#"+e.startNode,c):e.startNode;e=b?n.one("#"+e.endNode,c):e.endNode;for(var o=i+1;o<f;o++){var s=a[o],m=s.startContainer,q=s.endContainer;k.equals(m,h.parent())&&s.startOffset++;k.equals(m,e.parent())&&s.startOffset++;k.equals(q,h.parent())&&s.endOffset++;k.equals(q,e.parent())&&s.endOffset++}}return d},selectBookmarks:function(b){for(var a=[],d=0;d<b.length;d++){var c=
new t(this.document);c.moveToBookmark(b[d]);a.push(c)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4eCommonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var b=this.getNative();o?b&&b.clear():b&&b.removeAllRanges()}});var c={table:1,tbody:1,tr:1},e=y.whitespaces(j),
i=/\ufeff|\u00a0/;t.prototype.select=!o?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType===k.NodeType.ELEMENT_NODE&&!b[0].childNodes.length&&(b[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(j),a.setEnd(this.endContainer[0],this.endOffset);
else throw d;}b=u(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,d,f;if(this.startContainer[0]===this.endContainer[0]&&1===this.endOffset-this.startOffset){var h=this.startContainer[0].childNodes[this.startOffset];if(h.nodeType===k.NodeType.ELEMENT_NODE){(new v(this.document)).selectElement(new q(h));return}}(this.startContainer[0].nodeType===k.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===k.NodeType.ELEMENT_NODE&&
this.endContainer.nodeName()in c)&&this.shrink(p.SHRINK_ELEMENT,j);var n=this.createBookmark(),h=n.startNode,o;a||(o=n.endNode);n=this.document.body.createTextRange();n.moveToElementText(h[0]);n.moveStart("character",1);if(o)b=this.document.body.createTextRange(),b.moveToElementText(o[0]),n.setEndPoint("EndToEnd",b),n.moveEnd("character",-1);else{for(d=h[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(i))&&(b||!h[0].previousSibling||h[0].previousSibling&&"br"===k.nodeName(h[0].previousSibling));
f=new q(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(h);d&&k.insertBefore(this.document.createTextNode("\ufeff"),h[0]||h)}this.setStartBefore(h);h._4eRemove();if(a){if(d?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),f)this.moveToPosition(f,p.POSITION_BEFORE_START),f._4eRemove()}else this.setEndBefore(o),o._4eRemove(),n.select()};v.getSelection=u;return f.Selection=v});
KISSY.add("editor/enter-key",["node","./walker","./base","./element-path"],function(n,h){function v(k){var h;h=k.getSelection().getRanges();for(var p=h.length-1;0<p;p--)h[p].deleteContents();h=h[0];p=h.document;if(h.checkStartOfBlock()&&h.checkEndOfBlock()){var o=(new f(h.startContainer)).block;if(o&&("li"===o.nodeName()||"li"===o.parent().nodeName()))return k.hasCommand("outdent")?(k.execCommand("save"),k.execCommand("outdent"),k.execCommand("save"),!0):!1}var b=h.splitBlock("p");if(!b)return!0;
var k=b.previousBlock,o=b.nextBlock,c=b.wasStartOfBlock,e=b.wasEndOfBlock,i;if(o)i=o.parent(),"li"===i.nodeName()&&(o._4eBreakParent(i),o._4eMove(o.next(),!0));else if(k&&(i=k.parent())&&"li"===i.nodeName())k._4eBreakParent(i),h.moveToElementEditablePosition(k.next()),k._4eMove(k.prev());var g;if(!c&&!e){if("li"===o.nodeName()&&(i=o.first(y.invisible(!0)))&&n.inArray(i.nodeName(),["ul","ol"]))(j?new q(p.createTextNode("\u00a0")):new q(p.createElement("br"))).insertBefore(i);o&&h.moveToElementEditablePosition(o)}else{if(k){if("li"===
k.nodeName()||!r.test(k.nodeName()))g=k.clone()}else o&&(g=o.clone());g||(g=new q("<p>",null,p));if(i=b.elementPath)for(var b=0,a=i.elements.length;b<a;b++){var d=i.elements[b];if(d.equals(i.block)||d.equals(i.blockLimit))break;w.$removeEmpty[d.nodeName()]&&(d=d.clone(),g._4eMoveChildren(d),g.append(d))}j||g._4eAppendBogus();h.insertNode(g);if(j&&c&&(!e||!k[0].childNodes.length))h.moveToElementEditablePosition(e?k:g),h.select();h.moveToElementEditablePosition(c&&!e?o:g)}j||(o?(g=new q(p.createElement("span")),
g.html("&nbsp;"),h.insertNode(g),g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),h.deleteContents()):g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));h.select();return!0}function u(f){f.get("document").on("keydown",function(j){if(13===j.keyCode&&!j.shiftKey&&!j.ctrlKey&&!j.metaKey){f.execCommand("save");var h=f.execCommand("enterBlock");f.execCommand("save");!1!==h&&j.preventDefault()}})}var q=h("node"),y=h("./walker"),
t=h("./base"),f=h("./element-path"),j=11>n.UA.ieMode,r=/^h[1-6]$/,w=t.XHTML_DTD;return{init:function(f){f.addCommand("enterBlock",{exec:v});f.docReady(function(){u(f)})}}});
KISSY.add("editor/html-data-processor",["./base","html-parser"],function(n,h){var v=h("./base"),u=h("html-parser"),q=11>n.UA.ieMode;return{init:function(h){function t(a){var a=a.childNodes,b,d,c,e=a.length;if(e){c=1;for(b=0;b<e;b++)if(d=a[b],d.nodeType!==n.require("dom").NodeType.TEXT_NODE||d.nodeValue){c=0;break}return c?!1:void 0}return!1}function f(a){return a.replace(o,function(a,d,c){return"<"+d+c.replace(b,function(a,b){return-1===c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function j(a){return a.replace(e,
function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function r(a){return a.replace(i,function(a,b){return n.urlDecode(b)})}var w=n.Node,k=n.UA,s=new u.Filter,p=new u.Filter;(function(){function a(b){b=u.serialize(b);return new u.Comment(c+encodeURIComponent(b).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:t}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],d,c=0;c<b.length;c++)d="_keSaved_"+b[c],a.getAttribute(d)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var d=b.getAttribute("width"),b=b.getAttribute("height");d&&a.setAttribute("width",d);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:t,strong:t,em:t,del:t,u:t},attributes:{style:function(a){if(!n.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,c.length)===c)return a=n.trim(n.urlDecode(a.substr(c.length))),u.parse(a).childNodes[0]}};q&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});s.addRules(d);p.addRules(b)})();(function(){function a(b){for(var b=b.childNodes,d=b.length,c=b[d-1];c&&3===c.nodeType&&!n.trim(c.nodeValue);)c=b[--d];return c}function b(d){var c=a(d);c&&(1===c.nodeType&&"br"===c.nodeName?d.removeChild(c):
3===c.nodeType&&f.test(c.nodeValue)&&d.removeChild(c))}function d(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function c(a){b(a);d(a)&&(q||a.appendChild(new u.Tag("br")))}function e(a){b(a);d(a)&&a.appendChild(new u.Text("\u00a0"))}var f=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,g=v.XHTML_DTD,j=n.merge(g.$block,g.$listItem,g.$tableContent),h;for(h in j)"br"in g[h]||delete j[h];delete j.pre;var g={tags:{}},i={tags:{}};for(h in j)g.tags[h]=c,i.tags[h]=e;p.addRules(g);s.addRules(i)})();
s.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var o=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",e=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,i=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,g=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,a=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,
d=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;h.htmlDataProcessor={dataFilter:p,htmlFilter:s,toHtml:function(a){k.webkit&&(a=a.replace(/\u200b/g,""));var b=new u.BeautifyWriter;(new u.Parser(a)).parse().writeHtml(b,s);return a=b.getHtml()},toDataFormat:function(b,c){var c=c||p,b=j(b),b=f(b),b=b.replace(g,"$1ke:$2"),b=b.replace(d,"<ke:$1$2></ke:$1>"),e=new w("<div>");e.html("a"+b);b=e.html().substr(1);b=b.replace(a,"$1$2");b=r(b);e=new u.BasicWriter;(new u.Parser(b)).parse().writeHtml(e,c);return b=
e.getHtml()},toServer:function(a){var b=new u.MinifyWriter;(new u.Parser(a)).parse().writeHtml(b,s);return b.getHtml()}}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node"],function(n,h){function v(f){function b(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=w}return c}function c(){var b=d.selection.createRange();h&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&h.select();a.detach("mouseup",c);a.detach("mousemove",e);h=j=0}function e(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else c()}
var j,g=f.get("window")[0],a=f.get("document"),d=a[0],h;a.on("mousedown contextmenu",function(f){var k=d.documentElement;if(f.target===k&&(j&&c(),!(k.scrollHeight>k.clientHeight)&&(j=1,h=b(f.pageX,f.pageY))))a.on("mouseup",c),a.on("mousemove",e),g.focus(),h.select()})}function u(h){function b(d){if(a){var e=h.getSelection(),f=e&&e.getType(),i=e&&c.selection;if(d&&i&&f===p.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(j)},50);else{var k;if(!i||!i.type||!("Control"!==
i.type&&(k=i.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))g=i&&e.getRanges()[0],h.checkSelectionChange()}}}var c=h.get("document")[0],e=new f(c.body),i=new f(c.documentElement);if(8>n.UA.ieMode)i.on("click",function(a){"html"===(new f(a.target)).nodeName()&&h.getSelection().getNative().createRange().select()});var g,a,d=j;i.on("mousedown",function(){d=r});i.on("mouseup",function(){d=j});e.on("focusin",function(a){if("body"===(new f(a.target)).nodeName()&&
g){try{d&&g.select()}catch(b){}g=w}});e.on("focus",function(){a=j;b()});e.on("beforedeactivate",function(b){b.relatedTarget||(a=r,d=j)});e.on("mousedown",function(){a=r});e.on("mouseup",function(){a=j;setTimeout(function(){b(j)},0)});e.on("keydown",function(){a=r});e.on("keyup",function(){a=j;setTimeout(function(){b()},0)})}function q(f){f.get("document").on("mouseup keyup selectionchange",function(){f.checkSelectionChange()})}function y(h){function b(a){var b=t.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(a){return i(a)&&g(a)}var e=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,i=t.Walker.whitespaces(j),g=t.Walker.bookmark(r,j),a=function(a){return i(a)&&8!==a.nodeType};h.on("selectionChange",function(d){var g=d.path,i=h.get("document")[0],n=new f(i.body),d=(d=d.selection)&&d.getRanges()[0],q=g.blockLimit;n[0]||(i.documentElement.appendChild(i.createElement("body")),n=new f(i.body),
d&&(d.setStart(n,0),d.collapse(1)));q=q||n;if(k.gecko){var p=(i=g.block||g.blockLimit)&&i.last(c);i&&i._4eIsBlockBoundary()&&(!p||!(1===p[0].nodeType&&p._4eIsBlockBoundary()))&&"pre"!==i.nodeName()&&!i._4eGetBogus()&&i._4eAppendBogus()}if(d&&d.collapsed&&!g.block){if("body"===q.nodeName()){"html"===d.startContainer.nodeName()&&d.setStart(n,0);if((g=d.fixBlock(j,"p"))&&g[0]!==n[0].lastChild&&g.outerHtml().match(e))if((i=g.next(a,1))&&i[0].nodeType===s.NodeType.ELEMENT_NODE&&!b[i])d.moveToElementEditablePosition(i),
g._4eRemove();else if((i=g.prev(a,1))&&i[0].nodeType===s.NodeType.ELEMENT_NODE&&!b[i])d.moveToElementEditablePosition(i,i.outerHtml().match(e)?r:j),g._4eRemove();d.select();h.notifySelectionChange()}g=h.get("document")[0];d=new t.Range(g);d.moveToElementEditablePosition(n,j);"body"!==(new t.ElementPath(d.startContainer)).blockLimit.nodeName()&&(n=(new f(g.createElement("p"))).appendTo(n),k.ie||n._4eAppendBogus())}})}var t=h("./base");h("./selection");var f=h("node"),j=!0,r=!1,w=null,k=n.UA,s=n.require("dom"),
p=t.SelectionType;return{init:function(f){f.docReady(function(){if(document.selection)v(f),u(f);else if(q(f),k.ie){var b,c=f.get("document");c.on("focusout",function(){b=f.getSelection().getRanges()});c.on("focusin",function(){b&&(f.getSelection().selectRanges(b),b=null)})}});y(f)}}});
KISSY.add("editor/styles",["node","./selection","./range","./base","./element-path"],function(n,h){function v(a){return!z.attr(a,"_ke_bookmark")}function u(a,b){for(var d in a)"string"===typeof a[d]?a[d]=a[d].replace(R,function(a,d){return b[d]}):u(a[d],b)}function q(a,b){b&&(a=n.clone(a),u(a,b));var d=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"===d||Q[d]?J.STYLE_BLOCK:M[d]?J.STYLE_OBJECT:J.STYLE_INLINE;this._={definition:a}}function y(a,b){var d=b?this.removeFromRange:
this.applyToRange;a.body.focus();for(var c=new l(a),e=c.getRanges(),f=0;f<e.length;f++)d.call(this,e[f]);c.selectRanges(e)}function t(a,b,c){var e=a.element;"*"===e&&(e="span");b=new d(b.createElement(e));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var f in a)b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function f(a){var b=a.createBookmark(A),c=a.createIterator();c.enforceRealBlocks=A;c.enlargeBr=A;for(var e,f=a.document;e=c.getNextParagraph();){var g=
t(this,f,e),i=g,g="pre"===i.nodeName,h="pre"===e.nodeName,k=!g&&h;g&&!h?(h=e,k=h.html(),k=j(k,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,""),k=k.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1"),k=k.replace(/([\t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(i[0]),i.outerHtml("<pre>"+k+"</pre>"),i=new d(h.firstChild),i._4eRemove()):i.html(k)):k?i=w(r(e),i):e._4eMoveChildren(i);e[0].parentNode.replaceChild(i[0],e[0]);if(g&&(e=i,g=void 0,(g=
e._4ePreviousSourceNode(A,z.NodeType.ELEMENT_NODE))&&"pre"===g.nodeName()))i=j(g.html(),/\n$/,"")+"\n\n"+j(e.html(),/^\n/,""),N.ie?e.outerHtml("<pre>"+i+"</pre>"):e.html(i),g._4eRemove()}a.moveToBookmark(b)}function j(a,b,d){var c="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,d){b&&(c=b);d&&(e=d);return""});return c+a.replace(b,d)+e}function r(a){var b=[];j(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,
b,d){return b+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,d){b.push(d)});return b}function w(a,b){for(var d=b[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var e=a[c],e=e.replace(/(\r\n|\r)/g,"\n"),e=j(e,/^[\t]*\n/,""),e=j(e,/\n$/,""),e=j(e,/^[\t]+|[\t]+$/g,function(a,b){return 1===a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);d.appendChild(f[0])}return d}function k(a){var b=a.document;if(a.collapsed)b=t(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,f,g=L[c];g||(f=A,g=L.span);var j=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var h=a.createBookmark(),k=h.startNode,h=h.endNode,m=k,n;m&&m[0];){var l=C;if(z.equals(m,h))m=H,l=A;else{var o=m[0].nodeType,q=o===z.NodeType.ELEMENT_NODE?m.nodeName():H;if(q&&m.attr("_ke_bookmark")){m=
m._4eNextSourceNode(A);continue}if(!q||g[q]&&(m._4ePosition(h)|F.POSITION_PRECEDING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_PRECEDING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m))){var p=m.parent();if(p&&"a"===c&&p.nodeName()===c)o=t(this,b,void 0),p._4eMoveChildren(o),p[0].parentNode.replaceChild(o[0],p[0]),o._4eMergeSiblings();else if(p&&p[0]&&((L[p.nodeName()]||L.span)[c]||f)&&(!e.parentRule||e.parentRule(p))){if(!n&&(!q||!L.$removeEmpty[q]||(m._4ePosition(h)|
F.POSITION_PRECEDING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_PRECEDING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED))n=new D(b),n.setStartBefore(m);if(o===z.NodeType.TEXT_NODE||o===z.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){p=m;for(o=null;(l=!p.next(v,1))&&(o=p.parent())&&g[o.nodeName()]&&(o._4ePosition(k)|F.POSITION_FOLLOWING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_FOLLOWING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)p=
o;n.setEndAfter(p)}}else l=A}else l=A;m=m._4eNextSourceNode()}if(l&&n&&!n.collapsed){for(var l=t(this,b,void 0),p=n.getCommonAncestor(),o={},q={},r,s=null,u;l&&p&&l[0]&&p[0];){if(p.nodeName()===c){for(r in e.attributes)if(!q[r]&&(u=p.attr(s)))l.attr(r)===u?l.removeAttr(r):q[r]=1;for(s in e.styles)if(!o[s]&&(u=p.style(s)))l.style(s)===u?l.style(s,""):o[s]=1;if(!l._4eHasAttributes()){l=H;break}}p=p.parent()}l?(l[0].appendChild(n.extractContents()),i(this,l),n.insertNode(l),l._4eMergeSiblings(),N.ie||
l[0].normalize()):(l=new d(b.createElement("span")),l[0].appendChild(n.extractContents()),n.insertNode(l),i(this,l),l._4eRemove(!0));n=H}}k._4eRemove();h._4eRemove();a.moveToBookmark(j);a.shrink(G.SHRINK_TEXT)}}function s(a){a.enlarge(G.ENLARGE_ELEMENT);var e=a.createBookmark(),f=e.startNode;if(a.collapsed){for(var h=new E(f.parent()),i,j=0,k;j<h.elements.length&&(k=h.elements[j])&&!(k===h.block||k===h.blockLimit);j++)if(this.checkElementRemovable(k)){var l=a.checkBoundaryOfElement(k,G.END),n=!l&&
a.checkBoundaryOfElement(k,G.START);n||l?(i=k,i.match=n?"start":"end"):(k._4eMergeSiblings(),k.nodeName()!==this.element?(l=b(this),g(k,l[k.nodeName()]||l["*"])):c(this,k))}if(i){k=f;for(j=0;;j++){l=h.elements[j];if(l.equals(i))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(k[0]);k=l}k["start"===i.match?"insertBefore":"insertAfter"](i);h=i.html();!h||"\u200b"===h?i.remove():N.webkit&&m(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var o=e.endNode,p=this;i=function(){for(var a=
new E(f.parent()),b=new E(o.parent()),d=H,c,e=H,g=0;g<a.elements.length;g++){c=a.elements[g];if(c===a.block||c===a.blockLimit)break;p.checkElementRemovable(c)&&(d=c)}for(g=0;g<b.elements.length;g++){c=b.elements[g];if(c===b.block||c===b.blockLimit)break;p.checkElementRemovable(c)&&(e=c)}e&&o._4eBreakParent(e);d&&f._4eBreakParent(d)};i();for(h=new d(f[0].nextSibling);h[0]!==o[0];){j=h._4eNextSourceNode();if(h[0]&&h[0].nodeType===z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(h)&&(h.nodeName()===
this.element?c(this,h):(k=b(this),g(h,k[h.nodeName()]||k["*"])),j[0].nodeType===z.NodeType.ELEMENT_NODE&&j.contains(f)))i(),j=new d(f[0].nextSibling);h=j}}a.moveToBookmark(e)}function p(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,c){b[d]=c});return b}function o(a,b){var d="";b!==C?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},d=a._.definition.overrides;if(d){n.isArray(d)||(d=[d]);for(var c=0;c<d.length;c++){var e=d[c],f,g,h;"string"===typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():a.element,g=e.attributes,h=e.styles);e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var e=e.styles=e.styles||[],j;for(j in h)e.push([j.toLowerCase(),h[j]])}}}return b}function c(d,
c){var f=d._.definition,g=b(d),h=n.merge(f.attributes,(g[c.nodeName()]||g["*"]||{}).attributes),f=n.merge(f.styles,(g[c.nodeName()]||g["*"]||{}).styles),g=n.isEmptyObject(h)&&n.isEmptyObject(f),i;for(i in h)("class"===i||d._.definition.fullMatch)&&c.attr(i)!==e(i,h[i])||(g=g||!!c.hasAttr(i),c.removeAttr(i));for(var j in f)d._.definition.fullMatch&&c.style(j)!==e(j,f[j],A)||(g=g||!!c.style(j),c.style(j,""));a(c)}function e(a,b,c){var e=new d("<span>");e[c?"style":"attr"](a,b);return e[c?"style":"attr"](a)}
function i(a,e){for(var f=b(a),h=e.all(a.element),i=h.length;0<=--i;)c(a,new d(h[i]));for(var j in f)if(j!==a.element){h=e.all(j);for(i=h.length-1;0<=i;i--){var k=new d(h[i]);g(k,f[j])}}}function g(b,d){var c,e,f=d&&d.attributes;if(f)for(c=0;c<f.length;c++){var g=f[c][0];if(e=b.attr(g)){var h=f[c][1];(h===H||h.test&&h.test(e)||"string"===typeof h&&e===h)&&b[0].removeAttribute(g)}}if(f=d&&d.styles)for(c=0;c<f.length;c++)if(g=f[c][0],h=b.css(g)){var i=f[c][1];(i===H||i.test&&i.test(e)||"string"===typeof i&&
h===i)&&b.css(g,"")}a(b)}function a(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,d=a[0].lastChild;a._4eRemove(A);b&&(b.nodeType===z.NodeType.ELEMENT_NODE&&z._4eMergeSiblings(b),d&&b!==d&&d.nodeType===z.NodeType.ELEMENT_NODE&&z._4eMergeSiblings(d))}}var d=h("node"),l=h("./selection"),D=h("./range"),x=h("./base"),E=h("./element-path"),A=!0,C=!1,H=null,m=n.all,z=n.require("dom"),G=x.RangeType,F=x.PositionType,J,N=n.UA,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=x.XHTML_DTD,M=
{embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;x.StyleType=J={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};q.prototype={constructor:q,apply:function(a){y.call(this,a,C)},remove:function(a){y.call(this,a,A)},applyToRange:function(a){return(this.applyToRange=this.type===J.STYLE_INLINE?k:this.type===J.STYLE_BLOCK?f:H).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===J.STYLE_INLINE?s:H).call(this,
a)},checkElementRemovable:function(a,d){if(!a)return C;var c,e=this._.definition,f;if(a.nodeName()===this.element){if(!d&&!a._4eHasAttributes())return A;var g=e._AC;if(!g){var g={},h=0,i=e.attributes;if(i)for(var j in i)h++,g[j]=i[j];if(i=q.getStyleText(e))g.style||h++,g.style=i;g._length=h;e._AC=g}e=g;if(e._length){for(c in e)if("_length"!==c){h=a.attr(c)||"";if("style"===c)a:{g=e[c];h=o(h,C);"string"===typeof g&&(g=p(g));"string"===typeof h&&(h=p(h));i=void 0;for(i in g)if(!(i in h&&(h[i]===g[i]||
"inherit"===g[i]||"inherit"===h[i]))){g=C;break a}g=A}else g=e[c]===h;if(g){if(!d)return A}else if(d)return C}if(d)return A}else return A}c=b(this);if(c=c[a.nodeName()]||c["*"]){if(!(e=c.attributes)&&!(f=c.styles))return A;if(e)for(g=0;g<e.length;g++)if(c=e[g][0],c=a.attr(c))if(h=e[g][1],h===H||"string"===typeof h&&c===h||h.test&&h.test(c))return A;if(f)for(g=0;g<f.length;g++)if(c=a.css(f[g][0]))if(e=f[g][1],e===H||"string"===typeof e&&c===e||e.test&&e.test(c))return A}return C},checkActive:function(a){switch(this.type){case J.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,A);case J.STYLE_OBJECT:case J.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type===J.STYLE_INLINE&&(z.equals(d,a.block)||z.equals(d,a.blockLimit))))if((this.type!==J.STYLE_OBJECT||d.nodeName()in M)&&this.checkElementRemovable(d,A))return A}return C}};q.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(P,";"));for(var e in b){var f=b[e],g=(e+":"+f).replace(P,";");"inherit"===f?
d+=g:c+=g}c.length&&(c=o(c));c+=d;return a._ST=c};return x.Style=q});
KISSY.add("editor/dom-iterator",["node","./walker","./range","./base","./element-path"],function(n,h){function v(f){1>arguments.length||(this.range=f,this.forceBrBreak=r,this.enlargeBr=j,this.enforceRealBlocks=r,this._=this._||{})}var u=h("node"),q=h("./walker"),y=h("./range"),t=h("./base"),f=h("./element-path"),j=!0,r=!1,w=n.UA,k=t.RangeType,s=n.require("dom"),p=/^[\r\n\t ]*$/;n.augment(v,{getNextParagraph:function(h){var b,c,e,i,g,a;if(!this._.lastNode){e=this.range.clone();e.shrink(k.SHRINK_ELEMENT,
j);e.enlarge(this.forceBrBreak||!this.enlargeBr?k.ENLARGE_LIST_ITEM_CONTENTS:k.ENLARGE_BLOCK_CONTENTS);c=new q(e);var d=q.bookmark(j,j);c.evaluator=d;this._.nextNode=c.next();c=new q(e);c.evaluator=d;c=c.previous();this._.lastNode=c._4eNextSourceNode(j);this._.lastNode&&this._.lastNode[0].nodeType===s.NodeType.TEXT_NODE&&!n.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()&&(d=new y(e.document),d.moveToPosition(this._.lastNode,k.POSITION_AFTER_END),d.checkEndOfBlock()&&
(d=new f(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4eNextSourceNode(j)));this._.lastNode||(this._.lastNode=this._.docEndMarker=new u(e.document.createTextNode("")),s.insertAfter(this._.lastNode[0],c[0]));e=null}d=this._.nextNode;c=this._.lastNode;for(this._.nextNode=null;d;){var l=r,t=d[0].nodeType!==s.NodeType.ELEMENT_NODE,x=r;if(t)d[0].nodeType===s.NodeType.TEXT_NODE&&p.test(d[0].nodeValue)&&(t=r);else{var v=d.nodeName();if(d._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){if("br"===
v)t=j;else if(!e&&!d[0].childNodes.length&&"hr"!==v){b=d;i=d.equals(c);break}e&&(e.setEndAt(d,k.POSITION_BEFORE_START),"br"!==v&&(this._.nextNode=d));l=j}else{if(d[0].firstChild){e||(e=new y(this.range.document),e.setStartAt(d,k.POSITION_BEFORE_START));d=new u(d[0].firstChild);continue}t=j}}t&&!e&&(e=new y(this.range.document),e.setStartAt(d,k.POSITION_BEFORE_START));i=(!l||t)&&d.equals(c);if(e&&!l)for(;!d[0].nextSibling&&!i;){v=d.parent();if(v._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){l=j;i||
v.equals(c);break}d=v;t=j;i=d.equals(c);x=j}t&&e.setEndAt(d,k.POSITION_AFTER_END);d=d._4eNextSourceNode(x,null,c);if((i=!d)||l&&e)break}if(!b){if(!e)return this._.docEndMarker&&this._.docEndMarker._4eRemove(),this._.nextNode=null;b=new f(e.startContainer);d=b.blockLimit;l={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&l[d.nodeName()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())b=d;else if(!b||this.enforceRealBlocks&&"li"===b.nodeName())b=new u(this.range.document.createElement(h||
"p")),b[0].appendChild(e.extractContents()),b._4eTrim(),e.insertNode(b),g=a=j;else if("li"!==b.nodeName()){if(!e.checkStartOfBlock()||!e.checkEndOfBlock())b=b.clone(r),b[0].appendChild(e.extractContents()),b._4eTrim(),a=e.splitBlock(),g=!a.wasStartOfBlock,a=!a.wasEndOfBlock,e.insertNode(b)}else i||(this._.nextNode=b.equals(c)?null:e.getBoundaryNodes().endNode._4eNextSourceNode(j,null,c))}g&&(e=new u(b[0].previousSibling),e[0]&&e[0].nodeType===s.NodeType.ELEMENT_NODE&&("br"===e.nodeName()?e._4eRemove():
e[0].lastChild&&"br"===s.nodeName(e[0].lastChild)&&s._4eRemove(e[0].lastChild)));a&&(e=q.bookmark(r,j),g=new u(b[0].lastChild),g[0]&&g[0].nodeType===s.NodeType.ELEMENT_NODE&&"br"===g.nodeName()&&(w.ie||g.prev(e,1)||g.next(e,1))&&g.remove());this._.nextNode||(this._.nextNode=i||b.equals(c)?null:b._4eNextSourceNode(j,null,c));return b}});y.prototype.createIterator=function(){return new v(this)};return v});
KISSY.add("editor/z-index-manager",["./base"],function(n,h){var v=h("./base"),u=v.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(h){return(v.Config.baseZIndex||1E4)+h};return u});
