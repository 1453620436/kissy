/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Aug 26 16:07
*/
KISSY.add("editor","util,logger-manager,node,xtemplate/runtime,editor/iframe-content-xtpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager,ua".split(","),function(y,g,B,w){function r(a,m){var b=a.get("textarea"),e=a.get("toolBarEl"),c=a.get("statusBarEl"),m=parseInt(m,10),m=m-((e&&e.outerHeight()||0)+(c&&c.outerHeight()||0));b.parent().css(z,m);b.css(z,m)}function q(a,
m){var b=a.body;J(function(){a.designMode="on";setTimeout(function L(){a.designMode="off";b.focus();if(!L.retry)L.retry=o},50)},function(){a.designMode="off";b.setAttribute("contentEditable",false);b.setAttribute("contentEditable",true);m||q(a,1)})}function n(a){var m=a.get("textarea")[0],e=a.get("window"),c=a.get("document"),o=c[0];if(j.webkit){c.on("click",function(a){var m=f(a.target);v.inArray(m.nodeName(),["input","select"])&&a.preventDefault()});c.on("mouseup",function(a){var m=f(a.target);
v.inArray(m.nodeName(),["input","textarea"])&&a.preventDefault()})}if(j.gecko||j.ie){var d;d=f('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>').insertAfter(m);d.on("focus",function(){a.focus()});a.activateGecko=function(){j.gecko&&a.__iframeFocus&&d[0].focus()};a.on("destroy",function(){d.detach();d.remove()})}e.on("focus",function(){j.gecko&&q(o,i);a.notifySelectionChange()});if(j.gecko)c.on("mousedown",function(){a.__iframeFocus||q(o,i)});if(H){c.on("keydown",
function(m){if(m.keyCode in{8:1,46:1}){var b=a.getSelection(),e=b.getSelectedElement();if(e){a.execCommand("save");var c=b.getRanges()[0].createBookmark();e.remove();b.selectBookmarks([c]);a.execCommand("save");m.preventDefault()}}});if(o.compatMode==="CSS1Compat"){var C={33:1,34:1};c.on("keydown",function(m){m.keyCode in C&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(j.webkit)c.on("mousedown",function(m){m=f(m.target);v.inArray(m.nodeName(),["img","hr","input","textarea","select"])&&
a.getSelection().selectElement(m)});if(j.gecko)c.on("dragstart",function(a){var m=f(a.target);m.nodeName()==="img"&&/ke_/.test(m[0].className)&&a.preventDefault()});b.add(a)}function u(a,m,b,e){var c="",o;o=g.resolve("editor/assets/iframe.css");b=b.concat([]);b.unshift(o);for(o=0;o<b.length;o++)c=c+v.substitute('<link href="{href}" rel="stylesheet" />',{href:b[o]});return(new x(s)).render({doctype:j.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:c,style:"<style>"+
m+"</style>",data:e||"",script:a?'<script id="ke_active_script">'+(f(window).isCustomDomain()?'document.domain="'+document.domain+'";':"")+"parent."+E+'._initIframe("'+a+'");<\/script>':""})}function k(a,m){function b(){i=d.document;a.setInternal("document",f(i));a.setInternal("window",f(d));e.detach();i.open("text/html","replace");i.write(c);i.close()}var e=a.get("iframe"),c=u(a.get("id"),a.get("customStyle"),a.get("customLink"),m),o=e[0],d=o.contentWindow,i;e.__loaded=1;try{i=d.document}catch(C){o.src=
o.src;if(H<7){setTimeout(b,10);return}}b()}function h(a,m){var b=f(window).getEmptyIframeSrc()||"";b&&(b=' src="'+b+'" ');var b=f(v.substitute(F,{iframeSrc:b,prefixCls:a.get("prefixCls")})),e=a.get("textarea");e.hasAttr("tabindex")&&b.attr("tabindex",j.webkit?-1:e.attr("tabindex"));e.parent().prepend(b);a.set("iframe",b);a.__docReady=0;if(j.gecko&&!b.__loaded)b.on("load",function(){k(a,m)},a);else k(a,m)}function l(a){if(a.get("iframe")){var m=a.get("iframe"),b=a.get("window"),a=a.get("document"),
e=a[0],c=f(e.documentElement),e=f(e.body);v.each([a,c,e,b],function(a){a.detach()});m.remove()}}var v=g("util");g("logger-manager");var f=g("node"),x=g("xtemplate/runtime"),s=g("editor/iframe-content-xtpl"),p=g("editor/base"),d=g("editor/utils"),b=g("editor/focus-manager"),t=g("editor/clipboard"),c=g("editor/enter-key"),a=g("editor/html-data-processor"),e=g("editor/selection-fix");g("editor/styles");g("editor/dom-iterator");g("editor/z-index-manager");w.exports=p;var o=true,i=false,j=g("ua"),H=j.ieMode<
11,I=f.Dom.NodeType,z="height",J=d.tryThese,F='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',m=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;p.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};var C=v.buffer(function(){this.execCommand("save")},50),E="Editor"+ +new Date;window[E]=p;p.addMembers({initializer:function(){this.__commands={};this.__controls={};b.register(this)},renderUI:function(){t.init(this);c.init(this);
a.init(this);e.init(this)},bindUI:function(){function a(){m.detach("docReady",a);if(m.get("focused"))m.focus();else{var b=m.getSelection();b&&b.removeAllRanges()}}var m=this,b,e=m.get("prefixCls"),c=m.get("textarea");if(m.get("attachForm")&&(b=c[0].form)&&(b=f(b)))b.on("submit",m.sync,m);m.on("docReady",a);m.on("blur",function(){m.$el.removeClass(e+"editor-focused")});m.on("focus",function(){m.$el.addClass(e+"editor-focused")})},syncUI:function(){r(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},
getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,m){this.__controls[a]=m},showDialog:function(a,m){var a=a+"/dialog",b=this.__controls[a];b.show(m);this.fire("dialogShow",{dialog:b.dialog,pluginDialog:b,dialogName:a})},addCommand:function(a,m){this.__commands[a]=m},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var m=this.__commands[a],b=v.makeArray(arguments);b.shift();b.unshift(this);if(m)return m.exec.apply(m,
b)},queryCommandValue:function(a){return this.execCommand(d.getQueryCmd(a))},setData:function(a){var m,b=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(m=this.htmlDataProcessor)b=m.toDataFormat(a);l(this);h(this,b)}},getData:function(a,b){var e=this.htmlDataProcessor,c;b===void 0&&(b=this.get("mode"));c=b===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:e.toDataFormat(this.get("textarea").val());c=a?e.toHtml(c):e.toServer(c);c=v.trim(c);m.test(c)&&(c="");return c},getFormatData:function(a){return this.getData(1,
a)},getDocHtml:function(){return u(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],m="";if(a){a=a.cloneContents();m=this.get("document")[0].createElement("div");m.appendChild(a);m=m.innerHTML}return m},focus:function(){var a=this.get("window");if(a){var m=this.get("document")[0],a=a[0];j.ie||a&&a.parent&&a.parent.focus();a&&a.focus();
try{m.body.focus()}catch(b){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,m){var b=this.get("window"),e=this.get("customStyle")||"";this.set("customStyle",e+("\n"+a));b&&b.addStyleSheet(a,m)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var m=this.get("customLink"),b=this.get("document")[0];m.push(a);this.set("customLink",m);m=b.createElement("link");m.rel=
"stylesheet";b.getElementsByTagName("head")[0].appendChild(m);m.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(m){m.attr("href")===a&&m.remove()});var m=this.get("customLink"),b=v.indexOf(a,m);b!==-1&&m.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=
setTimeout(function(){var m=a.getSelection();if(m&&!m.isInvalid){var b=m.getStartElement(),e=new p.ElementPath(b);if(!a.__previousPath||!a.__previousPath.compare(e)){a.__previousPath=e;a.fire("selectionChange",{selection:m,path:e,element:b})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var m,b=a.nodeName(),e=p.XHTML_DTD,c=e.$block[b],d=p.RangeType,i=(b=this.getSelection())&&b.getRanges(),
E,j,f;if(i&&i.length!==0){this.execCommand("save");for(j=i.length-1;j>=0;j--){E=i[j];m=!j&&a||a.clone(o);E.insertNodeByDtd(m);f||(f=m)}if(f){E.moveToPosition(f,d.POSITION_AFTER_END);if(c){a=p.Walker.whitespaces(true);(a=(f=f.next(a,1))&&f[0].nodeType===I.ELEMENT_NODE&&f.nodeName())&&e.$block[a]&&e[a]["#text"]&&E.moveToElementEditablePosition(f)}b.selectRanges([E]);this.focus();m&&m[0].nodeType===1&&m.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});C.call(this);
return m}}}},insertHtml:function(a,m){var b=this,e,c=b.get("document")[0];if(b.get("mode")===1){if(e=b.htmlDataProcessor)a=e.toDataFormat(a,m);b.focus();b.execCommand("save");if(e=c.selection){e.type==="Control"&&e.clear();try{e.createRange().pasteHTML(a)}catch(o){}}else{e=b.get("iframe")[0].contentWindow.getSelection();var d=e.getRangeAt(0);d.deleteContents();var i=c.createElement("div");i.innerHTML=a;for(var c=c.createDocumentFragment(),E,j;E=i.firstChild;)j=c.appendChild(E);d.insertNode(c);if(j){d=
d.cloneRange();d.setStartAfter(j);d.collapse(true);e.removeAllRanges();e.addRange(d)}}setTimeout(function(){b.getSelection().scrollIntoView()},50);C.call(b)}},_onSetHeight:function(a){r(this,a)},_onSetMode:function(a){var m=this.get("iframe"),b=this.get("textarea");if(a===1){this.setData(b.val());b.hide();this.fire("wysiwygMode")}else{if(m){b.val(this.getFormatData(1));m.hide()}b.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,
m=this.get("textarea"),e=this.get("document");this.get("attachForm")&&(a=m[0].form)&&(a=f(a))&&a.detach("submit",this.sync,this);if(e){a=f(e[0].body);var m=f(e[0].documentElement),c=this.get("window");b.remove(this);e.detach();m.detach();a.detach();c.detach()}v.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});p.decorate=function(a,m){var m=m||{},a=f(a),b=m.textareaAttrs=m.textareaAttrs||{},e=a.style("width"),c=a.style("height"),o=a.attr("name");if(e)m.width=
m.width||e;if(c)m.height=m.height||c;if(o)b.name=o;m.data=m.data||a.val();m.elBefore=a;b=(new p(m)).render();a.remove();return b};p._initIframe=function(a){var m=b.getInstance(a),a=m.get("document"),e=a[0];a.one("#ke_active_script").remove();n(m);var c=e.body,d=f(c);if(H){c.hideFocus=o;c.disabled=o;c.contentEditable=o;c.removeAttribute("disabled")}else setTimeout(function(){j.gecko?c.contentEditable=o:j.webkit?c.parentNode.contentEditable=o:e.designMode="on"},0);if(j.gecko){var C=e.documentElement;
f(C).on("mousedown",function(a){if(a.target===C){j.gecko&&q(e,i);m.activateGecko()}})}setTimeout(function(){H&&setTimeout(function(){if(e){c.runtimeStyle.marginBottom="0px";c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){m.__docReady=1;m.fire("docReady");var a=m.get("disableObjectResizing"),b=m.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",i,!a);e.execCommand("enableInlineTableEditing",i,!b)}catch(c){d.on(H?"resizestart":"resize",function(m){var e=
f(m.target);(a||e.nodeName()==="table"&&b)&&m.preventDefault()})}},10)}});
KISSY.add("editor/iframe-content-xtpl",[],function(y,g,B,w){w.exports=function(g,q){this.pos={line:1,col:1};q.append("<!doctype html>\r\n<html>\r\n<head>");var n=g.resolve(["doctype"]);q.write(n);q.append("\r\n    <title>");n=g.resolve(["title"]);q.write(n);q.append("</title>\r\n    ");n=g.resolve(["style"]);q.write(n);q.append("\r\n    ");n=g.resolve(["links"]);q.write(n);q.append('\r\n    </head> \r\n<body class="ks-editor">\r\n');n=g.resolve(["data"]);q.write(n);q.append("\r\n");n=g.resolve(["script"]);
q.write(n);q.append("\r\n</body> \r\n</html>");return q};w.exports.TPL_NAME=w.name});
KISSY.add("editor/base",["util","ua","html-parser","component/control","./render-xtpl"],function(y,g,B,w){var r=g("util"),q=g("ua"),y=g("html-parser"),B=g("component/control"),g=g("./render-xtpl");w.exports=B.extend({beforeCreateDom:function(g){r.mix(g,{mobile:q.mobile})}},{Config:{},XHTML_DTD:y.DTD,ATTRS:{handleGestureEvents:{value:!1},focusable:{value:!1},allowTextSelection:{value:!0},contentTpl:{value:g},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},
textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(y,g,B,w){w.exports=function(g,q){var n=this.pos={line:1,col:1},u=this.root.nativeCommands,k=u.each,u=u["if"];q.append('<div class="');var h=g.resolve(["prefixCls"]);q.writeEscaped(h);q.append('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\n//johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="');h=g.resolve(["prefixCls"]);q.writeEscaped(h);q.append('editor-textarea-wrap"\r\n\r\n');var h={escape:1},l=[],
v=g.resolve(["mobile"]);l.push(v);h.params=l;h.fn=function(f,h){h.append('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n');return h};n.line=12;n.col=6;q=u.call(this,g,h,q);q.append('\r\n>\r\n\r\n<textarea class="');h=g.resolve(["prefixCls"]);q.writeEscaped(h);q.append('editor-textarea"\r\n\r\n');h={escape:1};l=[];v=g.resolve(["textareaAttrs"]);l.push(v);h.params=l;h.fn=function(f,h){h.append("\r\n");var l=f.resolve(["xindex"]);h.writeEscaped(l);h.append('="');l=f.resolve(["this"]);
h.writeEscaped(l);h.append('"\r\n');return h};n.line=19;n.col=8;q=k.call(this,g,h,q);q.append("\r\n\r\n");k={escape:1};h=[];l=g.resolve(["mode"]);h.push(l);k.params=h;k.fn=function(f,h){h.append('\r\nstyle="display:none"\r\n');return h};n.line=23;n.col=6;q=u.call(this,g,k,q);q.append("\r\n\r\n>");n=g.resolve(["data"]);q.writeEscaped(n);q.append('</textarea>\r\n\r\n</div>\r\n\r\n<div class="');n=g.resolve(["prefixCls"]);q.writeEscaped(n);q.append('editor-status">\r\n\r\n</div>\r\n');return q};w.exports.TPL_NAME=
w.name});
KISSY.add("editor/utils",["util","node","./base","dom","ua"],function(y,g,B,w){var r=g("util"),q=g("node"),y=g("./base"),n=g("dom"),u=g("ua"),k={debugUrl:function(){return""},lazyRun:function(h,l,g){var f=h[l],k=h[g];h[l]=function(){f.apply(this,arguments);h[l]=h[g];return k.apply(this,arguments)}},getXY:function(h,l){var g=h.left,f=h.top,k=l.get("window")[0],g=g-n.scrollLeft(k),f=f-n.scrollTop(k),k=l.get("iframe").offset(),g=g+k.left,f=f+k.top;return{left:g,top:f}},tryThese:function(){for(var h,l=
0,g=arguments.length;l<g;l++){var f=arguments[l];try{h=f();break}catch(k){}}return h},clearAllMarkers:function(h){for(var l in h)h[l]._4eClearMarkers(h,!0,void 0)},ltrim:function(h){return h.replace(/^\s+/,"")},rtrim:function(h){return h.replace(/\s+$/,"")},isNumber:function(h){return/^\d+(.\d+)?$/.test(r.trim(h))},verifyInputs:function(h){for(var l=0;l<h.length;l++){var g=q(h[l]),f=r.trim(k.valInput(g)),n=g.attr("data-verify"),g=g.attr("data-warning");if(n&&!RegExp(n).test(f))return alert(g),!1}return!0},
sourceDisable:function(h,l){h.on("sourceMode",l.disable,l);h.on("wysiwygMode",l.enable,l)},resetInput:function(h){var l=h.attr("placeholder");l&&u.ie?(h.addClass("ks-editor-input-tip"),h.val(l)):u.ie||h.val("")},valInput:function(h,l){if(void 0===l)return h.hasClass("ks-editor-input-tip")?"":h.val();h.removeClass("ks-editor-input-tip");h.val(l)},placeholder:function(h,l){h.attr("placeholder",l);u.ie&&(h.on("blur",function(){r.trim(h.val())||(h.addClass("ks-editor-input-tip"),h.val(l))}),h.on("focus",
function(){h.removeClass("ks-editor-input-tip");r.trim(h.val())===l&&h.val("")}))},normParams:function(h){var h=r.clone(h),l;for(l in h){var g=h[l];"function"===typeof g&&(h[l]=g())}return h},preventFocus:function(h){u.ie?h.unselectable():h.attr("onmousedown","return false;")},injectDom:function(h){r.mix(n,h);for(var g in h)(function(g){q.prototype[g]=function(){var f=[].slice.call(arguments,0);f.unshift(this[0]);return(f=h[g].apply(null,f))&&(f.nodeType||r.isWindow(f))?q(f):r.isArray(f)&&(f.__IS_NODELIST||
f[0]&&f[0].nodeType)?q(f):f}})(g)},addRes:function(){var h=this.__res=this.__res||[];h.push.apply(h,r.makeArray(arguments))},destroyRes:function(){for(var h=this.__res||[],g=0;g<h.length;g++){var k=h[g];"function"===typeof k?k():k.destroy?k.destroy():k.remove&&k.remove()}this.__res=[]},getQueryCmd:function(h){return"query"+("-"+h).replace(/-(\w)/g,function(h,g){return g.toUpperCase()})+"Value"}};y.Utils=k;w.exports=k});
KISSY.add("editor/focus-manager",["./base"],function(y,g,B,w){function r(){var f=this;f.__iframeFocus=h;k=f;u&&clearTimeout(u);u=setTimeout(function(){f.fire("focus")},30)}function q(){var f=this;f.__iframeFocus=l;k=v;u&&clearTimeout(u);u=setTimeout(function(){f.fire("blur")},30)}var y=g("./base"),n={},u,k,h=!0,l=!1,v=null,w=w.exports={currentInstance:function(){return k},getInstance:function(f){return n[f]},register:function(f){n[f.get("id")]=f},add:function(f){this.register(f);f.get("window").on("focus",
r,f).on("blur",q,f)},remove:function(f){delete n[f.get("id")];f.get("window").detach("focus",r,f).detach("blur",q,f)}};y.focusManager=w;y.getInstances=function(){return n}});
KISSY.add("editor/clipboard","util,logger-manager,./base,./range,./selection,node,ua".split(","),function(y,g,B){function w(a,b){var c=a.get("document")[0],d=f(c.body),j=false,h=function(){j=true};d.on(b,h);(x.ieMode>7?c:c.selection.createRange()).execCommand(b);d.detach(b,h);return j}function r(a){this.editor=a;this._init()}function q(a){var b=a.get("document")[0],c=a.getSelection(),d;if(c.getType()===v.SELECTION_ELEMENT&&(d=c.getSelectedElement())){var a=c.getRanges()[0],j=f(b.createTextNode(""));
j.insertBefore(d);a.setStartBefore(j);a.setEndAfter(d);c.selectRanges([a]);setTimeout(function(){if(d.parent()){j.remove();c.selectElement(d)}},0)}}function n(a){if(x.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(x.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(x.gecko){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function u(a){a=a.replace(/\s+/g,
" ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(x.webkit&&a.indexOf("<div>")>-1){if(a.match(/<div>(?:<br>)?<\/div>/)){a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"});a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")}a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"))}else if(x.gecko){x.gecko&&(a=a.replace(/^<br><br>$/,
"<br>"));a.indexOf("<br><br>")>-1&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>")}return a}function k(a){var b=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,"");if(a.indexOf("Apple-")!==-1){a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,b){return b.replace(/\t/g,Array(5).join("&nbsp;"))});if(a.indexOf('<br class="Apple-interchange-newline">')>-1){b=1;a=a.replace(/<br class="Apple-interchange-newline">/,
"")}a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1")}!b&&n(a)&&(a=u(a));return a}y=g("util");g("logger-manager");var h=g("./base"),l=g("./range"),v=g("./selection"),f=g("node"),x=g("ua"),s=x.ieMode<11,p=s?"beforepaste":"paste",d=h.RangeType,b=s?function(a,b){return w(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(c){return false}},t={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"};
y.augment(r,{_init:function(){var a=this,e=a.editor,c=e.get("document"),d=c.one("body"),j=function(a){this.type=a};j.prototype={exec:function(c){var e=this.type;c.focus();setTimeout(function(){if(s)if(e==="cut")q(c);else if(e==="paste"){a._preventPasteEvent();a._getClipboardDataFromPasteBin()}b(c,e)||alert(t[e])},0)}};d.on(p,a._getClipboardDataFromPasteBin,a);if(s){d.on("paste",a._iePaste,a);c.on("keydown",a._onKeyDown,a);c.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=
0},0)})}e.addCommand("copy",new j("copy"));e.addCommand("cut",new j("cut"));e.addCommand("paste",new j("paste"))},_onKeyDown:function(a){this.editor.get("mode")===h.Mode.WYSIWYG_MODE&&(a.ctrlKey&&a.keyCode===86||a.shiftKey&&a.keyCode===45)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,c=this.editor;if(a==="paste"){this._isPreventBeforePaste=1;try{b=c.get("document")[0].queryCommandEnabled(a)}catch(d){}this._isPreventBeforePaste=0}else b=(a=(a=c.getSelection())&&a.getRanges())&&
!(a.length===1&&a[0].collapsed);return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;if(!this._isPreventPaste){a.preventDefault();b.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,b=a.get("document")[0];if(!b.getElementById("ke-paste-bin")){var c=a.getSelection(),
i=new l(b),j=f(x.webkit?"<body></body>":"<div></div>",b);j.attr("id","ke-paste-bin");x.webkit&&j[0].appendChild(b.createTextNode("\u200b"));b.body.appendChild(j[0]);j.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});j.css("left","-1000px");var h=c.createBookmarks();i.setStartAt(j,d.POSITION_AFTER_START);i.setEndAt(j,d.POSITION_BEFORE_END);i.select(true);setTimeout(function(){var b,e=j;j=x.webkit&&(b=j.first())&&b.hasClass("Apple-style-span")?
b:j;c.selectBookmarks(h);var d=j.html();e.remove();if(d=k(d)){b=a.fire("paste",{html:d});if(b!==false){b!==void 0&&(d=b);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(d)?g("editor/plugin/word-filter",function(b){a.insertHtml(b.toDataFormat(d,a))}):a.insertHtml(d)}}},0)}}}});var c={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};B.init=function(a){var b;a.docReady(function(){b=new r(a)});var d={copy:1,cut:1,paste:1},i=["copy","cut","paste"];a.on("contextmenu",function(j){var f=j.contextmenu;if(!f.__copyFix){f.__copyFix=
1;for(j=0;j<i.length;j++)f.addChild({content:c[i[j]],value:i[j]});f.on("click",function(b){var m=b.target.get("value");if(d[m]){f.hide();setTimeout(function(){a.execCommand("save");a.execCommand(m);setTimeout(function(){a.execCommand("save")},10)},30)}})}for(var h=f.get("children"),j=h.length-1;j>=0;j--){var g=h[j],t;t=g.get?g.get("value"):g.value;if(d[t]){t=!b._stateFromNamedCommand(t);g.set?g.set("disabled",t):g.disabled=t}}})}});
KISSY.add("editor/range","./dom,./utils,./walker,./base,./element-path,util,dom,ua,node".split(","),function(y,g,B,w){function r(a){var b=a.nodeType!==c.NodeType.TEXT_NODE&&c.nodeName(a)in e.$removeEmpty,d=a.nodeType===c.NodeType.TEXT_NODE&&!x.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||d||a}function q(a){return!H(a)&&!I(a)}function n(m){var b=p;return function(e){if(I(e))return s;if(e.nodeType===c.NodeType.TEXT_NODE){if(x.trim(e.nodeValue).length)return p}else if(e.nodeType===
c.NodeType.ELEMENT_NODE){e=c.nodeName(e);if(!F[e])if(!m&&!a.ie&&e==="br"&&!b)b=s;else return p}return s}}function u(a,b){var e=a.startContainer,d=a.endContainer,j=a.startOffset,f=a.endOffset,h,g=p,t=p,l,k=a.document,P;b>0&&(l=k.createDocumentFragment());if(a.collapsed)return l;a.optimizeBookmark();if(d[0].nodeType===c.NodeType.TEXT_NODE){t=s;d=d._4eSplitText(f)}else if(d[0].childNodes.length>0)if(f>=d[0].childNodes.length){d=o(d[0].appendChild(k.createTextNode("")));P=s}else d=o(d[0].childNodes[f]);
if(e[0].nodeType===c.NodeType.TEXT_NODE){g=s;e._4eSplitText(j)}else if(j)if(j>=e[0].childNodes.length){e=o(e[0].appendChild(k.createTextNode("")));h=s}else e=o(e[0].childNodes[j].previousSibling);else{h=o(k.createTextNode(""));e.prepend(h);e=h;h=s}var n=e._4eParents(),N=d._4eParents();n.each(function(a,b){n[b]=a});N.each(function(a,b){N[b]=a});for(var G,I,k=0;k<n.length;k++){G=n[k];I=N[k];if(!G.equals(I))break}for(var j=l,A,M,H=k;H<n.length;H++){A=n[H];f=b>0&&!A.equals(e)?j.appendChild(A.clone()[0]):
null;A=A[0].nextSibling;M=N[H];for(var z=d[0],q=M&&M[0];A;){if(q===A||z===A)break;M=A.nextSibling;if(b===2)j.appendChild(A.cloneNode(s));else{if(i[A.nodeName.toLowerCase()]){var v=A.cloneNode(s);A.innerHTML="";A=v}else c._4eRemove(A);b===1&&j.appendChild(A)}A=M}f&&(j=f)}for(j=l;k<N.length;k++){A=N[k];f=b>0&&!A.equals(d)?j.appendChild(A.clone()[0]):null;if(!n[k]||!A._4eSameLevel(n[k]))for(A=A[0].previousSibling;A;){M=A.previousSibling;if(b===2)j.insertBefore(A.cloneNode(s),j.firstChild);else{c._4eRemove(A);
b===1&&j.insertBefore(A,j.firstChild)}A=M}f&&(j=f)}if(b===2){if(g){G=e[0];if(G.nodeType===c.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType===c.NodeType.TEXT_NODE){G.data=G.data+G.nextSibling.data;G.parentNode.removeChild(G.nextSibling)}}if(t){t=d[0];if(t.nodeType===c.NodeType.TEXT_NODE&&t.previousSibling&&t.previousSibling.nodeType===c.NodeType.TEXT_NODE){t.previousSibling.data=t.previousSibling.data+t.data;t.parentNode.removeChild(t)}}}else{if(G&&I&&(!e._4eSameLevel(G)||!d._4eSameLevel(I))){t=
G._4eIndex();h&&G._4eSameLevel(e)&&t--;a.setStart(G.parent(),t+1)}a.collapse(s)}h&&e.remove();P&&d.remove();return l}function k(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function h(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=d;this.collapsed=s;this.document=a}g("./dom");var y=g("./utils"),l=g("./walker"),v=g("./base"),f=g("./element-path"),x=g("util");v.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var s=true,p=false,d=null,b=v.RangeType,t=v.PositionType,c=g("dom"),a=g("ua"),e=v.XHTML_DTD,o=g("node"),i={td:1},j={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},H=new l.whitespaces,I=new l.bookmark,z=l.whitespaces(s),J=l.bookmark(false,true),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.augment(h,{toString:function(){var a=[],b=this.startContainer[0],e=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((e.id||e.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!==c.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
b=this.endOffset;a[0].nodeType!==c.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);b&&b.nodeName()==="span"&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){if(a[0].nodeType===c.NodeType.ELEMENT_NODE&&j[a.nodeName()]){a=a.parent();b=a._4eIndex()}this.startContainer=a;this.startOffset=b;if(!this.endContainer){this.endContainer=a;this.endOffset=b}k(this)},setEnd:function(a,b){if(a[0].nodeType===c.NodeType.ELEMENT_NODE&&j[a.nodeName()]){a=a.parent();b=a._4eIndex()+1}this.endContainer=a;this.endOffset=b;if(!this.startContainer){this.startContainer=
a;this.startOffset=b}k(this)},setStartAt:function(a,e){switch(e){case b.POSITION_AFTER_START:this.setStart(a,0);break;case b.POSITION_BEFORE_END:a[0].nodeType===c.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case b.POSITION_BEFORE_START:this.setStartBefore(a);break;case b.POSITION_AFTER_END:this.setStartAfter(a)}k(this)},setEndAt:function(a,e){switch(e){case b.POSITION_AFTER_START:this.setEnd(a,0);break;case b.POSITION_BEFORE_END:a[0].nodeType===
c.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case b.POSITION_BEFORE_START:this.setEndBefore(a);break;case b.POSITION_AFTER_END:this.setEndAfter(a)}k(this)},cloneContents:function(){return u(this,2)},deleteContents:function(){return u(this,0)},extractContents:function(){return u(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=s},clone:function(){var a=new h(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==c.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==c.NodeType.ELEMENT_NODE)return d;var b=new l(a);b.evaluator=function(a){return z(a)&&J(a)};a=b.next();b.reset();
b=b.previous();return a&&a.equals(b)?a:d},shrink:function(a,e){if(!this.collapsed){var a=a||b.SHRINK_TEXT,d=this.clone(),o=this.startContainer,i=this.endContainer,j=this.startOffset,f=this.endOffset,h=s,t,g,k=s;if(o&&o[0].nodeType===c.NodeType.TEXT_NODE)if(j)if(j>=o[0].nodeValue.length)d.setStartAfter(o);else{d.setStartBefore(o);h=p}else d.setStartBefore(o);if(i&&i[0].nodeType===c.NodeType.TEXT_NODE)if(f)if(f>=i[0].nodeValue.length)d.setEndAfter(i);else{d.setEndAfter(i);k=p}else d.setEndBefore(i);
if(h||k){g=new l(d);g.evaluator=function(e){return e.nodeType===(a===b.SHRINK_ELEMENT?c.NodeType.ELEMENT_NODE:c.NodeType.TEXT_NODE)};g.guard=function(e,d){if(a===b.SHRINK_ELEMENT&&e.nodeType===c.NodeType.TEXT_NODE||d&&e===t)return p;!d&&e.nodeType===c.NodeType.ELEMENT_NODE&&(t=e);return s}}if(h)(d=g[a===b.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,e?b.POSITION_AFTER_START:b.POSITION_BEFORE_START);if(k){g.reset();(g=g[a===b.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(g,
e?b.POSITION_BEFORE_END:b.POSITION_AFTER_END)}return h||k}},createBookmark2:function(a){var b=this.startContainer,e=this.endContainer,i=this.startOffset,j=this.endOffset,f,h;if(!b||!e)return{start:0,end:0};if(a){if(b[0].nodeType===c.NodeType.ELEMENT_NODE)if((f=o(b[0].childNodes[i]))&&f[0]&&f[0].nodeType===c.NodeType.TEXT_NODE&&i>0&&f[0].previousSibling.nodeType===c.NodeType.TEXT_NODE){b=f;i=0}for(;b[0].nodeType===c.NodeType.TEXT_NODE&&(h=b.prev(void 0,1))&&h[0].nodeType===c.NodeType.TEXT_NODE;){b=
h;i=i+h[0].nodeValue.length}if(!this.collapsed){if(e[0].nodeType===c.NodeType.ELEMENT_NODE)if((f=o(e[0].childNodes[j]))&&f[0]&&f[0].nodeType===c.NodeType.TEXT_NODE&&j>0&&f[0].previousSibling.nodeType===c.NodeType.TEXT_NODE){e=f;j=0}for(;e[0].nodeType===c.NodeType.TEXT_NODE&&(h=e.prev(void 0,1))&&h[0].nodeType===c.NodeType.TEXT_NODE;){e=h;j=j+h[0].nodeValue.length}}}return{start:b._4eAddress(a),end:this.collapsed?d:e._4eAddress(a),startOffset:i,endOffset:j,normalized:a,is2:s}},createBookmark:function(a){var e,
c,i,j,f=this.collapsed;e=o("<span>",d,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");if(a){i=x.guid("ke_bm_");e.attr("id",i+"S")}if(!f){c=e.clone();c.html("&nbsp;");a&&c.attr("id",i+"E");j=this.clone();j.collapse();j.insertNode(c)}j=this.clone();j.collapse(s);j.insertNode(e);if(c){this.setStartAfter(e);this.setEndBefore(c)}else this.moveToPosition(e,b.POSITION_AFTER_END);return{startNode:a?i+"S":e,endNode:a?i+"E":c,serializable:a,collapsed:f}},moveToPosition:function(a,
b){this.setStartAt(a,b);this.collapse(s)},trim:function(a,b){var e=this.startContainer,d=this.startOffset,i=this.collapsed;if((!a||i)&&e[0]&&e[0].nodeType===c.NodeType.TEXT_NODE){if(d)if(d>=e[0].nodeValue.length){d=e._4eIndex()+1;e=e.parent()}else{var o=e._4eSplitText(d),d=e._4eIndex()+1,e=e.parent();if(c.equals(this.startContainer,this.endContainer))this.setEnd(o,this.endOffset-this.startOffset);else if(c.equals(e,this.endContainer))this.endOffset=this.endOffset+1}else{d=e._4eIndex();e=e.parent()}this.setStart(e,
d);if(i){this.collapse(s);return}}e=this.endContainer;d=this.endOffset;if(!b&&!i&&e[0]&&e[0].nodeType===c.NodeType.TEXT_NODE){if(d){d>=e[0].nodeValue.length||e._4eSplitText(d);d=e._4eIndex()+1}else d=e._4eIndex();e=e.parent();this.setEnd(e,d)}},insertNode:function(a){this.optimizeBookmark();this.trim(p,s);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=o(this.document);
if(a.is2){var e=b._4eGetByAddress(a.start,a.normalized),c=a.startOffset,b=a.end&&b._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(e,c);b?this.setEnd(b,a):this.collapse(s)}else{e=(c=a.serializable)?o("#"+a.startNode,b):a.startNode;a=c?o("#"+a.endNode,b):a.endNode;this.setStartBefore(e);e._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(s)}},getCommonAncestor:function(a,b){var e=this.startContainer,d=this.endContainer,e=e[0]===d[0]?a&&e[0].nodeType===c.NodeType.ELEMENT_NODE&&
this.startOffset===this.endOffset-1?o(e[0].childNodes[this.startOffset]):e:e._4eCommonAncestor(d);return b&&e[0].nodeType===c.NodeType.TEXT_NODE?e.parent():e},enlarge:function(){function a(b,e,d,m){var i=b[e?"startContainer":"endContainer"],j,f=e?0:1,h=0,g=e?"previousSibling":"nextSibling";j=b[e?"startOffset":"endOffset"];if(i[0].nodeType===c.NodeType.TEXT_NODE){if(e){if(j)return}else if(j<i[0].nodeValue.length)return;j=i[0][g];i=i[0].parentNode}else{j=i[0].childNodes[j+(e?-1:1)]||null;i=i[0]}for(;i;){for(;j;)if(H(j)||
I(j))j=j[g];else break;if(j){if(!h)b[e?"setStartAfter":"setEndBefore"](o(j));break}i=o(i);if(i.nodeName()==="body")break;if(h||i.equals(m)){d[f]=i;h=1}else b[e?"setStartBefore":"setEndAfter"](i);j=i[0][g];i=i[0].parentNode}}return function(e){var i;switch(e){case b.ENLARGE_ELEMENT:if(this.collapsed)break;var e=this.getCommonAncestor(),j=[];a(this,1,j,e);a(this,0,j,e);if(j[0]&&j[1]){e=j[0].contains(j[1])?j[1]:j[0];this.setStartBefore(e);this.setEndAfter(e)}break;case b.ENLARGE_BLOCK_CONTENTS:case b.ENLARGE_LIST_ITEM_CONTENTS:i=
new h(this.document);j=o(this.document.body);i.setStartAt(j,b.POSITION_AFTER_START);i.setEnd(this.startContainer,this.startOffset);i=new l(i);var f,g,t=l.blockBoundary(e===b.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:d),k=function(a){var b=t(a);b||(f=o(a));return b},p=function(a){var b=k(a);!b&&c.nodeName(a)==="br"&&(g=o(a));return b};i.guard=k;i=i.lastBackward();f=f||j;this.setStartAt(f,f.nodeName()!=="br"&&(!i&&this.checkStartOfBlock()||i&&f.contains(i))?b.POSITION_AFTER_START:b.POSITION_AFTER_END);i=this.clone();
i.collapse();i.setEndAt(j,b.POSITION_BEFORE_END);i=new l(i);i.guard=e===b.ENLARGE_LIST_ITEM_CONTENTS?p:k;f=d;i=i.lastForward();f=f||j;this.setEndAt(f,!i&&this.checkEndOfBlock()||i&&f.contains(i)?b.POSITION_BEFORE_END:b.POSITION_BEFORE_START);g&&this.setEndAfter(g)}}}(),checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType===c.NodeType.TEXT_NODE&&x.trim(a[0].nodeValue.substring(0,e)).length)return p;this.trim();a=new f(this.startContainer);e=this.clone();e.collapse(s);
e.setStartAt(a.block||a.blockLimit,b.POSITION_AFTER_START);a=new l(e);a.evaluator=n(s);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,e=this.endOffset;if(a[0].nodeType===c.NodeType.TEXT_NODE&&x.trim(a[0].nodeValue.substring(e)).length)return p;this.trim();a=new f(this.endContainer);e=this.clone();e.collapse(p);e.setEndAt(a.block||a.blockLimit,b.POSITION_BEFORE_END);a=new l(e);a.evaluator=n(p);return a.checkForward()},checkBoundaryOfElement:function(a,e){var c=this.clone();
c[e===b.START?"setStartAt":"setEndAt"](a,e===b.START?b.POSITION_AFTER_START:b.POSITION_BEFORE_END);c=new l(c);c.evaluator=r;return c[e===b.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,e=this.startOffset,d=this.endOffset,i;if(a[0].nodeType===c.NodeType.ELEMENT_NODE){i=a[0].childNodes.length;if(i>e)a=o(a[0].childNodes[e]);else if(i===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=o(a);a=a._4eNextSourceNode()||
a}}if(b[0].nodeType===c.NodeType.ELEMENT_NODE){i=b[0].childNodes.length;if(i>d)b=o(b[0].childNodes[d])._4ePreviousSourceNode(s);else if(i===0)b=b._4ePreviousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=o(b)}}a._4ePosition(b)&t.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(e,c){var d=this.createBookmark(),i=o(this.document.createElement(c));this.collapse(e);this.enlarge(b.ENLARGE_BLOCK_CONTENTS);i[0].appendChild(this.extractContents());i._4eTrim();a.ie||i._4eAppendBogus();
this.insertNode(i);this.moveToBookmark(d);return i},splitBlock:function(e){var c=new f(this.startContainer),i=new f(this.endContainer),j=c.block,o=i.block,h=d;if(!c.blockLimit.equals(i.blockLimit))return d;if(e!=="br"){if(!j){j=this.fixBlock(s,e);o=(new f(this.endContainer)).block}o||(o=this.fixBlock(p,e))}e=j&&this.checkStartOfBlock();c=o&&this.checkEndOfBlock();this.deleteContents();if(j&&j[0]===o[0])if(c){h=new f(this.startContainer);this.moveToPosition(o,b.POSITION_AFTER_END);o=d}else if(e){h=
new f(this.startContainer);this.moveToPosition(j,b.POSITION_BEFORE_START);j=d}else{o=this.splitElement(j);!a.ie&&!x.inArray(j.nodeName(),["ul","ol"])&&j._4eAppendBogus()}return{previousBlock:j,nextBlock:o,wasStartOfBlock:e,wasEndOfBlock:c,elementPath:h}},splitElement:function(a){if(!this.collapsed)return d;this.setEndAt(a,b.POSITION_BEFORE_END);var e=this.extractContents(),c=a.clone(p);c[0].appendChild(e);c.insertAfter(a);this.moveToPosition(a,b.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,
e){for(var d=0;a;){if(a[0].nodeType===c.NodeType.TEXT_NODE){this.moveToPosition(a,e?b.POSITION_AFTER_END:b.POSITION_BEFORE_START);d=1;break}if(a[0].nodeType===c.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,e?b.POSITION_BEFORE_END:b.POSITION_AFTER_START);d=1}var i=a,j=d,o=void 0;i[0].nodeType===c.NodeType.ELEMENT_NODE&&i._4eIsEditable()&&(o=i[e?"last":"first"](q,1));!j&&!o&&(o=i[e?"prev":"next"](q,1));a=o}return!!d},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,
b.nodeType===c.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,c,d,i=a.nodeName();b=e.$block[i];this.deleteContents();if(b){for(b=this.getCommonAncestor(p,s);(c=e[b.nodeName()])&&(!c||!c[i]);){var j=b.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(b);this.collapse(s);b.remove()}else d=b;b=j}d&&this.splitElement(d)}this.insertNode(a)}});y.injectDom({_4eBreakParent:function(a,b){var b=o(b),a=o(a),e,c=new v.Range(a[0].ownerDocument);
c.setStartAfter(a);c.setEndAfter(b);e=c.extractContents();c.insertNode(a.remove());a.after(e)}});v.Range=h;w.exports=h});
KISSY.add("editor/dom","util,node,./base,./utils,dom,ua".split(","),function(y,g){function B(d,b){var f=d[b?"next":"prev"](void 0,1);if(f&&f[0].nodeType===h.ELEMENT_NODE){for(var c=[];f.attr("_ke_bookmark")||f._4eIsEmptyInlineRemovable(void 0);){c.push(f);f=b?f.next(void 0,1):f.prev(void 0,1);if(!f)return}if(d._4eIsIdentical(f,void 0)){for(var a=r(b?d[0].lastChild:d[0].firstChild);c.length;)c.shift()._4eMove(d,!b,void 0);f._4eMoveChildren(d,!b,void 0);f.remove();a[0]&&a[0].nodeType===h.ELEMENT_NODE&&
a._4eMergeSiblings()}}}var w=g("util"),r=g("node"),q=g("./base"),n=g("./utils"),u=q.XHTML_DTD,k=g("dom"),h=k.NodeType,l=g("ua"),v={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var f=q.PositionType,x={block:1,"list-item":1,
table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},s={hr:1},p=function(d){return d&&(d[0]||d)};n.injectDom({_4eSameLevel:function(d,b){var b=p(b),f=d.parentNode;return f&&f===b.parentNode},_4eIsBlockBoundary:function(d,b){var f=w.merge(s,b);return!(!x[k.css(d,"display")]&&!f[k.nodeName(d)])},_4eIndex:function(d,b){for(var f=d.parentNode.childNodes,c,a=-1,e=0;e<f.length;e++){c=f[e];if(!b||
!(c.nodeType===3&&c.previousSibling&&c.previousSibling.nodeType===3)){a++;if(c===d)return a}}return-1},_4eMove:function(d,b,f){b=p(b);f?b.insertBefore(d,b.firstChild):b.appendChild(d)},_4eIsIdentical:function(d,b){if(!b)return false;b=p(b);if(k.nodeName(d)!==k.nodeName(b))return false;var f=d.attributes,c,a,e=b.attributes,o=f.length,i=e.length;if(o!==i)return false;for(var j=0;j<o;j++){c=f[j];a=c.name;if(c.specified&&k.attr(d,a)!==k.attr(b,a))return false}if(l.ieMode<8)for(j=0;j<i;j++){c=e[j];a=c.name;
if(c.specified&&k.attr(d,a)!==k.attr(b,a))return false}return true},_4eIsEmptyInlineRemovable:function(d){if(!u.$removeEmpty[k.nodeName(d)])return false;for(var d=d.childNodes,b=0,f=d.length;b<f;b++){var c=d[b],a=c.nodeType;if(!(a===h.ELEMENT_NODE&&c.getAttribute("_ke_bookmark"))&&(a===h.ELEMENT_NODE&&!k._4eIsEmptyInlineRemovable(c)||a===k.NodeType.TEXT_NODE&&w.trim(c.nodeValue)))return false}return true},_4eMoveChildren:function(d,b,f){b=p(b);if(d!==b)if(f)for(;f=d.lastChild;)b.insertBefore(d.removeChild(f),
b.firstChild);else for(;f=d.firstChild;)b.appendChild(d.removeChild(f))},_4eMergeSiblings:function(d){d=r(d);if(v[d.nodeName()]){B(d,true);B(d)}},_4eSplitText:function(d,b){var f=d.ownerDocument;if(d.nodeType===k.NodeType.TEXT_NODE){if(l.ie&&b===d.nodeValue.length){var c=f.createTextNode("");k.insertAfter(c,d);return c}c=d.splitText(b);if(f.documentMode){f=f.createTextNode("");k.insertAfter(f,c);k.remove(f)}return c}},_4eParents:function(d,b){var f=[];f.__IS_NODELIST=1;do f[b?"push":"unshift"](d);
while(d=d.parentNode);return f},_4eNextSourceNode:function(d,b,f,c){if(c&&!c.call)var a=p(c),c=function(b){return b!==a};var b=!b&&d.firstChild,e=d;if(!b){if(d.nodeType===h.ELEMENT_NODE&&c&&c(d,true)===false)return null;b=d.nextSibling}for(;!b&&(e=e.parentNode);){if(c&&c(e,true)===false)return null;b=e.nextSibling}return!b||c&&c(b)===false?null:f&&f!==b.nodeType?k._4eNextSourceNode(b,false,f,c):b},_4ePreviousSourceNode:function(d,b,f,c){if(c&&!c.call)var a=p(c),c=function(b){return b!==a};var b=!b&&
d.lastChild,e=d;if(!b){if(d.nodeType===h.ELEMENT_NODE&&c&&c(d,true)===false)return null;b=d.previousSibling}for(;!b&&(e=e.parentNode);){if(c&&c(e,true)===false)return null;b=e.previousSibling}return!b||c&&c(b)===false?null:f&&b.nodeType!==f?k._4ePreviousSourceNode(b,false,f,c):b},_4eCommonAncestor:function(d,b){b=p(b);if(d===b)return d;if(k.contains(b,d))return b;var f=d;do if(k.contains(f,b))return f;while(f=f.parentNode);return null},_4eHasAttributes:l.ieMode<9?function(d){for(var b=d.attributes,
f=0;f<b.length;f++){var c=b[f];switch(c.name){case "class":if(d.getAttribute("class"))return true;break;default:if(c.specified)return true}}return false}:function(d){l.gecko&&d.removeAttribute("_moz_dirty");return d.hasAttributes()},_4ePosition:function(d,b){var g=p(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(g);if(d===g)return f.POSITION_IDENTICAL;if(d.nodeType===h.ELEMENT_NODE&&g.nodeType===h.ELEMENT_NODE){if(k.contains(d,g))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(k.contains(g,
d))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING;if("sourceIndex"in d)return d.sourceIndex<0||g.sourceIndex<0?f.POSITION_DISCONNECTED:d.sourceIndex<g.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}for(var c=k._4eAddress(d),g=k._4eAddress(g),a=Math.min(c.length,g.length),e=0;e<=a-1;e++)if(c[e]!==g[e])return c[e]<g[e]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;return c.length<g.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4eAddress:function(d,
b){for(var f=[],c=d.ownerDocument.documentElement,a=d;a&&a!==c;){f.unshift(k._4eIndex(a,b));a=a.parentNode}return f},_4eRemove:function(d,b){var f=d.parentNode;if(f){if(b)for(var c;c=d.firstChild;)f.insertBefore(d.removeChild(c),d);f.removeChild(d)}return d},_4eTrim:function(d){k._4eLtrim(d);k._4eRtrim(d)},_4eLtrim:function(d){for(var b;b=d.firstChild;){if(b.nodeType===k.NodeType.TEXT_NODE){var f=n.ltrim(b.nodeValue),c=b.nodeValue.length;if(f){if(f.length<c){k._4eSplitText(b,c-f.length);d.removeChild(d.firstChild)}}else{d.removeChild(b);
continue}}break}},_4eRtrim:function(d){for(var b;b=d.lastChild;){if(b.type===k.NodeType.TEXT_NODE){var f=n.rtrim(b.nodeValue),c=b.nodeValue.length;if(f){if(f.length<c){k._4eSplitText(b,f.length);d.removeChild(d.lastChild)}}else{d.removeChild(b);continue}}break}if(!l.ie)(b=d.lastChild)&&b.nodeType===1&&k.nodeName(b)==="br"&&d.removeChild(b)},_4eAppendBogus:function(d){for(var b=d.lastChild;b&&b.nodeType===k.NodeType.TEXT_NODE&&!w.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType===k.NodeType.TEXT_NODE||
k.nodeName(b)!=="br"){b=d.ownerDocument.createElement("br");d.appendChild(b)}},_4eSetMarker:function(d,b,f,c){var d=r(d),a=d.data("list_marker_id")||d.data("list_marker_id",w.guid()).data("list_marker_id"),e=d.data("list_marker_names")||d.data("list_marker_names",{}).data("list_marker_names");b[a]=d;e[f]=1;return d.data(f,c)},_4eClearMarkers:function(d,b,f){var d=r(d),c=d.data("list_marker_names"),a=d.data("list_marker_id"),e;for(e in c)d.removeData(e);d.removeData("list_marker_names");if(f){d.removeData("list_marker_id");
delete b[a]}},_4eCopyAttributes:function(d,b,f){for(var b=r(b),c=d.attributes,f=f||{},a=0;a<c.length;a++){var e=c[a],o=e.name.toLowerCase(),i;if(!(o in f))if(o==="checked"&&(i=k.attr(d,o)))b.attr(o,i);else if(e.specified||l.ie&&e.value&&o==="value"){i=k.attr(d,o);if(i===null)i=e.nodeValue;b.attr(o,i)}}if(d.style.cssText!=="")b[0].style.cssText=d.style.cssText},_4eIsEditable:function(d){d=k.nodeName(d);return(d=!u.$nonEditable[d]&&(u[d]||u.span))&&d["#text"]},_4eGetByAddress:function(d,b,f){for(var d=
d.documentElement,c=0;d&&c<b.length;c++){var a=b[c];if(f)for(var e=-1,o=0;o<d.childNodes.length;o++){var i=d.childNodes[o];if(!(f===true&&i.nodeType===3&&i.previousSibling&&i.previousSibling.nodeType===3)){e++;if(e===a){d=i;break}}}else d=d.childNodes[a]}return d}})});
KISSY.add("editor/walker",["./base","util","ua","dom","node"],function(y,g,B,w){function r(b,a){if(this._.end)return l;var e,d=this.range,i,j=this.guard,g=this.type,p=b?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,d.trim(),d.collapsed))return this.end(),l;if(!b&&!this._.guardLTR){var n=d.endContainer[0],q=n.childNodes[d.endOffset];this._.guardLTR=function(a,b){return b&&(n===a||"body"===f.nodeName(a))?!1:a!==q}}if(b&&!this._.guardRTL){var t=d.startContainer[0],m=0<
d.startOffset&&t.childNodes[d.startOffset-1]||null;this._.guardRTL=function(a,b){return b&&(t===a||"body"===f.nodeName(a))?!1:a!==m}}var v=b?this._.guardRTL:this._.guardLTR;i=j?function(a,b){return v(a,b)===h?h:j(a,b)}:v;this.current?e=this.current[p](h,g,i):b?(e=d.endContainer,0<d.endOffset?(e=s(e[0].childNodes[d.endOffset-1]),i(e[0])===h&&(e=l)):e=i(e,k)===h?l:e._4ePreviousSourceNode(k,g,i,void 0)):(e=d.startContainer,e=s(e[0].childNodes[d.startOffset]),e.length?i(e[0])===h&&(e=l):e=i(d.startContainer,
k)===h?l:d.startContainer._4eNextSourceNode(k,g,i,void 0));for(;e&&!this._.end;){this.current=e;if(!this.evaluator||this.evaluator(e[0])!==h){if(!a)return e}else if(a&&this.evaluator)return h;e=e[p](h,g,i)}this.end();return this.current=l}function q(b){for(var a,e=l;a=r.call(this,b);)e=a;return e}function n(b){this.range=b;this.guard=this.evaluator=l;this._={}}var y=g("./base"),u=g("util"),k=!0,h=!1,l=null,v=g("ua"),f=g("dom"),x=y.XHTML_DTD,s=g("node");u.augment(n,{end:function(){this._.end=1},next:function(){return r.call(this)},
previous:function(){return r.call(this,k)},checkForward:function(){return r.call(this,h,k)!==h},checkBackward:function(){return r.call(this,k,k)!==h},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,k)},reset:function(){delete this.current;this._={}},_iterator:r});u.mix(n,{blockBoundary:function(b){return function(a){return!(a.nodeType===f.NodeType.ELEMENT_NODE&&f._4eIsBlockBoundary(a,b))}},bookmark:function(b,a){function e(a){return"span"===f.nodeName(a)&&f.attr(a,
"_ke_bookmark")}return function(d){var i,j;i=d.nodeType===f.NodeType.TEXT_NODE&&(j=d.parentNode)&&e(j);i=b?i:i||e(d);return!!(a^i)}},whitespaces:function(b){return function(a){a=a.nodeType===f.NodeType.TEXT_NODE&&!u.trim(a.nodeValue);return!!(b^a)}},invisible:function(b){var a=n.whitespaces();return function(e){e=a(e)||e.nodeType===f.NodeType.ELEMENT_NODE&&!e.offsetHeight;return!!(b^e)}}});var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,d=n.whitespaces(),b=n.bookmark(),t=function(c){var a=f.nodeName(c);return b(c)||
d(c)||1===c.nodeType&&a in x.$inline&&!(a in x.$empty)};y.Utils.injectDom({_4eGetBogus:function(b){b=s(b);do b=b._4ePreviousSourceNode();while(b&&t(b[0]));return b&&(!v.ie?"br"===b.nodeName():3===b[0].nodeType&&p.test(b.text()))?b[0]:!1}});y.Walker=n;w.exports=n});
KISSY.add("editor/element-path",["./base","./dom","dom"],function(y,g,B,w){function r(g){for(var v=u,f=u,r=[];g;){if(g[0].nodeType===q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=g);var s=g.nodeName();if(!f&&(!v&&k[s]&&(v=g),h[s])){var p;if(p=!v)if(p="div"===s){a:{p=g[0].childNodes;for(var d=0,b=p.length;d<b;d++){var t=p[d];if(t.nodeType===q.NodeType.ELEMENT_NODE&&n.$block[t.nodeName.toLowerCase()]){p=!0;break a}}p=!1}p=!p}p?v=g:f=g}r.push(g);if("body"===s)break}g=g.parent()}this.block=
v;this.blockLimit=f;this.elements=r}y=g("./base");g("./dom");var q=g("dom"),n=y.XHTML_DTD,u=null,k={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};r.prototype={constructor:r,compare:function(g){var h=this.elements,g=g&&g.elements;if(!g||h.length!==g.length)return!1;for(var f=0;f<h.length;f++)if(!q.equals(h[f],g[f]))return!1;return!0},contains:function(g){for(var h=this.elements,f=0;f<h.length;f++)if(h[f].nodeName()in
g)return h[f];return u},toString:function(){var g=this.elements,h,f=[];for(h=0;h<g.length;h++)f.push(g[h].nodeName());return f.toString()}};y.ElementPath=r;w.exports=r});
KISSY.add("editor/selection","util,node,./walker,./range,./base,ua,dom".split(","),function(y,g,B,w){function r(a){this.document=a;this._={cache:{}};if(p)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!==a||b.parentElement&&b.parentElement().ownerDocument!==a)this.isInvalid=h}catch(d){this.isInvalid=h}}function q(a){a=new r(a);return!a||a.isInvalid?l:a}var y=g("util"),n=g("node"),B=g("./walker"),u=g("./range"),k=g("./base");k.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,
SELECTION_ELEMENT:3};var h=true,l=null,v=g("ua"),f=g("dom"),x=k.SelectionType,s=k.RangeType,p=document.selection,d={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};y.augment(r,{getNative:!p?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=f.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!p?function(){var a=
this._.cache;if(a.type)return a.type;var b=x.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount===1){var c=c.getRangeAt(0),i=c.startContainer;if(i===c.endContainer&&i.nodeType===f.NodeType.ELEMENT_NODE&&Number(c.endOffset-c.startOffset)===1&&d[i.childNodes[c.startOffset].nodeName.toLowerCase()])b=x.SELECTION_ELEMENT}}else b=x.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=x.SELECTION_NONE;try{var d=this.getNative(),c=d.type;if(c==="Text")b=x.SELECTION_TEXT;
if(c==="Control")b=x.SELECTION_ELEMENT;if(d.createRange().parentElement)b=x.SELECTION_TEXT}catch(f){}return a.type=b},getRanges:p?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var d=a.parentElement(),c=d.childNodes,g,h=0;h<c.length;h++){var k=c[h];if(k.nodeType===f.NodeType.ELEMENT_NODE){g=a.duplicate();g.moveToElementText(k);var k=g.compareEndPoints("StartToStart",a),p=g.compareEndPoints("EndToStart",a);g.collapse();if(k>0)break;else{if(!k||p===1&&k===-1)return{container:d,offset:h};
if(!p)return{container:d,offset:h+1}}g=l}}if(!g){g=a.duplicate();g.moveToElementText(d);g.collapse(false)}g.setEndPoint("StartToStart",a);g=(""+g.text).replace(/\r\n|\r/g,"\n").length;try{for(;g>0;)g=g-c[--h].nodeValue.length}catch(n){g=0}return g===0?{container:d,offset:h}:{container:c[h],offset:-g}};return function(b){var d=this._.cache;if(d.ranges&&!b)return d.ranges;var c=this.getNative(),b=c&&c.createRange(),f=this.getType();if(!c)return[];if(f===x.SELECTION_TEXT){c=new u(this.document);f=a(b,
h);c.setStart(n(f.container),f.offset);f=a(b);c.setEnd(n(f.container),f.offset);d.ranges=[c];return[c]}if(f===x.SELECTION_ELEMENT){d=d.ranges=[];for(f=0;f<b.length;f++){for(var g=b.item(f),k=g.parentNode,p=0,c=new u(this.document);p<k.childNodes.length&&k.childNodes[p]!==g;p++);c.setStart(n(k),p);c.setEnd(n(k),p+1);d.push(c)}return d}d.ranges=[];return[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],d=this.getNative();if(!d)return[];for(var c=0;c<d.rangeCount;c++){var f=
d.getRangeAt(c),g=new u(this.document);g.setStart(n(f.startContainer),f.startOffset);g.setEnd(n(f.endContainer),f.endOffset);a.push(g)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==void 0)return a.startElement;var b,d=this.getNative();switch(this.getType()){case x.SELECTION_ELEMENT:return this.getSelectedElement();case x.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();h;){b=c.startContainer;if(c.startOffset===(b[0].nodeType===f.NodeType.ELEMENT_NODE?
b[0].childNodes.length:b[0].nodeValue.length)&&!b._4eIsBlockBoundary())c.setStartAfter(b);else break}b=c.startContainer;if(b[0].nodeType!==f.NodeType.ELEMENT_NODE)return b.parent();b=n(b[0].childNodes[c.startOffset]);if(!b[0]||b[0].nodeType!==f.NodeType.ELEMENT_NODE)return c.startContainer;for(c=b[0].firstChild;c&&c.nodeType===f.NodeType.ELEMENT_NODE;){b=n(c);c=c.firstChild}return b}if(p){c=d.createRange();c.collapse(h);b=n(c.parentElement())}else{if((b=d.anchorNode)&&b.nodeType!==f.NodeType.ELEMENT_NODE)b=
b.parentNode;b&&(b=n(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(b.selectedElement!==void 0)return b.selectedElement;if(p){a=this.getNative().createRange();a=a.item&&a.item(0)}var c;if(a)c=n(a);else{a=this.getRanges()[0];for(var i,g=2;g&&(!(c=a.getEnclosedNode())||!(c[0].nodeType===f.NodeType.ELEMENT_NODE&&d[c.nodeName()]&&(i=c)));g--)a.shrink(s.SHRINK_ELEMENT);c=i}a=c;return b.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var b,
c=this.document;if(p)try{b=c.body.createControlRange();b.addElement(a[0]);b.select()}catch(d){b=c.body.createTextRange();b.moveToElementText(a[0]);b.select()}finally{}else{b=c.createRange();b.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(b)}this.reset()},selectRanges:function(a){if(p){if(a.length>1){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var d=
a[c],g=this.document.createRange(),h=d.startContainer;if(d.collapsed&&(v.gecko&&v.gecko<1.09||v.webkit)&&h[0].nodeType===f.NodeType.ELEMENT_NODE&&!h[0].childNodes.length){h[0].appendChild(this.document.createTextNode(v.webkit?"\u200b":""));d.startOffset++;d.endOffset++}g.setStart(h[0],d.startOffset);g.setEnd(d.endContainer[0],d.endOffset);b.addRange(g)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,
b){for(var c=[],d=this.document,g,b=b||this.getRanges(),k=b.length,p=0;p<k;p++){c.push(g=b[p].createBookmark(a,h));var l=(a=g.serializable)?n("#"+g.startNode,d):g.startNode;g=a?n("#"+g.endNode,d):g.endNode;for(var s=p+1;s<k;s++){var q=b[s],m=q.startContainer,t=q.endContainer;f.equals(m,l.parent())&&q.startOffset++;f.equals(m,g.parent())&&q.startOffset++;f.equals(t,l.parent())&&q.endOffset++;f.equals(t,g.parent())&&q.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=
new u(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();p?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},t=B.whitespaces(h),
c=/\ufeff|\u00a0/;u.prototype.select=!p?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType===f.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(v.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(h);b.setEnd(this.endContainer[0],this.endOffset)}else throw c;
}a=q(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var d=this.collapsed,g,i;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset===1){var j=this.startContainer[0].childNodes[this.startOffset];if(j.nodeType===f.NodeType.ELEMENT_NODE){(new r(this.document)).selectElement(n(j));return}}(this.startContainer[0].nodeType===f.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType===f.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in
b)&&this.shrink(s.SHRINK_ELEMENT,h);var k=this.createBookmark(),j=k.startNode,p;if(!d)p=k.endNode;k=this.document.body.createTextRange();k.moveToElementText(j[0]);k.moveStart("character",1);if(p){a=this.document.body.createTextRange();a.moveToElementText(p[0]);k.setEndPoint("EndToEnd",a);k.moveEnd("character",-1)}else{for(g=j[0].nextSibling;g&&!t(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(c))&&(a||!j[0].previousSibling||j[0].previousSibling&&f.nodeName(j[0].previousSibling)==="br");
i=n(this.document.createElement("span"));i.html("&#65279;");i.insertBefore(j);g&&f.insertBefore(this.document.createTextNode("\ufeff"),j[0]||j)}this.setStartBefore(j);j._4eRemove();if(d){if(g){k.moveStart("character",-1);k.select();this.document.selection.clear()}else k.select();if(i){this.moveToPosition(i,s.POSITION_BEFORE_START);i._4eRemove()}}else{this.setEndBefore(p);p._4eRemove();k.select()}};r.getSelection=q;k.Selection=r;w.exports=r});
KISSY.add("editor/enter-key","util,node,ua,./walker,./base,./element-path".split(","),function(y,g,B){function w(g){var p;p=g.getSelection().getRanges();for(var d=p.length-1;d>0;d--)p[d].deleteContents();p=p[0];var d=p.document,b=new l(p.startContainer),t=p.checkStartOfBlock(),c=p.checkEndOfBlock(),b=b.block;if(t&&c){if(b&&(b.nodeName()==="li"||b.parent().nodeName()==="li")){if(g.hasCommand("outdent")){g.execCommand("save");g.execCommand("outdent");g.execCommand("save");return true}return false}}else if(b&&
b.nodeName()==="pre"&&!c){var a=u.ieMode<9?n(d.createTextNode("\r")):n(d.createElement("br"));p.insertNode(a);if(u.ieMode<9){a=n(d.createTextNode("\ufeff")).insertAfter(a);p.setStartAt(a,h.RangeType.POSITION_AFTER_START)}else p.setStartAfter(a);p.collapse(true);p.select();if(u.ieMode<9)a[0].nodeValue="";return}var e=p.splitBlock("p");if(!e)return true;var g=e.previousBlock,b=e.nextBlock,t=e.wasStartOfBlock,c=e.wasEndOfBlock,o;if(b){o=b.parent();if(o.nodeName()==="li"){b._4eBreakParent(o);b._4eMove(b.next(),
true)}}else if(g&&(o=g.parent())&&o.nodeName()==="li"){g._4eBreakParent(o);p.moveToElementEditablePosition(g.next());g._4eMove(g.prev())}if(!t&&!c){if(b.nodeName()==="li"&&(o=b.first(k.invisible(true)))&&q.inArray(o.nodeName(),["ul","ol"]))(v?n(d.createTextNode("\u00a0")):n(d.createElement("br"))).insertBefore(o);b&&p.moveToElementEditablePosition(b)}else{if(g){if(g.nodeName()==="li"||!f.test(g.nodeName()))a=g.clone()}else b&&(a=b.clone());a||(a=n("<p>",null,d));if(o=e.elementPath)for(var e=0,i=o.elements.length;e<
i;e++){var j=o.elements[e];if(j.equals(o.block)||j.equals(o.blockLimit))break;if(x.$removeEmpty[j.nodeName()]){j=j.clone();a._4eMoveChildren(j);a.append(j)}}v||a._4eAppendBogus();p.insertNode(a);if(v&&t&&(!c||!g[0].childNodes.length)){p.moveToElementEditablePosition(c?g:a);p.select()}p.moveToElementEditablePosition(t&&!c?b:a)}if(!v)if(b){a=n(d.createElement("span"));a.html("&nbsp;");p.insertNode(a);a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});p.deleteContents()}else a.scrollIntoView(void 0,
{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});p.select();return true}function r(f){f.get("document").on("keydown",function(g){if(g.keyCode===13&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey){f.execCommand("save");var d=f.execCommand("enterBlock");f.execCommand("save");d!==false&&g.preventDefault()}})}var q=g("util"),n=g("node"),u=g("ua"),k=g("./walker"),h=g("./base"),l=g("./element-path"),v=u.ieMode<11,f=/^(?:h[1-6])|(?:pre)$/i,x=h.XHTML_DTD;B.init=function(f){f.addCommand("enterBlock",
{exec:w});f.docReady(function(){r(f)})}});
KISSY.add("editor/html-data-processor",["html-parser","ua","node","util"],function(y,g,B){function w(g){if(!k.$removeEmpty[g.nodeName])return!1;var g=g.childNodes,f,l,n=g.length;if(n)for(f=0;f<n;f++)if(l=g[f],l.nodeType!==h.TEXT_NODE||l.nodeValue||!w(l))return!1;return!0}var r=g("html-parser"),q=g("ua"),n=11>q.ieMode,u=g("node"),k=r.DTD,h=u.Dom.NodeType,l=g("util");B.init=function(g){function f(a){return!w(a)}function h(a){return a.replace(t,function(a,b,d){return"<"+b+d.replace(c,function(a,b){return-1===
d.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function s(a){return a.replace(e,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function p(a){return a.replace(o,function(a,b){return l.urlDecode(b)})}var d=new r.Filter,b=new r.Filter;(function(){function c(b){b=r.serialize(b);return new r.Comment(a+encodeURIComponent(b).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:c,
noscript:c,span:f}},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:f,strong:f,
em:f,del:f,u:f},attributes:{style:function(a){if(!l.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)===a)return b=l.trim(l.urlDecode(b.substr(a.length))),r.parse(b).childNodes[0]}};n&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});d.addRules(g);b.addRules(e)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,d=b[c-1];d&&(3===
d.nodeType&&!l.trim(d.nodeValue)||1===d.nodeType&&w(d));)d=b[--c];return d}function c(b){var d=a(b);d&&(1===d.nodeType&&"br"===d.nodeName?b.removeChild(d):3===d.nodeType&&i.test(d.nodeValue)&&b.removeChild(d))}function e(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function f(a){c(a);e(a)&&(n||a.appendChild(new r.Tag("br")))}function g(a){c(a);e(a)&&a.appendChild(new r.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,j=l.merge(k.$block,k.$listItem,k.$tableContent),h;for(h in j)"br"in
k[h]||delete j[h];delete j.pre;var o={tags:{}},p={tags:{}};for(h in j)o.tags[h]=f,p.tags[h]=g;b.addRules(o);d.addRules(p)})();d.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var t=/<(a|area|img|input)\b([^>]*)>/gi,c=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",e=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,o=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
i=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,j=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,y=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;g.htmlDataProcessor={dataFilter:b,htmlFilter:d,toHtml:function(a){q.webkit&&(a=a.replace(/\u200b/g,""));var b=new r.BeautifyWriter;(new r.Parser(a)).parse().writeHtml(b,d);return a=b.getHtml()},toDataFormat:function(a,c){var c=c||b,a=s(a),a=h(a),a=a.replace(i,"$1ke:$2"),a=a.replace(y,"<ke:$1$2></ke:$1>"),
d=u("<div>");d.html("a"+a);a=d.html().substr(1);a=a.replace(j,"$1$2");a=p(a);d=new r.BasicWriter;(new r.Parser(a)).parse().writeHtml(d,c);return a=d.getHtml()},toServer:function(a){var b=new r.MinifyWriter;(new r.Parser(a)).parse().writeHtml(b,d);return b.getHtml()}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node","ua","dom"],function(y,g,B){function w(f){function d(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=v}return c}function b(){var a=h.selection.createRange();i&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&i.select();e.detach("mouseup",b);e.detach("mousemove",g);i=c=0}function g(a){if(a.button){if(a=d(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",i)?a.setEndPoint("StartToStart",i):a.setEndPoint("EndToEnd",
i),a.select()}else b()}var c,a=f.get("window")[0],e=f.get("document"),h=e[0],i;e.on("mousedown contextmenu",function(f){var k=h.documentElement;if(f.target===k&&(c&&b(),!(k.scrollHeight>k.clientHeight)&&(c=1,i=d(f.pageX,f.pageY))))e.on("mouseup",b),e.on("mousemove",g),a.focus(),i.select()})}function r(g){function d(c){if(e){var f=g.getSelection(),k=f&&f.getType(),o=f&&b.selection;if(c&&o&&k===s.SELECTION_NONE&&!b.queryCommandEnabled("InsertImage"))setTimeout(function(){d(h)},50);else{var l;if(!o||
!o.type||!("Control"!==o.type&&(l=o.createRange())&&(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))a=o&&f.getRanges()[0],g.checkSelectionChange()}}}var b=g.get("document")[0],n=k(b.body),c=k(b.documentElement);if(8>f.ieMode)c.on("click",function(a){"html"===k(a.target).nodeName()&&g.getSelection().getNative().createRange().select()});var a,e,o=h;c.on("mousedown",function(){o=l});c.on("mouseup",function(){o=h});n.on("focusin",function(b){if("body"===k(b.target).nodeName()&&
a){try{o&&a.select()}catch(c){}a=v}});n.on("focus",function(){e=h;d()});n.on("beforedeactivate",function(a){a.relatedTarget||(e=l,o=h)});n.on("mousedown",function(){e=l});n.on("mouseup",function(){e=h;setTimeout(function(){d(h)},0)});n.on("keydown",function(){e=l});n.on("keyup",function(){e=h;setTimeout(function(){d()},0)})}function q(f){f.get("document").on("mouseup keyup selectionchange",function(){f.checkSelectionChange()})}function n(g){function d(a){var b=u.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function b(b){return c(b)&&a(b)}var n=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,c=u.Walker.whitespaces(h),a=u.Walker.bookmark(l,h),e=function(a){return c(a)&&8!==a.nodeType};g.on("selectionChange",function(a){var c=a.path,j=g.get("document")[0],q=k(j.body),a=(a=a.selection)&&a.getRanges()[0],r=c.blockLimit;q[0]||(j.documentElement.appendChild(j.createElement("body")),q=k(j.body),a&&(a.setStart(q,
0),a.collapse(1)));r=r||q;if(f.gecko){var s=(j=c.block||c.blockLimit)&&j.last(b);j&&j._4eIsBlockBoundary()&&(!s||!(1===s[0].nodeType&&s._4eIsBlockBoundary()))&&"pre"!==j.nodeName()&&!j._4eGetBogus()&&j._4eAppendBogus()}if(a&&a.collapsed&&!c.block){if("body"===r.nodeName()){"html"===a.startContainer.nodeName()&&a.setStart(q,0);if((c=a.fixBlock(h,"p"))&&c[0]!==q[0].lastChild&&c.outerHtml().match(n))if((j=c.next(e,1))&&j[0].nodeType===x.NodeType.ELEMENT_NODE&&!d[j])a.moveToElementEditablePosition(j),
c._4eRemove();else if((j=c.prev(e,1))&&j[0].nodeType===x.NodeType.ELEMENT_NODE&&!d[j])a.moveToElementEditablePosition(j,j.outerHtml().match(n)?l:h),c._4eRemove();a.select();g.notifySelectionChange()}c=g.get("document")[0];a=new u.Range(c);a.moveToElementEditablePosition(q,h);"body"!==(new u.ElementPath(a.startContainer)).blockLimit.nodeName()&&(q=k(c.createElement("p")).appendTo(q),f.ie||q._4eAppendBogus())}})}var u=g("./base");g("./selection");var k=g("node"),h=!0,l=!1,v=null,f=g("ua"),x=g("dom"),
s=u.SelectionType;B.init=function(g){g.docReady(function(){if(document.selection)w(g),r(g);else if(q(g),f.ie){var d,b=g.get("document");b.on("focusout",function(){d=g.getSelection().getRanges()});b.on("focusin",function(){d&&(g.getSelection().selectRanges(d),d=null)})}});n(g)}});
KISSY.add("editor/styles","util,./selection,./range,./base,./element-path,node,dom,ua".split(","),function(y,g,B,w){function r(a){return!C.attr(a,"_ke_bookmark")}function q(a,b){for(var c in a)typeof a[c]==="string"?a[c]=a[c].replace(T,function(a,c){return b[c]}):q(a[c],b)}function n(a,b){if(b){a=i.clone(a);q(a,b)}var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=c==="#text"||S[c]?K.STYLE_BLOCK:Q[c]?K.STYLE_OBJECT:K.STYLE_INLINE;this._={definition:a}}function u(a,
b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=new j(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function k(a,b,c){var d=a.element;d==="*"&&(d="span");b=m(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=n.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);if(c)b[0].style.cssText=c;return b}function h(a){var b=a.createBookmark(z),c=a.createIterator();c.enforceRealBlocks=z;c.enlargeBr=z;for(var d,e=a.document;d=
c.getNextParagraph();){var g=k(this,e,d),h=g,g=h.nodeName==="pre",i=d.nodeName==="pre",j=!g&&i;if(g&&!i){i=d;j=i.html();j=l(j,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,"");j=j.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1");j=j.replace(/([\t\n\r]+|&nbsp;)/g," ");j=j.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){i=i[0].ownerDocument.createElement("div");i.appendChild(h[0]);h.outerHtml("<pre>"+j+"</pre>");h=m(i.firstChild);h._4eRemove()}else h.html(j)}else j?h=f(v(d),h):d._4eMoveChildren(h);d[0].parentNode.replaceChild(h[0],
d[0]);if(g){d=h;g=void 0;if((g=d._4ePreviousSourceNode(z,C.NodeType.ELEMENT_NODE))&&g.nodeName()==="pre"){h=l(g.html(),/\n$/,"")+"\n\n"+l(d.html(),/^\n/,"");O.ie?d.outerHtml("<pre>"+h+"</pre>"):d.html(h);g._4eRemove()}}}a.moveToBookmark(b)}function l(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function v(a){var b=[];l(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function f(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=l(e,/^[\t]*\n/,""),e=l(e,/\n$/,""),e=l(e,/^[\t]+|[\t]+$/g,function(a,b){return a.length===1?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}function x(b){var c=b.document;if(b.collapsed){c=k(this,c,void 0);b.insertNode(c);b.moveToPosition(c,E.POSITION_BEFORE_END)}else{var d=this.element,e=this._.definition,f,g=L[d];if(!g){f=z;g=L.span}var h=b.createBookmark();b.enlarge(E.ENLARGE_ELEMENT);b.trim();for(var i=b.createBookmark(),j=i.startNode,i=i.endNode,l=j,o;l&&l[0];){var n=J;if(C.equals(l,i)){l=F;n=z}else{var p=l[0].nodeType,q=p===C.NodeType.ELEMENT_NODE?l.nodeName():F;if(q&&l.attr("_ke_bookmark")){l=
l._4eNextSourceNode(z);continue}if(!q||g[q]&&(l._4ePosition(i)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var t=l.parent();if(t&&d==="a"&&t.nodeName()===d){p=k(this,c,void 0);t._4eMoveChildren(p);t[0].parentNode.replaceChild(p[0],t[0]);p._4eMergeSiblings()}else if(t&&t[0]&&((L[t.nodeName()]||L.span)[d]||f)&&(!e.parentRule||e.parentRule(t))){if(!o&&(!q||!L.$removeEmpty[q]||(l._4ePosition(i)|
D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED)){o=new H(c);o.setStartBefore(l)}if(p===C.NodeType.TEXT_NODE||p===C.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){t=l;for(p=null;(n=!t.next(r,1))&&(p=t.parent())&&g[p.nodeName()]&&(p._4ePosition(j)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)t=
p;o.setEndAfter(t)}}else n=z}else n=z;l=l._4eNextSourceNode()}if(n&&o&&!o.collapsed){for(var n=k(this,c,void 0),t=o.getCommonAncestor(),p={},q={},s,u=null,v;n&&t&&n[0]&&t[0];){if(t.nodeName()===d){for(s in e.attributes)if(!q[s]&&(v=t.attr(u)))n.attr(s)===v?n.removeAttr(s):q[s]=1;for(u in e.styles)if(!p[u]&&(v=t.style(u)))n.style(u)===v?n.style(u,""):p[u]=1;if(!n._4eHasAttributes()){n=F;break}}t=t.parent()}if(n){n[0].appendChild(o.extractContents());a(this,n);o.insertNode(n);n._4eMergeSiblings();O.ie||
n[0].normalize()}else{n=m(c.createElement("span"));n[0].appendChild(o.extractContents());o.insertNode(n);a(this,n);n._4eRemove(true)}o=F}}j._4eRemove();i._4eRemove();b.moveToBookmark(h);b.shrink(E.SHRINK_TEXT)}}function s(a){a.enlarge(E.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var f=new I(d.parent()),g,h=0,i;h<f.elements.length&&(i=f.elements[h]);h++){if(i.equals(f.block)||i.equals(f.blockLimit))break;if(this.checkElementRemovable(i)){var j=a.checkBoundaryOfElement(i,
E.END),k=!j&&a.checkBoundaryOfElement(i,E.START);if(k||j){g=i;g.match=k?"start":"end"}else{i._4eMergeSiblings();if(i.nodeName()!==this.element){j=b(this);e(i,j[i.nodeName()]||j["*"])}else t(this,i)}}}if(g){i=d;for(h=0;;h++){j=f.elements[h];if(j.equals(g))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(i[0]);i=j}i[g.match==="start"?"insertBefore":"insertAfter"](g);f=g.html();!f||f==="\u200b"?g.remove():O.webkit&&m(a.document.createTextNode("\u200b")).insertBefore(i)}}else{var l=c.endNode,n=
this;g=function(){for(var a=new I(d.parent()),b=new I(l.parent()),c=F,e,f=F,g=0;g<a.elements.length;g++){e=a.elements[g];if(e===a.block||e===a.blockLimit)break;n.checkElementRemovable(e)&&(c=e)}for(g=0;g<b.elements.length;g++){e=b.elements[g];if(e===b.block||e===b.blockLimit)break;n.checkElementRemovable(e)&&(f=e)}f&&l._4eBreakParent(f);c&&d._4eBreakParent(c)};g();for(f=m(d[0].nextSibling);f[0]!==l[0];){h=f._4eNextSourceNode();if(f[0]&&f[0].nodeType===C.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)){if(f.nodeName()===
this.element)t(this,f);else{i=b(this);e(f,i[f.nodeName()]||i["*"])}if(h[0].nodeType===C.NodeType.ELEMENT_NODE&&h.contains(d)){g();h=m(d[0].nextSibling)}}f=h}}a.moveToBookmark(c)}function p(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function d(a,b){var c="";if(b!==J){c=document.createElement("span");c.style.cssText=a;c=c.style.cssText||""}else c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){i.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g,h;if(typeof e==="string")f=e.toLowerCase();else{f=e.element?e.element.toLowerCase():a.element;g=e.attributes;h=e.styles}e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var j in g)f.push([j.toLowerCase(),g[j]])}if(h){var e=e.styles=e.styles||[],k;for(k in h)e.push([k.toLowerCase(),h[k]])}}}return b}
function t(a,d){var e=a._.definition,f=b(a),g=i.merge(e.attributes,(f[d.nodeName()]||f["*"]||{}).attributes),e=i.merge(e.styles,(f[d.nodeName()]||f["*"]||{}).styles),f=i.isEmptyObject(g)&&i.isEmptyObject(e),h;for(h in g)if(!((h==="class"||a._.definition.fullMatch)&&d.attr(h)!==c(h,g[h]))){f=f||!!d.hasAttr(h);d.removeAttr(h)}for(var j in e)if(!(a._.definition.fullMatch&&d.style(j)!==c(j,e[j],z))){f=f||!!d.style(j);d.style(j,"")}o(d)}function c(a,b,c){var d=m("<span>");d[c?"style":"attr"](a,b);return d[c?
"style":"attr"](a)}function a(a,c){for(var d=b(a),f=c.all(a.element),g=f.length;--g>=0;)t(a,m(f[g]));for(var h in d)if(h!==a.element){f=c.all(h);for(g=f.length-1;g>=0;g--){var i=m(f[g]);e(i,d[h])}}}function e(a,b){var c,d,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0];if(d=a.attr(f)){var g=e[c][1];(g===F||g.test&&g.test(d)||typeof g==="string"&&d===g)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++){f=e[c][0];if(g=a.css(f)){var h=e[c][1];(h===F||h.test&&h.test(d)||
typeof h==="string"&&g===h)&&a.css(f,"")}}o(a)}function o(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(z);if(b){b.nodeType===C.NodeType.ELEMENT_NODE&&C._4eMergeSiblings(b);c&&b!==c&&c.nodeType===C.NodeType.ELEMENT_NODE&&C._4eMergeSiblings(c)}}}var i=g("util"),j=g("./selection"),H=g("./range"),y=g("./base"),I=g("./element-path"),z=true,J=false,F=null,m=g("node"),C=g("dom"),E=y.RangeType,D=y.PositionType,K,O=g("ua"),S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,
p:1,pre:1},L=y.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;y.StyleType=K={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};n.prototype={constructor:n,apply:function(a){u.call(this,a,J)},remove:function(a){u.call(this,a,z)},applyToRange:function(a){return(this.applyToRange=this.type===K.STYLE_INLINE?x:this.type===K.STYLE_BLOCK?h:F).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===
K.STYLE_INLINE?s:F).call(this,a)},checkElementRemovable:function(a,c){if(!a)return J;var e,f=this._.definition,g;if(a.nodeName()===this.element){if(!c&&!a._4eHasAttributes())return z;var h=f._AC;if(!h){var h={},i=0,j=f.attributes;if(j)for(var k in j){i++;h[k]=j[k]}if(j=n.getStyleText(f)){h.style||i++;h.style=j}h._length=i;f._AC=h}f=h;if(f._length){for(e in f)if(e!=="_length"){i=a.attr(e)||"";if(e==="style")a:{h=f[e];i=d(i,J);typeof h==="string"&&(h=p(h));typeof i==="string"&&(i=p(i));j=void 0;for(j in h)if(!(j in
i&&(i[j]===h[j]||h[j]==="inherit"||i[j]==="inherit"))){h=J;break a}h=z}else h=f[e]===i;if(h){if(!c)return z}else if(c)return J}if(c)return z}else return z}e=b(this);if(e=e[a.nodeName()]||e["*"]){if(!(f=e.attributes)&&!(g=e.styles))return z;if(f)for(h=0;h<f.length;h++){e=f[h][0];if(e=a.attr(e)){i=f[h][1];if(i===F||typeof i==="string"&&e===i||i.test&&i.test(e))return z}}if(g)for(h=0;h<g.length;h++)if(e=a.css(g[h][0])){f=g[h][1];if(f===F||typeof f==="string"&&e===f||f.test&&f.test(e))return z}}return J},
checkActive:function(a){switch(this.type){case K.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,z);case K.STYLE_OBJECT:case K.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++){d=b[c];if(!(this.type===K.STYLE_INLINE&&(C.equals(d,a.block)||C.equals(d,a.blockLimit))))if((this.type!==K.STYLE_OBJECT||d.nodeName()in Q)&&this.checkElementRemovable(d,z))return z}}return J}};n.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",
e="";c.length&&(c=c.replace(R,";"));for(var f in b){var g=b[f],h=(f+":"+g).replace(R,";");g==="inherit"?e=e+h:c=c+h}c.length&&(c=d(c));c=c+e;return a._ST=c};y.Style=n;w.exports=n});
KISSY.add("editor/dom-iterator","util,node,./walker,./range,./base,./element-path,ua,dom".split(","),function(y,g,B,w){function r(d){if(!(arguments.length<1)){this.range=d;this.forceBrBreak=v;this.enlargeBr=l;this.enforceRealBlocks=v;this._=this._||{}}}var q=g("util"),n=g("node"),u=g("./walker"),k=g("./range"),y=g("./base"),h=g("./element-path"),l=true,v=false,f=g("ua"),x=y.RangeType,s=g("dom"),p=/^[\r\n\t ]*$/;q.augment(r,{getNextParagraph:function(d){var b,g,c,a,e,o;if(!this._.lastNode){c=this.range.clone();
c.shrink(x.SHRINK_ELEMENT,l);c.enlarge(this.forceBrBreak||!this.enlargeBr?x.ENLARGE_LIST_ITEM_CONTENTS:x.ENLARGE_BLOCK_CONTENTS);g=new u(c);var i=u.bookmark(l,l);g.evaluator=i;this._.nextNode=g.next();g=new u(c);g.evaluator=i;g=g.previous();this._.lastNode=g._4eNextSourceNode(l);if(this._.lastNode&&this._.lastNode[0].nodeType===s.NodeType.TEXT_NODE&&!q.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()){i=new k(c.document);i.moveToPosition(this._.lastNode,x.POSITION_AFTER_END);
if(i.checkEndOfBlock()){i=new h(i.endContainer);this._.lastNode=(i.block||i.blockLimit)._4eNextSourceNode(l)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=n(c.document.createTextNode(""));s.insertAfter(this._.lastNode[0],g[0])}c=null}i=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;i;){var j=v,r=i[0].nodeType!==s.NodeType.ELEMENT_NODE,y=v;if(r)i[0].nodeType===s.NodeType.TEXT_NODE&&p.test(i[0].nodeValue)&&(r=v);else{var w=i.nodeName();if(i._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){if(w==="br")r=l;else if(!c&&!i[0].childNodes.length&&w!=="hr"){b=i;a=i.equals(g);break}if(c){c.setEndAt(i,x.POSITION_BEFORE_START);if(w!=="br")this._.nextNode=i}j=l}else{if(i[0].firstChild){if(!c){c=new k(this.range.document);c.setStartAt(i,x.POSITION_BEFORE_START)}i=n(i[0].firstChild);continue}r=l}}if(r&&!c){c=new k(this.range.document);c.setStartAt(i,x.POSITION_BEFORE_START)}a=(!j||r)&&i.equals(g);if(c&&!j)for(;!i[0].nextSibling&&!a;){w=i.parent();if(w._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){j=l;a||w.equals(g);break}i=w;r=l;a=i.equals(g);y=l}r&&c.setEndAt(i,x.POSITION_AFTER_END);i=i._4eNextSourceNode(y,null,g);if((a=!i)||j&&c)break}if(!b){if(!c){this._.docEndMarker&&this._.docEndMarker._4eRemove();return this._.nextNode=null}b=new h(c.startContainer);i=b.blockLimit;j={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&j[i.nodeName()]&&c.checkStartOfBlock()&&c.checkEndOfBlock())b=i;else if(!b||this.enforceRealBlocks&&b.nodeName()==="li"){b=n(this.range.document.createElement(d||
"p"));b[0].appendChild(c.extractContents());b._4eTrim();c.insertNode(b);e=o=l}else if(b.nodeName()!=="li"){if(!c.checkStartOfBlock()||!c.checkEndOfBlock()){b=b.clone(v);b[0].appendChild(c.extractContents());b._4eTrim();o=c.splitBlock();e=!o.wasStartOfBlock;o=!o.wasEndOfBlock;c.insertNode(b)}}else if(!a)this._.nextNode=b.equals(g)?null:c.getBoundaryNodes().endNode._4eNextSourceNode(l,null,g)}if(e){c=n(b[0].previousSibling);c[0]&&c[0].nodeType===s.NodeType.ELEMENT_NODE&&(c.nodeName()==="br"?c._4eRemove():
c[0].lastChild&&s.nodeName(c[0].lastChild)==="br"&&s._4eRemove(c[0].lastChild))}if(o){c=u.bookmark(v,l);e=n(b[0].lastChild);e[0]&&e[0].nodeType===s.NodeType.ELEMENT_NODE&&e.nodeName()==="br"&&(f.ie||e.prev(c,1)||e.next(c,1))&&e.remove()}if(!this._.nextNode)this._.nextNode=a||b.equals(g)?null:b._4eNextSourceNode(l,null,g);return b}});k.prototype.createIterator=function(){return new r(this)};w.exports=r});
KISSY.add("editor/z-index-manager",["./base"],function(y,g,B,w){var r=g("./base"),y=r.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(g){return(r.Config.baseZIndex||1E4)+g};w.exports=y});
