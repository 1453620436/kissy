/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 23 16:31
*/
KISSY.add("editor","node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/modules,editor/styles,editor/dom-iterator,editor/z-index-manager".split(","),function(l,k,v,u){function q(a,n){var d=a.get("textarea"),b=a.get("toolBarEl"),c=a.get("statusBarEl"),n=parseInt(n,10),n=n-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));d.parent().css(H,n);d.css(H,n)}function y(d,b){var c=d.body;n(function(){d.designMode=
"on";setTimeout(function M(){d.designMode="off";c.focus();if(!M.retry)M.retry=a},50)},function(){d.designMode="off";c.setAttribute("contentEditable",false);c.setAttribute("contentEditable",true);b||y(d,1)})}function t(a){var n=a.get("textarea")[0],c=a.get("window"),g=a.get("document"),m=g[0];if(x.webkit){g.on("click",function(a){var n=new j(a.target);l.inArray(n.nodeName(),["input","select"])&&a.preventDefault()});g.on("mouseup",function(a){var n=new j(a.target);l.inArray(n.nodeName(),["input","textarea"])&&
a.preventDefault()})}if(x.gecko||x.ie||x.opera){var e;e=(new j('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(n);e.on("focus",function(){a.focus()});a.activateGecko=function(){x.gecko&&a.__iframeFocus&&e[0].focus()};a.on("destroy",function(){e.detach();e.remove()})}c.on("focus",function(){x.gecko?y(m,d):x.opera&&m.body.focus();a.notifySelectionChange()});if(x.gecko)g.on("mousedown",function(){a.__iframeFocus||y(m,d)});if(E){g.on("keydown",function(n){if(n.keyCode in
{8:1,46:1}){var d=a.getSelection(),b=d.getSelectedElement();if(b){a.execCommand("save");var c=d.getRanges()[0].createBookmark();b.remove();d.selectBookmarks([c]);a.execCommand("save");n.preventDefault()}}});if(m.compatMode==="CSS1Compat"){var z={33:1,34:1};g.on("keydown",function(n){n.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(x.webkit)g.on("mousedown",function(n){n=new j(n.target);l.inArray(n.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(n)});
if(x.gecko)g.on("dragstart",function(a){var n=new j(a.target);n.nodeName()==="img"&&/ke_/.test(n[0].className)&&a.preventDefault()});b.add(a)}function f(a,n,d,b){var c="",g;g=o.debugUrl("theme/iframe.css");d=d.concat([]);d.unshift(g);for(g=0;g<d.length;g++)c=c+l.substitute('<link href="{href}" rel="stylesheet" />',{href:d[g]});return l.substitute(s,{doctype:l.UA.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:c,style:"<style>"+n+"</style>",data:b||"",script:a?
'<script id="ke_active_script">'+(C(m).isCustomDomain()?'document.domain="'+D.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+a+'");<\/script>':""})}function i(a,n){function d(){e=m.document;a.setInternal("document",new j(e));a.setInternal("window",new j(m));b.detach();e.open("text/html","replace");e.write(c);e.close()}var b=a.get("iframe"),c=f(a.get("id"),a.get("customStyle"),a.get("customLink"),n),g=b[0],m=g.contentWindow,e;b.__loaded=1;try{e=m.document}catch(z){g.src=g.src;if(E<
7){setTimeout(d,10);return}}d()}function r(a,n){var d=C(m).getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new j(l.substitute(z,{iframeSrc:d,prefixCls:a.get("prefixCls")})),b=a.get("textarea");b.hasAttr("tabindex")&&d.attr("tabindex",x.webkit?-1:b.attr("tabindex"));b.parent().prepend(d);a.set("iframe",d);a.__docReady=0;if(x.gecko&&!d.__loaded)d.on("load",function(){i(a,n)},a);else i(a,n)}function w(a){if(a.get("iframe")){var n=a.get("iframe"),d=a.get("window"),a=a.get("document"),b=a[0],c=C(b.documentElement),
b=C(b.body);l.each([a,c,b,d],function(a){a.detach()});n.remove()}}var j=k("node"),s=k("editor/iframe-content-tpl"),p=k("editor/base"),o=k("editor/utils"),b=k("editor/focus-manager"),c=k("editor/clipboard"),e=k("editor/enter-key"),h=k("editor/html-data-processor"),g=k("editor/selection-fix");k("editor/modules");k("editor/styles");k("editor/dom-iterator");k("editor/z-index-manager");u.exports=p;var a=true,d=false,m=l.Env.host,D=m.document,x=l.UA,E=x.ieMode<11,A=j.NodeType,C=j.all,H="height",n=o.tryThese,
z='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',G=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;p.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};p.addMembers({initializer:function(){this.__commands={};this.__controls={};b.register(this)},renderUI:function(){c.init(this);e.init(this);h.init(this);g.init(this)},bindUI:function(){function a(){n.detach("docReady",a);if(n.get("focused"))n.focus();else{var d=n.getSelection();
d&&d.removeAllRanges()}}var n=this,d,b=n.get("prefixCls"),c=n.get("textarea");if(n.get("attachForm")&&(d=c[0].form)&&(d=C(d)))d.on("submit",n.sync,n);n.on("docReady",a);n.on("blur",function(){n.$el.removeClass(b+"editor-focused")});n.on("focus",function(){n.$el.addClass(b+"editor-focused")})},syncUI:function(){q(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,
n){this.__controls[a]=n},showDialog:function(a,n){var a=a+"/dialog",d=this.__controls[a];d.show(n);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,dialogName:a})},addCommand:function(a,n){this.__commands[a]=n},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var n=this.__commands[a],d=l.makeArray(arguments);d.shift();d.unshift(this);if(n)return n.exec.apply(n,d)},queryCommandValue:function(a){return this.execCommand(o.getQueryCmd(a))},setData:function(a){var n,d=a;
if(this.get("mode")!==1)this.get("textarea").val(a);else{if(n=this.htmlDataProcessor)d=n.toDataFormat(a);w(this);r(this,d)}},getData:function(a,n){var d=this.htmlDataProcessor,b;n===void 0&&(n=this.get("mode"));b=n===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());b=a?d.toHtml(b):d.toServer(b);b=l.trim(b);G.test(b)&&(b="");return b},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return f(0,this.get("customStyle"),this.get("customLink"),
this.getFormatData())},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],n="";if(a){a=a.cloneContents();n=this.get("document")[0].createElement("div");n.appendChild(a);n=n.innerHTML}return n},focus:function(){var a=this.get("window");if(a){var n=this.get("document")[0],a=a[0];x.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{n.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,n){var d=this.get("window"),b=this.get("customStyle")||"";this.set("customStyle",b+("\n"+a));d&&d.addStyleSheet(a,n)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var n=this.get("customLink"),d=this.get("document")[0];n.push(a);this.set("customLink",n);n=d.createElement("link");n.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(n);n.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(n){n.attr("href")===
a&&n.remove()});var n=this.get("customLink"),d=l.indexOf(a,n);d!==-1&&n.splice(d,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var n=a.getSelection();if(n&&!n.isInvalid){var d=n.getStartElement(),b=new p.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(b)){a.__previousPath=
b;a.fire("selectionChange",{selection:n,path:b,element:d})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(n){if(this.get("mode")===1){this.focus();var d,b=n.nodeName(),c=p.XHTML_DTD,g=c.$block[b],e=p.RangeType,m=(b=this.getSelection())&&b.getRanges(),z,h,G;if(m&&m.length!==0){this.execCommand("save");for(h=m.length-1;h>=0;h--){z=m[h];d=!h&&n||n.clone(a);z.insertNodeByDtd(d);G||(G=d)}if(G){z.moveToPosition(G,e.POSITION_AFTER_END);
if(g){n=p.Walker.whitespaces(true);(n=(G=G.next(n,1))&&G[0].nodeType===A.ELEMENT_NODE&&G.nodeName())&&c.$block[n]&&c[n]["#text"]&&z.moveToElementEditablePosition(G)}b.selectRanges([z]);this.focus();d&&d[0].nodeType===1&&d.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});F.call(this);return d}}}},insertHtml:function(a,n){var d=this,b,c=d.get("document")[0];if(d.get("mode")===1){if(b=d.htmlDataProcessor)a=b.toDataFormat(a,n);d.focus();d.execCommand("save");
if(b=c.selection){b.type==="Control"&&b.clear();try{b.createRange().pasteHTML(a)}catch(g){}}else{b=d.get("iframe")[0].contentWindow.getSelection();var m=b.getRangeAt(0);m.deleteContents();var e=c.createElement("div");e.innerHTML=a;for(var c=c.createDocumentFragment(),z,h;z=e.firstChild;)h=c.appendChild(z);m.insertNode(c);if(h){m=m.cloneRange();m.setStartAfter(h);m.collapse(true);b.removeAllRanges();b.addRange(m)}}setTimeout(function(){d.getSelection().scrollIntoView()},50);F.call(d)}},_onSetHeight:function(a){q(this,
a)},_onSetMode:function(a){var n=this.get("iframe"),d=this.get("textarea");if(a===1){this.setData(d.val());d.hide();this.fire("wysiwygMode")}else{if(n){d.val(this.getFormatData(1));n.hide()}d.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,n=this.get("textarea"),d=this.get("document");this.get("attachForm")&&(a=n[0].form)&&(a=C(a))&&a.detach("submit",this.sync,this);if(d){a=C(d[0].body);var n=C(d[0].documentElement),c=this.get("window");
b.remove(this);d.detach();n.detach();a.detach();c.detach()}l.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});p.decorate=function(a,n){var n=n||{},a=C(a),d=n.textareaAttrs=n.textareaAttrs||{},b=a.style("width"),c=a.style("height"),g=a.attr("name");if(b)n.width=n.width||b;if(c)n.height=n.height||c;if(g)d.name=g;n.data=n.data||a.val();n.elBefore=a;d=(new p(n)).render();a.remove();return d};p._initIframe=function(n){var c=b.getInstance(n),n=c.get("document"),
g=n[0];n.one("#ke_active_script").remove();t(c);var m=g.body,e=C(m);if(E){m.hideFocus=a;m.disabled=a;m.contentEditable=a;m.removeAttribute("disabled")}else setTimeout(function(){x.gecko||x.opera?m.contentEditable=a:x.webkit?m.parentNode.contentEditable=a:g.designMode="on"},0);if(x.gecko||x.opera){var z=g.documentElement;C(z).on("mousedown",function(a){if(a.target===z){x.gecko&&y(g,d);c.activateGecko()}})}setTimeout(function(){E&&setTimeout(function(){if(g){m.runtimeStyle.marginBottom="0px";m.runtimeStyle.marginBottom=
""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),n=c.get("disableInlineTableEditing");if(a||n)try{g.execCommand("enableObjectResizing",d,!a);g.execCommand("enableInlineTableEditing",d,!n)}catch(b){e.on(E?"resizestart":"resize",function(d){var b=new j(d.target);(a||b.nodeName()==="table"&&n)&&d.preventDefault()})}},10)};var F=l.buffer(function(){this.execCommand("save")},50)});KISSY.add("editor/iframe-content-tpl",[],function(){return'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>'});
KISSY.add("editor/base",["html-parser","component/control","./render-xtpl"],function(l,k){var v=k("html-parser"),u=k("component/control"),q=k("./render-xtpl");return u.extend({beforeCreateDom:function(q){l.mix(q,{mobile:l.UA.mobile})}},{Config:{},XHTML_DTD:v.DTD,ATTRS:{contentTpl:{value:q},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},
statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},handleGestureEvents:{value:!1},focusable:{value:!1},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(l,k,v,u){k=function(q,k,t){var f=this.nativeCommands;if("5.0.0"!==l.version)throw Error("current xtemplate file("+this.name+")(v5.0.0) need to be recompiled using current kissy(v"+l.version+")!");var i=f.each,f=f["if"];k.write('<div class="');var r=q.resolve(["prefixCls"]);k.write(r,!0);k.write('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="');
r=q.resolve(["prefixCls"]);k.write(r,!0);k.write('editor-textarea-wrap"\r\n\r\n');var r={escape:1},w=[],j=q.resolve(["mobile"]);w.push(j);r.params=w;r.fn=function(f,i){i.write('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n');return i};k=f.call(this,q,r,k,12,t);k.write('\r\n>\r\n\r\n<textarea class="');r=q.resolve(["prefixCls"]);k.write(r,!0);k.write('editor-textarea"\r\n\r\n');r={escape:1};w=[];j=q.resolve(["textareaAttrs"]);w.push(j);r.params=w;r.fn=function(f,i){i.write("\r\n");
var j=f.resolve(["xindex"]);i.write(j,!0);i.write('="');j=f.resolve(["this"]);i.write(j,!0);i.write('"\r\n');return i};k=i.call(this,q,r,k,19,t);k.write("\r\n\r\n");i={escape:1};r=[];w=q.resolve(["mode"]);r.push(w);i.params=r;i.fn=function(f,i){i.write('\r\nstyle="display:none"\r\n');return i};k=f.call(this,q,i,k,23,t);k.write("\r\n\r\n>");t=q.resolve(["data"]);k.write(t,!0);k.write('</textarea>\r\n\r\n</div>\r\n\r\n<div class="');q=q.resolve(["prefixCls"]);k.write(q,!0);k.write('editor-status">\r\n\r\n</div>');
return k};k.TPL_NAME=u.name;return k});
KISSY.add("editor/utils",["node","./base"],function(l,k){var v=k("node"),u=k("./base"),q=l.require("dom"),y=l.UA,t={debugUrl:function(f){var i=l.Config;i.debug&&(f=f.replace(/\.(js|css)/i,"-debug.$1"));-1===f.indexOf("?t")&&(f=-1!==f.indexOf("?")?f+"&":f+"?",i.tag&&(f+="t="+encodeURIComponent(i.tag)));return l.config("base")+"editor/"+f},lazyRun:function(f,i,r){var l=f[i],j=f[r];f[i]=function(){l.apply(this,arguments);f[i]=f[r];return j.apply(this,arguments)}},getXY:function(f,i){var r=f.left,l=f.top,
j=i.get("window")[0],r=r-q.scrollLeft(j),l=l-q.scrollTop(j),j=i.get("iframe").offset(),r=r+j.left,l=l+j.top;return{left:r,top:l}},tryThese:function(){for(var f,i=0,l=arguments.length;i<l;i++){var k=arguments[i];try{f=k();break}catch(j){}}return f},clearAllMarkers:function(f){for(var i in f)f[i]._4eClearMarkers(f,!0,void 0)},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(l.trim(f))},verifyInputs:function(f){for(var i=
0;i<f.length;i++){var r=new v(f[i]),k=l.trim(t.valInput(r)),j=r.attr("data-verify"),r=r.attr("data-warning");if(j&&!RegExp(j).test(k))return alert(r),!1}return!0},sourceDisable:function(f,i){f.on("sourceMode",i.disable,i);f.on("wysiwygMode",i.enable,i)},resetInput:function(f){var i=f.attr("placeholder");i&&y.ie?(f.addClass("ks-editor-input-tip"),f.val(i)):y.ie||f.val("")},valInput:function(f,i){if(void 0===i)return f.hasClass("ks-editor-input-tip")?"":f.val();f.removeClass("ks-editor-input-tip");
f.val(i)},placeholder:function(f,i){f.attr("placeholder",i);y.ie&&(f.on("blur",function(){l.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(i))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");l.trim(f.val())===i&&f.val("")}))},normParams:function(f){var f=l.clone(f),i;for(i in f){var r=f[i];"function"===typeof r&&(f[i]=r())}return f},preventFocus:function(f){y.ie?f.unselectable():f.attr("onmousedown","return false;")},injectDom:function(f){l.mix(q,f);for(var i in f)(function(i){v.prototype[i]=
function(){var k=[].slice.call(arguments,0);k.unshift(this[0]);return(k=f[i].apply(null,k))&&(k.nodeType||l.isWindow(k))?new v(k):l.isArray(k)&&(k.__IS_NODELIST||k[0]&&k[0].nodeType)?new v(k):k}})(i)},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,l.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],i=0;i<f.length;i++){var l=f[i];"function"===typeof l?l():l.destroy?l.destroy():l.remove&&l.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,
function(f,l){return l.toUpperCase()})+"Value"}};return u.Utils=t});
KISSY.add("editor/focus-manager",["./base"],function(l,k){function v(){var i=this;i.__iframeFocus=r;f=i;t&&clearTimeout(t);t=setTimeout(function(){i.fire("focus")},30)}function u(){var i=this;i.__iframeFocus=w;f=j;t&&clearTimeout(t);t=setTimeout(function(){i.fire("blur")},30)}var q=k("./base"),y={},t,f,i={currentInstance:function(){return f},getInstance:function(f){return y[f]},register:function(f){y[f.get("id")]=f},add:function(f){this.register(f);f.get("window").on("focus",v,f).on("blur",u,f)},
remove:function(f){delete y[f.get("id")];f.get("window").detach("focus",v,f).detach("blur",u,f)}},r=!0,w=!1,j=null;q.focusManager=i;q.getInstances=function(){return y};return i});
KISSY.add("editor/clipboard",["node","./base","./range","./selection"],function(l,k){function v(a){this.editor=a;this._init()}function u(a){var d=a.get("document")[0],b=a.getSelection(),c;if(b.getType()===w.SELECTION_ELEMENT&&(c=b.getSelectedElement())){var a=b.getRanges()[0],g=j(d.createTextNode(""));g.insertBefore(c);a.setStartBefore(g);a.setEndAfter(c);b.selectRanges([a]);setTimeout(function(){c.parent()&&(g.remove(),b.selectElement(c))},0)}}function q(a){if(s.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(s.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(s.gecko||s.opera){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function y(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(s.webkit&&-1<a.indexOf("<div>"))a.match(/<div>(?:<br>)?<\/div>/)&&(a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"}),a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")),a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"));else if(s.gecko||s.opera)s.gecko&&(a=a.replace(/^<br><br>$/,"<br>")),-1<a.indexOf("<br><br>")&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>");return a}function t(a){var d=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,
"");-1!==a.indexOf("Apple-")&&(a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,d){return d.replace(/\t/g,Array(5).join("&nbsp;"))}),-1<a.indexOf('<br class="Apple-interchange-newline">')&&(d=1,a=a.replace(/<br class="Apple-interchange-newline">/,"")),a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1"));!d&&q(a)&&(a=y(a));return a}var f=k("node"),i=k("./base"),r=k("./range"),w=k("./selection"),j=f.all,
s=l.UA,p=11>s.ieMode,o=p?"beforepaste":"paste",b=i.RangeType;l.augment(v,{_init:function(){var a=this,d=a.editor,b=d.get("document"),c=b.one("body"),g=function(a){this.type=a};g.prototype={exec:function(d){var b=this.type;d.focus();setTimeout(function(){p&&("cut"===b?u(d):"paste"===b&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));e(d,b)||alert(h[b])},0)}};c.on(o,a._getClipboardDataFromPasteBin,a);p&&(c.on("paste",a._iePaste,a),b.on("keydown",a._onKeyDown,a),b.on("contextmenu",function(){a._isPreventBeforePaste=
1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));d.addCommand("copy",new g("copy"));d.addCommand("cut",new g("cut"));d.addCommand("paste",new g("paste"))},_onKeyDown:function(a){this.editor.get("mode")===i.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86===a.keyCode||a.shiftKey&&45===a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,b=this.editor;if("paste"===a){this._isPreventBeforePaste=1;try{d=b.get("document")[0].queryCommandEnabled(a)}catch(c){}this._isPreventBeforePaste=
0}else d=(a=(a=b.getSelection())&&a.getRanges())&&!(1===a.length&&a[0].collapsed);return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;this._isPreventPaste||(a.preventDefault(),d.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,d=a.get("document")[0];if(!d.getElementById("ke-paste-bin")){var c=
a.getSelection(),g=new r(d),e=j(s.webkit?"<body></body>":"<div></div>",d);e.attr("id","ke-paste-bin");s.webkit&&e[0].appendChild(d.createTextNode("\u200b"));d.body.appendChild(e[0]);e.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var h=c.createBookmarks();g.setStartAt(e,b.POSITION_AFTER_START);g.setEndAt(e,b.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var d,b=e;e=s.webkit&&(d=e.first())&&d.hasClass("Apple-style-span")?
d:e;c.selectBookmarks(h);var g=e.html();b.remove();if(g=t(g))d=a.fire("paste",{html:g}),!1!==d&&(void 0!==d&&(g=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?l.use("editor/plugin/word-filter",function(n,d){a.insertHtml(d.toDataFormat(g,a))}):a.insertHtml(g))},0)}}}});var c=function(a,d){var b=a.get("document")[0],c=j(b.body),g=!1,e=function(){g=!0};c.on(d,e);(7<s.ieMode?b:b.selection.createRange()).execCommand(d);c.detach(d,e);return g},e=p?function(a,d){return c(a,d)}:function(a,
d){try{return a.get("document")[0].execCommand(d)}catch(b){return!1}},h={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},g={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var d;a.docReady(function(){d=new v(a)});var b={copy:1,cut:1,paste:1},c=["copy","cut","paste"];a.on("contextmenu",function(e){var h=e.contextmenu;if(!h.__copyFix){h.__copyFix=1;for(e=0;e<c.length;e++)h.addChild({content:g[c[e]],
value:c[e]});h.on("click",function(n){var d=n.target.get("value");b[d]&&(h.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var f=h.get("children"),e=f.length-1;e--;0<=e){var i=f[e],j;j=i.get?i.get("value"):i.value;b[j]&&(j=!d._stateFromNamedCommand(j),i.set?i.set("disabled",j):i.disabled=j)}})}}});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./element-path".split(","),function(l,k){function v(n){var d=n.nodeType!==h.NodeType.TEXT_NODE&&h.nodeName(n)in a.$removeEmpty,b=n.nodeType===h.NodeType.TEXT_NODE&&!l.trim(n.nodeValue),n=!!n.parentNode.getAttribute("_ke_bookmark");return d||b||n}function u(a){return!x(a)&&!E(a)}function q(a){var d=o;return function(b){if(E(b))return p;if(b.nodeType===h.NodeType.TEXT_NODE){if(l.trim(b.nodeValue).length)return o}else if(b.nodeType===h.NodeType.ELEMENT_NODE){b=
h.nodeName(b);if(!H[b])if(!a&&!g.ie&&b==="br"&&!d)d=p;else return o}return p}}function y(a,d){var b=a.startContainer,c=a.endContainer,g=a.startOffset,e=a.endOffset,f,D=o,j=o,l,x=a.document,O;d>0&&(l=x.createDocumentFragment());if(a.collapsed)return l;a.optimizeBookmark();if(c[0].nodeType===h.NodeType.TEXT_NODE){j=p;c=c._4eSplitText(e)}else if(c[0].childNodes.length>0)if(e>=c[0].childNodes.length){c=new i(c[0].appendChild(x.createTextNode("")));O=p}else c=new i(c[0].childNodes[e]);if(b[0].nodeType===
h.NodeType.TEXT_NODE){D=p;b._4eSplitText(g)}else if(g)if(g>=b[0].childNodes.length){b=new i(b[0].appendChild(x.createTextNode("")));f=p}else b=new i(b[0].childNodes[g].previousSibling);else{f=new i(x.createTextNode(""));b.prepend(f);b=f;f=p}var k=b._4eParents(),K=c._4eParents();k.each(function(a,d){k[d]=a});K.each(function(a,d){K[d]=a});for(var I,r,x=0;x<k.length;x++){I=k[x];r=K[x];if(!I.equals(r))break}for(var g=l,B,E,s=x;s<k.length;s++){B=k[s];e=d>0&&!B.equals(b)?g.appendChild(B.clone()[0]):null;
B=B[0].nextSibling;E=K[s];for(var q=c[0],A=E&&E[0];B;){if(A===B||q===B)break;E=B.nextSibling;if(d===2)g.appendChild(B.cloneNode(p));else{if(m[B.nodeName.toLowerCase()]){var w=B.cloneNode(p);B.innerHTML="";B=w}else h._4eRemove(B);d===1&&g.appendChild(B)}B=E}e&&(g=e)}for(g=l;x<K.length;x++){B=K[x];e=d>0&&!B.equals(c)?g.appendChild(B.clone()[0]):null;if(!k[x]||!B._4eSameLevel(k[x]))for(B=B[0].previousSibling;B;){E=B.previousSibling;if(d===2)g.insertBefore(B.cloneNode(p),g.firstChild);else{h._4eRemove(B);
d===1&&g.insertBefore(B,g.firstChild)}B=E}e&&(g=e)}if(d===2){if(D){I=b[0];if(I.nodeType===h.NodeType.TEXT_NODE&&I.nextSibling&&I.nextSibling.nodeType===h.NodeType.TEXT_NODE){I.data=I.data+I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}if(j){j=c[0];if(j.nodeType===h.NodeType.TEXT_NODE&&j.previousSibling&&j.previousSibling.nodeType===h.NodeType.TEXT_NODE){j.previousSibling.data=j.previousSibling.data+j.data;j.parentNode.removeChild(j)}}}else{if(I&&r&&(!b._4eSameLevel(I)||!c._4eSameLevel(r))){j=
I._4eIndex();f&&I._4eSameLevel(b)&&j--;a.setStart(I.parent(),j+1)}a.collapse(p)}f&&b.remove();O&&c.remove();return l}function t(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function f(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=b;this.collapsed=p;this.document=a}k("./dom");var i=k("node"),r=k("./utils"),w=k("./walker"),j=k("./base"),s=k("./element-path");j.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=true,o=false,b=null,c=j.RangeType,e=j.PositionType,h=l.require("dom"),g=l.UA,a=j.XHTML_DTD,d=i.all,m={td:1},D={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},x=new w.whitespaces,E=new w.bookmark,A=w.whitespaces(p),C=w.bookmark(false,true),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};l.augment(f,{toString:function(){var a=[],d=this.startContainer[0],b=this.endContainer[0];a.push((d.id||d.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,d=this.startOffset;a[0].nodeType!==h.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
d=this.endOffset;a[0].nodeType!==h.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);d&&d.nodeName()==="span"&&d.attr("_ke_bookmark")&&this.setEndAfter(d)},setStart:function(a,d){if(a[0].nodeType===h.NodeType.ELEMENT_NODE&&D[a.nodeName()]){a=a.parent();d=a._4eIndex()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}t(this)},setEnd:function(a,d){if(a[0].nodeType===h.NodeType.ELEMENT_NODE&&D[a.nodeName()]){a=a.parent();d=a._4eIndex()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=
a;this.startOffset=d}t(this)},setStartAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===h.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}t(this)},setEndAt:function(a,d){switch(d){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
h.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}t(this)},cloneContents:function(){return y(this,2)},deleteContents:function(){return y(this,0)},extractContents:function(){return y(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=p},clone:function(){var a=new f(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==h.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==h.NodeType.ELEMENT_NODE)return b;var d=new w(a);d.evaluator=function(a){return A(a)&&C(a)};a=d.next();d.reset();
d=d.previous();return a&&a.equals(d)?a:b},shrink:function(a,d){if(!this.collapsed){var a=a||c.SHRINK_TEXT,b=this.clone(),g=this.startContainer,e=this.endContainer,m=this.startOffset,f=this.endOffset,i=p,j,D,x=p;if(g&&g[0].nodeType===h.NodeType.TEXT_NODE)if(m)if(m>=g[0].nodeValue.length)b.setStartAfter(g);else{b.setStartBefore(g);i=o}else b.setStartBefore(g);if(e&&e[0].nodeType===h.NodeType.TEXT_NODE)if(f)if(f>=e[0].nodeValue.length)b.setEndAfter(e);else{b.setEndAfter(e);x=o}else b.setEndBefore(e);
if(i||x){D=new w(b);D.evaluator=function(d){return d.nodeType===(a===c.SHRINK_ELEMENT?h.NodeType.ELEMENT_NODE:h.NodeType.TEXT_NODE)};D.guard=function(d,b){if(a===c.SHRINK_ELEMENT&&d.nodeType===h.NodeType.TEXT_NODE||b&&d===j)return o;!b&&d.nodeType===h.NodeType.ELEMENT_NODE&&(j=d);return p}}if(i)(b=D[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(b,d?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(x){D.reset();(D=D[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(D,
d?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return i||x}},createBookmark2:function(a){var d=this.startContainer,c=this.endContainer,g=this.startOffset,e=this.endOffset,m,f;if(!d||!c)return{start:0,end:0};if(a){if(d[0].nodeType===h.NodeType.ELEMENT_NODE)if((m=new i(d[0].childNodes[g]))&&m[0]&&m[0].nodeType===h.NodeType.TEXT_NODE&&g>0&&m[0].previousSibling.nodeType===h.NodeType.TEXT_NODE){d=m;g=0}for(;d[0].nodeType===h.NodeType.TEXT_NODE&&(f=d.prev(void 0,1))&&f[0].nodeType===h.NodeType.TEXT_NODE;){d=
f;g=g+f[0].nodeValue.length}if(!this.collapsed){if(c[0].nodeType===h.NodeType.ELEMENT_NODE)if((m=new i(c[0].childNodes[e]))&&m[0]&&m[0].nodeType===h.NodeType.TEXT_NODE&&e>0&&m[0].previousSibling.nodeType===h.NodeType.TEXT_NODE){c=m;e=0}for(;c[0].nodeType===h.NodeType.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType===h.NodeType.TEXT_NODE;){c=f;e=e+f[0].nodeValue.length}}}return{start:d._4eAddress(a),end:this.collapsed?b:c._4eAddress(a),startOffset:g,endOffset:e,normalized:a,is2:p}},createBookmark:function(a){var d,
g,e,m,f=this.collapsed;d=new i("<span>",b,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");if(a){e=l.guid("ke_bm_");d.attr("id",e+"S")}if(!f){g=d.clone();g.html("&nbsp;");a&&g.attr("id",e+"E");m=this.clone();m.collapse();m.insertNode(g)}m=this.clone();m.collapse(p);m.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,c.POSITION_AFTER_END);return{startNode:a?e+"S":d,endNode:a?e+"E":g,serializable:a,collapsed:f}},moveToPosition:function(a,
d){this.setStartAt(a,d);this.collapse(p)},trim:function(a,d){var b=this.startContainer,c=this.startOffset,g=this.collapsed;if((!a||g)&&b[0]&&b[0].nodeType===h.NodeType.TEXT_NODE){if(c)if(c>=b[0].nodeValue.length){c=b._4eIndex()+1;b=b.parent()}else{var e=b._4eSplitText(c),c=b._4eIndex()+1,b=b.parent();if(h.equals(this.startContainer,this.endContainer))this.setEnd(e,this.endOffset-this.startOffset);else if(h.equals(b,this.endContainer))this.endOffset=this.endOffset+1}else{c=b._4eIndex();b=b.parent()}this.setStart(b,
c);if(g){this.collapse(p);return}}b=this.endContainer;c=this.endOffset;if(!d&&!g&&b[0]&&b[0].nodeType===h.NodeType.TEXT_NODE){if(c){c>=b[0].nodeValue.length||b._4eSplitText(c);c=b._4eIndex()+1}else c=b._4eIndex();b=b.parent();this.setEnd(b,c)}},insertNode:function(a){this.optimizeBookmark();this.trim(o,p);var d=this.startContainer;d[0].insertBefore(a[0],d[0].childNodes[this.startOffset]||null);d[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=d(this.document);
if(a.is2){var c=b._4eGetByAddress(a.start,a.normalized),g=a.startOffset,b=a.end&&b._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,g);b?this.setEnd(b,a):this.collapse(p)}else{c=(g=a.serializable)?l.one("#"+a.startNode,b):a.startNode;a=g?l.one("#"+a.endNode,b):a.endNode;this.setStartBefore(c);c._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(p)}},getCommonAncestor:function(a,d){var b=this.startContainer,c=this.endContainer,b=b[0]===c[0]?a&&b[0].nodeType===
h.NodeType.ELEMENT_NODE&&this.startOffset===this.endOffset-1?new i(b[0].childNodes[this.startOffset]):b:b._4eCommonAncestor(c);return d&&b[0].nodeType===h.NodeType.TEXT_NODE?b.parent():b},enlarge:function(){function a(b,c,g,e){var m=b[c?"startContainer":"endContainer"],n,f=c?0:1,i=0,j=c?"previousSibling":"nextSibling";n=b[c?"startOffset":"endOffset"];if(m[0].nodeType===h.NodeType.TEXT_NODE){if(c){if(n)return}else if(n<m[0].nodeValue.length)return;n=m[0][j];m=m[0].parentNode}else{n=m[0].childNodes[n+
(c?-1:1)]||null;m=m[0]}for(;m;){for(;n;)if(x(n)||E(n))n=n[j];else break;if(n){if(!i)b[c?"setStartAfter":"setEndBefore"](d(n));break}m=d(m);if(m.nodeName()==="body")break;if(i||m.equals(e)){g[f]=m;i=1}else b[c?"setStartBefore":"setEndAfter"](m);n=m[0][j];m=m[0].parentNode}}return function(g){var e;switch(g){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var g=this.getCommonAncestor(),m=[];a(this,1,m,g);a(this,0,m,g);if(m[0]&&m[1]){g=m[0].contains(m[1])?m[1]:m[0];this.setStartBefore(g);this.setEndAfter(g)}break;
case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:e=new f(this.document);m=new i(this.document.body);e.setStartAt(m,c.POSITION_AFTER_START);e.setEnd(this.startContainer,this.startOffset);e=new w(e);var j,D,x=w.blockBoundary(g===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:b),l=function(a){var b=x(a);b||(j=d(a));return b},k=function(a){var b=l(a);!b&&h.nodeName(a)==="br"&&(D=d(a));return b};e.guard=l;e=e.lastBackward();j=j||m;this.setStartAt(j,j.nodeName()!=="br"&&(!e&&this.checkStartOfBlock()||
e&&j.contains(e))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);e=this.clone();e.collapse();e.setEndAt(m,c.POSITION_BEFORE_END);e=new w(e);e.guard=g===c.ENLARGE_LIST_ITEM_CONTENTS?k:l;j=b;e=e.lastForward();j=j||m;this.setEndAt(j,!e&&this.checkEndOfBlock()||e&&j.contains(e)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);D&&this.setEndAfter(D)}}}(),checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType===h.NodeType.TEXT_NODE&&l.trim(a[0].nodeValue.substring(0,d)).length)return o;
this.trim();a=new s(this.startContainer);d=this.clone();d.collapse(p);d.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new w(d);a.evaluator=q(p);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType===h.NodeType.TEXT_NODE&&l.trim(a[0].nodeValue.substring(d)).length)return o;this.trim();a=new s(this.endContainer);d=this.clone();d.collapse(o);d.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new w(d);a.evaluator=q(o);return a.checkForward()},
checkBoundaryOfElement:function(a,d){var b=this.clone();b[d===c.START?"setStartAt":"setEndAt"](a,d===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new w(b);b.evaluator=v;return b[d===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,m;if(a[0].nodeType===h.NodeType.ELEMENT_NODE){m=a[0].childNodes.length;if(m>c)a=d(a[0].childNodes[c]);else if(m===0)a=a._4ePreviousSourceNode();else{for(a=
a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4eNextSourceNode()||a}}if(b[0].nodeType===h.NodeType.ELEMENT_NODE){m=b[0].childNodes.length;if(m>g)b=d(b[0].childNodes[g])._4ePreviousSourceNode(p);else if(m===0)b=b._4ePreviousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}}a._4ePosition(b)&e.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var e=this.createBookmark(),m=d(this.document.createElement(b));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);
m[0].appendChild(this.extractContents());m._4eTrim();g.ie||m._4eAppendBogus();this.insertNode(m);this.moveToBookmark(e);return m},splitBlock:function(a){var d=new s(this.startContainer),e=new s(this.endContainer),m=d.block,f=e.block,h=b;if(!d.blockLimit.equals(e.blockLimit))return b;if(a!=="br"){if(!m){m=this.fixBlock(p,a);f=(new s(this.endContainer)).block}f||(f=this.fixBlock(o,a))}a=m&&this.checkStartOfBlock();d=f&&this.checkEndOfBlock();this.deleteContents();if(m&&m[0]===f[0])if(d){h=new s(this.startContainer);
this.moveToPosition(f,c.POSITION_AFTER_END);f=b}else if(a){h=new s(this.startContainer);this.moveToPosition(m,c.POSITION_BEFORE_START);m=b}else{f=this.splitElement(m);!g.ie&&!l.inArray(m.nodeName(),["ul","ol"])&&m._4eAppendBogus()}return{previousBlock:m,nextBlock:f,wasStartOfBlock:a,wasEndOfBlock:d,elementPath:h}},splitElement:function(a){if(!this.collapsed)return b;this.setEndAt(a,c.POSITION_BEFORE_END);var d=this.extractContents(),g=a.clone(o);g[0].appendChild(d);g.insertAfter(a);this.moveToPosition(a,
c.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(a,d){for(var b=0;a;){if(a[0].nodeType===h.NodeType.TEXT_NODE){this.moveToPosition(a,d?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);b=1;break}if(a[0].nodeType===h.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,d?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);b=1}var g=a,e=b,m=void 0;g[0].nodeType===h.NodeType.ELEMENT_NODE&&g._4eIsEditable()&&(m=g[d?"last":"first"](u,1));!e&&!m&&(m=g[d?"prev":"next"](u,1));a=m}return!!b},
selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,d.nodeType===h.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(d){var b,c,g,e=d.nodeName();b=a.$block[e];this.deleteContents();if(b){for(b=this.getCommonAncestor(o,p);(c=a[b.nodeName()])&&(!c||!c[e]);){var m=b.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(b);this.collapse(p);b.remove()}else g=b;b=m}g&&this.splitElement(g)}this.insertNode(d)}});r.injectDom({_4eBreakParent:function(a,
b){var b=d(b),a=d(a),c,g=new j.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);c=g.extractContents();g.insertNode(a.remove());a.after(c)}});return j.Range=f});
KISSY.add("editor/dom",["node","./base","./utils"],function(l,k){function v(b,c){var e=b[c?"next":"prev"](void 0,1);if(e&&e[0].nodeType===i.ELEMENT_NODE){for(var f=[];e.attr("_ke_bookmark")||e._4eIsEmptyInlineRemovable(void 0);)if(f.push(e),e=c?e.next(void 0,1):e.prev(void 0,1),!e)return;if(b._4eIsIdentical(e,void 0)){for(var g=new u(c?b[0].lastChild:b[0].firstChild);f.length;)f.shift()._4eMove(b,!c,void 0);e._4eMoveChildren(b,!c,void 0);e.remove();g[0]&&g[0].nodeType===i.ELEMENT_NODE&&g._4eMergeSiblings()}}}
var u=k("node"),q=k("./base"),y=k("./utils"),t=q.XHTML_DTD,f=l.require("dom"),i=f.NodeType,r=l.UA,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var j=q.PositionType,s={block:1,"list-item":1,table:1,"table-row-group":1,
"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},p={hr:1},o=function(b){return b&&(b[0]||b)};y.injectDom({_4eSameLevel:function(b,c){var c=o(c),e=b.parentNode;return e&&e===c.parentNode},_4eIsBlockBoundary:function(b,c){var e=l.merge(p,c);return!(!s[f.css(b,"display")]&&!e[f.nodeName(b)])},_4eIndex:function(b,c){for(var e=b.parentNode.childNodes,f,g=-1,a=0;a<e.length;a++)if(f=e[a],!c||!(3===f.nodeType&&f.previousSibling&&
3===f.previousSibling.nodeType))if(g++,f===b)return g;return-1},_4eMove:function(b,c,e){c=o(c);e?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4eIsIdentical:function(b,c){if(!c)return!1;c=o(c);if(f.nodeName(b)!==f.nodeName(c))return!1;var e=b.attributes,h,g,a=c.attributes,d=e.length,m=a.length;if(d!==m)return!1;for(var i=0;i<d;i++)if(h=e[i],g=h.name,h.specified&&f.attr(b,g)!==f.attr(c,g))return!1;if(8>r.ieMode)for(i=0;i<m;i++)if(h=a[i],g=h.name,h.specified&&f.attr(b,g)!==f.attr(c,g))return!1;
return!0},_4eIsEmptyInlineRemovable:function(b){if(!t.$removeEmpty[f.nodeName(b)])return!1;for(var b=b.childNodes,c=0,e=b.length;c<e;c++){var h=b[c],g=h.nodeType;if(!(g===i.ELEMENT_NODE&&h.getAttribute("_ke_bookmark"))&&(g===i.ELEMENT_NODE&&!f._4eIsEmptyInlineRemovable(h)||g===f.NodeType.TEXT_NODE&&l.trim(h.nodeValue)))return!1}return!0},_4eMoveChildren:function(b,c,e){c=o(c);if(b!==c)if(e)for(;e=b.lastChild;)c.insertBefore(b.removeChild(e),c.firstChild);else for(;e=b.firstChild;)c.appendChild(b.removeChild(e))},
_4eMergeSiblings:function(b){b=new u(b);w[b.nodeName()]&&(v(b,!0),v(b))},_4eSplitText:function(b,c){var e=b.ownerDocument;if(b.nodeType===f.NodeType.TEXT_NODE){if(r.ie&&c===b.nodeValue.length){var h=e.createTextNode("");f.insertAfter(h,b);return h}h=b.splitText(c);e.documentMode&&(e=e.createTextNode(""),f.insertAfter(e,h),f.remove(e));return h}},_4eParents:function(b,c){var e=[];e.__IS_NODELIST=1;do e[c?"push":"unshift"](b);while(b=b.parentNode);return e},_4eNextSourceNode:function(b,c,e,h){if(h&&
!h.call)var g=o(h),h=function(a){return a!==g};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType===i.ELEMENT_NODE&&h&&!1===h(b,!0))return null;c=b.nextSibling}for(;!c&&(a=a.parentNode);){if(h&&!1===h(a,!0))return null;c=a.nextSibling}return!c||h&&!1===h(c)?null:e&&e!==c.nodeType?f._4eNextSourceNode(c,!1,e,h):c},_4ePreviousSourceNode:function(b,c,e,h){if(h&&!h.call)var g=o(h),h=function(a){return a!==g};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType===i.ELEMENT_NODE&&h&&!1===h(b,!0))return null;c=b.previousSibling}for(;!c&&
(a=a.parentNode);){if(h&&!1===h(a,!0))return null;c=a.previousSibling}return!c||h&&!1===h(c)?null:e&&c.nodeType!==e?f._4ePreviousSourceNode(c,!1,e,h):c},_4eCommonAncestor:function(b,c){c=o(c);if(b===c)return b;if(f.contains(c,b))return c;var e=b;do if(f.contains(e,c))return e;while(e=e.parentNode);return null},_4eHasAttributes:9>r.ieMode?function(b){for(var c=b.attributes,e=0;e<c.length;e++){var f=c[e];switch(f.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(f.specified)return!0}}return!1}:
function(b){r.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4ePosition:function(b,c){var e=o(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(e);if(b===e)return j.POSITION_IDENTICAL;if(b.nodeType===i.ELEMENT_NODE&&e.nodeType===i.ELEMENT_NODE){if(f.contains(b,e))return j.POSITION_CONTAINS+j.POSITION_PRECEDING;if(f.contains(e,b))return j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>e.sourceIndex?j.POSITION_DISCONNECTED:
b.sourceIndex<e.sourceIndex?j.POSITION_PRECEDING:j.POSITION_FOLLOWING}for(var h=f._4eAddress(b),e=f._4eAddress(e),g=Math.min(h.length,e.length),a=0;a<=g-1;a++)if(h[a]!==e[a])return h[a]<e[a]?j.POSITION_PRECEDING:j.POSITION_FOLLOWING;return h.length<e.length?j.POSITION_CONTAINS+j.POSITION_PRECEDING:j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING},_4eAddress:function(b,c){for(var e=[],h=b.ownerDocument.documentElement,g=b;g&&g!==h;)e.unshift(f._4eIndex(g,c)),g=g.parentNode;return e},_4eRemove:function(b,
c){var e=b.parentNode;if(e){if(c)for(var f;f=b.firstChild;)e.insertBefore(b.removeChild(f),b);e.removeChild(b)}return b},_4eTrim:function(b){f._4eLtrim(b);f._4eRtrim(b)},_4eLtrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType===f.NodeType.TEXT_NODE){var e=y.ltrim(c.nodeValue),h=c.nodeValue.length;if(e)e.length<h&&(f._4eSplitText(c,h-e.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4eRtrim:function(b){for(var c;c=b.lastChild;){if(c.type===f.NodeType.TEXT_NODE){var e=
y.rtrim(c.nodeValue),h=c.nodeValue.length;if(e)e.length<h&&(f._4eSplitText(c,e.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!r.ie&&!r.opera&&(c=b.lastChild)&&1===c.nodeType&&"br"===f.nodeName(c)&&b.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===f.NodeType.TEXT_NODE&&!l.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===f.NodeType.TEXT_NODE||"br"!==f.nodeName(c))c=r.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),
b.appendChild(c)},_4eSetMarker:function(b,c,e,f){var b=new u(b),g=b.data("list_marker_id")||b.data("list_marker_id",l.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[g]=b;a[e]=1;return b.data(e,f)},_4eClearMarkers:function(b,c,e){var b=new u(b),f=b.data("list_marker_names"),g=b.data("list_marker_id"),a;for(a in f)b.removeData(a);b.removeData("list_marker_names");e&&(b.removeData("list_marker_id"),delete c[g])},_4eCopyAttributes:function(b,
c,e){for(var c=new u(c),h=b.attributes,e=e||{},g=0;g<h.length;g++){var a=h[g],d=a.name.toLowerCase(),m;if(!(d in e))if("checked"===d&&(m=f.attr(b,d)))c.attr(d,m);else if(a.specified||r.ie&&a.value&&"value"===d)m=f.attr(b,d),null===m&&(m=a.nodeValue),c.attr(d,m)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},_4eIsEditable:function(b){b=f.nodeName(b);return(b=!t.$nonEditable[b]&&(t[b]||t.span))&&b["#text"]},_4eGetByAddress:function(b,c,e){for(var b=b.documentElement,f=0;b&&f<c.length;f++){var g=
c[f];if(e)for(var a=-1,d=0;d<b.childNodes.length;d++){var m=b.childNodes[d];if(!(!0===e&&3===m.nodeType&&m.previousSibling&&3===m.previousSibling.nodeType)&&(a++,a===g)){b=m;break}}else b=b.childNodes[g]}return b}})});
KISSY.add("editor/walker",["./base","node"],function(l,k){function v(b,c){if(this._.end)return i;var g,a=this.range,d,m=this.guard,j=this.type,x=b?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),i;if(!b&&!this._.guardLTR){var l=a.endContainer[0],k=l.childNodes[a.endOffset];this._.guardLTR=function(a,d){return d&&(l===a||"body"===w.nodeName(a))?!1:a!==k}}if(b&&!this._.guardRTL){var o=a.startContainer[0],r=0<a.startOffset&&o.childNodes[a.startOffset-
1]||null;this._.guardRTL=function(a,d){return d&&(o===a||"body"===w.nodeName(a))?!1:a!==r}}var n=b?this._.guardRTL:this._.guardLTR;d=m?function(a,d){return n(a,d)===f?f:m(a,d)}:n;this.current?g=this.current[x](f,j,d):b?(g=a.endContainer,0<a.endOffset?(g=new s(g[0].childNodes[a.endOffset-1]),d(g[0])===f&&(g=i)):g=d(g,t)===f?i:g._4ePreviousSourceNode(t,j,d,void 0)):(g=a.startContainer,g=new s(g[0].childNodes[a.startOffset]),g.length?d(g[0])===f&&(g=i):g=d(a.startContainer,t)===f?i:a.startContainer._4eNextSourceNode(t,
j,d,void 0));for(;g&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g[0])!==f){if(!c)return g}else if(c&&this.evaluator)return f;g=g[x](f,j,d)}this.end();return this.current=i}function u(b){for(var c,g=i;c=v.call(this,b);)g=c;return g}function q(b){this.range=b;this.guard=this.evaluator=i;this._={}}var y=k("./base"),t=!0,f=!1,i=null,r=l.UA,w=l.require("dom"),j=y.XHTML_DTD,s=k("node");l.augment(q,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,
t)},checkForward:function(){return v.call(this,f,t)!==f},checkBackward:function(){return v.call(this,t,t)!==f},lastForward:function(){return u.call(this)},lastBackward:function(){return u.call(this,t)},reset:function(){delete this.current;this._={}},_iterator:v});l.mix(q,{blockBoundary:function(b){return function(c){return!(c.nodeType===w.NodeType.ELEMENT_NODE&&w._4eIsBlockBoundary(c,b))}},bookmark:function(b,c){function g(a){return"span"===w.nodeName(a)&&w.attr(a,"_ke_bookmark")}return function(a){var d,
m;d=a.nodeType===w.NodeType.TEXT_NODE&&(m=a.parentNode)&&g(m);d=b?d:d||g(a);return!!(c^d)}},whitespaces:function(b){return function(c){c=c.nodeType===w.NodeType.TEXT_NODE&&!l.trim(c.nodeValue);return!!(b^c)}},invisible:function(b){var c=q.whitespaces();return function(g){g=c(g)||g.nodeType===w.NodeType.ELEMENT_NODE&&!g.offsetHeight;return!!(b^g)}}});var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,o=q.whitespaces(),b=q.bookmark(),c=function(c){var f=w.nodeName(c);return b(c)||o(c)||1===c.nodeType&&f in j.$inline&&
!(f in j.$empty)};y.Utils.injectDom({_4eGetBogus:function(b){b=new s(b);do b=b._4ePreviousSourceNode();while(b&&c(b[0]));return b&&(!r.ie?"br"===b.nodeName():3===b[0].nodeType&&p.test(b.text()))?b[0]:!1}});return y.Walker=q});
KISSY.add("editor/element-path",["node","./base","./dom"],function(l,k){function v(l){for(var k=t,j=t,s=[];l;){if(l[0].nodeType===q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=l);var p=l.nodeName();if(!j&&(!k&&f[p]&&(k=l),i[p])){var o;if(o=!k)if(o="div"===p){a:{o=l[0].childNodes;for(var b=0,c=o.length;b<c;b++){var e=o[b];if(e.nodeType===q.NodeType.ELEMENT_NODE&&y.$block[e.nodeName.toLowerCase()]){o=!0;break a}}o=!1}o=!o}o?k=l:j=l}s.push(l);if("body"===p)break}l=l.parent()}this.block=
k;this.blockLimit=j;this.elements=s}k("node");var u=k("./base");k("./dom");var q=l.require("dom"),y=u.XHTML_DTD,t=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={constructor:v,compare:function(f){var i=this.elements,f=f&&f.elements;if(!f||i.length!==f.length)return!1;for(var j=0;j<i.length;j++)if(!q.equals(i[j],f[j]))return!1;return!0},contains:function(f){for(var i=this.elements,
j=0;j<i.length;j++)if(i[j].nodeName()in f)return i[j];return t},toString:function(){var f=this.elements,i,j=[];for(i=0;i<f.length;i++)j.push(f[i].nodeName());return j.toString()}};return u.ElementPath=v});
KISSY.add("editor/selection",["node","./walker","./range","./base"],function(l,k){function v(b){this.document=b;this._={cache:{}};if(o)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!==b||a.parentElement&&a.parentElement().ownerDocument!==b)this.isInvalid=i}catch(d){this.isInvalid=i}}function u(b){b=new v(b);return!b||b.isInvalid?r:b}var q=k("node"),y=k("./walker"),t=k("./range"),f=k("./base");f.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};
var i=!0,r=null,w=l.UA,j=l.require("dom"),s=f.SelectionType,p=f.RangeType,o=document.selection,b={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};l.augment(v,{getNative:!o?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=j.getWindow(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!o?function(){var c=this._.cache;
if(c.type)return c.type;var a=s.SELECTION_TEXT,d=this.getNative();if(d){if(1===d.rangeCount){var d=d.getRangeAt(0),m=d.startContainer;m===d.endContainer&&m.nodeType===j.NodeType.ELEMENT_NODE&&1===Number(d.endOffset-d.startOffset)&&b[m.childNodes[d.startOffset].nodeName.toLowerCase()]&&(a=s.SELECTION_ELEMENT)}}else a=s.SELECTION_NONE;return c.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=s.SELECTION_NONE;try{var d=this.getNative(),c=d.type;"Text"===c&&(a=s.SELECTION_TEXT);"Control"===
c&&(a=s.SELECTION_ELEMENT);d.createRange().parentElement&&(a=s.SELECTION_TEXT)}catch(e){}return b.type=a},getRanges:o?function(){var b=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),g=c.childNodes,e,f=0;f<g.length;f++){var i=g[f];if(i.nodeType===j.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(i);var i=e.compareEndPoints("StartToStart",a),h=e.compareEndPoints("EndToStart",a);e.collapse();if(0<i)break;else{if(!i||1===h&&-1===i)return{container:c,offset:f};if(!h)return{container:c,
offset:f+1}}e=r}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=g[--f].nodeValue.length}catch(l){e=0}return 0===e?{container:c,offset:f}:{container:g[f],offset:-e}};return function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var c=this.getNative(),a=c&&c.createRange(),e=this.getType();if(!c)return[];if(e===s.SELECTION_TEXT)return c=new t(this.document),e=b(a,i),c.setStart(new q(e.container),
e.offset),e=b(a),c.setEnd(new q(e.container),e.offset),d.ranges=[c],[c];if(e===s.SELECTION_ELEMENT){d=d.ranges=[];for(e=0;e<a.length;e++){for(var f=a.item(e),j=f.parentNode,h=0,c=new t(this.document);h<j.childNodes.length&&j.childNodes[h]!==f;h++);c.setStart(new q(j),h);c.setEnd(new q(j),h+1);d.push(c)}return d}d.ranges=[];return[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],d=this.getNative();if(!d)return[];for(var c=0;c<d.rangeCount;c++){var e=d.getRangeAt(c),f=new t(this.document);
f.setStart(new q(e.startContainer),e.startOffset);f.setEnd(new q(e.endContainer),e.endOffset);b.push(f)}return a.ranges=b},getStartElement:function(){var b=this._.cache;if(void 0!==b.startElement)return b.startElement;var a,d=this.getNative();switch(this.getType()){case s.SELECTION_ELEMENT:return this.getSelectedElement();case s.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();i;)if(a=c.startContainer,c.startOffset===(a[0].nodeType===j.NodeType.ELEMENT_NODE?a[0].childNodes.length:
a[0].nodeValue.length)&&!a._4eIsBlockBoundary())c.setStartAfter(a);else break;a=c.startContainer;if(a[0].nodeType!==j.NodeType.ELEMENT_NODE)return a.parent();a=new q(a[0].childNodes[c.startOffset]);if(!a[0]||a[0].nodeType!==j.NodeType.ELEMENT_NODE)return c.startContainer;for(c=a[0].firstChild;c&&c.nodeType===j.NodeType.ELEMENT_NODE;)a=new q(c),c=c.firstChild;return a}if(o)c=d.createRange(),c.collapse(i),a=new q(c.parentElement());else{if((a=d.anchorNode)&&a.nodeType!==j.NodeType.ELEMENT_NODE)a=a.parentNode;
a&&(a=new q(a))}}return b.startElement=a},getSelectedElement:function(){var c,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;o&&(c=this.getNative().createRange(),c=c.item&&c.item(0));var d;if(c)d=new q(c);else{c=this.getRanges()[0];for(var e,f=2;f&&(!(d=c.getEnclosedNode())||!(d[0].nodeType===j.NodeType.ELEMENT_NODE&&b[d.nodeName()]&&(e=d)));f--)c.shrink(p.SHRINK_ELEMENT);d=e}c=d;return a.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(b){var a,d=
this.document;if(o)try{a=d.body.createControlRange(),a.addElement(b[0]),a.select()}catch(c){a=d.body.createTextRange(),a.moveToElementText(b[0]),a.select()}finally{}else a=d.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);this.reset()},selectRanges:function(b){if(o){if(1<b.length){var a=b[b.length-1];b[0].setEnd(a.endContainer,a.endOffset);b.length=1}b[0]&&b[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var d=0;d<b.length;d++){var c=
b[d],e=this.document.createRange(),f=c.startContainer;if(c.collapsed&&(w.gecko&&1.09>w.gecko||w.opera||w.webkit)&&f[0].nodeType===j.NodeType.ELEMENT_NODE&&!f[0].childNodes.length)f[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":"")),c.startOffset++,c.endOffset++;e.setStart(f[0],c.startOffset);e.setEnd(c.endContainer[0],c.endOffset);a.addRange(e)}}this.reset()},createBookmarks2:function(b){for(var a=[],d=this.getRanges(),c=0;c<d.length;c++)a.push(d[c].createBookmark2(b));return a},createBookmarks:function(b,
a){for(var d=[],c=this.document,e,a=a||this.getRanges(),f=a.length,h=0;h<f;h++){d.push(e=a[h].createBookmark(b,i));var k=(b=e.serializable)?l.one("#"+e.startNode,c):e.startNode;e=b?l.one("#"+e.endNode,c):e.endNode;for(var o=h+1;o<f;o++){var s=a[o],n=s.startContainer,q=s.endContainer;j.equals(n,k.parent())&&s.startOffset++;j.equals(n,e.parent())&&s.startOffset++;j.equals(q,k.parent())&&s.endOffset++;j.equals(q,e.parent())&&s.endOffset++}}return d},selectBookmarks:function(b){for(var a=[],d=0;d<b.length;d++){var c=
new t(this.document);c.moveToBookmark(b[d]);a.push(c)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4eCommonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var b=this.getNative();o?b&&b.clear():b&&b.removeAllRanges()}});var c={table:1,tbody:1,tr:1},e=y.whitespaces(i),
h=/\ufeff|\u00a0/;t.prototype.select=!o?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType===j.NodeType.ELEMENT_NODE&&!b[0].childNodes.length&&(b[0].appendChild(this.document.createTextNode(w.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(i),a.setEnd(this.endContainer[0],this.endOffset);
else throw d;}b=u(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,d,f;if(this.startContainer[0]===this.endContainer[0]&&1===this.endOffset-this.startOffset){var l=this.startContainer[0].childNodes[this.startOffset];if(l.nodeType===j.NodeType.ELEMENT_NODE){(new v(this.document)).selectElement(new q(l));return}}(this.startContainer[0].nodeType===j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===j.NodeType.ELEMENT_NODE&&
this.endContainer.nodeName()in c)&&this.shrink(p.SHRINK_ELEMENT,i);var k=this.createBookmark(),l=k.startNode,o;a||(o=k.endNode);k=this.document.body.createTextRange();k.moveToElementText(l[0]);k.moveStart("character",1);if(o)b=this.document.body.createTextRange(),b.moveToElementText(o[0]),k.setEndPoint("EndToEnd",b),k.moveEnd("character",-1);else{for(d=l[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(h))&&(b||!l[0].previousSibling||l[0].previousSibling&&"br"===j.nodeName(l[0].previousSibling));
f=new q(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(l);d&&j.insertBefore(this.document.createTextNode("\ufeff"),l[0]||l)}this.setStartBefore(l);l._4eRemove();if(a){if(d?(k.moveStart("character",-1),k.select(),this.document.selection.clear()):k.select(),f)this.moveToPosition(f,p.POSITION_BEFORE_START),f._4eRemove()}else this.setEndBefore(o),o._4eRemove(),k.select()};v.getSelection=u;return f.Selection=v});
KISSY.add("editor/enter-key",["node","./walker","./base","./element-path"],function(l,k){function v(j){var k;k=j.getSelection().getRanges();for(var p=k.length-1;0<p;p--)k[p].deleteContents();k=k[0];p=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var o=(new f(k.startContainer)).block;if(o&&("li"===o.nodeName()||"li"===o.parent().nodeName()))return j.hasCommand("outdent")?(j.execCommand("save"),j.execCommand("outdent"),j.execCommand("save"),!0):!1}var b=k.splitBlock("p");if(!b)return!0;
var j=b.previousBlock,o=b.nextBlock,c=b.wasStartOfBlock,e=b.wasEndOfBlock,h;if(o)h=o.parent(),"li"===h.nodeName()&&(o._4eBreakParent(h),o._4eMove(o.next(),!0));else if(j&&(h=j.parent())&&"li"===h.nodeName())j._4eBreakParent(h),k.moveToElementEditablePosition(j.next()),j._4eMove(j.prev());var g;if(!c&&!e){if("li"===o.nodeName()&&(h=o.first(y.invisible(!0)))&&l.inArray(h.nodeName(),["ul","ol"]))(i?new q(p.createTextNode("\u00a0")):new q(p.createElement("br"))).insertBefore(h);o&&k.moveToElementEditablePosition(o)}else{if(j){if("li"===
j.nodeName()||!r.test(j.nodeName()))g=j.clone()}else o&&(g=o.clone());g||(g=new q("<p>",null,p));if(h=b.elementPath)for(var b=0,a=h.elements.length;b<a;b++){var d=h.elements[b];if(d.equals(h.block)||d.equals(h.blockLimit))break;w.$removeEmpty[d.nodeName()]&&(d=d.clone(),g._4eMoveChildren(d),g.append(d))}i||g._4eAppendBogus();k.insertNode(g);if(i&&c&&(!e||!j[0].childNodes.length))k.moveToElementEditablePosition(e?j:g),k.select();k.moveToElementEditablePosition(c&&!e?o:g)}i||(o?(g=new q(p.createElement("span")),
g.html("&nbsp;"),k.insertNode(g),g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),k.deleteContents()):g.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));k.select();return!0}function u(f){f.get("document").on("keydown",function(i){if(13===i.keyCode&&!i.shiftKey&&!i.ctrlKey&&!i.metaKey){f.execCommand("save");var k=f.execCommand("enterBlock");f.execCommand("save");!1!==k&&i.preventDefault()}})}var q=k("node"),y=k("./walker"),
t=k("./base"),f=k("./element-path"),i=11>l.UA.ieMode,r=/^h[1-6]$/,w=t.XHTML_DTD;return{init:function(f){f.addCommand("enterBlock",{exec:v});f.docReady(function(){u(f)})}}});
KISSY.add("editor/html-data-processor",["./base","html-parser"],function(l,k){var v=k("./base"),u=k("html-parser"),q=11>l.UA.ieMode;return{init:function(k){function t(a){var a=a.childNodes,b,d,c,e=a.length;if(e){c=1;for(b=0;b<e;b++)if(d=a[b],d.nodeType!==l.require("dom").NodeType.TEXT_NODE||d.nodeValue){c=0;break}return c?!1:void 0}return!1}function f(a){return a.replace(o,function(a,d,c){return"<"+d+c.replace(b,function(a,b){return-1===c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function i(a){return a.replace(e,
function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function r(a){return a.replace(h,function(a,b){return l.urlDecode(b)})}var w=l.Node,j=l.UA,s=new u.Filter,p=new u.Filter;(function(){function a(b){b=u.serialize(b);return new u.Comment(c+encodeURIComponent(b).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:t}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],d,c=0;c<b.length;c++)d="_keSaved_"+b[c],a.getAttribute(d)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var d=b.getAttribute("width"),b=b.getAttribute("height");d&&a.setAttribute("width",d);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:t,strong:t,em:t,del:t,u:t},attributes:{style:function(a){if(!l.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,c.length)===c)return a=l.trim(l.urlDecode(a.substr(c.length))),u.parse(a).childNodes[0]}};q&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});s.addRules(d);p.addRules(b)})();(function(){function a(b){for(var b=b.childNodes,d=b.length,c=b[d-1];c&&3===c.nodeType&&!l.trim(c.nodeValue);)c=b[--d];return c}function b(d){var c=a(d);c&&(1===c.nodeType&&"br"===c.nodeName?d.removeChild(c):
3===c.nodeType&&f.test(c.nodeValue)&&d.removeChild(c))}function d(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function c(a){b(a);d(a)&&(q||a.appendChild(new u.Tag("br")))}function e(a){b(a);d(a)&&a.appendChild(new u.Text("\u00a0"))}var f=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,g=v.XHTML_DTD,i=l.merge(g.$block,g.$listItem,g.$tableContent),h;for(h in i)"br"in g[h]||delete i[h];delete i.pre;var g={tags:{}},j={tags:{}};for(h in i)g.tags[h]=c,j.tags[h]=e;p.addRules(g);s.addRules(j)})();
s.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var o=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",e=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,h=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,g=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,a=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,
d=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;k.htmlDataProcessor={dataFilter:p,htmlFilter:s,toHtml:function(a){j.webkit&&(a=a.replace(/\u200b/g,""));var b=new u.BeautifyWriter;(new u.Parser(a)).parse().writeHtml(b,s);return a=b.getHtml()},toDataFormat:function(b,c){var c=c||p,b=i(b),b=f(b),b=b.replace(g,"$1ke:$2"),b=b.replace(d,"<ke:$1$2></ke:$1>"),e=new w("<div>");e.html("a"+b);b=e.html().substr(1);b=b.replace(a,"$1$2");b=r(b);e=new u.BasicWriter;(new u.Parser(b)).parse().writeHtml(e,c);return b=
e.getHtml()},toServer:function(a){var b=new u.MinifyWriter;(new u.Parser(a)).parse().writeHtml(b,s);return b.getHtml()}}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node"],function(l,k){function v(f){function b(a,b){var c=d.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=w}return c}function c(){var b=d.selection.createRange();m&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&m.select();a.detach("mouseup",c);a.detach("mousemove",e);m=i=0}function e(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",m)?a.setEndPoint("StartToStart",m):a.setEndPoint("EndToEnd",m),a.select()}else c()}
var i,g=f.get("window")[0],a=f.get("document"),d=a[0],m;a.on("mousedown contextmenu",function(f){var j=d.documentElement;if(f.target===j&&(i&&c(),!(j.scrollHeight>j.clientHeight)&&(i=1,m=b(f.pageX,f.pageY))))a.on("mouseup",c),a.on("mousemove",e),g.focus(),m.select()})}function u(j){function b(d){if(a){var e=j.getSelection(),f=e&&e.getType(),h=e&&c.selection;if(d&&h&&f===p.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(i)},50);else{var k;if(!h||!h.type||!("Control"!==
h.type&&(k=h.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))g=h&&e.getRanges()[0],j.checkSelectionChange()}}}var c=j.get("document")[0],e=new f(c.body),h=new f(c.documentElement);if(8>l.UA.ieMode)h.on("click",function(a){"html"===(new f(a.target)).nodeName()&&j.getSelection().getNative().createRange().select()});var g,a,d=i;h.on("mousedown",function(){d=r});h.on("mouseup",function(){d=i});e.on("focusin",function(a){if("body"===(new f(a.target)).nodeName()&&
g){try{d&&g.select()}catch(b){}g=w}});e.on("focus",function(){a=i;b()});e.on("beforedeactivate",function(b){b.relatedTarget||(a=r,d=i)});e.on("mousedown",function(){a=r});e.on("mouseup",function(){a=i;setTimeout(function(){b(i)},0)});e.on("keydown",function(){a=r});e.on("keyup",function(){a=i;setTimeout(function(){b()},0)})}function q(f){f.get("document").on("mouseup keyup selectionchange",function(){f.checkSelectionChange()})}function y(k){function b(a){var b=t.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(a){return h(a)&&g(a)}var e=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,h=t.Walker.whitespaces(i),g=t.Walker.bookmark(r,i),a=function(a){return h(a)&&8!==a.nodeType};k.on("selectionChange",function(d){var g=d.path,h=k.get("document")[0],l=new f(h.body),d=(d=d.selection)&&d.getRanges()[0],q=g.blockLimit;l[0]||(h.documentElement.appendChild(h.createElement("body")),l=new f(h.body),
d&&(d.setStart(l,0),d.collapse(1)));q=q||l;if(j.gecko){var p=(h=g.block||g.blockLimit)&&h.last(c);h&&h._4eIsBlockBoundary()&&(!p||!(1===p[0].nodeType&&p._4eIsBlockBoundary()))&&"pre"!==h.nodeName()&&!h._4eGetBogus()&&h._4eAppendBogus()}if(d&&d.collapsed&&!g.block){if("body"===q.nodeName()){"html"===d.startContainer.nodeName()&&d.setStart(l,0);if((g=d.fixBlock(i,"p"))&&g[0]!==l[0].lastChild&&g.outerHtml().match(e))if((h=g.next(a,1))&&h[0].nodeType===s.NodeType.ELEMENT_NODE&&!b[h])d.moveToElementEditablePosition(h),
g._4eRemove();else if((h=g.prev(a,1))&&h[0].nodeType===s.NodeType.ELEMENT_NODE&&!b[h])d.moveToElementEditablePosition(h,h.outerHtml().match(e)?r:i),g._4eRemove();d.select();k.notifySelectionChange()}g=k.get("document")[0];d=new t.Range(g);d.moveToElementEditablePosition(l,i);"body"!==(new t.ElementPath(d.startContainer)).blockLimit.nodeName()&&(l=(new f(g.createElement("p"))).appendTo(l),j.ie||l._4eAppendBogus())}})}var t=k("./base");k("./selection");var f=k("node"),i=!0,r=!1,w=null,j=l.UA,s=l.require("dom"),
p=t.SelectionType;return{init:function(f){f.docReady(function(){if(document.selection)v(f),u(f);else if(q(f),j.ie){var b,c=f.get("document");c.on("focusout",function(){b=f.getSelection().getRanges()});c.on("focusin",function(){b&&(f.getSelection().selectRanges(b),b=null)})}});y(f)}}});
KISSY.add("editor/modules",[],function(l){l.config("requires",{"editor/plugin/back-color":["editor/plugin/color/btn","editor/plugin/back-color/cmd"],"editor/plugin/back-color/cmd":["editor/plugin/color/cmd"],"editor/plugin/bold":["editor/plugin/font/ui","editor/plugin/bold/cmd"],"editor/plugin/bold/cmd":["editor/plugin/font/cmd"],"editor/plugin/bubble":["overlay","editor"],"editor/plugin/button":["editor","button"],"editor/plugin/checkbox-source-area":["editor"],"editor/plugin/code":["editor/plugin/button",
"editor/plugin/dialog-loader"],"editor/plugin/code/dialog":["menubutton","editor/plugin/dialog"],"editor/plugin/color/btn":["editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"],"editor/plugin/color/cmd":["editor"],"editor/plugin/color/dialog":["editor/plugin/dialog"],"editor/plugin/contextmenu":["menu","editor/plugin/focus-fix","event/dom"],"editor/plugin/dent-cmd":["editor","editor/plugin/list-utils"],"editor/plugin/dialog":["overlay","editor/plugin/focus-fix","dd/plugin/constrain",
"component/plugin/drag"],"editor/plugin/dialog-loader":["editor","overlay"],"editor/plugin/draft":["json","event/dom","editor/plugin/local-storage","editor/plugin/menubutton"],"editor/plugin/drag-upload":["editor","event/dom"],"editor/plugin/element-path":["editor"],"editor/plugin/fake-objects":["editor","html-parser"],"editor/plugin/flash":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/flash/dialog":["editor/plugin/flash-common/utils",
"editor/plugin/dialog","editor/plugin/menubutton"],"editor/plugin/flash-bridge":["editor","swf","event/custom"],"editor/plugin/flash-common/base-class":["editor/plugin/flash-common/utils","base","editor/plugin/dialog-loader","editor/plugin/bubble","editor/plugin/contextmenu"],"editor/plugin/flash-common/utils":["swf"],"editor/plugin/focus-fix":["editor"],"editor/plugin/font/cmd":["editor"],"editor/plugin/font/ui":["editor/plugin/button","editor/plugin/menubutton"],"editor/plugin/font-family":["editor/plugin/font/ui",
"editor/plugin/font-family/cmd"],"editor/plugin/font-family/cmd":["editor/plugin/font/cmd"],"editor/plugin/font-size":["editor/plugin/font/ui","editor/plugin/font-size/cmd"],"editor/plugin/font-size/cmd":["editor/plugin/font/cmd"],"editor/plugin/fore-color":["editor/plugin/color/btn","editor/plugin/fore-color/cmd"],"editor/plugin/fore-color/cmd":["editor/plugin/color/cmd"],"editor/plugin/heading":["editor/plugin/menubutton","editor/plugin/heading/cmd"],"editor/plugin/heading/cmd":["editor"],"editor/plugin/image":["editor/plugin/button",
"editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader","node"],"editor/plugin/image/dialog":["io","editor/plugin/dialog","tabs","editor/plugin/menubutton","node"],"editor/plugin/indent":["editor/plugin/indent/cmd","editor/plugin/button"],"editor/plugin/indent/cmd":["editor/plugin/dent-cmd"],"editor/plugin/italic":["editor/plugin/font/ui","editor/plugin/italic/cmd"],"editor/plugin/italic/cmd":["editor/plugin/font/cmd"],"editor/plugin/justify-center":["editor/plugin/justify-center/cmd",
"editor/plugin/button"],"editor/plugin/justify-center/cmd":["editor/plugin/justify-cmd"],"editor/plugin/justify-cmd":["editor"],"editor/plugin/justify-left":["editor/plugin/justify-left/cmd","editor/plugin/button"],"editor/plugin/justify-left/cmd":["editor/plugin/justify-cmd"],"editor/plugin/justify-right":["editor/plugin/justify-right/cmd","editor/plugin/button"],"editor/plugin/justify-right/cmd":["editor/plugin/justify-cmd"],"editor/plugin/link":["editor/plugin/button","editor/plugin/bubble","editor/plugin/link/utils",
"editor/plugin/dialog-loader"],"editor/plugin/link/dialog":["editor/plugin/dialog","editor/plugin/link/utils"],"editor/plugin/link/utils":["editor"],"editor/plugin/list-utils/btn":["editor/plugin/button","editor/plugin/menubutton"],"editor/plugin/list-utils/cmd":["editor","editor/plugin/list-utils"],"editor/plugin/local-storage":["overlay","editor/plugin/flash-bridge"],"editor/plugin/maximize":["editor/plugin/maximize/cmd","editor/plugin/button"],"editor/plugin/maximize/cmd":["editor","event/dom"],
"editor/plugin/menubutton":["editor","menubutton"],"editor/plugin/ordered-list":["editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"],"editor/plugin/ordered-list/cmd":["editor/plugin/list-utils/cmd"],"editor/plugin/outdent":["editor/plugin/button","editor/plugin/outdent/cmd"],"editor/plugin/outdent/cmd":["editor/plugin/dent-cmd"],"editor/plugin/overlay":["overlay","editor/plugin/focus-fix"],"editor/plugin/page-break":["editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/preview":["editor/plugin/button"],
"editor/plugin/progressbar":["base"],"editor/plugin/remove-format":["editor/plugin/button","editor/plugin/remove-format/cmd"],"editor/plugin/remove-format/cmd":["editor"],"editor/plugin/resize":["dd"],"editor/plugin/smiley":["editor/plugin/overlay","editor/plugin/button"],"editor/plugin/source-area":["editor/plugin/button"],"editor/plugin/strike-through":["editor/plugin/font/ui","editor/plugin/strike-through/cmd"],"editor/plugin/strike-through/cmd":["editor/plugin/font/cmd"],"editor/plugin/table":["editor/plugin/dialog-loader",
"editor/plugin/contextmenu","editor/plugin/button"],"editor/plugin/table/dialog":["editor/plugin/dialog","editor/plugin/menubutton"],"editor/plugin/underline":["editor/plugin/font/ui","editor/plugin/underline/cmd"],"editor/plugin/underline/cmd":["editor/plugin/font/cmd"],"editor/plugin/undo":["editor/plugin/undo/btn","editor/plugin/undo/cmd"],"editor/plugin/undo/btn":["editor/plugin/button"],"editor/plugin/undo/cmd":["editor"],"editor/plugin/unordered-list":["editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"],
"editor/plugin/unordered-list/cmd":["editor/plugin/list-utils/cmd"],"editor/plugin/video":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/video/dialog":["io","editor/plugin/flash/dialog"],"editor/plugin/word-filter":["html-parser"],"editor/plugin/xiami-music":["editor/plugin/flash-common/base-class","editor/plugin/fake-objects","editor/plugin/button"],"editor/plugin/xiami-music/dialog":["editor/plugin/flash/dialog"]})});
KISSY.add("editor/styles",["node","./selection","./range","./base","./element-path"],function(l,k){function v(a){return!z.attr(a,"_ke_bookmark")}function u(a,b){for(var d in a)"string"===typeof a[d]?a[d]=a[d].replace(R,function(a,d){return b[d]}):u(a[d],b)}function q(a,b){b&&(a=l.clone(a),u(a,b));var d=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"===d||Q[d]?J.STYLE_BLOCK:M[d]?J.STYLE_OBJECT:J.STYLE_INLINE;this._={definition:a}}function y(a,b){var d=b?this.removeFromRange:
this.applyToRange;a.body.focus();for(var c=new m(a),e=c.getRanges(),f=0;f<e.length;f++)d.call(this,e[f]);c.selectRanges(e)}function t(a,b,c){var e=a.element;"*"===e&&(e="span");b=new d(b.createElement(e));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var f in a)b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function f(a){var b=a.createBookmark(A),c=a.createIterator();c.enforceRealBlocks=A;c.enlargeBr=A;for(var e,f=a.document;e=c.getNextParagraph();){var g=
t(this,f,e),h=g,g="pre"===h.nodeName,j="pre"===e.nodeName,k=!g&&j;g&&!j?(j=e,k=j.html(),k=i(k,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,""),k=k.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1"),k=k.replace(/([\t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(h[0]),h.outerHtml("<pre>"+k+"</pre>"),h=new d(j.firstChild),h._4eRemove()):h.html(k)):k?h=w(r(e),h):e._4eMoveChildren(h);e[0].parentNode.replaceChild(h[0],e[0]);if(g&&(e=h,g=void 0,(g=
e._4ePreviousSourceNode(A,z.NodeType.ELEMENT_NODE))&&"pre"===g.nodeName()))h=i(g.html(),/\n$/,"")+"\n\n"+i(e.html(),/^\n/,""),N.ie?e.outerHtml("<pre>"+h+"</pre>"):e.html(h),g._4eRemove()}a.moveToBookmark(b)}function i(a,b,d){var c="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,d){b&&(c=b);d&&(e=d);return""});return c+a.replace(b,d)+e}function r(a){var b=[];i(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,
b,d){return b+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,d){b.push(d)});return b}function w(a,b){for(var d=b[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var e=a[c],e=e.replace(/(\r\n|\r)/g,"\n"),e=i(e,/^[\t]*\n/,""),e=i(e,/\n$/,""),e=i(e,/^[\t]+|[\t]+$/g,function(a,b){return 1===a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);d.appendChild(f[0])}return d}function j(a){var b=a.document;if(a.collapsed)b=t(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,f,g=L[c];g||(f=A,g=L.span);var i=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,l=k,n;l&&l[0];){var m=C;if(z.equals(l,j))l=H,m=A;else{var o=l[0].nodeType,q=o===z.NodeType.ELEMENT_NODE?l.nodeName():H;if(q&&l.attr("_ke_bookmark")){l=
l._4eNextSourceNode(A);continue}if(!q||g[q]&&(l._4ePosition(j)|F.POSITION_PRECEDING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_PRECEDING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(l))){var p=l.parent();if(p&&"a"===c&&p.nodeName()===c)o=t(this,b,void 0),p._4eMoveChildren(o),p[0].parentNode.replaceChild(o[0],p[0]),o._4eMergeSiblings();else if(p&&p[0]&&((L[p.nodeName()]||L.span)[c]||f)&&(!e.parentRule||e.parentRule(p))){if(!n&&(!q||!L.$removeEmpty[q]||(l._4ePosition(j)|
F.POSITION_PRECEDING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_PRECEDING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED))n=new D(b),n.setStartBefore(l);if(o===z.NodeType.TEXT_NODE||o===z.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){p=l;for(o=null;(m=!p.next(v,1))&&(o=p.parent())&&g[o.nodeName()]&&(o._4ePosition(k)|F.POSITION_FOLLOWING|F.POSITION_IDENTICAL|F.POSITION_IS_CONTAINED)===F.POSITION_FOLLOWING+F.POSITION_IDENTICAL+F.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)p=
o;n.setEndAfter(p)}}else m=A}else m=A;l=l._4eNextSourceNode()}if(m&&n&&!n.collapsed){for(var m=t(this,b,void 0),p=n.getCommonAncestor(),o={},q={},r,s=null,u;m&&p&&m[0]&&p[0];){if(p.nodeName()===c){for(r in e.attributes)if(!q[r]&&(u=p.attr(s)))m.attr(r)===u?m.removeAttr(r):q[r]=1;for(s in e.styles)if(!o[s]&&(u=p.style(s)))m.style(s)===u?m.style(s,""):o[s]=1;if(!m._4eHasAttributes()){m=H;break}}p=p.parent()}m?(m[0].appendChild(n.extractContents()),h(this,m),n.insertNode(m),m._4eMergeSiblings(),N.ie||
m[0].normalize()):(m=new d(b.createElement("span")),m[0].appendChild(n.extractContents()),n.insertNode(m),h(this,m),m._4eRemove(!0));n=H}}k._4eRemove();j._4eRemove();a.moveToBookmark(i);a.shrink(G.SHRINK_TEXT)}}function s(a){a.enlarge(G.ENLARGE_ELEMENT);var e=a.createBookmark(),f=e.startNode;if(a.collapsed){for(var h=new E(f.parent()),i,j=0,k;j<h.elements.length&&(k=h.elements[j])&&!(k===h.block||k===h.blockLimit);j++)if(this.checkElementRemovable(k)){var l=a.checkBoundaryOfElement(k,G.END),m=!l&&
a.checkBoundaryOfElement(k,G.START);m||l?(i=k,i.match=m?"start":"end"):(k._4eMergeSiblings(),k.nodeName()!==this.element?(l=b(this),g(k,l[k.nodeName()]||l["*"])):c(this,k))}if(i){k=f;for(j=0;;j++){l=h.elements[j];if(l.equals(i))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(k[0]);k=l}k["start"===i.match?"insertBefore":"insertAfter"](i);h=i.html();!h||"\u200b"===h?i.remove():N.webkit&&n(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var o=e.endNode,p=this;i=function(){for(var a=
new E(f.parent()),b=new E(o.parent()),d=H,c,e=H,g=0;g<a.elements.length;g++){c=a.elements[g];if(c===a.block||c===a.blockLimit)break;p.checkElementRemovable(c)&&(d=c)}for(g=0;g<b.elements.length;g++){c=b.elements[g];if(c===b.block||c===b.blockLimit)break;p.checkElementRemovable(c)&&(e=c)}e&&o._4eBreakParent(e);d&&f._4eBreakParent(d)};i();for(h=new d(f[0].nextSibling);h[0]!==o[0];){j=h._4eNextSourceNode();if(h[0]&&h[0].nodeType===z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(h)&&(h.nodeName()===
this.element?c(this,h):(k=b(this),g(h,k[h.nodeName()]||k["*"])),j[0].nodeType===z.NodeType.ELEMENT_NODE&&j.contains(f)))i(),j=new d(f[0].nextSibling);h=j}}a.moveToBookmark(e)}function p(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,c){b[d]=c});return b}function o(a,b){var d="";b!==C?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},d=a._.definition.overrides;if(d){l.isArray(d)||(d=[d]);for(var c=0;c<d.length;c++){var e=d[c],f,g,h;"string"===typeof e?f=e.toLowerCase():(f=e.element?e.element.toLowerCase():a.element,g=e.attributes,h=e.styles);e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var e=e.styles=e.styles||[],j;for(j in h)e.push([j.toLowerCase(),h[j]])}}}return b}function c(d,
c){var f=d._.definition,g=b(d),h=l.merge(f.attributes,(g[c.nodeName()]||g["*"]||{}).attributes),f=l.merge(f.styles,(g[c.nodeName()]||g["*"]||{}).styles),g=l.isEmptyObject(h)&&l.isEmptyObject(f),i;for(i in h)("class"===i||d._.definition.fullMatch)&&c.attr(i)!==e(i,h[i])||(g=g||!!c.hasAttr(i),c.removeAttr(i));for(var j in f)d._.definition.fullMatch&&c.style(j)!==e(j,f[j],A)||(g=g||!!c.style(j),c.style(j,""));a(c)}function e(a,b,c){var e=new d("<span>");e[c?"style":"attr"](a,b);return e[c?"style":"attr"](a)}
function h(a,e){for(var f=b(a),h=e.all(a.element),i=h.length;0<=--i;)c(a,new d(h[i]));for(var j in f)if(j!==a.element){h=e.all(j);for(i=h.length-1;0<=i;i--){var k=new d(h[i]);g(k,f[j])}}}function g(b,d){var c,e,f=d&&d.attributes;if(f)for(c=0;c<f.length;c++){var g=f[c][0];if(e=b.attr(g)){var h=f[c][1];(h===H||h.test&&h.test(e)||"string"===typeof h&&e===h)&&b[0].removeAttribute(g)}}if(f=d&&d.styles)for(c=0;c<f.length;c++)if(g=f[c][0],h=b.css(g)){var i=f[c][1];(i===H||i.test&&i.test(e)||"string"===typeof i&&
h===i)&&b.css(g,"")}a(b)}function a(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,d=a[0].lastChild;a._4eRemove(A);b&&(b.nodeType===z.NodeType.ELEMENT_NODE&&z._4eMergeSiblings(b),d&&b!==d&&d.nodeType===z.NodeType.ELEMENT_NODE&&z._4eMergeSiblings(d))}}var d=k("node"),m=k("./selection"),D=k("./range"),x=k("./base"),E=k("./element-path"),A=!0,C=!1,H=null,n=l.all,z=l.require("dom"),G=x.RangeType,F=x.PositionType,J,N=l.UA,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=x.XHTML_DTD,M=
{embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;x.StyleType=J={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};q.prototype={constructor:q,apply:function(a){y.call(this,a,C)},remove:function(a){y.call(this,a,A)},applyToRange:function(a){return(this.applyToRange=this.type===J.STYLE_INLINE?j:this.type===J.STYLE_BLOCK?f:H).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===J.STYLE_INLINE?s:H).call(this,
a)},checkElementRemovable:function(a,d){if(!a)return C;var c,e=this._.definition,f;if(a.nodeName()===this.element){if(!d&&!a._4eHasAttributes())return A;var g=e._AC;if(!g){var g={},h=0,i=e.attributes;if(i)for(var j in i)h++,g[j]=i[j];if(i=q.getStyleText(e))g.style||h++,g.style=i;g._length=h;e._AC=g}e=g;if(e._length){for(c in e)if("_length"!==c){h=a.attr(c)||"";if("style"===c)a:{g=e[c];h=o(h,C);"string"===typeof g&&(g=p(g));"string"===typeof h&&(h=p(h));i=void 0;for(i in g)if(!(i in h&&(h[i]===g[i]||
"inherit"===g[i]||"inherit"===h[i]))){g=C;break a}g=A}else g=e[c]===h;if(g){if(!d)return A}else if(d)return C}if(d)return A}else return A}c=b(this);if(c=c[a.nodeName()]||c["*"]){if(!(e=c.attributes)&&!(f=c.styles))return A;if(e)for(g=0;g<e.length;g++)if(c=e[g][0],c=a.attr(c))if(h=e[g][1],h===H||"string"===typeof h&&c===h||h.test&&h.test(c))return A;if(f)for(g=0;g<f.length;g++)if(c=a.css(f[g][0]))if(e=f[g][1],e===H||"string"===typeof e&&c===e||e.test&&e.test(c))return A}return C},checkActive:function(a){switch(this.type){case J.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,A);case J.STYLE_OBJECT:case J.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type===J.STYLE_INLINE&&(z.equals(d,a.block)||z.equals(d,a.blockLimit))))if((this.type!==J.STYLE_OBJECT||d.nodeName()in M)&&this.checkElementRemovable(d,A))return A}return C}};q.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(P,";"));for(var e in b){var f=b[e],g=(e+":"+f).replace(P,";");"inherit"===f?
d+=g:c+=g}c.length&&(c=o(c));c+=d;return a._ST=c};return x.Style=q});
KISSY.add("editor/dom-iterator",["node","./walker","./range","./base","./element-path"],function(l,k){function v(f){1>arguments.length||(this.range=f,this.forceBrBreak=r,this.enlargeBr=i,this.enforceRealBlocks=r,this._=this._||{})}var u=k("node"),q=k("./walker"),y=k("./range"),t=k("./base"),f=k("./element-path"),i=!0,r=!1,w=l.UA,j=t.RangeType,s=l.require("dom"),p=/^[\r\n\t ]*$/;l.augment(v,{getNextParagraph:function(k){var b,c,e,h,g,a;if(!this._.lastNode){e=this.range.clone();e.shrink(j.SHRINK_ELEMENT,
i);e.enlarge(this.forceBrBreak||!this.enlargeBr?j.ENLARGE_LIST_ITEM_CONTENTS:j.ENLARGE_BLOCK_CONTENTS);c=new q(e);var d=q.bookmark(i,i);c.evaluator=d;this._.nextNode=c.next();c=new q(e);c.evaluator=d;c=c.previous();this._.lastNode=c._4eNextSourceNode(i);this._.lastNode&&this._.lastNode[0].nodeType===s.NodeType.TEXT_NODE&&!l.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()&&(d=new y(e.document),d.moveToPosition(this._.lastNode,j.POSITION_AFTER_END),d.checkEndOfBlock()&&
(d=new f(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4eNextSourceNode(i)));this._.lastNode||(this._.lastNode=this._.docEndMarker=new u(e.document.createTextNode("")),s.insertAfter(this._.lastNode[0],c[0]));e=null}d=this._.nextNode;c=this._.lastNode;for(this._.nextNode=null;d;){var m=r,t=d[0].nodeType!==s.NodeType.ELEMENT_NODE,x=r;if(t)d[0].nodeType===s.NodeType.TEXT_NODE&&p.test(d[0].nodeValue)&&(t=r);else{var v=d.nodeName();if(d._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){if("br"===
v)t=i;else if(!e&&!d[0].childNodes.length&&"hr"!==v){b=d;h=d.equals(c);break}e&&(e.setEndAt(d,j.POSITION_BEFORE_START),"br"!==v&&(this._.nextNode=d));m=i}else{if(d[0].firstChild){e||(e=new y(this.range.document),e.setStartAt(d,j.POSITION_BEFORE_START));d=new u(d[0].firstChild);continue}t=i}}t&&!e&&(e=new y(this.range.document),e.setStartAt(d,j.POSITION_BEFORE_START));h=(!m||t)&&d.equals(c);if(e&&!m)for(;!d[0].nextSibling&&!h;){v=d.parent();if(v._4eIsBlockBoundary(this.forceBrBreak&&{br:1})){m=i;h||
v.equals(c);break}d=v;t=i;h=d.equals(c);x=i}t&&e.setEndAt(d,j.POSITION_AFTER_END);d=d._4eNextSourceNode(x,null,c);if((h=!d)||m&&e)break}if(!b){if(!e)return this._.docEndMarker&&this._.docEndMarker._4eRemove(),this._.nextNode=null;b=new f(e.startContainer);d=b.blockLimit;m={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&m[d.nodeName()]&&e.checkStartOfBlock()&&e.checkEndOfBlock())b=d;else if(!b||this.enforceRealBlocks&&"li"===b.nodeName())b=new u(this.range.document.createElement(k||
"p")),b[0].appendChild(e.extractContents()),b._4eTrim(),e.insertNode(b),g=a=i;else if("li"!==b.nodeName()){if(!e.checkStartOfBlock()||!e.checkEndOfBlock())b=b.clone(r),b[0].appendChild(e.extractContents()),b._4eTrim(),a=e.splitBlock(),g=!a.wasStartOfBlock,a=!a.wasEndOfBlock,e.insertNode(b)}else h||(this._.nextNode=b.equals(c)?null:e.getBoundaryNodes().endNode._4eNextSourceNode(i,null,c))}g&&(e=new u(b[0].previousSibling),e[0]&&e[0].nodeType===s.NodeType.ELEMENT_NODE&&("br"===e.nodeName()?e._4eRemove():
e[0].lastChild&&"br"===s.nodeName(e[0].lastChild)&&s._4eRemove(e[0].lastChild)));a&&(e=q.bookmark(r,i),g=new u(b[0].lastChild),g[0]&&g[0].nodeType===s.NodeType.ELEMENT_NODE&&"br"===g.nodeName()&&(w.ie||g.prev(e,1)||g.next(e,1))&&g.remove());this._.nextNode||(this._.nextNode=h||b.equals(c)?null:b._4eNextSourceNode(i,null,c));return b}});y.prototype.createIterator=function(){return new v(this)};return v});
KISSY.add("editor/z-index-manager",["./base"],function(l,k){var v=k("./base"),u=v.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(k){return(v.Config.baseZIndex||1E4)+k};return u});
