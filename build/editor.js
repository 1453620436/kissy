/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: May 14 22:24
*/
KISSY.add("editor","util,node,editor/iframe-content-tpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager,ua".split(","),function(E,b,v,w){function x(a,d){var i=a.get("textarea"),c=a.get("toolBarEl"),e=a.get("statusBarEl"),d=parseInt(d,10),d=d-((c&&c.outerHeight()||0)+(e&&e.outerHeight()||0));i.parent().css(H,d);i.css(H,d)}function l(d,c){var e=d.body;i(function(){d.designMode=
"on";setTimeout(function P(){d.designMode="off";e.focus();if(!P.retry)P.retry=a},50)},function(){d.designMode="off";e.setAttribute("contentEditable",false);e.setAttribute("contentEditable",true);c||l(d,1)})}function u(a){var i=a.get("textarea")[0],e=a.get("window"),y=a.get("document"),g=y[0];if(A.webkit){y.on("click",function(a){var d=new q(a.target);p.inArray(d.nodeName(),["input","select"])&&a.preventDefault()});y.on("mouseup",function(a){var d=new q(a.target);p.inArray(d.nodeName(),["input","textarea"])&&
a.preventDefault()})}if(A.gecko||A.ie){var f;f=(new q('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(i);f.on("focus",function(){a.focus()});a.activateGecko=function(){A.gecko&&a.__iframeFocus&&f[0].focus()};a.on("destroy",function(){f.detach();f.remove()})}e.on("focus",function(){A.gecko&&l(g,d);a.notifySelectionChange()});if(A.gecko)y.on("mousedown",function(){a.__iframeFocus||l(g,d)});if(B){y.on("keydown",function(d){if(d.keyCode in{8:1,46:1}){var i=
a.getSelection(),c=i.getSelectedElement();if(c){a.execCommand("save");var e=i.getRanges()[0].createBookmark();c.remove();i.selectBookmarks([e]);a.execCommand("save");d.preventDefault()}}});if(g.compatMode==="CSS1Compat"){var j={33:1,34:1};y.on("keydown",function(d){d.keyCode in j&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(A.webkit)y.on("mousedown",function(d){d=new q(d.target);p.inArray(d.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(d)});
if(A.gecko)y.on("dragstart",function(a){var d=new q(a.target);d.nodeName()==="img"&&/ke_/.test(d[0].className)&&a.preventDefault()});c.add(a)}function s(a,d,i,c){var e="",y;y=n.debugUrl("theme/iframe.css");i=i.concat([]);i.unshift(y);for(y=0;y<i.length;y++)e=e+p.substitute('<link href="{href}" rel="stylesheet" />',{href:i[y]});return p.substitute(r,{doctype:A.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:e,style:"<style>"+d+"</style>",data:c||"",script:a?
'<script id="ke_active_script">'+(F(o).isCustomDomain()?'document.domain="'+z.domain+'";':"")+"parent.KISSY.require('editor')._initIframe(\""+a+'");<\/script>':""})}function f(a,d){function i(){f=g.document;a.setInternal("document",new q(f));a.setInternal("window",new q(g));c.detach();f.open("text/html","replace");f.write(e);f.close()}var c=a.get("iframe"),e=s(a.get("id"),a.get("customStyle"),a.get("customLink"),d),y=c[0],g=y.contentWindow,f;c.__loaded=1;try{f=g.document}catch(j){y.src=y.src;if(B<
7){setTimeout(i,10);return}}i()}function h(a,d){var i=F(o).getEmptyIframeSrc()||"";i&&(i=' src="'+i+'" ');var i=new q(p.substitute(y,{iframeSrc:i,prefixCls:a.get("prefixCls")})),c=a.get("textarea");c.hasAttr("tabindex")&&i.attr("tabindex",A.webkit?-1:c.attr("tabindex"));c.parent().prepend(i);a.set("iframe",i);a.__docReady=0;if(A.gecko&&!i.__loaded)i.on("load",function(){f(a,d)},a);else f(a,d)}function t(a){if(a.get("iframe")){var d=a.get("iframe"),i=a.get("window"),a=a.get("document"),c=a[0],e=F(c.documentElement),
c=F(c.body);p.each([a,e,c,i],function(a){a.detach()});d.remove()}}var p=b("util"),q=b("node"),r=b("editor/iframe-content-tpl"),m=b("editor/base"),n=b("editor/utils"),c=b("editor/focus-manager"),e=b("editor/clipboard"),g=b("editor/enter-key"),j=b("editor/html-data-processor"),k=b("editor/selection-fix");b("editor/styles");b("editor/dom-iterator");b("editor/z-index-manager");w.exports=m;var a=true,d=false,o=E.Env.host,z=o.document,A=b("ua"),B=A.ieMode<11,D=q.NodeType,F=q.all,H="height",i=n.tryThese,
y='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',J=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;m.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};m.addMembers({initializer:function(){this.__commands={};this.__controls={};c.register(this)},renderUI:function(){e.init(this);g.init(this);j.init(this);k.init(this)},bindUI:function(){function a(){d.detach("docReady",a);if(d.get("focused"))d.focus();else{var i=d.getSelection();
i&&i.removeAllRanges()}}var d=this,i,c=d.get("prefixCls"),e=d.get("textarea");if(d.get("attachForm")&&(i=e[0].form)&&(i=F(i)))i.on("submit",d.sync,d);d.on("docReady",a);d.on("blur",function(){d.$el.removeClass(c+"editor-focused")});d.on("focus",function(){d.$el.addClass(c+"editor-focused")})},syncUI:function(){x(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,
d){this.__controls[a]=d},showDialog:function(a,d){var a=a+"/dialog",i=this.__controls[a];i.show(d);this.fire("dialogShow",{dialog:i.dialog,pluginDialog:i,dialogName:a})},addCommand:function(a,d){this.__commands[a]=d},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var d=this.__commands[a],i=p.makeArray(arguments);i.shift();i.unshift(this);if(d)return d.exec.apply(d,i)},queryCommandValue:function(a){return this.execCommand(n.getQueryCmd(a))},setData:function(a){var d,i=a;
if(this.get("mode")!==1)this.get("textarea").val(a);else{if(d=this.htmlDataProcessor)i=d.toDataFormat(a);t(this);h(this,i)}},getData:function(a,d){var i=this.htmlDataProcessor,c;d===void 0&&(d=this.get("mode"));c=d===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:i.toDataFormat(this.get("textarea").val());c=a?i.toHtml(c):i.toServer(c);c=p.trim(c);J.test(c)&&(c="");return c},getFormatData:function(a){return this.getData(1,a)},getDocHtml:function(){return s(0,this.get("customStyle"),this.get("customLink"),
this.getFormatData())},getSelection:function(){return m.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],d="";if(a){a=a.cloneContents();d=this.get("document")[0].createElement("div");d.appendChild(a);d=d.innerHTML}return d},focus:function(){var a=this.get("window");if(a){var d=this.get("document")[0],a=a[0];A.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{d.body.focus()}catch(i){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,d){var i=this.get("window"),c=this.get("customStyle")||"";this.set("customStyle",c+("\n"+a));i&&i.addStyleSheet(a,d)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var d=this.get("customLink"),i=this.get("document")[0];d.push(a);this.set("customLink",d);d=i.createElement("link");d.rel="stylesheet";i.getElementsByTagName("head")[0].appendChild(d);d.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(d){d.attr("href")===
a&&d.remove()});var d=this.get("customLink"),i=p.indexOf(a,d);i!==-1&&d.splice(i,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var d=a.getSelection();if(d&&!d.isInvalid){var i=d.getStartElement(),c=new m.ElementPath(i);if(!a.__previousPath||!a.__previousPath.compare(c)){a.__previousPath=
c;a.fire("selectionChange",{selection:d,path:c,element:i})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(d){if(this.get("mode")===1){this.focus();var i,c=d.nodeName(),e=m.XHTML_DTD,y=e.$block[c],f=m.RangeType,g=(c=this.getSelection())&&c.getRanges(),j,J,o;if(g&&g.length!==0){this.execCommand("save");for(J=g.length-1;J>=0;J--){j=g[J];i=!J&&d||d.clone(a);j.insertNodeByDtd(i);o||(o=i)}if(o){j.moveToPosition(o,f.POSITION_AFTER_END);
if(y){d=m.Walker.whitespaces(true);(d=(o=o.next(d,1))&&o[0].nodeType===D.ELEMENT_NODE&&o.nodeName())&&e.$block[d]&&e[d]["#text"]&&j.moveToElementEditablePosition(o)}c.selectRanges([j]);this.focus();i&&i[0].nodeType===1&&i.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});G.call(this);return i}}}},insertHtml:function(a,d){var i=this,c,e=i.get("document")[0];if(i.get("mode")===1){if(c=i.htmlDataProcessor)a=c.toDataFormat(a,d);i.focus();i.execCommand("save");
if(c=e.selection){c.type==="Control"&&c.clear();try{c.createRange().pasteHTML(a)}catch(y){}}else{c=i.get("iframe")[0].contentWindow.getSelection();var g=c.getRangeAt(0);g.deleteContents();var f=e.createElement("div");f.innerHTML=a;for(var e=e.createDocumentFragment(),j,o;j=f.firstChild;)o=e.appendChild(j);g.insertNode(e);if(o){g=g.cloneRange();g.setStartAfter(o);g.collapse(true);c.removeAllRanges();c.addRange(g)}}setTimeout(function(){i.getSelection().scrollIntoView()},50);G.call(i)}},_onSetHeight:function(a){x(this,
a)},_onSetMode:function(a){var d=this.get("iframe"),i=this.get("textarea");if(a===1){this.setData(i.val());i.hide();this.fire("wysiwygMode")}else{if(d){i.val(this.getFormatData(1));d.hide()}i.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,d=this.get("textarea"),i=this.get("document");this.get("attachForm")&&(a=d[0].form)&&(a=F(a))&&a.detach("submit",this.sync,this);if(i){a=F(i[0].body);var d=F(i[0].documentElement),e=this.get("window");
c.remove(this);i.detach();d.detach();a.detach();e.detach()}p.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});m.decorate=function(a,d){var d=d||{},a=F(a),i=d.textareaAttrs=d.textareaAttrs||{},c=a.style("width"),e=a.style("height"),y=a.attr("name");if(c)d.width=d.width||c;if(e)d.height=d.height||e;if(y)i.name=y;d.data=d.data||a.val();d.elBefore=a;i=(new m(d)).render();a.remove();return i};m._initIframe=function(i){var e=c.getInstance(i),i=e.get("document"),
y=i[0];i.one("#ke_active_script").remove();u(e);var g=y.body,f=F(g);if(B){g.hideFocus=a;g.disabled=a;g.contentEditable=a;g.removeAttribute("disabled")}else setTimeout(function(){A.gecko?g.contentEditable=a:A.webkit?g.parentNode.contentEditable=a:y.designMode="on"},0);if(A.gecko){var j=y.documentElement;F(j).on("mousedown",function(a){if(a.target===j){A.gecko&&l(y,d);e.activateGecko()}})}setTimeout(function(){B&&setTimeout(function(){if(y){g.runtimeStyle.marginBottom="0px";g.runtimeStyle.marginBottom=
""}},1E3)},0);setTimeout(function(){e.__docReady=1;e.fire("docReady");var a=e.get("disableObjectResizing"),i=e.get("disableInlineTableEditing");if(a||i)try{y.execCommand("enableObjectResizing",d,!a);y.execCommand("enableInlineTableEditing",d,!i)}catch(c){f.on(B?"resizestart":"resize",function(d){var c=new q(d.target);(a||c.nodeName()==="table"&&i)&&d.preventDefault()})}},10)};var G=p.buffer(function(){this.execCommand("save")},50)});KISSY.add("editor/iframe-content-tpl",[],function(){return'<!doctype html>\n<html>\n<head>{doctype}\n    <title>{title}</title>\n    {style}\n    {links}\n    </head> \n<body class="ks-editor">\n{data}\n{script}\n</body> \n</html>'});
KISSY.add("editor/base",["util","ua","html-parser","component/control","./render-xtpl"],function(E,b){var v=b("util"),w=b("ua"),x=b("html-parser"),l=b("component/control"),u=b("./render-xtpl");return l.extend({beforeCreateDom:function(b){v.mix(b,{mobile:w.mobile})}},{Config:{},XHTML_DTD:x.DTD,ATTRS:{contentTpl:{value:u},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+
this.getBaseCssClass("tools")}},statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},handleGestureEvents:{value:!1},focusable:{value:!1},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(E,b,v,w){E=function(b,l){var u=this.root.nativeCommands,s=u.each,u=u["if"];l.write('<div class="',0);var f=b.resolve(["prefixCls"],0);l.write(f,!0);l.write('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\nhttp://johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="',0);f=b.resolve(["prefixCls"],0);l.write(f,!0);l.write('editor-textarea-wrap"\r\n\r\n',0);var f={escape:1},h=[],t=b.resolve(["mobile"],0);h.push(t);
f.params=h;f.fn=function(f,h){h.write('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n',0);return h};l=u.call(this,b,f,l,12);l.write('\r\n>\r\n\r\n<textarea class="',0);f=b.resolve(["prefixCls"],0);l.write(f,!0);l.write('editor-textarea"\r\n\r\n',0);f={escape:1};h=[];t=b.resolve(["textareaAttrs"],0);h.push(t);f.params=h;f.fn=function(f,h){h.write("\r\n",0);var b=f.resolve(["xindex"],0);h.write(b,!0);h.write('="',0);b=f.resolve(["this"],0);h.write(b,!0);h.write('"\r\n',0);return h};
l=s.call(this,b,f,l,19);l.write("\r\n\r\n",0);s={escape:1};f=[];h=b.resolve(["mode"],0);f.push(h);s.params=f;s.fn=function(f,h){h.write('\r\nstyle="display:none"\r\n',0);return h};l=u.call(this,b,s,l,23);l.write("\r\n\r\n>",0);u=b.resolve(["data"],0);l.write(u,!0);l.write('</textarea>\r\n\r\n</div>\r\n\r\n<div class="',0);u=b.resolve(["prefixCls"],0);l.write(u,!0);l.write('editor-status">\r\n\r\n</div>',0);return l};E.TPL_NAME=w.name;E.version="5.0.0";return E});
KISSY.add("editor/utils",["util","node","./base","dom","ua"],function(E,b){var v=b("util"),w=b("node"),x=b("./base"),l=b("dom"),u=b("ua"),s={debugUrl:function(f){var h=E.Config;h.debug&&(f=f.replace(/\.(js|css)/i,"-debug.$1"));-1===f.indexOf("?t")&&(f=-1!==f.indexOf("?")?f+"&":f+"?",h.tag&&(f+="t="+encodeURIComponent(h.tag)));return E.config("base")+"editor/"+f},lazyRun:function(f,h,b){var p=f[h],q=f[b];f[h]=function(){p.apply(this,arguments);f[h]=f[b];return q.apply(this,arguments)}},getXY:function(f,
h){var b=f.left,p=f.top,q=h.get("window")[0],b=b-l.scrollLeft(q),p=p-l.scrollTop(q),q=h.get("iframe").offset(),b=b+q.left,p=p+q.top;return{left:b,top:p}},tryThese:function(){for(var f,h=0,b=arguments.length;h<b;h++){var p=arguments[h];try{f=p();break}catch(q){}}return f},clearAllMarkers:function(f){for(var h in f)f[h]._4eClearMarkers(f,!0,void 0)},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(v.trim(f))},
verifyInputs:function(f){for(var h=0;h<f.length;h++){var b=new w(f[h]),p=v.trim(s.valInput(b)),q=b.attr("data-verify"),b=b.attr("data-warning");if(q&&!RegExp(q).test(p))return alert(b),!1}return!0},sourceDisable:function(f,h){f.on("sourceMode",h.disable,h);f.on("wysiwygMode",h.enable,h)},resetInput:function(f){var h=f.attr("placeholder");h&&u.ie?(f.addClass("ks-editor-input-tip"),f.val(h)):u.ie||f.val("")},valInput:function(f,h){if(void 0===h)return f.hasClass("ks-editor-input-tip")?"":f.val();f.removeClass("ks-editor-input-tip");
f.val(h)},placeholder:function(f,h){f.attr("placeholder",h);u.ie&&(f.on("blur",function(){v.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(h))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");v.trim(f.val())===h&&f.val("")}))},normParams:function(f){var f=v.clone(f),h;for(h in f){var b=f[h];"function"===typeof b&&(f[h]=b())}return f},preventFocus:function(f){u.ie?f.unselectable():f.attr("onmousedown","return false;")},injectDom:function(f){v.mix(l,f);for(var h in f)(function(h){w.prototype[h]=
function(){var b=[].slice.call(arguments,0);b.unshift(this[0]);return(b=f[h].apply(null,b))&&(b.nodeType||v.isWindow(b))?new w(b):v.isArray(b)&&(b.__IS_NODELIST||b[0]&&b[0].nodeType)?new w(b):b}})(h)},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,v.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],h=0;h<f.length;h++){var b=f[h];"function"===typeof b?b():b.destroy?b.destroy():b.remove&&b.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,
function(f,b){return b.toUpperCase()})+"Value"}};return x.Utils=s});
KISSY.add("editor/focus-manager",["./base"],function(E,b){function v(){var f=this;f.__iframeFocus=h;s=f;u&&clearTimeout(u);u=setTimeout(function(){f.fire("focus")},30)}function w(){var f=this;f.__iframeFocus=t;s=p;u&&clearTimeout(u);u=setTimeout(function(){f.fire("blur")},30)}var x=b("./base"),l={},u,s,f={currentInstance:function(){return s},getInstance:function(f){return l[f]},register:function(f){l[f.get("id")]=f},add:function(f){this.register(f);f.get("window").on("focus",v,f).on("blur",w,f)},
remove:function(f){delete l[f.get("id")];f.get("window").detach("focus",v,f).detach("blur",w,f)}},h=!0,t=!1,p=null;x.focusManager=f;x.getInstances=function(){return l};return f});
KISSY.add("editor/clipboard","util,node,./base,./range,./selection,ua".split(","),function(E,b){function v(a){this.editor=a;this._init()}function w(a){var d=a.get("document")[0],c=a.getSelection(),e;if(c.getType()===p.SELECTION_ELEMENT&&(e=c.getSelectedElement())){var a=c.getRanges()[0],f=q(d.createTextNode(""));f.insertBefore(e);a.setStartBefore(f);a.setEndAfter(e);c.selectRanges([a]);setTimeout(function(){if(e.parent()){f.remove();c.selectElement(e)}},0)}}function x(a){if(r.webkit){if(!a.match(/^[^<]*$/g)&&
!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(r.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(r.gecko){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function l(a){a=a.replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(r.webkit&&a.indexOf("<div>")>-1){if(a.match(/<div>(?:<br>)?<\/div>/)){a=a.replace(/<div>(?:<br>)?<\/div>/g,
function(){return"<p></p>"});a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")}a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"))}else if(r.gecko){r.gecko&&(a=a.replace(/^<br><br>$/,"<br>"));a.indexOf("<br><br>")>-1&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>")}return a}function u(a){var d=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,
"");if(a.indexOf("Apple-")!==-1){a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,d){return d.replace(/\t/g,Array(5).join("&nbsp;"))});if(a.indexOf('<br class="Apple-interchange-newline">')>-1){d=1;a=a.replace(/<br class="Apple-interchange-newline">/,"")}a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1")}!d&&x(a)&&(a=l(a));return a}var s=b("util"),f=b("node"),h=b("./base"),t=b("./range"),p=b("./selection"),
q=f.all,r=b("ua"),m=r.ieMode<11,n=m?"beforepaste":"paste",c=h.RangeType;s.augment(v,{_init:function(){var a=this,d=a.editor,c=d.get("document"),e=c.one("body"),f=function(a){this.type=a};f.prototype={exec:function(d){var c=this.type;d.focus();setTimeout(function(){if(m)if(c==="cut")w(d);else if(c==="paste"){a._preventPasteEvent();a._getClipboardDataFromPasteBin()}g(d,c)||alert(j[c])},0)}};e.on(n,a._getClipboardDataFromPasteBin,a);if(m){e.on("paste",a._iePaste,a);c.on("keydown",a._onKeyDown,a);c.on("contextmenu",
function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)})}d.addCommand("copy",new f("copy"));d.addCommand("cut",new f("cut"));d.addCommand("paste",new f("paste"))},_onKeyDown:function(a){this.editor.get("mode")===h.Mode.WYSIWYG_MODE&&(a.ctrlKey&&a.keyCode===86||a.shiftKey&&a.keyCode===45)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var d,c=this.editor;if(a==="paste"){this._isPreventBeforePaste=1;try{d=c.get("document")[0].queryCommandEnabled(a)}catch(e){}this._isPreventBeforePaste=
0}else d=(a=(a=c.getSelection())&&a.getRanges())&&!(a.length===1&&a[0].collapsed);return d},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var d=this.editor;if(!this._isPreventPaste){a.preventDefault();d.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,d=a.get("document")[0];
if(!d.getElementById("ke-paste-bin")){var e=a.getSelection(),f=new t(d),g=q(r.webkit?"<body></body>":"<div></div>",d);g.attr("id","ke-paste-bin");r.webkit&&g[0].appendChild(d.createTextNode("\u200b"));d.body.appendChild(g[0]);g.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var j=e.createBookmarks();f.setStartAt(g,c.POSITION_AFTER_START);f.setEndAt(g,c.POSITION_BEFORE_END);f.select(true);setTimeout(function(){var d,
c=g;g=r.webkit&&(d=g.first())&&d.hasClass("Apple-style-span")?d:g;e.selectBookmarks(j);var f=g.html();c.remove();if(f=u(f)){d=a.fire("paste",{html:f});if(d!==false){d!==void 0&&(f=d);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(f)?E.use("editor/plugin/word-filter",function(d,c){a.insertHtml(c.toDataFormat(f,a))}):a.insertHtml(f)}}},0)}}}});var e=function(a,d){var c=a.get("document")[0],e=q(c.body),f=false,g=function(){f=true};e.on(d,g);(r.ieMode>7?c:c.selection.createRange()).execCommand(d);
e.detach(d,g);return f},g=m?function(a,d){return e(a,d)}:function(a,d){try{return a.get("document")[0].execCommand(d)}catch(c){return false}},j={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},k={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var d;a.docReady(function(){d=new v(a)});var c={copy:1,cut:1,paste:1},e=["copy","cut","paste"];a.on("contextmenu",function(f){var g=
f.contextmenu;if(!g.__copyFix){g.__copyFix=1;for(f=0;f<e.length;f++)g.addChild({content:k[e[f]],value:e[f]});g.on("click",function(d){var e=d.target.get("value");if(c[e]){g.hide();setTimeout(function(){a.execCommand("save");a.execCommand(e);setTimeout(function(){a.execCommand("save")},10)},30)}})}for(var j=g.get("children"),f=j.length-1;f--;f>=0){var b=j[f],h;h=b.get?b.get("value"):b.value;if(c[h]){h=!d._stateFromNamedCommand(h);b.set?b.set("disabled",h):b.disabled=h}}})}}});
KISSY.add("editor/range","./dom,node,./utils,./walker,./base,./element-path,util,dom,ua".split(","),function(E,b){function v(d){var c=d.nodeType!==j.NodeType.TEXT_NODE&&j.nodeName(d)in a.$removeEmpty,e=d.nodeType===j.NodeType.TEXT_NODE&&!r.trim(d.nodeValue),d=!!d.parentNode.getAttribute("_ke_bookmark");return c||e||d}function w(a){return!A(a)&&!B(a)}function x(a){var d=n;return function(c){if(B(c))return m;if(c.nodeType===j.NodeType.TEXT_NODE){if(r.trim(c.nodeValue).length)return n}else if(c.nodeType===
j.NodeType.ELEMENT_NODE){c=j.nodeName(c);if(!H[c])if(!a&&!k.ie&&c==="br"&&!d)d=m;else return n}return m}}function l(a,d){var c=a.startContainer,e=a.endContainer,g=a.startOffset,b=a.endOffset,h,A=n,k=n,z,B=a.document,R;d>0&&(z=B.createDocumentFragment());if(a.collapsed)return z;a.optimizeBookmark();if(e[0].nodeType===j.NodeType.TEXT_NODE){k=m;e=e._4eSplitText(b)}else if(e[0].childNodes.length>0)if(b>=e[0].childNodes.length){e=new f(e[0].appendChild(B.createTextNode("")));R=m}else e=new f(e[0].childNodes[b]);
if(c[0].nodeType===j.NodeType.TEXT_NODE){A=m;c._4eSplitText(g)}else if(g)if(g>=c[0].childNodes.length){c=new f(c[0].appendChild(B.createTextNode("")));h=m}else c=new f(c[0].childNodes[g].previousSibling);else{h=new f(B.createTextNode(""));c.prepend(h);c=h;h=m}var L=c._4eParents(),N=e._4eParents();L.each(function(a,d){L[d]=a});N.each(function(a,d){N[d]=a});for(var I,p,B=0;B<L.length;B++){I=L[B];p=N[B];if(!I.equals(p))break}for(var g=z,C,M,l=B;l<L.length;l++){C=L[l];b=d>0&&!C.equals(c)?g.appendChild(C.clone()[0]):
null;C=C[0].nextSibling;M=N[l];for(var q=e[0],t=M&&M[0];C;){if(t===C||q===C)break;M=C.nextSibling;if(d===2)g.appendChild(C.cloneNode(m));else{if(o[C.nodeName.toLowerCase()]){var r=C.cloneNode(m);C.innerHTML="";C=r}else j._4eRemove(C);d===1&&g.appendChild(C)}C=M}b&&(g=b)}for(g=z;B<N.length;B++){C=N[B];b=d>0&&!C.equals(e)?g.appendChild(C.clone()[0]):null;if(!L[B]||!C._4eSameLevel(L[B]))for(C=C[0].previousSibling;C;){M=C.previousSibling;if(d===2)g.insertBefore(C.cloneNode(m),g.firstChild);else{j._4eRemove(C);
d===1&&g.insertBefore(C,g.firstChild)}C=M}b&&(g=b)}if(d===2){if(A){I=c[0];if(I.nodeType===j.NodeType.TEXT_NODE&&I.nextSibling&&I.nextSibling.nodeType===j.NodeType.TEXT_NODE){I.data=I.data+I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}if(k){k=e[0];if(k.nodeType===j.NodeType.TEXT_NODE&&k.previousSibling&&k.previousSibling.nodeType===j.NodeType.TEXT_NODE){k.previousSibling.data=k.previousSibling.data+k.data;k.parentNode.removeChild(k)}}}else{if(I&&p&&(!c._4eSameLevel(I)||!e._4eSameLevel(p))){k=
I._4eIndex();h&&I._4eSameLevel(c)&&k--;a.setStart(I.parent(),k+1)}a.collapse(m)}h&&c.remove();R&&e.remove();return z}function u(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=c;this.collapsed=m;this.document=a}b("./dom");var f=b("node"),h=b("./utils"),t=b("./walker"),p=b("./base"),q=b("./element-path"),r=b("util");p.RangeType={POSITION_AFTER_START:1,
POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var m=true,n=false,c=null,e=p.RangeType,g=p.PositionType,j=b("dom"),k=b("ua"),a=p.XHTML_DTD,d=f.all,o={td:1},z={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},A=new t.whitespaces,B=new t.bookmark,D=t.whitespaces(m),F=t.bookmark(false,true),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,
dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.augment(s,{toString:function(){var a=[],d=this.startContainer[0],c=this.endContainer[0];a.push((d.id||d.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,d=this.startOffset;a[0].nodeType!==j.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));
a=this.endContainer;d=this.endOffset;a[0].nodeType!==j.NodeType.ELEMENT_NODE&&(d?d>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a.nodeName()===
"span"&&a.attr("_ke_bookmark")&&this.setStartBefore(a);d&&d.nodeName()==="span"&&d.attr("_ke_bookmark")&&this.setEndAfter(d)},setStart:function(a,d){if(a[0].nodeType===j.NodeType.ELEMENT_NODE&&z[a.nodeName()]){a=a.parent();d=a._4eIndex()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}u(this)},setEnd:function(a,d){if(a[0].nodeType===j.NodeType.ELEMENT_NODE&&z[a.nodeName()]){a=a.parent();d=a._4eIndex()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=
a;this.startOffset=d}u(this)},setStartAt:function(a,d){switch(d){case e.POSITION_AFTER_START:this.setStart(a,0);break;case e.POSITION_BEFORE_END:a[0].nodeType===j.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setStartBefore(a);break;case e.POSITION_AFTER_END:this.setStartAfter(a)}u(this)},setEndAt:function(a,d){switch(d){case e.POSITION_AFTER_START:this.setEnd(a,0);break;case e.POSITION_BEFORE_END:a[0].nodeType===
j.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setEndBefore(a);break;case e.POSITION_AFTER_END:this.setEndAfter(a)}u(this)},cloneContents:function(){return l(this,2)},deleteContents:function(){return l(this,0)},extractContents:function(){return l(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=m},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==j.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==j.NodeType.ELEMENT_NODE)return c;var d=new t(a);d.evaluator=function(a){return D(a)&&F(a)};a=d.next();d.reset();
d=d.previous();return a&&a.equals(d)?a:c},shrink:function(a,d){if(!this.collapsed){var a=a||e.SHRINK_TEXT,c=this.clone(),f=this.startContainer,g=this.endContainer,b=this.startOffset,h=this.endOffset,o=m,k,A,z=m;if(f&&f[0].nodeType===j.NodeType.TEXT_NODE)if(b)if(b>=f[0].nodeValue.length)c.setStartAfter(f);else{c.setStartBefore(f);o=n}else c.setStartBefore(f);if(g&&g[0].nodeType===j.NodeType.TEXT_NODE)if(h)if(h>=g[0].nodeValue.length)c.setEndAfter(g);else{c.setEndAfter(g);z=n}else c.setEndBefore(g);
if(o||z){A=new t(c);A.evaluator=function(d){return d.nodeType===(a===e.SHRINK_ELEMENT?j.NodeType.ELEMENT_NODE:j.NodeType.TEXT_NODE)};A.guard=function(d,c){if(a===e.SHRINK_ELEMENT&&d.nodeType===j.NodeType.TEXT_NODE||c&&d===k)return n;!c&&d.nodeType===j.NodeType.ELEMENT_NODE&&(k=d);return m}}if(o)(c=A[a===e.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(c,d?e.POSITION_AFTER_START:e.POSITION_BEFORE_START);if(z){A.reset();(A=A[a===e.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(A,
d?e.POSITION_BEFORE_END:e.POSITION_AFTER_END)}return o||z}},createBookmark2:function(a){var d=this.startContainer,e=this.endContainer,g=this.startOffset,b=this.endOffset,h,o;if(!d||!e)return{start:0,end:0};if(a){if(d[0].nodeType===j.NodeType.ELEMENT_NODE)if((h=new f(d[0].childNodes[g]))&&h[0]&&h[0].nodeType===j.NodeType.TEXT_NODE&&g>0&&h[0].previousSibling.nodeType===j.NodeType.TEXT_NODE){d=h;g=0}for(;d[0].nodeType===j.NodeType.TEXT_NODE&&(o=d.prev(void 0,1))&&o[0].nodeType===j.NodeType.TEXT_NODE;){d=
o;g=g+o[0].nodeValue.length}if(!this.collapsed){if(e[0].nodeType===j.NodeType.ELEMENT_NODE)if((h=new f(e[0].childNodes[b]))&&h[0]&&h[0].nodeType===j.NodeType.TEXT_NODE&&b>0&&h[0].previousSibling.nodeType===j.NodeType.TEXT_NODE){e=h;b=0}for(;e[0].nodeType===j.NodeType.TEXT_NODE&&(o=e.prev(void 0,1))&&o[0].nodeType===j.NodeType.TEXT_NODE;){e=o;b=b+o[0].nodeValue.length}}}return{start:d._4eAddress(a),end:this.collapsed?c:e._4eAddress(a),startOffset:g,endOffset:b,normalized:a,is2:m}},createBookmark:function(a){var d,
g,j,b,h=this.collapsed;d=new f("<span>",c,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");if(a){j=r.guid("ke_bm_");d.attr("id",j+"S")}if(!h){g=d.clone();g.html("&nbsp;");a&&g.attr("id",j+"E");b=this.clone();b.collapse();b.insertNode(g)}b=this.clone();b.collapse(m);b.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,e.POSITION_AFTER_END);return{startNode:a?j+"S":d,endNode:a?j+"E":g,serializable:a,collapsed:h}},moveToPosition:function(a,
d){this.setStartAt(a,d);this.collapse(m)},trim:function(a,d){var c=this.startContainer,e=this.startOffset,g=this.collapsed;if((!a||g)&&c[0]&&c[0].nodeType===j.NodeType.TEXT_NODE){if(e)if(e>=c[0].nodeValue.length){e=c._4eIndex()+1;c=c.parent()}else{var f=c._4eSplitText(e),e=c._4eIndex()+1,c=c.parent();if(j.equals(this.startContainer,this.endContainer))this.setEnd(f,this.endOffset-this.startOffset);else if(j.equals(c,this.endContainer))this.endOffset=this.endOffset+1}else{e=c._4eIndex();c=c.parent()}this.setStart(c,
e);if(g){this.collapse(m);return}}c=this.endContainer;e=this.endOffset;if(!d&&!g&&c[0]&&c[0].nodeType===j.NodeType.TEXT_NODE){if(e){e>=c[0].nodeValue.length||c._4eSplitText(e);e=c._4eIndex()+1}else e=c._4eIndex();c=c.parent();this.setEnd(c,e)}},insertNode:function(a){this.optimizeBookmark();this.trim(n,m);var d=this.startContainer;d[0].insertBefore(a[0],d[0].childNodes[this.startOffset]||null);d[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var c=d(this.document);
if(a.is2){var e=c._4eGetByAddress(a.start,a.normalized),g=a.startOffset,c=a.end&&c._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(e,g);c?this.setEnd(c,a):this.collapse(m)}else{e=(g=a.serializable)?d("#"+a.startNode,c):a.startNode;a=g?d("#"+a.endNode,c):a.endNode;this.setStartBefore(e);e._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(m)}},getCommonAncestor:function(a,d){var c=this.startContainer,e=this.endContainer,c=c[0]===e[0]?a&&c[0].nodeType===j.NodeType.ELEMENT_NODE&&
this.startOffset===this.endOffset-1?new f(c[0].childNodes[this.startOffset]):c:c._4eCommonAncestor(e);return d&&c[0].nodeType===j.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(c,e,g,f){var i=c[e?"startContainer":"endContainer"],b,h=e?0:1,o=0,k=e?"previousSibling":"nextSibling";b=c[e?"startOffset":"endOffset"];if(i[0].nodeType===j.NodeType.TEXT_NODE){if(e){if(b)return}else if(b<i[0].nodeValue.length)return;b=i[0][k];i=i[0].parentNode}else{b=i[0].childNodes[b+(e?-1:1)]||null;i=i[0]}for(;i;){for(;b;)if(A(b)||
B(b))b=b[k];else break;if(b){if(!o)c[e?"setStartAfter":"setEndBefore"](d(b));break}i=d(i);if(i.nodeName()==="body")break;if(o||i.equals(f)){g[h]=i;o=1}else c[e?"setStartBefore":"setEndAfter"](i);b=i[0][k];i=i[0].parentNode}}return function(g){var b;switch(g){case e.ENLARGE_ELEMENT:if(this.collapsed)break;var g=this.getCommonAncestor(),h=[];a(this,1,h,g);a(this,0,h,g);if(h[0]&&h[1]){g=h[0].contains(h[1])?h[1]:h[0];this.setStartBefore(g);this.setEndAfter(g)}break;case e.ENLARGE_BLOCK_CONTENTS:case e.ENLARGE_LIST_ITEM_CONTENTS:b=
new s(this.document);h=new f(this.document.body);b.setStartAt(h,e.POSITION_AFTER_START);b.setEnd(this.startContainer,this.startOffset);b=new t(b);var o,k,A=t.blockBoundary(g===e.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:c),z=function(a){var c=A(a);c||(o=d(a));return c},m=function(a){var c=z(a);!c&&j.nodeName(a)==="br"&&(k=d(a));return c};b.guard=z;b=b.lastBackward();o=o||h;this.setStartAt(o,o.nodeName()!=="br"&&(!b&&this.checkStartOfBlock()||b&&o.contains(b))?e.POSITION_AFTER_START:e.POSITION_AFTER_END);
b=this.clone();b.collapse();b.setEndAt(h,e.POSITION_BEFORE_END);b=new t(b);b.guard=g===e.ENLARGE_LIST_ITEM_CONTENTS?m:z;o=c;b=b.lastForward();o=o||h;this.setEndAt(o,!b&&this.checkEndOfBlock()||b&&o.contains(b)?e.POSITION_BEFORE_END:e.POSITION_BEFORE_START);k&&this.setEndAfter(k)}}}(),checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType===j.NodeType.TEXT_NODE&&r.trim(a[0].nodeValue.substring(0,d)).length)return n;this.trim();a=new q(this.startContainer);d=this.clone();
d.collapse(m);d.setStartAt(a.block||a.blockLimit,e.POSITION_AFTER_START);a=new t(d);a.evaluator=x(m);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType===j.NodeType.TEXT_NODE&&r.trim(a[0].nodeValue.substring(d)).length)return n;this.trim();a=new q(this.endContainer);d=this.clone();d.collapse(n);d.setEndAt(a.block||a.blockLimit,e.POSITION_BEFORE_END);a=new t(d);a.evaluator=x(n);return a.checkForward()},checkBoundaryOfElement:function(a,d){var c=
this.clone();c[d===e.START?"setStartAt":"setEndAt"](a,d===e.START?e.POSITION_AFTER_START:e.POSITION_BEFORE_END);c=new t(c);c.evaluator=v;return c[d===e.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,c=this.endContainer,e=this.startOffset,f=this.endOffset,b;if(a[0].nodeType===j.NodeType.ELEMENT_NODE){b=a[0].childNodes.length;if(b>e)a=d(a[0].childNodes[e]);else if(b===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4eNextSourceNode()||
a}}if(c[0].nodeType===j.NodeType.ELEMENT_NODE){b=c[0].childNodes.length;if(b>f)c=d(c[0].childNodes[f])._4ePreviousSourceNode(m);else if(b===0)c=c._4ePreviousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=d(c)}}a._4ePosition(c)&g.POSITION_FOLLOWING&&(a=c);return{startNode:a,endNode:c}},fixBlock:function(a,c){var g=this.createBookmark(),f=d(this.document.createElement(c));this.collapse(a);this.enlarge(e.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4eTrim();k.ie||f._4eAppendBogus();
this.insertNode(f);this.moveToBookmark(g);return f},splitBlock:function(a){var d=new q(this.startContainer),g=new q(this.endContainer),f=d.block,b=g.block,j=c;if(!d.blockLimit.equals(g.blockLimit))return c;if(a!=="br"){if(!f){f=this.fixBlock(m,a);b=(new q(this.endContainer)).block}b||(b=this.fixBlock(n,a))}a=f&&this.checkStartOfBlock();d=b&&this.checkEndOfBlock();this.deleteContents();if(f&&f[0]===b[0])if(d){j=new q(this.startContainer);this.moveToPosition(b,e.POSITION_AFTER_END);b=c}else if(a){j=
new q(this.startContainer);this.moveToPosition(f,e.POSITION_BEFORE_START);f=c}else{b=this.splitElement(f);!k.ie&&!r.inArray(f.nodeName(),["ul","ol"])&&f._4eAppendBogus()}return{previousBlock:f,nextBlock:b,wasStartOfBlock:a,wasEndOfBlock:d,elementPath:j}},splitElement:function(a){if(!this.collapsed)return c;this.setEndAt(a,e.POSITION_BEFORE_END);var d=this.extractContents(),g=a.clone(n);g[0].appendChild(d);g.insertAfter(a);this.moveToPosition(a,e.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(a,
d){for(var c=0;a;){if(a[0].nodeType===j.NodeType.TEXT_NODE){this.moveToPosition(a,d?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);c=1;break}if(a[0].nodeType===j.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,d?e.POSITION_BEFORE_END:e.POSITION_AFTER_START);c=1}var g=a,f=c,b=void 0;g[0].nodeType===j.NodeType.ELEMENT_NODE&&g._4eIsEditable()&&(b=g[d?"last":"first"](w,1));!f&&!b&&(b=g[d?"prev":"next"](w,1));a=b}return!!c},selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,
d.nodeType===j.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(d){var c,e,g,f=d.nodeName();c=a.$block[f];this.deleteContents();if(c){for(c=this.getCommonAncestor(n,m);(e=a[c.nodeName()])&&(!e||!e[f]);){var b=c.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(c);this.collapse(m);c.remove()}else g=c;c=b}g&&this.splitElement(g)}this.insertNode(d)}});h.injectDom({_4eBreakParent:function(a,c){var c=d(c),a=d(a),e,g=new p.Range(a[0].ownerDocument);
g.setStartAfter(a);g.setEndAfter(c);e=g.extractContents();g.insertNode(a.remove());a.after(e)}});return p.Range=s});
KISSY.add("editor/dom","util,node,./base,./utils,dom,ua".split(","),function(E,b){function v(c,e){var g=c[e?"next":"prev"](void 0,1);if(g&&g[0].nodeType===h.ELEMENT_NODE){for(var f=[];g.attr("_ke_bookmark")||g._4eIsEmptyInlineRemovable(void 0);){f.push(g);g=e?g.next(void 0,1):g.prev(void 0,1);if(!g)return}if(c._4eIsIdentical(g,void 0)){for(var b=new x(e?c[0].lastChild:c[0].firstChild);f.length;)f.shift()._4eMove(c,!e,void 0);g._4eMoveChildren(c,!e,void 0);g.remove();b[0]&&b[0].nodeType===h.ELEMENT_NODE&&
b._4eMergeSiblings()}}}var w=b("util"),x=b("node"),l=b("./base"),u=b("./utils"),s=l.XHTML_DTD,f=b("dom"),h=f.NodeType,t=b("ua"),p={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};l.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var q=l.PositionType,r={block:1,"list-item":1,
table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},m={hr:1},n=function(c){return c&&(c[0]||c)};u.injectDom({_4eSameLevel:function(c,e){var e=n(e),g=c.parentNode;return g&&g===e.parentNode},_4eIsBlockBoundary:function(c,e){var g=w.merge(m,e);return!(!r[f.css(c,"display")]&&!g[f.nodeName(c)])},_4eIndex:function(c,e){for(var g=c.parentNode.childNodes,f,b=-1,a=0;a<g.length;a++){f=g[a];if(!e||
!(f.nodeType===3&&f.previousSibling&&f.previousSibling.nodeType===3)){b++;if(f===c)return b}}return-1},_4eMove:function(c,e,g){e=n(e);g?e.insertBefore(c,e.firstChild):e.appendChild(c)},_4eIsIdentical:function(c,e){if(!e)return false;e=n(e);if(f.nodeName(c)!==f.nodeName(e))return false;var g=c.attributes,b,h,a=e.attributes,d=g.length,o=a.length;if(d!==o)return false;for(var z=0;z<d;z++){b=g[z];h=b.name;if(b.specified&&f.attr(c,h)!==f.attr(e,h))return false}if(t.ieMode<8)for(z=0;z<o;z++){b=a[z];h=b.name;
if(b.specified&&f.attr(c,h)!==f.attr(e,h))return false}return true},_4eIsEmptyInlineRemovable:function(c){if(!s.$removeEmpty[f.nodeName(c)])return false;for(var c=c.childNodes,e=0,g=c.length;e<g;e++){var b=c[e],k=b.nodeType;if(!(k===h.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(k===h.ELEMENT_NODE&&!f._4eIsEmptyInlineRemovable(b)||k===f.NodeType.TEXT_NODE&&w.trim(b.nodeValue)))return false}return true},_4eMoveChildren:function(c,e,g){e=n(e);if(c!==e)if(g)for(;g=c.lastChild;)e.insertBefore(c.removeChild(g),
e.firstChild);else for(;g=c.firstChild;)e.appendChild(c.removeChild(g))},_4eMergeSiblings:function(c){c=new x(c);if(p[c.nodeName()]){v(c,true);v(c)}},_4eSplitText:function(c,e){var g=c.ownerDocument;if(c.nodeType===f.NodeType.TEXT_NODE){if(t.ie&&e===c.nodeValue.length){var b=g.createTextNode("");f.insertAfter(b,c);return b}b=c.splitText(e);if(g.documentMode){g=g.createTextNode("");f.insertAfter(g,b);f.remove(g)}return b}},_4eParents:function(c,e){var g=[];g.__IS_NODELIST=1;do g[e?"push":"unshift"](c);
while(c=c.parentNode);return g},_4eNextSourceNode:function(c,e,g,b){if(b&&!b.call)var k=n(b),b=function(a){return a!==k};var e=!e&&c.firstChild,a=c;if(!e){if(c.nodeType===h.ELEMENT_NODE&&b&&b(c,true)===false)return null;e=c.nextSibling}for(;!e&&(a=a.parentNode);){if(b&&b(a,true)===false)return null;e=a.nextSibling}return!e||b&&b(e)===false?null:g&&g!==e.nodeType?f._4eNextSourceNode(e,false,g,b):e},_4ePreviousSourceNode:function(c,e,g,b){if(b&&!b.call)var k=n(b),b=function(a){return a!==k};var e=!e&&
c.lastChild,a=c;if(!e){if(c.nodeType===h.ELEMENT_NODE&&b&&b(c,true)===false)return null;e=c.previousSibling}for(;!e&&(a=a.parentNode);){if(b&&b(a,true)===false)return null;e=a.previousSibling}return!e||b&&b(e)===false?null:g&&e.nodeType!==g?f._4ePreviousSourceNode(e,false,g,b):e},_4eCommonAncestor:function(c,e){e=n(e);if(c===e)return c;if(f.contains(e,c))return e;var g=c;do if(f.contains(g,e))return g;while(g=g.parentNode);return null},_4eHasAttributes:t.ieMode<9?function(c){for(var e=c.attributes,
g=0;g<e.length;g++){var f=e[g];switch(f.name){case "class":if(c.getAttribute("class"))return true;break;default:if(f.specified)return true}}return false}:function(c){t.gecko&&c.removeAttribute("_moz_dirty");return c.hasAttributes()},_4ePosition:function(c,e){var g=n(e);if(c.compareDocumentPosition)return c.compareDocumentPosition(g);if(c===g)return q.POSITION_IDENTICAL;if(c.nodeType===h.ELEMENT_NODE&&g.nodeType===h.ELEMENT_NODE){if(f.contains(c,g))return q.POSITION_CONTAINS+q.POSITION_PRECEDING;if(f.contains(g,
c))return q.POSITION_IS_CONTAINED+q.POSITION_FOLLOWING;if("sourceIndex"in c)return c.sourceIndex<0||g.sourceIndex<0?q.POSITION_DISCONNECTED:c.sourceIndex<g.sourceIndex?q.POSITION_PRECEDING:q.POSITION_FOLLOWING}for(var b=f._4eAddress(c),g=f._4eAddress(g),k=Math.min(b.length,g.length),a=0;a<=k-1;a++)if(b[a]!==g[a])return b[a]<g[a]?q.POSITION_PRECEDING:q.POSITION_FOLLOWING;return b.length<g.length?q.POSITION_CONTAINS+q.POSITION_PRECEDING:q.POSITION_IS_CONTAINED+q.POSITION_FOLLOWING},_4eAddress:function(c,
e){for(var g=[],b=c.ownerDocument.documentElement,h=c;h&&h!==b;){g.unshift(f._4eIndex(h,e));h=h.parentNode}return g},_4eRemove:function(c,e){var g=c.parentNode;if(g){if(e)for(var f;f=c.firstChild;)g.insertBefore(c.removeChild(f),c);g.removeChild(c)}return c},_4eTrim:function(c){f._4eLtrim(c);f._4eRtrim(c)},_4eLtrim:function(c){for(var e;e=c.firstChild;){if(e.nodeType===f.NodeType.TEXT_NODE){var g=u.ltrim(e.nodeValue),b=e.nodeValue.length;if(g){if(g.length<b){f._4eSplitText(e,b-g.length);c.removeChild(c.firstChild)}}else{c.removeChild(e);
continue}}break}},_4eRtrim:function(c){for(var e;e=c.lastChild;){if(e.type===f.NodeType.TEXT_NODE){var g=u.rtrim(e.nodeValue),b=e.nodeValue.length;if(g){if(g.length<b){f._4eSplitText(e,g.length);c.removeChild(c.lastChild)}}else{c.removeChild(e);continue}}break}if(!t.ie)(e=c.lastChild)&&e.nodeType===1&&f.nodeName(e)==="br"&&c.removeChild(e)},_4eAppendBogus:function(c){for(var e=c.lastChild;e&&e.nodeType===f.NodeType.TEXT_NODE&&!w.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType===f.NodeType.TEXT_NODE||
f.nodeName(e)!=="br"){e=c.ownerDocument.createElement("br");c.appendChild(e)}},_4eSetMarker:function(c,e,g,f){var c=new x(c),b=c.data("list_marker_id")||c.data("list_marker_id",w.guid()).data("list_marker_id"),a=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");e[b]=c;a[g]=1;return c.data(g,f)},_4eClearMarkers:function(c,e,g){var c=new x(c),f=c.data("list_marker_names"),b=c.data("list_marker_id"),a;for(a in f)c.removeData(a);c.removeData("list_marker_names");if(g){c.removeData("list_marker_id");
delete e[b]}},_4eCopyAttributes:function(c,e,g){for(var e=new x(e),b=c.attributes,g=g||{},h=0;h<b.length;h++){var a=b[h],d=a.name.toLowerCase(),o;if(!(d in g))if(d==="checked"&&(o=f.attr(c,d)))e.attr(d,o);else if(a.specified||t.ie&&a.value&&d==="value"){o=f.attr(c,d);if(o===null)o=a.nodeValue;e.attr(d,o)}}if(c.style.cssText!=="")e[0].style.cssText=c.style.cssText},_4eIsEditable:function(c){c=f.nodeName(c);return(c=!s.$nonEditable[c]&&(s[c]||s.span))&&c["#text"]},_4eGetByAddress:function(c,e,g){for(var c=
c.documentElement,f=0;c&&f<e.length;f++){var b=e[f];if(g)for(var a=-1,d=0;d<c.childNodes.length;d++){var h=c.childNodes[d];if(!(g===true&&h.nodeType===3&&h.previousSibling&&h.previousSibling.nodeType===3)){a++;if(a===b){c=h;break}}}else c=c.childNodes[b]}return c}})});
KISSY.add("editor/walker",["./base","util","ua","dom","node"],function(E,b){function v(c,e){if(this._.end)return h;var b,a=this.range,d,o=this.guard,z=this.type,A=c?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),h;if(!c&&!this._.guardLTR){var m=a.endContainer[0],n=m.childNodes[a.endOffset];this._.guardLTR=function(a,d){return d&&(m===a||"body"===p.nodeName(a))?!1:a!==n}}if(c&&!this._.guardRTL){var l=a.startContainer[0],q=0<a.startOffset&&
l.childNodes[a.startOffset-1]||null;this._.guardRTL=function(a,d){return d&&(l===a||"body"===p.nodeName(a))?!1:a!==q}}var i=c?this._.guardRTL:this._.guardLTR;d=o?function(a,d){return i(a,d)===f?f:o(a,d)}:i;this.current?b=this.current[A](f,z,d):c?(b=a.endContainer,0<a.endOffset?(b=new r(b[0].childNodes[a.endOffset-1]),d(b[0])===f&&(b=h)):b=d(b,s)===f?h:b._4ePreviousSourceNode(s,z,d,void 0)):(b=a.startContainer,b=new r(b[0].childNodes[a.startOffset]),b.length?d(b[0])===f&&(b=h):b=d(a.startContainer,
s)===f?h:a.startContainer._4eNextSourceNode(s,z,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==f){if(!e)return b}else if(e&&this.evaluator)return f;b=b[A](f,z,d)}this.end();return this.current=h}function w(c){for(var e,b=h;e=v.call(this,c);)b=e;return b}function x(c){this.range=c;this.guard=this.evaluator=h;this._={}}var l=b("./base"),u=b("util"),s=!0,f=!1,h=null,t=b("ua"),p=b("dom"),q=l.XHTML_DTD,r=b("node");u.augment(x,{end:function(){this._.end=1},next:function(){return v.call(this)},
previous:function(){return v.call(this,s)},checkForward:function(){return v.call(this,f,s)!==f},checkBackward:function(){return v.call(this,s,s)!==f},lastForward:function(){return w.call(this)},lastBackward:function(){return w.call(this,s)},reset:function(){delete this.current;this._={}},_iterator:v});u.mix(x,{blockBoundary:function(c){return function(e){return!(e.nodeType===p.NodeType.ELEMENT_NODE&&p._4eIsBlockBoundary(e,c))}},bookmark:function(c,e){function b(a){return"span"===p.nodeName(a)&&p.attr(a,
"_ke_bookmark")}return function(a){var d,f;d=a.nodeType===p.NodeType.TEXT_NODE&&(f=a.parentNode)&&b(f);d=c?d:d||b(a);return!!(e^d)}},whitespaces:function(c){return function(e){e=e.nodeType===p.NodeType.TEXT_NODE&&!u.trim(e.nodeValue);return!!(c^e)}},invisible:function(c){var e=x.whitespaces();return function(b){b=e(b)||b.nodeType===p.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(c^b)}}});var m=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,n=x.whitespaces(),c=x.bookmark(),e=function(e){var b=p.nodeName(e);return c(e)||
n(e)||1===e.nodeType&&b in q.$inline&&!(b in q.$empty)};l.Utils.injectDom({_4eGetBogus:function(c){c=new r(c);do c=c._4ePreviousSourceNode();while(c&&e(c[0]));return c&&(!t.ie?"br"===c.nodeName():3===c[0].nodeType&&m.test(c.text()))?c[0]:!1}});return l.Walker=x});
KISSY.add("editor/element-path",["node","./base","./dom","dom"],function(E,b){function v(b){for(var t=u,p=u,q=[];b;){if(b[0].nodeType===x.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=b);var r=b.nodeName();if(!p&&(!t&&s[r]&&(t=b),f[r])){var m;if(m=!t)if(m="div"===r){a:{m=b[0].childNodes;for(var n=0,c=m.length;n<c;n++){var e=m[n];if(e.nodeType===x.NodeType.ELEMENT_NODE&&l.$block[e.nodeName.toLowerCase()]){m=!0;break a}}m=!1}m=!m}m?t=b:p=b}q.push(b);if("body"===r)break}b=b.parent()}this.block=
t;this.blockLimit=p;this.elements=q}b("node");var w=b("./base");b("./dom");var x=b("dom"),l=w.XHTML_DTD,u=null,s={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},f={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={constructor:v,compare:function(b){var f=this.elements,b=b&&b.elements;if(!b||f.length!==b.length)return!1;for(var p=0;p<f.length;p++)if(!x.equals(f[p],b[p]))return!1;return!0},contains:function(b){for(var f=this.elements,p=0;p<
f.length;p++)if(f[p].nodeName()in b)return f[p];return u},toString:function(){var b=this.elements,f,p=[];for(f=0;f<b.length;f++)p.push(b[f].nodeName());return p.toString()}};return w.ElementPath=v});
KISSY.add("editor/selection","util,node,./walker,./range,./base,ua,dom".split(","),function(E,b){function v(a){this.document=a;this._={cache:{}};if(c)try{var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!==a||d.parentElement&&d.parentElement().ownerDocument!==a)this.isInvalid=t}catch(e){this.isInvalid=t}}function w(a){a=new v(a);return!a||a.isInvalid?p:a}var x=b("util"),l=b("node"),u=l.all,s=b("./walker"),f=b("./range"),h=b("./base");h.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,
SELECTION_ELEMENT:3};var t=true,p=null,q=b("ua"),r=b("dom"),m=h.SelectionType,n=h.RangeType,c=document.selection,e={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(v,{getNative:!c?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=r.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!c?function(){var a=
this._.cache;if(a.type)return a.type;var d=m.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount===1){var c=c.getRangeAt(0),b=c.startContainer;if(b===c.endContainer&&b.nodeType===r.NodeType.ELEMENT_NODE&&Number(c.endOffset-c.startOffset)===1&&e[b.childNodes[c.startOffset].nodeName.toLowerCase()])d=m.SELECTION_ELEMENT}}else d=m.SELECTION_NONE;return a.type=d}:function(){var a=this._.cache;if(a.type)return a.type;var d=m.SELECTION_NONE;try{var c=this.getNative(),e=c.type;if(e==="Text")d=m.SELECTION_TEXT;
if(e==="Control")d=m.SELECTION_ELEMENT;if(c.createRange().parentElement)d=m.SELECTION_TEXT}catch(b){}return a.type=d},getRanges:c?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var e=a.parentElement(),b=e.childNodes,f,g=0;g<b.length;g++){var h=b[g];if(h.nodeType===r.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(h);var h=f.compareEndPoints("StartToStart",a),m=f.compareEndPoints("EndToStart",a);f.collapse();if(h>0)break;else{if(!h||m===1&&h===-1)return{container:e,offset:g};
if(!m)return{container:e,offset:g+1}}f=p}}if(!f){f=a.duplicate();f.moveToElementText(e);f.collapse(false)}f.setEndPoint("StartToStart",a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;f>0;)f=f-b[--g].nodeValue.length}catch(i){f=0}return f===0?{container:e,offset:g}:{container:b[g],offset:-f}};return function(d){var c=this._.cache;if(c.ranges&&!d)return c.ranges;var e=this.getNative(),d=e&&e.createRange(),b=this.getType();if(!e)return[];if(b===m.SELECTION_TEXT){e=new f(this.document);b=a(d,
t);e.setStart(new l(b.container),b.offset);b=a(d);e.setEnd(new l(b.container),b.offset);c.ranges=[e];return[e]}if(b===m.SELECTION_ELEMENT){c=c.ranges=[];for(b=0;b<d.length;b++){for(var g=d.item(b),h=g.parentNode,j=0,e=new f(this.document);j<h.childNodes.length&&h.childNodes[j]!==g;j++);e.setStart(new l(h),j);e.setEnd(new l(h),j+1);c.push(e)}return c}c.ranges=[];return[]}}():function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var a=[],c=this.getNative();if(!c)return[];for(var e=0;e<c.rangeCount;e++){var b=
c.getRangeAt(e),g=new f(this.document);g.setStart(new l(b.startContainer),b.startOffset);g.setEnd(new l(b.endContainer),b.endOffset);a.push(g)}return d.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==void 0)return a.startElement;var d,e=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var b=this.getRanges()[0];if(b&&!b.collapsed){for(b.optimize();t;){d=b.startContainer;if(b.startOffset===(d[0].nodeType===
r.NodeType.ELEMENT_NODE?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4eIsBlockBoundary())b.setStartAfter(d);else break}d=b.startContainer;if(d[0].nodeType!==r.NodeType.ELEMENT_NODE)return d.parent();d=new l(d[0].childNodes[b.startOffset]);if(!d[0]||d[0].nodeType!==r.NodeType.ELEMENT_NODE)return b.startContainer;for(b=d[0].firstChild;b&&b.nodeType===r.NodeType.ELEMENT_NODE;){d=new l(b);b=b.firstChild}return d}if(c){b=e.createRange();b.collapse(t);d=new l(b.parentElement())}else{if((d=e.anchorNode)&&
d.nodeType!==r.NodeType.ELEMENT_NODE)d=d.parentNode;d&&(d=new l(d))}}return a.startElement=d},getSelectedElement:function(){var a,d=this._.cache;if(d.selectedElement!==void 0)return d.selectedElement;if(c){a=this.getNative().createRange();a=a.item&&a.item(0)}var b;if(a)b=new l(a);else{a=this.getRanges()[0];for(var f,g=2;g&&(!(b=a.getEnclosedNode())||!(b[0].nodeType===r.NodeType.ELEMENT_NODE&&e[b.nodeName()]&&(f=b)));g--)a.shrink(n.SHRINK_ELEMENT);b=f}a=b;return d.selectedElement=a},reset:function(){this._.cache=
{}},selectElement:function(a){var d,b=this.document;if(c)try{d=b.body.createControlRange();d.addElement(a[0]);d.select()}catch(e){d=b.body.createTextRange();d.moveToElementText(a[0]);d.select()}finally{}else{d=b.createRange();d.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(d)}this.reset()},selectRanges:function(a){if(c){if(a.length>1){var d=a[a.length-1];a[0].setEnd(d.endContainer,d.endOffset);a.length=1}a[0]&&a[0].select()}else{d=this.getNative();if(!d)return;d.removeAllRanges();
for(var b=0;b<a.length;b++){var e=a[b],f=this.document.createRange(),g=e.startContainer;if(e.collapsed&&(q.gecko&&q.gecko<1.09||q.webkit)&&g[0].nodeType===r.NodeType.ELEMENT_NODE&&!g[0].childNodes.length){g[0].appendChild(this.document.createTextNode(q.webkit?"\u200b":""));e.startOffset++;e.endOffset++}f.setStart(g[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);d.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var d=[],c=this.getRanges(),b=0;b<c.length;b++)d.push(c[b].createBookmark2(a));
return d},createBookmarks:function(a,d){for(var c=[],b=this.document,e,d=d||this.getRanges(),f=d.length,g=0;g<f;g++){c.push(e=d[g].createBookmark(a,t));var h=(a=e.serializable)?u("#"+e.startNode,b):e.startNode;e=a?u("#"+e.endNode,b):e.endNode;for(var m=g+1;m<f;m++){var i=d[m],j=i.startContainer,n=i.endContainer;r.equals(j,h.parent())&&i.startOffset++;r.equals(j,e.parent())&&i.startOffset++;r.equals(n,h.parent())&&i.endOffset++;r.equals(n,e.parent())&&i.endOffset++}}return c},selectBookmarks:function(a){for(var d=
[],c=0;c<a.length;c++){var b=new f(this.document);b.moveToBookmark(a[c]);d.push(b)}this.selectRanges(d);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();c?a&&a.clear():a&&a.removeAllRanges()}});var g={table:1,
tbody:1,tr:1},j=s.whitespaces(t),k=/\ufeff|\u00a0/;f.prototype.select=!c?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType===r.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(q.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var d=this.document.createRange();d.setStart(a[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(t);d.setEnd(this.endContainer[0],
this.endOffset)}else throw c;}a=w(this.document).getNative();a.removeAllRanges();a.addRange(d)}:function(a){var d=this.collapsed,c,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset===1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType===r.NodeType.ELEMENT_NODE){(new v(this.document)).selectElement(new l(e));return}}(this.startContainer[0].nodeType===r.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in g||this.endContainer[0].nodeType===
r.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in g)&&this.shrink(n.SHRINK_ELEMENT,t);var f=this.createBookmark(),e=f.startNode,h;if(!d)h=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(e[0]);f.moveStart("character",1);if(h){a=this.document.body.createTextRange();a.moveToElementText(h[0]);f.setEndPoint("EndToEnd",a);f.moveEnd("character",-1)}else{for(c=e[0].nextSibling;c&&!j(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(k))&&(a||!e[0].previousSibling||e[0].previousSibling&&
r.nodeName(e[0].previousSibling)==="br");b=new l(this.document.createElement("span"));b.html("&#65279;");b.insertBefore(e);c&&r.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4eRemove();if(d){if(c){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(b){this.moveToPosition(b,n.POSITION_BEFORE_START);b._4eRemove()}}else{this.setEndBefore(h);h._4eRemove();f.select()}};v.getSelection=w;return h.Selection=v});
KISSY.add("editor/enter-key","util,node,ua,./walker,./base,./element-path".split(","),function(E,b){function v(b){var n;n=b.getSelection().getRanges();for(var c=n.length-1;c>0;c--)n[c].deleteContents();n=n[0];var c=n.document,e=new t(n.startContainer),g=n.checkStartOfBlock(),j=n.checkEndOfBlock(),e=e.block;if(g&&j){if(e&&(e.nodeName()==="li"||e.parent().nodeName()==="li")){if(b.hasCommand("outdent")){b.execCommand("save");b.execCommand("outdent");b.execCommand("save");return true}return false}}else if(e&&
e.nodeName()==="pre"&&!j){var k=s.ieMode<9?u(c.createTextNode("\r")):u(c.createElement("br"));n.insertNode(k);if(s.ieMode<9){k=u(c.createTextNode("\ufeff")).insertAfter(k);n.setStartAt(k,h.RangeType.POSITION_AFTER_START)}else n.setStartAfter(k);n.collapse(true);n.select();if(s.ieMode<9)k[0].nodeValue="";return}var a=n.splitBlock("p");if(!a)return true;var b=a.previousBlock,e=a.nextBlock,g=a.wasStartOfBlock,j=a.wasEndOfBlock,d;if(e){d=e.parent();if(d.nodeName()==="li"){e._4eBreakParent(d);e._4eMove(e.next(),
true)}}else if(b&&(d=b.parent())&&d.nodeName()==="li"){b._4eBreakParent(d);n.moveToElementEditablePosition(b.next());b._4eMove(b.prev())}if(!g&&!j){if(e.nodeName()==="li"&&(d=e.first(f.invisible(true)))&&x.inArray(d.nodeName(),["ul","ol"]))(p?new l(c.createTextNode("\u00a0")):new l(c.createElement("br"))).insertBefore(d);e&&n.moveToElementEditablePosition(e)}else{if(b){if(b.nodeName()==="li"||!q.test(b.nodeName()))k=b.clone()}else e&&(k=e.clone());k||(k=new l("<p>",null,c));if(d=a.elementPath)for(var a=
0,o=d.elements.length;a<o;a++){var z=d.elements[a];if(z.equals(d.block)||z.equals(d.blockLimit))break;if(r.$removeEmpty[z.nodeName()]){z=z.clone();k._4eMoveChildren(z);k.append(z)}}p||k._4eAppendBogus();n.insertNode(k);if(p&&g&&(!j||!b[0].childNodes.length)){n.moveToElementEditablePosition(j?b:k);n.select()}n.moveToElementEditablePosition(g&&!j?e:k)}if(!p)if(e){k=new l(c.createElement("span"));k.html("&nbsp;");n.insertNode(k);k.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,
onlyScrollIfNeeded:true});n.deleteContents()}else k.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});n.select();return true}function w(b){b.get("document").on("keydown",function(f){if(f.keyCode===13&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){b.execCommand("save");var c=b.execCommand("enterBlock");b.execCommand("save");c!==false&&f.preventDefault()}})}var x=b("util"),l=b("node"),u=l.all,s=b("ua"),f=b("./walker"),h=b("./base"),t=b("./element-path"),p=s.ieMode<
11,q=/^(?:h[1-6])|(?:pre)$/i,r=h.XHTML_DTD;return{init:function(b){b.addCommand("enterBlock",{exec:v});b.docReady(function(){w(b)})}}});
KISSY.add("editor/html-data-processor",["html-parser","ua","node","util"],function(E,b){function v(b){if(!s.$removeEmpty[b.nodeName])return!1;var b=b.childNodes,h,l,r=b.length;if(r)for(h=0;h<r;h++)if(l=b[h],l.nodeType!==f.TEXT_NODE||l.nodeValue||!v(l))return!1;return!0}var w=b("html-parser"),x=b("ua"),l=11>x.ieMode,u=b("node"),s=w.DTD,f=u.NodeType,h=b("util");return{init:function(b){function f(a){return!v(a)}function q(a){return a.replace(e,function(a,c,d){return"<"+c+d.replace(g,function(a,c){return-1===
d.indexOf("_keSaved_"+c)?" _keSaved_"+a+" "+a:a})+">"})}function r(a){return a.replace(k,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function m(c){return c.replace(a,function(a,c){return h.urlDecode(c)})}var n=new w.Filter,c=new w.Filter;(function(){function a(c){c=w.serialize(c);return new w.Comment(j+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,
noscript:a,span:f}},b={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=["name","href","src"],d,b=0;b<c.length;b++)d="_keSaved_"+c[b],a.getAttribute(d)&&a.removeAttribute(c[b]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"===c.nodeName){var d=c.getAttribute("width"),c=c.getAttribute("height");d&&a.setAttribute("width",d);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:f,strong:f,
em:f,del:f,u:f},attributes:{style:function(a){if(!h.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,j.length)===j)return a=h.trim(h.urlDecode(a.substr(j.length))),w.parse(a).childNodes[0]}};l&&(b.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});n.addRules(b);c.addRules(d)})();(function(){function a(c){for(var c=c.childNodes,d=c.length,b=c[d-1];b&&(3===
b.nodeType&&!h.trim(b.nodeValue)||1===b.nodeType&&v(b));)b=c[--d];return b}function d(c){var b=a(c);b&&(1===b.nodeType&&"br"===b.nodeName?c.removeChild(b):3===b.nodeType&&g.test(b.nodeValue)&&c.removeChild(b))}function b(c){var d=a(c);return!d||"form"===c.nodeName&&"input"===d.nodeName}function e(a){d(a);b(a)&&(l||a.appendChild(new w.Tag("br")))}function f(a){d(a);b(a)&&a.appendChild(new w.Text("\u00a0"))}var g=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,j=h.merge(s.$block,s.$listItem,s.$tableContent),o;for(o in j)"br"in
s[o]||delete j[o];delete j.pre;var m={tags:{}},k={tags:{}};for(o in j)m.tags[o]=e,k.tags[o]=f;c.addRules(m);n.addRules(k)})();n.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var e=/<(a|area|img|input)\b([^>]*)>/gi,g=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",k=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,a=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
d=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,o=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,z=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;b.htmlDataProcessor={dataFilter:c,htmlFilter:n,toHtml:function(a){x.webkit&&(a=a.replace(/\u200b/g,""));var c=new w.BeautifyWriter;(new w.Parser(a)).parse().writeHtml(c,n);return a=c.getHtml()},toDataFormat:function(a,b){var b=b||c,a=r(a),a=q(a),a=a.replace(d,"$1ke:$2"),a=a.replace(z,"<ke:$1$2></ke:$1>"),
e=new u("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(o,"$1$2");a=m(a);e=new w.BasicWriter;(new w.Parser(a)).parse().writeHtml(e,b);return a=e.getHtml()},toServer:function(a){var c=new w.MinifyWriter;(new w.Parser(a)).parse().writeHtml(c,n);return c.getHtml()}}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node","ua","dom"],function(E,b){function v(b){function f(c,d){var b=a.body.createTextRange();try{b.moveToPoint(c,d)}catch(e){b=t}return b}function c(){var b=a.selection.createRange();d&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&d.select();k.detach("mouseup",c);k.detach("mousemove",e);d=g=0}function e(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",d)?a.setEndPoint("StartToStart",d):a.setEndPoint("EndToEnd",
d),a.select()}else c()}var g,h=b.get("window")[0],k=b.get("document"),a=k[0],d;k.on("mousedown contextmenu",function(b){var m=a.documentElement;if(b.target===m&&(g&&c(),!(m.scrollHeight>m.clientHeight)&&(g=1,d=f(b.pageX,b.pageY))))k.on("mouseup",c),k.on("mousemove",e),h.focus(),d.select()})}function w(b){function n(a){if(k){var e=b.getSelection(),g=e&&e.getType(),h=e&&c.selection;if(a&&h&&g===r.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){n(f)},50);else{var l;if(!h||
!h.type||!("Control"!==h.type&&(l=h.createRange())&&(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))j=h&&e.getRanges()[0],b.checkSelectionChange()}}}var c=b.get("document")[0],e=new s(c.body),g=new s(c.documentElement);if(8>p.ieMode)g.on("click",function(a){"html"===(new s(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var j,k,a=f;g.on("mousedown",function(){a=h});g.on("mouseup",function(){a=f});e.on("focusin",function(c){if("body"===(new s(c.target)).nodeName()&&
j){try{a&&j.select()}catch(b){}j=t}});e.on("focus",function(){k=f;n()});e.on("beforedeactivate",function(c){c.relatedTarget||(k=h,a=f)});e.on("mousedown",function(){k=h});e.on("mouseup",function(){k=f;setTimeout(function(){n(f)},0)});e.on("keydown",function(){k=h});e.on("keyup",function(){k=f;setTimeout(function(){n()},0)})}function x(b){b.get("document").on("mouseup keyup selectionchange",function(){b.checkSelectionChange()})}function l(b){function l(a){var c=u.XHTML_DTD;return a._4eIsBlockBoundary()&&
c.$empty[a.nodeName()]}function c(a){return g(a)&&j(a)}var e=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,g=u.Walker.whitespaces(f),j=u.Walker.bookmark(h,f),k=function(a){return g(a)&&8!==a.nodeType};b.on("selectionChange",function(a){var d=a.path,g=b.get("document")[0],j=new s(g.body),a=(a=a.selection)&&a.getRanges()[0],r=d.blockLimit;j[0]||(g.documentElement.appendChild(g.createElement("body")),j=new s(g.body),
a&&(a.setStart(j,0),a.collapse(1)));r=r||j;if(p.gecko){var t=(g=d.block||d.blockLimit)&&g.last(c);g&&g._4eIsBlockBoundary()&&(!t||!(1===t[0].nodeType&&t._4eIsBlockBoundary()))&&"pre"!==g.nodeName()&&!g._4eGetBogus()&&g._4eAppendBogus()}if(a&&a.collapsed&&!d.block){if("body"===r.nodeName()){"html"===a.startContainer.nodeName()&&a.setStart(j,0);if((d=a.fixBlock(f,"p"))&&d[0]!==j[0].lastChild&&d.outerHtml().match(e))if((g=d.next(k,1))&&g[0].nodeType===q.NodeType.ELEMENT_NODE&&!l[g])a.moveToElementEditablePosition(g),
d._4eRemove();else if((g=d.prev(k,1))&&g[0].nodeType===q.NodeType.ELEMENT_NODE&&!l[g])a.moveToElementEditablePosition(g,g.outerHtml().match(e)?h:f),d._4eRemove();a.select();b.notifySelectionChange()}d=b.get("document")[0];a=new u.Range(d);a.moveToElementEditablePosition(j,f);"body"!==(new u.ElementPath(a.startContainer)).blockLimit.nodeName()&&(j=(new s(d.createElement("p"))).appendTo(j),p.ie||j._4eAppendBogus())}})}var u=b("./base");b("./selection");var s=b("node"),f=!0,h=!1,t=null,p=b("ua"),q=b("dom"),
r=u.SelectionType;return{init:function(b){b.docReady(function(){if(document.selection)v(b),w(b);else if(x(b),p.ie){var f,c=b.get("document");c.on("focusout",function(){f=b.getSelection().getRanges()});c.on("focusin",function(){f&&(b.getSelection().selectRanges(f),f=null)})}});l(b)}}});
KISSY.add("editor/styles","util,node,./selection,./range,./base,./element-path,dom,ua".split(","),function(E,b){function v(a){return!y.attr(a,"_ke_bookmark")}function w(a,c){for(var b in a)typeof a[b]==="string"?a[b]=a[b].replace(U,function(a,b){return c[b]}):w(a[b],c)}function x(c,b){if(b){c=a.clone(c);w(c,b)}var d=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type=d==="#text"||T[d]?K.STYLE_BLOCK:P[d]?K.STYLE_OBJECT:K.STYLE_INLINE;this._={definition:c}}function l(a,c){var b=
c?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=new o(a),e=d.getRanges(),f=0;f<e.length;f++)b.call(this,e[f]);d.selectRanges(e)}function u(a,c,b){var e=a.element;e==="*"&&(e="span");c=new d(c.createElement(e));b&&b._4eCopyAttributes(c);b=a._.definition;a=b.attributes;b=x.getStyleText(b);if(a)for(var f in a)c.attr(f,a[f]);if(b)c[0].style.cssText=b;return c}function s(a){var c=a.createBookmark(D),b=a.createIterator();b.enforceRealBlocks=D;b.enlargeBr=D;for(var e,g=a.document;e=b.getNextParagraph();){var j=
u(this,g,e),i=j,j=i.nodeName==="pre",l=e.nodeName==="pre",k=!j&&l;if(j&&!l){l=e;k=l.html();k=f(k,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,"");k=k.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1");k=k.replace(/([\t\n\r]+|&nbsp;)/g," ");k=k.replace(/<br\b[^>]*>/gi,"\n");if(Q.ie){l=l[0].ownerDocument.createElement("div");l.appendChild(i[0]);i.outerHtml("<pre>"+k+"</pre>");i=new d(l.firstChild);i._4eRemove()}else i.html(k)}else k?i=t(h(e),i):e._4eMoveChildren(i);e[0].parentNode.replaceChild(i[0],e[0]);if(j){e=
i;j=void 0;if((j=e._4ePreviousSourceNode(D,y.NodeType.ELEMENT_NODE))&&j.nodeName()==="pre"){i=f(j.html(),/\n$/,"")+"\n\n"+f(e.html(),/^\n/,"");Q.ie?e.outerHtml("<pre>"+i+"</pre>"):e.html(i);j._4eRemove()}}}a.moveToBookmark(c)}function f(a,c,b){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,b){c&&(d=c);b&&(e=b);return""});return d+a.replace(c,b)+e}function h(a){var c=[];f(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,c,b){return c+"</pre>"+b+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,b){c.push(b)});return c}function t(a,c){for(var b=c[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=f(e,/^[\t]*\n/,""),e=f(e,/\n$/,""),e=f(e,/^[\t]+|[\t]+$/g,function(a,c){return a.length===1?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),g=c.clone();g.html(e);b.appendChild(g[0])}return b}function p(a){var c=a.document;if(a.collapsed){c=u(this,c,void 0);a.insertNode(c);a.moveToPosition(c,J.POSITION_BEFORE_END)}else{var b=this.element,e=this._.definition,f,h=O[b];if(!h){f=D;h=O.span}var j=a.createBookmark();a.enlarge(J.ENLARGE_ELEMENT);a.trim();for(var i=a.createBookmark(),l=i.startNode,i=i.endNode,k=l,m;k&&k[0];){var n=F;if(y.equals(k,i)){k=H;n=D}else{var p=k[0].nodeType,q=p===y.NodeType.ELEMENT_NODE?k.nodeName():H;if(q&&k.attr("_ke_bookmark")){k=
k._4eNextSourceNode(D);continue}if(!q||h[q]&&(k._4ePosition(i)|G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)===G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(k))){var o=k.parent();if(o&&b==="a"&&o.nodeName()===b){p=u(this,c,void 0);o._4eMoveChildren(p);o[0].parentNode.replaceChild(p[0],o[0]);p._4eMergeSiblings()}else if(o&&o[0]&&((O[o.nodeName()]||O.span)[b]||f)&&(!e.parentRule||e.parentRule(o))){if(!m&&(!q||!O.$removeEmpty[q]||(k._4ePosition(i)|
G.POSITION_PRECEDING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)===G.POSITION_PRECEDING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED)){m=new z(c);m.setStartBefore(k)}if(p===y.NodeType.TEXT_NODE||p===y.NodeType.ELEMENT_NODE&&!k[0].childNodes.length){o=k;for(p=null;(n=!o.next(v,1))&&(p=o.parent())&&h[p.nodeName()]&&(p._4ePosition(l)|G.POSITION_FOLLOWING|G.POSITION_IDENTICAL|G.POSITION_IS_CONTAINED)===G.POSITION_FOLLOWING+G.POSITION_IDENTICAL+G.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)o=
p;m.setEndAfter(o)}}else n=D}else n=D;k=k._4eNextSourceNode()}if(n&&m&&!m.collapsed){for(var n=u(this,c,void 0),o=m.getCommonAncestor(),p={},q={},r,t=null,s;n&&o&&n[0]&&o[0];){if(o.nodeName()===b){for(r in e.attributes)if(!q[r]&&(s=o.attr(t)))n.attr(r)===s?n.removeAttr(r):q[r]=1;for(t in e.styles)if(!p[t]&&(s=o.style(t)))n.style(t)===s?n.style(t,""):p[t]=1;if(!n._4eHasAttributes()){n=H;break}}o=o.parent()}if(n){n[0].appendChild(m.extractContents());g(this,n);m.insertNode(n);n._4eMergeSiblings();Q.ie||
n[0].normalize()}else{n=new d(c.createElement("span"));n[0].appendChild(m.extractContents());m.insertNode(n);g(this,n);n._4eRemove(true)}m=H}}l._4eRemove();i._4eRemove();a.moveToBookmark(j);a.shrink(J.SHRINK_TEXT)}}function q(a){a.enlarge(J.ENLARGE_ELEMENT);var b=a.createBookmark(),e=b.startNode;if(a.collapsed){for(var f=new B(e.parent()),g,h=0,k;h<f.elements.length&&(k=f.elements[h]);h++){if(k===f.block||k===f.blockLimit)break;if(this.checkElementRemovable(k)){var l=a.checkBoundaryOfElement(k,J.END),
m=!l&&a.checkBoundaryOfElement(k,J.START);if(m||l){g=k;g.match=m?"start":"end"}else{k._4eMergeSiblings();if(k.nodeName()!==this.element){l=n(this);j(k,l[k.nodeName()]||l["*"])}else c(this,k)}}}if(g){k=e;for(h=0;;h++){l=f.elements[h];if(l.equals(g))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(k[0]);k=l}k[g.match==="start"?"insertBefore":"insertAfter"](g);f=g.html();!f||f==="\u200b"?g.remove():Q.webkit&&i(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var o=b.endNode,p=this;g=
function(){for(var a=new B(e.parent()),c=new B(o.parent()),b=H,d,f=H,g=0;g<a.elements.length;g++){d=a.elements[g];if(d===a.block||d===a.blockLimit)break;p.checkElementRemovable(d)&&(b=d)}for(g=0;g<c.elements.length;g++){d=c.elements[g];if(d===c.block||d===c.blockLimit)break;p.checkElementRemovable(d)&&(f=d)}f&&o._4eBreakParent(f);b&&e._4eBreakParent(b)};g();for(f=new d(e[0].nextSibling);f[0]!==o[0];){h=f._4eNextSourceNode();if(f[0]&&f[0].nodeType===y.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)){if(f.nodeName()===
this.element)c(this,f);else{k=n(this);j(f,k[f.nodeName()]||k["*"])}if(h[0].nodeType===y.NodeType.ELEMENT_NODE&&h.contains(e)){g();h=new d(e[0].nextSibling)}}f=h}}a.moveToBookmark(b)}function r(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,b,d){c[b]=d});return c}function m(a,c){var b="";if(c!==F){b=document.createElement("span");b.style.cssText=a;b=b.style.cssText||""}else b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function n(c){if(c._.overrides)return c._.overrides;var b=c._.overrides={},d=c._.definition.overrides;if(d){a.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++){var f=d[e],g,h,i;if(typeof f==="string")g=f.toLowerCase();else{g=f.element?f.element.toLowerCase():c.element;h=f.attributes;i=f.styles}f=b[g]||(b[g]={});if(h){g=f.attributes=f.attributes||[];for(var j in h)g.push([j.toLowerCase(),h[j]])}if(i){var f=f.styles=f.styles||[],k;for(k in i)f.push([k.toLowerCase(),i[k]])}}}return b}
function c(c,b){var d=c._.definition,f=n(c),g=a.merge(d.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),d=a.merge(d.styles,(f[b.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(g)&&a.isEmptyObject(d),h;for(h in g)if(!((h==="class"||c._.definition.fullMatch)&&b.attr(h)!==e(h,g[h]))){f=f||!!b.hasAttr(h);b.removeAttr(h)}for(var i in d)if(!(c._.definition.fullMatch&&b.style(i)!==e(i,d[i],D))){f=f||!!b.style(i);b.style(i,"")}k(b)}function e(a,c,b){var e=new d("<span>");e[b?"style":"attr"](a,c);
return e[b?"style":"attr"](a)}function g(a,b){for(var e=n(a),f=b.all(a.element),g=f.length;--g>=0;)c(a,new d(f[g]));for(var h in e)if(h!==a.element){f=b.all(h);for(g=f.length-1;g>=0;g--){var i=new d(f[g]);j(i,e[h])}}}function j(a,c){var b,d,e=c&&c.attributes;if(e)for(b=0;b<e.length;b++){var f=e[b][0];if(d=a.attr(f)){var g=e[b][1];(g===H||g.test&&g.test(d)||typeof g==="string"&&d===g)&&a[0].removeAttribute(f)}}if(e=c&&c.styles)for(b=0;b<e.length;b++){f=e[b][0];if(g=a.css(f)){var h=e[b][1];(h===H||
h.test&&h.test(d)||typeof h==="string"&&g===h)&&a.css(f,"")}}k(a)}function k(a){if(!a._4eHasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4eRemove(D);if(c){c.nodeType===y.NodeType.ELEMENT_NODE&&y._4eMergeSiblings(c);b&&c!==b&&b.nodeType===y.NodeType.ELEMENT_NODE&&y._4eMergeSiblings(b)}}}var a=b("util"),d=b("node"),o=b("./selection"),z=b("./range"),A=b("./base"),B=b("./element-path"),D=true,F=false,H=null,i=d.all,y=b("dom"),J=A.RangeType,G=A.PositionType,K,Q=b("ua"),T={address:1,div:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},O=A.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},S=/\s*(?:;\s*|$)/g,U=/#\((.+?)\)/g;A.StyleType=K={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};x.prototype={constructor:x,apply:function(a){l.call(this,a,F)},remove:function(a){l.call(this,a,D)},applyToRange:function(a){return(this.applyToRange=this.type===K.STYLE_INLINE?p:this.type===K.STYLE_BLOCK?s:H).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=
this.type===K.STYLE_INLINE?q:H).call(this,a)},checkElementRemovable:function(a,c){if(!a)return F;var b,d=this._.definition,e;if(a.nodeName()===this.element){if(!c&&!a._4eHasAttributes())return D;var f=d._AC;if(!f){var f={},g=0,h=d.attributes;if(h)for(var i in h){g++;f[i]=h[i]}if(h=x.getStyleText(d)){f.style||g++;f.style=h}f._length=g;d._AC=f}d=f;if(d._length){for(b in d)if(b!=="_length"){g=a.attr(b)||"";if(b==="style")a:{f=d[b];g=m(g,F);typeof f==="string"&&(f=r(f));typeof g==="string"&&(g=r(g));
h=void 0;for(h in f)if(!(h in g&&(g[h]===f[h]||f[h]==="inherit"||g[h]==="inherit"))){f=F;break a}f=D}else f=d[b]===g;if(f){if(!c)return D}else if(c)return F}if(c)return D}else return D}b=n(this);if(b=b[a.nodeName()]||b["*"]){if(!(d=b.attributes)&&!(e=b.styles))return D;if(d)for(f=0;f<d.length;f++){b=d[f][0];if(b=a.attr(b)){g=d[f][1];if(g===H||typeof g==="string"&&b===g||g.test&&g.test(b))return D}}if(e)for(f=0;f<e.length;f++)if(b=a.css(e[f][0])){d=e[f][1];if(d===H||typeof d==="string"&&b===d||d.test&&
d.test(b))return D}}return F},checkActive:function(a){switch(this.type){case K.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,D);case K.STYLE_OBJECT:case K.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++){d=c[b];if(!(this.type===K.STYLE_INLINE&&(y.equals(d,a.block)||y.equals(d,a.blockLimit))))if((this.type!==K.STYLE_OBJECT||d.nodeName()in P)&&this.checkElementRemovable(d,D))return D}}return F}};x.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&
a.attributes.style||"",d="";b.length&&(b=b.replace(S,";"));for(var e in c){var f=c[e],g=(e+":"+f).replace(S,";");f==="inherit"?d=d+g:b=b+g}b.length&&(b=m(b));b=b+d;return a._ST=b};return A.Style=x});
KISSY.add("editor/dom-iterator","util,node,./walker,./range,./base,./element-path,ua,dom".split(","),function(E,b){function v(b){if(!(arguments.length<1)){this.range=b;this.forceBrBreak=t;this.enlargeBr=h;this.enforceRealBlocks=t;this._=this._||{}}}var w=b("util"),x=b("node"),l=b("./walker"),u=b("./range"),s=b("./base"),f=b("./element-path"),h=true,t=false,p=b("ua"),q=s.RangeType,r=b("dom"),m=/^[\r\n\t ]*$/;w.augment(v,{getNextParagraph:function(b){var c,e,g,j,k,a;if(!this._.lastNode){g=this.range.clone();
g.shrink(q.SHRINK_ELEMENT,h);g.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);e=new l(g);var d=l.bookmark(h,h);e.evaluator=d;this._.nextNode=e.next();e=new l(g);e.evaluator=d;e=e.previous();this._.lastNode=e._4eNextSourceNode(h);if(this._.lastNode&&this._.lastNode[0].nodeType===r.NodeType.TEXT_NODE&&!w.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()){d=new u(g.document);d.moveToPosition(this._.lastNode,q.POSITION_AFTER_END);
if(d.checkEndOfBlock()){d=new f(d.endContainer);this._.lastNode=(d.block||d.blockLimit)._4eNextSourceNode(h)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=new x(g.document.createTextNode(""));r.insertAfter(this._.lastNode[0],e[0])}g=null}d=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;d;){var o=t,s=d[0].nodeType!==r.NodeType.ELEMENT_NODE,v=t;if(s)d[0].nodeType===r.NodeType.TEXT_NODE&&m.test(d[0].nodeValue)&&(s=t);else{var B=d.nodeName();if(d._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){if(B==="br")s=h;else if(!g&&!d[0].childNodes.length&&B!=="hr"){c=d;j=d.equals(e);break}if(g){g.setEndAt(d,q.POSITION_BEFORE_START);if(B!=="br")this._.nextNode=d}o=h}else{if(d[0].firstChild){if(!g){g=new u(this.range.document);g.setStartAt(d,q.POSITION_BEFORE_START)}d=new x(d[0].firstChild);continue}s=h}}if(s&&!g){g=new u(this.range.document);g.setStartAt(d,q.POSITION_BEFORE_START)}j=(!o||s)&&d.equals(e);if(g&&!o)for(;!d[0].nextSibling&&!j;){B=d.parent();if(B._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){o=h;j||B.equals(e);break}d=B;s=h;j=d.equals(e);v=h}s&&g.setEndAt(d,q.POSITION_AFTER_END);d=d._4eNextSourceNode(v,null,e);if((j=!d)||o&&g)break}if(!c){if(!g){this._.docEndMarker&&this._.docEndMarker._4eRemove();return this._.nextNode=null}c=new f(g.startContainer);d=c.blockLimit;o={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&o[d.nodeName()]&&g.checkStartOfBlock()&&g.checkEndOfBlock())c=d;else if(!c||this.enforceRealBlocks&&c.nodeName()==="li"){c=new x(this.range.document.createElement(b||
"p"));c[0].appendChild(g.extractContents());c._4eTrim();g.insertNode(c);k=a=h}else if(c.nodeName()!=="li"){if(!g.checkStartOfBlock()||!g.checkEndOfBlock()){c=c.clone(t);c[0].appendChild(g.extractContents());c._4eTrim();a=g.splitBlock();k=!a.wasStartOfBlock;a=!a.wasEndOfBlock;g.insertNode(c)}}else if(!j)this._.nextNode=c.equals(e)?null:g.getBoundaryNodes().endNode._4eNextSourceNode(h,null,e)}if(k){g=new x(c[0].previousSibling);g[0]&&g[0].nodeType===r.NodeType.ELEMENT_NODE&&(g.nodeName()==="br"?g._4eRemove():
g[0].lastChild&&r.nodeName(g[0].lastChild)==="br"&&r._4eRemove(g[0].lastChild))}if(a){g=l.bookmark(t,h);k=new x(c[0].lastChild);k[0]&&k[0].nodeType===r.NodeType.ELEMENT_NODE&&k.nodeName()==="br"&&(p.ie||k.prev(g,1)||k.next(g,1))&&k.remove()}if(!this._.nextNode)this._.nextNode=j||c.equals(e)?null:c._4eNextSourceNode(h,null,e);return c}});u.prototype.createIterator=function(){return new v(this)};return v});
KISSY.add("editor/z-index-manager",["./base"],function(E,b){var v=b("./base"),w=v.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(b){return(v.Config.baseZIndex||1E4)+b};return w});
