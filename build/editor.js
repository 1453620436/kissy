/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Aug 26 12:07
*/
KISSY.add("editor","util,logger-manager,node,xtemplate/runtime,editor/iframe-content-xtpl,editor/base,editor/utils,editor/focus-manager,editor/clipboard,editor/enter-key,editor/html-data-processor,editor/selection-fix,editor/styles,editor/dom-iterator,editor/z-index-manager,ua".split(","),function(w,b,B,x){function q(a,m){var c=a.get("textarea"),e=a.get("toolBarEl"),d=a.get("statusBarEl"),m=parseInt(m,10),m=m-((e&&e.outerHeight()||0)+(d&&d.outerHeight()||0));c.parent().css(y,m);c.css(y,m)}function r(a,
m){var c=a.body;J(function(){a.designMode="on";setTimeout(function L(){a.designMode="off";c.focus();if(!L.retry)L.retry=k},50)},function(){a.designMode="off";c.setAttribute("contentEditable",false);c.setAttribute("contentEditable",true);m||r(a,1)})}function n(a){var m=a.get("textarea")[0],e=a.get("window"),d=a.get("document"),k=d[0];if(l.webkit){d.on("click",function(a){var m=f(a.target);u.inArray(m.nodeName(),["input","select"])&&a.preventDefault()});d.on("mouseup",function(a){var m=f(a.target);
u.inArray(m.nodeName(),["input","textarea"])&&a.preventDefault()})}if(l.gecko||l.ie){var g;g=f('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>').insertAfter(m);g.on("focus",function(){a.focus()});a.activateGecko=function(){l.gecko&&a.__iframeFocus&&g[0].focus()};a.on("destroy",function(){g.detach();g.remove()})}e.on("focus",function(){l.gecko&&r(k,j);a.notifySelectionChange()});if(l.gecko)d.on("mousedown",function(){a.__iframeFocus||r(k,j)});if(H){d.on("keydown",
function(m){if(m.keyCode in{8:1,46:1}){var c=a.getSelection(),e=c.getSelectedElement();if(e){a.execCommand("save");var d=c.getRanges()[0].createBookmark();e.remove();c.selectBookmarks([d]);a.execCommand("save");m.preventDefault()}}});if(k.compatMode==="CSS1Compat"){var C={33:1,34:1};d.on("keydown",function(m){m.keyCode in C&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}if(l.webkit)d.on("mousedown",function(m){m=f(m.target);u.inArray(m.nodeName(),["img","hr","input","textarea","select"])&&
a.getSelection().selectElement(m)});if(l.gecko)d.on("dragstart",function(a){var m=f(a.target);m.nodeName()==="img"&&/ke_/.test(m[0].className)&&a.preventDefault()});c.add(a)}function t(a,m,c,e){var d="",k;k=b.resolve("editor/assets/iframe.css");c=c.concat([]);c.unshift(k);for(k=0;k<c.length;k++)d=d+u.substitute('<link href="{href}" rel="stylesheet" />',{href:c[k]});return(new v(s)).render({doctype:l.ieMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"{title}",links:d,style:"<style>"+
m+"</style>",data:e||"",script:a?'<script id="ke_active_script">'+(f(window).isCustomDomain()?'document.domain="'+document.domain+'";':"")+"parent."+E+'._initIframe("'+a+'");<\/script>':""})}function i(a,m){function c(){j=g.document;a.setInternal("document",f(j));a.setInternal("window",f(g));e.detach();j.open("text/html","replace");j.write(d);j.close()}var e=a.get("iframe"),d=t(a.get("id"),a.get("customStyle"),a.get("customLink"),m),k=e[0],g=k.contentWindow,j;e.__loaded=1;try{j=g.document}catch(C){k.src=
k.src;if(H<7){setTimeout(c,10);return}}c()}function o(a,m){var c=f(window).getEmptyIframeSrc()||"";c&&(c=' src="'+c+'" ');var c=f(u.substitute(F,{iframeSrc:c,prefixCls:a.get("prefixCls")})),e=a.get("textarea");e.hasAttr("tabindex")&&c.attr("tabindex",l.webkit?-1:e.attr("tabindex"));e.parent().prepend(c);a.set("iframe",c);a.__docReady=0;if(l.gecko&&!c.__loaded)c.on("load",function(){i(a,m)},a);else i(a,m)}function h(a){if(a.get("iframe")){var m=a.get("iframe"),c=a.get("window"),a=a.get("document"),
e=a[0],d=f(e.documentElement),e=f(e.body);u.each([a,d,e,c],function(a){a.detach()});m.remove()}}var u=b("util");b("logger-manager");var f=b("node"),v=b("xtemplate/runtime"),s=b("editor/iframe-content-xtpl"),p=b("editor/base"),g=b("editor/utils"),c=b("editor/focus-manager"),z=b("editor/clipboard"),d=b("editor/enter-key"),a=b("editor/html-data-processor"),e=b("editor/selection-fix");b("editor/styles");b("editor/dom-iterator");b("editor/z-index-manager");x.exports=p;var k=true,j=false,l=b("ua"),H=l.ieMode<
11,I=f.Dom.NodeType,y="height",J=g.tryThese,F='<iframe class="{prefixCls}editor-iframe" frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',m=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i;p.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};var C=u.buffer(function(){this.execCommand("save")},50),E="Editor"+ +new Date;window[E]=p;p.addMembers({initializer:function(){this.__commands={};this.__controls={};c.register(this)},renderUI:function(){z.init(this);d.init(this);
a.init(this);e.init(this)},bindUI:function(){function a(){m.detach("docReady",a);if(m.get("focused"))m.focus();else{var c=m.getSelection();c&&c.removeAllRanges()}}var m=this,c,e=m.get("prefixCls"),d=m.get("textarea");if(m.get("attachForm")&&(c=d[0].form)&&(c=f(c)))c.on("submit",m.sync,m);m.on("docReady",a);m.on("blur",function(){m.$el.removeClass(e+"editor-focused")});m.on("focus",function(){m.$el.addClass(e+"editor-focused")})},syncUI:function(){q(this,this.get("height"))},sync:function(){this.get("textarea").val(this.getData())},
getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,m){this.__controls[a]=m},showDialog:function(a,m){var a=a+"/dialog",c=this.__controls[a];c.show(m);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,m){this.__commands[a]=m},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var m=this.__commands[a],c=u.makeArray(arguments);c.shift();c.unshift(this);if(m)return m.exec.apply(m,
c)},queryCommandValue:function(a){return this.execCommand(g.getQueryCmd(a))},setData:function(a){var m,c=a;if(this.get("mode")!==1)this.get("textarea").val(a);else{if(m=this.htmlDataProcessor)c=m.toDataFormat(a);h(this);o(this,c)}},getData:function(a,c){var e=this.htmlDataProcessor,d;c===void 0&&(c=this.get("mode"));d=c===1&&this.isDocReady()?this.get("document")[0].body.innerHTML:e.toDataFormat(this.get("textarea").val());d=a?e.toHtml(d):e.toServer(d);d=u.trim(d);m.test(d)&&(d="");return d},getFormatData:function(a){return this.getData(1,
a)},getDocHtml:function(){return t(0,this.get("customStyle"),this.get("customLink"),this.getFormatData())},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},getSelectedHtml:function(){var a=this.getSelection().getRanges()[0],m="";if(a){a=a.cloneContents();m=this.get("document")[0].createElement("div");m.appendChild(a);m=m.innerHTML}return m},focus:function(){var a=this.get("window");if(a){var m=this.get("document")[0],a=a[0];l.ie||a&&a.parent&&a.parent.focus();a&&a.focus();
try{m.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,m){var c=this.get("window"),e=this.get("customStyle")||"";this.set("customStyle",e+("\n"+a));c&&c.addStyleSheet(a,m)},removeCustomStyle:function(a){this.get("document").on("#"+a).remove()},addCustomLink:function(a){var m=this.get("customLink"),c=this.get("document")[0];m.push(a);this.set("customLink",m);m=c.createElement("link");m.rel=
"stylesheet";c.getElementsByTagName("head")[0].appendChild(m);m.href=a},removeCustomLink:function(a){this.get("document").all("link").each(function(m){m.attr("href")===a&&m.remove()});var m=this.get("customLink"),c=u.indexOf(a,m);c!==-1&&m.splice(c,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=
setTimeout(function(){var m=a.getSelection();if(m&&!m.isInvalid){var c=m.getStartElement(),e=new p.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(e)){a.__previousPath=e;a.fire("selectionChange",{selection:m,path:e,element:c})}}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===1){this.focus();var m,c=a.nodeName(),e=p.XHTML_DTD,d=e.$block[c],g=p.RangeType,j=(c=this.getSelection())&&c.getRanges(),
E,l,f;if(j&&j.length!==0){this.execCommand("save");for(l=j.length-1;l>=0;l--){E=j[l];m=!l&&a||a.clone(k);E.insertNodeByDtd(m);f||(f=m)}if(f){E.moveToPosition(f,g.POSITION_AFTER_END);if(d){a=p.Walker.whitespaces(true);(a=(f=f.next(a,1))&&f[0].nodeType===I.ELEMENT_NODE&&f.nodeName())&&e.$block[a]&&e[a]["#text"]&&E.moveToElementEditablePosition(f)}c.selectRanges([E]);this.focus();m&&m[0].nodeType===1&&m.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});C.call(this);
return m}}}},insertHtml:function(a,m){var c=this,e,d=c.get("document")[0];if(c.get("mode")===1){if(e=c.htmlDataProcessor)a=e.toDataFormat(a,m);c.focus();c.execCommand("save");if(e=d.selection){e.type==="Control"&&e.clear();try{e.createRange().pasteHTML(a)}catch(k){}}else{e=c.get("iframe")[0].contentWindow.getSelection();var g=e.getRangeAt(0);g.deleteContents();var j=d.createElement("div");j.innerHTML=a;for(var d=d.createDocumentFragment(),E,l;E=j.firstChild;)l=d.appendChild(E);g.insertNode(d);if(l){g=
g.cloneRange();g.setStartAfter(l);g.collapse(true);e.removeAllRanges();e.addRange(g)}}setTimeout(function(){c.getSelection().scrollIntoView()},50);C.call(c)}},_onSetHeight:function(a){q(this,a)},_onSetMode:function(a){var m=this.get("iframe"),c=this.get("textarea");if(a===1){this.setData(c.val());c.hide();this.fire("wysiwygMode")}else{if(m){c.val(this.getFormatData(1));m.hide()}c.show();this.fire("sourceMode")}},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a,
m=this.get("textarea"),e=this.get("document");this.get("attachForm")&&(a=m[0].form)&&(a=f(a))&&a.detach("submit",this.sync,this);if(e){a=f(e[0].body);var m=f(e[0].documentElement),d=this.get("window");c.remove(this);e.detach();m.detach();a.detach();d.detach()}u.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}}});p.decorate=function(a,m){var m=m||{},a=f(a),c=m.textareaAttrs=m.textareaAttrs||{},e=a.style("width"),d=a.style("height"),k=a.attr("name");if(e)m.width=
m.width||e;if(d)m.height=m.height||d;if(k)c.name=k;m.data=m.data||a.val();m.elBefore=a;c=(new p(m)).render();a.remove();return c};p._initIframe=function(a){var m=c.getInstance(a),a=m.get("document"),e=a[0];a.one("#ke_active_script").remove();n(m);var d=e.body,g=f(d);if(H){d.hideFocus=k;d.disabled=k;d.contentEditable=k;d.removeAttribute("disabled")}else setTimeout(function(){l.gecko?d.contentEditable=k:l.webkit?d.parentNode.contentEditable=k:e.designMode="on"},0);if(l.gecko){var C=e.documentElement;
f(C).on("mousedown",function(a){if(a.target===C){l.gecko&&r(e,j);m.activateGecko()}})}setTimeout(function(){H&&setTimeout(function(){if(e){d.runtimeStyle.marginBottom="0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){m.__docReady=1;m.fire("docReady");var a=m.get("disableObjectResizing"),c=m.get("disableInlineTableEditing");if(a||c)try{e.execCommand("enableObjectResizing",j,!a);e.execCommand("enableInlineTableEditing",j,!c)}catch(d){g.on(H?"resizestart":"resize",function(m){var e=
f(m.target);(a||e.nodeName()==="table"&&c)&&m.preventDefault()})}},10)}});
KISSY.add("editor/iframe-content-xtpl",[],function(w,b,B,x){x.exports=function(b,r){r.write("<!doctype html>\r\n<html>\r\n<head>");var n=b.resolve(["doctype"]);r.write(n);r.write("\r\n    <title>");n=b.resolve(["title"]);r.write(n);r.write("</title>\r\n    ");n=b.resolve(["style"]);r.write(n);r.write("\r\n    ");n=b.resolve(["links"]);r.write(n);r.write('\r\n    </head> \r\n<body class="ks-editor">\r\n');n=b.resolve(["data"]);r.write(n);r.write("\r\n");n=b.resolve(["script"]);r.write(n);r.write("\r\n</body> \r\n</html>");
return r};x.exports.TPL_NAME=x.name});
KISSY.add("editor/base",["util","ua","html-parser","component/control","./render-xtpl"],function(w,b,B,x){var q=b("util"),r=b("ua"),w=b("html-parser"),B=b("component/control"),b=b("./render-xtpl");x.exports=B.extend({beforeCreateDom:function(b){q.mix(b,{mobile:r.mobile})}},{Config:{},XHTML_DTD:w.DTD,ATTRS:{handleGestureEvents:{value:!1},focusable:{value:!1},allowTextSelection:{value:!0},contentTpl:{value:b},height:{value:300},textarea:{selector:function(){return"."+this.getBaseCssClass("textarea")}},
textareaAttrs:{render:1,sync:0},iframe:{},window:{},document:{},toolBarEl:{selector:function(){return"."+this.getBaseCssClass("tools")}},statusBarEl:{selector:function(){return"."+this.getBaseCssClass("status")}},mode:{render:1,value:1},data:{render:1,sync:0},customStyle:{value:""},customLink:{value:[]}},xclass:"editor"})});
KISSY.add("editor/render-xtpl",[],function(w,b,B,x){x.exports=function(b,r){var n=this.root.nativeCommands,t=n.each,n=n["if"];r.write('<div class="');var i=b.resolve(["prefixCls"]);r.writeEscaped(i);r.write('editor-tools">\r\n\r\n</div>\r\n\r\n<\!--\r\n//johanbrook.com/browsers/native-momentum-scrolling-ios-5/\r\nios \u4e0d\u80fd\u653e\u5728 iframe \u4e0a\uff01\r\n--\>\r\n\r\n<div class="');i=b.resolve(["prefixCls"]);r.writeEscaped(i);r.write('editor-textarea-wrap"\r\n\r\n');var i={escape:1},o=[],h=b.resolve(["mobile"]);o.push(h);
i.params=o;i.fn=function(h,f){f.write('\r\nstyle="overflow:scroll;-webkit-overflow-scrolling:touch;"\r\n');return f};r=n.call(this,b,i,r,12);r.write('\r\n>\r\n\r\n<textarea class="');i=b.resolve(["prefixCls"]);r.writeEscaped(i);r.write('editor-textarea"\r\n\r\n');i={escape:1};o=[];h=b.resolve(["textareaAttrs"]);o.push(h);i.params=o;i.fn=function(h,f){f.write("\r\n");var o=h.resolve(["xindex"]);f.writeEscaped(o);f.write('="');o=h.resolve(["this"]);f.writeEscaped(o);f.write('"\r\n');return f};r=t.call(this,
b,i,r,19);r.write("\r\n\r\n");t={escape:1};i=[];o=b.resolve(["mode"]);i.push(o);t.params=i;t.fn=function(h,f){f.write('\r\nstyle="display:none"\r\n');return f};r=n.call(this,b,t,r,23);r.write("\r\n\r\n>");n=b.resolve(["data"]);r.writeEscaped(n);r.write('</textarea>\r\n\r\n</div>\r\n\r\n<div class="');n=b.resolve(["prefixCls"]);r.writeEscaped(n);r.write('editor-status">\r\n\r\n</div>\r\n');return r};x.exports.TPL_NAME=x.name});
KISSY.add("editor/utils",["util","node","./base","dom","ua"],function(w,b,B,x){var q=b("util"),r=b("node"),w=b("./base"),n=b("dom"),t=b("ua"),i={debugUrl:function(){return""},lazyRun:function(o,h,b){var f=o[h],i=o[b];o[h]=function(){f.apply(this,arguments);o[h]=o[b];return i.apply(this,arguments)}},getXY:function(o,h){var b=o.left,f=o.top,i=h.get("window")[0],b=b-n.scrollLeft(i),f=f-n.scrollTop(i),i=h.get("iframe").offset(),b=b+i.left,f=f+i.top;return{left:b,top:f}},tryThese:function(){for(var o,
h=0,b=arguments.length;h<b;h++){var f=arguments[h];try{o=f();break}catch(i){}}return o},clearAllMarkers:function(o){for(var h in o)o[h]._4eClearMarkers(o,!0,void 0)},ltrim:function(o){return o.replace(/^\s+/,"")},rtrim:function(o){return o.replace(/\s+$/,"")},isNumber:function(o){return/^\d+(.\d+)?$/.test(q.trim(o))},verifyInputs:function(o){for(var h=0;h<o.length;h++){var b=r(o[h]),f=q.trim(i.valInput(b)),n=b.attr("data-verify"),b=b.attr("data-warning");if(n&&!RegExp(n).test(f))return alert(b),!1}return!0},
sourceDisable:function(b,h){b.on("sourceMode",h.disable,h);b.on("wysiwygMode",h.enable,h)},resetInput:function(b){var h=b.attr("placeholder");h&&t.ie?(b.addClass("ks-editor-input-tip"),b.val(h)):t.ie||b.val("")},valInput:function(b,h){if(void 0===h)return b.hasClass("ks-editor-input-tip")?"":b.val();b.removeClass("ks-editor-input-tip");b.val(h)},placeholder:function(b,h){b.attr("placeholder",h);t.ie&&(b.on("blur",function(){q.trim(b.val())||(b.addClass("ks-editor-input-tip"),b.val(h))}),b.on("focus",
function(){b.removeClass("ks-editor-input-tip");q.trim(b.val())===h&&b.val("")}))},normParams:function(b){var b=q.clone(b),h;for(h in b){var i=b[h];"function"===typeof i&&(b[h]=i())}return b},preventFocus:function(b){t.ie?b.unselectable():b.attr("onmousedown","return false;")},injectDom:function(b){q.mix(n,b);for(var h in b)(function(h){r.prototype[h]=function(){var f=[].slice.call(arguments,0);f.unshift(this[0]);return(f=b[h].apply(null,f))&&(f.nodeType||q.isWindow(f))?r(f):q.isArray(f)&&(f.__IS_NODELIST||
f[0]&&f[0].nodeType)?r(f):f}})(h)},addRes:function(){var b=this.__res=this.__res||[];b.push.apply(b,q.makeArray(arguments))},destroyRes:function(){for(var b=this.__res||[],h=0;h<b.length;h++){var i=b[h];"function"===typeof i?i():i.destroy?i.destroy():i.remove&&i.remove()}this.__res=[]},getQueryCmd:function(b){return"query"+("-"+b).replace(/-(\w)/g,function(b,i){return i.toUpperCase()})+"Value"}};w.Utils=i;x.exports=i});
KISSY.add("editor/focus-manager",["./base"],function(w,b,B,x){function q(){var b=this;b.__iframeFocus=o;i=b;t&&clearTimeout(t);t=setTimeout(function(){b.fire("focus")},30)}function r(){var b=this;b.__iframeFocus=h;i=u;t&&clearTimeout(t);t=setTimeout(function(){b.fire("blur")},30)}var w=b("./base"),n={},t,i,o=!0,h=!1,u=null,x=x.exports={currentInstance:function(){return i},getInstance:function(b){return n[b]},register:function(b){n[b.get("id")]=b},add:function(b){this.register(b);b.get("window").on("focus",
q,b).on("blur",r,b)},remove:function(b){delete n[b.get("id")];b.get("window").detach("focus",q,b).detach("blur",r,b)}};w.focusManager=x;w.getInstances=function(){return n}});
KISSY.add("editor/clipboard","util,logger-manager,./base,./range,./selection,node,ua".split(","),function(w,b,B){function x(a,c){var d=a.get("document")[0],g=f(d.body),b=false,z=function(){b=true};g.on(c,z);(v.ieMode>7?d:d.selection.createRange()).execCommand(c);g.detach(c,z);return b}function q(a){this.editor=a;this._init()}function r(a){var c=a.get("document")[0],d=a.getSelection(),g;if(d.getType()===u.SELECTION_ELEMENT&&(g=d.getSelectedElement())){var a=d.getRanges()[0],b=f(c.createTextNode(""));
b.insertBefore(g);a.setStartBefore(b);a.setEndAfter(g);d.selectRanges([a]);setTimeout(function(){if(g.parent()){b.remove();d.selectElement(g)}},0)}}function n(a){if(v.webkit){if(!a.match(/^[^<]*$/g)&&!a.match(/^(<div><br( ?\/)?><\/div>|<div>[^<]*<\/div>)*$/gi))return 0}else if(v.ie){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi)&&!a.match(/^(<p>([^<]|<br( ?\/)?>)*<\/p>|(\r\n))*$/gi))return 0}else if(v.gecko){if(!a.match(/^([^<]|<br( ?\/)?>)*$/gi))return 0}else return 0;return 1}function t(a){a=a.replace(/\s+/g,
" ").replace(/> +</g,"><").replace(/<br ?\/>/gi,"<br>");if(a.match(/^[^<]$/))return a;if(v.webkit&&a.indexOf("<div>")>-1){if(a.match(/<div>(?:<br>)?<\/div>/)){a=a.replace(/<div>(?:<br>)?<\/div>/g,function(){return"<p></p>"});a=a.replace(/<\/p><div>/g,"</p><p>").replace(/<\/div><p>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>")}a.match(/<\/div><div>/)&&(a=a.replace(/<\/div><div>/g,"</p><p>").replace(/^<div>/,"<p>").replace(/^<\/div>/,"</p>"))}else if(v.gecko){v.gecko&&(a=a.replace(/^<br><br>$/,
"<br>"));a.indexOf("<br><br>")>-1&&(a="<p>"+a.replace(/<br><br>/g,function(){return"</p><p>"})+"</p>")}return a}function i(a){var c=0,a=a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/gi,"");if(a.indexOf("Apple-")!==-1){a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," ");a=a.replace(/<span class="Apple-tab-span"[^>]*>([^<]*)<\/span>/gi,function(a,c){return c.replace(/\t/g,Array(5).join("&nbsp;"))});if(a.indexOf('<br class="Apple-interchange-newline">')>-1){c=1;a=a.replace(/<br class="Apple-interchange-newline">/,
"")}a=a.replace(/(<[^>]+) class="Apple-[^"]*"/gi,"$1")}!c&&n(a)&&(a=t(a));return a}w=b("util");b("logger-manager");var o=b("./base"),h=b("./range"),u=b("./selection"),f=b("node"),v=b("ua"),s=v.ieMode<11,p=s?"beforepaste":"paste",g=o.RangeType,c=s?function(a,c){return x(a,c)}:function(a,c){try{return a.get("document")[0].execCommand(c)}catch(d){return false}},z={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"};
w.augment(q,{_init:function(){var a=this,e=a.editor,d=e.get("document"),g=d.one("body"),b=function(a){this.type=a};b.prototype={exec:function(d){var e=this.type;d.focus();setTimeout(function(){if(s)if(e==="cut")r(d);else if(e==="paste"){a._preventPasteEvent();a._getClipboardDataFromPasteBin()}c(d,e)||alert(z[e])},0)}};g.on(p,a._getClipboardDataFromPasteBin,a);if(s){g.on("paste",a._iePaste,a);d.on("keydown",a._onKeyDown,a);d.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=
0},0)})}e.addCommand("copy",new b("copy"));e.addCommand("cut",new b("cut"));e.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")===o.Mode.WYSIWYG_MODE&&(a.ctrlKey&&a.keyCode===86||a.shiftKey&&a.keyCode===45)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var c,d=this.editor;if(a==="paste"){this._isPreventBeforePaste=1;try{c=d.get("document")[0].queryCommandEnabled(a)}catch(g){}this._isPreventBeforePaste=0}else c=(a=(a=d.getSelection())&&a.getRanges())&&
!(a.length===1&&a[0].collapsed);return c},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var c=this.editor;if(!this._isPreventPaste){a.preventDefault();c.execCommand("paste")}},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var a=this.editor,c=a.get("document")[0];if(!c.getElementById("ke-paste-bin")){var d=a.getSelection(),
j=new h(c),l=f(v.webkit?"<body></body>":"<div></div>",c);l.attr("id","ke-paste-bin");v.webkit&&l[0].appendChild(c.createTextNode("\u200b"));c.body.appendChild(l[0]);l.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});l.css("left","-1000px");var z=d.createBookmarks();j.setStartAt(l,g.POSITION_AFTER_START);j.setEndAt(l,g.POSITION_BEFORE_END);j.select(true);setTimeout(function(){var c,e=l;l=v.webkit&&(c=l.first())&&c.hasClass("Apple-style-span")?
c:l;d.selectBookmarks(z);var g=l.html();e.remove();if(g=i(g)){c=a.fire("paste",{html:g});if(c!==false){c!==void 0&&(g=c);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?b("editor/plugin/word-filter",function(c){a.insertHtml(c.toDataFormat(g,a))}):a.insertHtml(g)}}},0)}}}});var d={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};B.init=function(a){var c;a.docReady(function(){c=new q(a)});var g={copy:1,cut:1,paste:1},b=["copy","cut","paste"];a.on("contextmenu",function(l){var f=l.contextmenu;if(!f.__copyFix){f.__copyFix=
1;for(l=0;l<b.length;l++)f.addChild({content:d[b[l]],value:b[l]});f.on("click",function(c){var m=c.target.get("value");if(g[m]){f.hide();setTimeout(function(){a.execCommand("save");a.execCommand(m);setTimeout(function(){a.execCommand("save")},10)},30)}})}for(var z=f.get("children"),l=z.length-1;l>=0;l--){var h=z[l],i;i=h.get?h.get("value"):h.value;if(g[i]){i=!c._stateFromNamedCommand(i);h.set?h.set("disabled",i):h.disabled=i}}})}});
KISSY.add("editor/range","./dom,./utils,./walker,./base,./element-path,util,dom,ua,node".split(","),function(w,b,B,x){function q(a){var c=a.nodeType!==d.NodeType.TEXT_NODE&&d.nodeName(a)in e.$removeEmpty,g=a.nodeType===d.NodeType.TEXT_NODE&&!v.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return c||g||a}function r(a){return!H(a)&&!I(a)}function n(m){var c=p;return function(e){if(I(e))return s;if(e.nodeType===d.NodeType.TEXT_NODE){if(v.trim(e.nodeValue).length)return p}else if(e.nodeType===
d.NodeType.ELEMENT_NODE){e=d.nodeName(e);if(!F[e])if(!m&&!a.ie&&e==="br"&&!c)c=s;else return p}return s}}function t(a,c){var e=a.startContainer,g=a.endContainer,b=a.startOffset,l=a.endOffset,f,z=p,h=p,i,o=a.document,P;c>0&&(i=o.createDocumentFragment());if(a.collapsed)return i;a.optimizeBookmark();if(g[0].nodeType===d.NodeType.TEXT_NODE){h=s;g=g._4eSplitText(l)}else if(g[0].childNodes.length>0)if(l>=g[0].childNodes.length){g=k(g[0].appendChild(o.createTextNode("")));P=s}else g=k(g[0].childNodes[l]);
if(e[0].nodeType===d.NodeType.TEXT_NODE){z=s;e._4eSplitText(b)}else if(b)if(b>=e[0].childNodes.length){e=k(e[0].appendChild(o.createTextNode("")));f=s}else e=k(e[0].childNodes[b].previousSibling);else{f=k(o.createTextNode(""));e.prepend(f);e=f;f=s}var n=e._4eParents(),N=g._4eParents();n.each(function(a,c){n[c]=a});N.each(function(a,c){N[c]=a});for(var G,I,o=0;o<n.length;o++){G=n[o];I=N[o];if(!G.equals(I))break}for(var b=i,A,M,H=o;H<n.length;H++){A=n[H];l=c>0&&!A.equals(e)?b.appendChild(A.clone()[0]):
null;A=A[0].nextSibling;M=N[H];for(var y=g[0],r=M&&M[0];A;){if(r===A||y===A)break;M=A.nextSibling;if(c===2)b.appendChild(A.cloneNode(s));else{if(j[A.nodeName.toLowerCase()]){var u=A.cloneNode(s);A.innerHTML="";A=u}else d._4eRemove(A);c===1&&b.appendChild(A)}A=M}l&&(b=l)}for(b=i;o<N.length;o++){A=N[o];l=c>0&&!A.equals(g)?b.appendChild(A.clone()[0]):null;if(!n[o]||!A._4eSameLevel(n[o]))for(A=A[0].previousSibling;A;){M=A.previousSibling;if(c===2)b.insertBefore(A.cloneNode(s),b.firstChild);else{d._4eRemove(A);
c===1&&b.insertBefore(A,b.firstChild)}A=M}l&&(b=l)}if(c===2){if(z){G=e[0];if(G.nodeType===d.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType===d.NodeType.TEXT_NODE){G.data=G.data+G.nextSibling.data;G.parentNode.removeChild(G.nextSibling)}}if(h){h=g[0];if(h.nodeType===d.NodeType.TEXT_NODE&&h.previousSibling&&h.previousSibling.nodeType===d.NodeType.TEXT_NODE){h.previousSibling.data=h.previousSibling.data+h.data;h.parentNode.removeChild(h)}}}else{if(G&&I&&(!e._4eSameLevel(G)||!g._4eSameLevel(I))){h=
G._4eIndex();f&&G._4eSameLevel(e)&&h--;a.setStart(G.parent(),h+1)}a.collapse(s)}f&&e.remove();P&&g.remove();return i}function i(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]===a.endContainer[0]&&a.startOffset===a.endOffset}function o(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=g;this.collapsed=s;this.document=a}b("./dom");var w=b("./utils"),h=b("./walker"),u=b("./base"),f=b("./element-path"),v=b("util");u.RangeType={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,
POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var s=true,p=false,g=null,c=u.RangeType,z=u.PositionType,d=b("dom"),a=b("ua"),e=u.XHTML_DTD,k=b("node"),j={td:1},l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},H=new h.whitespaces,I=new h.bookmark,y=h.whitespaces(s),J=h.bookmark(false,true),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,
i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};v.augment(o,{toString:function(){var a=[],c=this.startContainer[0],e=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((e.id||e.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,c=this.startOffset;a[0].nodeType!==d.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;
c=this.endOffset;a[0].nodeType!==d.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4eIndex()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4eIndex())},setEndAfter:function(a){this.setEnd(a.parent(),a._4eIndex()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4eIndex())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&a.nodeName()==="span"&&a.attr("_ke_bookmark")&&
this.setStartBefore(a);c&&c.nodeName()==="span"&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(a,c){if(a[0].nodeType===d.NodeType.ELEMENT_NODE&&l[a.nodeName()]){a=a.parent();c=a._4eIndex()}this.startContainer=a;this.startOffset=c;if(!this.endContainer){this.endContainer=a;this.endOffset=c}i(this)},setEnd:function(a,c){if(a[0].nodeType===d.NodeType.ELEMENT_NODE&&l[a.nodeName()]){a=a.parent();c=a._4eIndex()+1}this.endContainer=a;this.endOffset=c;if(!this.startContainer){this.startContainer=
a;this.startOffset=c}i(this)},setStartAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===d.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}i(this)},setEndAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType===
d.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}i(this)},cloneContents:function(){return t(this,2)},deleteContents:function(){return t(this,0)},extractContents:function(){return t(this,1)},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=
this.endOffset}this.collapsed=s},clone:function(){var a=new o(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!==d.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!==d.NodeType.ELEMENT_NODE)return g;var c=new h(a);c.evaluator=function(a){return y(a)&&J(a)};a=c.next();c.reset();
c=c.previous();return a&&a.equals(c)?a:g},shrink:function(a,e){if(!this.collapsed){var a=a||c.SHRINK_TEXT,g=this.clone(),b=this.startContainer,k=this.endContainer,j=this.startOffset,l=this.endOffset,f=s,z,i,o=s;if(b&&b[0].nodeType===d.NodeType.TEXT_NODE)if(j)if(j>=b[0].nodeValue.length)g.setStartAfter(b);else{g.setStartBefore(b);f=p}else g.setStartBefore(b);if(k&&k[0].nodeType===d.NodeType.TEXT_NODE)if(l)if(l>=k[0].nodeValue.length)g.setEndAfter(k);else{g.setEndAfter(k);o=p}else g.setEndBefore(k);
if(f||o){i=new h(g);i.evaluator=function(e){return e.nodeType===(a===c.SHRINK_ELEMENT?d.NodeType.ELEMENT_NODE:d.NodeType.TEXT_NODE)};i.guard=function(e,g){if(a===c.SHRINK_ELEMENT&&e.nodeType===d.NodeType.TEXT_NODE||g&&e===z)return p;!g&&e.nodeType===d.NodeType.ELEMENT_NODE&&(z=e);return s}}if(f)(g=i[a===c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,e?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(o){i.reset();(i=i[a===c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,
e?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return f||o}},createBookmark2:function(a){var c=this.startContainer,e=this.endContainer,b=this.startOffset,j=this.endOffset,l,f;if(!c||!e)return{start:0,end:0};if(a){if(c[0].nodeType===d.NodeType.ELEMENT_NODE)if((l=k(c[0].childNodes[b]))&&l[0]&&l[0].nodeType===d.NodeType.TEXT_NODE&&b>0&&l[0].previousSibling.nodeType===d.NodeType.TEXT_NODE){c=l;b=0}for(;c[0].nodeType===d.NodeType.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType===d.NodeType.TEXT_NODE;){c=
f;b=b+f[0].nodeValue.length}if(!this.collapsed){if(e[0].nodeType===d.NodeType.ELEMENT_NODE)if((l=k(e[0].childNodes[j]))&&l[0]&&l[0].nodeType===d.NodeType.TEXT_NODE&&j>0&&l[0].previousSibling.nodeType===d.NodeType.TEXT_NODE){e=l;j=0}for(;e[0].nodeType===d.NodeType.TEXT_NODE&&(f=e.prev(void 0,1))&&f[0].nodeType===d.NodeType.TEXT_NODE;){e=f;j=j+f[0].nodeValue.length}}}return{start:c._4eAddress(a),end:this.collapsed?g:e._4eAddress(a),startOffset:b,endOffset:j,normalized:a,is2:s}},createBookmark:function(a){var e,
d,b,j,l=this.collapsed;e=k("<span>",g,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");if(a){b=v.guid("ke_bm_");e.attr("id",b+"S")}if(!l){d=e.clone();d.html("&nbsp;");a&&d.attr("id",b+"E");j=this.clone();j.collapse();j.insertNode(d)}j=this.clone();j.collapse(s);j.insertNode(e);if(d){this.setStartAfter(e);this.setEndBefore(d)}else this.moveToPosition(e,c.POSITION_AFTER_END);return{startNode:a?b+"S":e,endNode:a?b+"E":d,serializable:a,collapsed:l}},moveToPosition:function(a,
c){this.setStartAt(a,c);this.collapse(s)},trim:function(a,c){var e=this.startContainer,g=this.startOffset,b=this.collapsed;if((!a||b)&&e[0]&&e[0].nodeType===d.NodeType.TEXT_NODE){if(g)if(g>=e[0].nodeValue.length){g=e._4eIndex()+1;e=e.parent()}else{var k=e._4eSplitText(g),g=e._4eIndex()+1,e=e.parent();if(d.equals(this.startContainer,this.endContainer))this.setEnd(k,this.endOffset-this.startOffset);else if(d.equals(e,this.endContainer))this.endOffset=this.endOffset+1}else{g=e._4eIndex();e=e.parent()}this.setStart(e,
g);if(b){this.collapse(s);return}}e=this.endContainer;g=this.endOffset;if(!c&&!b&&e[0]&&e[0].nodeType===d.NodeType.TEXT_NODE){if(g){g>=e[0].nodeValue.length||e._4eSplitText(g);g=e._4eIndex()+1}else g=e._4eIndex();e=e.parent();this.setEnd(e,g)}},insertNode:function(a){this.optimizeBookmark();this.trim(p,s);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]===this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var c=k(this.document);
if(a.is2){var e=c._4eGetByAddress(a.start,a.normalized),d=a.startOffset,c=a.end&&c._4eGetByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(e,d);c?this.setEnd(c,a):this.collapse(s)}else{e=(d=a.serializable)?k("#"+a.startNode,c):a.startNode;a=d?k("#"+a.endNode,c):a.endNode;this.setStartBefore(e);e._4eRemove();if(a&&a[0]){this.setEndBefore(a);a._4eRemove()}else this.collapse(s)}},getCommonAncestor:function(a,c){var e=this.startContainer,g=this.endContainer,e=e[0]===g[0]?a&&e[0].nodeType===d.NodeType.ELEMENT_NODE&&
this.startOffset===this.endOffset-1?k(e[0].childNodes[this.startOffset]):e:e._4eCommonAncestor(g);return c&&e[0].nodeType===d.NodeType.TEXT_NODE?e.parent():e},enlarge:function(){function a(c,e,g,b){var m=c[e?"startContainer":"endContainer"],j,l=e?0:1,f=0,h=e?"previousSibling":"nextSibling";j=c[e?"startOffset":"endOffset"];if(m[0].nodeType===d.NodeType.TEXT_NODE){if(e){if(j)return}else if(j<m[0].nodeValue.length)return;j=m[0][h];m=m[0].parentNode}else{j=m[0].childNodes[j+(e?-1:1)]||null;m=m[0]}for(;m;){for(;j;)if(H(j)||
I(j))j=j[h];else break;if(j){if(!f)c[e?"setStartAfter":"setEndBefore"](k(j));break}m=k(m);if(m.nodeName()==="body")break;if(f||m.equals(b)){g[l]=m;f=1}else c[e?"setStartBefore":"setEndAfter"](m);j=m[0][h];m=m[0].parentNode}}return function(e){var b;switch(e){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var e=this.getCommonAncestor(),j=[];a(this,1,j,e);a(this,0,j,e);if(j[0]&&j[1]){e=j[0].contains(j[1])?j[1]:j[0];this.setStartBefore(e);this.setEndAfter(e)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:b=
new o(this.document);j=k(this.document.body);b.setStartAt(j,c.POSITION_AFTER_START);b.setEnd(this.startContainer,this.startOffset);b=new h(b);var l,f,z=h.blockBoundary(e===c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:g),i=function(a){var c=z(a);c||(l=k(a));return c},p=function(a){var c=i(a);!c&&d.nodeName(a)==="br"&&(f=k(a));return c};b.guard=i;b=b.lastBackward();l=l||j;this.setStartAt(l,l.nodeName()!=="br"&&(!b&&this.checkStartOfBlock()||b&&l.contains(b))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);b=this.clone();
b.collapse();b.setEndAt(j,c.POSITION_BEFORE_END);b=new h(b);b.guard=e===c.ENLARGE_LIST_ITEM_CONTENTS?p:i;l=g;b=b.lastForward();l=l||j;this.setEndAt(l,!b&&this.checkEndOfBlock()||b&&l.contains(b)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType===d.NodeType.TEXT_NODE&&v.trim(a[0].nodeValue.substring(0,e)).length)return p;this.trim();a=new f(this.startContainer);e=this.clone();e.collapse(s);
e.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new h(e);a.evaluator=n(s);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,e=this.endOffset;if(a[0].nodeType===d.NodeType.TEXT_NODE&&v.trim(a[0].nodeValue.substring(e)).length)return p;this.trim();a=new f(this.endContainer);e=this.clone();e.collapse(p);e.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new h(e);a.evaluator=n(p);return a.checkForward()},checkBoundaryOfElement:function(a,e){var d=this.clone();
d[e===c.START?"setStartAt":"setEndAt"](a,e===c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);d=new h(d);d.evaluator=q;return d[e===c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,c=this.endContainer,e=this.startOffset,g=this.endOffset,b;if(a[0].nodeType===d.NodeType.ELEMENT_NODE){b=a[0].childNodes.length;if(b>e)a=k(a[0].childNodes[e]);else if(b===0)a=a._4ePreviousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=k(a);a=a._4eNextSourceNode()||
a}}if(c[0].nodeType===d.NodeType.ELEMENT_NODE){b=c[0].childNodes.length;if(b>g)c=k(c[0].childNodes[g])._4ePreviousSourceNode(s);else if(b===0)c=c._4ePreviousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=k(c)}}a._4ePosition(c)&z.POSITION_FOLLOWING&&(a=c);return{startNode:a,endNode:c}},fixBlock:function(e,d){var g=this.createBookmark(),b=k(this.document.createElement(d));this.collapse(e);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);b[0].appendChild(this.extractContents());b._4eTrim();a.ie||b._4eAppendBogus();
this.insertNode(b);this.moveToBookmark(g);return b},splitBlock:function(e){var d=new f(this.startContainer),b=new f(this.endContainer),j=d.block,k=b.block,l=g;if(!d.blockLimit.equals(b.blockLimit))return g;if(e!=="br"){if(!j){j=this.fixBlock(s,e);k=(new f(this.endContainer)).block}k||(k=this.fixBlock(p,e))}e=j&&this.checkStartOfBlock();d=k&&this.checkEndOfBlock();this.deleteContents();if(j&&j[0]===k[0])if(d){l=new f(this.startContainer);this.moveToPosition(k,c.POSITION_AFTER_END);k=g}else if(e){l=
new f(this.startContainer);this.moveToPosition(j,c.POSITION_BEFORE_START);j=g}else{k=this.splitElement(j);!a.ie&&!v.inArray(j.nodeName(),["ul","ol"])&&j._4eAppendBogus()}return{previousBlock:j,nextBlock:k,wasStartOfBlock:e,wasEndOfBlock:d,elementPath:l}},splitElement:function(a){if(!this.collapsed)return g;this.setEndAt(a,c.POSITION_BEFORE_END);var e=this.extractContents(),d=a.clone(p);d[0].appendChild(e);d.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,
e){for(var g=0;a;){if(a[0].nodeType===d.NodeType.TEXT_NODE){this.moveToPosition(a,e?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);g=1;break}if(a[0].nodeType===d.NodeType.ELEMENT_NODE&&a._4eIsEditable()){this.moveToPosition(a,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);g=1}var b=a,j=g,k=void 0;b[0].nodeType===d.NodeType.ELEMENT_NODE&&b._4eIsEditable()&&(k=b[e?"last":"first"](r,1));!j&&!k&&(k=b[e?"prev":"next"](r,1));a=k}return!!g},selectNodeContents:function(a){var c=a[0];this.setStart(a,0);this.setEnd(a,
c.nodeType===d.NodeType.TEXT_NODE?c.nodeValue.length:c.childNodes.length)},insertNodeByDtd:function(a){var c,d,g,b=a.nodeName();c=e.$block[b];this.deleteContents();if(c){for(c=this.getCommonAncestor(p,s);(d=e[c.nodeName()])&&(!d||!d[b]);){var j=c.parent();if(this.checkStartOfBlock()&&this.checkEndOfBlock()){this.setStartBefore(c);this.collapse(s);c.remove()}else g=c;c=j}g&&this.splitElement(g)}this.insertNode(a)}});w.injectDom({_4eBreakParent:function(a,c){var c=k(c),a=k(a),e,d=new u.Range(a[0].ownerDocument);
d.setStartAfter(a);d.setEndAfter(c);e=d.extractContents();d.insertNode(a.remove());a.after(e)}});u.Range=o;x.exports=o});
KISSY.add("editor/dom","util,node,./base,./utils,dom,ua".split(","),function(w,b){function B(g,c){var b=g[c?"next":"prev"](void 0,1);if(b&&b[0].nodeType===o.ELEMENT_NODE){for(var d=[];b.attr("_ke_bookmark")||b._4eIsEmptyInlineRemovable(void 0);){d.push(b);b=c?b.next(void 0,1):b.prev(void 0,1);if(!b)return}if(g._4eIsIdentical(b,void 0)){for(var a=q(c?g[0].lastChild:g[0].firstChild);d.length;)d.shift()._4eMove(g,!c,void 0);b._4eMoveChildren(g,!c,void 0);b.remove();a[0]&&a[0].nodeType===o.ELEMENT_NODE&&
a._4eMergeSiblings()}}}var x=b("util"),q=b("node"),r=b("./base"),n=b("./utils"),t=r.XHTML_DTD,i=b("dom"),o=i.NodeType,h=b("ua"),u={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.PositionType={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var f=r.PositionType,v={block:1,"list-item":1,
table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},s={hr:1},p=function(b){return b&&(b[0]||b)};n.injectDom({_4eSameLevel:function(b,c){var c=p(c),f=b.parentNode;return f&&f===c.parentNode},_4eIsBlockBoundary:function(b,c){var f=x.merge(s,c);return!(!v[i.css(b,"display")]&&!f[i.nodeName(b)])},_4eIndex:function(b,c){for(var f=b.parentNode.childNodes,d,a=-1,e=0;e<f.length;e++){d=f[e];if(!c||
!(d.nodeType===3&&d.previousSibling&&d.previousSibling.nodeType===3)){a++;if(d===b)return a}}return-1},_4eMove:function(b,c,f){c=p(c);f?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4eIsIdentical:function(b,c){if(!c)return false;c=p(c);if(i.nodeName(b)!==i.nodeName(c))return false;var f=b.attributes,d,a,e=c.attributes,k=f.length,j=e.length;if(k!==j)return false;for(var l=0;l<k;l++){d=f[l];a=d.name;if(d.specified&&i.attr(b,a)!==i.attr(c,a))return false}if(h.ieMode<8)for(l=0;l<j;l++){d=e[l];a=d.name;
if(d.specified&&i.attr(b,a)!==i.attr(c,a))return false}return true},_4eIsEmptyInlineRemovable:function(b){if(!t.$removeEmpty[i.nodeName(b)])return false;for(var b=b.childNodes,c=0,f=b.length;c<f;c++){var d=b[c],a=d.nodeType;if(!(a===o.ELEMENT_NODE&&d.getAttribute("_ke_bookmark"))&&(a===o.ELEMENT_NODE&&!i._4eIsEmptyInlineRemovable(d)||a===i.NodeType.TEXT_NODE&&x.trim(d.nodeValue)))return false}return true},_4eMoveChildren:function(b,c,f){c=p(c);if(b!==c)if(f)for(;f=b.lastChild;)c.insertBefore(b.removeChild(f),
c.firstChild);else for(;f=b.firstChild;)c.appendChild(b.removeChild(f))},_4eMergeSiblings:function(b){b=q(b);if(u[b.nodeName()]){B(b,true);B(b)}},_4eSplitText:function(b,c){var f=b.ownerDocument;if(b.nodeType===i.NodeType.TEXT_NODE){if(h.ie&&c===b.nodeValue.length){var d=f.createTextNode("");i.insertAfter(d,b);return d}d=b.splitText(c);if(f.documentMode){f=f.createTextNode("");i.insertAfter(f,d);i.remove(f)}return d}},_4eParents:function(b,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](b);
while(b=b.parentNode);return f},_4eNextSourceNode:function(b,c,f,d){if(d&&!d.call)var a=p(d),d=function(c){return c!==a};var c=!c&&b.firstChild,e=b;if(!c){if(b.nodeType===o.ELEMENT_NODE&&d&&d(b,true)===false)return null;c=b.nextSibling}for(;!c&&(e=e.parentNode);){if(d&&d(e,true)===false)return null;c=e.nextSibling}return!c||d&&d(c)===false?null:f&&f!==c.nodeType?i._4eNextSourceNode(c,false,f,d):c},_4ePreviousSourceNode:function(b,c,f,d){if(d&&!d.call)var a=p(d),d=function(c){return c!==a};var c=!c&&
b.lastChild,e=b;if(!c){if(b.nodeType===o.ELEMENT_NODE&&d&&d(b,true)===false)return null;c=b.previousSibling}for(;!c&&(e=e.parentNode);){if(d&&d(e,true)===false)return null;c=e.previousSibling}return!c||d&&d(c)===false?null:f&&c.nodeType!==f?i._4ePreviousSourceNode(c,false,f,d):c},_4eCommonAncestor:function(b,c){c=p(c);if(b===c)return b;if(i.contains(c,b))return c;var f=b;do if(i.contains(f,c))return f;while(f=f.parentNode);return null},_4eHasAttributes:h.ieMode<9?function(b){for(var c=b.attributes,
f=0;f<c.length;f++){var d=c[f];switch(d.name){case "class":if(b.getAttribute("class"))return true;break;default:if(d.specified)return true}}return false}:function(b){h.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4ePosition:function(b,c){var h=p(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(h);if(b===h)return f.POSITION_IDENTICAL;if(b.nodeType===o.ELEMENT_NODE&&h.nodeType===o.ELEMENT_NODE){if(i.contains(b,h))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(i.contains(h,
b))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING;if("sourceIndex"in b)return b.sourceIndex<0||h.sourceIndex<0?f.POSITION_DISCONNECTED:b.sourceIndex<h.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}for(var d=i._4eAddress(b),h=i._4eAddress(h),a=Math.min(d.length,h.length),e=0;e<=a-1;e++)if(d[e]!==h[e])return d[e]<h[e]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;return d.length<h.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4eAddress:function(b,
c){for(var f=[],d=b.ownerDocument.documentElement,a=b;a&&a!==d;){f.unshift(i._4eIndex(a,c));a=a.parentNode}return f},_4eRemove:function(b,c){var f=b.parentNode;if(f){if(c)for(var d;d=b.firstChild;)f.insertBefore(b.removeChild(d),b);f.removeChild(b)}return b},_4eTrim:function(b){i._4eLtrim(b);i._4eRtrim(b)},_4eLtrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType===i.NodeType.TEXT_NODE){var f=n.ltrim(c.nodeValue),d=c.nodeValue.length;if(f){if(f.length<d){i._4eSplitText(c,d-f.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);
continue}}break}},_4eRtrim:function(b){for(var c;c=b.lastChild;){if(c.type===i.NodeType.TEXT_NODE){var f=n.rtrim(c.nodeValue),d=c.nodeValue.length;if(f){if(f.length<d){i._4eSplitText(c,f.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!h.ie)(c=b.lastChild)&&c.nodeType===1&&i.nodeName(c)==="br"&&b.removeChild(c)},_4eAppendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType===i.NodeType.TEXT_NODE&&!x.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType===i.NodeType.TEXT_NODE||
i.nodeName(c)!=="br"){c=b.ownerDocument.createElement("br");b.appendChild(c)}},_4eSetMarker:function(b,c,f,d){var b=q(b),a=b.data("list_marker_id")||b.data("list_marker_id",x.guid()).data("list_marker_id"),e=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[a]=b;e[f]=1;return b.data(f,d)},_4eClearMarkers:function(b,c,f){var b=q(b),d=b.data("list_marker_names"),a=b.data("list_marker_id"),e;for(e in d)b.removeData(e);b.removeData("list_marker_names");if(f){b.removeData("list_marker_id");
delete c[a]}},_4eCopyAttributes:function(b,c,f){for(var c=q(c),d=b.attributes,f=f||{},a=0;a<d.length;a++){var e=d[a],k=e.name.toLowerCase(),j;if(!(k in f))if(k==="checked"&&(j=i.attr(b,k)))c.attr(k,j);else if(e.specified||h.ie&&e.value&&k==="value"){j=i.attr(b,k);if(j===null)j=e.nodeValue;c.attr(k,j)}}if(b.style.cssText!=="")c[0].style.cssText=b.style.cssText},_4eIsEditable:function(b){b=i.nodeName(b);return(b=!t.$nonEditable[b]&&(t[b]||t.span))&&b["#text"]},_4eGetByAddress:function(b,c,f){for(var b=
b.documentElement,d=0;b&&d<c.length;d++){var a=c[d];if(f)for(var e=-1,k=0;k<b.childNodes.length;k++){var j=b.childNodes[k];if(!(f===true&&j.nodeType===3&&j.previousSibling&&j.previousSibling.nodeType===3)){e++;if(e===a){b=j;break}}}else b=b.childNodes[a]}return b}})});
KISSY.add("editor/walker",["./base","util","ua","dom","node"],function(w,b,B,x){function q(c,a){if(this._.end)return h;var b,k=this.range,j,l=this.guard,g=this.type,p=c?"_4ePreviousSourceNode":"_4eNextSourceNode";if(!this._.start&&(this._.start=1,k.trim(),k.collapsed))return this.end(),h;if(!c&&!this._.guardLTR){var n=k.endContainer[0],r=n.childNodes[k.endOffset];this._.guardLTR=function(a,c){return c&&(n===a||"body"===f.nodeName(a))?!1:a!==r}}if(c&&!this._.guardRTL){var u=k.startContainer[0],m=0<
k.startOffset&&u.childNodes[k.startOffset-1]||null;this._.guardRTL=function(a,c){return c&&(u===a||"body"===f.nodeName(a))?!1:a!==m}}var q=c?this._.guardRTL:this._.guardLTR;j=l?function(a,c){return q(a,c)===o?o:l(a,c)}:q;this.current?b=this.current[p](o,g,j):c?(b=k.endContainer,0<k.endOffset?(b=s(b[0].childNodes[k.endOffset-1]),j(b[0])===o&&(b=h)):b=j(b,i)===o?h:b._4ePreviousSourceNode(i,g,j,void 0)):(b=k.startContainer,b=s(b[0].childNodes[k.startOffset]),b.length?j(b[0])===o&&(b=h):b=j(k.startContainer,
i)===o?h:k.startContainer._4eNextSourceNode(i,g,j,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==o){if(!a)return b}else if(a&&this.evaluator)return o;b=b[p](o,g,j)}this.end();return this.current=h}function r(c){for(var a,b=h;a=q.call(this,c);)b=a;return b}function n(c){this.range=c;this.guard=this.evaluator=h;this._={}}var w=b("./base"),t=b("util"),i=!0,o=!1,h=null,u=b("ua"),f=b("dom"),v=w.XHTML_DTD,s=b("node");t.augment(n,{end:function(){this._.end=1},next:function(){return q.call(this)},
previous:function(){return q.call(this,i)},checkForward:function(){return q.call(this,o,i)!==o},checkBackward:function(){return q.call(this,i,i)!==o},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,i)},reset:function(){delete this.current;this._={}},_iterator:q});t.mix(n,{blockBoundary:function(c){return function(a){return!(a.nodeType===f.NodeType.ELEMENT_NODE&&f._4eIsBlockBoundary(a,c))}},bookmark:function(c,a){function b(a){return"span"===f.nodeName(a)&&f.attr(a,
"_ke_bookmark")}return function(k){var j,l;j=k.nodeType===f.NodeType.TEXT_NODE&&(l=k.parentNode)&&b(l);j=c?j:j||b(k);return!!(a^j)}},whitespaces:function(c){return function(a){a=a.nodeType===f.NodeType.TEXT_NODE&&!t.trim(a.nodeValue);return!!(c^a)}},invisible:function(c){var a=n.whitespaces();return function(b){b=a(b)||b.nodeType===f.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(c^b)}}});var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=n.whitespaces(),c=n.bookmark(),z=function(b){var a=f.nodeName(b);return c(b)||
g(b)||1===b.nodeType&&a in v.$inline&&!(a in v.$empty)};w.Utils.injectDom({_4eGetBogus:function(c){c=s(c);do c=c._4ePreviousSourceNode();while(c&&z(c[0]));return c&&(!u.ie?"br"===c.nodeName():3===c[0].nodeType&&p.test(c.text()))?c[0]:!1}});w.Walker=n;x.exports=n});
KISSY.add("editor/element-path",["./base","./dom","dom"],function(w,b,B,x){function q(b){for(var u=t,f=t,q=[];b;){if(b[0].nodeType===r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=b);var s=b.nodeName();if(!f&&(!u&&i[s]&&(u=b),o[s])){var p;if(p=!u)if(p="div"===s){a:{p=b[0].childNodes;for(var g=0,c=p.length;g<c;g++){var z=p[g];if(z.nodeType===r.NodeType.ELEMENT_NODE&&n.$block[z.nodeName.toLowerCase()]){p=!0;break a}}p=!1}p=!p}p?u=b:f=b}q.push(b);if("body"===s)break}b=b.parent()}this.block=
u;this.blockLimit=f;this.elements=q}w=b("./base");b("./dom");var r=b("dom"),n=w.XHTML_DTD,t=null,i={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},o={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};q.prototype={constructor:q,compare:function(b){var i=this.elements,b=b&&b.elements;if(!b||i.length!==b.length)return!1;for(var f=0;f<i.length;f++)if(!r.equals(i[f],b[f]))return!1;return!0},contains:function(b){for(var i=this.elements,f=0;f<i.length;f++)if(i[f].nodeName()in
b)return i[f];return t},toString:function(){var b=this.elements,i,f=[];for(i=0;i<b.length;i++)f.push(b[i].nodeName());return f.toString()}};w.ElementPath=q;x.exports=q});
KISSY.add("editor/selection","util,node,./walker,./range,./base,ua,dom".split(","),function(w,b,B,x){function q(a){this.document=a;this._={cache:{}};if(p)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!==a||c.parentElement&&c.parentElement().ownerDocument!==a)this.isInvalid=o}catch(b){this.isInvalid=o}}function r(a){a=new q(a);return!a||a.isInvalid?h:a}var w=b("util"),n=b("node"),B=b("./walker"),t=b("./range"),i=b("./base");i.SelectionType={SELECTION_NONE:1,SELECTION_TEXT:2,
SELECTION_ELEMENT:3};var o=true,h=null,u=b("ua"),f=b("dom"),v=i.SelectionType,s=i.RangeType,p=document.selection,g={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};w.augment(q,{getNative:!p?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=f.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!p?function(){var a=
this._.cache;if(a.type)return a.type;var c=v.SELECTION_TEXT,b=this.getNative();if(b){if(b.rangeCount===1){var b=b.getRangeAt(0),d=b.startContainer;if(d===b.endContainer&&d.nodeType===f.NodeType.ELEMENT_NODE&&Number(b.endOffset-b.startOffset)===1&&g[d.childNodes[b.startOffset].nodeName.toLowerCase()])c=v.SELECTION_ELEMENT}}else c=v.SELECTION_NONE;return a.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var c=v.SELECTION_NONE;try{var b=this.getNative(),d=b.type;if(d==="Text")c=v.SELECTION_TEXT;
if(d==="Control")c=v.SELECTION_ELEMENT;if(b.createRange().parentElement)c=v.SELECTION_TEXT}catch(f){}return a.type=c},getRanges:p?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var b=a.parentElement(),d=b.childNodes,g,i=0;i<d.length;i++){var p=d[i];if(p.nodeType===f.NodeType.ELEMENT_NODE){g=a.duplicate();g.moveToElementText(p);var p=g.compareEndPoints("StartToStart",a),o=g.compareEndPoints("EndToStart",a);g.collapse();if(p>0)break;else{if(!p||o===1&&p===-1)return{container:b,offset:i};
if(!o)return{container:b,offset:i+1}}g=h}}if(!g){g=a.duplicate();g.moveToElementText(b);g.collapse(false)}g.setEndPoint("StartToStart",a);g=(""+g.text).replace(/\r\n|\r/g,"\n").length;try{for(;g>0;)g=g-d[--i].nodeValue.length}catch(n){g=0}return g===0?{container:b,offset:i}:{container:d[i],offset:-g}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var d=this.getNative(),b=d&&d.createRange(),f=this.getType();if(!d)return[];if(f===v.SELECTION_TEXT){d=new t(this.document);f=a(b,
o);d.setStart(n(f.container),f.offset);f=a(b);d.setEnd(n(f.container),f.offset);c.ranges=[d];return[d]}if(f===v.SELECTION_ELEMENT){c=c.ranges=[];for(f=0;f<b.length;f++){for(var g=b.item(f),i=g.parentNode,h=0,d=new t(this.document);h<i.childNodes.length&&i.childNodes[h]!==g;h++);d.setStart(n(i),h);d.setEnd(n(i),h+1);c.push(d)}return c}c.ranges=[];return[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],b=this.getNative();if(!b)return[];for(var d=0;d<b.rangeCount;d++){var f=
b.getRangeAt(d),g=new t(this.document);g.setStart(n(f.startContainer),f.startOffset);g.setEnd(n(f.endContainer),f.endOffset);a.push(g)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(a.startElement!==void 0)return a.startElement;var c,b=this.getNative();switch(this.getType()){case v.SELECTION_ELEMENT:return this.getSelectedElement();case v.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();o;){c=d.startContainer;if(d.startOffset===(c[0].nodeType===f.NodeType.ELEMENT_NODE?
c[0].childNodes.length:c[0].nodeValue.length)&&!c._4eIsBlockBoundary())d.setStartAfter(c);else break}c=d.startContainer;if(c[0].nodeType!==f.NodeType.ELEMENT_NODE)return c.parent();c=n(c[0].childNodes[d.startOffset]);if(!c[0]||c[0].nodeType!==f.NodeType.ELEMENT_NODE)return d.startContainer;for(d=c[0].firstChild;d&&d.nodeType===f.NodeType.ELEMENT_NODE;){c=n(d);d=d.firstChild}return c}if(p){d=b.createRange();d.collapse(o);c=n(d.parentElement())}else{if((c=b.anchorNode)&&c.nodeType!==f.NodeType.ELEMENT_NODE)c=
c.parentNode;c&&(c=n(c))}}return a.startElement=c},getSelectedElement:function(){var a,c=this._.cache;if(c.selectedElement!==void 0)return c.selectedElement;if(p){a=this.getNative().createRange();a=a.item&&a.item(0)}var b;if(a)b=n(a);else{a=this.getRanges()[0];for(var d,l=2;l&&(!(b=a.getEnclosedNode())||!(b[0].nodeType===f.NodeType.ELEMENT_NODE&&g[b.nodeName()]&&(d=b)));l--)a.shrink(s.SHRINK_ELEMENT);b=d}a=b;return c.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var c,
b=this.document;if(p)try{c=b.body.createControlRange();c.addElement(a[0]);c.select()}catch(d){c=b.body.createTextRange();c.moveToElementText(a[0]);c.select()}finally{}else{c=b.createRange();c.selectNode(a[0]);a=this.getNative();a.removeAllRanges();a.addRange(c)}this.reset()},selectRanges:function(a){if(p){if(a.length>1){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var b=0;b<a.length;b++){var d=
a[b],g=this.document.createRange(),i=d.startContainer;if(d.collapsed&&(u.gecko&&u.gecko<1.09||u.webkit)&&i[0].nodeType===f.NodeType.ELEMENT_NODE&&!i[0].childNodes.length){i[0].appendChild(this.document.createTextNode(u.webkit?"\u200b":""));d.startOffset++;d.endOffset++}g.setStart(i[0],d.startOffset);g.setEnd(d.endContainer[0],d.endOffset);c.addRange(g)}}this.reset()},createBookmarks2:function(a){for(var c=[],b=this.getRanges(),d=0;d<b.length;d++)c.push(b[d].createBookmark2(a));return c},createBookmarks:function(a,
c){for(var b=[],d=this.document,g,c=c||this.getRanges(),i=c.length,h=0;h<i;h++){b.push(g=c[h].createBookmark(a,o));var p=(a=g.serializable)?n("#"+g.startNode,d):g.startNode;g=a?n("#"+g.endNode,d):g.endNode;for(var s=h+1;s<i;s++){var r=c[s],m=r.startContainer,q=r.endContainer;f.equals(m,p.parent())&&r.startOffset++;f.equals(m,g.parent())&&r.startOffset++;f.equals(q,p.parent())&&r.endOffset++;f.equals(q,g.parent())&&r.endOffset++}}return b},selectBookmarks:function(a){for(var c=[],b=0;b<a.length;b++){var d=
new t(this.document);d.moveToBookmark(a[b]);c.push(d)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4eCommonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true})},removeAllRanges:function(){var a=this.getNative();p?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},z=B.whitespaces(o),
d=/\ufeff|\u00a0/;t.prototype.select=!p?function(){var a=this.startContainer;if(this.collapsed&&a[0].nodeType===f.NodeType.ELEMENT_NODE&&!a[0].childNodes.length){a[0].appendChild(this.document.createTextNode(u.webkit?"\u200b":""));this.startOffset++;this.endOffset++}var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(o);c.setEnd(this.endContainer[0],this.endOffset)}else throw b;
}a=r(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var b=this.collapsed,g,j;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset===1){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType===f.NodeType.ELEMENT_NODE){(new q(this.document)).selectElement(n(i));return}}(this.startContainer[0].nodeType===f.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType===f.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in
c)&&this.shrink(s.SHRINK_ELEMENT,o);var h=this.createBookmark(),i=h.startNode,p;if(!b)p=h.endNode;h=this.document.body.createTextRange();h.moveToElementText(i[0]);h.moveStart("character",1);if(p){a=this.document.body.createTextRange();a.moveToElementText(p[0]);h.setEndPoint("EndToEnd",a);h.moveEnd("character",-1)}else{for(g=i[0].nextSibling;g&&!z(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(d))&&(a||!i[0].previousSibling||i[0].previousSibling&&f.nodeName(i[0].previousSibling)==="br");
j=n(this.document.createElement("span"));j.html("&#65279;");j.insertBefore(i);g&&f.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4eRemove();if(b){if(g){h.moveStart("character",-1);h.select();this.document.selection.clear()}else h.select();if(j){this.moveToPosition(j,s.POSITION_BEFORE_START);j._4eRemove()}}else{this.setEndBefore(p);p._4eRemove();h.select()}};q.getSelection=r;i.Selection=q;x.exports=q});
KISSY.add("editor/enter-key","util,node,ua,./walker,./base,./element-path".split(","),function(w,b,B){function x(b){var p;p=b.getSelection().getRanges();for(var g=p.length-1;g>0;g--)p[g].deleteContents();p=p[0];var g=p.document,c=new h(p.startContainer),q=p.checkStartOfBlock(),d=p.checkEndOfBlock(),c=c.block;if(q&&d){if(c&&(c.nodeName()==="li"||c.parent().nodeName()==="li")){if(b.hasCommand("outdent")){b.execCommand("save");b.execCommand("outdent");b.execCommand("save");return true}return false}}else if(c&&
c.nodeName()==="pre"&&!d){var a=t.ieMode<9?n(g.createTextNode("\r")):n(g.createElement("br"));p.insertNode(a);if(t.ieMode<9){a=n(g.createTextNode("\ufeff")).insertAfter(a);p.setStartAt(a,o.RangeType.POSITION_AFTER_START)}else p.setStartAfter(a);p.collapse(true);p.select();if(t.ieMode<9)a[0].nodeValue="";return}var e=p.splitBlock("p");if(!e)return true;var b=e.previousBlock,c=e.nextBlock,q=e.wasStartOfBlock,d=e.wasEndOfBlock,k;if(c){k=c.parent();if(k.nodeName()==="li"){c._4eBreakParent(k);c._4eMove(c.next(),
true)}}else if(b&&(k=b.parent())&&k.nodeName()==="li"){b._4eBreakParent(k);p.moveToElementEditablePosition(b.next());b._4eMove(b.prev())}if(!q&&!d){if(c.nodeName()==="li"&&(k=c.first(i.invisible(true)))&&r.inArray(k.nodeName(),["ul","ol"]))(u?n(g.createTextNode("\u00a0")):n(g.createElement("br"))).insertBefore(k);c&&p.moveToElementEditablePosition(c)}else{if(b){if(b.nodeName()==="li"||!f.test(b.nodeName()))a=b.clone()}else c&&(a=c.clone());a||(a=n("<p>",null,g));if(k=e.elementPath)for(var e=0,j=k.elements.length;e<
j;e++){var l=k.elements[e];if(l.equals(k.block)||l.equals(k.blockLimit))break;if(v.$removeEmpty[l.nodeName()]){l=l.clone();a._4eMoveChildren(l);a.append(l)}}u||a._4eAppendBogus();p.insertNode(a);if(u&&q&&(!d||!b[0].childNodes.length)){p.moveToElementEditablePosition(d?b:a);p.select()}p.moveToElementEditablePosition(q&&!d?c:a)}if(!u)if(c){a=n(g.createElement("span"));a.html("&nbsp;");p.insertNode(a);a.scrollIntoView(void 0,{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});p.deleteContents()}else a.scrollIntoView(void 0,
{alignWithTop:false,allowHorizontalScroll:true,onlyScrollIfNeeded:true});p.select();return true}function q(b){b.get("document").on("keydown",function(f){if(f.keyCode===13&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){b.execCommand("save");var g=b.execCommand("enterBlock");b.execCommand("save");g!==false&&f.preventDefault()}})}var r=b("util"),n=b("node"),t=b("ua"),i=b("./walker"),o=b("./base"),h=b("./element-path"),u=t.ieMode<11,f=/^(?:h[1-6])|(?:pre)$/i,v=o.XHTML_DTD;B.init=function(b){b.addCommand("enterBlock",
{exec:x});b.docReady(function(){q(b)})}});
KISSY.add("editor/html-data-processor",["html-parser","ua","node","util"],function(w,b,B){function x(b){if(!i.$removeEmpty[b.nodeName])return!1;var b=b.childNodes,f,h,n=b.length;if(n)for(f=0;f<n;f++)if(h=b[f],h.nodeType!==o.TEXT_NODE||h.nodeValue||!x(h))return!1;return!0}var q=b("html-parser"),r=b("ua"),n=11>r.ieMode,t=b("node"),i=q.DTD,o=t.Dom.NodeType,h=b("util");B.init=function(b){function f(a){return!x(a)}function o(a){return a.replace(z,function(a,b,c){return"<"+b+c.replace(d,function(a,b){return-1===
c.indexOf("_keSaved_"+b)?" _keSaved_"+a+" "+a:a})+">"})}function s(a){return a.replace(e,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}function p(a){return a.replace(k,function(a,b){return h.urlDecode(b)})}var g=new q.Filter,c=new q.Filter;(function(){function b(c){c=q.serialize(c);return new q.Comment(a+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,
noscript:b,span:f}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=["name","href","src"],c,d=0;d<b.length;d++)c="_keSaved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"===b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:f,strong:f,
em:f,del:f,u:f},attributes:{style:function(a){if(!h.trim(a))return!1}},attributeNames:[[/^_keSaved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)===a)return b=h.trim(h.urlDecode(b.substr(a.length))),q.parse(b).childNodes[0]}};n&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});g.addRules(e);c.addRules(d)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,d=b[c-1];d&&(3===
d.nodeType&&!h.trim(d.nodeValue)||1===d.nodeType&&x(d));)d=b[--c];return d}function b(c){var d=a(c);d&&(1===d.nodeType&&"br"===d.nodeName?c.removeChild(d):3===d.nodeType&&j.test(d.nodeValue)&&c.removeChild(d))}function d(b){var c=a(b);return!c||"form"===b.nodeName&&"input"===c.nodeName}function e(a){b(a);d(a)&&(n||a.appendChild(new q.Tag("br")))}function f(a){b(a);d(a)&&a.appendChild(new q.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,l=h.merge(i.$block,i.$listItem,i.$tableContent),k;for(k in l)"br"in
i[k]||delete l[k];delete l.pre;var p={tags:{}},o={tags:{}};for(k in l)p.tags[k]=e,o.tags[k]=f;c.addRules(p);g.addRules(o)})();g.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var z=/<(a|area|img|input)\b([^>]*)>/gi,d=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",e=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<script[^>]*>[\s\S]*<\/script>)|(?:<(:?link|meta|base)[^>]*>)/gi,k=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
j=/(<\/?)((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,l=/(<\/?)ke:((?:object|embed|param|html|body|head|title|noscript)[^>]*>)/gi,w=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;b.htmlDataProcessor={dataFilter:c,htmlFilter:g,toHtml:function(a){r.webkit&&(a=a.replace(/\u200b/g,""));var b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHtml(b,g);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||c,a=s(a),a=o(a),a=a.replace(j,"$1ke:$2"),a=a.replace(w,"<ke:$1$2></ke:$1>"),
d=t("<div>");d.html("a"+a);a=d.html().substr(1);a=a.replace(l,"$1$2");a=p(a);d=new q.BasicWriter;(new q.Parser(a)).parse().writeHtml(d,b);return a=d.getHtml()},toServer:function(a){var b=new q.MinifyWriter;(new q.Parser(a)).parse().writeHtml(b,g);return b.getHtml()}}}});
KISSY.add("editor/selection-fix",["./base","./selection","node","ua","dom"],function(w,b,B){function x(b){function f(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=u}return c}function c(){var a=h.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();e.detach("mouseup",c);e.detach("mousemove",i);j=d=0}function i(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",
j),a.select()}else c()}var d,a=b.get("window")[0],e=b.get("document"),h=e[0],j;e.on("mousedown contextmenu",function(b){var p=h.documentElement;if(b.target===p&&(d&&c(),!(p.scrollHeight>p.clientHeight)&&(d=1,j=f(b.pageX,b.pageY))))e.on("mouseup",c),e.on("mousemove",i),a.focus(),j.select()})}function q(b){function g(d){if(e){var f=b.getSelection(),i=f&&f.getType(),h=f&&c.selection;if(d&&h&&i===s.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){g(o)},50);else{var k;if(!h||
!h.type||!("Control"!==h.type&&(k=h.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))a=h&&f.getRanges()[0],b.checkSelectionChange()}}}var c=b.get("document")[0],n=i(c.body),d=i(c.documentElement);if(8>f.ieMode)d.on("click",function(a){"html"===i(a.target).nodeName()&&b.getSelection().getNative().createRange().select()});var a,e,k=o;d.on("mousedown",function(){k=h});d.on("mouseup",function(){k=o});n.on("focusin",function(b){if("body"===i(b.target).nodeName()&&
a){try{k&&a.select()}catch(c){}a=u}});n.on("focus",function(){e=o;g()});n.on("beforedeactivate",function(a){a.relatedTarget||(e=h,k=o)});n.on("mousedown",function(){e=h});n.on("mouseup",function(){e=o;setTimeout(function(){g(o)},0)});n.on("keydown",function(){e=h});n.on("keyup",function(){e=o;setTimeout(function(){g()},0)})}function r(b){b.get("document").on("mouseup keyup selectionchange",function(){b.checkSelectionChange()})}function n(b){function g(a){var b=t.XHTML_DTD;return a._4eIsBlockBoundary()&&
b.$empty[a.nodeName()]}function c(b){return d(b)&&a(b)}var n=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,d=t.Walker.whitespaces(o),a=t.Walker.bookmark(h,o),e=function(a){return d(a)&&8!==a.nodeType};b.on("selectionChange",function(a){var d=a.path,l=b.get("document")[0],r=i(l.body),a=(a=a.selection)&&a.getRanges()[0],q=d.blockLimit;r[0]||(l.documentElement.appendChild(l.createElement("body")),r=i(l.body),a&&(a.setStart(r,
0),a.collapse(1)));q=q||r;if(f.gecko){var s=(l=d.block||d.blockLimit)&&l.last(c);l&&l._4eIsBlockBoundary()&&(!s||!(1===s[0].nodeType&&s._4eIsBlockBoundary()))&&"pre"!==l.nodeName()&&!l._4eGetBogus()&&l._4eAppendBogus()}if(a&&a.collapsed&&!d.block){if("body"===q.nodeName()){"html"===a.startContainer.nodeName()&&a.setStart(r,0);if((d=a.fixBlock(o,"p"))&&d[0]!==r[0].lastChild&&d.outerHtml().match(n))if((l=d.next(e,1))&&l[0].nodeType===v.NodeType.ELEMENT_NODE&&!g[l])a.moveToElementEditablePosition(l),
d._4eRemove();else if((l=d.prev(e,1))&&l[0].nodeType===v.NodeType.ELEMENT_NODE&&!g[l])a.moveToElementEditablePosition(l,l.outerHtml().match(n)?h:o),d._4eRemove();a.select();b.notifySelectionChange()}d=b.get("document")[0];a=new t.Range(d);a.moveToElementEditablePosition(r,o);"body"!==(new t.ElementPath(a.startContainer)).blockLimit.nodeName()&&(r=i(d.createElement("p")).appendTo(r),f.ie||r._4eAppendBogus())}})}var t=b("./base");b("./selection");var i=b("node"),o=!0,h=!1,u=null,f=b("ua"),v=b("dom"),
s=t.SelectionType;B.init=function(b){b.docReady(function(){if(document.selection)x(b),q(b);else if(r(b),f.ie){var g,c=b.get("document");c.on("focusout",function(){g=b.getSelection().getRanges()});c.on("focusin",function(){g&&(b.getSelection().selectRanges(g),g=null)})}});n(b)}});
KISSY.add("editor/styles","util,./selection,./range,./base,./element-path,node,dom,ua".split(","),function(w,b,B,x){function q(a){return!C.attr(a,"_ke_bookmark")}function r(a,b){for(var c in a)typeof a[c]==="string"?a[c]=a[c].replace(T,function(a,c){return b[c]}):r(a[c],b)}function n(a,b){if(b){a=j.clone(a);r(a,b)}var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=c==="#text"||S[c]?K.STYLE_BLOCK:Q[c]?K.STYLE_OBJECT:K.STYLE_INLINE;this._={definition:a}}function t(a,
b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=new l(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function i(a,b,c){var d=a.element;d==="*"&&(d="span");b=m(b.createElement(d));c&&c._4eCopyAttributes(b);c=a._.definition;a=c.attributes;c=n.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);if(c)b[0].style.cssText=c;return b}function o(a){var b=a.createBookmark(y),c=a.createIterator();c.enforceRealBlocks=y;c.enlargeBr=y;for(var d,e=a.document;d=
c.getNextParagraph();){var g=i(this,e,d),j=g,g=j.nodeName==="pre",l=d.nodeName==="pre",k=!g&&l;if(g&&!l){l=d;k=l.html();k=h(k,/(?:^[\t\n\r]+)|(?:[\t\n\r]+$)/g,"");k=k.replace(/[\t\r\n]*(<br[^>]*>)[\t\r\n]*/gi,"$1");k=k.replace(/([\t\n\r]+|&nbsp;)/g," ");k=k.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){l=l[0].ownerDocument.createElement("div");l.appendChild(j[0]);j.outerHtml("<pre>"+k+"</pre>");j=m(l.firstChild);j._4eRemove()}else j.html(k)}else k?j=f(u(d),j):d._4eMoveChildren(j);d[0].parentNode.replaceChild(j[0],
d[0]);if(g){d=j;g=void 0;if((g=d._4ePreviousSourceNode(y,C.NodeType.ELEMENT_NODE))&&g.nodeName()==="pre"){j=h(g.html(),/\n$/,"")+"\n\n"+h(d.html(),/^\n/,"");O.ie?d.outerHtml("<pre>"+j+"</pre>"):d.html(j);g._4eRemove()}}}a.moveToBookmark(b)}function h(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function u(a){var b=[];h(a.outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function f(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=h(e,/^[\t]*\n/,""),e=h(e,/\n$/,""),e=h(e,/^[\t]+|[\t]+$/g,function(a,b){return a.length===1?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[\t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}function v(b){var c=b.document;if(b.collapsed){c=i(this,c,void 0);b.insertNode(c);b.moveToPosition(c,E.POSITION_BEFORE_END)}else{var d=this.element,e=this._.definition,f,g=L[d];if(!g){f=y;g=L.span}var h=b.createBookmark();b.enlarge(E.ENLARGE_ELEMENT);b.trim();for(var j=b.createBookmark(),l=j.startNode,j=j.endNode,k=l,o;k&&k[0];){var n=J;if(C.equals(k,j)){k=F;n=y}else{var p=k[0].nodeType,r=p===C.NodeType.ELEMENT_NODE?k.nodeName():F;if(r&&k.attr("_ke_bookmark")){k=
k._4eNextSourceNode(y);continue}if(!r||g[r]&&(k._4ePosition(j)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(k))){var s=k.parent();if(s&&d==="a"&&s.nodeName()===d){p=i(this,c,void 0);s._4eMoveChildren(p);s[0].parentNode.replaceChild(p[0],s[0]);p._4eMergeSiblings()}else if(s&&s[0]&&((L[s.nodeName()]||L.span)[d]||f)&&(!e.parentRule||e.parentRule(s))){if(!o&&(!r||!L.$removeEmpty[r]||(k._4ePosition(j)|
D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED)){o=new H(c);o.setStartBefore(k)}if(p===C.NodeType.TEXT_NODE||p===C.NodeType.ELEMENT_NODE&&!k[0].childNodes.length){s=k;for(p=null;(n=!s.next(q,1))&&(p=s.parent())&&g[p.nodeName()]&&(p._4ePosition(l)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)===D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)s=
p;o.setEndAfter(s)}}else n=y}else n=y;k=k._4eNextSourceNode()}if(n&&o&&!o.collapsed){for(var n=i(this,c,void 0),s=o.getCommonAncestor(),p={},r={},t,u=null,v;n&&s&&n[0]&&s[0];){if(s.nodeName()===d){for(t in e.attributes)if(!r[t]&&(v=s.attr(u)))n.attr(t)===v?n.removeAttr(t):r[t]=1;for(u in e.styles)if(!p[u]&&(v=s.style(u)))n.style(u)===v?n.style(u,""):p[u]=1;if(!n._4eHasAttributes()){n=F;break}}s=s.parent()}if(n){n[0].appendChild(o.extractContents());a(this,n);o.insertNode(n);n._4eMergeSiblings();O.ie||
n[0].normalize()}else{n=m(c.createElement("span"));n[0].appendChild(o.extractContents());o.insertNode(n);a(this,n);n._4eRemove(true)}o=F}}l._4eRemove();j._4eRemove();b.moveToBookmark(h);b.shrink(E.SHRINK_TEXT)}}function s(a){a.enlarge(E.ENLARGE_ELEMENT);var b=a.createBookmark(),d=b.startNode;if(a.collapsed){for(var f=new I(d.parent()),g,i=0,h;i<f.elements.length&&(h=f.elements[i]);i++){if(h.equals(f.block)||h.equals(f.blockLimit))break;if(this.checkElementRemovable(h)){var j=a.checkBoundaryOfElement(h,
E.END),k=!j&&a.checkBoundaryOfElement(h,E.START);if(k||j){g=h;g.match=k?"start":"end"}else{h._4eMergeSiblings();if(h.nodeName()!==this.element){j=c(this);e(h,j[h.nodeName()]||j["*"])}else z(this,h)}}}if(g){h=d;for(i=0;;i++){j=f.elements[i];if(j.equals(g))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(h[0]);h=j}h[g.match==="start"?"insertBefore":"insertAfter"](g);f=g.html();!f||f==="\u200b"?g.remove():O.webkit&&m(a.document.createTextNode("\u200b")).insertBefore(h)}}else{var l=b.endNode,n=
this;g=function(){for(var a=new I(d.parent()),b=new I(l.parent()),c=F,e,f=F,g=0;g<a.elements.length;g++){e=a.elements[g];if(e===a.block||e===a.blockLimit)break;n.checkElementRemovable(e)&&(c=e)}for(g=0;g<b.elements.length;g++){e=b.elements[g];if(e===b.block||e===b.blockLimit)break;n.checkElementRemovable(e)&&(f=e)}f&&l._4eBreakParent(f);c&&d._4eBreakParent(c)};g();for(f=m(d[0].nextSibling);f[0]!==l[0];){i=f._4eNextSourceNode();if(f[0]&&f[0].nodeType===C.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)){if(f.nodeName()===
this.element)z(this,f);else{h=c(this);e(f,h[f.nodeName()]||h["*"])}if(i[0].nodeType===C.NodeType.ELEMENT_NODE&&i.contains(d)){g();i=m(d[0].nextSibling)}}f=i}}a.moveToBookmark(b)}function p(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function g(a,b){var c="";if(b!==J){c=document.createElement("span");c.style.cssText=a;c=c.style.cssText||""}else c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function c(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){j.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],f,g,h;if(typeof e==="string")f=e.toLowerCase();else{f=e.element?e.element.toLowerCase():a.element;g=e.attributes;h=e.styles}e=b[f]||(b[f]={});if(g){f=e.attributes=e.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var e=e.styles=e.styles||[],k;for(k in h)e.push([k.toLowerCase(),h[k]])}}}return b}
function z(a,b){var e=a._.definition,f=c(a),g=j.merge(e.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),e=j.merge(e.styles,(f[b.nodeName()]||f["*"]||{}).styles),f=j.isEmptyObject(g)&&j.isEmptyObject(e),h;for(h in g)if(!((h==="class"||a._.definition.fullMatch)&&b.attr(h)!==d(h,g[h]))){f=f||!!b.hasAttr(h);b.removeAttr(h)}for(var i in e)if(!(a._.definition.fullMatch&&b.style(i)!==d(i,e[i],y))){f=f||!!b.style(i);b.style(i,"")}k(b)}function d(a,b,c){var d=m("<span>");d[c?"style":"attr"](a,b);return d[c?
"style":"attr"](a)}function a(a,b){for(var d=c(a),f=b.all(a.element),g=f.length;--g>=0;)z(a,m(f[g]));for(var h in d)if(h!==a.element){f=b.all(h);for(g=f.length-1;g>=0;g--){var i=m(f[g]);e(i,d[h])}}}function e(a,b){var c,d,e=b&&b.attributes;if(e)for(c=0;c<e.length;c++){var f=e[c][0];if(d=a.attr(f)){var g=e[c][1];(g===F||g.test&&g.test(d)||typeof g==="string"&&d===g)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(c=0;c<e.length;c++){f=e[c][0];if(g=a.css(f)){var h=e[c][1];(h===F||h.test&&h.test(d)||
typeof h==="string"&&g===h)&&a.css(f,"")}}k(a)}function k(a){if(!a._4eHasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4eRemove(y);if(b){b.nodeType===C.NodeType.ELEMENT_NODE&&C._4eMergeSiblings(b);c&&b!==c&&c.nodeType===C.NodeType.ELEMENT_NODE&&C._4eMergeSiblings(c)}}}var j=b("util"),l=b("./selection"),H=b("./range"),w=b("./base"),I=b("./element-path"),y=true,J=false,F=null,m=b("node"),C=b("dom"),E=w.RangeType,D=w.PositionType,K,O=b("ua"),S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,
p:1,pre:1},L=w.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;w.StyleType=K={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3};n.prototype={constructor:n,apply:function(a){t.call(this,a,J)},remove:function(a){t.call(this,a,y)},applyToRange:function(a){return(this.applyToRange=this.type===K.STYLE_INLINE?v:this.type===K.STYLE_BLOCK?o:F).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type===
K.STYLE_INLINE?s:F).call(this,a)},checkElementRemovable:function(a,b){if(!a)return J;var d,e=this._.definition,f;if(a.nodeName()===this.element){if(!b&&!a._4eHasAttributes())return y;var h=e._AC;if(!h){var h={},i=0,j=e.attributes;if(j)for(var k in j){i++;h[k]=j[k]}if(j=n.getStyleText(e)){h.style||i++;h.style=j}h._length=i;e._AC=h}e=h;if(e._length){for(d in e)if(d!=="_length"){i=a.attr(d)||"";if(d==="style")a:{h=e[d];i=g(i,J);typeof h==="string"&&(h=p(h));typeof i==="string"&&(i=p(i));j=void 0;for(j in h)if(!(j in
i&&(i[j]===h[j]||h[j]==="inherit"||i[j]==="inherit"))){h=J;break a}h=y}else h=e[d]===i;if(h){if(!b)return y}else if(b)return J}if(b)return y}else return y}d=c(this);if(d=d[a.nodeName()]||d["*"]){if(!(e=d.attributes)&&!(f=d.styles))return y;if(e)for(h=0;h<e.length;h++){d=e[h][0];if(d=a.attr(d)){i=e[h][1];if(i===F||typeof i==="string"&&d===i||i.test&&i.test(d))return y}}if(f)for(h=0;h<f.length;h++)if(d=a.css(f[h][0])){e=f[h][1];if(e===F||typeof e==="string"&&d===e||e.test&&e.test(d))return y}}return J},
checkActive:function(a){switch(this.type){case K.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,y);case K.STYLE_OBJECT:case K.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++){d=b[c];if(!(this.type===K.STYLE_INLINE&&(C.equals(d,a.block)||C.equals(d,a.blockLimit))))if((this.type!==K.STYLE_OBJECT||d.nodeName()in Q)&&this.checkElementRemovable(d,y))return y}}return J}};n.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",
d="";c.length&&(c=c.replace(R,";"));for(var e in b){var f=b[e],h=(e+":"+f).replace(R,";");f==="inherit"?d=d+h:c=c+h}c.length&&(c=g(c));c=c+d;return a._ST=c};w.Style=n;x.exports=n});
KISSY.add("editor/dom-iterator","util,node,./walker,./range,./base,./element-path,ua,dom".split(","),function(w,b,B,x){function q(b){if(!(arguments.length<1)){this.range=b;this.forceBrBreak=u;this.enlargeBr=h;this.enforceRealBlocks=u;this._=this._||{}}}var r=b("util"),n=b("node"),t=b("./walker"),i=b("./range"),w=b("./base"),o=b("./element-path"),h=true,u=false,f=b("ua"),v=w.RangeType,s=b("dom"),p=/^[\r\n\t ]*$/;r.augment(q,{getNextParagraph:function(b){var c,q,d,a,e,k;if(!this._.lastNode){d=this.range.clone();
d.shrink(v.SHRINK_ELEMENT,h);d.enlarge(this.forceBrBreak||!this.enlargeBr?v.ENLARGE_LIST_ITEM_CONTENTS:v.ENLARGE_BLOCK_CONTENTS);q=new t(d);var j=t.bookmark(h,h);q.evaluator=j;this._.nextNode=q.next();q=new t(d);q.evaluator=j;q=q.previous();this._.lastNode=q._4eNextSourceNode(h);if(this._.lastNode&&this._.lastNode[0].nodeType===s.NodeType.TEXT_NODE&&!r.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4eIsBlockBoundary()){j=new i(d.document);j.moveToPosition(this._.lastNode,v.POSITION_AFTER_END);
if(j.checkEndOfBlock()){j=new o(j.endContainer);this._.lastNode=(j.block||j.blockLimit)._4eNextSourceNode(h)}}if(!this._.lastNode){this._.lastNode=this._.docEndMarker=n(d.document.createTextNode(""));s.insertAfter(this._.lastNode[0],q[0])}d=null}j=this._.nextNode;q=this._.lastNode;for(this._.nextNode=null;j;){var l=u,w=j[0].nodeType!==s.NodeType.ELEMENT_NODE,x=u;if(w)j[0].nodeType===s.NodeType.TEXT_NODE&&p.test(j[0].nodeValue)&&(w=u);else{var y=j.nodeName();if(j._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){if(y==="br")w=h;else if(!d&&!j[0].childNodes.length&&y!=="hr"){c=j;a=j.equals(q);break}if(d){d.setEndAt(j,v.POSITION_BEFORE_START);if(y!=="br")this._.nextNode=j}l=h}else{if(j[0].firstChild){if(!d){d=new i(this.range.document);d.setStartAt(j,v.POSITION_BEFORE_START)}j=n(j[0].firstChild);continue}w=h}}if(w&&!d){d=new i(this.range.document);d.setStartAt(j,v.POSITION_BEFORE_START)}a=(!l||w)&&j.equals(q);if(d&&!l)for(;!j[0].nextSibling&&!a;){y=j.parent();if(y._4eIsBlockBoundary(this.forceBrBreak&&
{br:1})){l=h;a||y.equals(q);break}j=y;w=h;a=j.equals(q);x=h}w&&d.setEndAt(j,v.POSITION_AFTER_END);j=j._4eNextSourceNode(x,null,q);if((a=!j)||l&&d)break}if(!c){if(!d){this._.docEndMarker&&this._.docEndMarker._4eRemove();return this._.nextNode=null}c=new o(d.startContainer);j=c.blockLimit;l={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&l[j.nodeName()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&c.nodeName()==="li"){c=n(this.range.document.createElement(b||
"p"));c[0].appendChild(d.extractContents());c._4eTrim();d.insertNode(c);e=k=h}else if(c.nodeName()!=="li"){if(!d.checkStartOfBlock()||!d.checkEndOfBlock()){c=c.clone(u);c[0].appendChild(d.extractContents());c._4eTrim();k=d.splitBlock();e=!k.wasStartOfBlock;k=!k.wasEndOfBlock;d.insertNode(c)}}else if(!a)this._.nextNode=c.equals(q)?null:d.getBoundaryNodes().endNode._4eNextSourceNode(h,null,q)}if(e){d=n(c[0].previousSibling);d[0]&&d[0].nodeType===s.NodeType.ELEMENT_NODE&&(d.nodeName()==="br"?d._4eRemove():
d[0].lastChild&&s.nodeName(d[0].lastChild)==="br"&&s._4eRemove(d[0].lastChild))}if(k){d=t.bookmark(u,h);e=n(c[0].lastChild);e[0]&&e[0].nodeType===s.NodeType.ELEMENT_NODE&&e.nodeName()==="br"&&(f.ie||e.prev(d,1)||e.next(d,1))&&e.remove()}if(!this._.nextNode)this._.nextNode=a||c.equals(q)?null:c._4eNextSourceNode(h,null,q);return c}});i.prototype.createIterator=function(){return new q(this)};x.exports=q});
KISSY.add("editor/z-index-manager",["./base"],function(w,b,B,x){var q=b("./base"),w=q.ZIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};q.baseZIndex=function(b){return(q.Config.baseZIndex||1E4)+b};x.exports=w});
