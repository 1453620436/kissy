/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Sep 17 23:09
*/
KISSY.add("scroll-view/drag",function(m,G,w,H){function x(b,c,a){var c=c.timeStamp,d=b.get("scroll"+m.ucfirst(a));b.startScroll[a]=d;b.swipe[a].startTime=c;b.swipe[a].scroll=d}function y(b,c,a,d){if(!z(b,a)){var f={pageX:c.touches[0].pageX,pageY:c.touches[0].pageY},e="left"==a?"pageX":"pageY",i=b.lastPageXY,g,j=b.startScroll[a]-(f[e]-d[e]),d=c.timeStamp,l=b.minScroll,o=b.maxScroll,k=b.lastDirection,h=b.swipe,n;i[e]&&(g=f[e]==i[e],n=0<f[e]-i[e]);b.get("bounce")||(j=Math.min(Math.max(j,l[a]),o[a]));
j<l[a]?(f=l[a]-j,f*=A,j=l[a]-f):j>o[a]&&(f=j-o[a],f*=A,j=o[a]+f);f=d-h[a].startTime;if(!g&&void 0!==k[a]&&k[a]!==n||f>I)h[a].startTime=d,h[a].scroll=j;b.set("scroll"+m.ucfirst(a),j);k[a]=n;i[e]=c[e]}}function z(b,c){return!b.allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function B(b,c,a,d){if(z(b,a))d();else{var f="scroll"+m.ucfirst(a),e=b.get(f),i=b.minScroll,g=b.maxScroll,j=c.timeStamp,c=b.swipe,l;e<i[a]?l=i[a]:e>g[a]&&(l=g[a]);void 0!==l?(e={},e[a]=l,b.scrollTo(e,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:d})):b.pagesOffset?d():(l=j-c[a].startTime,c=e-c[a].scroll,0==l||0==c?d():(l=Math.min(Math.max(c/l,-C),C),d={node:{},to:{},duration:9999,queue:!1,complete:d,frame:J(b,l,e,f,g[a],i[a])},d.node[a]=e,d.to[a]=null,b.scrollAnims.push((new H(d)).run())))}}function J(b,c,a,d,f,e){var i=c*v,g=1,j=0;return function(c,o){var k=m.now(),h;if(g){h=k-c.startTime;var n=Math.exp(h*K);h=parseInt(a+i*(1-n)/-D);h>e&&h<f?o.lastValue===h?o.pos=1:(o.lastValue=h,b.set(d,h)):
(g=0,i*=n,a=h<=e?e:f,j=k)}else h=k-j,k=h/v,k*=Math.exp(-L*k),h=parseInt(i*k),0===h&&(o.pos=1),b.set(d,a+h)}}function M(b){var c=b.touches;if(!this.get("disabled")){this.stopAnimation();var a={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};if(this.isScrolling){var d=this.get("pageIndex");this.fire("scrollEnd",m.mix({fromPageIndex:d,pageIndex:d},a))}1<c.length||(E(this),this.startMousePos=a,x(this,b,"left"),x(this,b,"top"),F.on(t.move,u,this).on(t.end,N,this))}}function u(b){var c=b.touches,a=this.startMousePos;
if(a){var c={pageX:c[0].pageX,pageY:c[0].pageY},d=Math.abs(c.pageX-a.pageX),f=Math.abs(c.pageY-a.pageY);if(!(Math.max(d,f)<O)){this.isScrolling||(this.fire("scrollStart",c),this.isScrolling=1);var e=this.get("lockX"),i=this.get("lockY");if(e||i){var g;if(!(g=this.dragInitDirection))this.dragInitDirection=g=d>f?"left":"top";if(e&&"left"==g&&!this.allowScroll[g]){this.isScrolling=0;return}if(i&&"top"==g&&!this.allowScroll[g]){this.isScrolling=0;return}}m.Features.isTouchEventSupported()&&b.preventDefault();
y(this,b,"left",a);y(this,b,"top",a);this.fire("scrollMove",c)}}}function N(b){function c(){f++;if(2==f){var c=function(){a.isScrolling=0;a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:h,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){a.get("snapThreshold");var d=a.get("snapDuration"),k=a.get("snapEasing"),h=a.get("pageIndex"),n=a.get("scrollLeft"),p=a.get("scrollTop"),d={duration:d,easing:k,complete:c},k=a.pagesOffset.concat([]);a.isScrolling=0;if(g||j)if(g&&j){var q=[],r=void 0;
m.each(k,function(a){a&&(0<e&&a.left>n?q.push(a):0>e&&a.left<n&&q.push(a))});var s;0<i?(s=Number.MAX_VALUE,m.each(q,function(a){a.top>p&&s<a.top-p&&(s=a.top-p,r=q.index)})):(s=Number.MAX_VALUE,m.each(q,function(a){a.top<p&&s<p-a.top&&(s=p-a.top,r=q.index)}));void 0!=r?r!=h?a.scrollToPage(r,d):(a.scrollToPage(r),c()):c()}else g||j?(c=a._getPageIndexFromXY(g?n:p,g,g?e:i),a.scrollToPage(c,d)):(a.scrollToPage(a.get("pageIndex")),c())}else c()}}var a=this,d=a.startMousePos;F.detach(t.move,u,a);if(d&&a.isScrolling){var f=
0,e=d.pageX-b.pageX,i=d.pageY-b.pageY,d=a.get("snapThreshold"),g=a.allowScroll.left&&Math.abs(e)>d,j=a.allowScroll.top&&Math.abs(i)>d;a.fire("dragend",{pageX:b.pageX,pageY:b.pageY});B(a,b,"left",c);B(a,b,"top",c)}}function E(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function P(b){b.preventDefault()}var A=0.5,O=3,t=w.Gesture,I=300,C=6,F=w.all(document),v=20,D=Math.log(0.95),K=D/v,L=0.3;m.UA.ie&&(u=m.throttle(u,30));
return G.extend({bindUI:function(){this.$contentEl.on("dragstart",P).on(t.start,M,this)},syncUI:function(){E(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","node","anim"]});
