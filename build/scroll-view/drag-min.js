/*
Copyright 2014, KISSY v1.42
MIT Licensed
build time: Feb 25 20:58
*/
KISSY.add("scroll-view/drag",["./base","node","anim"],function(l,v){function x(b,c,a){var c=c.timeStamp,e=b.get("scroll"+l.ucfirst(a));b.startScroll[a]=e;b.swipe[a].startTime=c;b.swipe[a].scroll=e}function y(b,c,a,e){if(!z(b,a)){var f={pageX:c.pageX,pageY:c.pageY},d="left"===a?"pageX":"pageY",g=b.lastPageXY,h,k=b.startScroll[a]-(f[d]-e[d]),e=c.timeStamp,n=b.minScroll,q=b.maxScroll,i=b.lastDirection,j=b.swipe,m;g[d]&&(h=f[d]===g[d],m=0<f[d]-g[d]);b.get("bounce")||(k=Math.min(Math.max(k,n[a]),q[a]));
k<n[a]?(f=n[a]-k,f*=A,k=n[a]-f):k>q[a]&&(f=k-q[a],f*=A,k=q[a]+f);f=e-j[a].startTime;if(!h&&void 0!==i[a]&&i[a]!==m||f>I)j[a].startTime=e,j[a].scroll=k;b.set("scroll"+l.ucfirst(a),k);i[a]=m;g[d]=c[d]}}function z(b,c){return!b.allowScroll[c]&&b.get("left"===c?"lockX":"lockY")?1:0}function B(b,c,a,e){if(z(b,a))e();else{var f="scroll"+l.ucfirst(a),d=b.get(f),g=b.minScroll,h=b.maxScroll,k=c.timeStamp,c=b.swipe,n;d<g[a]?n=g[a]:d>h[a]&&(n=h[a]);void 0!==n?(d={},d[a]=n,b.scrollTo(d,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:e})):b.pagesOffset?e():(n=k-c[a].startTime,c=d-c[a].scroll,0===n||0===c?e():(n=Math.min(Math.max(c/n,-C),C),e={node:{},to:{},duration:9999,queue:!1,complete:e,frame:J(b,n,d,f,h[a],g[a])},e.node[a]=d,e.to[a]=null,b.scrollAnims.push((new K(e)).run())))}}function J(b,c,a,e,f,d){var g=c*w,h=1,k=0;return function(c,q){var i=l.now(),j;if(h){j=i-c.startTime;var m=Math.exp(j*L);j=parseInt(a+g*(1-m)/-D,10);j>d&&j<f?q.lastValue===j?q.pos=1:(q.lastValue=j,b.set(e,
j)):(h=0,g*=m,a=j<=d?d:f,k=i)}else j=i-k,i=j/w,i*=Math.exp(-M*i),j=parseInt(g*i,10),0===j&&(q.pos=1),b.set(e,a+j)}}function N(b){if(b.isTouch){var c=b.touches;if(!this.get("disabled")){this.stopAnimation();var a={pageX:b.pageX,pageY:b.pageY};if(this.isScrolling){var e=this.get("pageIndex");this.fire("scrollEnd",l.mix({fromPageIndex:e,pageIndex:e},a))}1<c.length||(E(this),this.startMousePos=a,x(this,b,"left"),x(this,b,"top"),F.on(p.move,u,this).on(p.end,G,this))}}}function G(b){if(b.isTouch){var c=
this.startMousePos;F.detach(p.move,u,this).detach(p.end,G,this);c&&this.isScrolling&&this.fire("dragend",{pageX:b.pageX,deltaX:-(c.pageX-b.pageX),deltaY:-(c.pageY-b.pageY),pageY:b.pageY})}}function O(b){function c(){e++;if(2===e){var c=function(){a.isScrolling=0;a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,deltaX:-f,deltaY:-d,fromPageIndex:j,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){var g=a._snapDurationCfg,i=a._snapEasingCfg,j=a.get("pageIndex"),m=a.get("scrollLeft"),l=a.get("scrollTop"),
g={duration:g,easing:i,complete:c},p=a.pagesOffset,r=p.length;a.isScrolling=0;if(h||k)if(h&&k){var i=[],o,s;for(o=0;o<r;o++){var t=p[o];t&&(0<f&&t.left>m?i.push(t):0>f&&t.left<m&&i.push(t))}p=i.length;if(0<d){m=Number.MAX_VALUE;for(o=0;o<p;o++)r=i[o],r.top>l&&m<r.top-l&&(m=r.top-l,s=i.index)}else{m=Number.MAX_VALUE;for(o=0;o<p;o++)r=i[o],r.top<l&&m<l-r.top&&(m=l-r.top,s=i.index)}void 0!==s?s!==j?a.scrollToPage(s,g):(a.scrollToPage(s),c()):c()}else h||k?(c=a._getPageIndexFromXY(h?m:l,h,h?f:d),a.scrollToPage(c,
g)):(a.scrollToPage(j),c())}else c()}}var a=this,e=0,f=-b.deltaX,d=-b.deltaY,g=a._snapThresholdCfg,h=a.allowScroll.left&&Math.abs(f)>g,k=a.allowScroll.top&&Math.abs(d)>g;B(a,b,"left",c);B(a,b,"top",c)}function E(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function P(b){b.preventDefault()}var Q=v("./base"),H=v("node"),K=v("anim"),A=0.5,p=H.Gesture,I=300,C=6,F=H.all(document),w=20,D=Math.log(0.95),L=D/w,M=0.3,u=function(b){if(b.isTouch){var c=
this.startMousePos;if(c){var a={pageX:b.pageX,pageY:b.pageY},e=Math.abs(a.pageX-c.pageX),f=Math.abs(a.pageY-c.pageY);if(!(3>Math.max(e,f))){this.isScrolling||(this.fire("scrollStart",a),this.isScrolling=1);var d=this.get("lockX"),g=this.get("lockY");if(d||g){var h;if(!(h=this.dragInitDirection))this.dragInitDirection=h=e>f?"left":"top";if(d&&"left"===h&&!this.allowScroll[h]){this.isScrolling=0;this.get("preventDefaultX")&&b.preventDefault();return}if(g&&"top"===h&&!this.allowScroll[h]){this.isScrolling=
0;this.get("preventDefaultY")&&b.preventDefault();return}}l.Features.isTouchEventSupported()&&b.preventDefault();y(this,b,"left",c);y(this,b,"top",c);this.fire("scrollMove",a)}}}};l.UA.ie&&(u=l.throttle(u,30));return Q.extend({initializer:function(){this._snapThresholdCfg=this.get("snapThreshold");this._snapDurationCfg=this.get("snapDuration");this._snapEasingCfg=this.get("snapEasing");this.publish("dragend",{defaultFn:O,defaultTargetOnly:!0})},bindUI:function(){this.$contentEl.on("dragstart",P).on(p.start,
N,this)},syncUI:function(){E(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},preventDefaultX:{value:!0},lockY:{value:!1},preventDefaultY:{value:!1},snapDuration:{value:0.3},snapEasing:{value:"easeOut"},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}}})});
