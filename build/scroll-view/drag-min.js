/*
Copyright 2013, KISSY v1.40dev
MIT Licensed
build time: Sep 3 19:05
*/
KISSY.add("scroll-view/drag",function(m,E,F,G){function w(b,c,a){var c=c.timeStamp,f=b.get("scroll"+m.ucfirst(a));b.startScroll[a]=f;b.swipe[a].startTime=c;b.swipe[a].scroll=f}function x(b,c,a,f){if(!y(b,a)){var d={pageX:c.touches[0].pageX,pageY:c.touches[0].pageY},e="left"==a?"pageX":"pageY",i=b.lastPageXY,g,j=b.startScroll[a]-(d[e]-f[e]),f=c.timeStamp,l=b.minScroll,o=b.maxScroll,k=b.lastDirection,h=b.swipe,n;i[e]&&(g=d[e]==i[e],n=0<d[e]-i[e]);b.get("bounce")||(j=Math.min(Math.max(j,l[a]),o[a]));
j<l[a]?(d=l[a]-j,d*=z,j=l[a]-d):j>o[a]&&(d=j-o[a],d*=z,j=o[a]+d);d=f-h[a].startTime;if(!g&&void 0!==k[a]&&k[a]!==n||d>H)h[a].startTime=f,h[a].scroll=j;b.set("scroll"+m.ucfirst(a),j);k[a]=n;i[e]=c[e]}}function y(b,c){return!b.allowScroll[c]&&b.get("left"==c?"lockX":"lockY")?1:0}function A(b,c,a,f){if(y(b,a))f();else{var d="scroll"+m.ucfirst(a),e=b.get(d),i=b.minScroll,g=b.maxScroll,j=c.timeStamp,c=b.swipe,l;e<i[a]?l=i[a]:e>g[a]&&(l=g[a]);void 0!==l?(e={},e[a]=l,b.scrollTo(e,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:f})):b.pagesOffset?f():(l=j-c[a].startTime,c=e-c[a].scroll,0==l||0==c?f():(l=Math.min(Math.max(c/l,-B),B),f={node:{},to:{},duration:9999,queue:!1,complete:f,frame:I(b,l,e,d,g[a],i[a])},f.node[a]=e,f.to[a]=null,b.scrollAnims.push((new G(f)).run())))}}function I(b,c,a,f,d,e){var i=c*v,g=1,j=0;return function(c,o){var k=m.now(),h;if(g){h=k-c.startTime;var n=Math.exp(h*J);h=parseInt(a+i*(1-n)/-C);h>e&&h<d?o.lastValue===h?o.pos=1:(o.lastValue=h,b.set(f,h)):
(g=0,i*=n,a=h<=e?e:d,j=k)}else h=k-j,k=h/v,k*=Math.exp(-K*k),h=parseInt(i*k),0===h&&(o.pos=1),b.set(f,a+h)}}function L(b){if(!this.get("disabled")){this.stopAnimation();var c={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};if(this.isScrolling){var a=this.get("pageIndex");this.fire("scrollEnd",m.mix({fromPageIndex:a,pageIndex:a},c))}D(this);this.startMousePos=c;w(this,b,"left");w(this,b,"top");this.$contentEl.on(t.move,u,this)}}function u(b){var c=this.startMousePos;if(c){var a={pageX:b.touches[0].pageX,
pageY:b.touches[0].pageY},f=Math.abs(a.pageX-c.pageX),d=Math.abs(a.pageY-c.pageY);if(!(Math.max(f,d)<M)){this.isScrolling||(this.fire("scrollStart",a),this.isScrolling=1);var e=this.get("lockX"),i=this.get("lockY");if(e||i){var g;if(!(g=this.dragInitDirection))this.dragInitDirection=g=f>d?"left":"top";if(e&&"left"==g&&!this.allowScroll[g]){this.isScrolling=0;return}if(i&&"top"==g&&!this.allowScroll[g]){this.isScrolling=0;return}}m.Features.isTouchEventSupported()&&b.preventDefault();x(this,b,"left",
c);x(this,b,"top",c);this.fire("scrollMove",a)}}}function N(b){function c(){f++;if(2==f){var c=function(){a.isScrolling=0;a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,fromPageIndex:h,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){a.get("snapThreshold");var d=a.get("snapDuration"),k=a.get("snapEasing"),h=a.get("pageIndex"),n=a.get("scrollLeft"),p=a.get("scrollTop"),d={duration:d,easing:k,complete:c},k=a.pagesOffset.concat([]);a.isScrolling=0;if(g||j)if(g&&j){var q=[],r=void 0;m.each(k,function(a){a&&
(0<e&&a.left>n?q.push(a):0>e&&a.left<n&&q.push(a))});var s;0<i?(s=Number.MAX_VALUE,m.each(q,function(a){a.top>p&&s<a.top-p&&(s=a.top-p,r=q.index)})):(s=Number.MAX_VALUE,m.each(q,function(a){a.top<p&&s<p-a.top&&(s=p-a.top,r=q.index)}));void 0!=r?r!=h?a.scrollToPage(r,d):(a.scrollToPage(r),c()):c()}else g||j?(c=a._getPageIndexFromXY(g?n:p,g,g?e:i),a.scrollToPage(c,d)):(a.scrollToPage(a.get("pageIndex")),c())}else c()}}var a=this,f=0,d=a.startMousePos;if(d&&a.isScrolling){a.$contentEl.detach(t.move,
u,a);var e=d.pageX-b.pageX,i=d.pageY-b.pageY,d=a.get("snapThreshold"),g=a.allowScroll.left&&Math.abs(e)>d,j=a.allowScroll.top&&Math.abs(i)>d;a.fire("dragend",{pageX:b.pageX,pageY:b.pageY});A(a,b,"left",c);A(a,b,"top",c)}}function D(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function O(b){b.preventDefault()}var z=0.5,M=3,t=F.Gesture,H=300,B=6,v=20,C=Math.log(0.95),J=C/v,K=0.3;m.UA.ie&&(u=m.throttle(u,30));return E.extend({bindUI:function(){this.$contentEl.on("dragstart",
O).on(t.start,L,this).on(t.end,N,this)},syncUI:function(){D(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},lockY:{value:!1},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}},xclass:"scroll-view"})},{requires:["./base","node","anim"]});
