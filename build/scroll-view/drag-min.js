/*
Copyright 2014, KISSY v1.50
MIT Licensed
build time: Feb 13 12:29
*/
KISSY.add("scroll-view/drag",["./base","node","anim"],function(l,w){function y(b,c,a){var c=c.timeStamp,e=b.get("scroll"+l.ucfirst(a));b.startScroll[a]=e;b.swipe[a].startTime=c;b.swipe[a].scroll=e}function z(b,c,a,e){if(!A(b,a)){var f={pageX:c.touches[0].pageX,pageY:c.touches[0].pageY},d="left"===a?"pageX":"pageY",g=b.lastPageXY,h,k=b.startScroll[a]-(f[d]-e[d]),e=c.timeStamp,n=b.minScroll,p=b.maxScroll,i=b.lastDirection,j=b.swipe,m;g[d]&&(h=f[d]===g[d],m=0<f[d]-g[d]);b.get("bounce")||(k=Math.min(Math.max(k,
n[a]),p[a]));k<n[a]?(f=n[a]-k,f*=B,k=n[a]-f):k>p[a]&&(f=k-p[a],f*=B,k=p[a]+f);f=e-j[a].startTime;if(!h&&void 0!==i[a]&&i[a]!==m||f>I)j[a].startTime=e,j[a].scroll=k;b.set("scroll"+l.ucfirst(a),k);i[a]=m;g[d]=c[d]}}function A(b,c){return!b.allowScroll[c]&&b.get("left"===c?"lockX":"lockY")?1:0}function C(b,c,a,e){if(A(b,a))e();else{var f="scroll"+l.ucfirst(a),d=b.get(f),g=b.minScroll,h=b.maxScroll,k=c.timeStamp,c=b.swipe,n;d<g[a]?n=g[a]:d>h[a]&&(n=h[a]);void 0!==n?(d={},d[a]=n,b.scrollTo(d,{duration:b.get("bounceDuration"),
easing:b.get("bounceEasing"),queue:!1,complete:e})):b.pagesOffset?e():(n=k-c[a].startTime,c=d-c[a].scroll,0===n||0===c?e():(n=Math.min(Math.max(c/n,-D),D),e={node:{},to:{},duration:9999,queue:!1,complete:e,frame:J(b,n,d,f,h[a],g[a])},e.node[a]=d,e.to[a]=null,b.scrollAnims.push((new K(e)).run())))}}function J(b,c,a,e,f,d){var g=c*x,h=1,k=0;return function(c,p){var i=l.now(),j;if(h){j=i-c.startTime;var m=Math.exp(j*L);j=parseInt(a+g*(1-m)/-E,10);j>d&&j<f?p.lastValue===j?p.pos=1:(p.lastValue=j,b.set(e,
j)):(h=0,g*=m,a=j<=d?d:f,k=i)}else j=i-k,i=j/x,i*=Math.exp(-M*i),j=parseInt(g*i,10),0===j&&(p.pos=1),b.set(e,a+j)}}function N(b){var c=b.touches;if(!this.get("disabled")){this.stopAnimation();var a={pageX:b.touches[0].pageX,pageY:b.touches[0].pageY};if(this.isScrolling){var e=this.get("pageIndex");this.fire("scrollEnd",l.mix({fromPageIndex:e,pageIndex:e},a))}1<c.length||(F(this),this.startMousePos=a,y(this,b,"left"),y(this,b,"top"),G.on(u.move,v,this).on(u.end,O,this))}}function O(b){var c=this.startMousePos;
G.detach(u.move,v,this);c&&this.isScrolling&&this.fire("dragend",{pageX:b.pageX,deltaX:-(c.pageX-b.pageX),deltaY:-(c.pageY-b.pageY),pageY:b.pageY})}function P(b){function c(){e++;if(2===e){var c=function(){a.isScrolling=0;a.fire("scrollEnd",{pageX:b.pageX,pageY:b.pageY,deltaX:-f,deltaY:-d,fromPageIndex:j,pageIndex:a.get("pageIndex")})};if(a.pagesOffset){var g=a._snapDurationCfg,i=a._snapEasingCfg,j=a.get("pageIndex"),m=a.get("scrollLeft"),l=a.get("scrollTop"),g={duration:g,easing:i,complete:c},s=
a.pagesOffset,q=s.length;a.isScrolling=0;if(h||k)if(h&&k){var i=[],o,r;for(o=0;o<q;o++){var t=s[o];t&&(0<f&&t.left>m?i.push(t):0>f&&t.left<m&&i.push(t))}s=i.length;if(0<d){m=Number.MAX_VALUE;for(o=0;o<s;o++)q=i[o],q.top>l&&m<q.top-l&&(m=q.top-l,r=i.index)}else{m=Number.MAX_VALUE;for(o=0;o<s;o++)q=i[o],q.top<l&&m<l-q.top&&(m=l-q.top,r=i.index)}void 0!==r?r!==j?a.scrollToPage(r,g):(a.scrollToPage(r),c()):c()}else h||k?(c=a._getPageIndexFromXY(h?m:l,h,h?f:d),a.scrollToPage(c,g)):(a.scrollToPage(j),c())}else c()}}
var a=this,e=0,f=-b.deltaX,d=-b.deltaY,g=a._snapThresholdCfg,h=a.allowScroll.left&&Math.abs(f)>g,k=a.allowScroll.top&&Math.abs(d)>g;C(a,b,"left",c);C(a,b,"top",c)}function F(b){b.lastPageXY={};b.lastDirection={};b.swipe={left:{},top:{}};b.startMousePos=null;b.startScroll={};b.dragInitDirection=null}function Q(b){b.preventDefault()}var R=w("./base"),H=w("node"),K=w("anim"),B=0.5,u=H.Gesture,I=300,D=6,G=H.all(document),x=20,E=Math.log(0.95),L=E/x,M=0.3,v=function(b){var c=b.touches,a=this.startMousePos;
if(a){var c={pageX:c[0].pageX,pageY:c[0].pageY},e=Math.abs(c.pageX-a.pageX),f=Math.abs(c.pageY-a.pageY);if(!(3>Math.max(e,f))){this.isScrolling||(this.fire("scrollStart",c),this.isScrolling=1);var d=this.get("lockX"),g=this.get("lockY");if(d||g){var h;if(!(h=this.dragInitDirection))this.dragInitDirection=h=e>f?"left":"top";if(d&&"left"===h&&!this.allowScroll[h]){this.isScrolling=0;this.get("preventDefaultX")&&b.preventDefault();return}if(g&&"top"===h&&!this.allowScroll[h]){this.isScrolling=0;this.get("preventDefaultY")&&
b.preventDefault();return}}l.Features.isTouchEventSupported()&&b.preventDefault();z(this,b,"left",a);z(this,b,"top",a);this.fire("scrollMove",c)}}};l.UA.ie&&(v=l.throttle(v,30));return R.extend({initializer:function(){this._snapThresholdCfg=this.get("snapThreshold");this._snapDurationCfg=this.get("snapDuration");this._snapEasingCfg=this.get("snapEasing");this.publish("dragend",{defaultFn:P,defaultTargetOnly:!0})},bindUI:function(){this.$contentEl.on("dragstart",Q).on(u.start,N,this)},syncUI:function(){F(this)},
destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},preventDefaultX:{value:!0},lockY:{value:!1},preventDefaultY:{value:!1},snapDuration:{value:0.3},snapEasing:{value:"easeOut"},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}}})});
