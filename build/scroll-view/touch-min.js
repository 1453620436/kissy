/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 14 14:16
*/
KISSY.add("scroll-view/touch",["./base","anim/timer","event/gesture/base","event/gesture/drag"],function(v,s){function x(a,c,b){if(!y(a,b)){var d=a.startScroll[b]-("left"===b?c.deltaX:c.deltaY),c=a.minScroll,g=a.maxScroll;a._bounce||(d=Math.min(Math.max(d,c[b]),g[b]));d<c[b]?(d=c[b]-d,d*=z,d=c[b]-d):d>g[b]&&(d-=g[b],d*=z,d=g[b]+d);a.set("scroll"+v.ucfirst(b),d)}}function y(a,c){return!a.allowScroll[c]&&a["_"+("left"===c?"lockX":"lockY")]?1:0}function A(a,c,b,d){if(y(a,b))d();else{var g="scroll"+v.ucfirst(b),
h=a.get(g),i=a.minScroll,k=a.maxScroll,j;h<i[b]?j=i[b]:h>k[b]&&(j=k[b]);void 0!==j?(h={},h[b]=j,a.scrollTo(h,{duration:a.get("bounceDuration"),easing:a.get("bounceEasing"),queue:!1,complete:d})):a.pagesOffset?d():(j="left"===b?-c.velocityX:-c.velocityY,j=Math.min(Math.max(j,-B),B),d={node:{},to:{},duration:9999,queue:!1,complete:d,frame:E(a,j,h,g,k[b],i[b])},d.node[b]=h,d.to[b]=null,a.scrollAnims.push((new F(d)).run()))}}function E(a,c,b,d,g,h){var i=c*w,k=1,j=0;return function(c,t){var e=v.now(),
f;if(k){f=e-c.startTime;var l=Math.exp(f*G);f=parseInt(b+i*(1-l)/(0-C),10);f>h&&f<g?t.lastValue===f?t.pos=1:(t.lastValue=f,a.set(d,f)):(k=0,i*=l,b=f<=h?h:g,j=e)}else f=e-j,e=f/w,e*=Math.exp(0-H*e),f=parseInt(i*e,10),0===f&&(t.pos=1),a.set(d,b+f)}}function I(a){"touch"!==a.gestureType||this.isScrolling&&this.pagesOffset||(this.startScroll={},this.dragInitDirection=null,this.isScrolling=1,this.startScroll.left=this.get("scrollLeft"),this.startScroll.top=this.get("scrollTop"))}function J(a){if("touch"===
a.gestureType){var c=this._lockX,b=this._lockY;if(c||b){var d=a.direction;if(c&&"left"===d&&!this.allowScroll[d]){this.isScrolling=0;this._preventDefaultX&&a.preventDefault();return}if(b&&"top"===d&&!this.allowScroll[d]){this.isScrolling=0;this._preventDefaultY&&a.preventDefault();return}}a.preventDefault()}}function K(a){"touch"===a.gestureType&&(x(this,a,"left"),x(this,a,"top"))}function L(a){"touch"===a.gestureType&&this.fire("touchEnd",{pageX:a.pageX,deltaX:a.deltaX,deltaY:a.deltaY,pageY:a.pageY,
velocityX:a.velocityX,velocityY:a.velocityY})}function M(a){function c(){d++;if(2===d){var c=function(){b.isScrolling=0;b.fire("scrollTouchEnd",{pageX:a.pageX,pageY:a.pageY,deltaX:-g,deltaY:-h,fromPageIndex:f,pageIndex:b.get("pageIndex")})};if(b.pagesOffset){var i=b._snapDurationCfg,e=b._snapEasingCfg,f=b.get("pageIndex"),l=b.get("scrollLeft"),o=b.get("scrollTop"),i={duration:i,easing:e,complete:c},q=b.pagesOffset,n=q.length;b.isScrolling=0;if(k||j)if(k&&j){var e=[],m,p;for(m=0;m<n;m++){var r=q[m];
r&&(0<g&&r.left>l?e.push(r):0>g&&r.left<l&&e.push(r))}q=e.length;if(0<h){l=Number.MAX_VALUE;for(m=0;m<q;m++)n=e[m],n.top>o&&l<n.top-o&&(l=n.top-o,p=e.index)}else{l=Number.MAX_VALUE;for(m=0;m<q;m++)n=e[m],n.top<o&&l<o-n.top&&(l=o-n.top,p=e.index)}void 0!==p?p!==f?b.scrollToPage(p,i):(b.scrollToPage(p),c()):c()}else k||j?(c=b.getPageIndexFromXY(k?l:o,k,k?g:h),b.scrollToPage(c,i)):(b.scrollToPage(f),c())}else c()}}var b=this,d=0,g=-a.deltaX,h=-a.deltaY,i=b._snapThresholdCfg,k=b.allowScroll.left&&Math.abs(g)>
i,j=b.allowScroll.top&&Math.abs(h)>i;A(b,a,"left",c);A(b,a,"top",c)}function N(a){this.isScrolling&&"touch"===a.gestureType&&a.preventDefault();if((!this.isScrolling||!this.pagesOffset)&&this.isScrolling)this.stopAnimation(),this.fire("scrollTouchEnd",{pageX:a.pageX,pageY:a.pageY})}function D(a){var c=a.get("disabled")?"detach":"on";a.$contentEl[c](u.DRAG_START,I,a)[c](O.START,N,a)[c](u.DRAGGING,J,a)[c](u.DRAG,K,a)[c](u.DRAG_END,L,a)}var P=s("./base"),F=s("anim/timer"),z=0.5,B=6,O=s("event/gesture/base"),
u=s("event/gesture/drag"),w=20,C=Math.log(0.95),G=C/w,H=0.3;return P.extend({initializer:function(){this._preventDefaultY=this.get("preventDefaultY");this._preventDefaultX=this.get("preventDefaultX");this._lockX=this.get("lockX");this._lockY=this.get("lockY");this._bounce=this.get("bounce");this._snapThresholdCfg=this.get("snapThreshold");this._snapDurationCfg=this.get("snapDuration");this._snapEasingCfg=this.get("snapEasing");this.publish("touchEnd",{defaultFn:M,defaultTargetOnly:!0})},bindUI:function(){D(this)},
_onSetDisabled:function(a){this.callSuper(a);D(this)},destructor:function(){this.stopAnimation()},stopAnimation:function(){this.callSuper();this.isScrolling=0}},{ATTRS:{lockX:{value:!0},preventDefaultX:{value:!0},lockY:{value:!1},preventDefaultY:{value:!1},snapDuration:{value:0.3},snapEasing:{value:"easeOut"},snapThreshold:{value:5},bounce:{value:!0},bounceDuration:{value:0.4},bounceEasing:{value:"easeOut"}}})});
