/*
Copyright 2014, KISSY v5.0.0
MIT Licensed
build time: Apr 15 17:55
*/
KISSY.add("scroll-view/base",["node","anim/timer","component/container","component/extension/content-box"],function(j,k){function r(){var a=this.el,c=a.scrollTop,b=a.scrollLeft;c&&this.set("scrollTop",c+this.get("scrollTop"));b&&this.set("scrollLeft",b+this.get("scrollLeft"));a.scrollTop=a.scrollLeft=0}function s(a,c){a.scrollView.set(c.prop,c.val)}var l=k("node"),t=k("anim/timer"),u=k("component/container"),v=k("component/extension/content-box"),p=j.all,i=l.KeyCode,l=j.Feature.getCssVendorInfo("transform"),
m=Math.floor,n,q=j.Feature.isTransform3dSupported(),o={initializer:function(){this.scrollAnims=[]},bindUI:function(){this.$el.on("mousewheel",this.handleMouseWheel,this).on("scroll",r,this)},syncUI:function(){this.sync()},sync:function(){var a=this.el,c=this.contentEl,b=Math.max(c.offsetHeight,c.scrollHeight),c=Math.max(c.offsetWidth,c.scrollWidth);this.set("dimension",{scrollHeight:b,scrollWidth:c,clientWidth:a.clientWidth,clientHeight:a.clientHeight})},_onSetDimension:function(a,c){var b=this.$contentEl,
d=a.scrollHeight,e=a.scrollWidth,f=a.clientHeight,g,h=a.clientWidth;g=c&&c.prevVal||{};if(!(g.scrollHeight===d&&g.scrollWidth===e&&f===g.clientHeight&&h===g.clientWidth)){this.scrollHeight=d;this.scrollWidth=e;this.clientHeight=f;this.clientWidth=h;g=this.allowScroll={};d>f&&(g.top=1);e>h&&(g.left=1);this.minScroll={left:0,top:0};var i,j;this.maxScroll={left:i=e-h,top:j=d-f};delete this.scrollStep;f=this.get("snap");d=this.get("scrollLeft");e=this.get("scrollTop");if(f){var k=b.offset(),b=this.pages=
"string"===typeof f?b.all(f):b.children(),f=this.get("pageIndex"),l=this.pagesOffset=[];b.each(function(a,c){var b=a.offset(),d=b.left-k.left,b=b.top-k.top;d<=i&&b<=j&&(l[c]={left:d,top:b,index:c})});if(f){this.scrollToPage(f);return}}this.scrollToWithBounds({left:d,top:e});this.fire("reflow",a)}},handleKeyDownInternal:function(a){var c=p(a.target),b=c.nodeName();if(!("input"===b||"textarea"===b||"select"===b||c.hasAttr("contenteditable"))){var a=a.keyCode,c=this.getScrollStep(),d,b=this.allowScroll.left;
if(this.allowScroll.top){var e=c.top,f=this.clientHeight,g=this.get("scrollTop");a===i.DOWN?(this.scrollToWithBounds({top:g+e}),d=!0):a===i.UP?(this.scrollToWithBounds({top:g-e}),d=!0):a===i.PAGE_DOWN?(this.scrollToWithBounds({top:g+f}),d=!0):a===i.PAGE_UP&&(this.scrollToWithBounds({top:g-f}),d=!0)}b&&(c=c.left,b=this.get("scrollLeft"),a===i.RIGHT?(this.scrollToWithBounds({left:b+c}),d=!0):a===i.LEFT&&(this.scrollToWithBounds({left:b-c}),d=!0));return d}},getScrollStep:function(){if(this.scrollStep)return this.scrollStep;
var a=p(this.get("el")[0].ownerDocument),c=this.clientHeight,b=this.clientWidth;return this.scrollStep={top:Math.max(0.7*c*c/a.height(),20),left:Math.max(0.7*b*b/a.width(),20)}},handleMouseWheel:function(a){if(!this.get("disabled")){var c,b,d=this.getScrollStep(),e,f=this.maxScroll,g=this.minScroll;if((e=a.deltaY)&&this.allowScroll.top){var h=this.get("scrollTop");c=f.top;b=g.top;h<=b&&0<e||h>=c&&0>e||(this.scrollToWithBounds({top:h-a.deltaY*d.top}),a.preventDefault())}if((e=a.deltaX)&&this.allowScroll.left)h=
this.get("scrollLeft"),c=f.left,b=g.left,h<=b&&0<e||h>=c&&0>e||(this.scrollToWithBounds({left:h-a.deltaX*d.left}),a.preventDefault())}},stopAnimation:function(){this.scrollAnims.length&&(j.each(this.scrollAnims,function(a){a.stop()}),this.scrollAnims=[]);this.scrollToWithBounds({left:this.get("scrollLeft"),top:this.get("scrollTop")})},_uiSetPageIndex:function(a){this.scrollToPage(a)},getPageIndexFromXY:function(a,c,b){var d=this.pagesOffset.concat([]),e=c?"left":"top";d.sort(function(a,b){return a[e]-
b[e]});if(0<b)for(c=0;c<d.length;c++){if(b=d[c],b[e]>=a)return b.index}else for(c=d.length-1;0<=c;c--)if(b=d[c],b[e]<=a)return b.index},scrollToPage:function(a,c){var b;if((b=this.pagesOffset)&&b[a])this.set("pageIndex",a),this.scrollTo(b[a],c)},scrollToWithBounds:function(a,c){var b=this.maxScroll,d=this.minScroll;a.left&&(a.left=Math.min(Math.max(a.left,d.left),b.left));a.top&&(a.top=Math.min(Math.max(a.top,d.top),b.top));this.scrollTo(a,c)},scrollTo:function(a,c){var b=a.left,d=a.top;if(c){var e=
{},f={};void 0!==b&&(f.scrollLeft=b,e.scrollLeft=this.get("scrollLeft"));void 0!==d&&(f.scrollTop=d,e.scrollTop=this.get("scrollTop"));c.frame=s;c.node=e;c.to=f;this.scrollAnims.push(b=new t(c));b.scrollView=this;b.run()}else void 0!==b&&this.set("scrollLeft",b),void 0!==d&&this.set("scrollTop",d)},_onSetScrollLeft:function(a){this.contentEl.style.left=-a+"px"},_onSetScrollTop:function(a){this.contentEl.style.top=-a+"px"}};l&&(n=l.propertyName,o._onSetScrollLeft=function(a){this.contentEl.style[n]=
"translateX("+m(0-a)+"px) translateY("+m(0-this.get("scrollTop"))+"px)"+(q?" translateZ(0)":"")},o._onSetScrollTop=function(a){this.contentEl.style[n]="translateX("+m(0-this.get("scrollLeft"))+"px) translateY("+m(0-a)+"px)"+(q?" translateZ(0)":"")});return u.extend([v],o,{ATTRS:{contentEl:{},scrollLeft:{render:1,value:0},scrollTop:{render:1,value:0},dimension:{},focusable:{value:!0},allowTextSelection:{value:!0},handleGestureEvents:{value:!1},snap:{value:!1},pageIndex:{value:0}},xclass:"scroll-view"})});
